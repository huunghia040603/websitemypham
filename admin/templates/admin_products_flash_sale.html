{% extends "admin_base.html" %}

{% block title %}Quản Lý Flash Sale - Admin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-bolt me-2"></i>Quản Lý Flash Sale
            </h1>
            <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#addFlashSaleModal">
                <i class="fas fa-plus me-2"></i>Thêm Flash Sale
            </button>
        </div>
    </div>
</div>

<!-- Filter and Search -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="searchInput" class="form-label">Tìm kiếm sản phẩm</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Nhập tên sản phẩm...">
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="discountFilter" class="form-label">Giảm giá (%)</label>
                        <select class="form-select" id="discountFilter">
                            <option value="">Tất cả</option>
                            <option value="50">Trên 50%</option>
                            <option value="30">30-50%</option>
                            <option value="20">20-30%</option>
                            <option value="10">10-20%</option>
                            <option value="5">Dưới 10%</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="brandFilter" class="form-label">Thương hiệu</label>
                        <select class="form-select" id="brandFilter">
                            <option value="">Tất cả thương hiệu</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="stockFilter" class="form-label">Tồn kho</label>
                        <select class="form-select" id="stockFilter">
                            <option value="">Tất cả</option>
                            <option value="in_stock">Còn hàng</option>
                            <option value="low_stock">Sắp hết</option>
                            <option value="out_of_stock">Hết hàng</option>
                        </select>
                    </div>
                    <div class="col-md-1 mb-3">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Flash Sale Products -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>Sản Phẩm Flash Sale
                    <span class="badge bg-warning ms-2" id="productCount">0</span>
                </h5>
            </div>
            <div class="card-body">
                <div id="productsContainer">
                    <div class="loading-spinner show">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Đang tải danh sách sản phẩm flash sale...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Flash Sale Modal -->
<div class="modal fade" id="addFlashSaleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bolt me-2"></i>Thêm Flash Sale
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addFlashSaleForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="productSelect" class="form-label">Chọn sản phẩm *</label>
                            <select class="form-select" id="productSelect" required>
                                <option value="">-- Chọn sản phẩm --</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="discountRate" class="form-label">Tỷ lệ giảm giá (%) *</label>
                            <input type="number" class="form-control" id="discountRate" min="1" max="99" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="flashSaleStart" class="form-label">Thời gian bắt đầu</label>
                            <input type="datetime-local" class="form-control" id="flashSaleStart">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="flashSaleEnd" class="form-label">Thời gian kết thúc</label>
                            <input type="datetime-local" class="form-control" id="flashSaleEnd">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="flashSaleDescription" class="form-label">Mô tả flash sale</label>
                        <textarea class="form-control" id="flashSaleDescription" rows="2" placeholder="Mô tả ngắn về chương trình flash sale..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-warning" onclick="addFlashSale()">
                    <i class="fas fa-bolt me-2"></i>Thêm Flash Sale
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Flash Sale Modal -->
<div class="modal fade" id="editFlashSaleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Chỉnh Sửa Flash Sale
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editFlashSaleForm">
                    <input type="hidden" id="editProductId">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editProductName" class="form-label">Tên sản phẩm</label>
                            <input type="text" class="form-control" id="editProductName" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editDiscountRate" class="form-label">Tỷ lệ giảm giá (%) *</label>
                            <input type="number" class="form-control" id="editDiscountRate" min="1" max="99" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="editOriginalPrice" class="form-label">Giá gốc</label>
                            <input type="number" class="form-control" id="editOriginalPrice" readonly>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editDiscountedPrice" class="form-label">Giá sau giảm</label>
                            <input type="number" class="form-control" id="editDiscountedPrice" readonly>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editStockQuantity" class="form-label">Tồn kho</label>
                            <input type="number" class="form-control" id="editStockQuantity">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editFlashSaleStart" class="form-label">Thời gian bắt đầu</label>
                            <input type="datetime-local" class="form-control" id="editFlashSaleStart">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editFlashSaleEnd" class="form-label">Thời gian kết thúc</label>
                            <input type="datetime-local" class="form-control" id="editFlashSaleEnd">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editFlashSaleDescription" class="form-label">Mô tả flash sale</label>
                        <textarea class="form-control" id="editFlashSaleDescription" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-warning" onclick="updateFlashSale()">
                    <i class="fas fa-save me-2"></i>Cập Nhật
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allProducts = [];
let filteredProducts = [];

document.addEventListener('DOMContentLoaded', async function() {
    await loadFlashSaleProducts();
    await loadAllProductsForSelect();
    setupEventListeners();
});

async function loadFlashSaleProducts() {
    try {
        AdminAPI.showLoading('productsContainer');
        allProducts = await AdminAPI.fetchProducts(null, true); // Get flash sale products
        filteredProducts = [...allProducts];
        
        renderProducts();
        populateFilters();
        updateProductCount();
        
    } catch (error) {
        console.error('Error loading flash sale products:', error);
        document.getElementById('productsContainer').innerHTML = 
            '<p class="text-danger text-center py-4">Lỗi khi tải danh sách sản phẩm flash sale</p>';
    }
}

async function loadAllProductsForSelect() {
    try {
        const products = await AdminAPI.fetchProducts();
        const productSelect = document.getElementById('productSelect');
        
        products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = `${product.name} - ${AdminAPI.formatPrice(product.original_price)}`;
            productSelect.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading products for select:', error);
    }
}

function renderProducts() {
    const container = document.getElementById('productsContainer');
    
    if (filteredProducts.length === 0) {
        container.innerHTML = '<p class="text-muted text-center py-4">Không có sản phẩm flash sale nào</p>';
        return;
    }
    
    let html = '<div class="row">';
    
    filteredProducts.forEach(product => {
        const imageUrl = product.image || '/static/image/default-product.jpg';
        const originalPrice = AdminAPI.formatPrice(product.original_price);
        const discountedPrice = AdminAPI.formatPrice(product.discounted_price);
        const discountRate = Math.round(product.discount_rate || 0);
        const stockClass = product.stock_quantity > 10 ? 'bg-success' : product.stock_quantity > 0 ? 'bg-warning' : 'bg-danger';
        
        html += `
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card product-card h-100">
                    <div class="position-relative">
                        <img src="${imageUrl}" class="card-img-top product-image" alt="${product.name}">
                        <div class="flash-sale-badge">-${discountRate}%</div>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title">${product.name}</h6>
                        <p class="card-text">
                            <small class="text-muted">${product.brand_name || 'N/A'}</small>
                        </p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <span class="text-decoration-line-through text-muted small">${originalPrice}</span>
                                <br>
                                <span class="text-danger fw-bold">${discountedPrice}</span>
                            </div>
                            <span class="badge ${stockClass}">Còn ${product.stock_quantity}</span>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-warning flex-fill" onclick="editFlashSale(${product.id})">
                                <i class="fas fa-edit me-1"></i>Chỉnh Sửa
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeFlashSale(${product.id})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function populateFilters() {
    // Populate brand filter
    const brands = [...new Set(allProducts.map(p => p.brand_name).filter(Boolean))];
    const brandSelect = document.getElementById('brandFilter');
    brands.forEach(brand => {
        const option = document.createElement('option');
        option.value = brand;
        option.textContent = brand;
        brandSelect.appendChild(option);
    });
}

function setupEventListeners() {
    document.getElementById('searchInput').addEventListener('input', filterProducts);
    document.getElementById('discountFilter').addEventListener('change', filterProducts);
    document.getElementById('brandFilter').addEventListener('change', filterProducts);
    document.getElementById('stockFilter').addEventListener('change', filterProducts);
    
    // Auto calculate discounted price
    document.getElementById('discountRate').addEventListener('input', calculateDiscountedPrice);
    document.getElementById('editDiscountRate').addEventListener('input', calculateEditDiscountedPrice);
}

function filterProducts() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const discountFilter = document.getElementById('discountFilter').value;
    const brandFilter = document.getElementById('brandFilter').value;
    const stockFilter = document.getElementById('stockFilter').value;
    
    filteredProducts = allProducts.filter(product => {
        const matchesSearch = product.name.toLowerCase().includes(searchTerm);
        const matchesBrand = !brandFilter || product.brand_name === brandFilter;
        
        let matchesDiscount = true;
        if (discountFilter) {
            const discount = parseFloat(product.discount_rate || 0);
            const filterValue = parseFloat(discountFilter);
            matchesDiscount = discount >= filterValue;
        }
        
        let matchesStock = true;
        if (stockFilter) {
            const stock = product.stock_quantity || 0;
            if (stockFilter === 'in_stock') matchesStock = stock > 10;
            else if (stockFilter === 'low_stock') matchesStock = stock > 0 && stock <= 10;
            else if (stockFilter === 'out_of_stock') matchesStock = stock === 0;
        }
        
        return matchesSearch && matchesBrand && matchesDiscount && matchesStock;
    });
    
    renderProducts();
    updateProductCount();
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('discountFilter').value = '';
    document.getElementById('brandFilter').value = '';
    document.getElementById('stockFilter').value = '';
    filterProducts();
}

function updateProductCount() {
    document.getElementById('productCount').textContent = filteredProducts.length;
}

function calculateDiscountedPrice() {
    const productSelect = document.getElementById('productSelect');
    const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
    
    if (productSelect.value && discountRate > 0) {
        const selectedProduct = allProducts.find(p => p.id == productSelect.value);
        if (selectedProduct) {
            const originalPrice = selectedProduct.original_price || 0;
            const discountedPrice = originalPrice * (1 - discountRate / 100);
            // You can show this in a preview area if needed
        }
    }
}

function calculateEditDiscountedPrice() {
    const originalPrice = parseFloat(document.getElementById('editOriginalPrice').value) || 0;
    const discountRate = parseFloat(document.getElementById('editDiscountRate').value) || 0;
    
    if (originalPrice > 0 && discountRate > 0) {
        const discountedPrice = originalPrice * (1 - discountRate / 100);
        document.getElementById('editDiscountedPrice').value = discountedPrice.toFixed(2);
    }
}

function editFlashSale(productId) {
    const product = allProducts.find(p => p.id === productId);
    if (!product) return;
    
    // Populate edit form
    document.getElementById('editProductId').value = product.id;
    document.getElementById('editProductName').value = product.name;
    document.getElementById('editDiscountRate').value = Math.round(product.discount_rate || 0);
    document.getElementById('editOriginalPrice').value = product.original_price || 0;
    document.getElementById('editDiscountedPrice').value = product.discounted_price || 0;
    document.getElementById('editStockQuantity').value = product.stock_quantity || 0;
    document.getElementById('editFlashSaleDescription').value = product.flash_sale_description || '';
    
    // Show modal
    new bootstrap.Modal(document.getElementById('editFlashSaleModal')).show();
}

async function updateFlashSale() {
    const productId = document.getElementById('editProductId').value;
    const discountRate = parseFloat(document.getElementById('editDiscountRate').value);
    const originalPrice = parseFloat(document.getElementById('editOriginalPrice').value);
    const stockQuantity = parseInt(document.getElementById('editStockQuantity').value);
    
    const discountedPrice = originalPrice * (1 - discountRate / 100);
    
    const formData = {
        discount_rate: discountRate,
        discounted_price: discountedPrice,
        stock_quantity: stockQuantity,
        flash_sale_description: document.getElementById('editFlashSaleDescription').value
    };
    
    try {
        await AdminAPI.updateProduct(productId, formData);
        AdminAPI.showNotification('Cập nhật flash sale thành công!', 'success');
        
        // Close modal and reload data
        bootstrap.Modal.getInstance(document.getElementById('editFlashSaleModal')).hide();
        await loadFlashSaleProducts();
        
    } catch (error) {
        console.error('Error updating flash sale:', error);
    }
}

async function addFlashSale() {
    const productId = document.getElementById('productSelect').value;
    const discountRate = parseFloat(document.getElementById('discountRate').value);
    
    if (!productId || !discountRate) {
        AdminAPI.showNotification('Vui lòng chọn sản phẩm và nhập tỷ lệ giảm giá', 'warning');
        return;
    }
    
    try {
        // Get selected product
        const selectedProduct = allProducts.find(p => p.id == productId);
        if (!selectedProduct) {
            AdminAPI.showNotification('Không tìm thấy sản phẩm được chọn', 'error');
            return;
        }
        
        const originalPrice = selectedProduct.original_price || 0;
        const discountedPrice = originalPrice * (1 - discountRate / 100);
        
        const formData = {
            discount_rate: discountRate,
            discounted_price: discountedPrice,
            flash_sale_description: document.getElementById('flashSaleDescription').value
        };
        
        await AdminAPI.updateProduct(productId, formData);
        AdminAPI.showNotification('Thêm flash sale thành công!', 'success');
        
        // Close modal and reload data
        bootstrap.Modal.getInstance(document.getElementById('addFlashSaleModal')).hide();
        document.getElementById('addFlashSaleForm').reset();
        await loadFlashSaleProducts();
        
    } catch (error) {
        console.error('Error adding flash sale:', error);
    }
}

async function removeFlashSale(productId) {
    if (!confirm('Bạn có chắc chắn muốn xóa flash sale cho sản phẩm này?')) {
        return;
    }
    
    try {
        const formData = {
            discount_rate: 0,
            discounted_price: null
        };
        
        await AdminAPI.updateProduct(productId, formData);
        AdminAPI.showNotification('Xóa flash sale thành công!', 'success');
        
        await loadFlashSaleProducts();
        
    } catch (error) {
        console.error('Error removing flash sale:', error);
    }
}
</script>
{% endblock %}
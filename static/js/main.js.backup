// Main JavaScript for BuddySkincare Website

// Generate random discount for LOVEBUDDY (5,000 - 15,000 VND)
function generateRandomDiscount() {
    // Generate random number from 5 to 15, then multiply by 1000
    const randomNumber = Math.floor(Math.random() * 11) + 5; // 5 to 15
    const discount = randomNumber * 1000; // 5,000 to 15,000
    return discount;
}

// Get voucher with case-insensitive matching
function getVoucherByCode(code) {
    const upperCode = code.toUpperCase();
    return VOUCHERS[upperCode] || null;
}

// Voucher data (temporary - will be replaced with PythonAnywhere API)
const VOUCHERS = {
    'HIBUDDY': {
        code: 'HIBUDDY',
        discount: 10000,
        type: 'fixed', // 'fixed' or 'percentage'
        minOrder: 0,
        maxUses: 100,
        description: 'Gi·∫£m 10.000ƒë cho ƒë∆°n h√†ng'
    },
    'LOVEBUDDY': {
        code: 'LOVEBUDDY',
        discount: generateRandomDiscount(), // Random 5,000-15,000
        type: 'fixed',
        minOrder: 0,
        maxUses: 100,
        description: 'Gi·∫£m ng·∫´u nhi√™n 5.000ƒë - 15.000ƒë cho ƒë∆°n h√†ng'
    }
};

// Save voucher to localStorage
function saveVoucher(voucher) {
    localStorage.setItem('appliedVoucher', JSON.stringify(voucher));
}

// Get voucher from localStorage
function getAppliedVoucher() {
    const voucher = localStorage.getItem('appliedVoucher');
    return voucher ? JSON.parse(voucher) : null;
}

// Clear voucher
function clearVoucher() {
    localStorage.removeItem('appliedVoucher');
}

// Clear voucher display
function clearVoucherDisplay(isCheckout = false) {
    const prefix = isCheckout ? 'checkout' : 'cart';
    const messageEl = document.getElementById(`${prefix}VoucherMessage`);
    const appliedEl = document.getElementById(`${prefix}VoucherApplied`);
    const voucherLineEl = document.getElementById(`${prefix}VoucherLine`);
    const codeInput = document.getElementById(`${prefix}VoucherCode`);
    
    // Clear input field
    if (codeInput) codeInput.value = '';
    
    // Hide applied voucher section
    if (appliedEl) appliedEl.classList.add('d-none');
    
    // Hide voucher line in summary and reset discount to 0ƒë
    if (voucherLineEl) {
        voucherLineEl.style.display = 'none';
    }
    
    // Reset voucher discount to 0ƒë
    const voucherDiscountEl = document.querySelector(`.${prefix}-voucher-discount`);
    if (voucherDiscountEl) {
        voucherDiscountEl.textContent = '-0ƒë';
    }
    
    // Clear message
    if (messageEl) messageEl.innerHTML = '';
    
    console.log('Voucher display cleared for:', prefix, 'discount reset to 0ƒë');
}

// Remove voucher
function removeVoucher(isCheckout = false) {
    console.log('=== REMOVING VOUCHER ===');
    
    // Clear voucher from localStorage
    clearVoucher();
    
    // Clear voucher display
    clearVoucherDisplay(isCheckout);
    
    // Update voucher line in summary to show 0ƒë
    const prefix = isCheckout ? 'checkout' : 'cart';
    const voucherLineEl = document.getElementById(`${prefix}VoucherLine`);
    const voucherDiscountEl = document.querySelector(`.${prefix}-voucher-discount`);
    
    if (voucherLineEl) {
        voucherLineEl.style.display = 'none';
    }
    
    if (voucherDiscountEl) {
        voucherDiscountEl.textContent = '-0ƒë';
    }
    
    // Update summary immediately
    if (isCheckout) {
        updateCheckoutSummary();
    } else {
        updateCartSummary();
        // Also sync to checkout
        syncVoucherToCheckout();
    }
    
    console.log('Voucher removed successfully, discount reset to 0ƒë');
}

// Apply voucher
function applyVoucher(code, isCheckout = false) {
    const prefix = isCheckout ? 'checkout' : 'cart';
    const messageEl = document.getElementById(`${prefix}VoucherMessage`);
    const appliedEl = document.getElementById(`${prefix}VoucherApplied`);
    const nameEl = document.getElementById(`${prefix}VoucherName`);
    const discountEl = document.getElementById(`${prefix}VoucherDiscount`);
    const voucherLineEl = document.getElementById(`${prefix}VoucherLine`);
    
    // Clear previous messages
    messageEl.innerHTML = '';
    
    // Get voucher with case-insensitive matching
    const voucher = getVoucherByCode(code);
    if (!voucher) {
        messageEl.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle me-1"></i>M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá</span>';
        return false;
    }
    
    // For LOVEBUDDY, generate new random discount each time
    if (voucher.code === 'LOVEBUDDY') {
        voucher.discount = generateRandomDiscount(); // Random 5,000-15,000
        console.log('LOVEBUDDY voucher applied with random discount:', voucher.discount);
    }
    
    // Check minimum order (if needed)
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    let subtotal = 0;
    cart.forEach(item => {
        const price = parsePrice(item.price);
        subtotal += price * item.quantity;
    });
    
    if (subtotal < voucher.minOrder) {
        messageEl.innerHTML = `<span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>ƒê∆°n h√†ng t·ªëi thi·ªÉu ${voucher.minOrder.toLocaleString('vi-VN')}ƒë</span>`;
        return false;
    }
    
    // Check if there's already a voucher applied
    const existingVoucher = getAppliedVoucher();
    if (existingVoucher) {
        console.log('Replacing existing voucher:', existingVoucher.code, 'with new voucher:', voucher.code);
        // Clear old voucher display first
        clearVoucherDisplay(isCheckout);
    }
    
    // Apply voucher
    saveVoucher(voucher);
    
    // Update UI
    nameEl.textContent = voucher.code;
    discountEl.textContent = `-${voucher.discount.toLocaleString('vi-VN')}ƒë`;
    appliedEl.classList.remove('d-none');
    voucherLineEl.style.display = 'flex';
    
    messageEl.innerHTML = '<span class="text-success"><i class="fas fa-check-circle me-1"></i>√Åp d·ª•ng th√†nh c√¥ng!</span>';
    
    // Update summary
    if (isCheckout) {
        updateCheckoutSummary();
    } else {
        updateCartSummary();
        // Also sync to checkout if user goes there
        syncVoucherToCheckout();
    }
    
    return true;
}

// Sync voucher display to checkout
function syncVoucherToCheckout() {
    const voucher = getAppliedVoucher();
    const checkoutCodeEl = document.getElementById('checkoutVoucherCode');
    const checkoutAppliedEl = document.getElementById('checkoutVoucherApplied');
    const checkoutNameEl = document.getElementById('checkoutVoucherName');
    const checkoutDiscountEl = document.getElementById('checkoutVoucherDiscount');
    const checkoutVoucherLineEl = document.getElementById('checkoutVoucherLine');
    
    if (voucher && checkoutCodeEl) {
        checkoutCodeEl.value = voucher.code;
        if (checkoutNameEl) checkoutNameEl.textContent = voucher.code;
        if (checkoutDiscountEl) checkoutDiscountEl.textContent = `-${voucher.discount.toLocaleString('vi-VN')}ƒë`;
        if (checkoutAppliedEl) checkoutAppliedEl.classList.remove('d-none');
        if (checkoutVoucherLineEl) checkoutVoucherLineEl.style.display = 'flex';
    } else {
        // Clear voucher display if no voucher
        clearVoucherDisplay(true);
    }
}

// Sync voucher display to cart
function syncVoucherToCart() {
    const voucher = getAppliedVoucher();
    const cartCodeEl = document.getElementById('cartVoucherCode');
    const cartAppliedEl = document.getElementById('cartVoucherApplied');
    const cartNameEl = document.getElementById('cartVoucherName');
    const cartDiscountEl = document.getElementById('cartVoucherDiscount');
    const cartVoucherLineEl = document.getElementById('cartVoucherLine');
    
    if (voucher && cartCodeEl) {
        cartCodeEl.value = voucher.code;
        if (cartNameEl) cartNameEl.textContent = voucher.code;
        if (cartDiscountEl) cartDiscountEl.textContent = `-${voucher.discount.toLocaleString('vi-VN')}ƒë`;
        if (cartAppliedEl) cartAppliedEl.classList.remove('d-none');
        if (cartVoucherLineEl) cartVoucherLineEl.style.display = 'flex';
    } else {
        // Clear voucher display if no voucher
        clearVoucherDisplay(false);
    }
}

// Initialize voucher events
function initVoucherEvents() {
    // Cart voucher events
    const cartApplyBtn = document.getElementById('applyCartVoucher');
    const cartCodeInput = document.getElementById('cartVoucherCode');
    const cartRemoveBtn = document.getElementById('removeCartVoucher');
    
    if (cartApplyBtn && cartCodeInput) {
        cartApplyBtn.addEventListener('click', () => {
            const code = cartCodeInput.value.trim();
            if (code) {
                applyVoucher(code, false);
            }
        });
        
        cartCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const code = cartCodeInput.value.trim();
                if (code) {
                    applyVoucher(code, false);
                }
            }
        });
    }
    
    // Cart remove voucher button
    if (cartRemoveBtn) {
        cartRemoveBtn.addEventListener('click', () => {
            removeVoucher(false);
        });
    }
    
    // Checkout voucher events
    const checkoutApplyBtn = document.getElementById('applyCheckoutVoucher');
    const checkoutCodeInput = document.getElementById('checkoutVoucherCode');
    const checkoutRemoveBtn = document.getElementById('removeCheckoutVoucher');
    
    if (checkoutApplyBtn && checkoutCodeInput) {
        checkoutApplyBtn.addEventListener('click', () => {
            const code = checkoutCodeInput.value.trim();
            if (code) {
                applyVoucher(code, true);
            }
        });
        
        checkoutCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const code = checkoutCodeInput.value.trim();
                if (code) {
                    applyVoucher(code, true);
                }
            }
        });
    }
    
    // Checkout remove voucher button
    if (checkoutRemoveBtn) {
        checkoutRemoveBtn.addEventListener('click', () => {
            removeVoucher(true);
        });
    }
    
    // Load saved voucher on page load
    syncVoucherToCart();
    syncVoucherToCheckout();
}

// Helper function to parse price accurately
function parsePrice(priceString) {
    if (!priceString) return 0;
    // Remove all non-numeric characters except dots and commas, then remove dots and commas
    const cleanPrice = priceString.replace(/[^\d,.]/g, '').replace(/[,.]/g, '');
    const result = parseInt(cleanPrice, 10) || 0;
    console.log(`parsePrice: "${priceString}" -> "${cleanPrice}" -> ${result}`);
    return result;
}

// Initialize cart when page loads
function initCart() {
    console.log('=== INITIALIZING CART ===');
    
    // Detect current page
    const cartPaymentInputs = document.querySelectorAll('input[name="paymentMethod"]');
    const checkoutPaymentInputs = document.querySelectorAll('input[name="pay"]');
    
    const isCartPage = cartPaymentInputs.length > 0;
    const isCheckoutPage = checkoutPaymentInputs.length > 0;
    
    console.log('Page detection:');
    console.log('- Is Cart Page:', isCartPage);
    console.log('- Is Checkout Page:', isCheckoutPage);
    console.log('Found elements:');
    console.log('- Cart payment inputs:', cartPaymentInputs.length);
    console.log('- Checkout payment inputs:', checkoutPaymentInputs.length);
    
    if (cartPaymentInputs.length > 0) {
        console.log('Cart payment input values:', Array.from(cartPaymentInputs).map(input => input.value));
        console.log('Cart payment input checked states:', Array.from(cartPaymentInputs).map(input => input.checked));
    }
    if (checkoutPaymentInputs.length > 0) {
        console.log('Checkout payment input values:', Array.from(checkoutPaymentInputs).map(input => input.value));
        console.log('Checkout payment input checked states:', Array.from(checkoutPaymentInputs).map(input => input.checked));
    }
    
    // Update cart count badges
    updateCartCount();
    
    if (isCartPage) {
        console.log('Initializing cart page...');
        
        // Debug: Check if cart elements are actually visible
        const cartContainer = document.querySelector('#cart-items-container');
        const cartSummary = document.querySelector('.col-lg-4');
        console.log('Cart elements found:');
        console.log('- Cart items container:', !!cartContainer);
        console.log('- Cart summary column:', !!cartSummary);
        
        // Update cart display if on cart page
        updateCartDisplay();
        
        // Add event listeners for cart payment methods
        initCartPaymentEvents();
    }
    
    if (isCheckoutPage) {
        console.log('Initializing checkout page...');
        
        // Debug: Check if checkout elements are actually visible
        const checkoutContainer = document.querySelector('#checkout-items-container');
        const checkoutSummary = document.querySelector('.col-lg-4');
        console.log('Checkout elements found:');
        console.log('- Checkout items container:', !!checkoutContainer);
        console.log('- Checkout summary column:', !!checkoutSummary);
        
        // Update checkout display if on checkout page
        updateCheckoutDisplay();
        
        // Add event listeners for checkout page
        initCheckoutEvents();
    }
    
    // Initialize voucher events (works on both pages)
    initVoucherEvents();
    
    // Debug: Check current payment method status
    const currentPaymentMethod = getPaymentMethod();
    console.log('Current payment method from localStorage:', currentPaymentMethod);
    
    // Sync payment method from cart to checkout with delay to ensure DOM is ready
    setTimeout(() => {
        console.log('First sync attempt...');
        syncPaymentMethod();
        // Retry after a longer delay to ensure everything is loaded
        setTimeout(() => {
            console.log('Retrying payment method sync in cart...');
            syncPaymentMethod();
        }, 500);
    }, 200);
}

// Initialize checkout page events
function initCheckoutEvents() {
    console.log('=== INITIALIZING CHECKOUT EVENTS ===');
    
    // Handle shipping method change
    const shippingRadios = document.querySelectorAll('input[name="ship"]');
    console.log('Found shipping radios:', shippingRadios.length);
    shippingRadios.forEach(radio => {
        radio.addEventListener('change', updateCheckoutSummary);
    });
    
    // Handle payment method change
    const paymentRadios = document.querySelectorAll('input[name="pay"]');
    console.log('Found payment radios:', paymentRadios.length);
    paymentRadios.forEach(radio => {
        radio.addEventListener('change', handlePaymentMethodChange);
    });
    
    // Handle place order button
    const placeOrderBtn = document.getElementById('place-order-btn');
    if (placeOrderBtn) {
        placeOrderBtn.addEventListener('click', function(e) {
            e.preventDefault();
            handlePlaceOrder();
        });
    }
    // Also handle form submit if there's a checkout form
    const checkoutForm = document.getElementById('checkoutForm');
    if (checkoutForm) {
        checkoutForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handlePlaceOrder();
        });
    }
    
    // Initialize payment method display
    handlePaymentMethodChange();
    
    // Auto-select saved payment method
    const savedPaymentMethod = getPaymentMethod();
    console.log('Saved payment method in checkout:', savedPaymentMethod);
    
    // Debug: Check all available payment radios
    const allPaymentRadios = document.querySelectorAll('input[name="pay"]');
    console.log('All payment radios found:', allPaymentRadios.length);
    allPaymentRadios.forEach((radio, index) => {
        console.log(`Radio ${index}: value="${radio.value}", checked=${radio.checked}`);
    });
    
    const paymentRadio = document.querySelector(`input[name="pay"][value="${savedPaymentMethod}"]`);
    if (paymentRadio) {
        console.log('Auto-selecting payment method:', savedPaymentMethod);
        console.log('Found radio button:', paymentRadio.outerHTML);
        
        // Force uncheck all first
        console.log('Unchecking all radios...');
        document.querySelectorAll('input[name="pay"]').forEach(radio => {
            radio.checked = false;
            console.log(`Unchecked radio ${radio.value}:`, radio.checked);
        });
        
        // Then check the correct one
        paymentRadio.checked = true;
        console.log('Radio button checked:', paymentRadio.checked);
        console.log('Radio button HTML after check:', paymentRadio.outerHTML);
        
        // Verify the selection
        const verifiedRadio = document.querySelector(`input[name="pay"][value="${savedPaymentMethod}"]`);
        console.log('Verification - Radio still checked:', verifiedRadio?.checked);
        
        // Force trigger change event after a small delay
        setTimeout(() => {
            console.log('Force triggering change event...');
            paymentRadio.dispatchEvent(new Event('change', { bubbles: true }));
        }, 100);
        
        handlePaymentMethodChange();
    } else {
        console.log('Payment radio not found for:', savedPaymentMethod);
        console.log('Available values:', Array.from(allPaymentRadios).map(r => r.value));
    }
    
    // Initialize checkout summary with current values
    updateCheckoutSummary();
    
    // Sync payment method from cart with delay to ensure DOM is ready
    setTimeout(() => {
        console.log('First checkout sync attempt...');
        syncPaymentMethod();
        // Retry after a longer delay to ensure everything is loaded
        setTimeout(() => {
            console.log('Retrying payment method sync in checkout...');
            syncPaymentMethod();
        }, 500);
    }, 200);
    
    // Force sync one more time after everything is initialized
    setTimeout(() => {
        console.log('Final force sync attempt...');
        syncPaymentMethod();
    }, 1000);
    
    // Initialize suggested products
    initCheckoutSuggestedProducts();
}

// Handle payment method change
function handlePaymentMethodChange() {
    console.log('=== CHECKOUT PAYMENT METHOD CHANGED ===');
    
    const selectedPayment = document.querySelector('input[name="pay"]:checked');
    const bankTransferSection = document.getElementById('bankTransferSection');
    
    console.log('Selected payment method:', selectedPayment?.value);
    console.log('Bank transfer section element found:', !!bankTransferSection);
    console.log('Bank transfer section current display:', bankTransferSection?.style.display);
    
    if (selectedPayment && selectedPayment.value === 'bankTransfer') {
        console.log('Showing bank transfer section');
        bankTransferSection.classList.remove('d-none');
        console.log('Bank transfer section display after show:', bankTransferSection?.style.display);
        console.log('Bank transfer section classes after show:', bankTransferSection?.className);
    } else {
        console.log('Hiding bank transfer section');
        bankTransferSection.classList.add('d-none');
        console.log('Bank transfer section display after hide:', bankTransferSection?.style.display);
    }
    
    // Save selected payment method
    if (selectedPayment) {
        savePaymentMethod(selectedPayment.value);
        console.log('Payment method saved to localStorage:', selectedPayment.value);
    } else {
        console.log('No payment method selected, cannot save');
    }
    
    // Update checkout summary when payment method changes
    updateCheckoutSummary();
    
    console.log('=== CHECKOUT PAYMENT METHOD CHANGE COMPLETED ===');
}

// Initialize cart payment method events
function initCartPaymentEvents() {
    console.log('=== INITIALIZING CART PAYMENT EVENTS ===');
    
    const paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');
    console.log('Found cart payment radios:', paymentRadios.length);
    
    if (paymentRadios.length === 0) {
        console.error('No cart payment radios found! This should not happen on cart page.');
        return;
    }
    
    paymentRadios.forEach((radio, index) => {
        console.log(`Adding event listener to radio ${index}:`, radio.value, radio.checked);
        radio.addEventListener('change', handleCartPaymentChange);
    });
    
    // Initialize bank transfer info display
    console.log('Calling handleCartPaymentChange to initialize display...');
    handleCartPaymentChange();
    
    // Add event listener to checkout button to sync payment method
    const checkoutBtn = document.getElementById('checkoutBtn');
    if (checkoutBtn) {
        console.log('Checkout button found, adding event listener');
        checkoutBtn.addEventListener('click', function(e) {
            console.log('=== CHECKOUT BUTTON CLICKED ===');
            // Force save current payment method
            const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked');
            if (selectedPayment) {
                console.log('Force saving payment method:', selectedPayment.value);
                savePaymentMethod(selectedPayment.value);
            } else {
                console.log('No payment method selected in cart');
            }
            // Sync payment method before navigation
            syncPaymentMethod();
            console.log('Payment method synced, proceeding to checkout...');
        });
    } else {
        console.log('Checkout button not found');
    }
}

// Sync payment method between cart and checkout
function syncPaymentMethod() {
    console.log('=== SYNCING PAYMENT METHOD ===');
    
    // Auto-sync from cart to checkout
    const savedPaymentMethod = getPaymentMethod();
    console.log('Saved payment method:', savedPaymentMethod);
    
    // Debug: Check all available radio buttons
    const allCartRadios = document.querySelectorAll('input[name="paymentMethod"]');
    const allCheckoutRadios = document.querySelectorAll('input[name="pay"]');
    console.log('Found cart radios:', allCartRadios.length);
    console.log('Found checkout radios:', allCheckoutRadios.length);
    
    // Update cart payment method
    const cartPaymentRadio = document.querySelector(`input[name="paymentMethod"][value="${savedPaymentMethod}"]`);
    if (cartPaymentRadio) {
        console.log('Updating cart payment method to:', savedPaymentMethod);
        cartPaymentRadio.checked = true;
        handleCartPaymentChange();
    } else {
        console.log('Cart payment radio not found for:', savedPaymentMethod);
        console.log('Available cart values:', Array.from(allCartRadios).map(r => r.value));
    }
    
    // Update checkout payment method
    const checkoutPaymentRadio = document.querySelector(`input[name="pay"][value="${savedPaymentMethod}"]`);
    if (checkoutPaymentRadio) {
        console.log('Updating checkout payment method to:', savedPaymentMethod);
        console.log('Found checkout radio button:', checkoutPaymentRadio.outerHTML);
        
        // Force uncheck all first
        const allCheckoutRadios = document.querySelectorAll('input[name="pay"]');
        console.log('Unchecking all checkout radios...');
        allCheckoutRadios.forEach(radio => {
            radio.checked = false;
        });
        
        // Then check the correct one
        checkoutPaymentRadio.checked = true;
        console.log('Checkout radio button checked:', checkoutPaymentRadio.checked);
        
        handlePaymentMethodChange();
    } else {
        console.log('Checkout payment radio not found for:', savedPaymentMethod);
        console.log('Available checkout values:', Array.from(checkoutPaymentInputs).map(input => input.value));
    }
    
    console.log('=== PAYMENT METHOD SYNCED ===');
}

// Handle cart payment method change
// Handle place order
// Global flag to prevent multiple order submissions
let isOrderBeingProcessed = false;

async function handlePlaceOrder() {
    console.log('[Checkout] handlePlaceOrder invoked');
    
    // Prevent multiple submissions
    if (isOrderBeingProcessed) {
        console.log('[Checkout] Blocked: order already being processed');
        return;
    }
    
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    
    if (cart.length === 0) {
        console.log('[Checkout] Blocked: cart is empty');
        return;
    }
    
    // Set processing flag and disable button immediately
    isOrderBeingProcessed = true;
    const placeOrderBtn = document.getElementById('place-order-btn');
    if (placeOrderBtn) {
        placeOrderBtn.disabled = true;
        placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang x·ª≠ l√Ω...';
    }

    const isCheckoutPage = document.querySelector('input[name="pay"]') !== null;
    if (isCheckoutPage) {
        const formRoot = document.getElementById('checkoutForm') || document;
        // Clear previous invalid states
        formRoot.querySelectorAll('.is-invalid').forEach(el => clearInvalidField(el));

        // Prefer explicit known fields
        const explicitIds = ['fullName','phone','city','shippingAddress'];
        let requiredEls = explicitIds
            .map(id => formRoot.querySelector(`#${id}`) || formRoot.querySelector(`[name="${id}"]`))
            .filter(Boolean);

        // Fallback to generic required markers if explicit not found
        if (requiredEls.length === 0) {
            requiredEls = Array.from(formRoot.querySelectorAll('[required], .checkout-required'))
                .filter(el => el.type !== 'email' && !/email/i.test(el.name || el.id || '') && !/ghi chu|note|message/i.test(el.name || el.id || ''));
        }

        let hasInvalid = false;
        let firstInvalid = null;
        requiredEls.forEach(el => {
            const val = (el.value || '').toString().trim();
            if (!val) {
                hasInvalid = true;
                if (!firstInvalid) firstInvalid = el;
                console.log('[Checkout] Missing field:', el.id || el.name || el.placeholder || el.outerHTML);
                markInvalidField(el);
                const handler = () => clearInvalidField(el);
                el.addEventListener('input', handler, { once: true });
                el.addEventListener('change', handler, { once: true });
            }
        });

        // Bank transfer proof only if element exists and method is bankTransfer
        const selectedPay = document.querySelector('input[name="pay"]:checked');
        let bankTransferImageUrl = null;
        
        if (selectedPay && selectedPay.value === 'bankTransfer') {
            const proofInput = document.getElementById('transferProof')
                || document.getElementById('bankTransferProof')
                || document.querySelector('#bankTransferSection input[type="file"]')
                || null; // do not search too wide; if null, don't block
            if (proofInput) {
                const hasFile = proofInput.files && proofInput.files.length > 0;
                if (!hasFile) {
                    hasInvalid = true;
                    if (!firstInvalid) firstInvalid = proofInput;
                    console.log('[Checkout] Missing bank transfer proof file');
                    markInvalidField(proofInput, 'Vui l√≤ng t·∫£i ·∫£nh/b·∫±ng ch·ª©ng chuy·ªÉn kho·∫£n', { marginLeft: '20px', marginBottom: '5px' });
                    proofInput.addEventListener('change', () => clearInvalidField(proofInput), { once: true });
                } else {
                    // Upload bank transfer image to Cloudinary
                    try {
                        console.log('[Checkout] Uploading bank transfer image...');
                        const uploadFormData = new FormData();
                        uploadFormData.append('file', proofInput.files[0]);
                        
                        const uploadResponse = await fetch('/api/upload-bank-transfer', {
                            method: 'POST',
                            body: uploadFormData
                        });
                        
                        if (uploadResponse.ok) {
                            const uploadResult = await uploadResponse.json();
                            bankTransferImageUrl = uploadResult.url;
                            console.log('[Checkout] Bank transfer image uploaded successfully:', bankTransferImageUrl);
                        } else {
                            const errorResult = await uploadResponse.json();
                            console.error('[Checkout] Failed to upload bank transfer image:', errorResult);
                            showNotification('L·ªói upload ·∫£nh chuy·ªÉn kho·∫£n: ' + (errorResult.error || 'Unknown error'), 'error');
                            return;
                        }
                    } catch (uploadError) {
                        console.error('[Checkout] Error uploading bank transfer image:', uploadError);
                        showNotification('L·ªói upload ·∫£nh chuy·ªÉn kho·∫£n: ' + uploadError.message, 'error');
                        return;
                    }
                }
            }
        }

        if (hasInvalid) {
            console.log('[Checkout] Blocked: has invalid fields');
            firstInvalid && firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        // Collect form data for API
        const shippingAddress = (document.getElementById('shippingAddress')?.value || '').trim();
        const orderNote = (document.getElementById('orderNote')?.value || '').trim();
        
        const appliedVoucher = getAppliedVoucher();
        const formData = {
            customer_name: (document.getElementById('fullName')?.value || '').trim(),
            phone_number: (document.getElementById('phone')?.value || '').trim(),
            email: (document.getElementById('email')?.value || '').trim(),
            street: shippingAddress, // Full address including ward/district info
            ward: '', // Not available in current form - could be parsed from shippingAddress if needed
            district: '', // Not available in current form - could be parsed from shippingAddress if needed  
            province: (document.getElementById('city')?.value || '').trim(),
            payment_method: selectedPay?.value === 'bankTransfer' ? 'bank' : (selectedPay?.value || 'cod')
        };

        // Only add optional fields if they have values
        if (appliedVoucher && appliedVoucher.code) {
            formData.voucher_code = appliedVoucher.code;
        }
        if (orderNote && orderNote.trim()) {
            formData.notes = orderNote.trim();
        }

        // Prepare items data
        const items_data = cart.map(item => ({
            product: item.id,
            quantity: item.quantity
        }));

        // Get shipping fee from checkout-shipping field (already divided by 1000)
        const shippingFeeInput = formRoot.querySelector('#checkout-shipping') || formRoot.querySelector('[name="checkout-shipping"]');
        const shipping_fee = shippingFeeInput ? parseFloat(shippingFeeInput.value) || 0 : 0;

        const orderData = {
            ...formData,
            items_data: items_data,
            shipping_fee: shipping_fee
        };

        // Add bank transfer image URL if available
        if (bankTransferImageUrl) {
            orderData.bank_transfer_image = bankTransferImageUrl;
        }

        // Validate required fields before sending
        if (!formData.customer_name || !formData.phone_number || !formData.street || !formData.province) {
            showNotification('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc.', 'error');
            return;
        }

        // Validate items data
        if (!items_data || items_data.length === 0) {
            showNotification('Gi·ªè h√†ng tr·ªëng. Vui l√≤ng th√™m s·∫£n ph·∫©m tr∆∞·ªõc khi ƒë·∫∑t h√†ng.', 'error');
            return;
        }

        console.log('[Checkout] Sending order data:', orderData);
        console.log('[Checkout] Items count:', items_data.length);
        console.log('[Checkout] Customer:', formData.customer_name);
        console.log('[Checkout] Phone:', formData.phone_number);
        console.log('[Checkout] Payment method:', formData.payment_method);
        console.log('[Checkout] Voucher applied:', appliedVoucher ? appliedVoucher.code : 'None');
        console.log('[Checkout] Order note:', orderNote || 'None');

        // Button already disabled above

        try {

            // Send order to API
            const response = await fetch('https://buddyskincare.pythonanywhere.com/orders/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            });

            if (response.ok) {
                const result = await response.json();
                console.log('[Checkout] Order created successfully:', result);
    
    // Success flow: show pretty modal, then clear and redirect on OK
    showOrderSuccessModal(() => {
        // Clear cart
        localStorage.removeItem('cart');
        localStorage.setItem('cartCount', '0');

        // Clear voucher and its UI
        try {
            clearVoucher();
            clearVoucherDisplay(false);
            clearVoucherDisplay(true);
        } catch (e) {}

        // Redirect
        window.location.href = '/';
    });
            } else {
                const errorData = await response.json();
                console.error('[Checkout] Order creation failed:', errorData);
                console.error('[Checkout] Response status:', response.status);
                
                // Show specific error message if available
                let errorMessage = 'C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t h√†ng. Vui l√≤ng th·ª≠ l·∫°i.';
                
                if (response.status === 400) {
                    // Handle validation errors
                    if (errorData.voucher_code) {
                        errorMessage = 'M√£ voucher kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i.';
                    } else if (errorData.items_data) {
                        errorMessage = 'Th√¥ng tin s·∫£n ph·∫©m kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i.';
                    } else if (errorData.customer_name) {
                        errorMessage = 'T√™n kh√°ch h√†ng kh√¥ng h·ª£p l·ªá.';
                    } else if (errorData.phone_number) {
                        errorMessage = 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá.';
                    } else if (errorData.email) {
                        errorMessage = 'Email kh√¥ng h·ª£p l·ªá.';
                    } else {
                        errorMessage = 'D·ªØ li·ªáu ƒë∆°n h√†ng kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin.';
                    }
                } else if (errorData.detail) {
                    errorMessage = errorData.detail;
                } else if (errorData.message) {
                    errorMessage = errorData.message;
                } else if (errorData.error) {
                    errorMessage = errorData.error;
                }
                
                showNotification(errorMessage, 'error');
            }
        } catch (error) {
            console.error('[Checkout] Network error:', error);
            showNotification('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.', 'error');
        } finally {
            // Reset button state and processing flag
            if (placeOrderBtn) {
                placeOrderBtn.disabled = false;
                placeOrderBtn.innerHTML = 'ƒê·∫∑t h√†ng';
            }
            isOrderBeingProcessed = false;
        }
    } else {
        // For non-checkout pages, just show success modal
        showOrderSuccessModal(() => {
            // Clear cart
            localStorage.removeItem('cart');
            localStorage.setItem('cartCount', '0');

            // Clear voucher and its UI
            try {
                clearVoucher();
                clearVoucherDisplay(false);
                clearVoucherDisplay(true);
            } catch (e) {}

            // Redirect
            window.location.href = '/';
        });
    }
}

// Initialize additional features
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM loaded, initializing...');
    console.log('üîç Checking Flash Sale container...');
    const flashContainer = document.querySelector('#flash-sale-products');
    console.log('üéØ Flash Sale container found:', flashContainer);
    
    // Initialize all components
    initCountdownTimer();
    initProductCards();
    initNewsletterForm();
    initAnimations();
    initMobileMenu();
    initCartQuantityControls();
    initCartBadgeZero();
    initSearch();
    initLazyLoading();
    initSmoothScrolling();
    console.log('üöÄ About to initialize Flash Sale products...');
    initFlashSaleProducts(); // Kh·ªüi t·∫°o Flash Sale
    console.log('‚úÖ Flash Sale products initialization completed');
    initNewProducts(); // Kh·ªüi t·∫°o s·∫£n ph·∫©m m·ªõi
    initFeaturedProducts(); // Kh·ªüi t·∫°o s·∫£n ph·∫©m n·ªïi b·∫≠t
    initCart(); // Kh·ªüi t·∫°o gi·ªè h√†ng
    initProductsPage(); // Kh·ªüi t·∫°o trang danh s√°ch s·∫£n ph·∫©m ƒë·ªông
    (typeof defineProductDetailInit === 'function' ? defineProductDetailInit : () => {})(); // Kh·ªüi t·∫°o trang chi ti·∫øt n·∫øu c√≥
    initRelatedProducts(); // Kh·ªüi t·∫°o s·∫£n ph·∫©m li√™n quan

    // Ensure modal dismiss buttons always work
    document.addEventListener('click', function(e) {
        const dismissBtn = e.target.closest('[data-bs-dismiss="modal"]');
        if (!dismissBtn) return;
        const modalEl = dismissBtn.closest('.modal');
        if (modalEl && window.bootstrap) {
            try {
                const instance = bootstrap.Modal.getOrCreateInstance(modalEl);
                instance.hide();
            } catch (err) {
                // ignore
            }
        }
    });
    
    // Force sync payment method after page is fully loaded
    window.addEventListener('load', function() {
        console.log('=== PAGE FULLY LOADED ===');
        setTimeout(() => {
            console.log('Force syncing payment method after page load...');
            syncPaymentMethod();
        }, 300);
    });
});

// --- Dynamic Products Section ---

// H√†m chung ƒë·ªÉ fetch v√† render s·∫£n ph·∫©m
async function fetchAndRenderProducts(apiUrl, containerSelector, cardFunction = createProductCard, viewAllButton = null) {
    console.log('üîç fetchAndRenderProducts called with:', {apiUrl, containerSelector});
    const container = document.querySelector(containerSelector);
    if (!container) {
        console.error(`‚ùå Kh√¥ng t√¨m th·∫•y container v·ªõi selector: ${containerSelector}`);
        return;
    }
    console.log('‚úÖ Container found:', container);

    // X√≥a n·ªôi dung c≈© tr∆∞·ªõc khi th√™m m·ªõi
    container.innerHTML = '';

    try {
        console.log(`üì° ƒêang t·∫£i d·ªØ li·ªáu t·ª´: ${apiUrl}`);
        const response = await fetch(apiUrl);
        console.log('üì° Response status:', response.status);
        if (!response.ok) {
            throw new Error('L·ªói khi l·∫•y d·ªØ li·ªáu t·ª´ API');
        }
        const products = await response.json();
        console.log(`‚úÖ ƒê√£ t·∫£i ƒë∆∞·ª£c ${products.length} s·∫£n ph·∫©m:`, products.slice(0, 2));
        
        if (products.length === 0) {
            container.innerHTML = '<p class="text-muted text-center py-4">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë·ªÉ hi·ªÉn th·ªã.</p>';
            return;
        }

        // T·∫°o wrapper cho carousel
        const carouselWrapper = document.createElement('div');
        carouselWrapper.className = 'position-relative';
        carouselWrapper.style.overflow = 'hidden';
        carouselWrapper.style.padding = '10px 40px'; // Gi·∫£m padding d·ªçc t·ª´ 30px xu·ªëng 5px ƒë·ªÉ tr√°nh c·∫Øt n√∫t
        
        // T·∫°o container cho s·∫£n ph·∫©m (1 h√†ng, kh√¥ng xu·ªëng d√≤ng)
        const productsContainer = document.createElement('div');
        productsContainer.className = 'homepage-products';
        productsContainer.style.display = 'flex';
        productsContainer.style.flexWrap = 'nowrap';
        productsContainer.style.gap = '16px';
        productsContainer.style.transition = 'transform 0.4s ease';
        productsContainer.style.willChange = 'transform';
        productsContainer.id = `${containerSelector.replace('#', '')}-products`;
        productsContainer.dataset.currentIndex = '0';
        productsContainer.dataset.totalProducts = String(products.length);
        productsContainer.dataset.productsPerView = '5';

        const productsPerView = 5;
        // T·∫°o t·∫•t c·∫£ s·∫£n ph·∫©m; width s·∫Ω ƒë∆∞·ª£c t√≠nh theo pixel trong layoutSlider()
        products.forEach(product => {
            const item = document.createElement('div');
            item.className = 'slider-item';
            item.style.flex = '0 0 auto';
            item.style.minWidth = '0';
            item.innerHTML = cardFunction(product);
            productsContainer.appendChild(item);
        });

        carouselWrapper.appendChild(productsContainer);
        container.appendChild(carouselWrapper);

        // Th√™m n√∫t ƒëi·ªÅu h∆∞·ªõng n·∫øu c√≥ nhi·ªÅu h∆°n productsPerView s·∫£n ph·∫©m
        if (products.length > productsPerView) {
            // N√∫t tr√°i
            const leftBtn = document.createElement('button');
            leftBtn.className = 'btn btn-light position-absolute carousel-nav-btn carousel-left-btn';
            leftBtn.style.cssText = 'z-index: 10; border-radius: 50%; width: 40px; height: 40px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); top: calc(40% - 10px); left: 20px; transform: translateY(-50%); background-color: #fff;';
            leftBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            leftBtn.onclick = () => navigateProducts(containerSelector, 'left');
            
            // N√∫t ph·∫£i
            const rightBtn = document.createElement('button');
            rightBtn.className = 'btn btn-light position-absolute carousel-nav-btn carousel-right-btn';
            rightBtn.style.cssText = 'z-index: 10; border-radius: 50%; width: 40px; height: 40px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); top: calc(40% - 10px); right: 20px; transform: translateY(-50%); background-color: #fff;';
            rightBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            rightBtn.onclick = () => navigateProducts(containerSelector, 'right');
            
            carouselWrapper.appendChild(leftBtn);
            carouselWrapper.appendChild(rightBtn);

            // Th√™m n√∫t "Xem t·∫•t c·∫£" ·ªü cu·ªëi
            const defaultButton = `
                <div class="col-12 text-center mt-4">
                    <a href="/products" class="btn btn-outline-primary">
                        <i class="fas fa-eye me-2"></i>Xem t·∫•t c·∫£ s·∫£n ph·∫©m
                    </a>
                </div>
            `;
            const buttonHTML = viewAllButton || defaultButton;
            container.insertAdjacentHTML('beforeend', buttonHTML);

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i ban ƒë·∫ßu
            updateNavigationButtons(containerSelector, 0);
        }

        // T√≠nh layout theo k√≠ch th∆∞·ªõc wrapper hi·ªán t·∫°i
        layoutSlider(containerSelector);
        // Re-layout on resize (debounced)
        window.addEventListener('resize', debounce(() => layoutSlider(containerSelector), 150));

        // Re-initialize Product Cards with new DOM elements
        initProductCards();
        // Re-initialize Animations with new DOM elements
        initAnimations();

    } catch (error) {
        console.error(`ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ ${apiUrl}:`, error);
        container.innerHTML = '<p class="text-danger text-center py-4">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i sau.</p>';
    }
}

// H√†m kh·ªüi t·∫°o cho Flash Sale
function initFlashSaleProducts() {
    console.log('üöÄ Initializing Flash Sale products...');
    const flashSaleApiUrl = '/api/products?tags=FlashSale';
    const containerSelector = '#flash-sale-products';
    const flashSaleButton = `
        
    `;
    console.log('üì° Flash Sale API URL:', flashSaleApiUrl);
    console.log('üéØ Container selector:', containerSelector);
    fetchAndRenderProducts(flashSaleApiUrl, containerSelector, createFlashSaleProductCard, flashSaleButton);
}

// H√†m kh·ªüi t·∫°o cho s·∫£n ph·∫©m m·ªõi
function initNewProducts() {
    const newProductsApiUrl = '/api/products?sort=latest';
    const containerSelector = '#new-product-products';
    fetchAndRenderProducts(newProductsApiUrl, containerSelector, createProductCard);
}

// H√†m kh·ªüi t·∫°o cho s·∫£n ph·∫©m n·ªïi b·∫≠t
function initFeaturedProducts() {
    const featuredProductsApiUrl = '/api/products?sort=sales';
    const containerSelector = '#featured-products-container';
    fetchAndRenderProducts(featuredProductsApiUrl, containerSelector, createProductCard);
}

// H√†m ƒëi·ªÅu h∆∞·ªõng s·∫£n ph·∫©m (tr∆∞·ª£t theo trang, responsive)
function navigateProducts(containerSelector, direction) {
    const container = document.querySelector(containerSelector);
    const productsContainer = container.querySelector('.homepage-products');
    if (!productsContainer) return;
    const wrapper = productsContainer.parentElement; // carouselWrapper

    const currentIndex = parseInt(productsContainer.dataset.currentIndex || '0', 10);
    const totalProducts = parseInt(productsContainer.dataset.totalProducts || '0', 10);
    const productsPerView = parseInt(productsContainer.dataset.productsPerView || '5', 10);

    // T√≠nh step theo chi·ªÅu r·ªông 1 item + gap
    const firstItem = productsContainer.querySelector('.slider-item');
    const gap = 16; // Fixed gap
    const paddingX = productsPerView === 2 ? 32 : productsPerView === 3 ? 40 : 80; // Responsive padding
    const availableWidth = wrapper.clientWidth - paddingX;
    const totalGapWidth = gap * (productsPerView - 1);
    const itemWidth = firstItem ? firstItem.offsetWidth : Math.floor((availableWidth - totalGapWidth) / productsPerView);
    const step = itemWidth + gap;

    // Ch·ªâ s·ªë b·∫Øt ƒë·∫ßu t·ªëi ƒëa sao cho v·∫´n ƒë·ªß productsPerView s·∫£n ph·∫©m trong khung nh√¨n
    const maxStartIndex = Math.max(0, totalProducts - productsPerView);

    let newIndex = currentIndex;
    if (direction === 'left') {
        newIndex = Math.max(0, currentIndex - 1);
    } else {
        newIndex = Math.min(maxStartIndex, currentIndex + 1);
    }

    if (newIndex !== currentIndex) {
        productsContainer.dataset.currentIndex = String(newIndex);
        const translatePx = -newIndex * step;
        productsContainer.style.transform = `translateX(${translatePx}px)`;
        updateNavigationButtons(containerSelector, newIndex);
    }
}

// C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t ƒëi·ªÅu h∆∞·ªõng
function updateNavigationButtons(containerSelector, currentIndex) {
    const container = document.querySelector(containerSelector);
    if (!container) return;

    const productsContainer = container.querySelector('.homepage-products');
    const totalProducts = parseInt(productsContainer?.dataset?.totalProducts || '0', 10);
    const productsPerView = parseInt(productsContainer?.dataset?.productsPerView || '5', 10);
    const maxStartIndex = Math.max(0, totalProducts - productsPerView);

    const leftBtn = container.querySelector('.carousel-left-btn');
    const rightBtn = container.querySelector('.carousel-right-btn');

    if (leftBtn) {
        leftBtn.disabled = currentIndex === 0;
        leftBtn.style.opacity = currentIndex === 0 ? '0.5' : '1';
    }
    if (rightBtn) {
        rightBtn.disabled = currentIndex >= maxStartIndex;
        rightBtn.style.opacity = currentIndex >= maxStartIndex ? '0.5' : '1';
    }
}

// Ch·ª©c nƒÉng l√†m s·∫°ch container
function clearProductsContainer() {
    // H√†m n√†y kh√¥ng c√≤n c·∫ßn thi·∫øt cho vi·ªác chung, nh∆∞ng v·∫´n gi·ªØ n·∫øu c√≥ nhu c·∫ßu kh√°c.
    // T·ªët h∆°n l√† n√™n d√πng logic clear container b√™n trong fetchAndRenderProducts.
}

// H√†m ƒë·ªãnh d·∫°ng gi√° ti·ªÅn v·ªõi d·∫•u ch·∫•m
function formatPrice(price) {
    if (price === null || price === undefined) {
        return 'ƒêang c·∫≠p nh·∫≠t';
    }
    // Chuy·ªÉn ƒë·ªïi gi√° v·ªÅ d·∫°ng s·ªë, sau ƒë√≥ ƒë·ªãnh d·∫°ng
    const amount = Number(price);
    if (isNaN(amount)) {
        return 'Gi√° kh√¥ng h·ª£p l·ªá';
    }
    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
}

// H√†m t·∫°o HTML cho m·ªôt s·∫£n ph·∫©m (kh√¥ng b·ªçc c·ªôt)
// Helper function to check if product has FlashSale tag
function isFlashSaleProduct(product) {
    try {
        const tags = product?.tags || [];
        if (Array.isArray(tags)) {
            return tags.some(t => {
                if (typeof t === 'string') return t.toLowerCase() === 'flashsale';
                if (t && typeof t === 'object') return (t.name || '').toLowerCase() === 'flashsale';
                return false;
            });
        }
        return false;
    } catch (error) {
        return false;
    }
}

function createProductCard(product) {
    // Map to backend Product model (no variants/album)
    const imageUrl = (product.image && String(product.image).trim()) || '/static/image/default-product.jpg';
    const brandName = product.brand_name || (product.brand ? product.brand.name : 'Kh√¥ng r√µ');
    
    // Check if product has FlashSale tag
    const isFlashSale = isFlashSaleProduct(product);

    // Determine if product is new by status; otherwise it's used
    const statusText = (product.status || '').toString().toLowerCase();
    const isNewByStatus = statusText.includes('new') || statusText.includes('chiet');
    let remainingPercent = null;
    if (!isNewByStatus) {
        const m = statusText.match(/(\d{2})/);
        remainingPercent = m ? m[1] : null;
    }
    const usedLabel = !isNewByStatus
        ? (statusText.includes('test') ? 'Test 1-2 l·∫ßn' : (remainingPercent ? `C√≤n ${remainingPercent}%` : null))
        : null;
    const newLabel = isNewByStatus ? (function(){
        if (statusText.includes('chiet')) return 'Chi·∫øt';
        if (statusText === 'new') return 'New nguy√™n';
        if (statusText.includes('newmh')) return 'New m·∫•t h·ªôp';
        if (statusText.includes('newm')) return 'New m√≥p h·ªôp';
        if (statusText.includes('newrt')) return 'New r√°ch tem';
        if (statusText.includes('newmn')) return 'New m√≥p nh·∫π';
        if (statusText.includes('newx')) return 'New x∆∞·ªõc nh·∫π';
        if (statusText.includes('newspx')) return 'New x∆∞·ªõc';
        return 'New';
    })() : null;
    const infoLabel = isNewByStatus ? newLabel : usedLabel;

    const originalPrice = typeof product.original_price === 'number' ? product.original_price : null;
    const discountedPrice = typeof product.discounted_price === 'number' ? product.discounted_price : null;
    const rating = typeof product.rating === 'number' ? product.rating : (parseFloat(product.rating) || 0);
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5 && rating % 1 < 1;

    let starsHTML = '';
    for (let i = 0; i < fullStars; i++) starsHTML += '<i class="fas fa-star"></i>';
    if (hasHalfStar) starsHTML += '<i class="fas fa-star-half-alt"></i>';
    for (let i = fullStars + (hasHalfStar ? 1 : 0); i < 5; i++) starsHTML += '<i class="far fa-star"></i>';

    const discountRate = (typeof product.discount_rate === 'number')
        ? Math.round(product.discount_rate)
        : ((originalPrice && discountedPrice) ? Math.round(((originalPrice - discountedPrice) / originalPrice) * 100) : 0);
    const stockQuantity = typeof product.stock_quantity === 'number' ? product.stock_quantity : 0;

    const productName = product.name;

    const cardHTML = `
        <div class="product-card card h-100 border-0 shadow-sm ${isFlashSale ? 'flash-sale-card' : ''}" style="${isFlashSale ? 'border: 2px solid #ffc107 !important;' : ''}">
            <div class="position-relative">
                <a href="/product/${product.id}" class="text-decoration-none">
                    <img src="${imageUrl}" class="card-img-top" alt="${productName}" style="height: 220px; object-fit: cover;">
                </a>
                <div class="position-absolute top-0 end-0 m-2">
                    <i class="fas fa-heart text-white" style="font-size: 18px; text-shadow: 0 1px 3px rgba(0,0,0,0.5);"></i>
                </div>
                <div class="position-absolute bottom-0 start-0 m-1">
                    <img src="/static/image/logo.png" alt="Logo" class="product-logo" style="width: 28px; height: 28px; object-fit: contain; border-radius: 50%; background: white; padding: 2px; display: block; z-index: 10; box-shadow: 0 1px 3px rgba(0,0,0,0.2);" onerror="this.style.display='none';">
                </div>
                <div class="product-badges-row position-absolute" style="top:8px;left:10px;display:flex;gap:6px;align-items:center;z-index:2;">
                    ${discountRate > 0 ? `<div class=\"badge bg-danger discount-badge-left\" style=\"font-size: 11px; padding: 4px 8px;\">-${discountRate}%</div>` : ''}
                    ${infoLabel ? `<div class=\"product-info-badge\" style=\"font-size: 10px; padding: 1px 6px; background:#eaf4ff; border:1px solid #b8d4ff; color:#1e56a0; border-radius:6px;\"><i class="fas fa-circle-info me-1"></i>${infoLabel}</div>` : ''}
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <h6 class="card-title fw-bold" style="font-size: 12px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; height: 16px;">
                    <a href="/product/${product.id}" class="text-decoration-none text-dark">${productName}</a>
                </h6>
                <p class="text-muted small mb-2" style="font-size: 10px;">${brandName}${infoLabel ? ` ‚Ä¢ ${infoLabel}` : ''}</p>
                <div class="d-flex align-items-center mb-1">
                    ${originalPrice ? `<span class="text-decoration-line-through text-muted me-1" style="font-size: 11px;">${formatPrice(originalPrice)}</span>` : ''}
                    <span class="text-danger fw-bold" style="font-size: 15px;">${formatPrice(discountedPrice)}</span>
                </div>
                <div class="d-flex align-items-center mb-3">
                    <div class="stars text-warning me-2" style="font-size: 12px;">
                        ${starsHTML}
                    </div>
                    <small class="text-muted" style="font-size: 11px;">(${rating})</small>
                    <span class="badge bg-success" style="font-size: 10px; padding: 4px 8px; margin-left: 10px;">C√≤n ${stockQuantity}</span>
                </div>
                <button class="btn w-100 add-to-cart-btn ${isFlashSale ? 'btn-warning text-dark' : 'btn-light text-dark border'}" data-product-id="${product.id}" style="font-size: 13px; padding: 8px;">Th√™m v√†o gi·ªè</button>
            </div>
        </div>
    `;
    return cardHTML;
}

// H√†m t·∫°o HTML cho Flash Sale (kh√¥ng b·ªçc c·ªôt)
function createFlashSaleProductCard(product) {
    const imageUrl = (product.image && String(product.image).trim()) || '/static/image/default-product.jpg';
    const brandName = product.brand_name ? (product.brand_name || 'Kh√¥ng r√µ') : 'Kh√¥ng r√µ';

    const originalPrice = typeof product.original_price === 'number' ? product.original_price : null;
    const discountedPrice = typeof product.discounted_price === 'number' ? product.discounted_price : null;
    const rating = typeof product.rating === 'number' ? product.rating : (parseFloat(product.rating) || 0);
    const reviews = typeof product.rating !== 'undefined' ? rating : 0;

    // Map status to info label (new/used like regular cards)
    const statusText = (product.status || '').toString().toLowerCase();
    const isNewByStatus = statusText.includes('new') || statusText.includes('chiet');
    let remainingPercentFS = null;
    if (!isNewByStatus) {
        const m = statusText.match(/(\d{2})/);
        remainingPercentFS = m ? m[1] : null;
    }
    const usedLabelFS = !isNewByStatus
        ? (statusText.includes('test') ? 'Test 1-2 l·∫ßn' : (remainingPercentFS ? `C√≤n ${remainingPercentFS}%` : null))
        : null;
    const newLabelFS = isNewByStatus ? (function(){
        if (statusText.includes('chiet')) return 'Chi·∫øt';
        if (statusText === 'new') return 'New nguy√™n';
        if (statusText.includes('newmh')) return 'New m·∫•t h·ªôp';
        if (statusText.includes('newm')) return 'New m√≥p h·ªôp';
        if (statusText.includes('newrt')) return 'New r√°ch tem';
        if (statusText.includes('newmn')) return 'New m√≥p nh·∫π';
        if (statusText.includes('newx')) return 'New x∆∞·ªõc nh·∫π';
        if (statusText.includes('newspx')) return 'New x∆∞·ªõc';
        return 'New';
    })() : null;
    const infoLabelFS = isNewByStatus ? newLabelFS : usedLabelFS;

    let starsHTML = '';
    for (let i = 0; i < Math.floor(rating); i++) starsHTML += '<i class="fas fa-star"></i>';
    if (rating % 1 >= 0.5) starsHTML += '<i class="fas fa-star-half-alt"></i>';
    for (let i = Math.ceil(rating); i < 5; i++) starsHTML += '<i class="far fa-star"></i>';

    const discountRate = (typeof product.discount_rate === 'number')
        ? Math.round(product.discount_rate)
        : ((originalPrice && discountedPrice) ? Math.round(((originalPrice - discountedPrice) / originalPrice) * 100) : 0);
    const stockQuantity = typeof product.stock_quantity === 'number' ? product.stock_quantity : 0;
    const soldQuantity = typeof product.sold_quantity === 'number' ? product.sold_quantity : 0;
    const totalStock = stockQuantity + soldQuantity;
    const progressPercentage = totalStock > 0 ? (soldQuantity / totalStock) * 100 : 0;

    const productName = product.name;

    const cardHTML = `
        <div class="product-card card h-100 border-0 shadow-sm flash-sale-card">
            <div class="position-relative">
                <a href="/product/${product.id}" class="text-decoration-none">
                    <img src="${imageUrl}" class="card-img-top" alt="${productName}" style="height: 220px; object-fit: cover;">
                </a>
                <div class="position-absolute top-0 end-0 m-2">
                    <i class="fas fa-heart text-white" style="font-size: 18px; text-shadow: 0 1px 3px rgba(0,0,0,0.5);"></i>
                </div>
                <div class="position-absolute bottom-0 start-0 m-1">
                    <img src="/static/image/logo.png" alt="Logo" class="product-logo" style="width: 28px; height: 28px; object-fit: contain; border-radius: 50%; background: white; padding: 2px; display: block; z-index: 10; box-shadow: 0 1px 3px rgba(0,0,0,0.2);" onerror="this.style.display='none';">
                </div>
                <div>
                <div class="product-badges-row position-absolute" style="top: 8px; left: 10px; display:flex; gap:6px; align-items:center; z-index:2;">
                    <div class="badge bg-warning text-dark discount-badge-left" style="font-size: 10px; padding: 4px 6px;"><i class="fas fa-bolt me-1"></i>FLASH SALE</div>
                    ${infoLabelFS ? `<div class="product-info-badge" style="font-size: 10px; padding: 1px 6px; background:#eaf4ff; border:1px solid #b8d4ff; color:#1e56a0; border-radius:6px;"><i class="fas fa-circle-info me-1"></i>${infoLabelFS}</div>` : ''}
                </div>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <h6 class="card-title fw-bold" style="font-size: 12px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; height: 16px;">
                    <a href="/product/${product.id}" class="text-decoration-none text-dark">${productName}</a>
                </h6>
                <p class="text-muted small mb-1" style="font-size: 12px;">${brandName} <span class="text-success ms-1"><i class="fas fa-badge-check"></i> Ch√≠nh h√£ng</span></p>
                <div class="d-flex align-items-center mb-1">
                    ${originalPrice ? `<span class="text-decoration-line-through text-muted me-1" style="font-size: 9px;">${formatPrice(originalPrice)}</span>` : ''}
                    <span class="text-danger fw-bold" style="font-size: 13px;">${formatPrice(discountedPrice)}</span>
                </div>
                <div class="d-flex align-items-center mb-1">
                    <div class="stars text-warning me-2" style="font-size: 12px;">${starsHTML}</div>
                    <small class="text-muted" style="font-size: 11px;">(${reviews})</small> 
                     ${discountRate > 0 ? `<div class="badge bg-danger position-absolute" style=" right: 20%; font-size: 11px; padding: 4px 8px;">-${discountRate}%</div>` : ''}

                </div>

                <div class="stock mb-2">
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: ${progressPercentage}%" aria-valuenow="${progressPercentage}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <span class="text-success" style="font-size: 11px;">ƒê√£ b√°n ${soldQuantity}</span>
                        <span class="text-muted" style="font-size: 11px;">C√≤n ${stockQuantity}</span>
                    </div>
                </div>
                <ul class="list-unstyled mb-1" style="font-size: 11px;">
                    <li class="text-muted small"><i class="fas fa-shield-alt text-success me-1"></i>ƒê·∫£m b·∫£o ch√≠nh h√£ng</li>
                    <li class="text-muted small"><i class="fas fa-rotate text-primary me-1"></i>ƒê·ªïi tr·∫£ trong 5 ng√†y</li>
                    <li class="text-muted small"><i class="fas fa-truck-fast text-warning me-1"></i>Giao nhanh TP.HCM</li>
                </ul>
                <button class="btn btn-light w-100 text-dark border add-to-cart-btn" data-product-id="${product.id}" style="font-size: 13px; padding: 8px;">Th√™m v√†o gi·ªè</button>
            </div>
        </div>
    `;
    return cardHTML;
}

// --- End of Dynamic Products Section ---

// Countdown Timer for Flash Sale
function initCountdownTimer() {
    const countdownElements = document.querySelectorAll('.countdown-number');
    if (countdownElements.length === 0) return;

    // Set target date (2 days from now)
    const targetDate = new Date();
    targetDate.setDate(targetDate.getDate() + 2);
    targetDate.setHours(15, 30, 45, 0);

    function updateCountdown() {
        const now = new Date().getTime();
        const distance = targetDate.getTime() - now;

        if (distance < 0) {
            // Countdown finished
            countdownElements.forEach(el => el.textContent = '00');
            return;
        }

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        // Update display
        if (countdownElements[0]) countdownElements[0].textContent = days.toString().padStart(2, '0');
        if (countdownElements[1]) countdownElements[1].textContent = hours.toString().padStart(2, '0');
        if (countdownElements[2]) countdownElements[2].textContent = minutes.toString().padStart(2, '0');
        if (countdownElements[3]) countdownElements[3].textContent = seconds.toString().padStart(2, '0');
    }

    // Update countdown every second
    updateCountdown();
    setInterval(updateCountdown, 1000);
}


// Product Cards Interactions
function initProductCards() {
    // Handle both regular product cards and suggested product cards
    const productCards = document.querySelectorAll('.product-card, .suggested-product-card');
    
    productCards.forEach(card => {
        const addToCartBtn = card.querySelector('.add-to-cart-btn');
        const productImage = card.querySelector('img');

        if (addToCartBtn) {
            addToCartBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Prevent multiple clicks
                if (this.disabled) return;
                this.disabled = true;
                
                // Get product ID
                const productId = this.getAttribute('data-product-id');
                
                // Check if this product was already added recently (within 2 seconds)
                const lastAddedKey = `lastAdded_${productId}`;
                const lastAdded = sessionStorage.getItem(lastAddedKey);
                const now = Date.now();
                
                if (lastAdded && (now - parseInt(lastAdded)) < 2000) {
                    // Product was added recently, don't add again
                    this.disabled = false;
                    return;
                }
                
                // Store the current time for this product
                sessionStorage.setItem(lastAddedKey, now.toString());

                // Get product details from the card
                let productName, productPrice, productImg, originalPrice;
                
                if (card.classList.contains('suggested-product-card')) {
                    // For suggested product cards
                    productName = card.querySelector('.card-title')?.textContent || 'S·∫£n ph·∫©m';
                    productPrice = card.querySelector('.text-danger')?.textContent || '0ƒë';
                    productImg = card.querySelector('.card-img-top')?.src || '';
                    originalPrice = card.querySelector('.text-decoration-line-through')?.textContent || null;
                } else {
                    // For regular product cards
                    productName = card.querySelector('.card-title a')?.textContent || 'S·∫£n ph·∫©m';
                    productPrice = card.querySelector('.text-danger')?.textContent || '0ƒë';
                    productImg = card.querySelector('.card-img-top')?.src || '';
                    originalPrice = card.querySelector('.text-decoration-line-through')?.textContent || null;
                }
                
                // Add product to cart
                addProductToCart(productId, productName, productPrice, productImg, originalPrice);

                // Show success notification with cart count
                const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
                // showNotification(`ƒê√£ th√™m "${productName}" v√†o gi·ªè h√†ng! (T·ªïng: ${totalQuantity} s·∫£n ph·∫©m)`, 'success');

                // Trigger fly-to-cart animation
                flyToCart(productImage, () => {
                    // Re-enable button after animation
                    setTimeout(() => {
                        this.disabled = false;
                    }, 1000);
                });
            });
        }
    });
}

// Update Cart Count - Use actual cart items count
function updateCartCount() {
    const cartBadges = document.querySelectorAll('.cart-badge');
    if (cartBadges.length === 0) return;

    // Get cart from localStorage
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    
    // Calculate total quantity
    const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
    
    // Store total count
    localStorage.setItem('cartCount', totalQuantity.toString());

    // Update all cart badges
    cartBadges.forEach(cartBadge => {
        cartBadge.textContent = totalQuantity;

        // Add animation
        cartBadge.style.transform = 'scale(1.2)';
        setTimeout(() => {
            cartBadge.style.transform = 'scale(1)';
        }, 200);
    });
}

// Ensure cart badges show correct count on initial load
function initCartBadgeZero() {
    const cartBadges = document.querySelectorAll('.cart-badge');
    if (cartBadges.length === 0) return;
    
    // Get cart count from localStorage or default to 0
    const cartCount = parseInt(localStorage.getItem('cartCount') || '0', 10);
    
    cartBadges.forEach(badge => {
        badge.textContent = cartCount.toString();
    });
}

// Fly product image to cart icon
function flyToCart(sourceImageEl, onComplete) {
    // Pick the visible cart icon (desktop or mobile)
    const cartIcons = Array.from(document.querySelectorAll('.cart-icon, .fa-shopping-cart'));
    const visibleCartIcon = cartIcons.find(icon => {
        const rect = icon.getBoundingClientRect();
        const style = window.getComputedStyle(icon);
        return rect.width > 0 && rect.height > 0 && style.visibility !== 'hidden' && style.display !== 'none';
    });

    const cartIcon = visibleCartIcon || cartIcons[0];
    if (!sourceImageEl || !cartIcon) {
        if (typeof onComplete === 'function') onComplete();
        return;
    }

    const imgRect = sourceImageEl.getBoundingClientRect();
    const cartRect = cartIcon.getBoundingClientRect();

    const flying = document.createElement('img');
    flying.src = sourceImageEl.src;
    flying.className = 'flying-to-cart';
    flying.style.position = 'fixed';
    flying.style.left = imgRect.left + 'px';
    flying.style.top = imgRect.top + 'px';
    flying.style.width = Math.max(60, Math.min(imgRect.width, 120)) + 'px';
    flying.style.height = 'auto';
    flying.style.borderRadius = '8px';
    flying.style.zIndex = '9999';
    flying.style.transition = 'transform 1.25s cubic-bezier(0.22, 1, 0.36, 1), opacity 1.25s ease';
    flying.style.willChange = 'transform, opacity';
    flying.style.opacity = '0.95';

    document.body.appendChild(flying);

    // Compute translate to cart center
    const start = flying.getBoundingClientRect();
    const targetX = cartRect.left + cartRect.width / 2 - (start.left + start.width / 2);
    const targetY = cartRect.top + cartRect.height / 2 - (start.top + start.height / 2);

    // Animate on next frame
    requestAnimationFrame(() => {
        flying.style.transform = `translate(${targetX}px, ${targetY}px) scale(0.2)`;
        flying.style.opacity = '0.2';
    });

    let hasCompleted = false;
    const cleanup = () => {
        if (hasCompleted) return;
        hasCompleted = true;
        flying.remove();
        // Brief bump on cart icon
        cartIcon.style.transform = 'scale(1.2)';
        setTimeout(() => {
            cartIcon.style.transform = 'scale(1)';
        }, 200);
        if (typeof onComplete === 'function') onComplete();
    };

    flying.addEventListener('transitionend', cleanup, { once: true });
    // Fallback cleanup
    setTimeout(cleanup, 1700);
}

// Newsletter Form
function initNewsletterForm() {
    const newsletterForm = document.querySelector('.newsletter-section .input-group');
    if (!newsletterForm) return;

    const emailInput = newsletterForm.querySelector('input[type="email"]');
    const submitBtn = newsletterForm.querySelector('button');

    submitBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        const email = emailInput.value.trim();
        
        if (!email || !isValidEmail(email)) {
            showNotification('Vui l√≤ng nh·∫≠p email h·ª£p l·ªá!', 'error');
            return;
        }
        
        // Add loading state
        const originalText = this.textContent;
        this.innerHTML = '<span class="loading"></span> ƒêang ƒëƒÉng k√Ω...';
        this.disabled = true;
        
        // Simulate API call
        setTimeout(() => {
            this.innerHTML = '<i class="fas fa-check"></i> ƒê√£ ƒëƒÉng k√Ω!';
            this.classList.remove('btn-light');
            this.classList.add('btn-success');
            emailInput.value = '';
            
            showNotification('ƒêƒÉng k√Ω th√†nh c√¥ng! B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o s·ªõm nh·∫•t.', 'success');
            
            // Reset button after 3 seconds
            setTimeout(() => {
                this.innerHTML = originalText;
                this.classList.remove('btn-success');
                this.classList.add('btn-light');
                this.disabled = false;
            }, 3000);
        }, 1500);
    });
}

// Email validation
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

// Show notification
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show notification-fixed`;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Animations on scroll
function initAnimations() {
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('fade-in');
                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);

    // Observe elements for animation
    const animateElements = document.querySelectorAll('.product-card, .category-card, .testimonial-card');
    animateElements.forEach(el => {
        observer.observe(el);
    });
}

// Mobile menu enhancements
function initMobileMenu() {
    const navbarToggler = document.querySelector('.navbar-toggler');
    const navbarCollapse = document.querySelector('.navbar-collapse');
    
    if (navbarToggler && navbarCollapse) {
        // Close mobile menu when clicking on a link
        const navLinks = navbarCollapse.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 992) {
                    const bsCollapse = new bootstrap.Collapse(navbarCollapse);
                    bsCollapse.hide();
                }
            });
        });
    }
}

// Search functionality
function initSearch() {
    const searchInput = document.querySelector('input[placeholder*="T√¨m ki·∫øm"]');
    if (!searchInput) return;

    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        
        searchTimeout = setTimeout(() => {
            const query = this.value.trim();
            if (query.length >= 2) {
                // Simulate search
                console.log('Searching for:', query);
                // Here you would typically make an API call
            }
        }, 500);
    });
}

// Lazy loading for images
function initLazyLoading() {
    const images = document.querySelectorAll('img[data-src]');
    
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.classList.remove('lazy');
                imageObserver.unobserve(img);
            }
        });
    });

    images.forEach(img => imageObserver.observe(img));
}

// Smooth scrolling for anchor links
// Smooth scrolling for anchor links
function initSmoothScrolling() {
    const anchorLinks = document.querySelectorAll('a[href^="#"]');

    anchorLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            // L·∫•y href c·ªßa th·∫ª <a>
            const targetId = this.getAttribute('href');

            // --- C·∫£i thi·ªán x·ª≠ l√Ω l·ªói ---
            // 1. Ki·ªÉm tra n·∫øu href ch·ªâ l√† "#"
            // 2. Ki·ªÉm tra n·∫øu href l√† chu·ªói r·ªóng
            if (targetId === '#' || targetId === '') {
                // N·∫øu ch·ªâ c√≥ "#", ngƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh v√† tr·ªü v·ªÅ ƒë·∫ßu trang
                e.preventDefault();
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                return; // Ng·ª´ng th·ª±c thi
            }

            // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh
            e.preventDefault();

            // L·∫•y element t·ª´ ID
            const targetElement = document.querySelector(targetId);

            // Ki·ªÉm tra xem element c√≥ t·ªìn t·∫°i kh√¥ng
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            } else {
                console.error('Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ v·ªõi selector:', targetId);
            }
        });
    });
}

// Initialize additional features
document.addEventListener('DOMContentLoaded', function() {
    initSearch();
    initLazyLoading();
    initSmoothScrolling();
});

// Utility function to format currency
function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
    }).format(amount);
}

// Utility function to debounce
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Export functions for global use
window.BeautySale = {
    formatCurrency,
    showNotification,
    updateCartCount
};

// Global scroll to top function
window.scrollToTop = function() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
};

// Initialize floating scroll to top button
document.addEventListener('DOMContentLoaded', function() {
    const scrollTopBtn = document.querySelector('.scroll-top-btn');
    if (scrollTopBtn) {
        scrollTopBtn.style.display = 'none';
        
        window.addEventListener('scroll', function() {
            if (window.scrollY > 300) {
                scrollTopBtn.style.display = 'flex';
            } else {
                scrollTopBtn.style.display = 'none';
            }
        });
    }
}); 

// Cart quantity controls
function initCartQuantityControls() {
    const cartTable = document.querySelector('table');
    if (!cartTable) return;

    function parseNumber(text) {
        return parseInt(String(text).replace(/[^0-9]/g, ''), 10) || 0;
    }

    function updateTotals() {
        const lineTotals = Array.from(document.querySelectorAll('.cart-line-total'));
        const subtotal = lineTotals.reduce((sum, el) => sum + parseNumber(el.textContent), 0);
        const subtotalEl = document.querySelector('.cart-subtotal');
        const shippingEl = document.querySelector('.cart-shipping');
        const totalEl = document.querySelector('.cart-total');
        const shipping = shippingEl ? parseNumber(shippingEl.textContent) : 0;
        if (subtotalEl) subtotalEl.textContent = new Intl.NumberFormat('vi-VN').format(subtotal) + 'ƒë';
        if (totalEl) totalEl.textContent = new Intl.NumberFormat('vi-VN').format(subtotal + shipping) + 'ƒë';

        // Update global cart badge with total quantity
        const totalQty = Array.from(document.querySelectorAll('.cart-qty-input'))
            .reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);
        document.querySelectorAll('.cart-badge').forEach(badge => {
            badge.textContent = totalQty;
        });

        // Toggle empty cart UI
        toggleCartEmptyUI(totalQty === 0);
    }

    // Function to remove product from localStorage and update UI
    function removeProductFromCart(productId) {
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        cart = cart.filter(item => item.id !== productId);
        localStorage.setItem('cart', JSON.stringify(cart));
        
        // Update cart count
        const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
        localStorage.setItem('cartCount', totalQuantity.toString());
        
        // Update cart display
        updateCartDisplay();
        updateCartCount();
        
        // Toggle empty cart UI if cart is now empty
        toggleCartEmptyUI(totalQuantity === 0);
        
        // Update checkout button state
        updateCheckoutButtonState();
    }

    // Function to check stock and update quantity
    async function checkStockAndUpdateQuantity(productId, newQuantity, input, lineTotalEl, unitPrice) {
        try {
            const response = await fetch(`/api/product-stock/${productId}`);
            let stockQuantity = 999; // Default fallback
            
            if (response.ok) {
                const productData = await response.json();
                stockQuantity = productData.stock_quantity || 0;
            }
            
            // Check if new quantity exceeds stock
            if (newQuantity > stockQuantity) {
                showNotification(`Ch·ªâ c√≤n ${stockQuantity} s·∫£n ph·∫©m trong kho!`, 'warning');
                newQuantity = stockQuantity;
            }
            
            // Update UI
            input.value = newQuantity;
            const newLineTotal = unitPrice * newQuantity;
            lineTotalEl.textContent = new Intl.NumberFormat('vi-VN').format(newLineTotal) + 'ƒë';
            
            // Update quantity in localStorage
            await updateProductQuantity(productId, newQuantity);
            
        } catch (error) {
            console.error('Error checking stock:', error);
            showNotification('L·ªói khi ki·ªÉm tra s·ªë l∆∞·ª£ng t·ªìn kho!', 'error');
        }
    }

    // Function to update product quantity in localStorage
    async function updateProductQuantity(productId, newQuantity) {
        try {
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const productIndex = cart.findIndex(item => item.id === productId);
        
        if (productIndex !== -1) {
            if (newQuantity <= 0) {
                // Do not remove here while user is typing; defer to change/confirm handler
                return;
                }
                
                // Check stock availability before updating
                const response = await fetch(`/api/product-stock/${productId}`);
                let stockQuantity = 999; // Default fallback
                
                if (response.ok) {
                    const productData = await response.json();
                    stockQuantity = productData.stock_quantity || 0;
                }
                
                // Check if new quantity exceeds stock
                if (newQuantity > stockQuantity) {
                    showNotification(`Ch·ªâ c√≤n ${stockQuantity} s·∫£n ph·∫©m trong kho!`, 'warning');
                    // Reset to stock quantity
                    newQuantity = stockQuantity;
                }
                
                // Update quantity
                cart[productIndex].quantity = newQuantity;
            
            localStorage.setItem('cart', JSON.stringify(cart));
            
            // Update cart count
            const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
            localStorage.setItem('cartCount', totalQuantity.toString());
            
            // Update cart display
            updateCartDisplay();
            updateCartCount();
            
            // Toggle empty cart UI if cart is now empty
            toggleCartEmptyUI(totalQuantity === 0);
                
                // Update checkout button state
                updateCheckoutButtonState();
            }
        } catch (error) {
            console.error('Error updating product quantity:', error);
            showNotification('L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m!', 'error');
        }
    }

    cartTable.addEventListener('click', function(e) {
        const decreaseBtn = e.target.closest('.cart-qty-decrease');
        const increaseBtn = e.target.closest('.cart-qty-increase');
        const removeBtn = e.target.closest('.cart-remove-btn');
        if (!decreaseBtn && !increaseBtn && !removeBtn) return;

        const row = e.target.closest('tr');
        const input = row.querySelector('.cart-qty-input');
        const priceEl = row.querySelector('.cart-price');
        const lineTotalEl = row.querySelector('.cart-line-total');
        const unitPrice = parseNumber(priceEl?.dataset?.price);

        // Handle remove button explicitly (use modal)
        if (removeBtn) {
            const productId = removeBtn.getAttribute('data-product-id');
            const name = row.querySelector('td:nth-child(2) .fw-semibold')?.textContent?.trim() || 's·∫£n ph·∫©m n√†y';
            showCartConfirm(`B·∫°n c√≥ mu·ªën x√≥a ${name} kh·ªèi gi·ªè h√†ng kh√¥ng?`, () => {
                removeProductFromCart(productId);
            });
            return;
        }

        let qty = parseInt(input.value, 10) || 1;
        const productId = input.getAttribute('data-product-id');
        
        if (increaseBtn) {
            // Check stock before increasing
            checkStockAndUpdateQuantity(productId, qty + 1, input, lineTotalEl, unitPrice);
            return;
        } else if (decreaseBtn) {
            if (qty - 1 <= 0) {
                const name = row.querySelector('td:nth-child(2) .fw-semibold')?.textContent?.trim() || 's·∫£n ph·∫©m n√†y';
                showCartConfirm(`S·ªë l∆∞·ª£ng v·ªÅ 0. B·∫°n c√≥ mu·ªën x√≥a ${name} kh·ªèi gi·ªè h√†ng kh√¥ng?`, () => {
                    removeProductFromCart(productId);
                });
                return;
            } else {
                qty = qty - 1;
            }
        }

        input.value = qty;
        const newLineTotal = unitPrice * qty;
        lineTotalEl.textContent = new Intl.NumberFormat('vi-VN').format(newLineTotal) + 'ƒë';

        // Update quantity in localStorage
        updateProductQuantity(productId, qty);
    });

    // Handle typing quantity directly
    cartTable.addEventListener('input', function(e) {
        const input = e.target.closest('.cart-qty-input');
        if (!input) return;
        const row = input.closest('tr');
        const priceEl = row.querySelector('.cart-price');
        const lineTotalEl = row.querySelector('.cart-line-total');
        const unitPrice = parseNumber(priceEl?.dataset?.price);

        // Keep only digits but allow temporary empty while typing
        const digits = input.value.replace(/[^0-9]/g, '');
        input.value = digits;
        const qty = digits === '' ? null : Math.max(0, parseInt(digits, 10));

        const newLineTotal = (qty === null ? 0 : unitPrice * qty);
        lineTotalEl.textContent = new Intl.NumberFormat('vi-VN').format(newLineTotal) + 'ƒë';
        
        // Do not persist while empty; wait for change/blur
        if (qty !== null) {
            const productId = input.getAttribute('data-product-id');
            // Check stock before updating
            checkStockAndUpdateQuantity(productId, qty, input, lineTotalEl, unitPrice);
        }
    });

    // Enforce minimums and confirm removal on blur/change
    cartTable.addEventListener('change', function(e) {
        const input = e.target.closest('.cart-qty-input');
        if (!input) return;
        const row = input.closest('tr');
        let digits = input.value.replace(/[^0-9]/g, '');
        if (digits === '') digits = '0';
        let qty = Math.max(0, parseInt(digits || '0', 10));

        if (qty <= 0) {
            const productId = input.getAttribute('data-product-id');
            const name = row.querySelector('td:nth-child(2) .fw-semibold')?.textContent?.trim() || 's·∫£n ph·∫©m n√†y';
            showCartConfirm(`S·ªë l∆∞·ª£ng v·ªÅ 0. B·∫°n c√≥ mu·ªën x√≥a ${name} kh·ªèi gi·ªè h√†ng kh√¥ng?`, () => {
                removeProductFromCart(productId);
            });
            // keep input showing 0 until user confirms; totals already updated
            return;
        }

        if (qty > 9999) qty = 9999;
        input.value = String(qty);
        
        const productId = input.getAttribute('data-product-id');
        updateProductQuantity(productId, qty);
        
        const priceEl = row.querySelector('.cart-price');
        const lineTotalEl = row.querySelector('.cart-line-total');
        const unitPrice = parseNumber(priceEl?.dataset?.price);
        const newLineTotal = unitPrice * qty;
        lineTotalEl.textContent = new Intl.NumberFormat('vi-VN').format(newLineTotal) + 'ƒë';
    });

    // Initial sync on load
    updateTotals();
}

// Add product to cart
async function addProductToCart(productId, productName, productPrice, productImg, originalPrice = null, quantity = 1) {
    try {
    // Get current cart from localStorage
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    
    // Normalize quantity
    const qty = Math.max(1, parseInt(quantity, 10) || 1);
        
        // Fetch product stock information from API
        const response = await fetch(`/api/product-stock/${productId}`);
        let stockQuantity = 999; // Default fallback
        
        if (response.ok) {
            const productData = await response.json();
            stockQuantity = productData.stock_quantity || 0;
        }
    
    // Check if product already exists in cart
    const existingProductIndex = cart.findIndex(item => item.id === productId);
    
        let newTotalQuantity = qty;
        if (existingProductIndex !== -1) {
            // Product exists, calculate new total quantity
            newTotalQuantity = cart[existingProductIndex].quantity + qty;
        }
        
        // Check stock availability
        if (newTotalQuantity > stockQuantity) {
            const availableQuantity = stockQuantity - (existingProductIndex !== -1 ? cart[existingProductIndex].quantity : 0);
            
            if (availableQuantity <= 0) {
                showNotification(`S·∫£n ph·∫©m "${productName}" ƒë√£ h·∫øt h√†ng!`, 'error');
                return false;
            } else {
                showNotification(`Ch·ªâ c√≤n ${availableQuantity} s·∫£n ph·∫©m "${productName}" trong kho!`, 'warning');
                return false;
            }
        }
        
        // Add/update product in cart
    if (existingProductIndex !== -1) {
        // Product exists, increment quantity
        cart[existingProductIndex].quantity += qty;
    } else {
        // Product doesn't exist, add new item
        cart.push({
            id: productId,
            name: productName,
            price: productPrice,
            image: productImg,
            originalPrice: originalPrice, // L∆∞u gi√° g·ªëc ƒë·ªÉ t√≠nh ti·∫øt ki·ªám
            quantity: qty
        });
    }
    
    // Save updated cart to localStorage
    localStorage.setItem('cart', JSON.stringify(cart));
    
    // Update all cart-related displays automatically
    updateAllCartDisplays();
    
        // Update checkout button state
        updateCheckoutButtonState();
        
        showNotification(`ƒê√£ th√™m ${qty} x "${productName}" v√†o gi·ªè h√†ng!`, 'success');
    console.log(`ƒê√£ th√™m ${qty} x "${productName}" v√†o gi·ªè. T·ªïng m·∫∑t h√†ng: ${cart.length}`);
        return true;
        
    } catch (error) {
        console.error('Error adding product to cart:', error);
        showNotification('L·ªói khi th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!', 'error');
        return false;
    }
}

// Update cart display
function updateCartDisplay() {
    const cartContainer = document.querySelector('#cart-items-container');
    if (!cartContainer) {
        console.log('Cart container not found - user is not on cart page');
        return;
    }
    
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    
    if (cart.length === 0) {
        cartContainer.innerHTML = `
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center py-5">
                    <img src="/static/image/gif/khoc.gif" alt="empty" class="mx-auto mb-3" style="width: 120px; height: 120px; object-fit: cover;">
                    <h5 class="fw-bold mb-2">Gi·ªè h√†ng tr·ªëng</h5>
                    <p class="text-muted mb-4">B·∫°n ch∆∞a th√™m s·∫£n ph·∫©m n√†o. Kh√°m ph√° s·∫£n ph·∫©m v√† th√™m v√†o gi·ªè nh√©!</p>
                    <a href="/products" class="btn btn-primary"><i class="fas fa-shopping-bag me-2"></i>Mua s·∫Øm ngay</a>
                </div>
            </div>
        `;
        return;
    }
    
    let cartHTML = `
        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 70px;"></th>
                                <th>S·∫£n ph·∫©m</th>
                                <th class="text-center" style="width: 120px;">S·ªë l∆∞·ª£ng</th>
                                <th class="text-end" style="width: 150px;">ƒê∆°n gi√°</th>
                                <th class="text-end" style="width: 150px;">Th√†nh ti·ªÅn</th>
                                <th class="text-end" style="width: 60px;"></th>
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    cart.forEach(item => {
        const price = parsePrice(item.price);
        const itemTotal = price * item.quantity;
        
        cartHTML += `
            <tr>
                <td>
                    <img src="${item.image}" alt="${item.name}" class="img-fluid rounded" style="width:60px;height:60px;object-fit:cover;">
                </td>
                <td>
                    <div class="fw-semibold"><a href="/product/${item.id}" class="text-decoration-none">${item.name}</a></div>
                    <div class="text-muted small">ID: ${item.id}</div>
                </td>
                <td class="text-center">
                    <div class="d-inline-flex align-items-center justify-content-center gap-2 cart-qty" style="max-width:160px;">
                        <button class="btn btn-outline-secondary btn-sm cart-qty-decrease" type="button" aria-label="Gi·∫£m">-</button>
                        <input type="text" class="form-control form-control-sm text-center cart-qty-input" value="${item.quantity}" style="width:64px;" data-product-id="${item.id}">
                        <button class="btn btn-outline-secondary btn-sm cart-qty-increase" type="button" aria-label="TƒÉng">+</button>
                    </div>
                </td>
                <td class="text-end cart-price" data-price="${price}">${item.price}</td>
                <td class="text-end fw-semibold cart-line-total">${itemTotal.toLocaleString('vi-VN')}ƒë</td>
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-danger cart-remove-btn" aria-label="X√≥a s·∫£n ph·∫©m" data-product-id="${item.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    cartHTML += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="mt-3 d-flex gap-2">
            <a href="/products" class="btn btn-outline-secondary" style="padding: 10px 20px;">
                <i class="fas fa-arrow-left me-2"></i>Ti·∫øp t·ª•c mua s·∫Øm
            </a>
            <a href="/checkout" class="btn btn-primary">
                <i class="fas fa-credit-card me-2"></i>Thanh to√°n
            </a>
        </div>
    `;
    
    cartContainer.innerHTML = cartHTML;
    
    // Update cart summary
    updateCartSummary();
    
    // Re-initialize cart controls
    initCartQuantityControls();
    
    console.log('Cart display updated successfully');
}

// Update checkout display
function updateCheckoutDisplay() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const container = document.querySelector('#checkout-items-container');
    
    if (!container) {
        console.log('Checkout container not found - user is not on checkout page');
        return;
    }
    
    if (cart.length === 0) {
        container.innerHTML = `
            <div class="text-center py-3">
                <i class="fas fa-shopping-cart text-muted" style="font-size: 2rem;"></i>
                <p class="text-muted mt-2">Gi·ªè h√†ng tr·ªëng</p>
                <a href="/products" class="btn btn-sm btn-primary">Mua s·∫Øm ngay</a>
            </div>
        `;
        return;
    }
    
    let itemsHTML = '';
    cart.forEach(item => {
        const price = parsePrice(item.price);
        const itemTotal = price * item.quantity;
        
        itemsHTML += `
            <div class="d-flex align-items-center mb-3">
                <img src="${item.image}" alt="${item.name}" class="rounded me-3" style="width:56px;height:56px;object-fit:cover;">
                <div class="flex-grow-1">
                    <div class="small fw-semibold"><a href="/product/${item.id}" class="text-decoration-none">${item.name}</a></div>
                    <div class="text-muted small">x${item.quantity}</div>
                </div>
                <div class="fw-semibold">${itemTotal.toLocaleString('vi-VN')}ƒë</div>
            </div>
        `;
    });
    
    container.innerHTML = itemsHTML;
    
    // Update checkout summary
    updateCheckoutSummary();
    
    console.log('Checkout display updated successfully');
}

// Update checkout summary
function updateCheckoutSummary() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const subtotalEl = document.querySelector('.checkout-subtotal');
    const shippingEl = document.querySelector('.checkout-shipping');
    const totalEl = document.querySelector('.checkout-total');
    const savingsEl = document.querySelector('.checkout-savings');
    
    console.log('=== UPDATE CHECKOUT SUMMARY ===');
    console.log('Cart items:', cart.length);
    console.log('Subtotal element found:', !!subtotalEl);
    console.log('Shipping element found:', !!shippingEl);
    console.log('Total element found:', !!totalEl);
    console.log('Savings element found:', !!savingsEl);
    
    if (!subtotalEl || !shippingEl || !totalEl) {
        console.error('Required elements not found on checkout page');
        console.error('Subtotal element:', subtotalEl);
        console.error('Shipping element:', shippingEl);
        console.error('Total element:', totalEl);
        return; // Not on checkout page
    }
    
    // Additional check: verify elements are actually in the DOM
    if (!document.contains(subtotalEl) || !document.contains(shippingEl) || !document.contains(totalEl)) {
        console.error('Elements found but not in DOM');
        return;
    }
    
    if (cart.length === 0) {
        subtotalEl.textContent = '0ƒë';
        shippingEl.textContent = '0ƒë';
        totalEl.textContent = '0ƒë';
        if (savingsEl) savingsEl.textContent = '0ƒë';
        return;
    }
    
    let subtotal = 0;
    let totalOriginalPrice = 0;
    let totalDiscountedPrice = 0;
    
    cart.forEach(item => {
        // Parse price more accurately using helper function
        const price = parsePrice(item.price);
        subtotal += price * item.quantity;
        
        // Debug: Log th√¥ng tin ƒë·ªÉ ki·ªÉm tra
        console.log('=== DEBUG ITEM ===');
        console.log('Item name:', item.name);
        console.log('Item price (discounted):', item.price, '-> parsed:', price);
        console.log('Item originalPrice:', item.originalPrice);
        console.log('Item quantity:', item.quantity);
        
        // T√≠nh to√°n ph·∫ßn ti·∫øt ki·ªám d·ª±a tr√™n gi√° g·ªëc th·ª±c t·∫ø
        if (item.originalPrice) {
            const originalPrice = parsePrice(item.originalPrice);
            totalOriginalPrice += originalPrice * item.quantity;
            console.log('Using ACTUAL original price:', originalPrice, '-> total:', totalOriginalPrice);
        } else {
            // Fallback: ∆∞·ªõc t√≠nh gi√° g·ªëc n·∫øu kh√¥ng c√≥ th√¥ng tin
            // Gi·∫£ s·ª≠ gi·∫£m trung b√¨nh 40% (th·ª±c t·∫ø h∆°n cho s·∫£n ph·∫©m thanh l√Ω)
            const estimatedOriginalPrice = Math.round(price / 0.6); // Gi·∫£ s·ª≠ gi·∫£m 40%
            totalOriginalPrice += estimatedOriginalPrice * item.quantity;
            console.log('Using ESTIMATED original price:', estimatedOriginalPrice, '-> total:', totalOriginalPrice);
        }
        totalDiscountedPrice += price * item.quantity;
        console.log('Total discounted price so far:', totalDiscountedPrice);
        console.log('=== END DEBUG ===');
    });
    
    // T√≠nh ph·∫ßn ti·∫øt ki·ªám (ƒë·∫£m b·∫£o kh√¥ng √¢m)
    const productSavings = Math.max(0, totalOriginalPrice - totalDiscountedPrice);
    
    console.log('=== FINAL CALCULATION ===');
    console.log('Total Original Price:', totalOriginalPrice);
    console.log('Total Discounted Price:', totalDiscountedPrice);
    console.log('Total Savings:', productSavings);
    console.log('=== END FINAL ===');
    
    // Get selected shipping method
    const selectedShip = document.querySelector('input[name="ship"]:checked');
    let shipping = 30000; // Default standard shipping
    
    if (selectedShip && selectedShip.id === 'ship2') {
        shipping = 40000; // Express shipping for TP.HCM (4h-8h)
    }
    
    // Apply 50% discount if bank transfer is selected
    const selectedPayment = document.querySelector('input[name="pay"]:checked');
    if (selectedPayment && selectedPayment.value === 'bankTransfer') {
        shipping = Math.round(shipping * 0.5); // Gi·∫£m 50% khi chuy·ªÉn kho·∫£n
    }
    
    // Apply voucher discount
    const appliedVoucher = getAppliedVoucher();
    let voucherDiscount = 0;
    if (appliedVoucher) {
        voucherDiscount = appliedVoucher.discount;
        // Update voucher line display
        const voucherLineEl = document.getElementById('checkoutVoucherLine');
        const voucherDiscountEl = document.querySelector('.checkout-voucher-discount');
        if (voucherLineEl && voucherDiscountEl) {
            voucherLineEl.style.display = 'flex';
            voucherDiscountEl.textContent = `-${voucherDiscount.toLocaleString('vi-VN')}ƒë`;
        }
    } else {
        // Hide voucher line if no voucher and reset to 0ƒë
        const voucherLineEl = document.getElementById('checkoutVoucherLine');
        const voucherDiscountEl = document.querySelector('.checkout-voucher-discount');
        if (voucherLineEl) {
            voucherLineEl.style.display = 'none';
        }
        if (voucherDiscountEl) {
            voucherDiscountEl.textContent = '-0ƒë';
        }
    }
    
    // T√≠nh ph√≠ v·∫≠n chuy·ªÉn g·ªëc (kh√¥ng gi·∫£m gi√°)
    const originalShipping = selectedShip && selectedShip.id === 'ship2' ? 40000 : 30000;
    
    // T√≠nh t·ªïng ti·ªÅn ti·∫øt ki·ªám
    const totalSavings = productSavings + voucherDiscount + (originalShipping - shipping);
    
    const total = subtotal + shipping - voucherDiscount;
    
    console.log('=== FINAL CHECKOUT CALCULATION ===');
    console.log('Subtotal:', subtotal);
    console.log('Shipping:', shipping);
    console.log('Voucher Discount:', voucherDiscount);
    console.log('Product Savings (price difference):', productSavings);
    console.log('Shipping Savings (50% off):', originalShipping - shipping);
    console.log('Total Savings:', totalSavings);
    console.log('Total:', total);
    console.log('=== END CHECKOUT CALCULATION ===');
    
    subtotalEl.textContent = subtotal.toLocaleString('vi-VN') + 'ƒë';
    shippingEl.textContent = shipping.toLocaleString('vi-VN') + 'ƒë';
    totalEl.textContent = total.toLocaleString('vi-VN') + 'ƒë';
    
    // Update hidden shipping fee input (divide by 1000 for API)
    const shippingInput = document.getElementById('checkout-shipping');
    if (shippingInput) {
        shippingInput.value = shipping / 1000;
        console.log('Updated shipping input value to:', shipping / 1000);
    }
    
    // Debug: Log what we're setting
    console.log('Setting subtotal to:', subtotal.toLocaleString('vi-VN') + 'ƒë');
    console.log('Setting shipping to:', shipping.toLocaleString('vi-VN') + 'ƒë');
    console.log('Setting total to:', total.toLocaleString('vi-VN') + 'ƒë');
    
    // Also try to update the transfer amount if it exists
    const transferAmountEl = document.querySelector('.transfer-amount');
    if (transferAmountEl) {
        transferAmountEl.textContent = total.toLocaleString('vi-VN') + 'ƒë';
        console.log('Setting transfer amount to:', total.toLocaleString('vi-VN') + 'ƒë');
    }
    
    // Hi·ªÉn th·ªã ph·∫ßn ti·∫øt ki·ªám
    if (savingsEl && totalSavings > 0) {
        savingsEl.textContent = totalSavings.toLocaleString('vi-VN') + 'ƒë';
    } else if (savingsEl) {
        savingsEl.textContent = '0ƒë';
    }
}

// Toggle empty cart state UI (hide summary, show empty message, disable checkout)
function toggleCartEmptyUI(isEmpty) {
    const leftCol = document.querySelector('.row.g-4 .col-lg-8');
    const firstCard = leftCol ? leftCol.querySelector('.card.border-0.shadow-sm') : null;
    const summaryCol = document.querySelector('.row.g-4 .col-lg-4');
    const summaryCards = summaryCol ? summaryCol.querySelectorAll('.card') : [];
    const checkoutLinks = document.querySelectorAll('a[href="/checkout"]');

    // Manage summary visibility and checkout enable/disable
    checkoutLinks.forEach(a => {
        if (isEmpty) {
            a.classList.add('disabled');
            a.setAttribute('aria-disabled', 'true');
            a.setAttribute('tabindex', '-1');
            a.style.pointerEvents = 'none';
            a.style.opacity = '0.6';
        } else {
            a.classList.remove('disabled');
            a.removeAttribute('aria-disabled');
            a.removeAttribute('tabindex');
            a.style.pointerEvents = 'auto';
            a.style.opacity = '1';
        }
    });

    summaryCards.forEach(card => {
        if (isEmpty) {
            // C·∫≠p nh·∫≠t t·∫•t c·∫£ gi√° tr·ªã v·ªÅ 0ƒë khi gi·ªè h√†ng tr·ªëng
            const subtotalEl = card.querySelector('.cart-subtotal');
            const savingsEl = card.querySelector('.cart-savings');
            const shippingEl = card.querySelector('.cart-shipping');
            const totalEl = card.querySelector('.cart-total');
            
            if (subtotalEl) subtotalEl.textContent = '0ƒë';
            if (savingsEl) savingsEl.textContent = '0ƒë';
            if (shippingEl) shippingEl.textContent = '0ƒë';
            if (totalEl) totalEl.textContent = '0ƒë';
        }
        // Kh√¥ng c·∫ßn ·∫©n/hi·ªán card, ch·ªâ c·∫≠p nh·∫≠t gi√° tr·ªã
    });

    if (!leftCol || !firstCard) return;

    let emptyEl = leftCol.querySelector('#cart-empty-state');
    if (isEmpty) {
        // Hide table card
        firstCard.classList.add('d-none');
        if (!emptyEl) {
            emptyEl = document.createElement('div');
            emptyEl.id = 'cart-empty-state';
            emptyEl.className = 'card border-0 shadow-sm';
            emptyEl.innerHTML = `
                <div class="card-body text-center py-5">
                    <img src="/static/image/gif/khoc.gif" alt="empty" class="mx-auto mb-3" style="width: 120px; height: 120px; object-fit: cover; display:block;">
                    <h5 class="fw-bold mb-2">Gi·ªè h√†ng tr·ªëng</h5>
                    <p class="text-muted mb-4">B·∫°n ch∆∞a th√™m s·∫£n ph·∫©m n√†o. Kh√°m ph√° s·∫£n ph·∫©m v√† th√™m v√†o gi·ªè nh√©!</p>
                    <a href="/products" class="btn btn-primary"><i class="fas fa-shopping-bag me-2"></i>Mua s·∫Øm ngay</a>
                </div>`;
            // Insert after the hidden first card
            firstCard.insertAdjacentElement('afterend', emptyEl);
        }
    } else {
        firstCard.classList.remove('d-none');
        if (emptyEl) emptyEl.remove();
    }
}

// Helper: show confirmation modal for cart actions
function showCartConfirm(message, onOk) {
    const modalEl = document.getElementById('cartConfirmModal');
    const msgEl = document.getElementById('cartConfirmMessage');
    const okBtn = document.getElementById('cartConfirmOkBtn');
    if (!modalEl || !msgEl || !okBtn) {
        if (confirm(message)) onOk && onOk();
        return;
    }
    msgEl.textContent = message;
    const modal = new bootstrap.Modal(modalEl);
    let gifRestartIntervalId = null;

    const handleOk = () => {
        cleanup();
        modal.hide();
        onOk && onOk();
    };

    const cleanup = () => {
        okBtn.removeEventListener('click', handleOk);
        modalEl.removeEventListener('hidden.bs.modal', cleanup);
        modalEl.removeEventListener('shown.bs.modal', handleShown);
        // Stop and reset GIF on close to avoid infinite loop effect
        const gif = document.getElementById('cartSadGif');
        if (gif) {
            const src = gif.getAttribute('src');
            gif.setAttribute('src', '');
            // small delay then restore to reset one-shot playback on next open
            setTimeout(() => gif.setAttribute('src', src), 0);
        }
        if (gifRestartIntervalId) {
            clearInterval(gifRestartIntervalId);
            gifRestartIntervalId = null;
        }
    };

    // When modal is shown, keep the GIF looping by restarting its src periodically
    const handleShown = () => {
        const gif = document.getElementById('cartSadGif');
        if (!gif) return;
        const restartMs = parseInt(gif.getAttribute('data-restart-ms') || '3000', 10);
        if (gifRestartIntervalId) clearInterval(gifRestartIntervalId);
        gifRestartIntervalId = setInterval(() => {
            const src = gif.getAttribute('src');
            gif.setAttribute('src', '');
            setTimeout(() => gif.setAttribute('src', src), 0);
        }, Math.max(1500, restartMs));
    };

    okBtn.addEventListener('click', handleOk);
    modalEl.addEventListener('hidden.bs.modal', cleanup);
    modalEl.addEventListener('shown.bs.modal', handleShown);
    modal.show();
}

// T√≠nh l·∫°i chi·ªÅu r·ªông item/container d·ª±a v√†o viewport (responsive)
function layoutSlider(containerSelector) {
    const container = document.querySelector(containerSelector);
    if (!container) return;
    const productsContainer = container.querySelector('.homepage-products');
    const wrapper = productsContainer?.parentElement;
    if (!productsContainer || !wrapper) return;

    const totalProducts = parseInt(productsContainer.dataset.totalProducts || '0', 10);
    const gap = 16; // Fixed gap 16px
    
    // Responsive products per view
    let productsPerView, paddingX;
    if (window.innerWidth <= 576) {
        // Mobile: 2 products
        productsPerView = 2;
        paddingX = 32; // 16px left + 16px right padding
    } else if (window.innerWidth <= 768) {
        // Tablet: 3 products  
        productsPerView = 3;
        paddingX = 40; // 20px left + 20px right padding
    } else {
        // Desktop: 5 products
        productsPerView = 5;
        paddingX = 80; // 40px left + 40px right padding
    }
    
    // C·∫≠p nh·∫≠t dataset ƒë·ªÉ navigateProducts bi·∫øt s·ªë l∆∞·ª£ng hi·ªán t·∫°i
    productsContainer.dataset.productsPerView = String(productsPerView);
    
    // T√≠nh to√°n ch√≠nh x√°c ƒë·ªÉ ƒë·∫£m b·∫£o productsPerView s·∫£n ph·∫©m hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß
    const availableWidth = wrapper.clientWidth - paddingX;
    const totalGapWidth = gap * (productsPerView - 1);
    const itemWidth = Math.floor((availableWidth - totalGapWidth) / productsPerView);

    // Set width cho t·∫•t c·∫£ items
    const items = productsContainer.querySelectorAll('.slider-item');
    items.forEach(el => {
        el.style.width = `${itemWidth}px`;
        el.style.flex = '0 0 auto';
    });
    
    // Set t·ªïng chi·ªÅu r·ªông container
    const totalContainerWidth = itemWidth * totalProducts + gap * Math.max(0, totalProducts - 1);
    productsContainer.style.width = `${totalContainerWidth}px`;

    // Reposition current index by item step
    const currentIndex = parseInt(productsContainer.dataset.currentIndex || '0', 10);
    const step = itemWidth + gap;
    const translatePx = -currentIndex * step;
    productsContainer.style.transform = `translateX(${translatePx}px)`;
    updateNavigationButtons(containerSelector, currentIndex);
}

// Update cart summary
function updateCartSummary() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const subtotalEl = document.querySelector('.cart-subtotal');
    const shippingEl = document.querySelector('.cart-shipping');
    const totalEl = document.querySelector('.cart-total');
    const savingsEl = document.querySelector('.cart-savings');
    const checkoutBtn = document.getElementById('checkoutBtn');
    
    if (cart.length === 0) {
        if (subtotalEl) subtotalEl.textContent = '0ƒë';
        if (shippingEl) shippingEl.textContent = '0ƒë';
        if (totalEl) totalEl.textContent = '0ƒë';
        if (savingsEl) savingsEl.textContent = '0ƒë';
        
        // Disable checkout button when cart is empty
        if (checkoutBtn) {
            checkoutBtn.classList.add('disabled');
            checkoutBtn.setAttribute('aria-disabled', 'true');
            checkoutBtn.setAttribute('tabindex', '-1');
            checkoutBtn.style.pointerEvents = 'none';
            checkoutBtn.style.opacity = '0.6';
        }
        return;
    }
    
    // Enable checkout button when cart has items
    if (checkoutBtn) {
        checkoutBtn.classList.remove('disabled');
        checkoutBtn.removeAttribute('aria-disabled');
        checkoutBtn.removeAttribute('tabindex');
        checkoutBtn.style.pointerEvents = 'auto';
        checkoutBtn.style.opacity = '1';
    }
    
    let subtotal = 0;
    let totalOriginalPrice = 0;
    let totalDiscountedPrice = 0;
    
    cart.forEach(item => {
        // Parse price more accurately using helper function
        const price = parsePrice(item.price);
        subtotal += price * item.quantity;
        
        // T√≠nh to√°n ph·∫ßn ti·∫øt ki·ªám d·ª±a tr√™n gi√° g·ªëc th·ª±c t·∫ø
        if (item.originalPrice) {
            const originalPrice = parsePrice(item.originalPrice);
            totalOriginalPrice += originalPrice * item.quantity;
        } else {
            // Fallback: ∆∞·ªõc t√≠nh gi√° g·ªëc n·∫øu kh√¥ng c√≥ th√¥ng tin
            // Gi·∫£ s·ª≠ gi·∫£m trung b√¨nh 40% (th·ª±c t·∫ø h∆°n cho s·∫£n ph·∫©m thanh l√Ω)
            const estimatedOriginalPrice = Math.round(price / 0.6); // Gi·∫£ s·ª≠ gi·∫£m 40%
            totalOriginalPrice += estimatedOriginalPrice * item.quantity;
        }
        totalDiscountedPrice += price * item.quantity;
    });
    
    // T√≠nh ph·∫ßn ti·∫øt ki·ªám t·ª´ gi√° s·∫£n ph·∫©m (ƒë·∫£m b·∫£o kh√¥ng √¢m)
    const productSavings = Math.max(0, totalOriginalPrice - totalDiscountedPrice);
    
    // T√≠nh ph√≠ v·∫≠n chuy·ªÉn d·ª±a tr√™n ph∆∞∆°ng th·ª©c thanh to√°n
    let shipping = 30000; // Default shipping cost
    const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked');
    if (selectedPayment && selectedPayment.value === 'bankTransfer') {
        shipping = Math.round(shipping * 0.5); // Gi·∫£m 50% khi chuy·ªÉn kho·∫£n
    }
    
    // Apply voucher discount
    const appliedVoucher = getAppliedVoucher();
    let voucherDiscount = 0;
    if (appliedVoucher) {
        voucherDiscount = appliedVoucher.discount;
        // Update voucher line display
        const voucherLineEl = document.getElementById('cartVoucherLine');
        const voucherDiscountEl = document.querySelector('.cart-voucher-discount');
        if (voucherLineEl && voucherDiscountEl) {
            voucherLineEl.style.display = 'flex';
            voucherDiscountEl.textContent = `-${voucherDiscount.toLocaleString('vi-VN')}ƒë`;
        }
    } else {
        // Hide voucher line if no voucher and reset to 0ƒë
        const voucherLineEl = document.getElementById('cartVoucherLine');
        const voucherDiscountEl = document.querySelector('.cart-voucher-discount');
        if (voucherLineEl) {
            voucherLineEl.style.display = 'none';
        }
        if (voucherDiscountEl) {
            voucherDiscountEl.textContent = '-0ƒë';
        }
    }
    
    // T√≠nh ph√≠ v·∫≠n chuy·ªÉn g·ªëc (kh√¥ng gi·∫£m gi√°)
    const originalShipping = 30000;
    
    // T√≠nh t·ªïng ti·ªÅn ti·∫øt ki·ªám
    const totalSavings = productSavings + voucherDiscount + (originalShipping - shipping);
    
    const total = subtotal + shipping - voucherDiscount;
    
    if (subtotalEl) subtotalEl.textContent = subtotal.toLocaleString('vi-VN') + 'ƒë';
    if (shippingEl) shippingEl.textContent = shipping.toLocaleString('vi-VN') + 'ƒë';
    if (totalEl) totalEl.textContent = total.toLocaleString('vi-VN') + 'ƒë';
    
    // Hi·ªÉn th·ªã t·ªïng ti·ªÅn ti·∫øt ki·ªám
    if (savingsEl && totalSavings > 0) {
        savingsEl.textContent = totalSavings.toLocaleString('vi-VN') + 'ƒë';
    } else if (savingsEl) {
        savingsEl.textContent = '0ƒë';
    }
    
    // Debug logging
    console.log('=== CART SUMMARY CALCULATION ===');
    console.log('Product savings (price difference):', productSavings);
    console.log('Voucher discount:', voucherDiscount);
    console.log('Shipping savings (50% off):', originalShipping - shipping);
    console.log('Total savings:', totalSavings);
    console.log('=== END CART SUMMARY ===');
}

// Update checkout button state based on cart content
function updateCheckoutButtonState() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const checkoutBtn = document.getElementById('checkoutBtn');
    
    if (!checkoutBtn) return;
    
    if (cart.length === 0) {
        // Disable checkout button when cart is empty
        checkoutBtn.classList.add('disabled');
        checkoutBtn.setAttribute('aria-disabled', 'true');
        checkoutBtn.setAttribute('tabindex', '-1');
        checkoutBtn.style.pointerEvents = 'none';
        checkoutBtn.style.opacity = '0.6';
        console.log('Checkout button disabled - cart is empty');
    } else {
        // Enable checkout button when cart has items
        checkoutBtn.classList.remove('disabled');
        checkoutBtn.removeAttribute('aria-disabled');
        checkoutBtn.removeAttribute('tabindex');
        checkoutBtn.style.pointerEvents = 'auto';
        checkoutBtn.style.opacity = '1';
        console.log('Checkout button enabled - cart has items');
    }
}

// Save payment method to localStorage
function savePaymentMethod(method) {
    console.log('Saving payment method to localStorage:', method);
    localStorage.setItem('selectedPaymentMethod', method);
}

// Get payment method from localStorage
function getPaymentMethod() {
    const method = localStorage.getItem('selectedPaymentMethod') || 'cod';
    console.log('Getting payment method from localStorage:', method);
    return method;
}

// Handle cart payment method change
function handleCartPaymentChange() {
    console.log('=== CART PAYMENT METHOD CHANGED ===');
    
    const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked');
    const bankTransferInfo = document.getElementById('bankTransferInfo');
    
    console.log('Selected payment method:', selectedPayment?.value);
    console.log('Bank transfer info element found:', !!bankTransferInfo);
    
    if (selectedPayment && selectedPayment.value === 'bankTransfer') {
        console.log('Showing bank transfer info');
        bankTransferInfo.classList.remove('d-none');
    } else {
        console.log('Hiding bank transfer info');
        bankTransferInfo.classList.add('d-none');
    }
    
    // Save selected payment method
    if (selectedPayment) {
        savePaymentMethod(selectedPayment.value);
        console.log('Payment method saved to localStorage:', selectedPayment.value);
    } else {
        console.log('No payment method selected, cannot save');
    }
    
    // Update cart summary when payment method changes
    updateCartSummary();
    
    console.log('=== CART PAYMENT METHOD CHANGE COMPLETED ===');
}

// Manual trigger for testing payment method sync
window.manualSyncPayment = function() {
    console.log('=== MANUAL PAYMENT SYNC TRIGGERED ===');
    syncPaymentMethod();
};

// Manual trigger for testing voucher sync
window.manualSyncVoucher = function() {
    console.log('=== MANUAL VOUCHER SYNC TRIGGERED ===');
    syncVoucherToCart();
    syncVoucherToCheckout();
};

// Manual trigger for testing payment method selection
window.manualSelectPayment = function(method = 'bankTransfer') {
    console.log('=== MANUAL PAYMENT SELECTION TRIGGERED ===');
    console.log('Selecting payment method:', method);
    
    const radio = document.querySelector(`input[name="pay"][value="${method}"]`);
    if (radio) {
        console.log('Found radio button:', radio.outerHTML);
        
        // Uncheck all first
        document.querySelectorAll('input[name="pay"]').forEach(r => r.checked = false);
        
        // Check the selected one
        radio.checked = true;
        console.log('Radio button checked:', radio.checked);
        
        // Trigger change event
        radio.dispatchEvent(new Event('change', { bubbles: true }));
        
        console.log('Payment method manually selected:', method);
    } else {
        console.log('Radio button not found for:', method);
    }
};

console.log('Manual functions available:');
console.log('- manualSyncPayment() - Force sync payment method');
console.log('- manualSyncVoucher() - Force sync voucher');
console.log('- manualSelectPayment("bankTransfer") - Manually select bank transfer');

// H√†m kh·ªüi t·∫°o cho s·∫£n ph·∫©m g·ª£i √Ω trong checkout
function initCheckoutSuggestedProducts() {
    const suggestedProductsApiUrl = '/api/products?tags=FlashSale&limit=4';
    const containerSelector = '#checkout-suggested-products';
    fetchAndRenderSuggestedProducts(suggestedProductsApiUrl, containerSelector);
}

// H√†m render s·∫£n ph·∫©m g·ª£i √Ω cho checkout (layout nh·ªè g·ªçn)
async function fetchAndRenderSuggestedProducts(apiUrl, containerSelector) {
    const container = document.querySelector(containerSelector);
    if (!container) {
        console.error(`Kh√¥ng t√¨m th·∫•y container v·ªõi selector: ${containerSelector}`);
        return;
    }

    try {
        const response = await fetch(apiUrl);
        if (!response.ok) {
            throw new Error('L·ªói khi l·∫•y d·ªØ li·ªáu t·ª´ API');
        }
        const products = await response.json();
        
        if (products.length === 0) {
            container.innerHTML = '<p class="text-muted text-center py-4">Kh√¥ng c√≥ s·∫£n ph·∫©m flash-sale n√†o ƒë·ªÉ hi·ªÉn th·ªã.</p>';
            return;
        }

        // T·∫°o grid layout cho s·∫£n ph·∫©m g·ª£i √Ω (2 h√†ng, m·ªói h√†ng 5 s·∫£n ph·∫©m)
        let productsHTML = '';
        
        // X√°c ƒë·ªãnh s·ªë l∆∞·ª£ng t·ªëi ƒëa theo thi·∫øt b·ªã
        const isMobile = window.innerWidth <= 767;
        const maxItems = isMobile ? 6 : 10;
        const count = Math.min(products.length, maxItems);
        
        // T·∫°o layout responsive
        const itemsPerRow = isMobile ? 2 : 5;
        const rows = Math.ceil(count / itemsPerRow);
        
        for (let row = 0; row < rows; row++) {
            productsHTML += '<div class="row g-2" style="margin-bottom: 10px !important;">';
            
            const startIndex = row * itemsPerRow;
            const endIndex = Math.min(startIndex + itemsPerRow, count);
            
            for (let i = startIndex; i < endIndex; i++) {
            const product = products[i];
            
            if (product) {
                // Map sang Product model (kh√¥ng d√πng variants/album)
                const imageUrl = (product.image && String(product.image).trim()) || '/static/image/default-product.jpg';
                const brandName = product.brand_name || (product.brand ? product.brand.name : '');
                const originalPrice = typeof product.original_price === 'number' ? product.original_price * 1000 : null;
                const discountedPrice = typeof product.discounted_price === 'number' ? product.discounted_price * 1000 : null;
                const discountRate = (typeof product.discount_rate === 'number')
                    ? Math.round(product.discount_rate)
                    : ((originalPrice && discountedPrice) ? Math.round(((originalPrice - discountedPrice) / originalPrice) * 100) : 0);
                const stockQuantity = typeof product.stock_quantity === 'number' ? product.stock_quantity : 0;

                productsHTML += `
                    <div class="col-6 col-lg" style="flex: 0 0 ${isMobile ? '50%' : '20%'}; max-width: ${isMobile ? '50%' : '20%'};">
                        <div class="card suggested-product-card h-100 border-0 shadow-sm">
                            <div class="position-relative">
                                <a href="/product/${product.id}" class="text-decoration-none">
                                    <img src="${imageUrl}" class="card-img-top" alt="${product.name}" style="height: 150px; object-fit: cover; border-radius: 4px;">
                                </a>
                                <div class="flash-sale-badge">-${discountRate}%</div>
                                <div class="position-absolute bottom-0 start-0 m-1">
                                    <img src="/static/image/logo.png" alt="Logo" class="product-logo" style="width: 28px !important; height: 28px !important; object-fit: contain; border-radius: 50%; background: white; padding: 2px; display: block; z-index: 10; box-shadow: 0 1px 3px rgba(0,0,0,0.2);" onerror="this.style.display='none';">
                                </div>
                            </div>
                            <div class="card-body p-1 position-relative">
                                <h6 class="card-title small fw-bold mb-1" style="font-size: 9px; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                    <a href="/product/${product.id}" class="text-decoration-none text-dark">${product.name}</a>
                                </h6>
                                <div class="d-flex align-items-center mb-1">
                                    ${originalPrice ? `<span class="text-decoration-line-through text-muted me-1" style="font-size: 8px;">${formatPrice(originalPrice)}</span>` : ''}
                                    <span class="text-danger fw-bold" style="font-size: 10px;">${formatPrice(discountedPrice)}</span>
                                </div>
                                <div class="d-flex align-items-center justify-content-between">
                                    <small class="text-muted" style="font-size: 8px;">C√≤n ${stockQuantity}</small>
                                    <button class="btn btn-sm btn-outline-primary add-to-cart-btn" data-product-id="${product.id}" style="font-size: 8px; padding: 1px 10px;">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
            productsHTML += '</div>'; // ƒê√≥ng row
        }
        
        container.innerHTML = productsHTML;

        // Re-initialize Product Cards with new DOM elements
        initProductCards();

    } catch (error) {
        console.error(`ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m g·ª£i √Ω:`, error);
        container.innerHTML = '<p class="text-danger text-center py-4">Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m g·ª£i √Ω. Vui l√≤ng th·ª≠ l·∫°i sau.</p>';
    }
}

// Helper function to update all cart-related displays
function updateAllCartDisplays() {
    console.log('=== UPDATING ALL CART DISPLAYS ===');
    
    // Update cart count badge (works on all pages)
    updateCartCount();
    
    // Update cart page if user is on it
    updateCartDisplay();
    
    // Update checkout page if user is on it
    updateCheckoutDisplay();
    
    // Update summaries if they exist
    updateCartSummary();
    updateCheckoutSummary();
    
    // Update checkout button state
    updateCheckoutButtonState();
    
    console.log('=== ALL CART DISPLAYS UPDATED ===');
}

// Initialize Products page (dynamic grid like "S·∫£n Ph·∫©m M·ªõi V·ªÅ")
function initProductsPage() {
    const grid = document.getElementById('products-page-grid');
    if (!grid) return; // Not on products page

    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('query') || urlParams.get('q') || '';
    let condition = urlParams.get('condition') || '';
    const categoryName = urlParams.get('category_name') || urlParams.get('category') || '';
    const brandsName = urlParams.get('brands_name') || urlParams.get('brand') || '';
    const priceRange = urlParams.get('price_range') || urlParams.get('price') || '';
    const discountRange = urlParams.get('discount_range') || urlParams.get('discount') || '';
    const tagsFilter = urlParams.get('tags') || '';
    // Infer condition from pathname if not provided via query string
    if (!condition) {
        const path = window.location.pathname || '';
        if (path.includes('/products/new')) condition = 'new';
        else if (path.includes('/products/used')) condition = 'used';
    }

    let apiUrl = '/api/products';
    const qs = [];
    if (query) qs.push(`search=${encodeURIComponent(query)}`);
    if (condition) qs.push(`condition=${encodeURIComponent(condition)}`);
    if (qs.length) apiUrl += (apiUrl.includes('?') ? '&' : '?') + qs.join('&');

    grid.innerHTML = `
        <div class="col-12 text-center py-4">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">ƒêang t·∫£i...</span></div>
            <p class="text-muted mt-2 mb-0">ƒêang t·∫£i s·∫£n ph·∫©m...</p>
        </div>
    `;

    fetch(apiUrl)
        .then(r => r.ok ? r.json() : Promise.reject(new Error('API error')))
        .then(products => {
            if (!Array.isArray(products) || products.length === 0) {
                grid.innerHTML = '<div class="col-12"><p class="text-center text-muted py-4 mb-0">Kh√¥ng c√≥ s·∫£n ph·∫©m ƒë·ªÉ hi·ªÉn th·ªã.</p></div>';
                return;
            }

            // Client-side filter by condition (new/used) using status
            if (condition) {
                const isNewStatus = s => {
                    if (!s) return false;
                    const x = String(s).toLowerCase();
                    return x.includes('new') || x.includes('chiet');
                };
                if (condition === 'new') {
                    products = products.filter(p => isNewStatus(p.status));
                } else if (condition === 'used') {
                    products = products.filter(p => !isNewStatus(p.status));
                }
            }

            // Filter by category and brand names
            const getCategoryName = (p) => {
                if (p && typeof p === 'object') {
                    if (p.category && typeof p.category === 'object') {
                        return (p.category.name || p.category.title || '').toString().trim();
                    }
                    return (p.category_name || p.category || '').toString().trim();
                }
                return '';
            };
            if (categoryName) {
                const target = categoryName.toString().trim().toLowerCase();
                products = products.filter(p => getCategoryName(p).toLowerCase() === target);
            }
            if (brandsName) {
                const getBrandName = (p) => (p.brand_name || (p.brand && p.brand.name) || '').toString().trim();
                const btarget = brandsName.toString().trim();
                products = products.filter(p => getBrandName(p) === btarget);
            }

            // Helpers
                const priceVnd = p => (p.discounted_price || 0);
            const rate = p => parseFloat(p.discount_rate || 0) || 0;

            // Price ranges
            switch (priceRange) {
                case 'under_200k':
                    products = products.filter(p => priceVnd(p) < 200000); break;
                case '200_500':
                    products = products.filter(p => 200000 <= priceVnd(p) && priceVnd(p) < 500000); break;
                case '500_1m':
                    products = products.filter(p => 500000 <= priceVnd(p) && priceVnd(p) < 1000000); break;
                case 'over_1m':
                    products = products.filter(p => priceVnd(p) >= 1000000); break;
                // Backward compatibility
                case 'under_500k':
                    products = products.filter(p => priceVnd(p) < 500000); break;
                case '500k_1m':
                    products = products.filter(p => 500000 <= priceVnd(p) && priceVnd(p) < 1000000); break;
                case '1m_2m':
                    products = products.filter(p => 1000000 <= priceVnd(p) && priceVnd(p) < 2000000); break;
                case 'over_2m':
                    products = products.filter(p => priceVnd(p) >= 2000000); break;
            }

            // Discount ranges
            switch (discountRange) {
                case 'under_30':
                    products = products.filter(p => rate(p) < 30); break;
                case '50_70':
                    products = products.filter(p => rate(p) >= 50 && rate(p) <= 70); break;
                case 'over_70':
                    products = products.filter(p => rate(p) > 70); break;
                // Backward compatibility
                case 'over_50':
                    products = products.filter(p => rate(p) >= 50); break;
                case '30_50':
                    products = products.filter(p => rate(p) >= 30 && rate(p) < 50); break;
            }

            // Tags filter
            if (tagsFilter) {
                console.log(`üîç JavaScript filtering by tag: ${tagsFilter}`);
                const hasTag = (product, targetTag) => {
                    try {
                        const tags = product?.tags || [];
                        if (!Array.isArray(tags)) return false;
                        return tags.some(t => {
                            if (typeof t === 'string') return t.toLowerCase() === targetTag.toLowerCase();
                            if (t && typeof t === 'object') return (t.name || '').toLowerCase() === targetTag.toLowerCase();
                            return false;
                        });
                    } catch (error) {
                        return false;
                    }
                };
                const beforeCount = products.length;
                products = products.filter(p => hasTag(p, tagsFilter));
                const afterCount = products.length;
                console.log(`üìä JavaScript tags filter: ${beforeCount} -> ${afterCount} products`);
            }

            function render(list) {
                const fragments = document.createDocumentFragment();
                list.forEach(product => {
                    const col = document.createElement('div');
                    col.className = 'col-6 col-md-4 col-lg-3';
                    col.innerHTML = createProductCard(product);
                    fragments.appendChild(col);
                });
                grid.innerHTML = '';
                grid.appendChild(fragments);
                initProductCards();
                initAnimations();
            }

            // Attach sorting and render first time
            attachProductsSorting(products, render);
        })
        .catch(() => {
            grid.innerHTML = '<div class="col-12"><p class="text-center text-danger py-4 mb-0">Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i sau.</p></div>';
        });
}

// Sorting logic for products page
function attachProductsSorting(products, renderCallback) {
    const sortSelect = document.getElementById('products-sort');
    if (!sortSelect) return;

    const getOriginal = (p) => {
        const v = typeof p.original_price === 'number' ? p.original_price : parseFloat(p.original_price || '0');
        return isNaN(v) ? 0 : v;
    };
    const getDiscounted = (p) => {
        const v = typeof p.discounted_price === 'number' ? p.discounted_price : parseFloat(p.discounted_price || '0');
        return isNaN(v) ? 0 : v;
    };
    const getRating = (p) => {
        const v = typeof p.rating === 'number' ? p.rating : parseFloat(p.rating || '0');
        return isNaN(v) ? 0 : v;
    };
    const getSold = (p) => {
        const v = typeof p.sold_quantity === 'number' ? p.sold_quantity : parseFloat(p.sold_quantity || '0');
        return isNaN(v) ? 0 : v;
    };
    const getDiscountRate = (p) => {
        const r = typeof p.discount_rate === 'number' ? p.discount_rate : parseFloat(p.discount_rate || '0');
        if (!isNaN(r) && r > 0) return r;
        const o = getOriginal(p), d = getDiscounted(p);
        if (o > 0 && d >= 0 && d <= o) return ((o - d) / o) * 100;
        return 0;
    };

    function applySort() {
        const mode = sortSelect.value;
        const sorted = [...products];
        sorted.sort((a, b) => {
            switch (mode) {
                case 'price_asc':
                    return getDiscounted(a) - getDiscounted(b);
                case 'price_desc':
                    return getDiscounted(b) - getDiscounted(a);
                case 'sales':
                    return getSold(b) - getSold(a);
                case 'discount':
                    return getDiscountRate(b) - getDiscountRate(a);
                case 'newest':
                default:
                    return (Number(b.id) || 0) - (Number(a.id) || 0);
            }
        });
        renderCallback(sorted);
    }

    sortSelect.addEventListener('change', applySort);
    // First run
    applySort();
}

// Init product detail page
defineProductDetailInit = (function(){
    function parseProductIdFromPath() {
        // Expect /product/<id>
        const parts = location.pathname.split('/').filter(Boolean);
        const idx = parts.indexOf('product');
        if (idx !== -1 && parts[idx+1]) return parts[idx+1];
        return null;
    }

    function setStars(container, rating) {
        if (!container) return;
        let html = '';
        const full = Math.floor(rating || 0);
        const half = (rating || 0) % 1 >= 0.5;
        for (let i=0;i<full;i++) html += '<i class="fas fa-star"></i>';
        if (half) html += '<i class="fas fa-star-half-alt"></i>';
        for (let i=full + (half?1:0); i<5; i++) html += '<i class="far fa-star"></i>';
        container.innerHTML = html;
    }

    function populateDetail(p) {
        console.log('üéØ populateDetail called with data:', p);
        console.log('üì¶ Product name:', p.name);
        console.log('üí∞ Product price:', p.sale_price || p.discounted_price);
        
        // X·ª≠ l√Ω c·∫£ d·ªØ li·ªáu c≈© (Flask demo) v√† m·ªõi (API)
        let imageUrl, brandName, original, discounted, rating, stock, soldQuantity;
        
        if (p.image && p.image.startsWith('http')) {
            // D·ªØ li·ªáu m·ªõi t·ª´ API
            imageUrl = (p.image && String(p.image).trim()) || '/static/image/default-product.jpg';
            brandName = p.brand_name || (p.brand ? p.brand.name : '');
            original = typeof p.original_price === 'number' ? p.original_price : null;
            discounted = typeof p.discounted_price === 'number' ? p.discounted_price : null;
            rating = typeof p.rating === 'number' ? p.rating : (parseFloat(p.rating) || 0);
            stock = typeof p.stock_quantity === 'number' ? p.stock_quantity : 0;
            soldQuantity = typeof p.sold_quantity === 'number' ? p.sold_quantity : 0;
        } else {
            // D·ªØ li·ªáu t·ª´ API PythonAnywhere
            imageUrl = (p.image && String(p.image).trim()) || '/static/image/default-product.jpg';
            brandName = p.brand_name || (p.brand ? p.brand.name : '');
            original = typeof p.original_price === 'number' ? p.original_price : null;
            discounted = typeof p.discounted_price === 'number' ? p.discounted_price : null;
            rating = typeof p.rating === 'number' ? p.rating : (parseFloat(p.rating) || 0);
            stock = typeof p.stock_quantity === 'number' ? p.stock_quantity : 0;
            soldQuantity = typeof p.sold_quantity === 'number' ? p.sold_quantity : 0;
        }

        console.log('üñºÔ∏è Setting image URL:', imageUrl);
        const mainImage = document.getElementById('mainImage');
        if (mainImage) {
            mainImage.src = imageUrl;
            console.log('‚úÖ Main image updated');
        } else {
            console.log('‚ùå Main image element not found');
        }

        const thumbnailContainer = document.getElementById('thumbnailContainer');
        if (thumbnailContainer) {
            thumbnailContainer.innerHTML = '';
            // For now, just show the main image as thumbnail since we don't have album
                const el = document.createElement('img');
            el.src = imageUrl;
                el.alt = 'Thumbnail';
                el.className = 'img-thumbnail cursor-pointer';
                el.style.width = '80px';
                el.style.height = '80px';
                el.style.objectFit = 'cover';
            el.addEventListener('click', () => changeMainImage(imageUrl));
                thumbnailContainer.appendChild(el);
        }

        const nameEl = document.getElementById('detailName'); 
        if (nameEl) {
            nameEl.textContent = p.name || 'S·∫£n ph·∫©m';
            console.log('‚úÖ Product name updated:', p.name);
        } else {
            console.log('‚ùå Product name element not found');
        }
        const brandEl = document.getElementById('detailBrand'); if (brandEl) brandEl.textContent = brandName;
        const brandFeatureEl = document.getElementById('detailBrandFeature'); if (brandFeatureEl) brandFeatureEl.textContent = brandName;
        setStars(document.getElementById('detailStars'), rating);
        const reviewsEl = document.getElementById('detailReviews'); if (reviewsEl) reviewsEl.textContent = `(${soldQuantity} ƒë√£ b√°n)`;
        const stockEl = document.getElementById('detailStock'); if (stockEl) stockEl.textContent = stock > 0 ? `C√≤n ${stock} s·∫£n ph·∫©m` : 'H·∫øt h√†ng';

        const oEl = document.getElementById('detailOriginalPrice'); if (oEl && original) oEl.textContent = formatPrice(original);
        const dEl = document.getElementById('detailDiscountedPrice'); if (dEl && discounted) dEl.textContent = formatPrice(discounted);
        const badge = document.getElementById('detailDiscountBadge');
        if (badge && original && discounted && original > discounted) {
            const rate = typeof p.discount_rate === 'number' 
                ? Math.round(p.discount_rate) 
                : Math.round(((original - discounted) / original) * 100);
            badge.style.display = '';
            badge.textContent = `-${rate}%`;
        }
        const saveEl = document.getElementById('detailSavings');
        if (saveEl && original && discounted) {
            const savings = original - discounted;
            saveEl.textContent = `Ti·∫øt ki·ªám: ${formatPrice(savings)}`;
        }

        const descEl = document.getElementById('detailDescription'); 
        if (descEl) descEl.innerHTML = p.description || 'Ch∆∞a c√≥ m√¥ t·∫£.';
        
        const specEl = document.getElementById('detailSpecifications'); 
        if (specEl) {
            // Create specifications from API data
            let specsHTML = '<div class="row">';
            
            // X·ª≠ l√Ω d·ªØ li·ªáu t·ª´ API PythonAnywhere
            if (p.volume) specsHTML += `<div class="col-md-6"><strong>Dung t√≠ch:</strong> ${p.volume}</div>`;
            if (p.unit) specsHTML += `<div class="col-md-6"><strong>ƒê∆°n v·ªã:</strong> ${p.unit}</div>`;
            if (p.status) {
                const statusText = {
                    'new': 'M·ªõi 100%',
                    'test': 'ƒê√£ test 1-2 l·∫ßn',
                    '30': 'C√≤n 30%',
                    '50': 'C√≤n 50%',
                    '70': 'C√≤n 70%',
                    '80': 'C√≤n 80%',
                    '90': 'C√≤n 90%',
                    '95': 'C√≤n 95%',
                    'newmh': 'M·ªõi nh∆∞ng m·∫•t h·ªôp',
                    'newrt': 'M·ªõi nh∆∞ng r√°ch tem',
                    'newx': 'M·ªõi nh∆∞ng h·ªôp b·ªã x∆∞·ªõc',
                    'chiet': 'S·∫£n ph·∫©m chi·∫øt'
                }[p.status] || p.status;
                specsHTML += `<div class="col-md-6"><strong>T√¨nh tr·∫°ng:</strong> ${statusText}</div>`;
            }
            if (p.ingredients) specsHTML += `<div class="col-12"><strong>Th√†nh ph·∫ßn:</strong><br>${p.ingredients}</div>`;
            
            specsHTML += '</div>';
            specEl.innerHTML = specsHTML || 'Ch∆∞a c√≥ th√¥ng s·ªë.';
        }

        const crumb = document.getElementById('detailBreadcrumb'); if (crumb) crumb.textContent = p.name || '';
        const catEl = document.getElementById('detailCategory'); if (catEl) catEl.textContent = p.category?.name || 'Danh m·ª•c';

        // Display tags
        const tagsContainer = document.getElementById('detailTags');
        const tagsList = document.getElementById('detailTagsList');
        if (tagsContainer && tagsList && p.tags && p.tags.length > 0) {
            tagsContainer.style.display = '';
            tagsList.innerHTML = p.tags.map(tag => 
                `<span class="badge bg-primary me-2 mb-2">${tag.name || tag}</span>`
            ).join('');
        }

        // Display gifts
        const giftsContainer = document.getElementById('detailGifts');
        const giftsList = document.getElementById('detailGiftsList');
        if (giftsContainer && giftsList && p.gifts && p.gifts.length > 0) {
            giftsContainer.style.display = '';
            giftsList.innerHTML = p.gifts.map(gift => 
                `<div class="d-flex align-items-center mb-2">
                    <img src="${gift.image || '/static/image/default-product.jpg'}" 
                         alt="${gift.name}" 
                         class="me-2" 
                         style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">
                    <div>
                        <div class="fw-semibold">${gift.name}</div>
                        <small class="text-muted">${gift.description || ''}</small>
                    </div>
                </div>`
            ).join('');
        }

        // Wire add to cart
        const addBtn = document.getElementById('detailAddToCartBtn');
        if (addBtn) {
            addBtn.addEventListener('click', () => {
                const qty = Math.max(1, parseInt(document.getElementById('quantity')?.value || '1', 10) || 1);
                const productPriceText = formatPrice(discounted || original || 0);
                addProductToCart(String(p.id), p.name, productPriceText, imageUrl, original ? formatPrice(original) : null, qty);
                const imgEl = document.getElementById('mainImage');
                flyToCart(imgEl, () => {
                    updateCartCount();
                });
            });
        }

        const buyBtn = document.getElementById('detailBuyNowBtn');
        if (buyBtn) {
            buyBtn.addEventListener('click', () => {
                const qty = parseInt(document.getElementById('quantity')?.value || '1', 10) || 1;
                const productPriceText = formatPrice(discounted || original || 0);
                addProductToCart(String(p.id), p.name, productPriceText, imageUrl, original ? formatPrice(original) : null);
                window.location.href = '/checkout';
            });
        }

        // Status bar if low stock
        if (stock <= 5 && stock >= 0) {
            const statusWrap = document.getElementById('detailStatus');
            const statusText = document.getElementById('detailStatusText');
            if (statusWrap && statusText) {
                statusWrap.style.display = '';
                statusText.innerHTML = `<strong>Ch·ªâ c√≤n ${stock} s·∫£n ph·∫©m!</strong> ƒê·∫∑t h√†ng ngay ƒë·ªÉ kh√¥ng b·ªè l·ª°.`;
            }
        }
    }

    function initProductDetailPage() {
        if (!document.getElementById('product-detail-page')) return;
        const id = parseProductIdFromPath();
        if (!id) return;
        
        // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu t·ª´ Flask template kh√¥ng
        const productData = window.productData;
        if (productData) {
            console.log('Using product data from Flask template:', productData);
            populateDetail(productData);
            return;
        }
        
        // Fallback: fetch t·ª´ API PythonAnywhere
        const apiUrl = `/api/products/${id}`;
        console.log('Fetching product from API:', apiUrl);
        fetch(apiUrl)
            .then(r => r.ok ? r.json() : Promise.reject(new Error('Not found')))
            .then(populateDetail)
            .catch((error) => {
                console.error('API fetch failed:', error);
                showNotification('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ho·∫∑c x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu.', 'error');
            });
    }

    return initProductDetailPage;
})();

// Helpers to mark required fields visually without alert
function markInvalidField(fieldEl, message = 'Vui l√≤ng ƒëi·ªÅn th√¥ng tin n√†y', styles) {
    if (!fieldEl) return;
    fieldEl.classList.add('is-invalid');
    // Ensure feedback node exists
    let feedback = fieldEl.parentElement?.querySelector('.invalid-feedback');
    if (!feedback) {
        feedback = document.createElement('div');
        feedback.className = 'invalid-feedback';
        fieldEl.parentElement && fieldEl.parentElement.appendChild(feedback);
    }
    feedback.textContent = message;
    if (styles && typeof styles === 'object') {
        Object.assign(feedback.style, styles);
    }
}
function clearInvalidField(fieldEl) {
    if (!fieldEl) return;
    fieldEl.classList.remove('is-invalid');
    const feedback = fieldEl.parentElement?.querySelector('.invalid-feedback');
    if (feedback) feedback.textContent = '';
}

// Global delegated handler as a fallback to ensure place order always fires on checkout
document.addEventListener('click', function(e) {
    const btn = e.target.closest('#place-order-btn, [data-place-order], button[name="place-order"]');
    if (!btn) return;
    if (document.querySelector('input[name="pay"]')) {
        e.preventDefault();
        console.log('[Checkout] Place order click captured (delegated).');
        handlePlaceOrder();
    }
});

// Helper: show success order modal
function showOrderSuccessModal(onOk) {
    let modalEl = document.getElementById('orderSuccessModal');
    if (!modalEl) {
        modalEl = document.createElement('div');
        modalEl.id = 'orderSuccessModal';
        modalEl.className = 'modal fade';
        modalEl.tabIndex = -1;
        // Prevent closing by backdrop/ESC
        modalEl.setAttribute('data-bs-backdrop', 'static');
        modalEl.setAttribute('data-bs-keyboard', 'false');
        modalEl.innerHTML = `
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        ƒê·∫∑t h√†ng th√†nh c√¥ng
                    </h5>
                </div>
                <div class="modal-body pt-0">
                    <div class="text-center py-2">
                        <div class="display-6 text-success mb-2"><i class="fas fa-bag-shopping"></i></div>
                        <p class="mb-0">ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t th√†nh c√¥ng.</p>
                        <p class="text-muted mb-0">C·∫£m ∆°n b·∫°n ƒë√£ lu√¥n tin t∆∞·ªüng ch√∫ng t√¥i!</p>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light text-dark border border-success" id="orderSuccessOkBtn" style="padding: 8px 16px;">Quay l·∫°i trang ch·ªß</button>
                </div>
            </div>
        </div>`;
        document.body.appendChild(modalEl);
    } else {
        // Ensure attributes are applied if modal already exists
        modalEl.setAttribute('data-bs-backdrop', 'static');
        modalEl.setAttribute('data-bs-keyboard', 'false');
    }
    const okBtn = modalEl.querySelector('#orderSuccessOkBtn');
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl, { backdrop: 'static', keyboard: false });
    const cleanup = () => {
        okBtn && okBtn.removeEventListener('click', handleOk);
        modalEl && modalEl.removeEventListener('hidden.bs.modal', cleanup);
    };
    const handleOk = () => {
        cleanup();
        modal.hide();
        if (typeof onOk === 'function') onOk();
    };
    okBtn && okBtn.addEventListener('click', handleOk);
    modalEl && modalEl.addEventListener('hidden.bs.modal', cleanup);
    modal.show();
}

// Initialize related products on product detail page
function initRelatedProducts() {
    if (!document.getElementById('product-detail-page')) return;
    const container = document.getElementById('related-products-container');
    if (!container) return;

    // Build API: fetch a list (we'll randomize client-side) then slice 10
    const apiUrl = '/api/products';

    fetch(apiUrl)
        .then(r => r.ok ? r.json() : Promise.reject(new Error('API error')))
        .then(list => {
            if (!Array.isArray(list) || list.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m li√™n quan.</p>';
                return;
            }
            // Shuffle and take up to 10
            const shuffled = list.sort(() => Math.random() - 0.5).slice(0, 10);

            // Create carousel like homepage
            const wrapper = document.createElement('div');
            wrapper.className = 'position-relative';
            wrapper.style.overflow = 'hidden';
            wrapper.style.padding = '10px 40px';

            const track = document.createElement('div');
            track.className = 'related-track d-flex';
            track.style.gap = '16px';
            track.style.transition = 'transform .4s ease';
            track.dataset.index = '0';
            track.dataset.perView = '5';

            shuffled.forEach(p => {
                const item = document.createElement('div');
                item.className = 'slider-item';
                item.style.flex = '0 0 auto';
                item.innerHTML = createProductCard(p);
                track.appendChild(item);
            });

            wrapper.appendChild(track);
            container.innerHTML = '';
            container.appendChild(wrapper);

            // Nav buttons
            if (shuffled.length > 5) {
                const left = document.createElement('button');
                left.className = 'btn btn-light position-absolute';
                left.style.cssText = 'z-index:10;border-radius:50%;width:40px;height:40px;box-shadow:0 4px 10px rgba(0,0,0,.2);top:40%;left:10px;transform:translateY(-50%);';
                left.innerHTML = '<i class="fas fa-chevron-left"></i>';
                const right = document.createElement('button');
                right.className = 'btn btn-light position-absolute';
                right.style.cssText = 'z-index:10;border-radius:50%;width:40px;height:40px;box-shadow:0 4px 10px rgba(0,0,0,.2);top:40%;right:10px;transform:translateY(-50%);';
                right.innerHTML = '<i class="fas fa-chevron-right"></i>';
                wrapper.appendChild(left);
                wrapper.appendChild(right);

                const relayout = () => {
                    const per = window.innerWidth <= 576 ? 2 : (window.innerWidth <= 768 ? 3 : 5);
                    track.dataset.perView = String(per);
                    const containerWidth = wrapper.clientWidth - 20 * 2; // approximate side paddings
                    const gap = 16;
                    const itemWidth = Math.floor((containerWidth - gap * (per - 1)) / per);
                    track.querySelectorAll('.slider-item').forEach(it => { it.style.width = itemWidth + 'px'; });
                };
                const navigate = dir => {
                    const per = parseInt(track.dataset.perView || '5', 10);
                    const current = parseInt(track.dataset.index || '0', 10);
                    const maxIndex = Math.max(0, shuffled.length - per);
                    const next = Math.max(0, Math.min(maxIndex, current + (dir === 'left' ? -1 : 1)));
                    if (next === current) return;
                    track.dataset.index = String(next);
                    const first = track.querySelector('.slider-item');
                    const step = (first ? first.offsetWidth : 0) + 16;
                    track.style.transform = `translateX(${-next * step}px)`;
                };
                left.addEventListener('click', () => navigate('left'));
                right.addEventListener('click', () => navigate('right'));
                window.addEventListener('resize', () => { relayout(); navigate('left'); navigate('right'); });
                relayout();
            }

            // Re-init for newly added cards
            initProductCards();
            initAnimations();
        })
        .catch(() => {
            container.innerHTML = '<p class="text-center text-danger">Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m li√™n quan.</p>';
        });
}

// Global function to initialize product detail page
window.initProductDetailPageGlobal = function() {
    console.log('üîç initProductDetailPageGlobal called');
    
    if (!document.getElementById('product-detail-page')) {
        console.log('‚ùå product-detail-page element not found');
        return;
    }
    
    const id = parseProductIdFromPath();
    if (!id) {
        console.log('‚ùå Product ID not found in URL');
        return;
    }
    
    console.log('‚úÖ Product ID found:', id);
    
    // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu t·ª´ Flask template kh√¥ng
    const productData = window.productData;
    if (productData) {
        console.log('‚úÖ Using product data from Flask template:', productData);
        console.log('üì¶ Product name:', productData.name);
        console.log('üí∞ Product price:', productData.sale_price);
        
        try {
            populateDetail(productData);
            console.log('‚úÖ populateDetail called successfully');
        } catch (error) {
            console.error('‚ùå Error in populateDetail:', error);
        }
        return;
    }
    
    console.log('‚ö†Ô∏è No product data from Flask template, trying API...');
    
    // Fallback: fetch t·ª´ API PythonAnywhere
    const apiUrl = `/api/products/${id}`;
    console.log('Fetching product from API:', apiUrl);
    fetch(apiUrl)
        .then(r => r.ok ? r.json() : Promise.reject(new Error('Not found')))
        .then(populateDetail)
        .catch((error) => {
            console.error('API fetch failed:', error);
            showNotification('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ho·∫∑c x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu.', 'error');
        });
};

// Initialize product detail page when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize product detail page if we're on a product detail page
    if (document.getElementById('product-detail-page')) {
        console.log('Initializing product detail page...');
        window.initProductDetailPageGlobal();
    }
});


        modalEl.id = 'orderSuccessModal';
        modalEl.className = 'modal fade';
        modalEl.tabIndex = -1;
        // Prevent closing by backdrop/ESC
        modalEl.setAttribute('data-bs-backdrop', 'static');
        modalEl.setAttribute('data-bs-keyboard', 'false');
        modalEl.innerHTML = `
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        ƒê·∫∑t h√†ng th√†nh c√¥ng
                    </h5>
                </div>
                <div class="modal-body pt-0">
                    <div class="text-center py-2">
                        <div class="display-6 text-success mb-2"><i class="fas fa-bag-shopping"></i></div>
                        <p class="mb-0">ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t th√†nh c√¥ng.</p>
                        <p class="text-muted mb-0">C·∫£m ∆°n b·∫°n ƒë√£ lu√¥n tin t∆∞·ªüng ch√∫ng t√¥i!</p>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light text-dark border border-success" id="orderSuccessOkBtn" style="padding: 8px 16px;">Quay l·∫°i trang ch·ªß</button>
                </div>
            </div>
        </div>`;
        document.body.appendChild(modalEl);
    } else {
        // Ensure attributes are applied if modal already exists
        modalEl.setAttribute('data-bs-backdrop', 'static');
        modalEl.setAttribute('data-bs-keyboard', 'false');
    }
    const okBtn = modalEl.querySelector('#orderSuccessOkBtn');
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl, { backdrop: 'static', keyboard: false });
    const cleanup = () => {
        okBtn && okBtn.removeEventListener('click', handleOk);
        modalEl && modalEl.removeEventListener('hidden.bs.modal', cleanup);
    };
    const handleOk = () => {
        cleanup();
        modal.hide();
        if (typeof onOk === 'function') onOk();
    };
    okBtn && okBtn.addEventListener('click', handleOk);
    modalEl && modalEl.addEventListener('hidden.bs.modal', cleanup);
    modal.show();
}

// Initialize related products on product detail page
function initRelatedProducts() {
    if (!document.getElementById('product-detail-page')) return;
    const container = document.getElementById('related-products-container');
    if (!container) return;

    // Build API: fetch a list (we'll randomize client-side) then slice 10
    const apiUrl = '/api/products';

    fetch(apiUrl)
        .then(r => r.ok ? r.json() : Promise.reject(new Error('API error')))
        .then(list => {
            if (!Array.isArray(list) || list.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m li√™n quan.</p>';
                return;
            }
            // Shuffle and take up to 10
            const shuffled = list.sort(() => Math.random() - 0.5).slice(0, 10);

            // Create carousel like homepage
            const wrapper = document.createElement('div');
            wrapper.className = 'position-relative';
            wrapper.style.overflow = 'hidden';
            wrapper.style.padding = '10px 40px';

            const track = document.createElement('div');
            track.className = 'related-track d-flex';
            track.style.gap = '16px';
            track.style.transition = 'transform .4s ease';
            track.dataset.index = '0';
            track.dataset.perView = '5';

            shuffled.forEach(p => {
                const item = document.createElement('div');
                item.className = 'slider-item';
                item.style.flex = '0 0 auto';
                item.innerHTML = createProductCard(p);
                track.appendChild(item);
            });

            wrapper.appendChild(track);
            container.innerHTML = '';
            container.appendChild(wrapper);

            // Nav buttons
            if (shuffled.length > 5) {
                const left = document.createElement('button');
                left.className = 'btn btn-light position-absolute';
                left.style.cssText = 'z-index:10;border-radius:50%;width:40px;height:40px;box-shadow:0 4px 10px rgba(0,0,0,.2);top:40%;left:10px;transform:translateY(-50%);';
                left.innerHTML = '<i class="fas fa-chevron-left"></i>';
                const right = document.createElement('button');
                right.className = 'btn btn-light position-absolute';
                right.style.cssText = 'z-index:10;border-radius:50%;width:40px;height:40px;box-shadow:0 4px 10px rgba(0,0,0,.2);top:40%;right:10px;transform:translateY(-50%);';
                right.innerHTML = '<i class="fas fa-chevron-right"></i>';
                wrapper.appendChild(left);
                wrapper.appendChild(right);

                const relayout = () => {
                    const per = window.innerWidth <= 576 ? 2 : (window.innerWidth <= 768 ? 3 : 5);
                    track.dataset.perView = String(per);
                    const containerWidth = wrapper.clientWidth - 20 * 2; // approximate side paddings
                    const gap = 16;
                    const itemWidth = Math.floor((containerWidth - gap * (per - 1)) / per);
                    track.querySelectorAll('.slider-item').forEach(it => { it.style.width = itemWidth + 'px'; });
                };
                const navigate = dir => {
                    const per = parseInt(track.dataset.perView || '5', 10);
                    const current = parseInt(track.dataset.index || '0', 10);
                    const maxIndex = Math.max(0, shuffled.length - per);
                    const next = Math.max(0, Math.min(maxIndex, current + (dir === 'left' ? -1 : 1)));
                    if (next === current) return;
                    track.dataset.index = String(next);
                    const first = track.querySelector('.slider-item');
                    const step = (first ? first.offsetWidth : 0) + 16;
                    track.style.transform = `translateX(${-next * step}px)`;
                };
                left.addEventListener('click', () => navigate('left'));
                right.addEventListener('click', () => navigate('right'));
                window.addEventListener('resize', () => { relayout(); navigate('left'); navigate('right'); });
                relayout();
            }

            // Re-init for newly added cards
            initProductCards();
            initAnimations();
        })
        .catch(() => {
            container.innerHTML = '<p class="text-center text-danger">Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m li√™n quan.</p>';
        });
}

// Global function to initialize product detail page
window.initProductDetailPageGlobal = function() {
    console.log('üîç initProductDetailPageGlobal called');
    
    if (!document.getElementById('product-detail-page')) {
        console.log('‚ùå product-detail-page element not found');
        return;
    }
    
    const id = parseProductIdFromPath();
    if (!id) {
        console.log('‚ùå Product ID not found in URL');
        return;
    }
    
    console.log('‚úÖ Product ID found:', id);
    
    // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu t·ª´ Flask template kh√¥ng
    const productData = window.productData;
    if (productData) {
        console.log('‚úÖ Using product data from Flask template:', productData);
        console.log('üì¶ Product name:', productData.name);
        console.log('üí∞ Product price:', productData.sale_price);
        
        try {
            populateDetail(productData);
            console.log('‚úÖ populateDetail called successfully');
        } catch (error) {
            console.error('‚ùå Error in populateDetail:', error);
        }
        return;
    }
    
    console.log('‚ö†Ô∏è No product data from Flask template, trying API...');
    
    // Fallback: fetch t·ª´ API PythonAnywhere
    const apiUrl = `/api/products/${id}`;
    console.log('Fetching product from API:', apiUrl);
    fetch(apiUrl)
        .then(r => r.ok ? r.json() : Promise.reject(new Error('Not found')))
        .then(populateDetail)
        .catch((error) => {
            console.error('API fetch failed:', error);
            showNotification('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ho·∫∑c x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu.', 'error');
        });
};

// Initialize product detail page when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize product detail page if we're on a product detail page
    if (document.getElementById('product-detail-page')) {
        console.log('Initializing product detail page...');
        window.initProductDetailPageGlobal();
    }
});


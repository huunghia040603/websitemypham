{% extends "admin_base.html" %}

{% block title %}Quản Lý Tài Nguyên Marketing{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-images me-2"></i>Quản Lý Tài Nguyên Marketing</h2>
    <div>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#uploadModal">
            <i class="fas fa-upload me-1"></i>Upload Hàng Loạt
        </button>
        <button class="btn btn-danger" id="deleteSelectedBtn" disabled>
            <i class="fas fa-trash me-1"></i>Xóa Đã Chọn
        </button>
    </div>
</div>

<!-- Filter và Search -->
<div class="row mb-3">
    <div class="col-md-3">
        <select class="form-select" id="typeFilter">
            <option value="">Tất cả loại</option>
            <option value="new_product" >Sản phẩm mới</option>
            <option value="event">Sự kiện</option>
            <option value="product">Sản phẩm</option>
            <option value="article">Bài viết mẫu</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="statusFilter">
            <option value="">Tất cả trạng thái</option>
            <option value="true">Đang hoạt động</option>
            <option value="false">Không hoạt động</option>
        </select>
    </div>
    <div class="col-md-4">
        <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm theo tên...">
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary w-100" onclick="loadResources()">
            <i class="fas fa-search"></i> Tìm
        </button>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="totalResources">-</h4>
                        <p class="mb-0">Tổng tài nguyên</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-images fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="activeResources">-</h4>
                        <p class="mb-0">Đang hoạt động</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="totalDownloads">-</h4>
                        <p class="mb-0">Tổng lượt tải</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-download fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="newProductCount">-</h4>
                        <p class="mb-0">Sản phẩm mới</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-star fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resources Grid -->
<div class="row" id="resourcesGrid">
    <div class="col-12 text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Đang tải...</span>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Tài Nguyên Hàng Loạt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">Loại tài nguyên</label>
                        <select class="form-select" name="resource_type" required>
                            <option value="">Chọn loại tài nguyên</option>
                            <option value="new_product" selected>Sản phẩm mới</option>
                            <option value="event">Sự kiện</option>
                            <option value="product">Sản phẩm</option>
                            <option value="article">Bài viết mẫu</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Chọn file (có thể chọn nhiều)</label>
                        <input type="file" class="form-control" name="files" multiple accept="image/*,.pdf,.doc,.docx" required>
                        <div class="form-text">Hỗ trợ: JPG, PNG, GIF, PDF, DOC, DOCX</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô tả chung (tùy chọn)</label>
                        <textarea class="form-control" name="description" rows="3" placeholder="Mô tả chung cho tất cả file..."></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_active" checked>
                            <label class="form-check-label">Kích hoạt ngay sau khi upload</label>
                        </div>
                    </div>
                </form>
                <div id="uploadProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="mt-2">
                        <small id="uploadStatus">Đang upload...</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="uploadFiles()">Upload</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chỉnh Sửa Tài Nguyên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editId" name="id">
                    <div class="mb-3">
                        <label class="form-label">Tên tài nguyên</label>
                        <input type="text" class="form-control" id="editName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" id="editDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Loại tài nguyên</label>
                        <select class="form-select" id="editResourceType" name="resource_type" required>
                            <option value="new_product">Sản phẩm mới</option>
                            <option value="event">Sự kiện</option>
                            <option value="product">Sản phẩm</option>
                            <option value="article">Bài viết mẫu</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editIsActive" name="is_active">
                            <label class="form-check-label">Đang hoạt động</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="updateResource()">Cập nhật</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.resource-card {
    transition: transform 0.2s ease;
    cursor: pointer;
}

.resource-card:hover {
    transform: translateY(-2px);
}

.resource-preview {
    height: 150px;
    object-fit: cover;
    width: 100%;
}

.file-icon {
    height: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    color: #6c757d;
}

.selected {
    border: 3px solid #007bff !important;
}

.bulk-actions {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let allResources = [];
let selectedResources = [];

// Load resources when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadResources();
    loadStats();
    
    // Add event listeners
    document.getElementById('typeFilter').addEventListener('change', loadResources);
    document.getElementById('statusFilter').addEventListener('change', loadResources);
    document.getElementById('searchInput').addEventListener('input', debounce(loadResources, 500));
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

async function loadResources() {
    try {
        const typeFilter = document.getElementById('typeFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const searchQuery = document.getElementById('searchInput').value;
        
        // Nếu filter là "product", load ảnh sản phẩm từ API products
        if (typeFilter === 'product') {
            await loadProductImages();
            return;
        }
        
        let url = '/backend/api/marketing-resources/';
        const params = new URLSearchParams();
        
        if (typeFilter) params.append('resource_type', typeFilter);
        if (statusFilter) params.append('is_active', statusFilter);
        if (searchQuery) params.append('search', searchQuery);
        
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        const response = await fetch(url);
        allResources = await response.json();
        displayResources(allResources);
        
    } catch (error) {
        console.error('Error loading resources:', error);
        document.getElementById('resourcesGrid').innerHTML = '<div class="col-12 text-center text-danger">Lỗi khi tải tài nguyên</div>';
    }
}

async function loadProductImages() {
    try {
        // Gọi trực tiếp Django API để lấy TẤT CẢ sản phẩm (không filter theo status)
        const response = await fetch('/backend/api/products/?page_size=1000');
        const data = await response.json();
        const products = data.results || data; // Handle both paginated and non-paginated responses
        console.log(`🔍 Admin loaded ${products.length} products from Django API`);
        
        // Chuyển đổi dữ liệu ảnh sản phẩm thành format giống MarketingResource
        allResources = [];
        
        products.forEach(product => {
            // Lấy tất cả ảnh của sản phẩm
            const allImages = product.all_images || [];
            
            allImages.forEach((imageUrl, index) => {
                if (imageUrl && imageUrl.trim()) {
                    allResources.push({
                        id: `product_${product.id}_${index + 1}`,
                        name: `${product.name} - Ảnh ${index + 1}`,
                        description: `Sản phẩm ${product.brand_name || 'Không xác định'}`,
                        resource_type: 'product',
                        file_url: imageUrl,
                        thumbnail_url: imageUrl,
                        is_image: true,
                        is_active: true, // Ảnh sản phẩm luôn active
                        download_count: 0,
                        created_at: new Date().toISOString(),
                        product_id: product.id,
                        product_name: product.name,
                        image_index: index + 1,
                        total_images: allImages.length
                    });
                }
            });
        });
        
        console.log(`🔍 Admin products with images: ${allResources.length}`);
        displayResources(allResources);
        
    } catch (error) {
        console.error('Error loading product images:', error);
        document.getElementById('resourcesGrid').innerHTML = '<div class="col-12 text-center text-danger">Lỗi khi tải ảnh sản phẩm</div>';
    }
}

function displayResources(resources) {
    const container = document.getElementById('resourcesGrid');
    
    if (!resources || resources.length === 0) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-5">Không có tài nguyên nào</div>';
        return;
    }
    
    container.innerHTML = resources.map(resource => {
        const isImage = resource.is_image;
        const isSelected = selectedResources.includes(resource.id);
        const showDescription = resource.resource_type === 'event' || resource.resource_type === 'article';
        
        return `
            <div class="col-md-3 col-lg-2 col-6 mb-3">
                <div class="resource-item position-relative">
                    <!-- Checkbox -->
                    <div class="position-absolute top-0 start-0 m-2">
                        <input type="checkbox" class="form-check-input resource-checkbox" 
                               value="${resource.id}" ${isSelected ? 'checked' : ''}
                               onchange="toggleSelection(${resource.id})" 
                               style="background-color: white; width: 18px; height: 18px;">
                    </div>
                    
                    <!-- Ảnh -->
                    ${isImage ? `
                        <div class="text-center">
                            <img src="${resource.thumbnail_url || resource.file_url}" 
                                 class="img-fluid rounded shadow-sm" 
                                 style="width: 100%; max-height: 300px; object-fit: contain;"
                                 alt="${resource.name}">
                        </div>
                    ` : `
                        <div class="text-center bg-light rounded shadow-sm d-flex align-items-center justify-content-center" 
                             style="height: 120px;">
                            <i class="fas fa-file-alt fa-2x text-muted"></i>
                        </div>
                    `}
                    
                    <!-- Lượt tải xuống -->
                    <div class="position-absolute top-0 end-0 m-2">
                        <span class="badge bg-info" style="font-size: 10px;">
                            <i class="fas fa-download me-1"></i>${resource.download_count || 0}
                        </span>
                    </div>
                    
                    <!-- Nút copy description cho event và article -->
                    ${showDescription && resource.description ? `
                        <div class="position-absolute top-0 start-0 m-2" style="top: 30px !important;">
                            <button class="btn btn-sm btn-success rounded-circle shadow" 
                                    onclick="copyDescription('${resource.description.replace(/'/g, "\\'")}', '${resource.name}')"
                                    style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;"
                                    title="Copy mô tả">
                                <i class="fas fa-copy" style="font-size: 12px;"></i>
                            </button>
                        </div>
                    ` : ''}
                    
                    <!-- Nút Edit -->
                    <div class="position-absolute bottom-0 start-0 m-2">
                        <button class="btn btn-sm btn-warning rounded-circle shadow" 
                                onclick="editResource(${resource.id}, event)"
                                style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-edit" style="font-size: 12px;"></i>
                        </button>
                    </div>
                    
                    <!-- Nút Xóa -->
                    <div class="position-absolute bottom-0 end-0 m-2">
                        <button class="btn btn-sm btn-danger rounded-circle shadow" 
                                onclick="deleteResource(${resource.id}, event)"
                                style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-trash" style="font-size: 12px;"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function toggleSelection(resourceId) {
    const index = selectedResources.indexOf(resourceId);
    if (index > -1) {
        selectedResources.splice(index, 1);
    } else {
        selectedResources.push(resourceId);
    }
    
    updateDeleteButton();
    displayResources(allResources);
}

function updateDeleteButton() {
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    deleteBtn.disabled = selectedResources.length === 0;
    deleteBtn.textContent = selectedResources.length > 0 ? 
        `Xóa Đã Chọn (${selectedResources.length})` : 'Xóa Đã Chọn';
}

async function loadStats() {
    try {
        const response = await fetch('/backend/api/marketing-resources/');
        const resources = await response.json();
        
        const total = resources.length;
        const active = resources.filter(r => r.is_active).length;
        const totalDownloads = resources.reduce((sum, r) => sum + (r.download_count || 0), 0);
        const newProductCount = resources.filter(r => r.resource_type === 'new_product').length;
        
        document.getElementById('totalResources').textContent = total;
        document.getElementById('activeResources').textContent = active;
        document.getElementById('totalDownloads').textContent = totalDownloads;
        document.getElementById('newProductCount').textContent = newProductCount;
        
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function uploadFiles() {
    const form = document.getElementById('uploadForm');
    const formData = new FormData(form);
    const files = formData.getAll('files');
    
    if (files.length === 0) {
        alert('Vui lòng chọn ít nhất một file');
        return;
    }
    
    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = progressDiv.querySelector('.progress-bar');
    const statusText = document.getElementById('uploadStatus');
    
    progressDiv.style.display = 'block';
    
    try {
        statusText.textContent = `Đang upload ${files.length} file hàng loạt...`;
        progressBar.style.width = '0%';
        
        // Use bulk upload endpoint - auto detect environment
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        let uploadUrl;
        if (isLocalhost) {
            uploadUrl = 'http://localhost:8000/api/upload-marketing-resources-bulk';
        } else {
            uploadUrl = 'https://buddyskincare.vn/backend/api/api/upload-marketing-resources-bulk/';
        }
        
        console.log(`🔍 Environment: ${isLocalhost ? 'Local' : 'Production'}`);
        console.log(`🔗 Upload URL: ${uploadUrl}`);
        
        const bulkResponse = await fetch(uploadUrl, {
            method: 'POST',
            body: formData
        });
        
        if (!bulkResponse.ok) {
            const errorText = await bulkResponse.text();
            throw new Error(`Lỗi upload hàng loạt: ${bulkResponse.status} ${bulkResponse.statusText} - ${errorText}`);
        }
        
        const result = await bulkResponse.json();
        console.log('📊 Bulk upload result:', result);
        
        // Update progress bar
        progressBar.style.width = '100%';
        
        if (result.success) {
            statusText.textContent = `Upload hoàn tất: ${result.successful_uploads}/${result.total_files} file thành công`;
            progressBar.classList.add('bg-success');
            
            // Show detailed results if there are errors
            if (result.errors && result.errors.length > 0) {
                console.warn('⚠️ Upload errors:', result.errors);
                statusText.innerHTML += `<br><small class="text-warning">Lỗi: ${result.errors.join(', ')}</small>`;
            }
        } else {
            throw new Error(result.error || 'Upload thất bại');
        }
        
        // Reload resources and stats
        setTimeout(() => {
            loadResources();
            loadStats();
            bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
            form.reset();
            progressDiv.style.display = 'none';
            progressBar.classList.remove('bg-success', 'bg-danger');
            progressBar.style.width = '0%';
        }, 2000);
        
    } catch (error) {
        console.error('Upload error:', error);
        statusText.textContent = 'Lỗi upload: ' + error.message;
        progressBar.classList.add('bg-danger');
    }
}

function editResource(resourceId, event) {
    event.stopPropagation();
    
    const resource = allResources.find(r => r.id === resourceId);
    if (!resource) return;
    
    document.getElementById('editId').value = resource.id;
    document.getElementById('editName').value = resource.name;
    document.getElementById('editDescription').value = resource.description || '';
    document.getElementById('editResourceType').value = resource.resource_type;
    document.getElementById('editIsActive').checked = resource.is_active;
    
    new bootstrap.Modal(document.getElementById('editModal')).show();
}

async function updateResource() {
    const form = document.getElementById('editForm');
    const formData = new FormData(form);
    const resourceId = formData.get('id');
    
    try {
        const response = await fetch(`/backend/api/marketing-resources/${resourceId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: formData.get('name'),
                description: formData.get('description'),
                resource_type: formData.get('resource_type'),
                is_active: formData.get('is_active') === 'on'
            })
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            loadResources();
            loadStats();
        } else {
            throw new Error('Cập nhật thất bại');
        }
        
    } catch (error) {
        console.error('Update error:', error);
        alert('Lỗi cập nhật: ' + error.message);
    }
}

async function deleteResource(resourceId, event) {
    event.stopPropagation();
    
    if (!confirm('Bạn có chắc chắn muốn xóa tài nguyên này?')) {
        return;
    }
    
    try {
        const response = await fetch(`/backend/api/marketing-resources/${resourceId}/`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadResources();
            loadStats();
        } else {
            throw new Error('Xóa thất bại');
        }
        
    } catch (error) {
        console.error('Delete error:', error);
        alert('Lỗi xóa: ' + error.message);
    }
}

// Delete selected resources
document.getElementById('deleteSelectedBtn').addEventListener('click', async function() {
    if (selectedResources.length === 0) return;
    
    if (!confirm(`Bạn có chắc chắn muốn xóa ${selectedResources.length} tài nguyên đã chọn?`)) {
        return;
    }
    
    try {
        for (const resourceId of selectedResources) {
            const response = await fetch(`/backend/api/marketing-resources/${resourceId}/`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error(`Lỗi xóa tài nguyên ID ${resourceId}`);
            }
        }
        
        selectedResources = [];
        updateDeleteButton();
        loadResources();
        loadStats();
        
    } catch (error) {
        console.error('Bulk delete error:', error);
        alert('Lỗi xóa hàng loạt: ' + error.message);
    }
});

async function copyDescription(description, resourceName) {
    try {
        // Copy description to clipboard
        await navigator.clipboard.writeText(description);
        
        // Show success message
        const toast = document.createElement('div');
        toast.className = 'position-fixed top-0 end-0 m-3 p-3 bg-success text-white rounded shadow';
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-check-circle me-2"></i>
                <div>
                    <strong>Đã copy!</strong><br>
                    <small>Mô tả của "${resourceName}"</small>
                </div>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Remove toast after 3 seconds
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 3000);
        
    } catch (error) {
        console.error('Error copying description:', error);
        
        // Fallback: show alert
        alert(`Mô tả của "${resourceName}":\n\n${description}`);
    }
}
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}ÄÄƒng kÃ½ Cá»™ng TÃ¡c ViÃªn{% endblock %}

{% block extra_css %}
<style>
  .pt-hero{position:relative;background:linear-gradient(135deg,#7c63f2 0%,#4a4be7 60%,#3b2f92 100%);color:#fff;padding:2.5rem 0 2rem;overflow:hidden}
  .pt-pill{border-radius:999px;padding:.35rem .8rem;background: rgb(219, 234, 254);
    color: rgb(30, 64, 175);
    border: 2px solid rgb(59, 130, 246);}
  .pt-card{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
  .pt-muted{color:#6b7280}
  .pt-form .form-label{font-weight:500}
  .pt-form .form-control,.pt-form .form-select{border-radius:10px}
  .pt-benefit{display:flex;gap:.75rem;align-items:flex-start}
  .pt-benefit .ico{width:36px;height:36px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center}
  .fw-semibold{ color: #0b0061 !important; }
  .pt-section-title{display:flex;align-items:center;gap:.5rem;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px;padding:.5rem .75rem;margin:.25rem 0 .25rem}
  .pt-section-title .badge-req{color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;border-radius:6px;padding:.1rem .4rem;font-size:.7rem}
  .pt-divider{height:1px;background:linear-gradient(90deg,#cbd5e1,#e2e8f0);margin:.5rem 0}
</style>
{% endblock %}

{% block content %}
<div class="pt-hero">
  <div class="container">
    <div class="row g-4 align-items-start">
      <div class="col-lg-7">
        <div class="pt-card p-3" style="background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%); border: 2px solid #93c5fd !important;">
          <h1 class="h3 mb-2 text-dark">ÄÄƒng kÃ½ Cá»™ng TÃ¡c ViÃªn</h1>
          <div class="pt-muted mb-2">Nháº­n hoa há»“ng cao nháº¥t trong ngÃ nh</div>
          <div class="d-flex gap-2 flex-wrap">
            <span class="pt-pill">Hoa há»“ng Ä‘áº¿n 22%</span>
            <span class="pt-pill">Thanh toÃ¡n hÃ ng tuáº§n</span>
            <span class="pt-pill">Há»— trá»£ tÃ i liá»‡u & media</span>
          </div>
        </div>
      </div>
      <div class="col-lg-5">
        <div class="pt-card p-3">
          <div class="pt-muted">Lá»£i Ã­ch nhanh</div>
          <div class="mt-2 d-grid gap-2">
            <div class="pt-benefit"><span class="ico bg-primary-subtle text-primary"><i class="fa-solid fa-bolt"></i></span><div><div class="fw-semibold">Báº¯t Ä‘áº§u nhanh</div><div class="pt-muted small">Duyá»‡t há»“ sÆ¡ trong 24h</div></div></div>
            <div class="pt-benefit"><span class="ico bg-success-subtle text-success"><i class="fa-solid fa-percent"></i></span><div><div class="fw-semibold">Chiáº¿t kháº¥u tá»‘t</div><div class="pt-muted small">Æ¯u Ä‘Ã£i theo doanh sá»‘</div></div></div>
            <div class="pt-benefit"><span class="ico bg-info-subtle text-info"><i class="fa-solid fa-headset"></i></span><div><div class="fw-semibold">Há»— trá»£ 24/7</div><div class="pt-muted small">Äá»™i ngÅ© tÆ° váº¥n Ä‘á»“ng hÃ nh</div></div></div>
          </div>
          <div class="mt-3 pt-3 border-top">
            <div class="text-center">
              <p class="small pt-muted mb-2">ÄÃ£ lÃ  cá»™ng tÃ¡c viÃªn?</p>
              <a href="/ctv/login" class="btn btn-outline-primary btn-sm w-100">
                <i class="fas fa-sign-in-alt me-1"></i>ÄÄƒng nháº­p CTV
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container py-4">
  <div class="row g-4">
    <div class="col-lg-6">
      <div class="pt-card p-4">
        <div class="pt-section-title"><strong>ThÃ´ng tin Ä‘Äƒng kÃ½</strong></div>
        <div class="pt-divider"></div>
        <form id="partnerForm" class="row g-3 pt-form" enctype="multipart/form-data">
          <div class="col-md-6">
            <label class="form-label">Há» vÃ  tÃªn <span class="text-danger">*</span></label>
            <input id="ptFullName" name="full_name" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Sá»‘ Ä‘iá»‡n thoáº¡i Zalo <span class="text-danger">*</span></label>
            <input id="ptPhone" name="phone" class="form-control"  inputmode="tel" pattern="^[0-9]{10,11}$" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">MÃ£ CTV mong muá»‘n</label>
            <input id="ptDesiredCode" name="desired_code" class="form-control" placeholder="VD: NGUYENVANA" maxlength="20">
            <div class="form-text" style="font-size: 10px;" >Chá»‰ dÃ¹ng chá»¯/sá»‘/_/-, tá»‘i Ä‘a 20 kÃ½ tá»±. CÃ³ thá»ƒ Ä‘á»ƒ trá»‘ng.</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Email <span class="text-danger">*</span></label>
            <input id="ptEmail" type="email" name="email" class="form-control"  required>
          </div>
          <div class="col-12">
            <label class="form-label">Äá»‹a chá»‰</label>
            <input id="ptAddress" name="address" class="form-control" placeholder="Sá»‘ nhÃ , Ä‘Æ°á»ng, phÆ°á»ng/xÃ£, quáº­n/huyá»‡n, tá»‰nh/thÃ nh">
          </div>

          <div class="col-12 mt-2">
            <div class="pt-divider"></div>
            <div class="pt-section-title"><strong>ThÃ´ng tin ngÃ¢n hÃ ng nháº­n hoa há»“ng</strong> <span class="badge-req">Báº¯t buá»™c</span></div>

          </div>
          <div class="col-md-4">
            <label class="form-label">TÃªn ngÃ¢n hÃ ng <span class="text-danger">*</span></label>
            <input id="ptBankName" name="bank_name" class="form-control" placeholder="VD: Vietcombank" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Sá»‘ tÃ i khoáº£n <span class="text-danger">*</span></label>
            <input id="ptBankNumber" name="bank_number" class="form-control" placeholder="VD: 0123456789" inputmode="numeric" pattern="^[0-9]{6,20}$" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">TÃªn tháº» ngÃ¢n hÃ ng <span class="text-danger">*</span></label>
            <input id="ptBankHolder" name="bank_holder" class="form-control" placeholder="VD: NGUYEN VAN A" required>
          </div>
          <div class="col-12 mt-2">
            <div class="pt-divider"></div>
            <div class="pt-section-title"><strong>XÃ¡c minh CCCD</strong> <span class="badge-req">Báº¯t buá»™c</span></div>

          </div>
          <div class="col-md-6">
            <label class="form-label">áº¢nh máº·t trÆ°á»›c CCCD <span class="text-danger">*</span></label>
            <input id="ptCccdFront" name="cccd_front" type="file" class="form-control" accept="image/*" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">áº¢nh máº·t sau CCCD <span class="text-danger">*</span></label>
            <input id="ptCccdBack" name="cccd_back" type="file" class="form-control" accept="image/*" required>
          </div>

          <div class="col-12">
            <label class="form-label">Báº¡n lÃ m gÃ¬ Ä‘á»ƒ bÃ¡n Ä‘Æ°á»£c hÃ ng (cÃ³ thá»ƒ Ä‘á»ƒ trá»‘ng)</label>
            <textarea id="ptPlan" name="sales_plan" class="form-control" rows="3" placeholder="VD: Livestream, cháº¡y quáº£ng cÃ¡o, KOC/KOL, cá»™ng Ä‘á»“ng Facebook, giá»›i thiá»‡u báº¡n bÃ¨, bÃ¡n qua Zalo, Shopee, Lazada..."></textarea>
          </div>

          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="1" id="ptAgree" required>
              <label class="form-check-label" for="ptAgree">
                TÃ´i Ä‘á»“ng Ã½ vá»›i quy Ä‘á»‹nh vÃ  thoáº£ thuáº­n cá»§a BuddySkincare
              </label>
            </div>
          </div>

          <div class="col-12">
            <button class="btn btn-primary w-100" type="submit">Gá»­i Ä‘Äƒng kÃ½</button>
          </div>
        </form>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="pt-card p-4">
        <h2 class="h5 mb-3">CÃ¢u há»i thÆ°á»ng gáº·p</h2>
        <div class="mb-2"><strong>Äiá»u kiá»‡n tham gia?</strong><div class="pt-muted">Chá»‰ cáº§n Ä‘am mÃª lÃ m Ä‘áº¹p vÃ  cÃ³ kÃªnh bÃ¡n phÃ¹ há»£p.</div></div>
        <div class="mb-2"><strong>Thanh toÃ¡n hoa há»“ng?</strong><div class="pt-muted">Chuyá»ƒn khoáº£n háº±ng tuáº§n khi Ä‘á»§ ngÆ°á»¡ng.</div></div>
        <div class="mb-2"><strong>ÄÃ o táº¡o/há»— trá»£?</strong><div class="pt-muted">TÃ i liá»‡u, nhÃ³m cá»™ng Ä‘á»“ng vÃ  há»— trá»£ trá»±c tiáº¿p.</div></div>
      </div>
      <div class="pt-card p-4 mt-3">
        <h2 class="h5 mb-3">Cáº¥p báº­c Cá»™ng tÃ¡c viÃªn</h2>
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:140px">Cáº¥p</th>
                <th style="width:160px">Hoa há»“ng</th>
                <th>MÃ´ táº£</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span class="pt-pill">Cáº¥p 1</span></td>
                <td><strong>10%</strong></td>
                <td class="pt-muted">Hoa há»“ng trÃªn doanh thu bÃ¡n Ä‘Æ°á»£c (máº·c Ä‘á»‹nh).</td>
              </tr>
              <tr>
                <td><span class="pt-pill">Cáº¥p 2</span></td>
                <td><strong>12%</strong></td>
                <td class="pt-muted">TÄƒng theo ngÆ°á»¡ng doanh thu thÃ¡ng.</td>
              </tr>
              <tr>
                <td><span class="pt-pill">Cáº¥p 3</span></td>
                <td><strong>16%</strong></td>
                <td class="pt-muted">Æ¯u Ä‘Ã£i tá»‘t hÆ¡n cho CTV tÃ­ch cá»±c.</td>
              </tr>
              <tr>
                <td><span class="pt-pill">Cáº¥p 4</span></td>
                <td><strong>20%</strong></td>
                <td class="pt-muted">Duy trÃ¬ doanh sá»‘ á»•n Ä‘á»‹nh.</td>
              </tr>
              <tr>
                <td><span class="pt-pill">Cáº¥p 5</span></td>
                <td><strong>22%</strong></td>
                <td class="pt-muted">Cáº¥p cao nháº¥t, thÆ°á»Ÿng hoa há»“ng tá»‘i Ä‘a.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let partnerSubmitting = false;
document.getElementById('partnerForm')?.addEventListener('submit', async function(e){
  e.preventDefault();
  if (partnerSubmitting) return;
  partnerSubmitting = true;
  const submitBtn = this.querySelector('button[type="submit"]');
  const btnOriginalHTML = submitBtn ? submitBtn.innerHTML : '';
  if (submitBtn){
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Äang gá»­i...';
  }
  const fullName = document.getElementById('ptFullName').value.trim();
  const phone = document.getElementById('ptPhone').value.trim();
  const email = document.getElementById('ptEmail').value.trim();
  const bankName = document.getElementById('ptBankName').value.trim();
  const bankNumber = document.getElementById('ptBankNumber').value.trim();
  const bankHolder = document.getElementById('ptBankHolder').value.trim();
  const front = document.getElementById('ptCccdFront').files?.length || 0;
  const back = document.getElementById('ptCccdBack').files?.length || 0;
  const agree = document.getElementById('ptAgree').checked;

  // Basic validations
  if (!fullName) return alert('Vui lÃ²ng nháº­p Há» vÃ  tÃªn');
  if (!/^\d{10,11}$/.test(phone)) return alert('Sá»‘ Ä‘iá»‡n thoáº¡i pháº£i 10-11 sá»‘');
  if (!email) return alert('Vui lÃ²ng nháº­p Email');
  if (!bankName || !bankNumber || !bankHolder) return alert('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin ngÃ¢n hÃ ng');
  if (!/^\d{6,20}$/.test(bankNumber)) return alert('Sá»‘ tÃ i khoáº£n khÃ´ng há»£p lá»‡');
  if (!front || !back) return alert('Vui lÃ²ng táº£i lÃªn áº£nh CCCD (máº·t trÆ°á»›c & máº·t sau)');
  if (!agree) return alert('Vui lÃ²ng Ä‘á»“ng Ã½ vá»›i quy Ä‘á»‹nh vÃ  thoáº£ thuáº­n cá»§a BuddySkincare');

  try {
    const fFile = document.getElementById('ptCccdFront').files[0];
    const bFile = document.getElementById('ptCccdBack').files[0];

    // Upload to Cloudinary directly from frontend
    async function uploadImage(file){
      console.log('ğŸ“¤ Uploading file:', file.name, 'Size:', file.size, 'Type:', file.type);

      // Check file size (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        throw new Error('File quÃ¡ lá»›n. KÃ­ch thÆ°á»›c tá»‘i Ä‘a lÃ  10MB');
      }

      // Check file type
      if (!file.type.startsWith('image/')) {
        throw new Error('Chá»‰ Ä‘Æ°á»£c upload file áº£nh');
      }

      try {
        // Try Django CCCD upload endpoint first
        console.log('ğŸ”„ Trying Django CCCD upload endpoint...');
        const fd = new FormData();
        fd.append('file', file);
        
        const djangoResp = await fetch('/backend/api/upload-cccd/', { method: 'POST', body: fd });
        if (djangoResp.ok) {
          const data = await djangoResp.json();
          console.log('ğŸ“Š Django Upload response:', data);
          if (data.success && data.url) {
            console.log('âœ… Upload successful via Django CCCD endpoint');
            console.log('ğŸ”— Cloudinary URL:', data.url);
            console.log('ğŸ†” Public ID:', data.public_id);
            console.log('ğŸ“ Size:', data.size, 'bytes');
            
            // Test URL accessibility
            try {
              const testResp = await fetch(data.url, { method: 'HEAD' });
              console.log('ğŸ” URL test result:', testResp.status, testResp.headers.get('content-type'));
            } catch (testError) {
              console.log('âš ï¸ URL test failed:', testError);
            }
            
            return data.url;
          }
        }
        console.log('âš ï¸ Django CCCD endpoint failed, trying Flask endpoint...');
        console.log('âŒ Django Response status:', djangoResp.status);
        console.log('âŒ Django Response text:', await djangoResp.text());
        
        // Try Flask CCCD upload endpoint as fallback
        console.log('ğŸ”„ Trying Flask CCCD upload endpoint as fallback...');
        const flaskResp = await fetch('/api/upload-cccd', { method: 'POST', body: fd });
        if (flaskResp.ok) {
          const data = await flaskResp.json();
          console.log('ğŸ“Š Flask Upload response:', data);
          if (data.success && data.url) {
            console.log('âœ… Upload successful via Flask CCCD endpoint');
            console.log('ğŸ”— Cloudinary URL:', data.url);
            return data.url;
          }
        }
        console.log('âš ï¸ Flask CCCD endpoint also failed, using base64 fallback...');
        console.log('âŒ Flask Response status:', flaskResp.status);
        console.log('âŒ Flask Response text:', await flaskResp.text());
        
        // Final fallback: Convert file to base64
        const base64Data = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        
        console.log('âœ… File converted to base64, length:', base64Data.length);
        return base64Data;
        
      } catch (error) {
        console.error('âŒ Upload error:', error);
        throw error;
      }
    }

    // Upload images with fallback
    let frontUrl, backUrl;
    try {
      frontUrl = await uploadImage(fFile);
      console.log('âœ… Front image uploaded:', frontUrl);
    } catch (error) {
      console.error('âŒ Front image upload failed:', error);
      throw new Error(`Upload áº£nh máº·t trÆ°á»›c tháº¥t báº¡i: ${error.message}`);
    }

    try {
      backUrl = await uploadImage(bFile);
      console.log('âœ… Back image uploaded:', backUrl);
    } catch (error) {
      console.error('âŒ Back image upload failed:', error);
      throw new Error(`Upload áº£nh máº·t sau tháº¥t báº¡i: ${error.message}`);
    }

    const payload = {
      full_name: fullName,
      phone: phone,
      email: email,
      address: document.getElementById('ptAddress').value.trim(),
      desired_code: document.getElementById('ptDesiredCode')?.value.trim() || '',
      bank_name: bankName,
      bank_number: bankNumber,
      bank_holder: bankHolder,
      cccd_front_url: frontUrl,
      cccd_back_url: backUrl,
      sales_plan: document.getElementById('ptPlan').value.trim(),
      agreed: true
    };

        const resp = await fetch('/backend/api/ctv-applications/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      const msg = err.detail || JSON.stringify(err) || 'ÄÄƒng kÃ½ tháº¥t báº¡i';
      return alert(msg);
    }
    alert('ÄÃ£ gá»­i Ä‘Äƒng kÃ½! ChÃºng tÃ´i sáº½ liÃªn há»‡ sá»›m.');
    e.target.reset();
  } catch (err) {
    alert('CÃ³ lá»—i khi gá»­i Ä‘Äƒng kÃ½: ' + (err?.message || err));
  } finally {
    partnerSubmitting = false;
    if (submitBtn){
      submitBtn.disabled = false;
      submitBtn.innerHTML = btnOriginalHTML || 'Gá»­i Ä‘Äƒng kÃ½';
    }
  }
});

// ÄÆ¡n giáº£n hÃ³a: bá» kiá»ƒm tra mÃ£, Ä‘á»ƒ admin duyá»‡t vÃ  sinh mÃ£ náº¿u trÃ¹ng
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Đăng ký Cộng Tác Viên{% endblock %}

{% block extra_css %}
<style>
  .pt-hero{position:relative;background:linear-gradient(135deg,#7c63f2 0%,#4a4be7 60%,#3b2f92 100%);color:#fff;padding:2.5rem 0 2rem;overflow:hidden}
  .pt-pill{border-radius:999px;padding:.35rem .8rem;background: rgb(219, 234, 254);
    color: rgb(30, 64, 175);
    border: 2px solid rgb(59, 130, 246);}
  .pt-card{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
  .pt-muted{color:#6b7280}
  .pt-form .form-label{font-weight:500}
  .pt-form .form-control,.pt-form .form-select{border-radius:10px}
  .pt-benefit{display:flex;gap:.75rem;align-items:flex-start}
  .pt-benefit .ico{width:36px;height:36px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center}
  .fw-semibold{ color: #0b0061 !important; }
  .pt-section-title{display:flex;align-items:center;gap:.5rem;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px;padding:.5rem .75rem;margin:.25rem 0 .25rem}
  .pt-section-title .badge-req{color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;border-radius:6px;padding:.1rem .4rem;font-size:.7rem}
  .pt-divider{height:1px;background:linear-gradient(90deg,#cbd5e1,#e2e8f0);margin:.5rem 0}
</style>
{% endblock %}

{% block content %}
<div class="pt-hero">
  <div class="container">
    <div class="row g-4 align-items-start">
      <div class="col-lg-7">
        <div class="pt-card p-3" style="background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%); border: 2px solid #93c5fd !important;">
          <h1 class="h3 mb-2 text-dark">Đăng ký Cộng Tác Viên</h1>
          <div class="pt-muted mb-2">Nhận hoa hồng cao nhất trong ngành</div>
          <div class="d-flex gap-2 flex-wrap">
            <span class="pt-pill">Hoa hồng đến 22%</span>
            <span class="pt-pill">Thanh toán hàng tuần</span>
            <span class="pt-pill">Hỗ trợ tài liệu & media</span>
          </div>
        </div>
      </div>
      <div class="col-lg-5">
        <div class="pt-card p-3">
          <div class="pt-muted">Lợi ích nhanh</div>
          <div class="mt-2 d-grid gap-2">
            <div class="pt-benefit"><span class="ico bg-primary-subtle text-primary"><i class="fa-solid fa-bolt"></i></span><div><div class="fw-semibold">Bắt đầu nhanh</div><div class="pt-muted small">Duyệt hồ sơ trong 24h</div></div></div>
            <div class="pt-benefit"><span class="ico bg-success-subtle text-success"><i class="fa-solid fa-percent"></i></span><div><div class="fw-semibold">Chiết khấu tốt</div><div class="pt-muted small">Ưu đãi theo doanh số</div></div></div>
            <div class="pt-benefit"><span class="ico bg-info-subtle text-info"><i class="fa-solid fa-headset"></i></span><div><div class="fw-semibold">Hỗ trợ 24/7</div><div class="pt-muted small">Đội ngũ tư vấn đồng hành</div></div></div>
          </div>
          <div class="mt-3 pt-3 border-top">
            <div class="text-center">
              <p class="small pt-muted mb-2">Đã là cộng tác viên?</p>
              <a href="/ctv/login" class="btn btn-outline-primary btn-sm w-100">
                <i class="fas fa-sign-in-alt me-1"></i>Đăng nhập CTV
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container py-4">
  <div class="row g-4">
    <div class="col-lg-6">
      <div class="pt-card p-4">
        <div class="pt-section-title"><strong>Thông tin đăng ký</strong></div>
        <div class="pt-divider"></div>
        <form id="partnerForm" class="row g-3 pt-form" enctype="multipart/form-data">
          <div class="col-md-6">
            <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
            <input id="ptFullName" name="full_name" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Số điện thoại Zalo <span class="text-danger">*</span></label>
            <input id="ptPhone" name="phone" class="form-control"  inputmode="tel" pattern="^[0-9]{10,11}$" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Mã CTV mong muốn</label>
            <input id="ptDesiredCode" name="desired_code" class="form-control" placeholder="VD: NGUYENVANA" maxlength="20">
            <div class="form-text" style="font-size: 10px;" >Chỉ dùng chữ/số/_/-, tối đa 20 ký tự. Có thể để trống.</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Email <span class="text-danger">*</span></label>
            <input id="ptEmail" type="email" name="email" class="form-control"  required>
          </div>
          <div class="col-12">
            <label class="form-label">Địa chỉ</label>
            <input id="ptAddress" name="address" class="form-control" placeholder="Số nhà, đường, phường/xã, quận/huyện, tỉnh/thành">
          </div>

          <div class="col-12 mt-2">
            <div class="pt-divider"></div>
            <div class="pt-section-title"><strong>Thông tin ngân hàng nhận hoa hồng</strong> <span class="badge-req">Bắt buộc</span></div>
            
          </div>
          <div class="col-md-4">
            <label class="form-label">Tên ngân hàng <span class="text-danger">*</span></label>
            <input id="ptBankName" name="bank_name" class="form-control" placeholder="VD: Vietcombank" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Số tài khoản <span class="text-danger">*</span></label>
            <input id="ptBankNumber" name="bank_number" class="form-control" placeholder="VD: 0123456789" inputmode="numeric" pattern="^[0-9]{6,20}$" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Tên thẻ ngân hàng <span class="text-danger">*</span></label>
            <input id="ptBankHolder" name="bank_holder" class="form-control" placeholder="VD: NGUYEN VAN A" required>
          </div>
          <div class="col-12 mt-2">
            <div class="pt-divider"></div>
            <div class="pt-section-title"><strong>Xác minh CCCD</strong> <span class="badge-req">Bắt buộc</span></div>
            
          </div>
          <div class="col-md-6">
            <label class="form-label">Ảnh mặt trước CCCD <span class="text-danger">*</span></label>
            <input id="ptCccdFront" name="cccd_front" type="file" class="form-control" accept="image/*" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Ảnh mặt sau CCCD <span class="text-danger">*</span></label>
            <input id="ptCccdBack" name="cccd_back" type="file" class="form-control" accept="image/*" required>
          </div>

          <div class="col-12">
            <label class="form-label">Bạn làm gì để bán được hàng (có thể để trống)</label>
            <textarea id="ptPlan" name="sales_plan" class="form-control" rows="3" placeholder="VD: Livestream, chạy quảng cáo, KOC/KOL, cộng đồng Facebook, giới thiệu bạn bè, bán qua Zalo, Shopee, Lazada..."></textarea>
          </div>

          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="1" id="ptAgree" required>
              <label class="form-check-label" for="ptAgree">
                Tôi đồng ý với quy định và thoả thuận của BuddySkincare
              </label>
            </div>
          </div>

          <div class="col-12">
            <button class="btn btn-primary w-100" type="submit">Gửi đăng ký</button>
          </div>
        </form>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="pt-card p-4">
        <h2 class="h5 mb-3">Câu hỏi thường gặp</h2>
        <div class="mb-2"><strong>Điều kiện tham gia?</strong><div class="pt-muted">Chỉ cần đam mê làm đẹp và có kênh bán phù hợp.</div></div>
        <div class="mb-2"><strong>Thanh toán hoa hồng?</strong><div class="pt-muted">Chuyển khoản hằng tuần khi đủ ngưỡng.</div></div>
        <div class="mb-2"><strong>Đào tạo/hỗ trợ?</strong><div class="pt-muted">Tài liệu, nhóm cộng đồng và hỗ trợ trực tiếp.</div></div>
      </div>
      <div class="pt-card p-4 mt-3">
        <h2 class="h5 mb-3">Cấp bậc Cộng tác viên</h2>
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:140px">Cấp</th>
                <th style="width:160px">Hoa hồng</th>
                <th>Mô tả</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span class="pt-pill">Cấp 1</span></td>
                <td><strong>10%</strong></td>
                <td class="pt-muted">Hoa hồng trên doanh thu bán được (mặc định).</td>
              </tr>
              <tr>
                <td><span class="pt-pill">Cấp 2</span></td>
                <td><strong>12%</strong></td>
                <td class="pt-muted">Tăng theo ngưỡng doanh thu tháng.</td>
              </tr>
              <tr>
                <td><span class="pt-pill">Cấp 3</span></td>
                <td><strong>16%</strong></td>
                <td class="pt-muted">Ưu đãi tốt hơn cho CTV tích cực.</td>
              </tr>
              <tr>
                <td><span class="pt-pill">Cấp 4</span></td>
                <td><strong>20%</strong></td>
                <td class="pt-muted">Duy trì doanh số ổn định.</td>
              </tr>
              <tr>
                <td><span class="pt-pill">Cấp 5</span></td>
                <td><strong>22%</strong></td>
                <td class="pt-muted">Cấp cao nhất, thưởng hoa hồng tối đa.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let partnerSubmitting = false;
document.getElementById('partnerForm')?.addEventListener('submit', async function(e){
  e.preventDefault();
  if (partnerSubmitting) return;
  partnerSubmitting = true;
  const submitBtn = this.querySelector('button[type="submit"]');
  const btnOriginalHTML = submitBtn ? submitBtn.innerHTML : '';
  if (submitBtn){
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Đang gửi...';
  }
  const fullName = document.getElementById('ptFullName').value.trim();
  const phone = document.getElementById('ptPhone').value.trim();
  const email = document.getElementById('ptEmail').value.trim();
  const bankName = document.getElementById('ptBankName').value.trim();
  const bankNumber = document.getElementById('ptBankNumber').value.trim();
  const bankHolder = document.getElementById('ptBankHolder').value.trim();
  const front = document.getElementById('ptCccdFront').files?.length || 0;
  const back = document.getElementById('ptCccdBack').files?.length || 0;
  const agree = document.getElementById('ptAgree').checked;

  // Basic validations
  if (!fullName) return alert('Vui lòng nhập Họ và tên');
  if (!/^\d{10,11}$/.test(phone)) return alert('Số điện thoại phải 10-11 số');
  if (!email) return alert('Vui lòng nhập Email');
  if (!bankName || !bankNumber || !bankHolder) return alert('Vui lòng điền đầy đủ thông tin ngân hàng');
  if (!/^\d{6,20}$/.test(bankNumber)) return alert('Số tài khoản không hợp lệ');
  if (!front || !back) return alert('Vui lòng tải lên ảnh CCCD (mặt trước & mặt sau)');
  if (!agree) return alert('Vui lòng đồng ý với quy định và thoả thuận của BuddySkincare');

  try {
    const fFile = document.getElementById('ptCccdFront').files[0];
    const bFile = document.getElementById('ptCccdBack').files[0];

    // Upload to Cloudinary via server proxy to get short URL
    async function uploadImage(file){
      const fd = new FormData();
      fd.append('file', file);
        const resp = await fetch('https://buddyskincare.vn/backend/api/upload-bank-transfer', { method: 'POST', body: fd });
      if (!resp.ok) throw new Error('Upload ảnh thất bại');
      const data = await resp.json();
      if (!data.success || !data.url) throw new Error('Upload ảnh thất bại');
      return data.url;
    }

    const frontUrl = await uploadImage(fFile);
    const backUrl = await uploadImage(bFile);

    const payload = {
      full_name: fullName,
      phone: phone,
      email: email,
      address: document.getElementById('ptAddress').value.trim(),
      desired_code: document.getElementById('ptDesiredCode')?.value.trim() || '',
      bank_name: bankName,
      bank_number: bankNumber,
      bank_holder: bankHolder,
      cccd_front_url: frontUrl,
      cccd_back_url: backUrl,
      sales_plan: document.getElementById('ptPlan').value.trim(),
      agreed: true
    };

        const resp = await fetch('https://buddyskincare.vn/backend/api/ctv-applications/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      const msg = err.detail || JSON.stringify(err) || 'Đăng ký thất bại';
      return alert(msg);
    }
    alert('Đã gửi đăng ký! Chúng tôi sẽ liên hệ sớm.');
    e.target.reset();
  } catch (err) {
    alert('Có lỗi khi gửi đăng ký: ' + (err?.message || err));
  } finally {
    partnerSubmitting = false;
    if (submitBtn){
      submitBtn.disabled = false;
      submitBtn.innerHTML = btnOriginalHTML || 'Gửi đăng ký';
    }
  }
});

// Đơn giản hóa: bỏ kiểm tra mã, để admin duyệt và sinh mã nếu trùng
</script>
{% endblock %} 
{% extends "base.html" %}

{% block title %}D∆∞·ª°ng Da - BuddySkincare{% endblock %}

{% block extra_css %}
<style>
    body { background: #ffffff; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; color: #374151; }
    .skin-container { max-width: 100%; margin: 0 auto; padding: 0; }

    /* Hero */
    .hero { position: relative; padding: 2rem 0 1.5rem; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; overflow: hidden; width: 100%; }
    .hero-content { position: relative; z-index: 2; max-width: 860px; margin: 0 auto; padding: 0 2rem; }
    .hero h1 { font-size: 3rem; font-weight: 800; letter-spacing: -0.02em; margin-bottom: 1rem; text-shadow: 0 4px 8px rgba(0,0,0,0.25); }
    .hero p { font-size: 1.1rem; color: rgba(255,255,255,0.9); margin: 0 auto; max-width: 680px; }

    /* Layout */
    .content-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-top: 2rem; max-width: 1200px; margin-left: auto; margin-right: auto; padding: 0 1rem; }
    .section { padding: 3rem 0; border-bottom: 1px solid #f3f4f6; }
    .section:last-child { border-bottom: none; }
    .section-header { margin-bottom: 1.5rem; text-align: left; }
    .section-title { font-size: 1.5rem; font-weight: 800; color: #111827; margin: 0 0 .6rem; letter-spacing: -0.015em; }
    .section-subtitle { font-size: 0.95rem; color: #6b7280; margin: 0; }

    /* Routine steps */
    .steps { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; }
    .step { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1rem; transition: border-color .2s ease, box-shadow .2s ease; text-decoration: none; color: inherit; display: block; cursor: pointer; }
    .step:hover { border-color: #d1d5db; box-shadow: 0 8px 22px rgba(0,0,0,0.06); }
    .step h4 { font-size: 1.05rem; font-weight: 700; color: #111827; margin: 0 0 .4rem; }
    .step p { font-size: .92rem; color: #6b7280; margin: 0; line-height: 1.6; }
    .badge-num { width: 36px; height: 36px; border-radius: 50%; background: #6d28d9; color: #fff; display: grid; place-items: center; font-weight: 800; margin-bottom: .6rem; }

    /* Tips grid */
    .tips { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
    .tip { background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border: 1px solid #10b981; border-radius: 12px; padding: 1rem; }
    .tip h4 { margin: 0 0 .35rem; font-size: 1rem; color: #065f46; font-weight: 800; }
    .tip p { margin: 0; color: #047857; font-size: .92rem; }

    /* Product cards */
    .products { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
    
    /* Responsive design for mobile */
    @media (max-width: 768px) {
        .products { grid-template-columns: repeat(2, 1fr); gap: 1rem; }
    }
    
    @media (max-width: 480px) {
        .products { grid-template-columns: 1fr; gap: 1rem; }
    }
    .product { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .product:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
    .product img { width: 100%; height: 160px; object-fit: cover; display: block; }
    .product .p-content { padding: .8rem; }
    .product h5 { font-size: 1rem; font-weight: 700; margin: 0 0 .25rem; color: #111827; }
    .price { color: #dc2626; font-weight: 800; font-size: .98rem; }
    .old { text-decoration: line-through; color: #9ca3af; font-size: .85rem; margin-left: .35rem; }
    
    /* Product card enhancements */
    .product-card { transition: all 0.3s ease; }
    .product-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
    .add-to-cart-btn { transition: all 0.2s ease; }
    .add-to-cart-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .fav-toggle:hover { transform: scale(1.1); }

    /* Sidebar */
    .sidebar-section { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; }
    .sidebar-title { font-size: 1rem; font-weight: 800; color: #111827; margin-bottom: .6rem; }
    .list { list-style: none; margin: 0; padding: 0; }
    .list li { padding: .45rem 0; border-bottom: 1px solid #f3f4f6; }
    .list li:last-child { border-bottom: 0; }

    /* FAQ */
    .faq { border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; }
    .faq-item { border-bottom: 1px solid #f3f4f6; }
    .faq-item:last-child { border-bottom: 0; }
    .faq-q { position: relative; background: #fff; padding: .9rem 2rem .9rem 1rem; font-weight: 700; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .faq-q::after { content: "\f078"; font-family: "Font Awesome 5 Free"; font-weight: 900; color: #9ca3af; position: absolute; right: .75rem; transition: transform .2s ease; }
    .faq-item.active .faq-q::after { transform: rotate(180deg); }
    .faq-a { display: none; background: #fff; padding: 0 1rem 1rem; color: #6b7280; font-size: .95rem; }
    .faq-item.active .faq-a { display: block; }

    /* Modal content */
    .modal-product img { width: 100%; border-radius: 10px; height: 140px; object-fit: cover; }
    .news-mini { display: grid; grid-template-columns: 56px 1fr; gap: .5rem; padding: .5rem; border: 1px solid #f3f4f6; border-radius: 10px; margin-bottom: .5rem; text-decoration: none; color: inherit; }
    .news-mini:hover { background: #f9fafb; }
    .news-mini .thumb { width: 56px; height: 42px; border-radius: 8px; overflow: hidden; background: #f3f4f6; }
    .news-mini .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .news-mini .title { font-size: .92rem; font-weight: 700; margin: 0; color: #111827; line-height: 1.35; }
    .news-mini .meta { font-size: .8rem; color: #6b7280; }
</style>
{% endblock %}

{% block content %}
<div class="skin-container">
    <section class="hero">
        <div class="hero-content">
            <h1>D∆∞·ª°ng Da CƒÉn B·∫£n</h1>
            <p>Quy tr√¨nh d∆∞·ª°ng da t·ªëi gi·∫£n nh∆∞ng hi·ªáu qu·∫£ c√πng m·ªπ ph·∫©m thanh l√Ω BuddySkincare.</p>
        </div>
    </section>

    <div class="content-layout">
        <div class="main">
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Quy Tr√¨nh 6 B∆∞·ªõc S√°ng - T·ªëi</h2>
                    <p class="section-subtitle">B·∫•m v√†o t·ª´ng b∆∞·ªõc ƒë·ªÉ xem h∆∞·ªõng d·∫´n chi ti·∫øt v√† g·ª£i √Ω s·∫£n ph·∫©m</p>
                </div>
                <div class="steps">
                    <div class="step" data-step="1" role="button" tabindex="0">
                        <div class="badge-num">1</div>
                        <h4>L√†m s·∫°ch</h4>
                        <p>S√°ng: s·ªØa r·ª≠a m·∫∑t d·ªãu nh·∫π. T·ªëi: t·∫©y trang + r·ª≠a m·∫∑t ƒë·ªÉ lo·∫°i b·ªè b·ª•i b·∫©n.</p>
                    </div>
                    <div class="step" data-step="2" role="button" tabindex="0">
                        <div class="badge-num">2</div>
                        <h4>C√¢n b·∫±ng</h4>
                        <p>N∆∞·ªõc c√¢n b·∫±ng (toner) ph·ª•c h·ªìi pH, chu·∫©n b·ªã cho b∆∞·ªõc d∆∞·ª°ng sau.</p>
                    </div>
                    <div class="step" data-step="3" role="button" tabindex="0">
                        <div class="badge-num">3</div>
                        <h4>ƒêi·ªÅu tr·ªã</h4>
                        <p>Serum ƒë·∫∑c tr·ªã (AHA/BHA, Niacinamide, Hyaluronic...).</p>
                    </div>
                    <div class="step" data-step="4" role="button" tabindex="0">
                        <div class="badge-num">4</div>
                        <h4>Kh√≥a ·∫©m</h4>
                        <p>Kem d∆∞·ª°ng gi√∫p gi·∫£m m·∫•t n∆∞·ªõc qua bi·ªÉu b√¨.</p>
                    </div>
                    <div class="step" data-step="5" role="button" tabindex="0">
                        <div class="badge-num">5</div>
                        <h4>Ch·ªëng n·∫Øng</h4>
                        <p>SPF 30+ ph·ªï r·ªông; ƒë·ªß l∆∞·ª£ng v√† thoa l·∫°i sau 2-3 gi·ªù.</p>
                    </div>
                    <div class="step" data-step="6" role="button" tabindex="0">
                        <div class="badge-num">6</div>
                        <h4>ƒê·∫∑c bi·ªát</h4>
                        <p>Mask/peel d·ªãu nh·∫π 1‚Äì2 l·∫ßn/tu·∫ßn.</p>
                    </div>
                </div>
            </section>

            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">G·ª£i √ù S·∫£n Ph·∫©m Ph√π H·ª£p</h2>
                    <p class="section-subtitle">M·ªôt s·ªë s·∫£n ph·∫©m thanh l√Ω gi√° t·ªët ƒëang c√≥</p>
                </div>
                <div class="products" id="skincareProducts">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                        </div>
                        <p class="mt-2 text-muted">ƒêang t·∫£i s·∫£n ph·∫©m...</p>
                    </div>
                </div>
            </section>

            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">M·∫πo D∆∞·ª°ng Da Theo Lo·∫°i Da</h2>
                    <p class="section-subtitle">ƒêi·ªÅu ch·ªânh quy tr√¨nh theo nhu c·∫ßu</p>
                </div>
                <div class="tips">
                    <div class="tip">
                        <h4>Da d·∫ßu/H·ªón h·ª£p</h4>
                        <p>∆Øu ti√™n gel/foaming cleanser, toner kh√¥ng c·ªìn, serum Niacinamide, gel d∆∞·ª°ng m·ªèng.</p>
                    </div>
                    <div class="tip">
                        <h4>Da kh√¥</h4>
                        <p>Ch·ªçn s·ªØa r·ª≠a m·∫∑t d·ªãu nh·∫π, th√™m Hyaluronic/ceramide, kem d∆∞·ª°ng ƒë·∫∑c h∆°n, kh√≥a ·∫©m.</p>
                    </div>
                    <div class="tip">
                        <h4>Da nh·∫°y c·∫£m</h4>
                        <p>Tr√°nh h∆∞∆°ng li·ªáu/m√πi; test th·ª≠ v√πng nh·ªè tr∆∞·ªõc khi d√πng; ∆∞u ti√™n th√†nh ph·∫ßn ph·ª•c h·ªìi.</p>
                    </div>
                    <div class="tip">
                        <h4>Da n√°m/t·ªëi m√†u</h4>
                        <p>Th√™m Vitamin C/Arbutin/Tranexamic; ch·ªëng n·∫Øng nghi√™m ng·∫∑t m·ªói ng√†y.</p>
                    </div>
                </div>
            </section>

            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">C√¢u H·ªèi Th∆∞·ªùng G·∫∑p</h2>
                    <p class="section-subtitle">Nh·ªØng th·∫Øc m·∫Øc ph·ªï bi·∫øn v·ªÅ d∆∞·ª°ng da c∆° b·∫£n</p>
                </div>
                <div class="faq" id="faq">
                    <div class="faq-item">
                        <div class="faq-q">N√™n r·ª≠a m·∫∑t m·∫•y l·∫ßn m·ªói ng√†y? </div>
                        <div class="faq-a">Hai l·∫ßn s√°ng/t·ªëi l√† ƒë·ªß. Tr√°nh r·ª≠a qu√° nhi·ªÅu g√¢y kh√¥ k√≠ch ·ª©ng.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">C√≥ c·∫ßn toner kh√¥ng?</div>
                        <div class="faq-a">Toner h·ªó tr·ª£ c√¢n b·∫±ng pH v√† l√†m ·∫©m nh·∫π. Kh√¥ng b·∫Øt bu·ªôc nh∆∞ng h·ªØu √≠ch cho nhi·ªÅu lo·∫°i da.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">B√¥i ch·ªëng n·∫Øng bao nhi√™u l√† ƒë·ªß?</div>
                        <div class="faq-a">∆Ø·ªõc l∆∞·ª£ng 2 ng√≥n tay cho m·∫∑t v√† c·ªï, thoa l·∫°i sau 2-3 gi·ªù n·∫øu ·ªü ngo√†i tr·ªùi.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Da d·∫ßu c√≥ c·∫ßn d∆∞·ª°ng ·∫©m kh√¥ng?</div>
                        <div class="faq-a">C√≥. D√πng gel/kem m·ªèng, kh√¥ng g√¢y b√≠t t·∫Øc (non-comedogenic) ƒë·ªÉ c√¢n b·∫±ng d·∫ßu.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Niacinamide d√πng chung Vitamin C ƒë∆∞·ª£c kh√¥ng?</div>
                        <div class="faq-a">C√≥ th·ªÉ d√πng c√πng routine. N·∫øu da nh·∫°y c·∫£m, d√πng xen k·∫Ω s√°ng/t·ªëi ƒë·ªÉ da th√≠ch nghi.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">AHA/BHA n√™n d√πng m·∫•y l·∫ßn/tu·∫ßn?</div>
                        <div class="faq-a">B·∫Øt ƒë·∫ßu 1-2 l·∫ßn/tu·∫ßn, tƒÉng d·∫ßn theo ƒë√°p ·ª©ng. Tr√°nh l·∫°m d·ª•ng g√¢y k√≠ch ·ª©ng.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">C√≥ c·∫ßn t·∫©y trang khi kh√¥ng trang ƒëi·ªÉm?</div>
                        <div class="faq-a">N√™n t·∫©y trang bu·ªïi t·ªëi ƒë·ªÉ lo·∫°i b·ªè kem ch·ªëng n·∫Øng/b·ª•i b·∫©n/b√£ nh·ªùn.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Da m·ª•n c√≥ n√™n d√πng d·∫ßu d∆∞·ª°ng?</div>
                        <div class="faq-a">C√≥ th·ªÉ d√πng c√°c lo·∫°i oil nh·∫π (squalane) ·ªü l∆∞·ª£ng nh·ªè, sau serum v√† tr∆∞·ªõc kem kh√≥a ·∫©m.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Th·ª© t·ª± layer s·∫£n ph·∫©m th·∫ø n√†o?</div>
                        <div class="faq-a">L·ªèng ƒë·∫øn ƒë·∫∑c: r·ª≠a m·∫∑t ‚Üí toner ‚Üí serum ‚Üí kem d∆∞·ª°ng ‚Üí ch·ªëng n·∫Øng (ban ng√†y).</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Bao l√¢u th·∫•y hi·ªáu qu·∫£ serum?</div>
                        <div class="faq-a">Th∆∞·ªùng 2-8 tu·∫ßn t√πy ho·∫°t ch·∫•t/m·ª©c ƒë·ªô v·∫•n ƒë·ªÅ da v√† th√≥i quen sinh ho·∫°t.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Da ƒëang k√≠ch ·ª©ng n√™n l√†m g√¨?</div>
                        <div class="faq-a">D·ª´ng ho·∫°t ch·∫•t m·∫°nh, ∆∞u ti√™n ph·ª•c h·ªìi (panthenol, ceramide), ch·ªëng n·∫Øng k·ªπ v√† t·ªëi gi·∫£n routine.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">C√≥ c·∫ßn r·ª≠a m·∫∑t sau khi ƒë·∫Øp mask?</div>
                        <div class="faq-a">V·ªõi mask gi·∫•y: kh√¥ng c·∫ßn r·ª≠a, v·ªó nh·∫π cho th·∫•m. V·ªõi mask r·ª≠a: r·ª≠a s·∫°ch theo h∆∞·ªõng d·∫´n.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">D√πng retinol khi n√†o?</div>
                        <div class="faq-a">D√πng bu·ªïi t·ªëi, 1-3 l·∫ßn/tu·∫ßn l√∫c ƒë·∫ßu, tƒÉng d·∫ßn. Lu√¥n ch·ªëng n·∫Øng v√† d∆∞·ª°ng ·∫©m k·ªπ.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Vitamin C b·ªã oxy h√≥a c√≥ d√πng ti·∫øp ƒë∆∞·ª£c kh√¥ng?</div>
                        <div class="faq-a">Khi chuy·ªÉn v√†ng n√¢u ƒë·∫≠m, m√πi h·∫Øc, n√™n ng·ª´ng d√πng. B·∫£o qu·∫£n k√≠n, tr√°nh s√°ng/nhi·ªát.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">C√≥ n√™n r·ª≠a m·∫∑t b·∫±ng n∆∞·ªõc l·∫°nh bu·ªïi s√°ng?</div>
                        <div class="faq-a">N·∫øu da r·∫•t kh√¥/nh·∫°y c·∫£m c√≥ th·ªÉ ch·ªâ d√πng n∆∞·ªõc ·∫•m nh·∫π. ƒêa s·ªë v·∫´n n√™n d√πng s·ªØa r·ª≠a m·∫∑t d·ªãu nh·∫π.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Thoa kem m·∫Øt tr∆∞·ªõc hay sau serum?</div>
                        <div class="faq-a">Sau serum cho m·∫∑t, tr∆∞·ªõc kem d∆∞·ª°ng. D√πng l∆∞·ª£ng √≠t, v·ªó nh·∫π quanh h·ªëc m·∫Øt.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Ch·ªçn kem ch·ªëng n·∫Øng v·∫≠t l√Ω hay h√≥a h·ªçc?</div>
                        <div class="faq-a">Da nh·∫°y c·∫£m d·ªÖ h·ª£p v·∫≠t l√Ω; c·∫ßn m·ªèng nh·∫π v√¥ h√¨nh c√≥ th·ªÉ ch·ªçn h√≥a h·ªçc. Quan tr·ªçng l√† d√πng ƒë·ªß l∆∞·ª£ng.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">D√πng nhi·ªÅu s·∫£n ph·∫©m c√πng l√∫c c√≥ t·ªët h∆°n kh√¥ng?</div>
                        <div class="faq-a">Kh√¥ng. T·ªëi gi·∫£n v√† nh·∫•t qu√°n gi√∫p da ·ªïn ƒë·ªãnh h∆°n, gi·∫£m nguy c∆° k√≠ch ·ª©ng v√† ti·∫øt ki·ªám chi ph√≠.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Bao l√¢u n√™n thay s·ªØa r·ª≠a m·∫∑t/kem d∆∞·ª°ng?</div>
                        <div class="faq-a">Theo h·∫°n d√πng ghi tr√™n bao b√¨ (PAO). Th∆∞·ªùng 6-12 th√°ng sau khi m·ªü n·∫Øp t√πy s·∫£n ph·∫©m.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">D√πng s·∫£n ph·∫©m thanh l√Ω/pass tester c√≥ an to√†n?</div>
                        <div class="faq-a">Ch√∫ng t√¥i ki·ªÉm tra t√¨nh tr·∫°ng, h·∫°n d√πng v√† ni√™m phong k·ªπ. B·∫°n n√™n ƒë·ªçc m√¥ t·∫£ chi ti·∫øt v√† test th·ª≠ v√πng nh·ªè tr∆∞·ªõc khi d√πng.</div>
                    </div>
                </div>
            </section>
        </div>

        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Danh M·ª•c Li√™n Quan</div>
                <ul class="list">
                    <li><a href="/flash-sale">Flash Sale gi·ªù v√†ng</a></li>
                    <li><a href="/shopping-guide">H∆∞·ªõng d·∫´n mua h√†ng</a></li>
                    <li><a href="/online-payment-safety">Thanh to√°n an to√†n</a></li>
                    <li><a href="/support">H·ªó tr·ª£ & FAQ</a></li>
                </ul>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">L∆∞u √ù Nhanh</div>
                <ul class="list">
                    <li>Test th·ª≠ v√πng nh·ªè khi d√πng s·∫£n ph·∫©m m·ªõi</li>
                    <li>∆Øu ti√™n SPF h·∫±ng ng√†y</li>
                    <li>Kh√¥ng d√πng qu√° nhi·ªÅu ho·∫°t ch·∫•t c√πng l√∫c</li>
                </ul>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Tin T·ª©c M·ªõi</div>
                <div id="newsContainer">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                        </div>
                        <p class="mt-2 text-muted small">ƒêang t·∫£i tin t·ª©c...</p>
                    </div>
                </div>
            </div>
        </aside>
    </div>
</div>

<!-- Step Detail Modal -->
<div class="modal fade" id="stepModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="stepTitle">Chi ti·∫øt b∆∞·ªõc</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="stepDesc" class="mb-3 text-muted"></p>
        <div class="row g-3">
          <div class="col-md-6">
            <h6 class="fw-bold">C√°ch th·ª±c hi·ªán</h6>
            <ol id="stepHow" class="mb-0"></ol>
          </div>
          <div class="col-md-6">
            <h6 class="fw-bold">M·∫πo nh·ªè</h6>
            <ul id="stepTips" class="mb-0"></ul>
          </div>
        </div>
        <div id="stepProductsWrap" class="mt-3" style="display:none;">
          <h6 class="fw-bold mb-2">G·ª£i √Ω s·∫£n ph·∫©m</h6>
          <div id="stepProducts" class="row g-3"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// API Configuration
const API_BASE_URL = 'https://buddyskincare.pythonanywhere.com';

// Load skincare products from API
async function loadSkincareProducts() {
  try {
    console.log('üîç Loading skincare products from API...');
    const response = await fetch(`${API_BASE_URL}/products/`);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const products = await response.json();
    console.log(`‚úÖ Got ${products.length} products from API`);
    
    // Filter skincare products
    const skincareKeywords = [
      's·ªØa r·ª≠a m·∫∑t', 'sua rua mat', 'cleanser', 'wash', 'r·ª≠a m·∫∑t',
      't·∫©y trang', 'tay trang', 'makeup remover', 'bioderma',
      'kem ch·ªëng n·∫Øng', 'kem chong nang', 'sunscreen', 'spf',
      'serum', 'toner', 'n∆∞·ªõc c√¢n b·∫±ng', 'nuoc can bang',
      'kem d∆∞·ª°ng', 'kem duong', 'moisturizer', 'cream',
      'mask', 'm·∫∑t n·∫°', 'mat na', 'peel', 'exfoliant',
      'dung d·ªãch', 'dung dich', 'rong nho', 'peel',
      'm·∫∑t n·∫°', 'mat na', 'mask', 'ƒë·∫•t s√©t', 'dat set',
      'kem d∆∞·ª°ng', 'kem duong', 'd∆∞·ª°ng', 'duong',
      'tinh ch·∫•t', 'tinh chat', 'serum', 'essence',
      'retinol', 'vitamin c', 'vitamin a', 'niacinamide',
      'hyaluronic', 'collagen', 'peptide', 'ceramide',
      'd∆∞·ª°ng th·ªÉ', 'duong the', 'body', 'lotion',
      'cleansing', 'purifying', 'moisturizing', 'hydrating'
    ];
    
    const skincareProducts = products.filter(product => {
      const productName = (product.name || '').toLowerCase();
      const categoryName = (product.category_name || '').toLowerCase();
      return skincareKeywords.some(keyword => 
        productName.includes(keyword) || categoryName.includes(keyword)
      );
    });
    
    // Shuffle array randomly and take 9 products
    const shuffledProducts = [...skincareProducts].sort(() => Math.random() - 0.5);
    const topProducts = shuffledProducts.slice(0, 9);
    
    console.log(`üìä Found ${topProducts.length} skincare products`);
    renderSkincareProducts(topProducts);
    
  } catch (error) {
    console.error('‚ùå Error loading skincare products:', error);
    renderSkincareProductsError();
  }
}

// Render skincare products with shopping functionality
function renderSkincareProducts(products) {
  const container = document.getElementById('skincareProducts');
  
  if (!products || products.length === 0) {
    container.innerHTML = `
      <div class="text-center py-4">
        <p class="text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m d∆∞·ª°ng da n√†o</p>
      </div>
    `;
    return;
  }
  
  // Clear container and add products with shopping functionality
  container.innerHTML = '';
  
  products.forEach(product => {
    const productCard = createSkincareProductCard(product);
    container.appendChild(productCard);
  });
  
  // Initialize product cards after rendering
  initSkincareProductCards();
}

// Create product card with shopping functionality (similar to index)
function createSkincareProductCard(product) {
  const imageUrl = (product.image && String(product.image).trim()) || '/static/image/default-product.jpg';
  const brandName = product.brand_name || (product.brand ? product.brand.name : 'Kh√¥ng r√µ');
  
  const originalPrice = typeof product.original_price === 'number' ? product.original_price * 1000 : null;
  const discountedPrice = typeof product.discounted_price === 'number' ? product.discounted_price * 1000 : null;
  const rating = typeof product.rating === 'number' ? product.rating : (parseFloat(product.rating) || 0);
  const stockQuantity = typeof product.stock_quantity === 'number' ? product.stock_quantity : 0;
  
  const fullStars = Math.floor(rating);
  const hasHalfStar = rating % 1 >= 0.5 && rating % 1 < 1;
  
  let starsHTML = '';
  for (let i = 0; i < fullStars; i++) starsHTML += '<i class="fas fa-star"></i>';
  if (hasHalfStar) starsHTML += '<i class="fas fa-star-half-alt"></i>';
  for (let i = fullStars + (hasHalfStar ? 1 : 0); i < 5; i++) starsHTML += '<i class="far fa-star"></i>';
  
  const discountRate = (typeof product.discount_rate === 'number')
    ? Math.round(product.discount_rate)
    : ((originalPrice && discountedPrice) ? Math.round(((originalPrice - discountedPrice) / originalPrice) * 100) : 0);
  
  const isOutOfStock = stockQuantity <= 0;
  const productName = product.name;
  
  const cardDiv = document.createElement('div');
  cardDiv.className = 'product';
  cardDiv.innerHTML = `
    <div class="product-card card h-100 border-0 shadow-sm" style="transition: transform 0.2s ease, box-shadow 0.2s ease;">
      <div class="position-relative">
        <a href="/product/${product.id}" class="text-decoration-none">
          <img src="${imageUrl}" class="card-img-top" alt="${productName}" 
               style="height: 200px; object-fit: cover; ${isOutOfStock ? 'filter: grayscale(100%);' : ''}"
               onerror="this.src='/static/image/default-product.jpg'">
        </a>
        ${isOutOfStock ? `
        <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" 
             style="background-color: rgba(0,0,0,0.7); border-radius: 6px;">
          <div class="text-center text-white">
            <i class="fas fa-times-circle fa-2x mb-1"></i>
            <h6 class="fw-bold mb-0">H·∫æT H√ÄNG</h6>
          </div>
        </div>
        ` : ''}
        <button class="fav-toggle position-absolute top-0 end-0 m-2" 
                title="Th√™m v√†o y√™u th√≠ch" 
                data-id="${product.id}"
                data-name="${String(productName).replace(/\"/g,'\\\"')}"
                data-image="${imageUrl}"
                data-brand="${String(brandName).replace(/\"/g,'\\\"')}"
                data-price="${discountedPrice || 0}"
                style="border:none;background:transparent;cursor:pointer;">
          <i class="far fa-heart" style="font-size: 18px; color:#fff; text-shadow: 0 1px 3px rgba(0,0,0,0.5);"></i>
        </button>
        <div class="position-absolute bottom-0 start-0 m-1">
          <img src="/static/image/logo.png" alt="Logo" class="product-logo" 
               style="width: 28px; height: 28px; object-fit: contain; border-radius: 50%; background: white; padding: 2px; display: block; z-index: 10; box-shadow: 0 1px 3px rgba(0,0,0,0.2);" 
               onerror="this.style.display='none';">
        </div>
        <div class="product-badges-row position-absolute" style="top:8px;left:10px;display:flex;gap:6px;align-items:center;z-index:2;">
          ${discountRate > 0 ? `<div class="badge bg-danger discount-badge-left" style="font-size: 11px; padding: 4px 8px;">-${discountRate}%</div>` : ''}
        </div>
      </div>
      <div class="card-body d-flex flex-column">
        <h6 class="card-title fw-bold" style="font-size: 14px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 36px;">
          <a href="/product/${product.id}" class="text-decoration-none text-dark">${productName}</a>
        </h6>
        <div class="d-flex justify-content-between align-items-center mb-2" style="font-size: 11px;">
          <span class="text-muted">${brandName}</span>
          <span class="badge ${getStatusBadgeClass(product.status)}" style="font-size: 8px; padding: 2px 4px;">${getStatusText(product.status)}</span>
        </div>
        <div class="d-flex align-items-center mb-1">
          ${originalPrice ? `<span class="text-decoration-line-through text-muted me-1" style="font-size: 12px;">${formatPrice(originalPrice)}</span>` : ''}
          <span class="text-danger fw-bold" style="font-size: 16px;">${formatPrice(discountedPrice)}</span>
        </div>
        <div class="d-flex align-items-center mb-3">
          <div class="stars text-warning me-2" style="font-size: 12px;">
            ${starsHTML}
          </div>
          <small class="text-muted" style="font-size: 11px;">(${rating})</small>
          <span class="badge ${isOutOfStock ? 'bg-danger' : 'bg-success'}" style="font-size: 10px; padding: 4px 8px; margin-left: 10px;">${isOutOfStock ? 'H·∫øt h√†ng' : `C√≤n ${stockQuantity}`}</span>
        </div>
        <button class="btn w-100 add-to-cart-btn ${isOutOfStock ? 'btn-secondary' : 'btn-primary'}" 
                data-product-id="${product.id}" 
                style="font-size: 13px; padding: 8px;" 
                ${isOutOfStock ? 'disabled' : ''}>
          ${isOutOfStock ? 'H·∫øt h√†ng' : 'Th√™m v√†o gi·ªè'}
        </button>
      </div>
    </div>
  `;
  
  return cardDiv;
}

// Initialize product cards functionality
function initSkincareProductCards() {
  // Add to cart functionality
  document.querySelectorAll('#skincareProducts .add-to-cart-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const productId = this.getAttribute('data-product-id');
      if (productId) {
        addToCartFromSkincare(productId);
      }
    });
  });
  
  // Favorite toggle functionality
  document.querySelectorAll('#skincareProducts .fav-toggle').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      toggleFavorite(this);
    });
  });
  
  // Restore favorite states from localStorage
  restoreFavoriteStates();
}

// Restore favorite states - using main.js system
function restoreFavoriteStates() {
  document.querySelectorAll('#skincareProducts .fav-toggle').forEach(btn => {
    const productId = btn.getAttribute('data-id');
    const heartIcon = btn.querySelector('i');
    
    // Use main.js getWishlist function if available
    if (typeof getWishlist === 'function') {
      const wishlist = getWishlist();
      // Check if wishlist is a Map or Set
      const isFavorite = wishlist && (wishlist.has ? wishlist.has(productId) : wishlist.hasOwnProperty(productId));
      
      if (isFavorite) {
        heartIcon.classList.remove('far');
        heartIcon.classList.add('fas');
        heartIcon.style.color = '#dc3545';
      } else {
        heartIcon.classList.remove('fas');
        heartIcon.classList.add('far');
        heartIcon.style.color = '#fff';
      }
    } else {
      // Fallback to localStorage
      const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      const isFavorite = favorites.some(fav => fav.id === productId);
      
      if (isFavorite) {
        heartIcon.classList.remove('far');
        heartIcon.classList.add('fas');
        heartIcon.style.color = '#dc3545';
      } else {
        heartIcon.classList.remove('fas');
        heartIcon.classList.add('far');
        heartIcon.style.color = '#fff';
      }
    }
  });
}

// Add to cart function for skincare page - using main.js system
async function addToCartFromSkincare(productId) {
  try {
    // Get product details first
    const productResponse = await fetch(`https://buddyskincare.pythonanywhere.com/products/${productId}/`);
    if (!productResponse.ok) {
      showCartNotification('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s·∫£n ph·∫©m', 'error');
      return;
    }
    
    const product = await productResponse.json();
    
    // Use the main.js addProductToCart function if available
    if (typeof addProductToCart === 'function') {
      // Ensure prices are numbers and multiply by 1000 to match display format
      const discountedPrice = typeof product.discounted_price === 'number' 
        ? product.discounted_price * 1000
        : (typeof product.discounted_price === 'string' ? (parseFloat(product.discounted_price) || 0) * 1000 : 0);
      
      const originalPrice = typeof product.original_price === 'number' 
        ? product.original_price * 1000
        : (typeof product.original_price === 'string' ? (parseFloat(product.original_price) || 0) * 1000 : 0);
      
      // Find the product image element for fly animation
      const productImage = document.querySelector(`[data-product-id="${productId}"]`)?.closest('.product')?.querySelector('img');
      
      // Add fly to cart animation if available
      if (typeof flyToCart === 'function' && productImage) {
        flyToCart(productImage, async () => {
          // Add to cart after animation
          await addProductToCart(
            productId,
            product.name || 'S·∫£n ph·∫©m',
            discountedPrice,
            product.image || '/static/image/default-product.jpg',
            originalPrice,
            1
          );
        });
      } else {
        // Add to cart without animation
        await addProductToCart(
          productId,
          product.name || 'S·∫£n ph·∫©m',
          discountedPrice,
          product.image || '/static/image/default-product.jpg',
          originalPrice,
          1
        );
      }
    } else {
      // Fallback to direct API call with animation
      const productImage = document.querySelector(`[data-product-id="${productId}"]`)?.closest('.product')?.querySelector('img');
      
      // Add fly to cart animation if available
      if (typeof flyToCart === 'function' && productImage) {
        flyToCart(productImage, async () => {
          // Add to cart after animation
          const response = await fetch('/api/add-to-cart', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              product_id: parseInt(productId),
              quantity: 1
            })
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              showCartNotification(`ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng! (${result.cart_count} s·∫£n ph·∫©m)`, 'success');
              updateCartCountInHeader(result.cart_count);
            } else {
              showCartNotification(result.message || 'C√≥ l·ªói x·∫£y ra', 'error');
            }
          } else {
            showCartNotification('C√≥ l·ªói x·∫£y ra khi th√™m v√†o gi·ªè h√†ng', 'error');
          }
        });
      } else {
        // Add to cart without animation
        const response = await fetch('/api/add-to-cart', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            product_id: parseInt(productId),
            quantity: 1
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            showCartNotification(`ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng! (${result.cart_count} s·∫£n ph·∫©m)`, 'success');
            updateCartCountInHeader(result.cart_count);
          } else {
            showCartNotification(result.message || 'C√≥ l·ªói x·∫£y ra', 'error');
          }
        } else {
          showCartNotification('C√≥ l·ªói x·∫£y ra khi th√™m v√†o gi·ªè h√†ng', 'error');
        }
      }
    }
  } catch (error) {
    console.error('Error adding to cart:', error);
    showCartNotification('C√≥ l·ªói x·∫£y ra', 'error');
  }
}

// Update cart count in header
function updateCartCountInHeader(count) {
  // Try to find cart count elements in header
  const cartCountElements = document.querySelectorAll('.cart-count, .cart-badge, [data-cart-count]');
  cartCountElements.forEach(element => {
    element.textContent = count;
    element.style.display = count > 0 ? 'inline' : 'none';
  });
  
  // Also try to update cart icon
  const cartIcons = document.querySelectorAll('.fa-shopping-cart, .cart-icon');
  cartIcons.forEach(icon => {
    const badge = icon.parentElement.querySelector('.badge');
    if (badge) {
      badge.textContent = count;
      badge.style.display = count > 0 ? 'inline' : 'none';
    }
  });
}

// Show cart notification
function showCartNotification(message, type = 'success') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
  notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  notification.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
      <span>${message}</span>
      <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // Auto remove after 3 seconds
  setTimeout(() => {
    if (notification.parentElement) {
      notification.remove();
    }
  }, 3000);
}

// Toggle favorite function - using main.js system
function toggleFavorite(btn) {
  const productId = btn.getAttribute('data-id');
  const productName = btn.getAttribute('data-name');
  const productImage = btn.getAttribute('data-image');
  const productBrand = btn.getAttribute('data-brand');
  const productPrice = btn.getAttribute('data-price');
  const heartIcon = btn.querySelector('i');
  
  // Use main.js toggleWishlist function if available
  if (typeof toggleWishlist === 'function') {
    const item = {
      id: productId,
      name: productName,
      image: productImage,
      brand: productBrand,
      price: productPrice
    };
    
    toggleWishlist(item);
    
    // Update visual state
    const wishlist = getWishlist();
    const isFavorite = wishlist && (wishlist.has ? wishlist.has(productId) : wishlist.hasOwnProperty(productId));
    if (isFavorite) {
      heartIcon.classList.remove('far');
      heartIcon.classList.add('fas');
      heartIcon.style.color = '#dc3545';
    } else {
      heartIcon.classList.remove('fas');
      heartIcon.classList.add('far');
      heartIcon.style.color = '#fff';
    }
  } else {
    // Fallback to localStorage system
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    
    if (heartIcon.classList.contains('far')) {
      // Add to favorites
      heartIcon.classList.remove('far');
      heartIcon.classList.add('fas');
      heartIcon.style.color = '#dc3545';
      
      const product = {
        id: productId,
        name: productName,
        image: productImage,
        brand: productBrand,
        price: productPrice
      };
      
      const existingIndex = favorites.findIndex(fav => fav.id === productId);
      if (existingIndex === -1) {
        favorites.push(product);
        localStorage.setItem('favorites', JSON.stringify(favorites));
        showCartNotification('ƒê√£ th√™m v√†o y√™u th√≠ch!', 'success');
      } else {
        showCartNotification('S·∫£n ph·∫©m ƒë√£ c√≥ trong y√™u th√≠ch!', 'info');
      }
    } else {
      // Remove from favorites
      heartIcon.classList.remove('fas');
      heartIcon.classList.add('far');
      heartIcon.style.color = '#fff';
      
      favorites = favorites.filter(fav => fav.id !== productId);
      localStorage.setItem('favorites', JSON.stringify(favorites));
      showCartNotification('ƒê√£ x√≥a kh·ªèi y√™u th√≠ch!', 'info');
    }
  }
}

// Render error state for products
function renderSkincareProductsError() {
  const container = document.getElementById('skincareProducts');
  container.innerHTML = `
    <div class="text-center py-4">
      <p class="text-muted">Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
    </div>
  `;
}

// Load news from API
async function loadNews() {
  try {
    console.log('üîç Loading news from API...');
    const response = await fetch(`${API_BASE_URL}/blog/`);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log(`‚úÖ Got blog data from API:`, data);
    
    // Handle paginated response
    const blogs = data.results || data; // Support both paginated and direct array
    console.log(`üìä Total blogs: ${data.count || blogs.length}, Current page: ${data.current_page || 1}`);
    
    // Filter active blogs and sort by date, take top 3
    const newsItems = blogs
      .filter(blog => blog && typeof blog === 'object' && blog.is_active !== false)
      .sort((a, b) => new Date(b.post_date || 0) - new Date(a.post_date || 0))
      .slice(0, 3);
    
    console.log(`üì∞ Found ${newsItems.length} active news items`);
    renderNews(newsItems);
    
  } catch (error) {
    console.error('‚ùå Error loading news:', error);
    renderNewsError();
  }
}

// Render news
function renderNews(newsItems) {
  const container = document.getElementById('newsContainer');
  
  if (!newsItems || newsItems.length === 0) {
    container.innerHTML = `
      <div class="text-center py-3">
        <p class="text-muted small">Kh√¥ng c√≥ tin t·ª©c n√†o</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = newsItems.map(news => `
    <a class="news-mini" href="/news">
      <div class="thumb">
        <img src="${news.img_thumbnail || '/static/image/demo/placeholder.jpg'}" 
             alt="${news.title || 'Tin t·ª©c'}"
             onerror="this.src='/static/image/demo/placeholder.jpg'">
      </div>
      <div>
        <div class="title">${news.title || 'Tin t·ª©c'}</div>
        <div class="meta">${formatDate(news.post_date)} ¬∑ ${news.views || 0} l∆∞·ª£t xem</div>
      </div>
    </a>
  `).join('');
}

// Render error state for news
function renderNewsError() {
  const container = document.getElementById('newsContainer');
  container.innerHTML = `
    <div class="text-center py-3">
      <p class="text-muted small">Kh√¥ng th·ªÉ t·∫£i tin t·ª©c. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
    </div>
  `;
}

// Helper functions
function formatPrice(price) {
  if (!price) return '0‚Ç´';
  return new Intl.NumberFormat('vi-VN').format(price) + '‚Ç´';
}

function formatDate(dateString) {
  if (!dateString) return 'Kh√¥ng r√µ ng√†y';
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('vi-VN', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
  } catch (error) {
    return 'Kh√¥ng r√µ ng√†y';
  }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ Initializing skincare page...');
  loadSkincareProducts();
  loadNews();
  loadCartCount();
});

// Load cart count - using main.js system
async function loadCartCount() {
  // Use main.js updateCartCount function if available
  if (typeof updateCartCount === 'function') {
    updateCartCount();
  } else {
    // Fallback to direct API call
    try {
      const response = await fetch('/api/cart');
      if (response.ok) {
        const result = await response.json();
        if (result.success) {
          updateCartCountInHeader(result.total_items);
          console.log('Cart loaded:', result.cart);
        }
      }
    } catch (error) {
      console.error('Error loading cart:', error);
    }
  }
}

// Helper functions for product status - moved outside IIFE for global access
function getStatusText(status) {
  const statusMap = {
    'new': 'M·ªõi',
    '30': 'c√≤n 30%',
    '80': 'c√≤n 80%',
    '75': 'c√≤n 75%',
    '70': 'c√≤n 70%',
    '60': 'c√≤n 60%',
    '50': 'c√≤n 50%',
    '90': 'c√≤n 90%',
    '85': 'c√≤n 85%',
    '95': 'c√≤n 95%',
    'test': 'Test 1-2 l·∫ßn',
    'newmh': 'M·ªõi m·∫•t h·ªôp',
    'newm': 'M·ªõi h·ªôp b·ªã m√≥p',
    'newrt': 'M·ªõi r√°ch tem',
    'newmn': 'M·ªõi m√≥p nh·∫π',
    'newx': 'M·ªõi b·ªã x∆∞·ªõc',
    'newspx': 'M·ªõi b·ªã x∆∞·ªõc',
    'chiet': 'Chi·∫øt'
  };
  return statusMap[status] || status || 'M·ªõi';
}

function getStatusBadgeClass(status) {
  const classMap = {
    'new': 'bg-success',
    '30': 'bg-danger',
    '80': 'bg-warning text-dark',
    '75': 'bg-warning text-dark',
    '70': 'bg-warning text-dark',
    '60': 'bg-warning text-dark',
    '50': 'bg-warning text-dark',
    '90': 'bg-info text-white',
    '85': 'bg-info text-white',
    '95': 'bg-info text-white',
    'test': 'bg-secondary',
    'newmh': 'bg-primary',
    'newm': 'bg-primary',
    'newrt': 'bg-primary',
    'newmn': 'bg-primary',
    'newx': 'bg-primary',
    'newspx': 'bg-primary',
    'chiet': 'bg-dark'
  };
  return classMap[status] || 'bg-success';
}

(function(){
  const stepsData = {
    1: {title:'B∆∞·ªõc 1: L√†m s·∫°ch',desc:'Lo·∫°i b·ªè b·ª•i b·∫©n, d·∫ßu th·ª´a v√† l·ªõp trang ƒëi·ªÉm ƒë·ªÉ da th√¥ng tho√°ng.',how:['Bu·ªïi t·ªëi: t·∫©y trang (d·∫ßu/n∆∞·ªõc micellar) tr∆∞·ªõc khi r·ª≠a m·∫∑t','L√†m ∆∞·ªõt m·∫∑t v·ªõi n∆∞·ªõc ·∫•m ƒë·ªÉ m·ªü nh·∫π l·ªó ch√¢n l√¥ng','L·∫•y 1‚Äì2 h·∫°t ƒë·∫≠u s·ªØa r·ª≠a m·∫∑t, t·∫°o b·ªçt trong l√≤ng b√†n tay','Massage v√≤ng tr√≤n 30‚Äì60 gi√¢y, t·∫≠p trung v√πng ch·ªØ T','R·ª≠a s·∫°ch v√† th·∫•m kh√¥ b·∫±ng khƒÉn m·ªÅm'],tips:['Ch·ªçn pH ~5.5, c√¥ng th·ª©c d·ªãu nh·∫π cho m·ªçi lo·∫°i da','S√°ng r·ª≠a nh·∫π, t·ªëi l√†m s·∫°ch k√©p n·∫øu d√πng ch·ªëng n·∫Øng/trang ƒëi·ªÉm'],products:[{name:'S·ªØa r·ª≠a m·∫∑t d·ªãu nh·∫π',price:'128.000‚Ç´',old:'320.000‚Ç´',img:'image/demo/facebook-dynamic-sua-rua-mat-cetaphil-diu-nhe-khong-xa-phong-500ml-moi-1741235596_img_300x300_b798dd_fit_center.jpg'},{name:'N∆∞·ªõc t·∫©y trang Bioderma',price:'98.000‚Ç´',old:'280.000‚Ç´',img:'image/demo/facebook-dynamic-nuoc-tay-trang-bioderma-danh-cho-da-dau-hon-hop-500ml-1745303871_img_300x300_b798dd_fit_center.jpg'}]},
    2: {title:'B∆∞·ªõc 2: C√¢n b·∫±ng',desc:'Ph·ª•c h·ªìi pH, c·∫•p ·∫©m nh·∫π v√† h·ªó tr·ª£ h·∫•p th·ª• cho b∆∞·ªõc sau.',how:['Sau khi r·ª≠a m·∫∑t, th·∫•m ∆∞·ªõt b√¥ng v·ªõi toner','Lau nh·∫π theo chi·ªÅu c·∫•u tr√∫c da ho·∫∑c v·ªó tr·ª±c ti·∫øp b·∫±ng tay s·∫°ch','Ch·ªù 30‚Äì60 gi√¢y tr∆∞·ªõc b∆∞·ªõc ti·∫øp theo'],tips:['Da nh·∫°y c·∫£m: ∆∞u ti√™n toner kh√¥ng c·ªìn, c√≥ panthenol/HA','C√≥ th·ªÉ layer 2‚Äì3 l·∫ßn ƒë·ªÉ tƒÉng ·∫©m khi th·ªùi ti·∫øt kh√¥ hanh'],products:[{name:'Toner c√¢n b·∫±ng d·ªãu nh·∫π',price:'120.000‚Ç´',old:'210.000‚Ç´',img:'image/demo/6fde01da-d545-435d-ab71-50ed3184afe0.webp'}]},
    3: {title:'B∆∞·ªõc 3: Serum ƒëi·ªÅu tr·ªã',desc:'T·∫≠p trung gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ: m·ª•n, th√¢m n√°m, thi·∫øu ·∫©m, l√£o h√≥a...',how:['D√πng 2‚Äì3 gi·ªçt serum tr√™n m·∫∑t v√† c·ªï','V·ªó/·∫•n nh·∫π cho th·∫•m, tr√°nh ch√† x√°t','ƒê·ª£i 1‚Äì2 ph√∫t tr∆∞·ªõc khi kh√≥a ·∫©m'],tips:['Kh√¥ng tr·ªôn nhi·ªÅu ho·∫°t ch·∫•t m·∫°nh (retinol, AHA/BHA, vitC) c√πng m·ªôt l√∫c','Da nh·∫°y c·∫£m: b·∫Øt ƒë·∫ßu c√°ch ng√†y, tƒÉng d·∫ßn t·∫ßn su·∫•t'],products:[{name:'Serum Niacinamide 10%',price:'159.000‚Ç´',old:'280.000‚Ç´',img:'image/demo/47e547c3-bc87-4c3a-a0da-eeddf358e0f5.webp'}]},
    4: {title:'B∆∞·ªõc 4: Kh√≥a ·∫©m',desc:'Gi·ªØ ·∫©m cho da, gi·∫£m m·∫•t n∆∞·ªõc qua bi·ªÉu b√¨ v√† ph·ª•c h·ªìi h√†ng r√†o.',how:['L·∫•y l∆∞·ª£ng kem b·∫±ng h·∫°t ƒë·∫≠u, ch·∫•m 5 ƒëi·ªÉm v√† t√°n ƒë·ªÅu','Massage h∆∞·ªõng l√™n tr√™n v√† ra ngo√†i','V√πng kh√¥ c√≥ th·ªÉ ch·∫•m th√™m m·ªôt l·ªõp m·ªèng'],tips:['Da d·∫ßu: ch·ªçn gel/cream nh·∫π, non‚Äëcomedogenic','Da kh√¥: ∆∞u ti√™n ceramide, squalane, shea butter'],products:[{name:'Kem d∆∞·ª°ng ph·ª•c h·ªìi',price:'165.000‚Ç´',old:'300.000‚Ç´',img:'image/demo/1200x429px_f18b4a4fee8d439b95d810bbd94b3493.jpg'}]},
    5: {title:'B∆∞·ªõc 5: Ch·ªëng n·∫Øng',desc:'B·∫£o v·ªá da tr∆∞·ªõc UVA/UVB, ngƒÉn n√°m s·∫°m v√† l√£o h√≥a s·ªõm.',how:['D√πng l∆∞·ª£ng ~2 ng√≥n tay cho m·∫∑t/c·ªï','Thoa sau d∆∞·ª°ng ·∫©m 15‚Äì20 ph√∫t tr∆∞·ªõc khi ra ngo√†i','Thoa l·∫°i sau 2‚Äì3 gi·ªù ho·∫∑c sau khi ƒë·ªï m·ªì h√¥i/n∆∞·ªõc'],tips:['Ch·ªçn SPF 30+ ph·ªï r·ªông, PA+++','Trong nh√† v·∫´n n√™n d√πng n·∫øu c√≥ √°nh s√°ng xanh/√°nh n·∫Øng'],products:[{name:"Kem ch·ªëng n·∫Øng L'Oreal",price:'157.500‚Ç´',old:'350.000‚Ç´',img:'image/demo/facebook-dynamic-kem-chong-nang-l-oreal-paris-x20-thoang-da-mong-nhe-50ml-1738898716_img_300x300_b798dd_fit_center.jpg'}]},
    6: {title:'B∆∞·ªõc 6: Mask/Peel',desc:'TƒÉng c∆∞·ªùng: c·∫•p ·∫©m s√¢u, s√°ng da, l√†m m·ªãn b·ªÅ m·∫∑t (1‚Äì2 l·∫ßn/tu·∫ßn).',how:['Sau l√†m s·∫°ch, ƒë·∫Øp mask 10‚Äì20 ph√∫t r·ªìi g·ª° nh·∫π','V·ªõi peel d·ªãu nh·∫π: thoa m·ªèng, ch·ªù 5‚Äì10 ph√∫t v√† r·ª≠a s·∫°ch','Lu√¥n kh√≥a ·∫©m sau mask/peel'],tips:['Tr√°nh d√πng chung ng√†y v·ªõi retinol/AHA m·∫°nh n·∫øu da nh·∫°y c·∫£m','Theo d√µi ph·∫£n ·ª©ng da, gi·∫£m t·∫ßn su·∫•t n·∫øu k√≠ch ·ª©ng'],products:[{name:'M·∫∑t n·∫° c·∫•p ·∫©m',price:'45.000‚Ç´',old:'79.000‚Ç´',img:'image/tintuc/cach-chon-kem-chong-nang-phu-hop-nhat-cho-tung-loai-da-201910150810078833.jpg'}]}
  };

  const modalEl = document.getElementById('stepModal');
  let bsModal = null;
  function ensureModal(){
    try{
      if (window.bootstrap && bootstrap.Modal){ if (!bsModal) bsModal = new bootstrap.Modal(modalEl); return 'bootstrap'; }
    }catch(err){ console.error('Bootstrap check error:', err); }
    return 'fallback';
  }

  const stepTitle = document.getElementById('stepTitle');
  const stepDesc = document.getElementById('stepDesc');
  const stepHow = document.getElementById('stepHow');
  const stepTips = document.getElementById('stepTips');
  const stepProducts = document.getElementById('stepProducts');
  const stepProductsWrap = document.getElementById('stepProductsWrap');

  function renderList(el, items){ el.innerHTML=''; (items||[]).forEach(t=>{ const li=document.createElement('li'); li.textContent=t; el.appendChild(li); }); }

  function imgPath(src){
    if(!src) return '';
    if(src.startsWith('http')) return src;
    if(src.startsWith('/')) return src;
    // ensure /static prefix
    return '/static/' + src.replace(/^static\//,'');
  }

  // Keywords for each step to filter products
  const stepKeywords = {
    1: ['s·ªØa r·ª≠a m·∫∑t', 't·∫©y trang', 'cleanser', 'micellar', 'foam', 'gel'],
    2: ['toner', 'c√¢n b·∫±ng', 'n∆∞·ªõc hoa h·ªìng', 'essence', 'lotion'],
    3: ['serum', 'tinh ch·∫•t', 'niacinamide', 'vitamin c', 'retinol', 'hyaluronic'],
    4: ['kem d∆∞·ª°ng', 'moisturizer', 'cream', 'lotion', 'd∆∞·ª°ng ·∫©m', 'ph·ª•c h·ªìi'],
    5: ['ch·ªëng n·∫Øng', 'sunscreen', 'spf', 'uv', 'sunblock'],
    6: ['m·∫∑t n·∫°', 'mask', 'peel', 'exfoliant', 'scrub', 'c·∫•p ·∫©m']
  };


  async function loadStepProducts(step) {
    try {
      const keywords = stepKeywords[step] || [];
      if (keywords.length === 0) return [];

      const response = await fetch('https://buddyskincare.pythonanywhere.com/products/');
      if (!response.ok) return [];

      const data = await response.json();
      const products = data.results || data;

      // Enhanced filtering with priority scoring
      const scoredProducts = products.map(product => {
        const name = (product.name || '').toLowerCase();
        const category = (product.category_name || '').toLowerCase();
        const brand = (product.brand_name || '').toLowerCase();
        const description = (product.description || '').toLowerCase();
        
        let score = 0;
        let matchedKeywords = [];
        
        // Check each keyword and assign scores
        keywords.forEach(keyword => {
          const keywordLower = keyword.toLowerCase();
          
          // Exact match in name gets highest score
          if (name.includes(keywordLower)) {
            score += 10;
            matchedKeywords.push(keyword);
          }
          
          // Match in category gets medium score
          if (category.includes(keywordLower)) {
            score += 7;
            matchedKeywords.push(keyword);
          }
          
          // Match in brand gets lower score
          if (brand.includes(keywordLower)) {
            score += 5;
            matchedKeywords.push(keyword);
          }
          
          // Match in description gets lowest score
          if (description.includes(keywordLower)) {
            score += 3;
            matchedKeywords.push(keyword);
          }
        });
        
        return {
          ...product,
          matchScore: score,
          matchedKeywords: [...new Set(matchedKeywords)] // Remove duplicates
        };
      });

      // Filter products with at least one match
      const filteredProducts = scoredProducts.filter(product => product.matchScore > 0);
      
      if (filteredProducts.length === 0) return [];

      // Sort by score first, then by rating, then randomize within same score groups
      const sortedProducts = filteredProducts.sort((a, b) => {
        if (b.matchScore !== a.matchScore) {
          return b.matchScore - a.matchScore; // Higher score first
        }
        if ((b.rating || 0) !== (a.rating || 0)) {
          return (b.rating || 0) - (a.rating || 0); // Higher rating first
        }
        return Math.random() - 0.5; // Random for same score and rating
      });

      // Take top 4 products and add some randomization
      const topProducts = sortedProducts.slice(0, 8); // Get more candidates
      const shuffled = [...topProducts].sort(() => Math.random() - 0.5);
      
      return shuffled.slice(0, 4); // Return 4 random products from top matches
    } catch (error) {
      console.error('Error loading step products:', error);
      return [];
    }
  }

  async function openStep(step){
    try{
      const data = stepsData[step]; if(!data) return;
      stepTitle.textContent = data.title||'Chi ti·∫øt b∆∞·ªõc';
      stepDesc.textContent = data.desc||'';
      renderList(stepHow, data.how);
      renderList(stepTips, data.tips);

      // Show loading state
      stepProducts.innerHTML = '<div class="col-12 text-center"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div><p class="small text-muted mt-2">ƒêang t·∫£i s·∫£n ph·∫©m...</p></div>';
      stepProductsWrap.style.display = '';

      // Show modal first
      if (ensureModal()==='bootstrap'){ bsModal.show(); }
      else {
        modalEl.classList.add('show'); modalEl.style.display='block'; modalEl.removeAttribute('aria-hidden'); document.body.classList.add('modal-open');
        let backdrop=document.createElement('div'); backdrop.className='modal-backdrop fade show'; backdrop.setAttribute('data-fallback','1'); document.body.appendChild(backdrop);
        const closeBtn = modalEl.querySelector('[data-bs-dismiss="modal"]');
        if (closeBtn){ closeBtn.onclick=function(){ modalEl.classList.remove('show'); modalEl.style.display='none'; modalEl.setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open'); const bd=document.querySelector('.modal-backdrop[data-fallback="1"]'); if(bd) bd.remove(); } }
      }

      // Load products from API
      const apiProducts = await loadStepProducts(step);
      
      stepProducts.innerHTML = '';
      if (apiProducts && apiProducts.length > 0) {
        stepProductsWrap.style.display = '';
        apiProducts.forEach(product => {
          const col = document.createElement('div');
          col.className = 'col-6 col-lg-3';
          
          const imageUrl = product.image || '/static/image/default-product.jpg';
          const originalPrice = product.original_price ? formatPrice(product.original_price * 1000) : '';
          const discountedPrice = product.discounted_price ? formatPrice(product.discounted_price * 1000) : formatPrice(product.original_price * 1000);
          
          col.innerHTML = `
            <div class="modal-product card border-0 h-100">
              <div class="position-relative">
                <img src="${imageUrl}" alt="${product.name || ''}" class="card-img-top" style="height: 120px; object-fit: cover;" onerror="this.src='/static/image/default-product.jpg'">
                <button class="btn btn-sm btn-primary position-absolute top-0 end-0 m-1 add-to-cart-btn" 
                        data-product-id="${product.id}" 
                        style="border-radius: 50%; width: 30px; height: 30px; padding: 0; display: flex; align-items: center; justify-content: center;">
                  <i class="fas fa-plus" style="font-size: 12px;"></i>
                </button>
              </div>
              <div class="card-body p-2 d-flex flex-column">
                <div class="fw-bold small mb-1" style="font-size: 12px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${product.name || ''}</div>
                <div class="small text-muted mb-2 d-flex justify-content-between align-items-center" style="font-size: 10px;">
                  <span>${product.brand_name || ''}</span>
                  <span class="badge ${getStatusBadgeClass(product.status)}" style="font-size: 8px; padding: 2px 4px;">${getStatusText(product.status)}</span>
                </div>
                <div class="small mt-auto">
                  ${originalPrice && product.discounted_price ? `<span class="text-muted text-decoration-line-through me-1" style="font-size: 10px;">${originalPrice}</span>` : ''}
                  <span class="text-danger fw-bold" style="font-size: 13px;">${discountedPrice}</span>
                </div>
              </div>
            </div>
          `;
          stepProducts.appendChild(col);
        });

        // Add event listeners for add to cart buttons
        stepProducts.querySelectorAll('.add-to-cart-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const productId = this.getAttribute('data-product-id');
            if (productId) {
              addToCartFromSkincare(productId);
            }
          });
        });
      } else {
        // Fallback to static products if API fails
        if (data.products && data.products.length) {
          stepProductsWrap.style.display = '';
          data.products.forEach(p => {
            const col = document.createElement('div');
            col.className = 'col-6 col-lg-3';
            col.innerHTML = `
              <div class="modal-product card border-0">
                <img src="${imgPath(p.img)}" alt="${p.name || ''}" class="card-img-top" style="height: 120px; object-fit: cover;">
                <div class="card-body p-2">
                  <div class="fw-bold small mb-1">${p.name || ''}</div>
                  <div class="small text-muted mb-2 d-flex justify-content-between align-items-center" style="font-size: 10px;">
                    <span>Th∆∞∆°ng hi·ªáu</span>
                    <span class="badge bg-success" style="font-size: 8px; padding: 2px 4px;">M·ªõi</span>
                  </div>
                  <div class="small">
                    <span class="text-danger fw-bold">${p.price || ''}</span>
                    ${p.old ? `<span class='text-muted text-decoration-line-through ms-1'>${p.old}</span>` : ''}
                  </div>
                </div>
              </div>
            `;
            stepProducts.appendChild(col);
          });
        } else {
          stepProductsWrap.style.display = 'none';
        }
      }
    }catch(err){ console.error('Open step error:', err); alert('Xin l·ªói, kh√¥ng th·ªÉ m·ªü chi ti·∫øt. Vui l√≤ng t·∫£i l·∫°i trang.'); }
  }

  document.querySelectorAll('.step[data-step]').forEach(card=>{
    const handler = ()=> openStep(card.getAttribute('data-step'));
    card.addEventListener('click', handler);
    card.addEventListener('keypress', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); handler(); } });
  });

  document.querySelectorAll('.faq-q').forEach(q=> q.addEventListener('click', ()=> q.parentElement.classList.toggle('active')));
})();
</script>
{% endblock %}
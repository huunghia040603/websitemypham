{% extends "base.html" %}

{% block title %}Dưỡng Da - BuddySkincare{% endblock %}

{% block extra_css %}
<style>
    body { background: #ffffff; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; color: #374151; }
    .skin-container { max-width: 100%; margin: 0 auto; padding: 0; }

    /* Hero */
    .hero { position: relative; padding: 2rem 0 1.5rem; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; overflow: hidden; width: 100%; }
    .hero-content { position: relative; z-index: 2; max-width: 860px; margin: 0 auto; padding: 0 2rem; }
    .hero h1 { font-size: 3rem; font-weight: 800; letter-spacing: -0.02em; margin-bottom: 1rem; text-shadow: 0 4px 8px rgba(0,0,0,0.25); }
    .hero p { font-size: 1.1rem; color: rgba(255,255,255,0.9); margin: 0 auto; max-width: 680px; }

    /* Layout */
    .content-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-top: 2rem; max-width: 1200px; margin-left: auto; margin-right: auto; padding: 0 1rem; }
    .section { padding: 3rem 0; border-bottom: 1px solid #f3f4f6; }
    .section:last-child { border-bottom: none; }
    .section-header { margin-bottom: 1.5rem; text-align: left; }
    .section-title { font-size: 1.5rem; font-weight: 800; color: #111827; margin: 0 0 .6rem; letter-spacing: -0.015em; }
    .section-subtitle { font-size: 0.95rem; color: #6b7280; margin: 0; }

    /* Routine steps */
    .steps { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; }
    .step { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1rem; transition: border-color .2s ease, box-shadow .2s ease; text-decoration: none; color: inherit; display: block; cursor: pointer; }
    .step:hover { border-color: #d1d5db; box-shadow: 0 8px 22px rgba(0,0,0,0.06); }
    .step h4 { font-size: 1.05rem; font-weight: 700; color: #111827; margin: 0 0 .4rem; }
    .step p { font-size: .92rem; color: #6b7280; margin: 0; line-height: 1.6; }
    .badge-num { width: 36px; height: 36px; border-radius: 50%; background: #6d28d9; color: #fff; display: grid; place-items: center; font-weight: 800; margin-bottom: .6rem; }

    /* Tips grid */
    .tips { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
    .tip { background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border: 1px solid #10b981; border-radius: 12px; padding: 1rem; }
    .tip h4 { margin: 0 0 .35rem; font-size: 1rem; color: #065f46; font-weight: 800; }
    .tip p { margin: 0; color: #047857; font-size: .92rem; }

    /* Product cards */
    .products { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
    
    /* Responsive design for mobile */
    @media (max-width: 768px) {
        .products { grid-template-columns: repeat(2, 1fr); gap: 1rem; }
    }
    
    @media (max-width: 480px) {
        .products { grid-template-columns: 1fr; gap: 1rem; }
    }
    .product { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .product:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
    .product img { width: 100%; height: 160px; object-fit: cover; display: block; }
    .product .p-content { padding: .8rem; }
    .product h5 { font-size: 1rem; font-weight: 700; margin: 0 0 .25rem; color: #111827; }
    .price { color: #dc2626; font-weight: 800; font-size: .98rem; }
    .old { text-decoration: line-through; color: #9ca3af; font-size: .85rem; margin-left: .35rem; }
    
    /* Product card enhancements */
    .product-card { transition: all 0.3s ease; }
    .product-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
    .add-to-cart-btn { transition: all 0.2s ease; }
    .add-to-cart-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .fav-toggle:hover { transform: scale(1.1); }

    /* Sidebar */
    .sidebar-section { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; }
    .sidebar-title { font-size: 1rem; font-weight: 800; color: #111827; margin-bottom: .6rem; }
    .list { list-style: none; margin: 0; padding: 0; }
    .list li { padding: .45rem 0; border-bottom: 1px solid #f3f4f6; }
    .list li:last-child { border-bottom: 0; }

    /* FAQ */
    .faq { border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; }
    .faq-item { border-bottom: 1px solid #f3f4f6; }
    .faq-item:last-child { border-bottom: 0; }
    .faq-q { position: relative; background: #fff; padding: .9rem 2rem .9rem 1rem; font-weight: 700; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .faq-q::after { content: "\f078"; font-family: "Font Awesome 5 Free"; font-weight: 900; color: #9ca3af; position: absolute; right: .75rem; transition: transform .2s ease; }
    .faq-item.active .faq-q::after { transform: rotate(180deg); }
    .faq-a { display: none; background: #fff; padding: 0 1rem 1rem; color: #6b7280; font-size: .95rem; }
    .faq-item.active .faq-a { display: block; }

    /* Modal content */
    .modal-product img { width: 100%; border-radius: 10px; height: 140px; object-fit: cover; }
    .news-mini { display: grid; grid-template-columns: 56px 1fr; gap: .5rem; padding: .5rem; border: 1px solid #f3f4f6; border-radius: 10px; margin-bottom: .5rem; text-decoration: none; color: inherit; }
    .news-mini:hover { background: #f9fafb; }
    .news-mini .thumb { width: 56px; height: 42px; border-radius: 8px; overflow: hidden; background: #f3f4f6; }
    .news-mini .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .news-mini .title { font-size: .92rem; font-weight: 700; margin: 0; color: #111827; line-height: 1.35; }
    .news-mini .meta { font-size: .8rem; color: #6b7280; }
</style>
{% endblock %}

{% block content %}
<div class="skin-container">
    <section class="hero">
        <div class="hero-content">
            <h1>Dưỡng Da Căn Bản</h1>
            <p>Quy trình dưỡng da tối giản nhưng hiệu quả cùng mỹ phẩm thanh lý BuddySkincare.</p>
        </div>
    </section>

    <div class="content-layout">
        <div class="main">
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Quy Trình 6 Bước Sáng - Tối</h2>
                    <p class="section-subtitle">Bấm vào từng bước để xem hướng dẫn chi tiết và gợi ý sản phẩm</p>
                </div>
                <div class="steps">
                    <div class="step" data-step="1" role="button" tabindex="0">
                        <div class="badge-num">1</div>
                        <h4>Làm sạch</h4>
                        <p>Sáng: sữa rửa mặt dịu nhẹ. Tối: tẩy trang + rửa mặt để loại bỏ bụi bẩn.</p>
                    </div>
                    <div class="step" data-step="2" role="button" tabindex="0">
                        <div class="badge-num">2</div>
                        <h4>Cân bằng</h4>
                        <p>Nước cân bằng (toner) phục hồi pH, chuẩn bị cho bước dưỡng sau.</p>
                    </div>
                    <div class="step" data-step="3" role="button" tabindex="0">
                        <div class="badge-num">3</div>
                        <h4>Điều trị</h4>
                        <p>Serum đặc trị (AHA/BHA, Niacinamide, Hyaluronic...).</p>
                    </div>
                    <div class="step" data-step="4" role="button" tabindex="0">
                        <div class="badge-num">4</div>
                        <h4>Khóa ẩm</h4>
                        <p>Kem dưỡng giúp giảm mất nước qua biểu bì.</p>
                    </div>
                    <div class="step" data-step="5" role="button" tabindex="0">
                        <div class="badge-num">5</div>
                        <h4>Chống nắng</h4>
                        <p>SPF 30+ phổ rộng; đủ lượng và thoa lại sau 2-3 giờ.</p>
                    </div>
                    <div class="step" data-step="6" role="button" tabindex="0">
                        <div class="badge-num">6</div>
                        <h4>Đặc biệt</h4>
                        <p>Mask/peel dịu nhẹ 1–2 lần/tuần.</p>
                    </div>
                </div>
            </section>

            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Gợi Ý Sản Phẩm Phù Hợp</h2>
                    <p class="section-subtitle">Một số sản phẩm thanh lý giá tốt đang có</p>
                </div>
                <div class="products" id="skincareProducts">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                        <p class="mt-2 text-muted">Đang tải sản phẩm...</p>
                    </div>
                </div>
            </section>

            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Mẹo Dưỡng Da Theo Loại Da</h2>
                    <p class="section-subtitle">Điều chỉnh quy trình theo nhu cầu</p>
                </div>
                <div class="tips">
                    <div class="tip">
                        <h4>Da dầu/Hỗn hợp</h4>
                        <p>Ưu tiên gel/foaming cleanser, toner không cồn, serum Niacinamide, gel dưỡng mỏng.</p>
                    </div>
                    <div class="tip">
                        <h4>Da khô</h4>
                        <p>Chọn sữa rửa mặt dịu nhẹ, thêm Hyaluronic/ceramide, kem dưỡng đặc hơn, khóa ẩm.</p>
                    </div>
                    <div class="tip">
                        <h4>Da nhạy cảm</h4>
                        <p>Tránh hương liệu/mùi; test thử vùng nhỏ trước khi dùng; ưu tiên thành phần phục hồi.</p>
                    </div>
                    <div class="tip">
                        <h4>Da nám/tối màu</h4>
                        <p>Thêm Vitamin C/Arbutin/Tranexamic; chống nắng nghiêm ngặt mỗi ngày.</p>
                    </div>
                </div>
            </section>

            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Câu Hỏi Thường Gặp</h2>
                    <p class="section-subtitle">Những thắc mắc phổ biến về dưỡng da cơ bản</p>
                </div>
                <div class="faq" id="faq">
                    <div class="faq-item">
                        <div class="faq-q">Nên rửa mặt mấy lần mỗi ngày? </div>
                        <div class="faq-a">Hai lần sáng/tối là đủ. Tránh rửa quá nhiều gây khô kích ứng.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Có cần toner không?</div>
                        <div class="faq-a">Toner hỗ trợ cân bằng pH và làm ẩm nhẹ. Không bắt buộc nhưng hữu ích cho nhiều loại da.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Bôi chống nắng bao nhiêu là đủ?</div>
                        <div class="faq-a">Ước lượng 2 ngón tay cho mặt và cổ, thoa lại sau 2-3 giờ nếu ở ngoài trời.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Da dầu có cần dưỡng ẩm không?</div>
                        <div class="faq-a">Có. Dùng gel/kem mỏng, không gây bít tắc (non-comedogenic) để cân bằng dầu.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Niacinamide dùng chung Vitamin C được không?</div>
                        <div class="faq-a">Có thể dùng cùng routine. Nếu da nhạy cảm, dùng xen kẽ sáng/tối để da thích nghi.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">AHA/BHA nên dùng mấy lần/tuần?</div>
                        <div class="faq-a">Bắt đầu 1-2 lần/tuần, tăng dần theo đáp ứng. Tránh lạm dụng gây kích ứng.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Có cần tẩy trang khi không trang điểm?</div>
                        <div class="faq-a">Nên tẩy trang buổi tối để loại bỏ kem chống nắng/bụi bẩn/bã nhờn.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Da mụn có nên dùng dầu dưỡng?</div>
                        <div class="faq-a">Có thể dùng các loại oil nhẹ (squalane) ở lượng nhỏ, sau serum và trước kem khóa ẩm.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Thứ tự layer sản phẩm thế nào?</div>
                        <div class="faq-a">Lỏng đến đặc: rửa mặt → toner → serum → kem dưỡng → chống nắng (ban ngày).</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Bao lâu thấy hiệu quả serum?</div>
                        <div class="faq-a">Thường 2-8 tuần tùy hoạt chất/mức độ vấn đề da và thói quen sinh hoạt.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Da đang kích ứng nên làm gì?</div>
                        <div class="faq-a">Dừng hoạt chất mạnh, ưu tiên phục hồi (panthenol, ceramide), chống nắng kỹ và tối giản routine.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Có cần rửa mặt sau khi đắp mask?</div>
                        <div class="faq-a">Với mask giấy: không cần rửa, vỗ nhẹ cho thấm. Với mask rửa: rửa sạch theo hướng dẫn.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Dùng retinol khi nào?</div>
                        <div class="faq-a">Dùng buổi tối, 1-3 lần/tuần lúc đầu, tăng dần. Luôn chống nắng và dưỡng ẩm kỹ.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Vitamin C bị oxy hóa có dùng tiếp được không?</div>
                        <div class="faq-a">Khi chuyển vàng nâu đậm, mùi hắc, nên ngừng dùng. Bảo quản kín, tránh sáng/nhiệt.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Có nên rửa mặt bằng nước lạnh buổi sáng?</div>
                        <div class="faq-a">Nếu da rất khô/nhạy cảm có thể chỉ dùng nước ấm nhẹ. Đa số vẫn nên dùng sữa rửa mặt dịu nhẹ.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Thoa kem mắt trước hay sau serum?</div>
                        <div class="faq-a">Sau serum cho mặt, trước kem dưỡng. Dùng lượng ít, vỗ nhẹ quanh hốc mắt.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Chọn kem chống nắng vật lý hay hóa học?</div>
                        <div class="faq-a">Da nhạy cảm dễ hợp vật lý; cần mỏng nhẹ vô hình có thể chọn hóa học. Quan trọng là dùng đủ lượng.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Dùng nhiều sản phẩm cùng lúc có tốt hơn không?</div>
                        <div class="faq-a">Không. Tối giản và nhất quán giúp da ổn định hơn, giảm nguy cơ kích ứng và tiết kiệm chi phí.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Bao lâu nên thay sữa rửa mặt/kem dưỡng?</div>
                        <div class="faq-a">Theo hạn dùng ghi trên bao bì (PAO). Thường 6-12 tháng sau khi mở nắp tùy sản phẩm.</div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-q">Dùng sản phẩm thanh lý/pass tester có an toàn?</div>
                        <div class="faq-a">Chúng tôi kiểm tra tình trạng, hạn dùng và niêm phong kỹ. Bạn nên đọc mô tả chi tiết và test thử vùng nhỏ trước khi dùng.</div>
                    </div>
                </div>
            </section>
        </div>

        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Danh Mục Liên Quan</div>
                <ul class="list">
                    <li><a href="/flash-sale">Flash Sale giờ vàng</a></li>
                    <li><a href="/shopping-guide">Hướng dẫn mua hàng</a></li>
                    <li><a href="/online-payment-safety">Thanh toán an toàn</a></li>
                    <li><a href="/support">Hỗ trợ & FAQ</a></li>
                </ul>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Lưu Ý Nhanh</div>
                <ul class="list">
                    <li>Test thử vùng nhỏ khi dùng sản phẩm mới</li>
                    <li>Ưu tiên SPF hằng ngày</li>
                    <li>Không dùng quá nhiều hoạt chất cùng lúc</li>
                </ul>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Tin Tức Mới</div>
                <div id="newsContainer">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                        <p class="mt-2 text-muted small">Đang tải tin tức...</p>
                    </div>
                </div>
            </div>
        </aside>
    </div>
</div>

<!-- Step Detail Modal -->
<div class="modal fade" id="stepModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="stepTitle">Chi tiết bước</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="stepDesc" class="mb-3 text-muted"></p>
        <div class="row g-3">
          <div class="col-md-6">
            <h6 class="fw-bold">Cách thực hiện</h6>
            <ol id="stepHow" class="mb-0"></ol>
          </div>
          <div class="col-md-6">
            <h6 class="fw-bold">Mẹo nhỏ</h6>
            <ul id="stepTips" class="mb-0"></ul>
          </div>
        </div>
        <div id="stepProductsWrap" class="mt-3" style="display:none;">
          <h6 class="fw-bold mb-2">Gợi ý sản phẩm</h6>
          <div id="stepProducts" class="row g-3"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// API Configuration
const API_BASE_URL = 'https://buddyskincare.pythonanywhere.com';

// Load skincare products from API
async function loadSkincareProducts() {
  try {
    console.log('🔍 Loading skincare products from API...');
    const response = await fetch(`${API_BASE_URL}/products/`);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const products = await response.json();
    console.log(`✅ Got ${products.length} products from API`);
    
    // Filter skincare products
    const skincareKeywords = [
      'sữa rửa mặt', 'sua rua mat', 'cleanser', 'wash', 'rửa mặt',
      'tẩy trang', 'tay trang', 'makeup remover', 'bioderma',
      'kem chống nắng', 'kem chong nang', 'sunscreen', 'spf',
      'serum', 'toner', 'nước cân bằng', 'nuoc can bang',
      'kem dưỡng', 'kem duong', 'moisturizer', 'cream',
      'mask', 'mặt nạ', 'mat na', 'peel', 'exfoliant',
      'dung dịch', 'dung dich', 'rong nho', 'peel',
      'mặt nạ', 'mat na', 'mask', 'đất sét', 'dat set',
      'kem dưỡng', 'kem duong', 'dưỡng', 'duong',
      'tinh chất', 'tinh chat', 'serum', 'essence',
      'retinol', 'vitamin c', 'vitamin a', 'niacinamide',
      'hyaluronic', 'collagen', 'peptide', 'ceramide',
      'dưỡng thể', 'duong the', 'body', 'lotion',
      'cleansing', 'purifying', 'moisturizing', 'hydrating'
    ];
    
    const skincareProducts = products.filter(product => {
      const productName = (product.name || '').toLowerCase();
      const categoryName = (product.category_name || '').toLowerCase();
      return skincareKeywords.some(keyword => 
        productName.includes(keyword) || categoryName.includes(keyword)
      );
    });
    
    // Shuffle array randomly and take 9 products
    const shuffledProducts = [...skincareProducts].sort(() => Math.random() - 0.5);
    const topProducts = shuffledProducts.slice(0, 9);
    
    console.log(`📊 Found ${topProducts.length} skincare products`);
    renderSkincareProducts(topProducts);
    
  } catch (error) {
    console.error('❌ Error loading skincare products:', error);
    renderSkincareProductsError();
  }
}

// Render skincare products with shopping functionality
function renderSkincareProducts(products) {
  const container = document.getElementById('skincareProducts');
  
  if (!products || products.length === 0) {
    container.innerHTML = `
      <div class="text-center py-4">
        <p class="text-muted">Không có sản phẩm dưỡng da nào</p>
      </div>
    `;
    return;
  }
  
  // Clear container and add products with shopping functionality
  container.innerHTML = '';
  
  products.forEach(product => {
    const productCard = createSkincareProductCard(product);
    container.appendChild(productCard);
  });
  
  // Initialize product cards after rendering
  initSkincareProductCards();
}

// Create product card with shopping functionality (similar to index)
function createSkincareProductCard(product) {
  const imageUrl = (product.image && String(product.image).trim()) || '/static/image/default-product.jpg';
  const brandName = product.brand_name || (product.brand ? product.brand.name : 'Không rõ');
  
  const originalPrice = typeof product.original_price === 'number' ? product.original_price * 1000 : null;
  const discountedPrice = typeof product.discounted_price === 'number' ? product.discounted_price * 1000 : null;
  const rating = typeof product.rating === 'number' ? product.rating : (parseFloat(product.rating) || 0);
  const stockQuantity = typeof product.stock_quantity === 'number' ? product.stock_quantity : 0;
  
  const fullStars = Math.floor(rating);
  const hasHalfStar = rating % 1 >= 0.5 && rating % 1 < 1;
  
  let starsHTML = '';
  for (let i = 0; i < fullStars; i++) starsHTML += '<i class="fas fa-star"></i>';
  if (hasHalfStar) starsHTML += '<i class="fas fa-star-half-alt"></i>';
  for (let i = fullStars + (hasHalfStar ? 1 : 0); i < 5; i++) starsHTML += '<i class="far fa-star"></i>';
  
  const discountRate = (typeof product.discount_rate === 'number')
    ? Math.round(product.discount_rate)
    : ((originalPrice && discountedPrice) ? Math.round(((originalPrice - discountedPrice) / originalPrice) * 100) : 0);
  
  const isOutOfStock = stockQuantity <= 0;
  const productName = product.name;
  
  const cardDiv = document.createElement('div');
  cardDiv.className = 'product';
  cardDiv.innerHTML = `
    <div class="product-card card h-100 border-0 shadow-sm" style="transition: transform 0.2s ease, box-shadow 0.2s ease;">
      <div class="position-relative">
        <a href="/product/${product.id}" class="text-decoration-none">
          <img src="${imageUrl}" class="card-img-top" alt="${productName}" 
               style="height: 200px; object-fit: cover; ${isOutOfStock ? 'filter: grayscale(100%);' : ''}"
               onerror="this.src='/static/image/default-product.jpg'">
        </a>
        ${isOutOfStock ? `
        <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" 
             style="background-color: rgba(0,0,0,0.7); border-radius: 6px;">
          <div class="text-center text-white">
            <i class="fas fa-times-circle fa-2x mb-1"></i>
            <h6 class="fw-bold mb-0">HẾT HÀNG</h6>
          </div>
        </div>
        ` : ''}
        <button class="fav-toggle position-absolute top-0 end-0 m-2" 
                title="Thêm vào yêu thích" 
                data-id="${product.id}"
                data-name="${String(productName).replace(/\"/g,'\\\"')}"
                data-image="${imageUrl}"
                data-brand="${String(brandName).replace(/\"/g,'\\\"')}"
                data-price="${discountedPrice || 0}"
                style="border:none;background:transparent;cursor:pointer;">
          <i class="far fa-heart" style="font-size: 18px; color:#fff; text-shadow: 0 1px 3px rgba(0,0,0,0.5);"></i>
        </button>
        <div class="position-absolute bottom-0 start-0 m-1">
          <img src="/static/image/logo.png" alt="Logo" class="product-logo" 
               style="width: 28px; height: 28px; object-fit: contain; border-radius: 50%; background: white; padding: 2px; display: block; z-index: 10; box-shadow: 0 1px 3px rgba(0,0,0,0.2);" 
               onerror="this.style.display='none';">
        </div>
        <div class="product-badges-row position-absolute" style="top:8px;left:10px;display:flex;gap:6px;align-items:center;z-index:2;">
          ${discountRate > 0 ? `<div class="badge bg-danger discount-badge-left" style="font-size: 11px; padding: 4px 8px;">-${discountRate}%</div>` : ''}
        </div>
      </div>
      <div class="card-body d-flex flex-column">
        <h6 class="card-title fw-bold" style="font-size: 14px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 36px;">
          <a href="/product/${product.id}" class="text-decoration-none text-dark">${productName}</a>
        </h6>
        <div class="d-flex justify-content-between align-items-center mb-2" style="font-size: 11px;">
          <span class="text-muted">${brandName}</span>
          <span class="badge ${getStatusBadgeClass(product.status)}" style="font-size: 8px; padding: 2px 4px;">${getStatusText(product.status)}</span>
        </div>
        <div class="d-flex align-items-center mb-1">
          ${originalPrice ? `<span class="text-decoration-line-through text-muted me-1" style="font-size: 12px;">${formatPrice(originalPrice)}</span>` : ''}
          <span class="text-danger fw-bold" style="font-size: 16px;">${formatPrice(discountedPrice)}</span>
        </div>
        <div class="d-flex align-items-center mb-3">
          <div class="stars text-warning me-2" style="font-size: 12px;">
            ${starsHTML}
          </div>
          <small class="text-muted" style="font-size: 11px;">(${rating})</small>
          <span class="badge ${isOutOfStock ? 'bg-danger' : 'bg-success'}" style="font-size: 10px; padding: 4px 8px; margin-left: 10px;">${isOutOfStock ? 'Hết hàng' : `Còn ${stockQuantity}`}</span>
        </div>
        <button class="btn w-100 add-to-cart-btn ${isOutOfStock ? 'btn-secondary' : 'btn-primary'}" 
                data-product-id="${product.id}" 
                style="font-size: 13px; padding: 8px;" 
                ${isOutOfStock ? 'disabled' : ''}>
          ${isOutOfStock ? 'Hết hàng' : 'Thêm vào giỏ'}
        </button>
      </div>
    </div>
  `;
  
  return cardDiv;
}

// Initialize product cards functionality
function initSkincareProductCards() {
  // Add to cart functionality
  document.querySelectorAll('#skincareProducts .add-to-cart-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const productId = this.getAttribute('data-product-id');
      if (productId) {
        addToCartFromSkincare(productId);
      }
    });
  });
  
  // Favorite toggle functionality
  document.querySelectorAll('#skincareProducts .fav-toggle').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      toggleFavorite(this);
    });
  });
  
  // Restore favorite states from localStorage
  restoreFavoriteStates();
}

// Restore favorite states - using main.js system
function restoreFavoriteStates() {
  document.querySelectorAll('#skincareProducts .fav-toggle').forEach(btn => {
    const productId = btn.getAttribute('data-id');
    const heartIcon = btn.querySelector('i');
    
    // Use main.js getWishlist function if available
    if (typeof getWishlist === 'function') {
      const wishlist = getWishlist();
      // Check if wishlist is a Map or Set
      const isFavorite = wishlist && (wishlist.has ? wishlist.has(productId) : wishlist.hasOwnProperty(productId));
      
      if (isFavorite) {
        heartIcon.classList.remove('far');
        heartIcon.classList.add('fas');
        heartIcon.style.color = '#dc3545';
      } else {
        heartIcon.classList.remove('fas');
        heartIcon.classList.add('far');
        heartIcon.style.color = '#fff';
      }
    } else {
      // Fallback to localStorage
      const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      const isFavorite = favorites.some(fav => fav.id === productId);
      
      if (isFavorite) {
        heartIcon.classList.remove('far');
        heartIcon.classList.add('fas');
        heartIcon.style.color = '#dc3545';
      } else {
        heartIcon.classList.remove('fas');
        heartIcon.classList.add('far');
        heartIcon.style.color = '#fff';
      }
    }
  });
}

// Add to cart function for skincare page - using main.js system
async function addToCartFromSkincare(productId) {
  try {
    // Get product details first
    const productResponse = await fetch(`https://buddyskincare.pythonanywhere.com/products/${productId}/`);
    if (!productResponse.ok) {
      showCartNotification('Không thể tải thông tin sản phẩm', 'error');
      return;
    }
    
    const product = await productResponse.json();
    
    // Use the main.js addProductToCart function if available
    if (typeof addProductToCart === 'function') {
      // Ensure prices are numbers and multiply by 1000 to match display format
      const discountedPrice = typeof product.discounted_price === 'number' 
        ? product.discounted_price * 1000
        : (typeof product.discounted_price === 'string' ? (parseFloat(product.discounted_price) || 0) * 1000 : 0);
      
      const originalPrice = typeof product.original_price === 'number' 
        ? product.original_price * 1000
        : (typeof product.original_price === 'string' ? (parseFloat(product.original_price) || 0) * 1000 : 0);
      
      // Find the product image element for fly animation
      const productImage = document.querySelector(`[data-product-id="${productId}"]`)?.closest('.product')?.querySelector('img');
      
      // Add fly to cart animation if available
      if (typeof flyToCart === 'function' && productImage) {
        flyToCart(productImage, async () => {
          // Add to cart after animation
          await addProductToCart(
            productId,
            product.name || 'Sản phẩm',
            discountedPrice,
            product.image || '/static/image/default-product.jpg',
            originalPrice,
            1
          );
        });
      } else {
        // Add to cart without animation
        await addProductToCart(
          productId,
          product.name || 'Sản phẩm',
          discountedPrice,
          product.image || '/static/image/default-product.jpg',
          originalPrice,
          1
        );
      }
    } else {
      // Fallback to direct API call with animation
      const productImage = document.querySelector(`[data-product-id="${productId}"]`)?.closest('.product')?.querySelector('img');
      
      // Add fly to cart animation if available
      if (typeof flyToCart === 'function' && productImage) {
        flyToCart(productImage, async () => {
          // Add to cart after animation
          const response = await fetch('/api/add-to-cart', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              product_id: parseInt(productId),
              quantity: 1
            })
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              showCartNotification(`Đã thêm sản phẩm vào giỏ hàng! (${result.cart_count} sản phẩm)`, 'success');
              updateCartCountInHeader(result.cart_count);
            } else {
              showCartNotification(result.message || 'Có lỗi xảy ra', 'error');
            }
          } else {
            showCartNotification('Có lỗi xảy ra khi thêm vào giỏ hàng', 'error');
          }
        });
      } else {
        // Add to cart without animation
        const response = await fetch('/api/add-to-cart', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            product_id: parseInt(productId),
            quantity: 1
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            showCartNotification(`Đã thêm sản phẩm vào giỏ hàng! (${result.cart_count} sản phẩm)`, 'success');
            updateCartCountInHeader(result.cart_count);
          } else {
            showCartNotification(result.message || 'Có lỗi xảy ra', 'error');
          }
        } else {
          showCartNotification('Có lỗi xảy ra khi thêm vào giỏ hàng', 'error');
        }
      }
    }
  } catch (error) {
    console.error('Error adding to cart:', error);
    showCartNotification('Có lỗi xảy ra', 'error');
  }
}

// Update cart count in header
function updateCartCountInHeader(count) {
  // Try to find cart count elements in header
  const cartCountElements = document.querySelectorAll('.cart-count, .cart-badge, [data-cart-count]');
  cartCountElements.forEach(element => {
    element.textContent = count;
    element.style.display = count > 0 ? 'inline' : 'none';
  });
  
  // Also try to update cart icon
  const cartIcons = document.querySelectorAll('.fa-shopping-cart, .cart-icon');
  cartIcons.forEach(icon => {
    const badge = icon.parentElement.querySelector('.badge');
    if (badge) {
      badge.textContent = count;
      badge.style.display = count > 0 ? 'inline' : 'none';
    }
  });
}

// Show cart notification
function showCartNotification(message, type = 'success') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
  notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  notification.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
      <span>${message}</span>
      <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // Auto remove after 3 seconds
  setTimeout(() => {
    if (notification.parentElement) {
      notification.remove();
    }
  }, 3000);
}

// Toggle favorite function - using main.js system
function toggleFavorite(btn) {
  const productId = btn.getAttribute('data-id');
  const productName = btn.getAttribute('data-name');
  const productImage = btn.getAttribute('data-image');
  const productBrand = btn.getAttribute('data-brand');
  const productPrice = btn.getAttribute('data-price');
  const heartIcon = btn.querySelector('i');
  
  // Use main.js toggleWishlist function if available
  if (typeof toggleWishlist === 'function') {
    const item = {
      id: productId,
      name: productName,
      image: productImage,
      brand: productBrand,
      price: productPrice
    };
    
    toggleWishlist(item);
    
    // Update visual state
    const wishlist = getWishlist();
    const isFavorite = wishlist && (wishlist.has ? wishlist.has(productId) : wishlist.hasOwnProperty(productId));
    if (isFavorite) {
      heartIcon.classList.remove('far');
      heartIcon.classList.add('fas');
      heartIcon.style.color = '#dc3545';
    } else {
      heartIcon.classList.remove('fas');
      heartIcon.classList.add('far');
      heartIcon.style.color = '#fff';
    }
  } else {
    // Fallback to localStorage system
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    
    if (heartIcon.classList.contains('far')) {
      // Add to favorites
      heartIcon.classList.remove('far');
      heartIcon.classList.add('fas');
      heartIcon.style.color = '#dc3545';
      
      const product = {
        id: productId,
        name: productName,
        image: productImage,
        brand: productBrand,
        price: productPrice
      };
      
      const existingIndex = favorites.findIndex(fav => fav.id === productId);
      if (existingIndex === -1) {
        favorites.push(product);
        localStorage.setItem('favorites', JSON.stringify(favorites));
        showCartNotification('Đã thêm vào yêu thích!', 'success');
      } else {
        showCartNotification('Sản phẩm đã có trong yêu thích!', 'info');
      }
    } else {
      // Remove from favorites
      heartIcon.classList.remove('fas');
      heartIcon.classList.add('far');
      heartIcon.style.color = '#fff';
      
      favorites = favorites.filter(fav => fav.id !== productId);
      localStorage.setItem('favorites', JSON.stringify(favorites));
      showCartNotification('Đã xóa khỏi yêu thích!', 'info');
    }
  }
}

// Render error state for products
function renderSkincareProductsError() {
  const container = document.getElementById('skincareProducts');
  container.innerHTML = `
    <div class="text-center py-4">
      <p class="text-muted">Không thể tải sản phẩm. Vui lòng thử lại sau.</p>
    </div>
  `;
}

// Load news from API
async function loadNews() {
  try {
    console.log('🔍 Loading news from API...');
    const response = await fetch(`${API_BASE_URL}/blog/`);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log(`✅ Got blog data from API:`, data);
    
    // Handle paginated response
    const blogs = data.results || data; // Support both paginated and direct array
    console.log(`📊 Total blogs: ${data.count || blogs.length}, Current page: ${data.current_page || 1}`);
    
    // Filter active blogs and sort by date, take top 3
    const newsItems = blogs
      .filter(blog => blog && typeof blog === 'object' && blog.is_active !== false)
      .sort((a, b) => new Date(b.post_date || 0) - new Date(a.post_date || 0))
      .slice(0, 3);
    
    console.log(`📰 Found ${newsItems.length} active news items`);
    renderNews(newsItems);
    
  } catch (error) {
    console.error('❌ Error loading news:', error);
    renderNewsError();
  }
}

// Render news
function renderNews(newsItems) {
  const container = document.getElementById('newsContainer');
  
  if (!newsItems || newsItems.length === 0) {
    container.innerHTML = `
      <div class="text-center py-3">
        <p class="text-muted small">Không có tin tức nào</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = newsItems.map(news => `
    <a class="news-mini" href="/news">
      <div class="thumb">
        <img src="${news.img_thumbnail || '/static/image/demo/placeholder.jpg'}" 
             alt="${news.title || 'Tin tức'}"
             onerror="this.src='/static/image/demo/placeholder.jpg'">
      </div>
      <div>
        <div class="title">${news.title || 'Tin tức'}</div>
        <div class="meta">${formatDate(news.post_date)} · ${news.views || 0} lượt xem</div>
      </div>
    </a>
  `).join('');
}

// Render error state for news
function renderNewsError() {
  const container = document.getElementById('newsContainer');
  container.innerHTML = `
    <div class="text-center py-3">
      <p class="text-muted small">Không thể tải tin tức. Vui lòng thử lại sau.</p>
    </div>
  `;
}

// Helper functions
function formatPrice(price) {
  if (!price) return '0₫';
  return new Intl.NumberFormat('vi-VN').format(price) + '₫';
}

function formatDate(dateString) {
  if (!dateString) return 'Không rõ ngày';
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('vi-VN', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
  } catch (error) {
    return 'Không rõ ngày';
  }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  console.log('🚀 Initializing skincare page...');
  loadSkincareProducts();
  loadNews();
  loadCartCount();
});

// Load cart count - using main.js system
async function loadCartCount() {
  // Use main.js updateCartCount function if available
  if (typeof updateCartCount === 'function') {
    updateCartCount();
  } else {
    // Fallback to direct API call
    try {
      const response = await fetch('/api/cart');
      if (response.ok) {
        const result = await response.json();
        if (result.success) {
          updateCartCountInHeader(result.total_items);
          console.log('Cart loaded:', result.cart);
        }
      }
    } catch (error) {
      console.error('Error loading cart:', error);
    }
  }
}

// Helper functions for product status - moved outside IIFE for global access
function getStatusText(status) {
  const statusMap = {
    'new': 'Mới',
    '30': 'còn 30%',
    '80': 'còn 80%',
    '75': 'còn 75%',
    '70': 'còn 70%',
    '60': 'còn 60%',
    '50': 'còn 50%',
    '90': 'còn 90%',
    '85': 'còn 85%',
    '95': 'còn 95%',
    'test': 'Test 1-2 lần',
    'newmh': 'Mới mất hộp',
    'newm': 'Mới hộp bị móp',
    'newrt': 'Mới rách tem',
    'newmn': 'Mới móp nhẹ',
    'newx': 'Mới bị xước',
    'newspx': 'Mới bị xước',
    'chiet': 'Chiết'
  };
  return statusMap[status] || status || 'Mới';
}

function getStatusBadgeClass(status) {
  const classMap = {
    'new': 'bg-success',
    '30': 'bg-danger',
    '80': 'bg-warning text-dark',
    '75': 'bg-warning text-dark',
    '70': 'bg-warning text-dark',
    '60': 'bg-warning text-dark',
    '50': 'bg-warning text-dark',
    '90': 'bg-info text-white',
    '85': 'bg-info text-white',
    '95': 'bg-info text-white',
    'test': 'bg-secondary',
    'newmh': 'bg-primary',
    'newm': 'bg-primary',
    'newrt': 'bg-primary',
    'newmn': 'bg-primary',
    'newx': 'bg-primary',
    'newspx': 'bg-primary',
    'chiet': 'bg-dark'
  };
  return classMap[status] || 'bg-success';
}

(function(){
  const stepsData = {
    1: {title:'Bước 1: Làm sạch',desc:'Loại bỏ bụi bẩn, dầu thừa và lớp trang điểm để da thông thoáng.',how:['Buổi tối: tẩy trang (dầu/nước micellar) trước khi rửa mặt','Làm ướt mặt với nước ấm để mở nhẹ lỗ chân lông','Lấy 1–2 hạt đậu sữa rửa mặt, tạo bọt trong lòng bàn tay','Massage vòng tròn 30–60 giây, tập trung vùng chữ T','Rửa sạch và thấm khô bằng khăn mềm'],tips:['Chọn pH ~5.5, công thức dịu nhẹ cho mọi loại da','Sáng rửa nhẹ, tối làm sạch kép nếu dùng chống nắng/trang điểm'],products:[{name:'Sữa rửa mặt dịu nhẹ',price:'128.000₫',old:'320.000₫',img:'image/demo/facebook-dynamic-sua-rua-mat-cetaphil-diu-nhe-khong-xa-phong-500ml-moi-1741235596_img_300x300_b798dd_fit_center.jpg'},{name:'Nước tẩy trang Bioderma',price:'98.000₫',old:'280.000₫',img:'image/demo/facebook-dynamic-nuoc-tay-trang-bioderma-danh-cho-da-dau-hon-hop-500ml-1745303871_img_300x300_b798dd_fit_center.jpg'}]},
    2: {title:'Bước 2: Cân bằng',desc:'Phục hồi pH, cấp ẩm nhẹ và hỗ trợ hấp thụ cho bước sau.',how:['Sau khi rửa mặt, thấm ướt bông với toner','Lau nhẹ theo chiều cấu trúc da hoặc vỗ trực tiếp bằng tay sạch','Chờ 30–60 giây trước bước tiếp theo'],tips:['Da nhạy cảm: ưu tiên toner không cồn, có panthenol/HA','Có thể layer 2–3 lần để tăng ẩm khi thời tiết khô hanh'],products:[{name:'Toner cân bằng dịu nhẹ',price:'120.000₫',old:'210.000₫',img:'image/demo/6fde01da-d545-435d-ab71-50ed3184afe0.webp'}]},
    3: {title:'Bước 3: Serum điều trị',desc:'Tập trung giải quyết vấn đề: mụn, thâm nám, thiếu ẩm, lão hóa...',how:['Dùng 2–3 giọt serum trên mặt và cổ','Vỗ/ấn nhẹ cho thấm, tránh chà xát','Đợi 1–2 phút trước khi khóa ẩm'],tips:['Không trộn nhiều hoạt chất mạnh (retinol, AHA/BHA, vitC) cùng một lúc','Da nhạy cảm: bắt đầu cách ngày, tăng dần tần suất'],products:[{name:'Serum Niacinamide 10%',price:'159.000₫',old:'280.000₫',img:'image/demo/47e547c3-bc87-4c3a-a0da-eeddf358e0f5.webp'}]},
    4: {title:'Bước 4: Khóa ẩm',desc:'Giữ ẩm cho da, giảm mất nước qua biểu bì và phục hồi hàng rào.',how:['Lấy lượng kem bằng hạt đậu, chấm 5 điểm và tán đều','Massage hướng lên trên và ra ngoài','Vùng khô có thể chấm thêm một lớp mỏng'],tips:['Da dầu: chọn gel/cream nhẹ, non‑comedogenic','Da khô: ưu tiên ceramide, squalane, shea butter'],products:[{name:'Kem dưỡng phục hồi',price:'165.000₫',old:'300.000₫',img:'image/demo/1200x429px_f18b4a4fee8d439b95d810bbd94b3493.jpg'}]},
    5: {title:'Bước 5: Chống nắng',desc:'Bảo vệ da trước UVA/UVB, ngăn nám sạm và lão hóa sớm.',how:['Dùng lượng ~2 ngón tay cho mặt/cổ','Thoa sau dưỡng ẩm 15–20 phút trước khi ra ngoài','Thoa lại sau 2–3 giờ hoặc sau khi đổ mồ hôi/nước'],tips:['Chọn SPF 30+ phổ rộng, PA+++','Trong nhà vẫn nên dùng nếu có ánh sáng xanh/ánh nắng'],products:[{name:"Kem chống nắng L'Oreal",price:'157.500₫',old:'350.000₫',img:'image/demo/facebook-dynamic-kem-chong-nang-l-oreal-paris-x20-thoang-da-mong-nhe-50ml-1738898716_img_300x300_b798dd_fit_center.jpg'}]},
    6: {title:'Bước 6: Mask/Peel',desc:'Tăng cường: cấp ẩm sâu, sáng da, làm mịn bề mặt (1–2 lần/tuần).',how:['Sau làm sạch, đắp mask 10–20 phút rồi gỡ nhẹ','Với peel dịu nhẹ: thoa mỏng, chờ 5–10 phút và rửa sạch','Luôn khóa ẩm sau mask/peel'],tips:['Tránh dùng chung ngày với retinol/AHA mạnh nếu da nhạy cảm','Theo dõi phản ứng da, giảm tần suất nếu kích ứng'],products:[{name:'Mặt nạ cấp ẩm',price:'45.000₫',old:'79.000₫',img:'image/tintuc/cach-chon-kem-chong-nang-phu-hop-nhat-cho-tung-loai-da-201910150810078833.jpg'}]}
  };

  const modalEl = document.getElementById('stepModal');
  let bsModal = null;
  function ensureModal(){
    try{
      if (window.bootstrap && bootstrap.Modal){ if (!bsModal) bsModal = new bootstrap.Modal(modalEl); return 'bootstrap'; }
    }catch(err){ console.error('Bootstrap check error:', err); }
    return 'fallback';
  }

  const stepTitle = document.getElementById('stepTitle');
  const stepDesc = document.getElementById('stepDesc');
  const stepHow = document.getElementById('stepHow');
  const stepTips = document.getElementById('stepTips');
  const stepProducts = document.getElementById('stepProducts');
  const stepProductsWrap = document.getElementById('stepProductsWrap');

  function renderList(el, items){ el.innerHTML=''; (items||[]).forEach(t=>{ const li=document.createElement('li'); li.textContent=t; el.appendChild(li); }); }

  function imgPath(src){
    if(!src) return '';
    if(src.startsWith('http')) return src;
    if(src.startsWith('/')) return src;
    // ensure /static prefix
    return '/static/' + src.replace(/^static\//,'');
  }

  // Keywords for each step to filter products
  const stepKeywords = {
    1: ['sữa rửa mặt', 'tẩy trang', 'cleanser', 'micellar', 'foam', 'gel'],
    2: ['toner', 'cân bằng', 'nước hoa hồng', 'essence', 'lotion'],
    3: ['serum', 'tinh chất', 'niacinamide', 'vitamin c', 'retinol', 'hyaluronic'],
    4: ['kem dưỡng', 'moisturizer', 'cream', 'lotion', 'dưỡng ẩm', 'phục hồi'],
    5: ['chống nắng', 'sunscreen', 'spf', 'uv', 'sunblock'],
    6: ['mặt nạ', 'mask', 'peel', 'exfoliant', 'scrub', 'cấp ẩm']
  };


  async function loadStepProducts(step) {
    try {
      const keywords = stepKeywords[step] || [];
      if (keywords.length === 0) return [];

      const response = await fetch('https://buddyskincare.pythonanywhere.com/products/');
      if (!response.ok) return [];

      const data = await response.json();
      const products = data.results || data;

      // Enhanced filtering with priority scoring
      const scoredProducts = products.map(product => {
        const name = (product.name || '').toLowerCase();
        const category = (product.category_name || '').toLowerCase();
        const brand = (product.brand_name || '').toLowerCase();
        const description = (product.description || '').toLowerCase();
        
        let score = 0;
        let matchedKeywords = [];
        
        // Check each keyword and assign scores
        keywords.forEach(keyword => {
          const keywordLower = keyword.toLowerCase();
          
          // Exact match in name gets highest score
          if (name.includes(keywordLower)) {
            score += 10;
            matchedKeywords.push(keyword);
          }
          
          // Match in category gets medium score
          if (category.includes(keywordLower)) {
            score += 7;
            matchedKeywords.push(keyword);
          }
          
          // Match in brand gets lower score
          if (brand.includes(keywordLower)) {
            score += 5;
            matchedKeywords.push(keyword);
          }
          
          // Match in description gets lowest score
          if (description.includes(keywordLower)) {
            score += 3;
            matchedKeywords.push(keyword);
          }
        });
        
        return {
          ...product,
          matchScore: score,
          matchedKeywords: [...new Set(matchedKeywords)] // Remove duplicates
        };
      });

      // Filter products with at least one match
      const filteredProducts = scoredProducts.filter(product => product.matchScore > 0);
      
      if (filteredProducts.length === 0) return [];

      // Sort by score first, then by rating, then randomize within same score groups
      const sortedProducts = filteredProducts.sort((a, b) => {
        if (b.matchScore !== a.matchScore) {
          return b.matchScore - a.matchScore; // Higher score first
        }
        if ((b.rating || 0) !== (a.rating || 0)) {
          return (b.rating || 0) - (a.rating || 0); // Higher rating first
        }
        return Math.random() - 0.5; // Random for same score and rating
      });

      // Take top 4 products and add some randomization
      const topProducts = sortedProducts.slice(0, 8); // Get more candidates
      const shuffled = [...topProducts].sort(() => Math.random() - 0.5);
      
      return shuffled.slice(0, 4); // Return 4 random products from top matches
    } catch (error) {
      console.error('Error loading step products:', error);
      return [];
    }
  }

  async function openStep(step){
    try{
      const data = stepsData[step]; if(!data) return;
      stepTitle.textContent = data.title||'Chi tiết bước';
      stepDesc.textContent = data.desc||'';
      renderList(stepHow, data.how);
      renderList(stepTips, data.tips);

      // Show loading state
      stepProducts.innerHTML = '<div class="col-12 text-center"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div><p class="small text-muted mt-2">Đang tải sản phẩm...</p></div>';
      stepProductsWrap.style.display = '';

      // Show modal first
      if (ensureModal()==='bootstrap'){ bsModal.show(); }
      else {
        modalEl.classList.add('show'); modalEl.style.display='block'; modalEl.removeAttribute('aria-hidden'); document.body.classList.add('modal-open');
        let backdrop=document.createElement('div'); backdrop.className='modal-backdrop fade show'; backdrop.setAttribute('data-fallback','1'); document.body.appendChild(backdrop);
        const closeBtn = modalEl.querySelector('[data-bs-dismiss="modal"]');
        if (closeBtn){ closeBtn.onclick=function(){ modalEl.classList.remove('show'); modalEl.style.display='none'; modalEl.setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open'); const bd=document.querySelector('.modal-backdrop[data-fallback="1"]'); if(bd) bd.remove(); } }
      }

      // Load products from API
      const apiProducts = await loadStepProducts(step);
      
      stepProducts.innerHTML = '';
      if (apiProducts && apiProducts.length > 0) {
        stepProductsWrap.style.display = '';
        apiProducts.forEach(product => {
          const col = document.createElement('div');
          col.className = 'col-6 col-lg-3';
          
          const imageUrl = product.image || '/static/image/default-product.jpg';
          const originalPrice = product.original_price ? formatPrice(product.original_price * 1000) : '';
          const discountedPrice = product.discounted_price ? formatPrice(product.discounted_price * 1000) : formatPrice(product.original_price * 1000);
          
          col.innerHTML = `
            <div class="modal-product card border-0 h-100">
              <div class="position-relative">
                <img src="${imageUrl}" alt="${product.name || ''}" class="card-img-top" style="height: 120px; object-fit: cover;" onerror="this.src='/static/image/default-product.jpg'">
                <button class="btn btn-sm btn-primary position-absolute top-0 end-0 m-1 add-to-cart-btn" 
                        data-product-id="${product.id}" 
                        style="border-radius: 50%; width: 30px; height: 30px; padding: 0; display: flex; align-items: center; justify-content: center;">
                  <i class="fas fa-plus" style="font-size: 12px;"></i>
                </button>
              </div>
              <div class="card-body p-2 d-flex flex-column">
                <div class="fw-bold small mb-1" style="font-size: 12px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${product.name || ''}</div>
                <div class="small text-muted mb-2 d-flex justify-content-between align-items-center" style="font-size: 10px;">
                  <span>${product.brand_name || ''}</span>
                  <span class="badge ${getStatusBadgeClass(product.status)}" style="font-size: 8px; padding: 2px 4px;">${getStatusText(product.status)}</span>
                </div>
                <div class="small mt-auto">
                  ${originalPrice && product.discounted_price ? `<span class="text-muted text-decoration-line-through me-1" style="font-size: 10px;">${originalPrice}</span>` : ''}
                  <span class="text-danger fw-bold" style="font-size: 13px;">${discountedPrice}</span>
                </div>
              </div>
            </div>
          `;
          stepProducts.appendChild(col);
        });

        // Add event listeners for add to cart buttons
        stepProducts.querySelectorAll('.add-to-cart-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const productId = this.getAttribute('data-product-id');
            if (productId) {
              addToCartFromSkincare(productId);
            }
          });
        });
      } else {
        // Fallback to static products if API fails
        if (data.products && data.products.length) {
          stepProductsWrap.style.display = '';
          data.products.forEach(p => {
            const col = document.createElement('div');
            col.className = 'col-6 col-lg-3';
            col.innerHTML = `
              <div class="modal-product card border-0">
                <img src="${imgPath(p.img)}" alt="${p.name || ''}" class="card-img-top" style="height: 120px; object-fit: cover;">
                <div class="card-body p-2">
                  <div class="fw-bold small mb-1">${p.name || ''}</div>
                  <div class="small text-muted mb-2 d-flex justify-content-between align-items-center" style="font-size: 10px;">
                    <span>Thương hiệu</span>
                    <span class="badge bg-success" style="font-size: 8px; padding: 2px 4px;">Mới</span>
                  </div>
                  <div class="small">
                    <span class="text-danger fw-bold">${p.price || ''}</span>
                    ${p.old ? `<span class='text-muted text-decoration-line-through ms-1'>${p.old}</span>` : ''}
                  </div>
                </div>
              </div>
            `;
            stepProducts.appendChild(col);
          });
        } else {
          stepProductsWrap.style.display = 'none';
        }
      }
    }catch(err){ console.error('Open step error:', err); alert('Xin lỗi, không thể mở chi tiết. Vui lòng tải lại trang.'); }
  }

  document.querySelectorAll('.step[data-step]').forEach(card=>{
    const handler = ()=> openStep(card.getAttribute('data-step'));
    card.addEventListener('click', handler);
    card.addEventListener('keypress', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); handler(); } });
  });

  document.querySelectorAll('.faq-q').forEach(q=> q.addEventListener('click', ()=> q.parentElement.classList.toggle('active')));
})();
</script>
{% endblock %}
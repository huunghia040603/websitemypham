{% extends "admin_base.html" %}

{% block title %}Quản lý Số may mắn - Admin{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12 mb-3">
    <h1 class="h4"><i class="fas fa-clover me-2 text-success"></i>Quản lý Sự kiện Số may mắn</h1>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-4">
    <div class="card h-100 glass">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Sự kiện hiện tại</strong>
        <button id="btnReloadEvent" class="btn btn-sm btn-outline-secondary"><i class="fas fa-rotate"></i></button>
      </div>
      <div class="card-body" id="currentEventBox">
        <div class="text-muted">Đang tải...</div>
      </div>
      <div class="card-footer d-flex gap-2">
        <button id="btnFinalize" class="btn btn-danger btn-sm"><i class="fas fa-flag-checkered me-1"></i>Chốt kết quả</button>
        <button id="btnActivate" class="btn btn-primary btn-sm"><i class="fas fa-toggle-on me-1"></i>Bật/Tắt</button>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card h-100 glass">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
        <div class="d-flex align-items-center gap-2">
          <strong>Người tham gia</strong>
          <span class="badge bg-primary" id="participantsCount">0</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button id="btnViewDetails" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#participantDetailsModal">
              <i class="fas fa-eye me-1"></i>Chi tiết
            </button>
            <button id="btnCopyAllPhones" class="btn btn-outline-warning btn-sm">
              <i class="fas fa-copy me-1"></i>Copy SĐT
            </button>
            <button id="btnCopyAllEmails" class="btn btn-outline-secondary btn-sm">
              <i class="fas fa-envelope me-1"></i>Copy Email
            </button>
            <button id="btnExportCSV" class="btn btn-outline-success btn-sm">
              <i class="fas fa-file-excel me-1"></i>Excel
            </button>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <div class="input-group input-group-sm" style="width: 220px;">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input id="searchPhone" type="text" class="form-control" placeholder="Tìm theo SĐT">
          </div>
          <div class="input-group input-group-sm" style="width: 140px;">
            <span class="input-group-text"><i class="fas fa-dice"></i></span>
            <input id="searchNumber" type="text" maxlength="2" class="form-control" placeholder="Số (00-99)" inputmode="numeric" pattern="[0-9]*">
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="toggleMask" checked>
            <label class="form-check-label small" for="toggleMask">Ẩn SĐT</label>
          </div>
        </div>
      </div>
      <div class="card-body p-0" style="max-height: 420px; overflow:auto;">
        <table class="table table-sm mb-0">
          <thead class="table-light sticky-top">
            <tr>
              <th>Tên</th>
              <th>SĐT</th>
              <th>Email</th>
              <th>Số</th>
              <th>Gửi lúc</th>
            </tr>
          </thead>
          <tbody id="participantsTable">
            <tr><td colspan="5" class="text-center text-muted py-3">Đang tải...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Giải thưởng</strong>
        <button id="btnReloadPrizes" class="btn btn-sm btn-outline-secondary"><i class="fas fa-rotate"></i></button>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Tên</th>
              <th>Giá trị</th>
            </tr>
          </thead>
          <tbody id="prizesTable">
            <tr><td colspan="3" class="text-center text-muted py-3">Đang tải...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal xem chi tiết khách hàng -->
<div class="modal fade" id="participantDetailsModal" tabindex="-1" aria-labelledby="participantDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="participantDetailsModalLabel">
          <i class="fas fa-users me-2"></i>Chi tiết khách hàng tham gia
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
              <input type="text" class="form-control" id="modalSearchPhone" placeholder="Tìm theo SĐT...">
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-dice"></i></span>
              <input type="text" class="form-control" id="modalSearchNumber" placeholder="Tìm theo số may mắn..." maxlength="2">
            </div>
          </div>
        </div>
        
        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
          <table class="table table-hover">
            <thead class="table-light sticky-top">
              <tr>
                <th width="4%"><input type="checkbox" id="modalSelectAll"></th>
                <th width="5%">#</th>
                <th width="20%">Tên</th>
                <th width="15%">SĐT</th>
                <th width="20%">Email</th>
                <th width="30%">Địa chỉ</th>
                <th width="5%">Số</th>
                <th width="5%">Thao tác</th>
              </tr>
            </thead>
            <tbody id="participantDetailsTable">
              <tr><td colspan="8" class="text-center text-muted py-3">Đang tải...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <div class="d-flex justify-content-between w-100">
          <div>
            <button type="button" class="btn btn-outline-warning btn-sm" id="modalCopyAllPhones">
              <i class="fas fa-copy me-1"></i>Copy tất cả SĐT
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="modalCopyAllEmails">
              <i class="fas fa-envelope me-1"></i>Copy tất cả Email
            </button>
          </div>
          <div>
            <button type="button" class="btn btn-outline-success btn-sm" id="modalExportExcel">
              <i class="fas fa-file-excel me-1"></i>Xuất Excel
            </button>
            <button type="button" class="btn btn-outline-danger btn-sm" id="modalDeleteSelected">
              <i class="fas fa-trash me-1"></i>Xóa đã chọn
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Winners full-width row -->
<div class="row mt-3">
  <div class="col-12">
    <div class="card glass">
      <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2">
          <strong>Người trúng thưởng</strong>
          <span id="winnersCount" class="badge bg-success">0</span>
        </div>
        <div class="d-flex align-items-center gap-2">
          <div class="form-check form-switch m-0">
            <input class="form-check-input" type="checkbox" role="switch" id="toggleMaskWinners" checked>
            <label class="form-check-label small" for="toggleMaskWinners">Ẩn SĐT</label>
          </div>
          <button id="btnReloadWinners" class="btn btn-sm btn-outline-secondary"><i class="fas fa-rotate"></i></button>
        </div>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0 winners-table align-middle">
          <thead class="table-light sticky-top">
            <tr>
              <th style="width:10%">Tên</th>
              <th style="width:8%">SĐT</th>
              <th style="width:12%">Email</th>
              <th style="width:6%">Số</th>
              <th style="width:20%">Giải</th>
              <th style="width:18%">Địa chỉ</th>
              <th style="width:8%">Thời gian</th>
              <th style="width:18%">Lời chúc</th>
            </tr>
          </thead>
          <tbody id="winnersTable">
            <tr><td colspan="8" class="text-center text-muted py-3">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const API = 'https://buddyskincare.pythonanywhere.com';

async function fetchJson(url, opts={}) {
  const res = await fetch(url, opts);
  if (!res.ok) throw new Error('HTTP ' + res.status);
  return res.json();
}

function fmtMoney(v) {
  const n = Number(v) || 0;
  return new Intl.NumberFormat('vi-VN', {style:'currency', currency:'VND'}).format(n);
}

async function loadCurrentEvent() {
  const box = document.getElementById('currentEventBox');
  try {
    const events = await fetchJson(`${API}/lucky-events/`);
    const event = Array.isArray(events) && events.length ? events[0] : null;
    if (!event) { box.innerHTML = '<div class="text-muted">Chưa có sự kiện</div>'; return; }
    const statusBadge = document.getElementById('eventStatusBadge');
    if (statusBadge) {
      statusBadge.className = `badge rounded-pill ${event.is_active ? 'bg-success':'bg-secondary'}`;
      statusBadge.textContent = event.is_active ? 'Đang hoạt động' : 'Tạm tắt';
    }
    document.getElementById('statActive') && (document.getElementById('statActive').textContent = event.is_active ? 'ON' : 'OFF');
    document.getElementById('statLucky') && (document.getElementById('statLucky').textContent = event.lucky_number || '--');
    document.getElementById('statPrize') && (document.getElementById('statPrize').textContent = (event.prizes||[]).length);

    box.innerHTML = `
      <div class="mb-2 d-flex align-items-center justify-content-between">
        <strong>${event.title}</strong>
        ${event.lucky_number ? `<span class="badge bg-info text-dark">Kết quả: ${event.lucky_number}</span>`:''}
      </div>
      <div class="text-muted small">${event.description || ''}</div>
      <div class="mt-3 small">
        <div class="mb-1"><i class="far fa-clock me-1"></i><strong>Bắt đầu:</strong> ${new Date(event.start_at).toLocaleString('vi-VN')}</div>
        <div><i class="far fa-calendar me-1"></i><strong>Kết thúc:</strong> ${new Date(event.end_at).toLocaleString('vi-VN')}</div>
      </div>`;
    box.dataset.eventId = event.id;
    await loadParticipants(event.id);
    renderPrizes(event.prizes || []);
    await loadWinnersAdmin(event.id);
  } catch (e) {
    box.innerHTML = '<div class="text-danger">Lỗi tải sự kiện</div>'
  }
}

let allParticipantsCache = [];
async function loadParticipants(eventId) {
  const tbody = document.getElementById('participantsTable');
  try {
    const list = await fetchJson(`${API}/lucky-participants/?event=${eventId}`);
    allParticipantsCache = list;
    document.getElementById('participantsCount').textContent = list.length;
    if (!list.length) { tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">Chưa có người tham gia</td></tr>'; return; }
    tbody.innerHTML = list.map(p => rowHtml(p)).join('');
  } catch (e) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-danger text-center">Lỗi tải danh sách</td></tr>';
  }
}

function rowHtml(p) {
  const mask = document.getElementById('toggleMask')?.checked;
  const phone = String(p.zalo_phone||'');
  const masked = mask && phone.length >= 9 ? (phone.substring(0,3) + ' xxxx ' + phone.substring(phone.length-3)) : phone;
  const email = String(p.email||'');
  const maskedEmail = mask && email ? (email.split('@')[0].substring(0,2) + '***@' + email.split('@')[1]) : email;
  return `
      <tr>
        <td class="fw-semibold">${p.name || ''}</td>
        <td>${masked}</td>
        <td class="small">${maskedEmail}</td>
        <td><span class="badge bg-dark">${String(p.chosen_number||'').padStart(2,'0')}</span></td>
        <td class="text-muted small">${new Date(p.submitted_at).toLocaleString('vi-VN')}</td>
      </tr>`;
}

function renderPrizes(prizes) {
  const tbody = document.getElementById('prizesTable');
  if (!prizes || !prizes.length) { tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Chưa có phần thưởng</td></tr>'; return; }
  tbody.innerHTML = prizes.map((pr, idx) => `
    <tr>
      <td>${idx+1}</td>
      <td>${pr.name}</td>
      <td>${fmtMoney((parseFloat(pr.value)||0))}</td>
    </tr>
  `).join('');
}

async function loadWinnersAdmin(eventId){
  const tbody = document.getElementById('winnersTable');
  if (!tbody) return;
  try{
    const list = await fetchJson(`${API}/lucky-winners/?event=${eventId}`);
    if (!list || list.length===0){
      tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-3">Chưa có dữ liệu</td></tr>';
      return;
    }
    const countEl = document.getElementById('winnersCount');
    if (countEl) countEl.textContent = list.length;
    tbody.innerHTML = list.map(w => {
      const p = w.participant || {};
      const prize = w.prize || {};
      const phone = p.zalo_phone || '';
      const email = p.email || '';
      const mask = document.getElementById('toggleMaskWinners')?.checked;
      const masked = mask && phone && phone.length>=9 ? (phone.substring(0,3)+' xxxx '+phone.substring(phone.length-3)) : phone;
      const maskedEmail = mask && email ? (email.split('@')[0].substring(0,2) + '***@' + email.split('@')[1]) : email;
      return `
        <tr>
          <td>${p.name || ''}</td>
          <td>${masked}</td>
          <td class="small">${maskedEmail}</td>
          <td><span class="badge bg-dark">${String(p.chosen_number||'').padStart(2,'0')}</span></td>
          <td>${prize.name || '-'}</td>
          <td>${p.address || '-'}</td>
        <td class="text-muted small">${p.submitted_at ? new Date(p.submitted_at).toLocaleString('vi-VN') : '-'}</td>
          <td>${p.message || '-'}</td>
        </tr>
      `;
    }).join('');
  }catch(e){
    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger py-3">Lỗi tải danh sách trúng thưởng</td></tr>';
  }
}

async function finalizeEvent() {
  const eventId = document.getElementById('currentEventBox').dataset.eventId;
  if (!eventId) return;
  const manual = prompt('Nhập số may mắn (2 số) để chốt (tùy chọn):');
  try {
    const res = await fetch(`${API}/lucky-events/${eventId}/finalize/`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ lucky_number: manual })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail||'Finalize failed');
    alert('Đã chốt kết quả!');
    loadCurrentEvent();
  } catch (e) { alert('Lỗi chốt kết quả: ' + e.message); }
}

// Function để load chi tiết khách hàng vào modal
function loadParticipantDetails() {
  const tbody = document.getElementById('participantDetailsTable');
  if (!tbody) return;
  
  tbody.innerHTML = allParticipantsCache.length ? 
    allParticipantsCache.map((p, idx) => modalRowHtml(p, idx + 1)).join('') : 
    '<tr><td colspan="8" class="text-center text-muted py-3">Chưa có dữ liệu</td></tr>';
}

// Function để tạo HTML cho row trong modal
function modalRowHtml(p, index) {
  return `
    <tr>
      <td><input type="checkbox" class="modal-cb" data-id="${p.id}"></td>
      <td>${index}</td>
      <td class="fw-semibold">${p.name || ''}</td>
      <td>
        <span class="text-primary">${p.zalo_phone || ''}</span>
        <button class="btn btn-sm btn-outline-primary ms-1" onclick="copyToClipboard('${p.zalo_phone || ''}')" title="Copy SĐT">
          <i class="fas fa-copy"></i>
        </button>
      </td>
      <td>
        <span class="text-info">${p.email || ''}</span>
        <button class="btn btn-sm btn-outline-info ms-1" onclick="copyToClipboard('${p.email || ''}')" title="Copy Email">
          <i class="fas fa-copy"></i>
        </button>
      </td>
      <td class="small">${p.address || ''}</td>
      <td><span class="badge bg-dark">${String(p.chosen_number||'').padStart(2,'0')}</span></td>
      <td>
        <div class="btn-group" role="group">
          <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('${p.name || ''} - ${p.zalo_phone || ''} - ${p.email || ''} - ${p.address || ''}')" title="Copy tất cả thông tin">
            <i class="fas fa-copy"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteParticipant(${p.id})" title="Xóa người tham gia">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </td>
    </tr>
  `;
}

// Function để copy text vào clipboard
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    // Tạo toast notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">
            <i class="fas fa-check-circle me-2"></i>Đã copy vào clipboard!
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    `;
    document.body.appendChild(toast);
    
    // Auto remove sau 3 giây
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 3000);
  }).catch(() => {
    // Fallback cho trình duyệt cũ
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    alert('Đã copy vào clipboard!');
  });
}

document.addEventListener('DOMContentLoaded', () => {
  loadCurrentEvent();
  document.getElementById('btnReloadEvent').addEventListener('click', loadCurrentEvent);
  document.getElementById('btnReloadPrizes').addEventListener('click', loadCurrentEvent);
  document.getElementById('btnReloadWinners')?.addEventListener('click', () => {
    const id = document.getElementById('currentEventBox').dataset.eventId;
    if (id) loadWinnersAdmin(id);
  });
  document.getElementById('toggleMaskWinners')?.addEventListener('change', () => {
    const id = document.getElementById('currentEventBox').dataset.eventId;
    if (id) loadWinnersAdmin(id);
  });
  document.getElementById('btnFinalize').addEventListener('click', finalizeEvent);
  document.getElementById('toggleMask')?.addEventListener('change', () => {
    const tbody = document.getElementById('participantsTable');
    tbody.innerHTML = allParticipantsCache.length ? allParticipantsCache.map(p => rowHtml(p)).join('') : tbody.innerHTML;
  });
  let t1, t2; // debounce
  const applyFilters = () => {
    const qPhone = (document.getElementById('searchPhone')?.value || '').trim();
    const qNumRaw = (document.getElementById('searchNumber')?.value || '').replace(/\D/g,'').slice(0,2);
    if (document.getElementById('searchNumber')) document.getElementById('searchNumber').value = qNumRaw;
    let list = allParticipantsCache;
    if (qPhone) list = list.filter(p => (p.zalo_phone||'').includes(qPhone));
    if (qNumRaw) {
      const qNum = qNumRaw.padStart(2,'0');
      list = list.filter(p => String(p.chosen_number||'').padStart(2,'0') === qNum);
    }
    const tbody = document.getElementById('participantsTable');
    tbody.innerHTML = list.length ? list.map(p => rowHtml(p)).join('') : '<tr><td colspan="4" class="text-center text-muted py-3">Không tìm thấy</td></tr>';
  };
  document.getElementById('searchPhone')?.addEventListener('input', () => {
    clearTimeout(t1); t1 = setTimeout(applyFilters, 250);
  });
  document.getElementById('searchNumber')?.addEventListener('input', () => {
    clearTimeout(t2); t2 = setTimeout(applyFilters, 200);
  });
  document.getElementById('btnExportCSV')?.addEventListener('click', () => {
    // Tạo header
    const headers = ['Tên', 'SĐT', 'Email', 'Số may mắn', 'Thời gian gửi'];
    
    // Tạo dữ liệu
    const data = allParticipantsCache.map(p => [
      p.name || '',
      `="${p.zalo_phone || ''}"`, // Sử dụng ="..." để Excel hiểu là text
      p.email || '',
      String(p.chosen_number || '').padStart(2, '0'),
      new Date(p.submitted_at).toLocaleString('vi-VN')
    ]);
    
    // Tạo HTML table để Excel có thể import đúng
    const htmlContent = `
      <html xmlns:o="urn:schemas-microsoft-com:office:office" 
            xmlns:x="urn:schemas-microsoft-com:office:excel" 
            xmlns="http://www.w3.org/TR/REC-html40">
      <head>
        <meta charset="utf-8">
        <meta name="ExcelCreated" content="1">
        <!--[if gte mso 9]><xml>
          <x:ExcelWorkbook>
            <x:ExcelWorksheets>
              <x:ExcelWorksheet>
                <x:Name>Danh sách tham gia</x:Name>
                <x:WorksheetOptions>
                  <x:DefaultRowHeight>285</x:DefaultRowHeight>
                </x:WorksheetOptions>
              </x:ExcelWorksheet>
            </x:ExcelWorksheets>
          </x:ExcelWorkbook>
        </xml><![endif]-->
      </head>
      <body>
        <table>
          <tr>
            ${headers.map(h => `<th style="background-color: #4472C4; color: white; font-weight: bold; padding: 8px; border: 1px solid #000;">${h}</th>`).join('')}
          </tr>
          ${data.map(row => `
            <tr>
                ${row.map(cell => `<td style="padding: 4px; border: 1px solid #ccc;">${cell}</td>`).join('')}
            </tr>
          `).join('')}
        </table>
      </body>
      </html>
    `;
    
    const blob = new Blob([htmlContent], { type: 'application/vnd.ms-excel' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'lucky_participants.xls';
    a.click();
    URL.revokeObjectURL(url);
  });

  // Copy tất cả SĐT
  document.getElementById('btnCopyAllPhones')?.addEventListener('click', () => {
    const phones = allParticipantsCache.map(p => p.zalo_phone || '').filter(phone => phone.trim());
    const phoneText = phones.join('\n');
    navigator.clipboard.writeText(phoneText).then(() => {
      alert(`Đã copy ${phones.length} số điện thoại vào clipboard!`);
    }).catch(() => {
      // Fallback cho trình duyệt cũ
      const textArea = document.createElement('textarea');
      textArea.value = phoneText;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      alert(`Đã copy ${phones.length} số điện thoại vào clipboard!`);
    });
  });

  // Copy tất cả Email
  document.getElementById('btnCopyAllEmails')?.addEventListener('click', () => {
    const emails = allParticipantsCache.map(p => p.email || '').filter(email => email.trim());
    const emailText = emails.join('\n');
    navigator.clipboard.writeText(emailText).then(() => {
      alert(`Đã copy ${emails.length} email vào clipboard!`);
    }).catch(() => {
      // Fallback cho trình duyệt cũ
      const textArea = document.createElement('textarea');
      textArea.value = emailText;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      alert(`Đã copy ${emails.length} email vào clipboard!`);
    });
  });

  // Load chi tiết khách hàng vào modal
  document.getElementById('btnViewDetails')?.addEventListener('click', () => {
    loadParticipantDetails();
  });

  // Copy SĐT trong modal
  document.getElementById('modalCopyAllPhones')?.addEventListener('click', () => {
    const phones = allParticipantsCache.map(p => p.zalo_phone || '').filter(phone => phone.trim());
    const phoneText = phones.join('\n');
    navigator.clipboard.writeText(phoneText).then(() => {
      alert(`Đã copy ${phones.length} số điện thoại vào clipboard!`);
    }).catch(() => {
      const textArea = document.createElement('textarea');
      textArea.value = phoneText;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      alert(`Đã copy ${phones.length} số điện thoại vào clipboard!`);
    });
  });

  // Copy Email trong modal
  document.getElementById('modalCopyAllEmails')?.addEventListener('click', () => {
    const emails = allParticipantsCache.map(p => p.email || '').filter(email => email.trim());
    const emailText = emails.join('\n');
    navigator.clipboard.writeText(emailText).then(() => {
      alert(`Đã copy ${emails.length} email vào clipboard!`);
    }).catch(() => {
      const textArea = document.createElement('textarea');
      textArea.value = emailText;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      alert(`Đã copy ${emails.length} email vào clipboard!`);
    });
  });

  // Xuất Excel trong modal
  document.getElementById('modalExportExcel')?.addEventListener('click', () => {
    // Tạo header chi tiết
    const headers = ['STT', 'Tên', 'SĐT', 'Email', 'Địa chỉ', 'Số may mắn', 'Thời gian gửi', 'Lời chúc'];
    
    // Tạo dữ liệu chi tiết
    const data = allParticipantsCache.map((p, idx) => [
      idx + 1,
      p.name || '',
      `="${p.zalo_phone || ''}"`, // Sử dụng ="..." để Excel hiểu là text
      p.email || '',
      p.address || '',
      String(p.chosen_number || '').padStart(2, '0'),
      new Date(p.submitted_at).toLocaleString('vi-VN'),
      p.message || ''
    ]);
    
    // Tạo HTML table để Excel có thể import đúng
    const htmlContent = `
      <html xmlns:o="urn:schemas-microsoft-com:office:office" 
            xmlns:x="urn:schemas-microsoft-com:office:excel" 
            xmlns="http://www.w3.org/TR/REC-html40">
      <head>
        <meta charset="utf-8">
        <meta name="ExcelCreated" content="1">
        <!--[if gte mso 9]><xml>
          <x:ExcelWorkbook>
            <x:ExcelWorksheets>
              <x:ExcelWorksheet>
                <x:Name>Chi tiết tham gia</x:Name>
                <x:WorksheetOptions>
                  <x:DefaultRowHeight>285</x:DefaultRowHeight>
                </x:WorksheetOptions>
              </x:ExcelWorksheet>
            </x:ExcelWorksheets>
          </x:ExcelWorkbook>
        </xml><![endif]-->
      </head>
      <body>
        <table>
          <tr>
            ${headers.map(h => `<th style="background-color: #4472C4; color: white; font-weight: bold; padding: 8px; border: 1px solid #000;">${h}</th>`).join('')}
          </tr>
          ${data.map(row => `
            <tr>
                ${row.map(cell => `<td style="padding: 4px; border: 1px solid #ccc;">${cell}</td>`).join('')}
            </tr>
          `).join('')}
        </table>
      </body>
      </html>
    `;
    
    const blob = new Blob([htmlContent], { type: 'application/vnd.ms-excel' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'lucky_participants_detailed.xls';
    a.click();
    URL.revokeObjectURL(url);
  });

  // Tìm kiếm trong modal
  let modalT1, modalT2;
  const applyModalFilters = () => {
    const qPhone = (document.getElementById('modalSearchPhone')?.value || '').trim();
    const qNumRaw = (document.getElementById('modalSearchNumber')?.value || '').replace(/\D/g,'').slice(0,2);
    if (document.getElementById('modalSearchNumber')) document.getElementById('modalSearchNumber').value = qNumRaw;
    let list = allParticipantsCache;
    if (qPhone) list = list.filter(p => (p.zalo_phone||'').includes(qPhone));
    if (qNumRaw) {
      const qNum = qNumRaw.padStart(2,'0');
      list = list.filter(p => String(p.chosen_number||'').padStart(2,'0') === qNum);
    }
    const tbody = document.getElementById('participantDetailsTable');
    tbody.innerHTML = list.length ? list.map((p, idx) => modalRowHtml(p, idx + 1)).join('') : '<tr><td colspan="7" class="text-center text-muted py-3">Không tìm thấy</td></tr>';
  };

  document.getElementById('modalSearchPhone')?.addEventListener('input', () => {
    clearTimeout(modalT1); modalT1 = setTimeout(applyModalFilters, 250);
  });
  document.getElementById('modalSearchNumber')?.addEventListener('input', () => {
    clearTimeout(modalT2); modalT2 = setTimeout(applyModalFilters, 200);
  });
  // Select all in modal
  document.getElementById('modalSelectAll')?.addEventListener('change', (e) => {
    const checked = e.target.checked;
    document.querySelectorAll('.modal-cb').forEach(cb => cb.checked = checked);
  });
  // Bulk delete
  document.getElementById('modalDeleteSelected')?.addEventListener('click', deleteSelectedParticipants);
});

// Xóa người tham gia
async function deleteParticipant(id){
  try{
    if(!id) return;
    if(!confirm('Xóa người tham gia này?')) return;
    const res = await fetch(`${API}/lucky-participants/${id}/`, { method: 'DELETE' });
    if(res.status === 204){
      // Cập nhật cache và giao diện
      allParticipantsCache = (allParticipantsCache||[]).filter(p => p.id !== id);
      const countEl = document.getElementById('participantsCount');
      if (countEl) countEl.textContent = allParticipantsCache.length;
      const tbody = document.getElementById('participantsTable');
      if (tbody) tbody.innerHTML = allParticipantsCache.length ? allParticipantsCache.map(p => rowHtml(p)).join('') : '<tr><td colspan="5" class="text-center text-muted py-3">Chưa có người tham gia</td></tr>';
      // Cập nhật modal nếu đang mở
      const modalTbody = document.getElementById('participantDetailsTable');
      if (modalTbody) loadParticipantDetails();
      alert('Đã xóa');
    }else{
      const text = await res.text();
      alert('Xóa thất bại: ' + (text||res.status));
    }
  }catch(e){
    alert('Lỗi xóa: ' + e.message);
  }
}

// Bulk delete participants (modal)
async function deleteSelectedParticipants(){
  const ids = Array.from(document.querySelectorAll('.modal-cb:checked'))
    .map(cb => parseInt(cb.getAttribute('data-id')))
    .filter(Boolean);
  if (!ids.length){ alert('Chưa chọn người tham gia nào'); return; }
  if (!confirm(`Xóa ${ids.length} người tham gia đã chọn?`)) return;
  let ok = 0;
  for (const id of ids){
    try{
      const res = await fetch(`${API}/lucky-participants/${id}/`, { method: 'DELETE' });
      if (res.status === 204) ok++;
    }catch(e){ /* ignore */ }
  }
  if (ok){
    allParticipantsCache = (allParticipantsCache||[]).filter(p => !ids.includes(p.id));
    const countEl = document.getElementById('participantsCount');
    if (countEl) countEl.textContent = allParticipantsCache.length;
    const tbody = document.getElementById('participantsTable');
    if (tbody) tbody.innerHTML = allParticipantsCache.length ? allParticipantsCache.map(p => rowHtml(p)).join('') : '<tr><td colspan="5" class="text-center text-muted py-3">Chưa có người tham gia</td></tr>';
    loadParticipantDetails();
    const selAll = document.getElementById('modalSelectAll'); if (selAll) selAll.checked = false;
    alert(`Đã xóa ${ok}/${ids.length}`);
  }else{
    alert('Xóa thất bại');
  }
}
</script>
{% endblock %}

{% block extra_css %}
<style>
/* Modern admin styles for Lucky Number */
.glass{background:linear-gradient(180deg, rgba(255,255,255,.7), rgba(255,255,255,.9));backdrop-filter:blur(8px);border:1px solid rgba(0,0,0,.06);box-shadow:0 8px 24px rgba(16,24,40,.06);border-radius:14px}

.stat-chip{background:linear-gradient(135deg,#f8fafc,#eef2f7);border:1px solid rgba(0,0,0,.06);border-radius:12px;padding:10px 12px;box-shadow:0 4px 12px rgba(16,24,40,.06)}
.stat-chip .chip-label{font-size:12px;color:#6b7280}
.stat-chip .chip-value{font-weight:800;font-size:18px;color:#111827}
.chip-green{background:linear-gradient(135deg,#ecfdf5,#e7f9f0)}
.chip-amber{background:linear-gradient(135deg,#fff7ed,#fff3e0)}
.chip-blue{background:linear-gradient(135deg,#eff6ff,#e9f0ff)}

.table thead.sticky-top{top:0;z-index:5;box-shadow:0 2px 8px rgba(16,24,40,.06)}
.table-hover tbody tr:hover{background:#f8fafc}

.badge.rounded-pill{padding:.45em .75em;font-weight:700}

.btn-outline-primary,.btn-outline-secondary,.btn-danger{border-radius:10px}
.btn-outline-primary:hover,.btn-outline-secondary:hover{transform:translateY(-1px)}

/* Inputs */
.input-group .form-control{border-radius: 0 .5rem .5rem 0}
.input-group .input-group-text{border-radius:.5rem 0 0 .5rem}

/* Scroll area */
.card-body[style*="overflow:auto"]::-webkit-scrollbar{width:6px;height:6px}
.card-body[style*="overflow:auto"]::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:999px}
.card-body[style*="overflow:auto"]::-webkit-scrollbar-track{background:#f1f5f9;border-radius:999px}

/* Winners table compact, smaller font */
.winners-table{font-size:12px}
.winners-table td, .winners-table th{padding:.5rem .6rem}
.winners-table .badge{font-size:.75rem}

/* Toast notification */
.toast-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
  min-width: 300px;
}

/* Modal styles */
.modal-xl {
  max-width: 90%;
}

.modal-body .table th {
  background-color: #f8f9fa;
  font-weight: 600;
  font-size: 0.875rem;
}

.modal-body .table td {
  font-size: 0.875rem;
  vertical-align: middle;
}

.modal-body .table .btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
}

</style>
{% endblock %}


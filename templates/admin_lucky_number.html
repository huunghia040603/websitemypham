{% extends "admin_base.html" %}

{% block title %}Quản lý Số may mắn - Admin{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12 mb-3">
    <h1 class="h4"><i class="fas fa-clover me-2 text-success"></i>Quản lý Sự kiện Số may mắn</h1>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-4">
    <div class="card h-100 glass">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Sự kiện hiện tại</strong>
        <button id="btnReloadEvent" class="btn btn-sm btn-outline-secondary"><i class="fas fa-rotate"></i></button>
      </div>
      <div class="card-body" id="currentEventBox">
        <div class="text-muted">Đang tải...</div>
      </div>
      <div class="card-footer d-flex gap-2">
        <button id="btnFinalize" class="btn btn-danger btn-sm"><i class="fas fa-flag-checkered me-1"></i>Chốt kết quả</button>
        <button id="btnActivate" class="btn btn-primary btn-sm"><i class="fas fa-toggle-on me-1"></i>Bật/Tắt</button>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card h-100 glass">
      <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2">
          <strong>Người tham gia</strong>
          <span class="badge bg-primary" id="participantsCount">0</span>
        </div>
        <div class="d-flex align-items-center gap-2">
          <div class="input-group input-group-sm" style="width: 220px;">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input id="searchPhone" type="text" class="form-control" placeholder="Tìm theo SĐT">
          </div>
          <div class="input-group input-group-sm" style="width: 140px;">
            <span class="input-group-text"><i class="fas fa-dice"></i></span>
            <input id="searchNumber" type="text" maxlength="2" class="form-control" placeholder="Số (00-99)" inputmode="numeric" pattern="[0-9]*">
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="toggleMask" checked>
            <label class="form-check-label small" for="toggleMask">Ẩn SĐT</label>
          </div>
        </div>
      </div>
      <div class="card-body p-0" style="max-height: 420px; overflow:auto;">
        <table class="table table-sm mb-0">
          <thead class="table-light sticky-top">
            <tr>
              <th>Tên</th>
              <th>SĐT</th>
              <th>Số</th>
              <th>Gửi lúc</th>
            </tr>
          </thead>
          <tbody id="participantsTable">
            <tr><td colspan="4" class="text-center text-muted py-3">Đang tải...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Giải thưởng</strong>
        <button id="btnReloadPrizes" class="btn btn-sm btn-outline-secondary"><i class="fas fa-rotate"></i></button>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Tên</th>
              <th>Giá trị</th>
            </tr>
          </thead>
          <tbody id="prizesTable">
            <tr><td colspan="3" class="text-center text-muted py-3">Đang tải...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<!-- Winners full-width row -->
<div class="row mt-3">
  <div class="col-12">
    <div class="card glass">
      <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2">
          <strong>Người trúng thưởng</strong>
          <span id="winnersCount" class="badge bg-success">0</span>
        </div>
        <div class="d-flex align-items-center gap-2">
          <div class="form-check form-switch m-0">
            <input class="form-check-input" type="checkbox" role="switch" id="toggleMaskWinners" checked>
            <label class="form-check-label small" for="toggleMaskWinners">Ẩn SĐT</label>
          </div>
          <button id="btnReloadWinners" class="btn btn-sm btn-outline-secondary"><i class="fas fa-rotate"></i></button>
        </div>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0 winners-table align-middle">
          <thead class="table-light sticky-top">
            <tr>
              <th style="width:12%">Tên</th>
              <th style="width:10%">SĐT</th>
              <th style="width:6%">Số</th>
              <th style="width:24%">Giải</th>
              <th style="width:22%">Địa chỉ</th>
              <th style="width:10%">Thời gian</th>
              <th style="width:22%">Lời chúc</th>
            </tr>
          </thead>
          <tbody id="winnersTable">
            <tr><td colspan="7" class="text-center text-muted py-3">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const API = 'https://buddyskincare.pythonanywhere.com';

async function fetchJson(url, opts={}) {
  const res = await fetch(url, opts);
  if (!res.ok) throw new Error('HTTP ' + res.status);
  return res.json();
}

function fmtMoney(v) {
  const n = Number(v) || 0;
  return new Intl.NumberFormat('vi-VN', {style:'currency', currency:'VND'}).format(n);
}

async function loadCurrentEvent() {
  const box = document.getElementById('currentEventBox');
  try {
    const events = await fetchJson(`${API}/lucky-events/`);
    const event = Array.isArray(events) && events.length ? events[0] : null;
    if (!event) { box.innerHTML = '<div class="text-muted">Chưa có sự kiện</div>'; return; }
    const statusBadge = document.getElementById('eventStatusBadge');
    if (statusBadge) {
      statusBadge.className = `badge rounded-pill ${event.is_active ? 'bg-success':'bg-secondary'}`;
      statusBadge.textContent = event.is_active ? 'Đang hoạt động' : 'Tạm tắt';
    }
    document.getElementById('statActive') && (document.getElementById('statActive').textContent = event.is_active ? 'ON' : 'OFF');
    document.getElementById('statLucky') && (document.getElementById('statLucky').textContent = event.lucky_number || '--');
    document.getElementById('statPrize') && (document.getElementById('statPrize').textContent = (event.prizes||[]).length);

    box.innerHTML = `
      <div class="mb-2 d-flex align-items-center justify-content-between">
        <strong>${event.title}</strong>
        ${event.lucky_number ? `<span class="badge bg-info text-dark">Kết quả: ${event.lucky_number}</span>`:''}
      </div>
      <div class="text-muted small">${event.description || ''}</div>
      <div class="mt-3 small">
        <div class="mb-1"><i class="far fa-clock me-1"></i><strong>Bắt đầu:</strong> ${new Date(event.start_at).toLocaleString('vi-VN')}</div>
        <div><i class="far fa-calendar me-1"></i><strong>Kết thúc:</strong> ${new Date(event.end_at).toLocaleString('vi-VN')}</div>
      </div>`;
    box.dataset.eventId = event.id;
    await loadParticipants(event.id);
    renderPrizes(event.prizes || []);
    await loadWinnersAdmin(event.id);
  } catch (e) {
    box.innerHTML = '<div class="text-danger">Lỗi tải sự kiện</div>'
  }
}

let allParticipantsCache = [];
async function loadParticipants(eventId) {
  const tbody = document.getElementById('participantsTable');
  try {
    const list = await fetchJson(`${API}/lucky-participants/?event=${eventId}`);
    allParticipantsCache = list;
    document.getElementById('participantsCount').textContent = list.length;
    if (!list.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">Chưa có người tham gia</td></tr>'; return; }
    tbody.innerHTML = list.map(p => rowHtml(p)).join('');
  } catch (e) {
    tbody.innerHTML = '<tr><td colspan="4" class="text-danger text-center">Lỗi tải danh sách</td></tr>';
  }
}

function rowHtml(p) {
  const mask = document.getElementById('toggleMask')?.checked;
  const phone = String(p.zalo_phone||'');
  const masked = mask && phone.length >= 9 ? (phone.substring(0,3) + ' xxxx ' + phone.substring(phone.length-3)) : phone;
  return `
      <tr>
        <td class="fw-semibold">${p.name || ''}</td>
        <td>${masked}</td>
        <td><span class="badge bg-dark">${String(p.chosen_number||'').padStart(2,'0')}</span></td>
        <td class="text-muted small">${new Date(p.submitted_at).toLocaleString('vi-VN')}</td>
      </tr>`;
}

function renderPrizes(prizes) {
  const tbody = document.getElementById('prizesTable');
  if (!prizes || !prizes.length) { tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Chưa có phần thưởng</td></tr>'; return; }
  tbody.innerHTML = prizes.map((pr, idx) => `
    <tr>
      <td>${idx+1}</td>
      <td>${pr.name}</td>
      <td>${fmtMoney((parseFloat(pr.value)||0))}</td>
    </tr>
  `).join('');
}

async function loadWinnersAdmin(eventId){
  const tbody = document.getElementById('winnersTable');
  if (!tbody) return;
  try{
    const list = await fetchJson(`${API}/lucky-winners/?event=${eventId}`);
    if (!list || list.length===0){
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-3">Chưa có dữ liệu</td></tr>';
      return;
    }
    const countEl = document.getElementById('winnersCount');
    if (countEl) countEl.textContent = list.length;
    tbody.innerHTML = list.map(w => {
      const p = w.participant || {};
      const prize = w.prize || {};
      const phone = p.zalo_phone || '';
      const mask = document.getElementById('toggleMaskWinners')?.checked;
      const masked = mask && phone && phone.length>=9 ? (phone.substring(0,3)+' xxxx '+phone.substring(phone.length-3)) : phone;
      return `
        <tr>
          <td>${p.name || ''}</td>
          <td>${masked}</td>
          <td><span class="badge bg-dark">${String(p.chosen_number||'').padStart(2,'0')}</span></td>
          <td>${prize.name || '-'}</td>
          <td>${p.address || '-'}</td>
        <td class="text-muted small">${p.submitted_at ? new Date(p.submitted_at).toLocaleString('vi-VN') : '-'}</td>

          <td>${p.message || '-'}</td>
        </tr>
      `;
    }).join('');
  }catch(e){
    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-3">Lỗi tải danh sách trúng thưởng</td></tr>';
  }
}

async function finalizeEvent() {
  const eventId = document.getElementById('currentEventBox').dataset.eventId;
  if (!eventId) return;
  const manual = prompt('Nhập số may mắn (2 số) để chốt (tùy chọn):');
  try {
    const res = await fetch(`${API}/lucky-events/${eventId}/finalize/`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ lucky_number: manual })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail||'Finalize failed');
    alert('Đã chốt kết quả!');
    loadCurrentEvent();
  } catch (e) { alert('Lỗi chốt kết quả: ' + e.message); }
}

document.addEventListener('DOMContentLoaded', () => {
  loadCurrentEvent();
  document.getElementById('btnReloadEvent').addEventListener('click', loadCurrentEvent);
  document.getElementById('btnReloadPrizes').addEventListener('click', loadCurrentEvent);
  document.getElementById('btnReloadWinners')?.addEventListener('click', () => {
    const id = document.getElementById('currentEventBox').dataset.eventId;
    if (id) loadWinnersAdmin(id);
  });
  document.getElementById('toggleMaskWinners')?.addEventListener('change', () => {
    const id = document.getElementById('currentEventBox').dataset.eventId;
    if (id) loadWinnersAdmin(id);
  });
  document.getElementById('btnFinalize').addEventListener('click', finalizeEvent);
  document.getElementById('toggleMask')?.addEventListener('change', () => {
    const tbody = document.getElementById('participantsTable');
    tbody.innerHTML = allParticipantsCache.length ? allParticipantsCache.map(p => rowHtml(p)).join('') : tbody.innerHTML;
  });
  let t1, t2; // debounce
  const applyFilters = () => {
    const qPhone = (document.getElementById('searchPhone')?.value || '').trim();
    const qNumRaw = (document.getElementById('searchNumber')?.value || '').replace(/\D/g,'').slice(0,2);
    if (document.getElementById('searchNumber')) document.getElementById('searchNumber').value = qNumRaw;
    let list = allParticipantsCache;
    if (qPhone) list = list.filter(p => (p.zalo_phone||'').includes(qPhone));
    if (qNumRaw) {
      const qNum = qNumRaw.padStart(2,'0');
      list = list.filter(p => String(p.chosen_number||'').padStart(2,'0') === qNum);
    }
    const tbody = document.getElementById('participantsTable');
    tbody.innerHTML = list.length ? list.map(p => rowHtml(p)).join('') : '<tr><td colspan="4" class="text-center text-muted py-3">Không tìm thấy</td></tr>';
  };
  document.getElementById('searchPhone')?.addEventListener('input', () => {
    clearTimeout(t1); t1 = setTimeout(applyFilters, 250);
  });
  document.getElementById('searchNumber')?.addEventListener('input', () => {
    clearTimeout(t2); t2 = setTimeout(applyFilters, 200);
  });
  document.getElementById('btnExportCSV')?.addEventListener('click', () => {
    const rows = [['Name','Phone','Number','Submitted At'], ...allParticipantsCache.map(p => [p.name||'', p.zalo_phone||'', String(p.chosen_number||'').padStart(2,'0'), new Date(p.submitted_at).toLocaleString('vi-VN')])];
    const csv = rows.map(r => r.map(x => '"'+String(x).replace(/"/g,'""')+'"').join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'lucky_participants.csv'; a.click();
    URL.revokeObjectURL(url);
  });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
/* Modern admin styles for Lucky Number */
.glass{background:linear-gradient(180deg, rgba(255,255,255,.7), rgba(255,255,255,.9));backdrop-filter:blur(8px);border:1px solid rgba(0,0,0,.06);box-shadow:0 8px 24px rgba(16,24,40,.06);border-radius:14px}

.stat-chip{background:linear-gradient(135deg,#f8fafc,#eef2f7);border:1px solid rgba(0,0,0,.06);border-radius:12px;padding:10px 12px;box-shadow:0 4px 12px rgba(16,24,40,.06)}
.stat-chip .chip-label{font-size:12px;color:#6b7280}
.stat-chip .chip-value{font-weight:800;font-size:18px;color:#111827}
.chip-green{background:linear-gradient(135deg,#ecfdf5,#e7f9f0)}
.chip-amber{background:linear-gradient(135deg,#fff7ed,#fff3e0)}
.chip-blue{background:linear-gradient(135deg,#eff6ff,#e9f0ff)}

.table thead.sticky-top{top:0;z-index:5;box-shadow:0 2px 8px rgba(16,24,40,.06)}
.table-hover tbody tr:hover{background:#f8fafc}

.badge.rounded-pill{padding:.45em .75em;font-weight:700}

.btn-outline-primary,.btn-outline-secondary,.btn-danger{border-radius:10px}
.btn-outline-primary:hover,.btn-outline-secondary:hover{transform:translateY(-1px)}

/* Inputs */
.input-group .form-control{border-radius: 0 .5rem .5rem 0}
.input-group .input-group-text{border-radius:.5rem 0 0 .5rem}

/* Scroll area */
.card-body[style*="overflow:auto"]::-webkit-scrollbar{width:6px;height:6px}
.card-body[style*="overflow:auto"]::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:999px}
.card-body[style*="overflow:auto"]::-webkit-scrollbar-track{background:#f1f5f9;border-radius:999px}

/* Winners table compact, smaller font */
.winners-table{font-size:12px}
.winners-table td, .winners-table th{padding:.5rem .6rem}
.winners-table .badge{font-size:.75rem}

</style>
{% endblock %}


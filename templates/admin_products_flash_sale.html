{% extends "admin_base.html" %}

{% block title %}Quản Lý Flash Sale - Admin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-bolt me-2"></i>Quản Lý Flash Sale
            </h1>
            <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTagModal">
                    <i class="fas fa-tags me-2"></i>Thêm Tag Mới
                </button>
                <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#addProductModal">
                    <i class="fas fa-plus me-2"></i>Thêm Sản Phẩm vào Tag
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">Danh sách các Tag</h5>
            </div>
            <div class="card-body">
                <div id="tags-list" class="list-group">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addTagModal" tabindex="-1" aria-labelledby="addTagModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTagModalLabel">Tạo Tag Flash Sale Mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTagForm">
                    <div class="mb-3">
                        <label for="tagName" class="form-label">Tên Tag</label>
                        <input type="text" class="form-control" id="tagName" required>
                    </div>
                    <div class="mb-3">
                        <label for="tagCode" class="form-label">Mã Tag</label>
                        <input type="text" class="form-control" id="tagCode" required>
                    </div>
                    <div class="mb-3">
                        <label for="tagDescription" class="form-label">Mô tả</label>
                        <textarea class="form-control" id="tagDescription" rows="2" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="tagStatus" class="form-label">Trạng thái</label>
                        <select class="form-select" id="tagStatus" required>
                            <option value="upcoming" selected>Sắp diễn ra</option>
                            <option value="active">Đang hoạt động</option>
                            <option value="expired">Đã hết hạn</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="tagStartDate" class="form-label">Ngày giờ bắt đầu</label>
                        <input type="datetime-local" class="form-control" id="tagStartDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="tagEndDate" class="form-label">Ngày giờ kết thúc</label>
                        <input type="datetime-local" class="form-control" id="tagEndDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="tagDiscount" class="form-label">Giá giảm tiếp tục (nghìn đồng)</label>
                        <input type="number" class="form-control" id="tagDiscount" value="0">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Tạo Tag</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProductModalLabel">Thêm sản phẩm vào Flash Sale</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    <div class="mb-3">
                        <label for="flashSaleTagId" class="form-label">Chọn Tag</label>
                        <select class="form-select" id="flashSaleTagId" required>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="productSearch" class="form-label">Tìm kiếm sản phẩm</label>
                        <input type="text" class="form-control" id="productSearch" placeholder="Nhập tên sản phẩm...">
                    </div>
                    <div class="mb-3 product-list-container">
                        <label class="form-label">Chọn sản phẩm</label>
                        <div id="productCheckboxes" class="form-check-list">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Thêm sản phẩm</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Tag Modal -->
<div class="modal fade" id="editTagModal" tabindex="-1" aria-labelledby="editTagModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTagModalLabel">Chỉnh sửa Tag Flash Sale</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTagForm">
                    <input type="hidden" id="editTagId">
                    <div class="mb-3">
                        <label for="editTagName" class="form-label">Tên Tag</label>
                        <input type="text" class="form-control" id="editTagName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editTagCode" class="form-label">Mã Tag</label>
                        <input type="text" class="form-control" id="editTagCode" required>
                    </div>
                    <div class="mb-3">
                        <label for="editTagDescription" class="form-label">Mô tả</label>
                        <textarea class="form-control" id="editTagDescription" rows="2" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editTagStatus" class="form-label">Trạng thái</label>
                        <select class="form-select" id="editTagStatus" required>
                            <option value="upcoming">Sắp diễn ra</option>
                            <option value="active">Đang hoạt động</option>
                            <option value="expired">Đã hết hạn</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editTagStartDate" class="form-label">Ngày giờ bắt đầu</label>
                        <input type="datetime-local" class="form-control" id="editTagStartDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="editTagEndDate" class="form-label">Ngày giờ kết thúc</label>
                        <input type="datetime-local" class="form-control" id="editTagEndDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="editTagDiscount" class="form-label">Giá giảm tiếp tục (nghìn đồng)</label>
                        <input type="number" class="form-control" id="editTagDiscount" value="0">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Cập nhật Tag</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- View Tag Products Modal -->
<div class="modal fade" id="viewTagProductsModal" tabindex="-1" aria-labelledby="viewTagProductsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewTagProductsModalLabel">Sản phẩm trong Tag</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="tagProductsSearch" class="form-label">Tìm kiếm sản phẩm</label>
                    <input type="text" class="form-control" id="tagProductsSearch" placeholder="Nhập tên sản phẩm...">
                </div>
                <div id="tagProductsList" class="list-group">
                    <!-- Products will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-danger" id="removeAllProductsBtn">Xóa tất cả sản phẩm khỏi tag</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tagsListContainer = document.getElementById('tags-list');
        const flashSaleTagIdSelect = document.getElementById('flashSaleTagId');
        const productCheckboxesContainer = document.getElementById('productCheckboxes');
        const productSearchInput = document.getElementById('productSearch');
        const addProductForm = document.getElementById('addProductForm');
        const addTagForm = document.getElementById('addTagForm');
        let allProducts = [];
        let taggedProductIds = new Set();

        function translateStatus(status) {
            switch (status) {
                case 'active':
                    return 'Đang hoạt động';
                case 'upcoming':
                    return 'Sắp diễn ra';
                case 'expired':
                    return 'Đã hết hạn';
                default:
                    return status;
            }
        }

        function fetchAndRenderTags() {
            console.log('Đang tải danh sách tags...');
            fetch('https://buddyskincare.vn/backend/api/tags/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Tags đã được tải:', data);
                    tagsListContainer.innerHTML = '';
                    if (data.length === 0) {
                        tagsListContainer.innerHTML = '<p class="text-muted">Không có tag nào.</p>';
                        return;
                    }
                    data.forEach(tag => {
                        const tagItem = document.createElement('div');
                        tagItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                        
                        const statusClass = tag.status === 'active' ? 'bg-success' :
                                             tag.status === 'upcoming' ? 'bg-warning' :
                                             'bg-danger';
                        const translatedStatus = translateStatus(tag.status);

                        tagItem.innerHTML = `
                            <div class="d-flex flex-column">
                                <h6 class="mb-1"><span class="badge ${statusClass}">${tag.code}</span> ${tag.name}</h6>
                                <small class="text-muted">${tag.description}</small>
                                <small>Bắt đầu: ${new Date(tag.start_date).toLocaleString()}</small>
                                <small>Kết thúc: ${new Date(tag.end_date).toLocaleString()}</small>
                                <small class="text-info">Giảm giá: ${tag.discounted_price_reduction || 0}K VNĐ</small>
                            </div>
                            <div class="d-flex flex-column align-items-end gap-2">
                                <span class="badge ${statusClass} rounded-pill">${translatedStatus}</span>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary btn-sm" onclick="editTag(${tag.id})" title="Chỉnh sửa">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="viewTagProducts(${tag.id}, '${tag.name}')" title="Xem sản phẩm">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteTag(${tag.id}, '${tag.name}')" title="Xóa">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        tagsListContainer.appendChild(tagItem);
                    });
                })
                .catch(error => {
                    console.error('Lỗi khi tải tags:', error);
                    tagsListContainer.innerHTML = '<p class="text-danger">Không thể tải danh sách tag. Vui lòng thử lại.</p>';
                });
        }

        function renderProductCheckboxes(products, taggedIds = new Set()) {
            productCheckboxesContainer.innerHTML = '';
            if (products.length === 0) {
                productCheckboxesContainer.innerHTML = '<p class="text-muted">Không tìm thấy sản phẩm nào.</p>';
                return;
            }

            products.forEach(product => {
                const isTagged = taggedIds.has(product.id);
                const formCheckDiv = document.createElement('div');
                formCheckDiv.classList.add('form-check');
                formCheckDiv.innerHTML = `
                    <input class="form-check-input" type="checkbox" value="${product.id}" id="product-${product.id}" ${isTagged ? 'checked' : ''}>
                    <label class="form-check-label" for="product-${product.id}">
                        ${product.name}
                    </label>
                `;
                productCheckboxesContainer.appendChild(formCheckDiv);
            });
        }

        function fetchAllProducts() {
            return fetch('https://buddyskincare.vn/backend/api/products/')
                .then(response => response.json())
                .then(products => {
                    allProducts = products;
                })
                .catch(error => console.error('Lỗi khi tải tất cả sản phẩm:', error));
        }

        function fetchProductsByTag(tag) {
            return fetch(`https://buddyskincare.vn/backend/api/products/?tags=${tag}`)
                .then(response => response.json())
                .then(products => {
                    return products.map(p => p.id);
                })
                .catch(error => {
                    console.error(`Lỗi khi tải sản phẩm cho tag "${tag}":`, error);
                    return [];
                });
        }

        function fetchAndPopulateData() {
            console.log('Đang tải dữ liệu cho các modal...');
            
            // Tải danh sách tags
            fetch('https://buddyskincare.vn/backend/api/tags/')
                .then(response => response.json())
                .then(tags => {
                    console.log('Tags đã được tải cho modal:', tags);
                    flashSaleTagIdSelect.innerHTML = tags.map(tag => `<option value="${tag.id}">${tag.name} (${tag.code})</option>`).join('');
                })
                .catch(error => console.error('Lỗi khi tải tags cho modal:', error));

            // Tải tất cả sản phẩm
            fetchAllProducts()
                .then(() => {
                    // Sau khi tải xong tất cả sản phẩm, tải các sản phẩm có tag "FlashSale"
                    return fetchProductsByTag('FlashSale');
                })
                .then(taggedIdsArray => {
                    taggedProductIds = new Set(taggedIdsArray);
                    // Hiển thị danh sách sản phẩm với các checkbox đã được tick sẵn
                    renderProductCheckboxes(allProducts, taggedProductIds);
                });
        }

        flashSaleTagIdSelect.addEventListener('change', async function() {
            const selectedTagId = this.value;
            // Fetch products for the newly selected tag
            const tagName = this.options[this.selectedIndex].text.split('(')[1].slice(0, -1);
            const productIdsForNewTag = await fetchProductsByTag(tagName);
            
            // Re-render checkboxes with updated checked state
            renderProductCheckboxes(allProducts, new Set(productIdsForNewTag));
        });

        productSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const filteredProducts = allProducts.filter(product => 
                product.name.toLowerCase().includes(searchTerm)
            );
            renderProductCheckboxes(filteredProducts, taggedProductIds);
        });

        addTagForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const tagName = document.getElementById('tagName').value;
            const tagCode = document.getElementById('tagCode').value;
            const tagDescription = document.getElementById('tagDescription').value;
            const tagStatus = document.getElementById('tagStatus').value;
            const tagStartDate = document.getElementById('tagStartDate').value;
            const tagEndDate = document.getElementById('tagEndDate').value;
            const tagDiscount = document.getElementById('tagDiscount').value;
            
            const newTag = {
                name: tagName,
                code: tagCode,
                description: tagDescription,
                status: tagStatus,
                start_date: tagStartDate,
                end_date: tagEndDate,
                discounted_price_reduction: tagDiscount,
            };

            fetch('https://buddyskincare.vn/backend/api/tags/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newTag)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(JSON.stringify(err)); });
                }
                return response.json();
            })
            .then(data => {
                alert('Tạo tag mới thành công!');
                const modal = bootstrap.Modal.getInstance(document.getElementById('addTagModal'));
                modal.hide();
                fetchAndRenderTags();
                fetchAndPopulateData();
            })
            .catch(error => {
                console.error('Lỗi khi tạo tag:', error);
                alert('Tạo tag thất bại. Lỗi: ' + error.message);
            });
        });

        addProductForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const selectedTagId = flashSaleTagIdSelect.value;
            const selectedProductIds = Array.from(productCheckboxesContainer.querySelectorAll('input[type="checkbox"]:checked')).map(checkbox => checkbox.value);

            if (!selectedTagId || selectedProductIds.length === 0) {
                alert('Vui lòng chọn Tag và ít nhất một sản phẩm.');
                return;
            }

            const requestBody = { tag_id: selectedTagId, product_ids: selectedProductIds };

            fetch(`https://buddyskincare.vn/backend/api/products/add_tag/`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(JSON.stringify(err)); });
                }
                return response.json();
            })
            .then(data => {
                alert('Sản phẩm đã được thêm vào Flash Sale thành công!');
                const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
                modal.hide();
                fetchAndPopulateData();
            })
            .catch(error => {
                console.error('Lỗi khi thêm sản phẩm vào tag:', error);
                alert('Thêm sản phẩm thất bại. Lỗi: ' + error.message);
            });
        });

        const addProductModal = document.getElementById('addProductModal');
        addProductModal.addEventListener('shown.bs.modal', function() {
            // Tải lại dữ liệu mỗi khi modal mở
            fetchAndPopulateData();
        });

        fetchAndRenderTags();
        fetchAndPopulateData();
    });

    // Global functions for tag management
    let currentEditingTagId = null;
    let currentViewingTagId = null;

    function editTag(tagId) {
        currentEditingTagId = tagId;
        
        // Fetch tag details
        fetch(`https://buddyskincare.vn/backend/api/tags/${tagId}/`)
            .then(response => response.json())
            .then(tag => {
                // Populate edit form
                document.getElementById('editTagId').value = tag.id;
                document.getElementById('editTagName').value = tag.name;
                document.getElementById('editTagCode').value = tag.code;
                document.getElementById('editTagDescription').value = tag.description;
                document.getElementById('editTagStatus').value = tag.status;
                
                // Format dates for datetime-local input
                const startDate = new Date(tag.start_date);
                const endDate = new Date(tag.end_date);
                document.getElementById('editTagStartDate').value = startDate.toISOString().slice(0, 16);
                document.getElementById('editTagEndDate').value = endDate.toISOString().slice(0, 16);
                document.getElementById('editTagDiscount').value = tag.discounted_price_reduction || 0;
                
                // Show modal
                const editModal = new bootstrap.Modal(document.getElementById('editTagModal'));
                editModal.show();
            })
            .catch(error => {
                console.error('Lỗi khi tải thông tin tag:', error);
                alert('Không thể tải thông tin tag. Vui lòng thử lại.');
            });
    }

    function viewTagProducts(tagId, tagName) {
        currentViewingTagId = tagId;
        document.getElementById('viewTagProductsModalLabel').textContent = `Sản phẩm trong Tag: ${tagName}`;
        
        // Fetch products with this tag
        fetch(`https://buddyskincare.vn/backend/api/products/?tags=${tagName}`)
            .then(response => response.json())
            .then(products => {
                const productsList = document.getElementById('tagProductsList');
                productsList.innerHTML = '';
                
                if (products.length === 0) {
                    productsList.innerHTML = '<p class="text-muted">Không có sản phẩm nào trong tag này.</p>';
                    return;
                }
                
                products.forEach(product => {
                    const productItem = document.createElement('div');
                    productItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                    productItem.innerHTML = `
                        <div class="d-flex align-items-center">
                            <img src="${product.image || '/static/image/default-product.jpg'}" 
                                 alt="${product.name}" 
                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px; margin-right: 15px;"
                                 onerror="this.src='/static/image/default-product.jpg'">
                            <div>
                                <h6 class="mb-1">${product.name}</h6>
                                <small class="text-muted">${product.brand_name || 'Không rõ thương hiệu'}</small>
                                <br>
                                <small class="text-success">${new Intl.NumberFormat('vi-VN').format(product.discounted_price * 1000)}₫</small>
                            </div>
                        </div>
                        <button class="btn btn-outline-danger btn-sm" onclick="removeProductFromTag(${product.id}, '${product.name}')">
                            <i class="fas fa-times"></i> Xóa
                        </button>
                    `;
                    productsList.appendChild(productItem);
                });
                
                // Show modal
                const viewModal = new bootstrap.Modal(document.getElementById('viewTagProductsModal'));
                viewModal.show();
            })
            .catch(error => {
                console.error('Lỗi khi tải sản phẩm:', error);
                alert('Không thể tải danh sách sản phẩm. Vui lòng thử lại.');
            });
    }

    function deleteTag(tagId, tagName) {
        if (confirm(`Bạn có chắc chắn muốn xóa tag "${tagName}"? Hành động này không thể hoàn tác.`)) {
            fetch(`https://buddyskincare.vn/backend/api/tags/${tagId}/`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    alert('Xóa tag thành công!');
                    location.reload(); // Reload to refresh the list
                } else {
                    throw new Error('Xóa tag thất bại');
                }
            })
            .catch(error => {
                console.error('Lỗi khi xóa tag:', error);
                alert('Xóa tag thất bại. Vui lòng thử lại.');
            });
        }
    }

    function removeProductFromTag(productId, productName) {
        if (confirm(`Bạn có chắc chắn muốn xóa sản phẩm "${productName}" khỏi tag này?`)) {
            // Get tag name from the modal title
            const tagName = document.getElementById('viewTagProductsModalLabel').textContent.split(': ')[1];
            
            // Remove tag from product using the new API
            fetch(`https://buddyskincare.vn/backend/api/products/${productId}/remove_tag/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tag_name: tagName })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(err => { 
                        throw new Error(err.detail || 'Xóa sản phẩm khỏi tag thất bại'); 
                    });
                }
            })
            .then(data => {
                alert(data.detail || 'Xóa sản phẩm khỏi tag thành công!');
                // Refresh the products list
                viewTagProducts(currentViewingTagId, tagName);
            })
            .catch(error => {
                console.error('Lỗi khi xóa sản phẩm khỏi tag:', error);
                alert('Lỗi khi xóa sản phẩm khỏi tag: ' + error.message);
            });
        }
    }

    // Edit tag form submission
    document.getElementById('editTagForm').addEventListener('submit', function(event) {
        event.preventDefault();
        
        const tagData = {
            name: document.getElementById('editTagName').value,
            code: document.getElementById('editTagCode').value,
            description: document.getElementById('editTagDescription').value,
            status: document.getElementById('editTagStatus').value,
            start_date: document.getElementById('editTagStartDate').value,
            end_date: document.getElementById('editTagEndDate').value,
            discounted_price_reduction: document.getElementById('editTagDiscount').value
        };

        fetch(`https://buddyskincare.vn/backend/api/tags/${currentEditingTagId}/`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(tagData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(JSON.stringify(err)); });
            }
            return response.json();
        })
        .then(data => {
            alert('Cập nhật tag thành công!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editTagModal'));
            modal.hide();
            location.reload(); // Reload to refresh the list
        })
        .catch(error => {
            console.error('Lỗi khi cập nhật tag:', error);
            alert('Cập nhật tag thất bại. Lỗi: ' + error.message);
        });
    });

    // Remove all products from tag
    document.getElementById('removeAllProductsBtn').addEventListener('click', function() {
        if (confirm('Bạn có chắc chắn muốn xóa tất cả sản phẩm khỏi tag này?')) {
            // This would require a bulk remove endpoint
            alert('Chức năng này cần được implement ở backend. Vui lòng xóa từng sản phẩm một.');
        }
    });

    // Search functionality for tag products
    document.getElementById('tagProductsSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const productItems = document.querySelectorAll('#tagProductsList .list-group-item');
        
        productItems.forEach(item => {
            const productName = item.querySelector('h6').textContent.toLowerCase();
            if (productName.includes(searchTerm)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}
{% extends "ctv_base.html" %}

{% block title %}T√†i nguy√™n Marketing{% endblock %}

{% block ctv_body %}
<div class="ctv-card p-3">
  <h1 class="h6">T√†i nguy√™n Marketing</h1>
  <p class="text-muted small">T·∫£i xu·ªëng banner, ·∫£nh s·∫£n ph·∫©m, v√† n·ªôi dung m·∫´u ƒë·ªÉ chia s·∫ª.</p>
  
  <!-- Filter tabs -->
  <ul class="nav nav-tabs mb-3" id="resourceTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">
        T·∫•t c·∫£
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="new-product-tab" data-bs-toggle="tab" data-bs-target="#new-product" type="button" role="tab">
        S·∫£n ph·∫©m m·ªõi
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="event-tab" data-bs-toggle="tab" data-bs-target="#event" type="button" role="tab">
        S·ª± ki·ªán
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="product-tab" data-bs-toggle="tab" data-bs-target="#product" type="button" role="tab">
        S·∫£n ph·∫©m
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="article-tab" data-bs-toggle="tab" data-bs-target="#article" type="button" role="tab">
        B√†i vi·∫øt m·∫´u
      </button>
    </li>
  </ul>

  <!-- Download Options -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card border-0 bg-light">
        <div class="card-body py-2">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <div class="form-check form-switch me-3">
                <input class="form-check-input" type="checkbox" id="watermarkToggle" checked>
                <label class="form-check-label fw-semibold" for="watermarkToggle">
                  <i class="fas fa-stamp me-1"></i>T·∫£i ·∫£nh c√≥ m√¥ t·∫£
                </label>
              </div>
              <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Khi b·∫≠t: ·∫¢nh t·∫£i xu·ªëng s·∫Ω c√≥ logo, t√™n s·∫£n ph·∫©m, gi√°, t√¨nh tr·∫°ng in s·∫µn
              </small>
            </div>
            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-outline-secondary btn-sm" onclick="selectAllProducts()" id="selectAllBtn">
                <i class="fas fa-check-square me-1"></i>Ch·ªçn t·∫•t c·∫£
              </button>
              <button class="btn btn-outline-secondary btn-sm" onclick="deselectAllProducts()" id="deselectAllBtn">
                <i class="fas fa-square me-1"></i>B·ªè ch·ªçn
              </button>
              <button class="btn btn-outline-success btn-sm" onclick="downloadSelectedWithWatermark()" id="downloadSelectedBtn" disabled>
                <i class="fas fa-download me-1"></i>T·∫£i ƒë√£ ch·ªçn
              </button>
              <button class="btn btn-outline-primary btn-sm" onclick="downloadAllWithWatermark()" id="downloadAllBtn">
                <i class="fas fa-download me-1"></i>T·∫£i t·∫•t c·∫£
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab content -->
  <div class="tab-content" id="resourceTabContent">
    <div class="tab-pane fade show active" id="all" role="tabpanel">
      <div class="row g-3" id="allResources">
        <div class="col-12 text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ƒêang t·∫£i...</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="tab-pane fade" id="new-product" role="tabpanel">
      <div class="row g-3" id="newProductResources">
        <div class="col-12 text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ƒêang t·∫£i...</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="tab-pane fade" id="event" role="tabpanel">
      <div class="row g-3" id="eventResources">
        <div class="col-12 text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ƒêang t·∫£i...</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="tab-pane fade" id="product" role="tabpanel">
      <!-- Product Filters -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="card border-0 bg-light">
            <div class="card-body py-3">
              <h6 class="card-title mb-3">
                <i class="fas fa-filter me-2"></i>B·ªô l·ªçc s·∫£n ph·∫©m
              </h6>
              <!-- Mode instruction -->
              <div class="alert alert-info py-2 mb-3">
                <div class="d-flex align-items-center">
                  <i class="fas fa-info-circle me-2"></i>
                  <small>
                    <strong>H∆∞·ªõng d·∫´n:</strong> 
                    Ch·ªçn ch·∫ø ƒë·ªô ·ªü b√™n d∆∞·ªõi: 
                    <span class="fw-bold text-primary">T·∫£i xu·ªëng</span> - Click ·∫£nh ƒë·ªÉ t·∫£i xu·ªëng. 
                    <span class="fw-bold text-warning">Ch·ªânh s·ª≠a</span> - Click ·∫£nh ƒë·ªÉ ch·ªânh s·ª≠a s·ªë l∆∞·ª£ng t·ªìn kho (Enter ƒë·ªÉ l∆∞u, Escape ƒë·ªÉ h·ªßy).
                  </small>
                </div>
              </div>
              
              <div class="row g-3">
                <div class="col-md-3">
                  <label for="productNameFilter" class="form-label small fw-semibold">T√¨m theo t√™n</label>
                  <input type="text" class="form-control form-control-sm" id="productNameFilter" 
                         placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m..." onkeyup="filterProducts()">
                </div>
                <div class="col-md-3">
                  <label for="productCategoryFilter" class="form-label small fw-semibold">Danh m·ª•c</label>
                  <select class="form-select form-select-sm" id="productCategoryFilter" onchange="filterProducts()">
                    <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="productBrandFilter" class="form-label small fw-semibold">H√£ng</label>
                  <select class="form-select form-select-sm" id="productBrandFilter" onchange="filterProducts()">
                    <option value="">T·∫•t c·∫£ h√£ng</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="productStockFilter" class="form-label small fw-semibold">T√¨nh tr·∫°ng</label>
                  <select class="form-select form-select-sm" id="productStockFilter" onchange="filterProducts()">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="in_stock">C√≤n h√†ng</option>
                    <option value="out_of_stock">H·∫øt h√†ng</option>
                  </select>
                </div>
              </div>
              <div class="row mt-2">
                <div class="col-12">
                  <div class="d-flex align-items-center gap-2 flex-wrap">
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearProductFilters()">
                      <i class="fas fa-times me-1"></i>X√≥a b·ªô l·ªçc
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="selectAllFilteredProducts()" id="selectFilteredBtn">
                      <i class="fas fa-check-square me-1"></i>Ch·ªçn t·∫•t c·∫£ ƒë√£ l·ªçc
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="deselectAllFilteredProducts()" id="deselectFilteredBtn">
                      <i class="fas fa-square me-1"></i>B·ªè ch·ªçn ƒë√£ l·ªçc
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="toggleSelectedProductsView()" id="toggleViewBtn">
                      <i class="fas fa-images me-1"></i>Hi·ªán ·∫£nh
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="toggleSelectedProductsSummary()" id="toggleSummaryBtn">
                      <i class="fas fa-calculator me-1"></i>Hi·ªán t√≠nh to√°n
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="clearAllSelectedProducts()" id="clearAllBtn">
                      <i class="fas fa-trash me-1"></i>X√≥a t·∫•t c·∫£
                    </button>
                    <!-- Mode toggle buttons -->
                    <div class="btn-group ms-2" role="group">
                      <button class="btn btn-outline-primary btn-sm active" id="downloadModeBtn" onclick="setMode('download')">
                        <i class="fas fa-download me-1"></i>T·∫£i xu·ªëng
                      </button>
                      <button class="btn btn-outline-warning btn-sm" id="editModeBtn" onclick="setMode('edit')">
                        <i class="fas fa-edit me-1"></i>Ch·ªânh s·ª≠a
                      </button>
                    </div>
                    <span class="text-muted small ms-3" id="productFilterCount">
                      Hi·ªÉn th·ªã: <span id="productCount">0</span> s·∫£n ph·∫©m
                    </span>
                  </div>
                </div>
              </div>
              
              <!-- Selected Products Images View -->
              <div class="row mt-3" id="selectedProductsImages" style="display: none;">
                <div class="col-12">
                  <div class="card border-info">
                    <div class="card-header bg-info text-white py-2">
                      <h6 class="mb-0">
                        <i class="fas fa-images me-2"></i>Danh s√°ch s·∫£n ph·∫©m ƒë√£ ch·ªçn (·∫¢nh)
                        <span class="badge bg-light text-info ms-2" id="selectedImagesCount">0</span>
                      </h6>
                    </div>
                    <div class="card-body py-2">
                      <div class="row g-2" id="selectedProductsImagesList">
                        <!-- Selected product images will be displayed here -->
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Selected Products Summary -->
              <div class="row mt-3" id="selectedProductsSummary" style="display: none;">
                <div class="col-12">
                  <div class="card border-success">
                    <div class="card-header bg-success text-white py-2">
                      <h6 class="mb-0">
                        <i class="fas fa-calculator me-2"></i>T√≠nh to√°n chi ti·∫øt
                        <span class="badge bg-light text-success ms-2" id="selectedCount">0</span>
                      </h6>
                    </div>
                    <div class="card-body py-2">
                      <div class="row">
                        <div class="col-md-8">
                          <div id="selectedProductsList" class="small">
                            <!-- Selected products will be listed here -->
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="text-end">
                            <div class="fw-bold text-success">
                              T·ªïng gi√°: <span id="selectedTotalPrice">0ƒë</span>
                            </div>
                            <div class="text-muted small">
                              S·ªë lo·∫°i s·∫£n ph·∫©m: <span id="selectedTotalItems">0</span> 
                            </div>
                            <div class="text-muted small">
                              T·ªïng s·ªë l∆∞·ª£ng: <span id="selectedTotalQuantity">0</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row g-3" id="productResources">
        <div class="col-12 text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ƒêang t·∫£i...</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="tab-pane fade" id="article" role="tabpanel">
      <div class="row g-3" id="articleResources">
        <div class="col-12 text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ƒêang t·∫£i...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.resource-item {
    transition: transform 0.2s ease;
}

.resource-item:hover {
    transform: translateY(-2px);
}

.resource-item img {
    transition: opacity 0.2s ease;
}

.resource-item:hover img {
    opacity: 0.9;
}

.resource-tooltip {
    z-index: 10;
    word-wrap: break-word;
}

.resource-overlay {
    display: none !important;
    transition: opacity 0.2s ease;
}

.resource-item:hover .resource-overlay {
    display: flex !important;
}

/* Watermark styles */
.watermark-canvas {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
    z-index: 1;
}

.watermark-logo {
    position: absolute;
    top: 8px;
    left: 8px;
    width: 20px;
    height: 20px;
    border-radius: 3px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

.watermark-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 4px 6px;
    border-radius: 4px;
    font-size: 9px;
    font-weight: bold;
    max-width: 80px;
}

.watermark-name {
    position: absolute;
    bottom: 1px;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 4px 8px;
    font-size: 9px;
    font-weight: 500;
    text-align: center;
    border-radius: 0 0 4px 4px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.2;
    max-height: 2.4em;
}

/* Checkbox styles */
.resource-checkbox {
    width: 18px;
    height: 18px;
    background-color: white;
    border: 2px solid #007bff;
    border-radius: 3px;
    cursor: pointer;
}

.resource-checkbox:checked {
    background-color: #007bff;
    border-color: #007bff;
}

.resource-checkbox:checked::after {
    content: '‚úì';
    color: white;
    font-weight: bold;
    font-size: 12px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

/* Selected product item styles */
.selected-product-item {
    transition: background-color 0.2s ease;
}

.selected-product-item:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

/* Desktop layout - all in one row */
@media (min-width: 992px) {
    .selected-product-item .d-lg-flex {
        gap: 1rem;
        align-items: flex-start;
    }
    
    .selected-product-item .flex-grow-1 {
        min-width: 0;
        flex-shrink: 1;
    }
    
    .selected-product-item .fw-semibold {
        margin-bottom: 0.25rem;
        line-height: 1.3;
    }
    
    .selected-product-item .text-muted.small {
        font-size: 0.75rem;
        line-height: 1.2;
        margin-bottom: 0;
    }
    
    .selected-product-item .text-success {
        min-width: fit-content;
        flex-shrink: 0;
        margin-top: 0.25rem;
    }
    
    .selected-product-item .d-flex.align-items-center {
        min-width: fit-content;
        flex-shrink: 0;
        margin-top: 0.25rem;
    }
}

/* Mobile layout - responsive */
@media (max-width: 991.98px) {
    .selected-product-item .fw-semibold {
        font-size: 0.9rem;
        line-height: 1.3;
    }
    
    .selected-product-item .text-success {
        font-size: 0.9rem;
    }
}

/* Selected products images view */
.selected-product-image {
    position: relative;
    border: 2px solid #007bff;
    border-radius: 8px;
    overflow: hidden;
    transition: transform 0.2s ease;
}

.selected-product-image:hover {
    transform: scale(1.05);
}

.selected-product-image img {
    width: 100%;
    height: 120px;
    object-fit: cover;
}

.selected-product-image .quantity-badge {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(0, 123, 255, 0.9);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: bold;
}

.selected-product-image .remove-btn {
    position: absolute;
    top: 5px;
    left: 5px;
    background: rgba(220, 53, 69, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.selected-product-image .remove-btn:hover {
    background: rgba(220, 53, 69, 1);
}

/* Stock edit functionality styles */
.stock-badge-container {
    position: relative;
}

.stock-badge-container .badge {
    transition: all 0.2s ease;
}

.stock-badge-container .badge:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.stock-edit-input {
    min-width: 80px;
    z-index: 9999 !important;
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    background: rgba(0,0,0,0.95) !important;
    border-radius: 8px !important;
    padding: 8px !important;
    border: 3px solid #28a745 !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.8) !important;
    min-width: 200px !important;
    max-width: 300px !important;
}

.stock-edit-input input {
    text-align: center;
    font-weight: bold;
    font-size: 16px !important;
    padding: 8px 12px !important;
    height: 40px !important;
    border: 2px solid #28a745 !important;
    background: #fff !important;
    color: #000 !important;
    width: 100% !important;
    border-radius: 4px !important;
}

.stock-edit-input input:focus {
    border-color: #28a745 !important;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
    outline: none !important;
}

.stock-edit-input .btn {
    border: none;
    min-width: 40px;
    height: 32px;
    font-size: 12px;
    padding: 4px 8px;
}

.stock-edit-input .btn-success {
    background-color: #28a745 !important;
}

.stock-edit-input .btn-secondary {
    background-color: #6c757d !important;
}

/* Stock feedback animation */
#stockFeedback {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        transform: translate(-50%, -100%);
        opacity: 0;
    }
    to {
        transform: translate(-50%, 0);
        opacity: 1;
    }
}

/* Mode toggle button styles */
.btn-group .btn {
    transition: all 0.2s ease;
}

.btn-group .btn.active {
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transform: translateY(-1px);
}

.btn-group .btn:hover:not(.active) {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Cursor styles for different modes */
.mode-download .resource-item img {
    cursor: pointer !important;
}

.mode-edit .resource-item img {
    cursor: crosshair !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Function to get product status text
function getProductStatusText(status) {
    const statusMap = {
        'new': 'New ƒë·∫πp',
        '30': 'C√≤n 30%',
        '80': 'C√≤n 80%',
        '75': 'C√≤n 75%',
        '70': 'C√≤n 70%',
        '60': 'C√≤n 60%',
        '50': 'C√≤n 50%',
        '90': 'C√≤n 90%',
        '85': 'C√≤n 85%',
        '95': 'C√≤n 95%',
        'test': 'Test 1-2 l·∫ßn',
        'newmh': 'New m·∫•t h·ªôp',
        'newm': 'New m√≥p h·ªôp',
        'newrt': 'New r√°ch tem',
        'newmn': 'New m√≥p nh·∫π',
        'newx': 'New x∆∞·ªõc nh·∫π',
        'newspx': 'New x∆∞·ªõc',
        'chiet': 'Chi·∫øt'
    };
    
    return statusMap[status] || status || 'N/A';
}

// Load resources when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Add roundRect polyfill for older browsers
    if (!CanvasRenderingContext2D.prototype.roundRect) {
        CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
            if (typeof radius === 'number') {
                radius = {tl: radius, tr: radius, br: radius, bl: radius};
            } else {
                radius = {tl: 0, tr: 0, br: 0, bl: 0, ...radius};
            }
            this.beginPath();
            this.moveTo(x + radius.tl, y);
            this.lineTo(x + width - radius.tr, y);
            this.quadraticCurveTo(x + width, y, x + width, y + radius.tr);
            this.lineTo(x + width, y + height - radius.br);
            this.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);
            this.lineTo(x + radius.bl, y + height);
            this.quadraticCurveTo(x, y + height, x, y + height - radius.bl);
            this.lineTo(x, y + radius.tl);
            this.quadraticCurveTo(x, y, x + radius.tl, y);
            this.closePath();
        };
    }
    
    loadAllResources();
    
    // Initialize mode
    setMode('download');
    
    // Set up global event delegation for product clicks
    setupGlobalProductClickDelegation();
    
    // Load resources when tab is clicked
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (e) {
            const target = e.target.getAttribute('data-bs-target');
            switch(target) {
                case '#all':
                    loadAllResources();
                    break;
                case '#new-product':
                    loadResourcesByType('new_product');
                    break;
                case '#event':
                    loadResourcesByType('event');
                    break;
                case '#product':
                    loadProductImages();
                    break;
                case '#article':
                    loadResourcesByType('article');
                    break;
            }
        });
    });
});

async function loadAllResources() {
    try {
        const response = await fetch('https://buddyskincare.vn/backend/api/marketing-resources/');
        const resources = await response.json();
        displayResources(resources, 'allResources');
    } catch (error) {
        console.error('Error loading resources:', error);
        document.getElementById('allResources').innerHTML = '<div class="col-12 text-center text-danger">L·ªói khi t·∫£i t√†i nguy√™n</div>';
    }
}

async function loadResourcesByType(type) {
    try {
        const response = await fetch(`https://buddyskincare.vn/backend/api/marketing-resources/by-type/?type=${type}`);
        const resources = await response.json();
        const containerId = type === 'new_product' ? 'newProductResources' : 
                           type === 'event' ? 'eventResources' : 'articleResources';
        displayResources(resources, containerId);
    } catch (error) {
        console.error('Error loading resources:', error);
        const containerId = type === 'new_product' ? 'newProductResources' : 
                           type === 'event' ? 'eventResources' : 'articleResources';
        document.getElementById(containerId).innerHTML = '<div class="col-12 text-center text-danger">L·ªói khi t·∫£i t√†i nguy√™n</div>';
    }
}

// Global variable to store all product data
let allProductData = [];

// Global variable to store selected products with quantities
let selectedProducts = new Map(); // key: resourceId, value: {productData, quantity}

// Global variable to store current mode
let currentMode = 'download'; // 'download' or 'edit'

// Global event delegation setup
function setupGlobalProductClickDelegation() {
    // Remove any existing global listener
    document.removeEventListener('click', handleGlobalProductClick);
    
    // Add global event delegation
    document.addEventListener('click', handleGlobalProductClick, true); // Use capture phase
}

function handleGlobalProductClick(e) {
    console.log('üåç Global click detected on:', e.target, 'Tag name:', e.target.tagName);
    
    // Check if clicked element is a product image or download overlay button
    const img = e.target.closest('img[data-resource-id]');
    const downloadBtn = e.target.closest('.download-overlay-btn[data-resource-id]');
    
    let targetElement = img || downloadBtn;
    
    if (!targetElement) {
        console.log('‚ùå Not a product image or download button, target:', e.target);
        return;
    }
    
    console.log('‚úÖ Found target element:', targetElement);
    
    // Check if it's a product image (not just any image)
    const productItem = targetElement.closest('[data-resource-type="product"]');
    if (!productItem) {
        console.log('‚ùå Not in product item');
        return;
    }
    
    console.log('‚úÖ Found product item:', productItem);
    
    // Check if we're in the product resources container
    const productContainer = document.getElementById('productResources');
    if (!productContainer || !productContainer.contains(targetElement)) {
        console.log('‚ùå Not in product container');
        return;
    }
    
    console.log('‚úÖ In product container');
    
    console.log('üåç Global product click in', currentMode, 'mode:', { 
        resourceId: targetElement.getAttribute('data-resource-id'),
        fileUrl: targetElement.getAttribute('data-file-url'),
        resourceName: targetElement.getAttribute('data-resource-name')
    });
    
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();
    
    const resourceId = targetElement.getAttribute('data-resource-id');
    const fileUrl = targetElement.getAttribute('data-file-url');
    const resourceName = targetElement.getAttribute('data-resource-name');
    
    handleProductClick(resourceId, fileUrl, resourceName);
}

async function loadProductImages() {
    try {
        // G·ªçi tr·ª±c ti·∫øp Django API ƒë·ªÉ l·∫•y T·∫§T C·∫¢ s·∫£n ph·∫©m (kh√¥ng filter theo status)
        const response = await fetch('https://buddyskincare.vn/backend/api/products/?page_size=1000');
        const data = await response.json();
        const products = data.results || data; // Handle both paginated and non-paginated responses
        console.log(`üîç Loaded ${products.length} products from Django API`);
        
        allProductData = [];
        const categories = new Set();
        const brands = new Set();
        
        products.forEach(product => {
            // L·∫•y t·∫•t c·∫£ ·∫£nh c·ªßa s·∫£n ph·∫©m
            const allImages = product.all_images || [];
            
            // Add to filter sets - try different possible field names for category
            const category = product.category || product.category_name || product.product_category || '';
            if (category) categories.add(category);
            if (product.brand_name) brands.add(product.brand_name);
            
            allImages.forEach((imageUrl, index) => {
                if (imageUrl && imageUrl.trim()) {
                    allProductData.push({
                        id: `product_${product.id}_${index + 1}`,
                        name: product.name,
                        description: `S·∫£n ph·∫©m ${product.brand_name || 'Kh√¥ng x√°c ƒë·ªãnh'}`,
                        resource_type: 'product',
                        file_url: imageUrl,
                        thumbnail_url: imageUrl,
                        product_id: product.id,
                        product_name: product.name,
                        product_category: category,
                        product_brand: product.brand_name || '',
                        stock_quantity: product.stock_quantity || 0,
                        discounted_price: product.discounted_price || product.original_price || 0,
                        original_price: product.original_price || 0,
                        status: product.status || 0,
                        is_image: true,
                        file_extension: imageUrl.split('.').pop().toLowerCase() || 'jpg',
                        image_index: index + 1,
                        total_images: allImages.length
                    });
                }
            });
        });
        
        // Populate filter dropdowns
        console.log('üîç Categories found:', Array.from(categories));
        console.log('üîç Brands found:', Array.from(brands));
        populateCategoryFilter(Array.from(categories).sort());
        populateBrandFilter(Array.from(brands).sort());
        
        console.log(`üîç Products with images: ${allProductData.length}`);
        displayResources(allProductData, 'productResources');
        updateProductCount(allProductData.length);
        
        // Re-apply current mode after loading products
        setTimeout(() => {
            setMode(currentMode);
        }, 100);
    } catch (error) {
        console.error('Error loading product images:', error);
        document.getElementById('productResources').innerHTML = '<div class="col-12 text-center text-danger">L·ªói khi t·∫£i ·∫£nh s·∫£n ph·∫©m</div>';
    }
}

function displayResources(resources, containerId) {
    const container = document.getElementById(containerId);
    
    if (!resources || resources.length === 0) {
        container.innerHTML = '<div class="col-12 text-center text-muted">Kh√¥ng c√≥ t√†i nguy√™n n√†o</div>';
        return;
    }
    
    container.innerHTML = resources.map(resource => {
        const isImage = resource.is_image;
        const showDescription = resource.resource_type === 'event' || resource.resource_type === 'article';
        
        return `
            <div class="col-md-3 col-lg-2 col-6 mb-3">
                <div class="resource-item position-relative" 
                     style="cursor: default;" 
                     title="${resource.name}"
                     data-resource-id="${resource.id}"
                     data-resource-type="${resource.resource_type}"
                     data-stock="${resource.stock_quantity || 0}"
                     data-price="${resource.discounted_price ? Number(resource.discounted_price * 1000).toLocaleString('vi-VN') + 'ƒë' : '0ƒë'}"
                     data-status="${resource.status ? getProductStatusText(resource.status) : 'N/A'}">
                    <!-- Selection checkbox -->
                    <div class="position-absolute top-0 start-0 m-2" style="z-index: 20;">
                        <div class="form-check">
                            <input class="form-check-input resource-checkbox" 
                                   type="checkbox" 
                                   value="${resource.id}"
                                   id="checkbox_${resource.id}"
                                   onchange="updateDownloadSelectedButton()">
                        </div>
                    </div>
                    ${isImage ? `
                        <div class="text-center position-relative" 
                             style="cursor: pointer;">
                            <img src="${resource.thumbnail_url || resource.file_url}" 
                                 class="img-fluid rounded shadow-sm" 
                                 style="width: 100%; max-height: 300px; object-fit: contain;"
                                 alt="${resource.name}"
                                 data-resource-id="${resource.id}"
                                 data-file-url="${resource.file_url}"
                                 data-resource-name="${resource.name.replace(/'/g, "\\'")}">
                            ${resource.resource_type === 'product' && resource.stock_quantity !== undefined ? `
                                <!-- Logo at top left -->
                                <div class="position-absolute top-0 start-0 m-1">
                                    <img src="/static/image/logo.png" 
                                         style="width: 20px; height: 20px; border-radius: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.3);" 
                                         alt="BuddySkincare Logo">
                                </div>
                                
                                <!-- Stock badge at top right with edit functionality -->
                                <div class="position-absolute top-0 end-0 m-1">
                                    <div class="stock-badge-container" 
                                         style="position: relative; display: inline-block;">
                                        <span class="badge ${resource.stock_quantity > 0 ? 'bg-success' : 'bg-danger'}" 
                                              style="font-size: 9px; padding: 2px 4px; line-height: 1.2; cursor: pointer;"
                                              onclick="toggleStockEdit('${resource.id}')"
                                              title="Click ƒë·ªÉ ch·ªânh s·ª≠a s·ªë l∆∞·ª£ng t·ªìn kho">
                                            <div><i class="fas fa-boxes me-1"></i><span class="stock-display">${resource.stock_quantity > 0 ? resource.stock_quantity : 'H·∫øt h√†ng'}</span></div>
                                            ${resource.discounted_price * 1000 ? `<div style="font-size: 8px; margin-top: 1px;">Gi√°: ${Number(resource.discounted_price *1000).toLocaleString('vi-VN')}ƒë</div>` : ''}
                                            ${resource.status ? `<div style="font-size: 7px; margin-top: 1px; color: #fff; font-weight: bold;">${getProductStatusText(resource.status)}</div>` : ''}
                                        </span>
                                        <!-- Stock edit input (hidden by default) -->
                                        <div class="stock-edit-input" 
                                             style="display: none;">
                                            <div class="text-center mb-2">
                                                <label class="text-white fw-bold">Ch·ªânh s·ª≠a s·ªë l∆∞·ª£ng t·ªìn kho</label>
                                            </div>
                                            <input type="number" 
                                                   class="form-control" 
                                                   min="0" 
                                                   max="9999"
                                                   value="${resource.stock_quantity || 0}"
                                                   onkeypress="handleStockInputKeypress(event, '${resource.id}')"
                                                   onblur="saveStockQuantity('${resource.id}', this.value)"
                                                   onclick="event.stopPropagation()"
                                                   id="stock-input-${resource.id}"
                                                   placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng">
                                            <div class="d-flex gap-2 mt-3 justify-content-center">
                                                <button class="btn btn-success" 
                                                        onclick="saveStockQuantity('${resource.id}', document.getElementById('stock-input-${resource.id}').value); event.stopPropagation();"
                                                        title="L∆∞u">
                                                    <i class="fas fa-check me-1"></i>L∆∞u
                                                </button>
                                                <button class="btn btn-secondary" 
                                                        onclick="cancelStockEdit('${resource.id}'); event.stopPropagation();"
                                                        title="H·ªßy">
                                                    <i class="fas fa-times me-1"></i>H·ªßy
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Product name at bottom -->
                                <div class="position-absolute bottom-0 start-0 end-0" style="bottom: 1px; text-align: center; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; font-size: 9px; font-weight: 500; border-radius: 0 0 4px 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; max-height: 3.0em;">
                                    ${resource.product_name || resource.name}
                                    ${resource.product_category ? `<br><small style="font-size: 7px; opacity: 0.8;">${resource.product_category}</small>` : ''}
                                    ${resource.product_brand ? `<br><small style="font-size: 7px; opacity: 0.8;">${resource.product_brand}</small>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <div class="text-center bg-light rounded shadow-sm d-flex align-items-center justify-content-center" 
                             style="height: 120px;">
                            <i class="fas fa-file-alt fa-2x text-muted"></i>
                        </div>
                    `}
                    
                   
                    
                    <!-- N√∫t copy description cho event v√† article -->
                    ${showDescription && resource.description ? `
                       
                    ` : ''}
                    
                    <!-- Overlay hi·ªÉn th·ªã khi hover -->
                    <div class="resource-overlay position-absolute top-0 start-0 end-0 bottom-0 bg-dark bg-opacity-75 text-white d-flex align-items-center justify-content-center rounded" 
                         style="display: none; font-size: 12px; text-align: center; z-index: 10;">
                        ${showDescription && resource.description ? `
                            <div class="d-flex flex-column align-items-center gap-3">
                                <div class="d-flex gap-4">
                                    <div class="text-center copy-description-btn" 
                                         data-description="${resource.description}"
                                         data-resource-name="${resource.name}"
                                         style="cursor: pointer;">
                                        <i class="fas fa-copy fa-2x mb-2"></i>
                                        <div>Copy m√¥ t·∫£</div>
                                    </div>
                                    <div class="text-center download-overlay-btn" 
                                         data-resource-id="${resource.id}"
                                         data-file-url="${resource.file_url}"
                                         data-resource-name="${resource.name.replace(/'/g, "\\'")}"
                                         style="cursor: pointer;">
                                        <i class="fas fa-download fa-2x mb-2"></i>
                                        <div>T·∫£i xu·ªëng</div>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div class="text-center download-overlay-btn" 
                                 data-resource-id="${resource.id}"
                                 data-file-url="${resource.file_url}"
                                 data-resource-name="${resource.name.replace(/'/g, "\\'")}"
                                 style="cursor: pointer;">
                                <i class="fas fa-download fa-2x mb-2"></i>
                                <div>Click ƒë·ªÉ t·∫£i xu·ªëng</div>
                            </div>
                        `}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    // CSS hover s·∫Ω t·ª± ƒë·ªông x·ª≠ l√Ω hi·ªÉn th·ªã overlay
    
    // Th√™m event listeners cho n√∫t copy description
    container.querySelectorAll('.copy-description-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const description = this.getAttribute('data-description');
            const resourceName = this.getAttribute('data-resource-name');
            copyDescription(description, resourceName);
        });
    });
    
    // Update cursor for all product images
    updateProductCursors(container);
}

async function downloadResource(resourceId, fileUrl, fileName) {
    console.log('üîç DownloadResource called:', { resourceId, fileUrl, fileName });
    
    // Ensure resourceId is a string
    resourceId = String(resourceId);
    
    // Check if watermark is enabled
    const watermarkEnabled = document.getElementById('watermarkToggle').checked;
    console.log('üé® Watermark enabled:', watermarkEnabled);
    
    try {
        // Only track download for marketing resources, not product images
        if (!resourceId.startsWith('product_')) {
            try {
                console.log('üìä Tracking download for marketing resource:', resourceId);
                await fetch(`https://buddyskincare.vn/backend/api/marketing-resources/${resourceId}/download/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
            } catch (trackError) {
                console.warn('Download tracking failed:', trackError);
            }
        }
        
        console.log('üì• Starting download process...');
        
        // Method 1: Try fetch + blob download (force download)
        try {
            console.log('üîÑ Trying fetch + blob download...');
            
            // Better filename for product images
            const cleanFileName = fileName.replace(/[^a-zA-Z0-9\-_]/g, '_');
            const urlParts = fileUrl.split('.');
            const extension = urlParts.length > 1 ? urlParts[urlParts.length - 1] : 'jpg';
            // Extract product ID from resourceId (format: product_123_1)
            const productId = resourceId.startsWith('product_') ? 
                resourceId.split('_')[1] : // Get the product ID part
                resourceId;
                
            const finalFilename = resourceId.startsWith('product_') ? 
                `S·∫£n_Ph·∫©m_buddyskincare.vn_${productId}.${extension}` : 
                `${cleanFileName}.${extension}`;
            
            // Fetch the image as blob
            const response = await fetch(fileUrl);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            let blob = await response.blob();
            console.log('üì¶ Blob created, size:', blob.size);
            
            // Add watermark if enabled and it's a product image
            if (watermarkEnabled && resourceId.startsWith('product_')) {
                console.log('üé® Adding watermark to product image...');
                blob = await addWatermarkToImage(blob, resourceId, fileName);
            }
            
            // Create download link with blob URL
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = finalFilename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Clean up blob URL
            setTimeout(() => {
                window.URL.revokeObjectURL(downloadUrl);
            }, 1000);
            
            console.log('‚úÖ Fetch + blob download completed');
            return;
            
        } catch (fetchError) {
            console.warn('Fetch + blob download failed, trying simple download:', fetchError);
        }
        
        // Method 2: Try simple direct download
        try {
            console.log('üîÑ Trying simple direct download...');
            
            // Better filename for product images
            const cleanFileName = fileName.replace(/[^a-zA-Z0-9\-_]/g, '_');
            const urlParts = fileUrl.split('.');
            const extension = urlParts.length > 1 ? urlParts[urlParts.length - 1] : 'jpg';
            // Extract product ID from resourceId (format: product_123_1)
            const productId = resourceId.startsWith('product_') ? 
                resourceId.split('_')[1] : // Get the product ID part
                resourceId;
                
            const finalFilename = resourceId.startsWith('product_') ? 
                `S·∫£n_Ph·∫©m_buddyskincare.vn_${productId}.${extension}` : 
                `${cleanFileName}.${extension}`;
            
            const a = document.createElement('a');
            a.href = fileUrl;
            a.download = finalFilename;
            // Remove target='_blank' to force download instead of opening in new tab
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            console.log('‚úÖ Simple download started');
            return;
            
        } catch (simpleError) {
            console.warn('Simple download failed, trying Django proxy:', simpleError);
        }
        
        // Method 3: Try Django download proxy
        try {
            console.log('üîÑ Trying Django download proxy...');
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const baseUrl = isLocalhost ? window.location.origin : 'https://buddyskincare.vn';
            
            // Better filename for product images
            const cleanFileName = fileName.replace(/[^a-zA-Z0-9\-_]/g, '_');
            const urlParts = fileUrl.split('.');
            const extension = urlParts.length > 1 ? urlParts[urlParts.length - 1] : 'jpg';
            // Extract product ID from resourceId (format: product_123_1)
            const productId = resourceId.startsWith('product_') ? 
                resourceId.split('_')[1] : // Get the product ID part
                resourceId;
                
            const finalFilename = resourceId.startsWith('product_') ? 
                `S·∫£n_Ph·∫©m_buddyskincare.vn_${productId}.${extension}` : 
                `${cleanFileName}.${extension}`;
            
            const proxy = `${baseUrl}/backend/api/download-image/?url=${encodeURIComponent(fileUrl)}&filename=${encodeURIComponent(finalFilename)}`;
            
            const a = document.createElement('a');
            a.href = proxy;
            a.download = finalFilename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            console.log('‚úÖ Download started via Django proxy');
            return;
            
        } catch (proxyError) {
            console.warn('Django proxy failed, trying fallback:', proxyError);
        }
        
        // Method 4: Final fallback - open in new tab
        try {
            console.log('üîÑ Trying direct fetch method...');
            const response = await fetch(fileUrl);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const blob = await response.blob();
            console.log('üì¶ Blob created, size:', blob.size);
            
            // Create download link
            const downloadUrl = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = downloadUrl;
            
            // Get file extension from URL or default to jpg
            const urlParts = fileUrl.split('.');
            const extension = urlParts.length > 1 ? urlParts[urlParts.length - 1] : 'jpg';
            
            // Better filename for product images
            const cleanFileName = fileName.replace(/[^a-zA-Z0-9\-_]/g, '_');
            
            // Extract product ID from resourceId (format: product_123_1)
            const productId = resourceId.startsWith('product_') ? 
                resourceId.split('_')[1] : // Get the product ID part
                resourceId;
                
            link.download = resourceId.startsWith('product_') ? 
                `S·∫£n_Ph·∫©m_buddyskincare.vn_${productId}.${extension}` : 
                `buddy_image_${resourceId}.${extension}`;
            
            console.log('üìÅ Download filename:', link.download);
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up
            setTimeout(() => {
                window.URL.revokeObjectURL(downloadUrl);
            }, 1000);
            
            console.log('‚úÖ Download completed via direct method');
            
        } catch (fetchError) {
            console.error('Direct fetch failed:', fetchError);
            throw fetchError;
        }
        
    } catch (error) {
        console.error('‚ùå All download methods failed:', error);
        
        // Final fallback: try simple download link
        console.log('üîÑ Trying simple download link as fallback...');
        try {
            const a = document.createElement('a');
            a.href = fileUrl;
            a.download = fileName || 'download';
            a.target = '_blank';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            console.log('‚úÖ Simple download link triggered');
        } catch (fallbackError) {
            console.error('‚ùå Even simple download failed:', fallbackError);
            // Ultimate fallback: open in new tab
            console.log('üîÑ Opening in new tab as ultimate fallback...');
            window.open(fileUrl, '_blank');
        }
    }
}

async function trackDownload(resourceId) {
    try {
        await fetch(`https://buddyskincare.vn/backend/api/marketing-resources/${resourceId}/download/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
    } catch (error) {
        console.error('Error tracking download:', error);
    }
}

async function copyDescription(description, resourceName) {
    try {
        // Copy description to clipboard
        await navigator.clipboard.writeText(description);
        
        // Show success message
        const toast = document.createElement('div');
        toast.className = 'position-fixed top-0 end-0 m-3 p-3 bg-success text-white rounded shadow';
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-check-circle me-2"></i>
                <div>
                    <strong>ƒê√£ copy!</strong><br>
                    <small>M√¥ t·∫£ c·ªßa c·ªßa b√†i vi·∫øt. Ch√∫c b·∫°n mua may b√°n ƒë·∫Øt nh√©.</small>
                </div>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Remove toast after 3 seconds
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 3000);
        
    } catch (error) {
        console.error('Error copying description:', error);
        
        // Fallback: show alert
        alert(`M√¥ t·∫£ c·ªßa "${resourceName}":\n\n${description}`);
    }
}

// Function to add watermark to image
async function addWatermarkToImage(blob, resourceId, fileName) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        img.onload = function() {
            // Set canvas size to match image
            canvas.width = img.width;
            canvas.height = img.height;
            
            // Draw original image
            ctx.drawImage(img, 0, 0);
            
            // Get product data from resourceId
            const productData = getProductDataFromResourceId(resourceId);
            
            // Add watermarks sequentially to ensure logo loads first
            addLogoWatermark(ctx, canvas.width, canvas.height).then(() => {
                // Add product info watermark (top right)
                addProductInfoWatermark(ctx, canvas.width, canvas.height, productData);
                
                // Add product name watermark (bottom)
                addProductNameWatermark(ctx, canvas.width, canvas.height, productData);
                
                // Convert canvas to blob after all watermarks are added
                canvas.toBlob((watermarkedBlob) => {
                    if (watermarkedBlob) {
                        console.log('‚úÖ Watermark added successfully');
                        resolve(watermarkedBlob);
                    } else {
                        console.error('‚ùå Failed to create watermarked blob');
                        resolve(blob); // Return original blob if watermark fails
                    }
                }, 'image/jpeg', 0.9);
            });
        };
        
        img.onerror = function() {
            console.error('‚ùå Failed to load image for watermarking');
            resolve(blob); // Return original blob if image loading fails
        };
        
        // Load image from blob
        const url = URL.createObjectURL(blob);
        img.src = url;
    });
}

// Function to get product data from resourceId
function getProductDataFromResourceId(resourceId) {
    // Extract product info from the current page data
    const productElement = document.querySelector(`[data-resource-id="${resourceId}"]`);
    if (!productElement) return null;
    
    // Try to get data from data attributes first (more reliable)
    const stockAttr = productElement.getAttribute('data-stock');
    const priceAttr = productElement.getAttribute('data-price');
    const statusAttr = productElement.getAttribute('data-status');
    
    let stock = 0;
    let price = '0ƒë';
    let status = 'N/A';
    
    // Use data attributes if available
    if (stockAttr !== null) {
        stock = parseInt(stockAttr) || 0;
    } else {
        // Fallback: Extract from badge text
        const badgeElement = productElement.querySelector('.badge');
        if (badgeElement) {
            const badgeText = badgeElement.textContent;
            const lines = badgeText.split('\n').map(line => line.trim()).filter(line => line);
            
            // Extract stock
            const stockLine = lines.find(line => line.includes('H·∫øt h√†ng') || line.includes('üì¶'));
            if (stockLine) {
                if (stockLine.includes('H·∫øt h√†ng')) {
                    stock = 0;
                } else {
                    const stockMatch = stockLine.match(/(\d+)/);
                    stock = stockMatch ? parseInt(stockMatch[1]) : 0;
                }
            }
        }
    }
    
    if (priceAttr !== null) {
        price = priceAttr;
    } else {
        // Fallback: Extract from badge text
        const badgeElement = productElement.querySelector('.badge');
        if (badgeElement) {
            const badgeText = badgeElement.textContent;
            const lines = badgeText.split('\n').map(line => line.trim()).filter(line => line);
            
            // Extract price
            const priceLine = lines.find(line => line.includes('Gi√°:') || line.includes('ƒë'));
            if (priceLine) {
                const priceMatch = priceLine.match(/([\d,\.]+ƒë)/);
                price = priceMatch ? priceMatch[1] : '0ƒë';
            }
        }
    }
    
    if (statusAttr !== null) {
        status = statusAttr;
    } else {
        // Fallback: Extract from badge text
        const badgeElement = productElement.querySelector('.badge');
        if (badgeElement) {
            const badgeText = badgeElement.textContent;
            const lines = badgeText.split('\n').map(line => line.trim()).filter(line => line);
            
            // Extract status
            const statusLine = lines.find(line => line.includes('New') || line.includes('C√≤n') || line.includes('Test'));
            if (statusLine) {
                status = statusLine;
            }
        }
    }
    
    console.log('üîç Product data extracted:', { resourceId, stock, price, status });
    
    return {
        name: productElement.getAttribute('title') || 'S·∫£n ph·∫©m',
        stock: stock,
        price: price,
        status: status
    };
}

// Function to add logo watermark
function addLogoWatermark(ctx, canvasWidth, canvasHeight) {
    return new Promise((resolve) => {
        const logoSize = Math.min(canvasWidth, canvasHeight) * 0.15; // 15% of smaller dimension for better proportion with large text
        const logoX = 8;
        const logoY = 8;
        
        // Load the actual logo image
        const logoImg = new Image();
        logoImg.crossOrigin = 'anonymous'; // Enable CORS for external images
        
        logoImg.onload = function() {
            // Draw the actual logo with proper scaling
            ctx.drawImage(logoImg, logoX, logoY, logoSize, logoSize);
            resolve();
        };
        
        logoImg.onerror = function() {
            console.warn('Failed to load logo, using fallback');
            // Fallback to simple logo if image fails to load
            ctx.fillStyle = '#007bff';
            ctx.beginPath();
            ctx.arc(logoX + logoSize/2, logoY + logoSize/2, logoSize/2, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.fillStyle = 'white';
            ctx.font = `bold ${logoSize * 0.6}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('B', logoX + logoSize/2, logoY + logoSize/2);
            resolve();
        };
        
        // Load the actual logo from the static directory
        logoImg.src = '/static/image/logo.png';
    });
}

// Function to add product info watermark
function addProductInfoWatermark(ctx, canvasWidth, canvasHeight, productData) {
    // Calculate font size based on image height * 0.03
    const fontSize = Math.max(canvasHeight * 0.03, 30); // Minimum 12px
    
    // Calculate badge size based on font size
    const badgeWidth = Math.min(canvasWidth * 0.5);
    const badgeHeight = fontSize * 4.5; // Height based on font size
    const badgeX = canvasWidth - canvasWidth * 0.25; // Dynamic position based on image width * 0.06
    const badgeY = 30;
    
    // Determine background color based on stock
    const hasStock = productData?.stock > 0;
    console.log('üé® Watermark stock check:', { 
        productData, 
        stock: productData?.stock, 
        hasStock, 
        stockType: typeof productData?.stock 
    });
    const backgroundColor = hasStock ? 'rgba(0, 128, 0, 0.8)' : 'rgba(220, 53, 69, 0.8)'; // Green or Red
    
    // Draw badge background with rounded corners
    ctx.fillStyle = backgroundColor;
    ctx.beginPath();
    ctx.roundRect(badgeX, badgeY, badgeWidth, badgeHeight, 4);
    ctx.fill();
    
    // Draw badge text with dynamic font size
    ctx.fillStyle = 'white';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'top';
    
    const textX = badgeX + canvasWidth * 0.015; // Padding
    const textY = badgeY + canvasHeight * 0.015; // Padding
    const lineSpacing = fontSize * 1.2; // Line spacing based on font size
    
    // Stock info
    ctx.font = `bold ${fontSize}px Arial`;
    const stockText = hasStock ? `üì¶ C√≤n ${productData.stock}` : 'üì¶ H·∫øt h√†ng';
    ctx.fillText(stockText, textX, textY);
    
    // Price info
    ctx.font = `bold ${fontSize}px Arial`;
    const priceText = `üí∞ ${productData?.price || '0ƒë'}`;
    ctx.fillText(priceText, textX, textY + lineSpacing);
    
    // Status info
    ctx.font = `bold ${fontSize}px Arial`;
    const statusText = `üìã ${productData?.status || 'N/A'}`;
    ctx.fillText(statusText, textX, textY + lineSpacing * 2);
}

// Function to add product name watermark
function addProductNameWatermark(ctx, canvasWidth, canvasHeight, productData) {
    // Calculate font size based on image height * 0.03
    const fontSize = Math.max(canvasHeight * 0.03, 40); // Minimum 12px
    
    // Calculate height based on font size
    const nameHeight = fontSize * 3; // Height based on font size
    const nameY = canvasHeight - nameHeight;
    
    // Draw name background with rounded bottom corners
    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
    ctx.beginPath();
    ctx.roundRect(0, nameY, canvasWidth, nameHeight, {tl: 0, tr: 0, br: 4, bl: 4}); // Rounded bottom corners only
    ctx.fill();
    
    // Draw name text with dynamic font size
    ctx.fillStyle = 'white';
    ctx.font = `700 ${fontSize}px Arial`; // Dynamic font size
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    // Use real product name from data
    const productName = productData?.name || 'S·∫£n ph·∫©m m·ªπ ph·∫©m';
    const maxWidth = canvasWidth - 16; // Padding on both sides
    
    // Truncate text if too long (support 2 lines max)
    let displayName = productName;
    const lineHeight = fontSize * 1.2; // Line height based on font size
    const maxLines = 2;
    
    // Check if text fits in one line
    if (ctx.measureText(displayName).width <= maxWidth) {
        // Single line - center vertically
        ctx.fillText(displayName, canvasWidth / 2, nameY + nameHeight / 2);
    } else {
        // Multi-line - split text and center
        const words = displayName.split(' ');
        let line1 = '';
        let line2 = '';
        let currentLine = '';
        
        for (let i = 0; i < words.length; i++) {
            const testLine = currentLine + (currentLine ? ' ' : '') + words[i];
            if (ctx.measureText(testLine).width <= maxWidth) {
                currentLine = testLine;
            } else {
                if (!line1) {
                    line1 = currentLine;
                    currentLine = words[i];
                } else {
                    line2 = currentLine + ' ' + words.slice(i).join(' ');
                    break;
                }
            }
        }
        
        if (!line1) line1 = currentLine;
        if (!line2) line2 = currentLine;
        
        // Truncate line2 if still too long
        if (ctx.measureText(line2).width > maxWidth) {
            while (ctx.measureText(line2 + '...').width > maxWidth && line2.length > 0) {
                line2 = line2.slice(0, -1);
            }
            line2 += '...';
        }
        
        // Draw lines
        const totalHeight = line2 ? lineHeight * 2 : lineHeight;
        const startY = nameY + (nameHeight - totalHeight) / 2 + lineHeight / 2;
        
        ctx.fillText(line1, canvasWidth / 2, startY);
        if (line2 && line2 !== line1) {
            ctx.fillText(line2, canvasWidth / 2, startY + lineHeight);
        }
    }
}

// Function to populate category filter
function populateCategoryFilter(categories) {
    const categorySelect = document.getElementById('productCategoryFilter');
    categorySelect.innerHTML = '<option value="">T·∫•t c·∫£ danh m·ª•c</option>';
    
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
    });
}

// Function to populate brand filter
function populateBrandFilter(brands) {
    const brandSelect = document.getElementById('productBrandFilter');
    brandSelect.innerHTML = '<option value="">T·∫•t c·∫£ h√£ng</option>';
    
    brands.forEach(brand => {
        const option = document.createElement('option');
        option.value = brand;
        option.textContent = brand;
        brandSelect.appendChild(option);
    });
}

// Function to filter products
function filterProducts() {
    const nameFilter = document.getElementById('productNameFilter').value.toLowerCase();
    const categoryFilter = document.getElementById('productCategoryFilter').value;
    const brandFilter = document.getElementById('productBrandFilter').value;
    const stockFilter = document.getElementById('productStockFilter').value;
    
    const filteredData = allProductData.filter(product => {
        const nameMatch = !nameFilter || product.product_name.toLowerCase().includes(nameFilter);
        const categoryMatch = !categoryFilter || product.product_category === categoryFilter;
        const brandMatch = !brandFilter || product.product_brand === brandFilter;
        
        // Stock filter logic
        let stockMatch = true;
        if (stockFilter === 'in_stock') {
            stockMatch = product.stock_quantity > 0;
        } else if (stockFilter === 'out_of_stock') {
            stockMatch = product.stock_quantity <= 0;
        }
        
        return nameMatch && categoryMatch && brandMatch && stockMatch;
    });
    
    console.log(`üîç Filtered products: ${filteredData.length} out of ${allProductData.length}`, {
        nameFilter, categoryFilter, brandFilter, stockFilter
    });
    displayResources(filteredData, 'productResources');
    updateProductCount(filteredData.length);
    
    // Update button states
    updateFilteredSelectionButtons();
}

// Function to clear all filters
function clearProductFilters() {
    document.getElementById('productNameFilter').value = '';
    document.getElementById('productCategoryFilter').value = '';
    document.getElementById('productBrandFilter').value = '';
    document.getElementById('productStockFilter').value = '';
    
    displayResources(allProductData, 'productResources');
    updateProductCount(allProductData.length);
    
    // Update button states
    updateFilteredSelectionButtons();
}

// Function to update product count
function updateProductCount(count) {
    document.getElementById('productCount').textContent = count;
}

// Function to update selected products summary
function updateSelectedProductsSummary() {
    const summaryDiv = document.getElementById('selectedProductsSummary');
    const selectedCount = document.getElementById('selectedCount');
    const selectedProductsList = document.getElementById('selectedProductsList');
    const selectedTotalPrice = document.getElementById('selectedTotalPrice');
    const selectedTotalItems = document.getElementById('selectedTotalItems');
    
    if (selectedProducts.size === 0) {
        summaryDiv.style.display = 'none';
        return;
    }
    
    // Show summary
    summaryDiv.style.display = 'block';
    selectedCount.textContent = selectedProducts.size;
    selectedTotalItems.textContent = selectedProducts.size;
    
    // Calculate total price and total quantity
    let totalPrice = 0;
    let totalQuantity = 0;
    let productListHTML = '';
    
    selectedProducts.forEach((selectedProduct, resourceId) => {
        // Try to get product element from current display first
        let productElement = document.querySelector(`[data-resource-id="${resourceId}"]`);
        
        // If not found in current display, try to find in allProductData
        if (!productElement) {
            const productData = allProductData.find(p => p.id === resourceId);
            if (productData) {
                // Create a virtual element with the data
                productElement = {
                    getAttribute: (attr) => {
                        switch(attr) {
                            case 'title': return productData.name;
                            case 'data-stock': return productData.stock_quantity || 0;
                            case 'data-price': return productData.discounted_price ? Number(productData.discounted_price * 1000).toLocaleString('vi-VN') + 'ƒë' : '0ƒë';
                            case 'data-status': return productData.status ? getProductStatusText(productData.status) : 'N/A';
                            default: return '';
                        }
                    }
                };
            }
        }
        
        if (productElement) {
            const productName = productElement.getAttribute('title') || 'S·∫£n ph·∫©m';
            const stockAttr = productElement.getAttribute('data-stock');
            const priceAttr = productElement.getAttribute('data-price');
            const statusAttr = productElement.getAttribute('data-status');
            
            // Parse price (remove 'ƒë' and convert to number)
            let price = 0;
            if (priceAttr) {
                const priceStr = priceAttr.replace(/[^\d]/g, '');
                price = parseInt(priceStr) || 0;
            }
            
            // Get quantity from selected products map
            const quantity = selectedProduct.quantity || 1;
            
            totalPrice += price * quantity;
            totalQuantity += quantity;
            
            // Build product item
            productListHTML += `
                <div class="selected-product-item border-bottom py-2 mb-2">
                    <!-- Desktop: All in one row -->
                    <div class="d-none d-lg-flex justify-content-between align-items-center">
                        <div class="flex-grow-1 me-3">
                            <div class="fw-semibold">${productName}</div>
                            <div class="text-muted small">
                                ${priceAttr || '0ƒë'} ‚Ä¢ 
                                ${stockAttr > 0 ? `C√≤n ${stockAttr}` : 'H·∫øt h√†ng'} ‚Ä¢ 
                                ${statusAttr || 'N/A'}
                            </div>
                        </div>
                        <div class="fw-bold text-success me-3">
                            ${(price * quantity).toLocaleString('vi-VN')}ƒë
                        </div>
                        <div class="d-flex align-items-center gap-2 me-3">
                            <label class="small fw-semibold mb-0">S·ªë l∆∞·ª£ng:</label>
                            <input type="number" 
                                   class="form-control form-control-sm" 
                                   style="width: 80px;" 
                                   min="1" 
                                   max="${stockAttr || 1}" 
                                   value="${quantity}"
                                   onchange="updateProductQuantity('${resourceId}', this.value)"
                                   id="quantity_${resourceId}">
                            <span class="text-muted small">/ ${stockAttr || 0}</span>
                        </div>
                        <button class="btn btn-outline-danger btn-sm" onclick="removeSelectedProduct('${resourceId}')" title="B·ªè ch·ªçn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Mobile: Two rows -->
                    <div class="d-lg-none">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <div class="fw-semibold">${productName}</div>
                            <div class="fw-bold text-success">
                                ${(price * quantity).toLocaleString('vi-VN')}ƒë
                            </div>
                        </div>
                        <div class="text-muted small mb-2">
                            ${priceAttr || '0ƒë'} ‚Ä¢ 
                            ${stockAttr > 0 ? `C√≤n ${stockAttr}` : 'H·∫øt h√†ng'} ‚Ä¢ 
                            ${statusAttr || 'N/A'}
                        </div>
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center gap-2">
                                <label class="small fw-semibold">S·ªë l∆∞·ª£ng:</label>
                                <input type="number" 
                                       class="form-control form-control-sm" 
                                       style="width: 80px;" 
                                       min="1" 
                                       max="${stockAttr || 1}" 
                                       value="${quantity}"
                                       onchange="updateProductQuantity('${resourceId}', this.value)"
                                       id="quantity_${resourceId}">
                                <span class="text-muted small">/ ${stockAttr || 0}</span>
                            </div>
                            <button class="btn btn-outline-danger btn-sm" onclick="removeSelectedProduct('${resourceId}')" title="B·ªè ch·ªçn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
    });
    
    // Update UI
    selectedProductsList.innerHTML = productListHTML;
    selectedTotalPrice.textContent = totalPrice.toLocaleString('vi-VN') + 'ƒë';
    
    // Update total quantity
    const selectedTotalQuantity = document.getElementById('selectedTotalQuantity');
    if (selectedTotalQuantity) {
        selectedTotalQuantity.textContent = totalQuantity;
    }
}

// Function to remove a selected product
function removeSelectedProduct(resourceId) {
    // Try to uncheck checkbox if it exists in current display
    const checkbox = document.querySelector(`input[value="${resourceId}"]`);
    if (checkbox) {
        checkbox.checked = false;
    }
    
    // Remove from selected products map
    selectedProducts.delete(resourceId);
    
    updateDownloadSelectedButton();
    showFilterFeedback('ƒê√£ b·ªè ch·ªçn s·∫£n ph·∫©m');
}

// Function to update product quantity
function updateProductQuantity(resourceId, newQuantity) {
    const quantity = parseInt(newQuantity) || 1;
    
    // Try to get product element from current display first
    let productElement = document.querySelector(`[data-resource-id="${resourceId}"]`);
    
    // If not found in current display, try to find in allProductData
    if (!productElement) {
        const productData = allProductData.find(p => p.id === resourceId);
        if (productData) {
            // Create a virtual element with the data
            productElement = {
                getAttribute: (attr) => {
                    switch(attr) {
                        case 'data-stock': return productData.stock_quantity || 0;
                        default: return '';
                    }
                }
            };
        }
    }
    
    if (productElement) {
        const stockAttr = productElement.getAttribute('data-stock');
        const maxStock = parseInt(stockAttr) || 1;
        
        // Validate quantity
        if (quantity < 1) {
            const quantityInput = document.getElementById(`quantity_${resourceId}`);
            if (quantityInput) quantityInput.value = 1;
            return;
        }
        
        if (quantity > maxStock) {
            const quantityInput = document.getElementById(`quantity_${resourceId}`);
            if (quantityInput) quantityInput.value = maxStock;
            showFilterFeedback(`S·ªë l∆∞·ª£ng kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° ${maxStock}`);
            return;
        }
        
        // Update selected products map
        const selectedProduct = selectedProducts.get(resourceId);
        if (selectedProduct) {
            selectedProduct.quantity = quantity;
            selectedProducts.set(resourceId, selectedProduct);
        }
        
        // Update UI
        updateSelectedProductsSummary();
    }
}

// Function to add product to selected list
function addProductToSelected(resourceId) {
    // Try to get product element from current display first
    let productElement = document.querySelector(`[data-resource-id="${resourceId}"]`);
    
    // If not found in current display, try to find in allProductData
    if (!productElement) {
        const productData = allProductData.find(p => p.id === resourceId);
        if (productData) {
            // Create a virtual element with the data
            productElement = {
                getAttribute: (attr) => {
                    switch(attr) {
                        case 'title': return productData.name;
                        case 'data-stock': return productData.stock_quantity || 0;
                        case 'data-price': return productData.discounted_price ? Number(productData.discounted_price * 1000).toLocaleString('vi-VN') + 'ƒë' : '0ƒë';
                        case 'data-status': return productData.status ? getProductStatusText(productData.status) : 'N/A';
                        default: return '';
                    }
                }
            };
        }
    }
    
    if (productElement) {
        const productData = {
            name: productElement.getAttribute('title') || 'S·∫£n ph·∫©m',
            stock: productElement.getAttribute('data-stock') || 0,
            price: productElement.getAttribute('data-price') || '0ƒë',
            status: productElement.getAttribute('data-status') || 'N/A'
        };
        
        selectedProducts.set(resourceId, {
            productData: productData,
            quantity: 1
        });
    }
}

// Function to clear all selected products
function clearAllSelectedProducts() {
    // Uncheck all checkboxes
    const allCheckboxes = document.querySelectorAll('.resource-checkbox');
    allCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Clear selected products map
    selectedProducts.clear();
    
    // Hide both views
    document.getElementById('selectedProductsImages').style.display = 'none';
    document.getElementById('selectedProductsSummary').style.display = 'none';
    
    // Update UI
    updateDownloadSelectedButton();
    showFilterFeedback('ƒê√£ x√≥a t·∫•t c·∫£ s·∫£n ph·∫©m ƒë√£ ch·ªçn');
}

// Function to toggle selected products images view
function toggleSelectedProductsView() {
    const imagesView = document.getElementById('selectedProductsImages');
    const summaryView = document.getElementById('selectedProductsSummary');
    const toggleBtn = document.getElementById('toggleViewBtn');
    const summaryBtn = document.getElementById('toggleSummaryBtn');
    
    if (imagesView.style.display === 'none') {
        // Show images view
        imagesView.style.display = 'block';
        summaryView.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-eye-slash me-1"></i>·∫®n ·∫£nh';
        toggleBtn.classList.remove('btn-outline-info');
        toggleBtn.classList.add('btn-info');
        summaryBtn.classList.remove('btn-warning');
        summaryBtn.classList.add('btn-outline-warning');
        
        // Update images display
        updateSelectedProductsImages();
    } else {
        // Hide images view
        imagesView.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-images me-1"></i>Hi·ªán ·∫£nh';
        toggleBtn.classList.remove('btn-info');
        toggleBtn.classList.add('btn-outline-info');
    }
}

// Function to toggle selected products summary view
function toggleSelectedProductsSummary() {
    const imagesView = document.getElementById('selectedProductsImages');
    const summaryView = document.getElementById('selectedProductsSummary');
    const toggleBtn = document.getElementById('toggleViewBtn');
    const summaryBtn = document.getElementById('toggleSummaryBtn');
    
    if (summaryView.style.display === 'none') {
        // Show summary view
        summaryView.style.display = 'block';
        imagesView.style.display = 'none';
        summaryBtn.innerHTML = '<i class="fas fa-eye-slash me-1"></i>·∫®n t√≠nh to√°n';
        summaryBtn.classList.remove('btn-outline-warning');
        summaryBtn.classList.add('btn-warning');
        toggleBtn.classList.remove('btn-info');
        toggleBtn.classList.add('btn-outline-info');
        
        // Update summary display
        updateSelectedProductsSummary();
    } else {
        // Hide summary view
        summaryView.style.display = 'none';
        summaryBtn.innerHTML = '<i class="fas fa-calculator me-1"></i>Hi·ªán t√≠nh to√°n';
        summaryBtn.classList.remove('btn-warning');
        summaryBtn.classList.add('btn-outline-warning');
    }
}

// Function to update selected products images display
function updateSelectedProductsImages() {
    const imagesList = document.getElementById('selectedProductsImagesList');
    const imagesCount = document.getElementById('selectedImagesCount');
    
    if (selectedProducts.size === 0) {
        imagesList.innerHTML = '<div class="col-12 text-center text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn</div>';
        imagesCount.textContent = '0';
        return;
    }
    
    imagesCount.textContent = selectedProducts.size;
    
    // Clear current list
    imagesList.innerHTML = '';
    
    selectedProducts.forEach((selectedProduct, resourceId) => {
        // Find the actual tile in #productResources
        const itemEl = document.querySelector(`#productResources [data-resource-id="${resourceId}"]`);
        if (itemEl) {
            const columnEl = itemEl.closest('div.col-md-3, div.col-lg-2, div.col-6, .mb-3') || itemEl.parentElement;
            const clone = columnEl.cloneNode(true);
            // Ensure checkbox reflects selected state
            const cb = clone.querySelector(`input.resource-checkbox[value="${resourceId}"]`);
            if (cb) cb.checked = true;
            // Append to images list
            const wrapper = document.createElement('div');
            wrapper.className = 'col-md-2 col-sm-3 col-4';
            // Keep only the core card (.resource-item) to make grid compact
            const core = clone.querySelector('.resource-item') || clone;
            wrapper.appendChild(core.cloneNode(true));
            imagesList.appendChild(wrapper);
            return;
        }
        
        // Fallback: build a minimal card from allProductData
        const productData = allProductData.find(p => p.id === resourceId);
        if (productData && productData.file_url) {
            const wrapper = document.createElement('div');
            wrapper.className = 'col-md-2 col-sm-3 col-4';
            wrapper.innerHTML = `
                <div class="selected-product-image" title="${productData.name}">
                    <img src="${productData.file_url}" alt="${productData.name}">
                    <div class="quantity-badge">${selectedProduct.quantity || 1}</div>
                    <button class="remove-btn" onclick="removeSelectedProduct('${resourceId}')" title="B·ªè ch·ªçn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            imagesList.appendChild(wrapper);
        }
    });
}

// Function to select all filtered products (only visible ones)
function selectAllFilteredProducts() {
    const visibleCheckboxes = document.querySelectorAll('#productResources .resource-checkbox');
    visibleCheckboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    updateDownloadSelectedButton();
    
    // Show feedback
    const count = visibleCheckboxes.length;
    showFilterFeedback(`ƒê√£ ch·ªçn ${count} s·∫£n ph·∫©m ƒëang hi·ªÉn th·ªã`);
}

// Function to deselect all filtered products (only visible ones)
function deselectAllFilteredProducts() {
    const visibleCheckboxes = document.querySelectorAll('#productResources .resource-checkbox');
    visibleCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateDownloadSelectedButton();
    
    // Show feedback
    const count = visibleCheckboxes.length;
    showFilterFeedback(`ƒê√£ b·ªè ch·ªçn ${count} s·∫£n ph·∫©m ƒëang hi·ªÉn th·ªã`);
}

// Function to show filter feedback
function showFilterFeedback(message) {
    // Remove existing feedback if any
    const existingFeedback = document.getElementById('filterFeedback');
    if (existingFeedback) {
        existingFeedback.remove();
    }
    
    // Create new feedback
    const feedback = document.createElement('div');
    feedback.id = 'filterFeedback';
    feedback.className = 'position-fixed top-0 end-0 m-3 p-2 bg-info text-white rounded shadow';
    feedback.style.zIndex = '9999';
    feedback.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-info-circle me-2"></i>
            <small>${message}</small>
        </div>
    `;
    
    document.body.appendChild(feedback);
    
    // Remove after 2 seconds
    setTimeout(() => {
        if (feedback.parentNode) {
            feedback.parentNode.removeChild(feedback);
        }
    }, 2000);
}

// Function to update filtered selection button states
function updateFilteredSelectionButtons() {
    const visibleCheckboxes = document.querySelectorAll('#productResources .resource-checkbox');
    const selectFilteredBtn = document.getElementById('selectFilteredBtn');
    const deselectFilteredBtn = document.getElementById('deselectFilteredBtn');
    
    if (visibleCheckboxes.length === 0) {
        selectFilteredBtn.disabled = true;
        deselectFilteredBtn.disabled = true;
        selectFilteredBtn.innerHTML = '<i class="fas fa-check-square me-1"></i>Ch·ªçn t·∫•t c·∫£ ƒë√£ l·ªçc';
        deselectFilteredBtn.innerHTML = '<i class="fas fa-square me-1"></i>B·ªè ch·ªçn ƒë√£ l·ªçc';
    } else {
        selectFilteredBtn.disabled = false;
        deselectFilteredBtn.disabled = false;
        selectFilteredBtn.innerHTML = `<i class="fas fa-check-square me-1"></i>Ch·ªçn t·∫•t c·∫£ ƒë√£ l·ªçc (${visibleCheckboxes.length})`;
        deselectFilteredBtn.innerHTML = `<i class="fas fa-square me-1"></i>B·ªè ch·ªçn ƒë√£ l·ªçc (${visibleCheckboxes.length})`;
    }
}

// Function to select all products
function selectAllProducts() {
    const checkboxes = document.querySelectorAll('.resource-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    updateDownloadSelectedButton();
}

// Function to deselect all products
function deselectAllProducts() {
    const checkboxes = document.querySelectorAll('.resource-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateDownloadSelectedButton();
}

// Function to update download selected button state
function updateDownloadSelectedButton() {
    const selectedCheckboxes = document.querySelectorAll('.resource-checkbox:checked');
    const downloadSelectedBtn = document.getElementById('downloadSelectedBtn');
    
    // Add newly selected products to map
    selectedCheckboxes.forEach(checkbox => {
        const resourceId = checkbox.value;
        if (!selectedProducts.has(resourceId)) {
            addProductToSelected(resourceId);
        }
    });
    
    // Only remove from map if checkbox is explicitly unchecked (not just hidden by filter)
    selectedProducts.forEach((value, resourceId) => {
        const checkbox = document.querySelector(`input[value="${resourceId}"]`);
        // Only remove if checkbox exists and is explicitly unchecked
        if (checkbox && !checkbox.checked) {
            selectedProducts.delete(resourceId);
        }
    });
    
    if (selectedProducts.size > 0) {
        downloadSelectedBtn.disabled = false;
        downloadSelectedBtn.innerHTML = `<i class="fas fa-download me-1"></i>T·∫£i ƒë√£ ch·ªçn (${selectedProducts.size})`;
    } else {
        downloadSelectedBtn.disabled = true;
        downloadSelectedBtn.innerHTML = '<i class="fas fa-download me-1"></i>T·∫£i ƒë√£ ch·ªçn';
    }
    
    // Update selected products summary
    updateSelectedProductsSummary();
    
    // Update images view if it's visible
    const imagesView = document.getElementById('selectedProductsImages');
    if (imagesView && imagesView.style.display !== 'none') {
        updateSelectedProductsImages();
    }
}

// Function to download selected products with watermark
async function downloadSelectedWithWatermark() {
    if (selectedProducts.size === 0) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ t·∫£i xu·ªëng');
        return;
    }
    
    const watermarkEnabled = document.getElementById('watermarkToggle').checked;
    const confirmMessage = watermarkEnabled ? 
        `T·∫£i xu·ªëng ${selectedProducts.size} s·∫£n ph·∫©m ƒë√£ ch·ªçn v·ªõi watermark (logo, t√™n, gi√°, t√¨nh tr·∫°ng)?` :
        `T·∫£i xu·ªëng ${selectedProducts.size} s·∫£n ph·∫©m ƒë√£ ch·ªçn kh√¥ng c√≥ watermark?`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // Disable button during download
    const downloadBtn = document.getElementById('downloadSelectedBtn');
    const originalText = downloadBtn.innerHTML;
    downloadBtn.disabled = true;
    downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang t·∫£i...';
    
    try {
        let successCount = 0;
        let errorCount = 0;
        
        for (const [resourceId, selectedProduct] of selectedProducts) {
            // Try to get product element from current display first
            let productElement = document.querySelector(`[data-resource-id="${resourceId}"]`);
            
            // If not found in current display, try to find in allProductData
            if (!productElement) {
                const productData = allProductData.find(p => p.id === resourceId);
                if (productData) {
                    // Create a virtual element with the data
                    productElement = {
                        getAttribute: (attr) => {
                            switch(attr) {
                                case 'title': return productData.name;
                                default: return '';
                            }
                        },
                        querySelector: (selector) => {
                            if (selector === 'img' && productData.file_url) {
                                return { src: productData.file_url };
                            }
                            return null;
                        }
                    };
                }
            }
            
            const resourceName = productElement ? productElement.getAttribute('title') : 'S·∫£n ph·∫©m';
            const img = productElement ? productElement.querySelector('img') : null;
            
            if (img && resourceId && resourceName) {
                try {
                    // Download multiple times based on quantity
                    for (let i = 0; i < selectedProduct.quantity; i++) {
                        await downloadResource(resourceId, img.src, resourceName);
                        successCount++;
                        
                        // Small delay between downloads
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                } catch (error) {
                    console.error(`Error downloading ${resourceName}:`, error);
                    errorCount++;
                }
            }
        }
        
        alert(`T·∫£i xu·ªëng ho√†n t·∫•t!\nTh√†nh c√¥ng: ${successCount}\nL·ªói: ${errorCount}`);
        
        // Clear all selected products
        clearAllSelectedProducts();
        
        // Hide summary after download
        document.getElementById('selectedProductsSummary').style.display = 'none';
        
    } catch (error) {
        console.error('Error in selected download:', error);
        alert('C√≥ l·ªói x·∫£y ra khi t·∫£i xu·ªëng c√°c s·∫£n ph·∫©m ƒë√£ ch·ªçn');
    } finally {
        // Re-enable button
        downloadBtn.disabled = false;
        downloadBtn.innerHTML = originalText;
    }
}

// Mode management functions
function setMode(mode) {
    console.log('üîÑ Setting mode to:', mode);
    currentMode = mode;
    
    // Update button states
    const downloadBtn = document.getElementById('downloadModeBtn');
    const editBtn = document.getElementById('editModeBtn');
    
    if (mode === 'download') {
        downloadBtn.classList.add('active');
        downloadBtn.classList.remove('btn-outline-primary');
        downloadBtn.classList.add('btn-primary');
        editBtn.classList.remove('active');
        editBtn.classList.remove('btn-warning');
        editBtn.classList.add('btn-outline-warning');
        
        // Update cursor style for all product images
        document.querySelectorAll('[data-resource-type="product"] img').forEach(img => {
            img.style.cursor = 'pointer';
        });
        
        showModeFeedback('Ch·∫ø ƒë·ªô t·∫£i xu·ªëng - Click ·∫£nh ƒë·ªÉ t·∫£i xu·ªëng', 'info');
    } else if (mode === 'edit') {
        editBtn.classList.add('active');
        editBtn.classList.remove('btn-outline-warning');
        editBtn.classList.add('btn-warning');
        downloadBtn.classList.remove('active');
        downloadBtn.classList.remove('btn-primary');
        downloadBtn.classList.add('btn-outline-primary');
        
        // Update cursor style for all product images
        document.querySelectorAll('[data-resource-type="product"] img').forEach(img => {
            img.style.cursor = 'crosshair';
        });
        
        showModeFeedback('Ch·∫ø ƒë·ªô ch·ªânh s·ª≠a - Click ·∫£nh ƒë·ªÉ ch·ªânh s·ª≠a s·ªë l∆∞·ª£ng', 'warning');
    }
    
    // Update cursor for all existing product images
    document.querySelectorAll('[data-resource-type="product"] img').forEach(img => {
        if (currentMode === 'edit') {
            img.style.cursor = 'crosshair';
        } else {
            img.style.cursor = 'pointer';
        }
    });
}

function handleProductClick(resourceId, fileUrl, fileName) {
    console.log('üéØ handleProductClick called:', { resourceId, fileUrl, fileName, currentMode });
    
    if (currentMode === 'download') {
        console.log('üì• Download mode - calling downloadResource');
        // Download mode - download the resource
        downloadResource(resourceId, fileUrl, fileName);
    } else if (currentMode === 'edit') {
        console.log('‚úèÔ∏è Edit mode - calling toggleStockEdit');
        // Edit mode - edit stock quantity
        toggleStockEdit(resourceId);
    } else {
        console.warn('‚ùå Unknown mode:', currentMode);
    }
}


function updateProductCursors(container) {
    container.querySelectorAll('[data-resource-type="product"] img').forEach(img => {
        if (currentMode === 'edit') {
            img.style.cursor = 'crosshair';
        } else {
            img.style.cursor = 'pointer';
        }
    });
}

function showModeFeedback(message, type = 'info') {
    // Remove existing feedback if any
    const existingFeedback = document.getElementById('modeFeedback');
    if (existingFeedback) {
        existingFeedback.remove();
    }
    
    // Create new feedback
    const feedback = document.createElement('div');
    feedback.id = 'modeFeedback';
    const bgClass = type === 'success' ? 'bg-success' : type === 'warning' ? 'bg-warning' : 'bg-info';
    feedback.className = `position-fixed top-0 start-50 translate-middle-x m-3 p-2 ${bgClass} text-white rounded shadow`;
    feedback.style.zIndex = '9999';
    feedback.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            <small>${message}</small>
        </div>
    `;
    
    document.body.appendChild(feedback);
    
    // Remove after 3 seconds
    setTimeout(() => {
        if (feedback.parentNode) {
            feedback.parentNode.removeChild(feedback);
        }
    }, 3000);
}

// Stock management functions
function toggleStockEdit(resourceId) {
    console.log('üîß toggleStockEdit called with resourceId:', resourceId);
    
    // Try to find the container by resourceId
    let container = document.querySelector(`[data-resource-id="${resourceId}"] .stock-badge-container`);
    console.log('üîç Found container by resourceId:', container);
    
    // If not found, try to find by looking for the specific resource
    if (!container) {
        // Look for the resource item first
        const resourceItem = document.querySelector(`[data-resource-id="${resourceId}"]`);
        console.log('üîç Found resource item:', resourceItem);
        
        if (resourceItem) {
            container = resourceItem.querySelector('.stock-badge-container');
            console.log('üîç Found container in resource item:', container);
        }
    }
    
    if (!container) {
        console.warn('‚ùå No container found for resourceId:', resourceId);
        console.log('üîç Available resource items:', document.querySelectorAll('[data-resource-id]'));
        return;
    }
    
    const badge = container.querySelector('.badge');
    const editInput = container.querySelector('.stock-edit-input');
    const input = container.querySelector('input[type="number"]');
    
    console.log('üîç Badge:', badge, 'EditInput:', editInput, 'Input:', input);
    
    if (editInput.style.display === 'none' || editInput.style.display === '') {
        // Show edit mode
        console.log('üìù Showing edit mode');
        badge.style.display = 'none';
        editInput.style.display = 'block';
        editInput.style.visibility = 'visible';
        editInput.style.opacity = '1';
        
        // Focus and select input
        setTimeout(() => {
            if (input) {
                input.focus();
                input.select();
                console.log('üìù Input focused and selected');
            }
        }, 50);
    } else {
        // Hide edit mode
        console.log('üìù Hiding edit mode');
        editInput.style.display = 'none';
        editInput.style.visibility = 'hidden';
        editInput.style.opacity = '0';
        badge.style.display = 'block';
    }
}

function cancelStockEdit(resourceId) {
    const container = document.querySelector(`[data-resource-id="${resourceId}"] .stock-badge-container`);
    if (!container) return;
    
    const badge = container.querySelector('.badge');
    const editInput = container.querySelector('.stock-edit-input');
    
    editInput.style.display = 'none';
    badge.style.display = 'block';
}

function handleStockInputKeypress(event, resourceId) {
    if (event.key === 'Enter') {
        event.preventDefault();
        saveStockQuantity(resourceId, event.target.value);
    } else if (event.key === 'Escape') {
        event.preventDefault();
        cancelStockEdit(resourceId);
    }
}

async function saveStockQuantity(resourceId, newQuantity) {
    const quantity = parseInt(newQuantity) || 0;
    
    // Validate quantity
    if (quantity < 0) {
        showStockFeedback('S·ªë l∆∞·ª£ng kh√¥ng th·ªÉ √¢m', 'error');
        cancelStockEdit(resourceId);
        return;
    }
    
    // Extract product ID from resourceId (format: product_123_1)
    const productId = resourceId.startsWith('product_') ? resourceId.split('_')[1] : resourceId;
    
    try {
        // Show loading state
        showStockFeedback('ƒêang c·∫≠p nh·∫≠t...', 'info');
        
        // Update stock via API
        const response = await fetch(`https://buddyskincare.vn/backend/api/products/${productId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                stock_quantity: quantity
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const updatedProduct = await response.json();
        
        // Update local data
        const productData = allProductData.find(p => p.id === resourceId);
        if (productData) {
            productData.stock_quantity = quantity;
        }
        
        // Update UI
        updateStockDisplay(resourceId, quantity);
        
        // Update data attributes for watermark
        const productElement = document.querySelector(`[data-resource-id="${resourceId}"]`);
        if (productElement) {
            productElement.setAttribute('data-stock', quantity);
        }
        
        showStockFeedback('C·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');
        
        // Hide edit mode
        cancelStockEdit(resourceId);
        
    } catch (error) {
        console.error('Error updating stock:', error);
        showStockFeedback('L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng', 'error');
        cancelStockEdit(resourceId);
    }
}

function updateStockDisplay(resourceId, newQuantity) {
    const container = document.querySelector(`[data-resource-id="${resourceId}"] .stock-badge-container`);
    if (!container) return;
    
    const badge = container.querySelector('.badge');
    const stockDisplay = container.querySelector('.stock-display');
    const input = container.querySelector('input[type="number"]');
    
    // Update display text
    stockDisplay.textContent = newQuantity > 0 ? newQuantity : 'H·∫øt h√†ng';
    
    // Update badge color
    if (newQuantity > 0) {
        badge.classList.remove('bg-danger');
        badge.classList.add('bg-success');
    } else {
        badge.classList.remove('bg-success');
        badge.classList.add('bg-danger');
    }
    
    // Update input value
    input.value = newQuantity;
}

function showStockFeedback(message, type = 'info') {
    // Remove existing feedback if any
    const existingFeedback = document.getElementById('stockFeedback');
    if (existingFeedback) {
        existingFeedback.remove();
    }
    
    // Create new feedback
    const feedback = document.createElement('div');
    feedback.id = 'stockFeedback';
    const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';
    feedback.className = `position-fixed top-0 start-50 translate-middle-x m-3 p-2 ${bgClass} text-white rounded shadow`;
    feedback.style.zIndex = '9999';
    feedback.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            <small>${message}</small>
        </div>
    `;
    
    document.body.appendChild(feedback);
    
    // Remove after 3 seconds
    setTimeout(() => {
        if (feedback.parentNode) {
            feedback.parentNode.removeChild(feedback);
        }
    }, 3000);
}

// Function to download all products with watermark
async function downloadAllWithWatermark() {
    const watermarkEnabled = document.getElementById('watermarkToggle').checked;
    const productElements = document.querySelectorAll('[data-resource-type="product"]');
    
    if (productElements.length === 0) {
        alert('Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë·ªÉ t·∫£i xu·ªëng');
        return;
    }
    
    const confirmMessage = watermarkEnabled ? 
        `T·∫£i xu·ªëng ${productElements.length} s·∫£n ph·∫©m v·ªõi watermark (logo, t√™n, gi√°, t√¨nh tr·∫°ng)?` :
        `T·∫£i xu·ªëng ${productElements.length} s·∫£n ph·∫©m kh√¥ng c√≥ watermark?`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // Disable button during download
    const downloadBtn = document.getElementById('downloadAllBtn');
    const originalText = downloadBtn.innerHTML;
    downloadBtn.disabled = true;
    downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang t·∫£i...';
    
    try {
        let successCount = 0;
        let errorCount = 0;
        
        for (let i = 0; i < productElements.length; i++) {
            const element = productElements[i];
            const resourceId = element.getAttribute('data-resource-id');
            const resourceName = element.getAttribute('title');
            const img = element.querySelector('img');
            
            if (img && resourceId && resourceName) {
                try {
                    await downloadResource(resourceId, img.src, resourceName);
                    successCount++;
                    
                    // Small delay between downloads
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    console.error(`Error downloading ${resourceName}:`, error);
                    errorCount++;
                }
            }
        }
        
        alert(`T·∫£i xu·ªëng ho√†n t·∫•t!\nTh√†nh c√¥ng: ${successCount}\nL·ªói: ${errorCount}`);
        
    } catch (error) {
        console.error('Error in batch download:', error);
        alert('C√≥ l·ªói x·∫£y ra khi t·∫£i xu·ªëng h√†ng lo·∫°t');
    } finally {
        // Re-enable button
        downloadBtn.disabled = false;
        downloadBtn.innerHTML = originalText;
    }
}
</script>
{% endblock %}


{% extends "ctv_base.html" %}

{% block title %}T√†i nguy√™n Marketing{% endblock %}

{% block ctv_body %}
<div class="ctv-card p-3">
  <h1 class="h6">T√†i nguy√™n Marketing</h1>
  <p class="text-muted small">T·∫£i xu·ªëng banner, ·∫£nh s·∫£n ph·∫©m, v√† n·ªôi dung m·∫´u ƒë·ªÉ chia s·∫ª.</p>
  
  <!-- Filter tabs -->
  <ul class="nav nav-tabs mb-3" id="resourceTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">
        T·∫•t c·∫£
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="new-product-tab" data-bs-toggle="tab" data-bs-target="#new-product" type="button" role="tab">
        S·∫£n ph·∫©m m·ªõi
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="event-tab" data-bs-toggle="tab" data-bs-target="#event" type="button" role="tab">
        S·ª± ki·ªán
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="product-tab" data-bs-toggle="tab" data-bs-target="#product" type="button" role="tab">
        S·∫£n ph·∫©m
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="article-tab" data-bs-toggle="tab" data-bs-target="#article" type="button" role="tab">
        B√†i vi·∫øt m·∫´u
      </button>
    </li>
  </ul>

  <!-- Tab content -->
  <div class="tab-content" id="resourceTabContent">
    <div class="tab-pane fade show active" id="all" role="tabpanel">
      <div class="row g-3" id="allResources">
        <div class="col-12 text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ƒêang t·∫£i...</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="tab-pane fade" id="new-product" role="tabpanel">
      <div class="row g-3" id="newProductResources">
        <div class="col-12 text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ƒêang t·∫£i...</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="tab-pane fade" id="event" role="tabpanel">
      <div class="row g-3" id="eventResources">
        <div class="col-12 text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ƒêang t·∫£i...</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="tab-pane fade" id="product" role="tabpanel">
      <div class="row g-3" id="productResources">
        <div class="col-12 text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ƒêang t·∫£i...</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="tab-pane fade" id="article" role="tabpanel">
      <div class="row g-3" id="articleResources">
        <div class="col-12 text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ƒêang t·∫£i...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.resource-item {
    transition: transform 0.2s ease;
}

.resource-item:hover {
    transform: translateY(-2px);
}

.resource-item img {
    transition: opacity 0.2s ease;
}

.resource-item:hover img {
    opacity: 0.9;
}

.resource-tooltip {
    z-index: 10;
    word-wrap: break-word;
}

.resource-overlay {
    display: none !important;
    transition: opacity 0.2s ease;
}

.resource-item:hover .resource-overlay {
    display: flex !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Load resources when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadAllResources();
    
    // Load resources when tab is clicked
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (e) {
            const target = e.target.getAttribute('data-bs-target');
            switch(target) {
                case '#all':
                    loadAllResources();
                    break;
                case '#new-product':
                    loadResourcesByType('new_product');
                    break;
                case '#event':
                    loadResourcesByType('event');
                    break;
                case '#product':
                    loadProductImages();
                    break;
                case '#article':
                    loadResourcesByType('article');
                    break;
            }
        });
    });
});

async function loadAllResources() {
    try {
        const response = await fetch('https://buddyskincare.vn/backend/api/marketing-resources/');
        const resources = await response.json();
        displayResources(resources, 'allResources');
    } catch (error) {
        console.error('Error loading resources:', error);
        document.getElementById('allResources').innerHTML = '<div class="col-12 text-center text-danger">L·ªói khi t·∫£i t√†i nguy√™n</div>';
    }
}

async function loadResourcesByType(type) {
    try {
        const response = await fetch(`https://buddyskincare.vn/backend/api/marketing-resources/by-type/?type=${type}`);
        const resources = await response.json();
        const containerId = type === 'new_product' ? 'newProductResources' : 
                           type === 'event' ? 'eventResources' : 'articleResources';
        displayResources(resources, containerId);
    } catch (error) {
        console.error('Error loading resources:', error);
        const containerId = type === 'new_product' ? 'newProductResources' : 
                           type === 'event' ? 'eventResources' : 'articleResources';
        document.getElementById(containerId).innerHTML = '<div class="col-12 text-center text-danger">L·ªói khi t·∫£i t√†i nguy√™n</div>';
    }
}

async function loadProductImages() {
    try {
        // G·ªçi tr·ª±c ti·∫øp Django API thay v√¨ Flask API
        const response = await fetch('https://buddyskincare.vn/backend/api/products/?status=new');
        const products = await response.json();
        console.log(`üîç Loaded ${products.length} products from Django API`);
        
        const productData = [];
        
        products.forEach(product => {
            // L·∫•y t·∫•t c·∫£ ·∫£nh c·ªßa s·∫£n ph·∫©m
            const allImages = product.all_images || [];
            
            allImages.forEach((imageUrl, index) => {
                if (imageUrl && imageUrl.trim()) {
                    productData.push({
                        id: `product_${product.id}_${index + 1}`,
                        name: `${product.name} - ·∫¢nh ${index + 1}`,
                        description: `S·∫£n ph·∫©m ${product.brand_name || 'Kh√¥ng x√°c ƒë·ªãnh'}`,
                        resource_type: 'product',
                        file_url: imageUrl,
                        thumbnail_url: imageUrl,
                        product_id: product.id,
                        product_name: product.name,
                        stock_quantity: product.stock_quantity || 0,
                        is_image: true,
                        file_extension: imageUrl.split('.').pop().toLowerCase() || 'jpg',
                        image_index: index + 1,
                        total_images: allImages.length
                    });
                }
            });
        });
        
        console.log(`üîç Products with images: ${productData.length}`);
        displayResources(productData, 'productResources');
    } catch (error) {
        console.error('Error loading product images:', error);
        document.getElementById('productResources').innerHTML = '<div class="col-12 text-center text-danger">L·ªói khi t·∫£i ·∫£nh s·∫£n ph·∫©m</div>';
    }
}

function displayResources(resources, containerId) {
    const container = document.getElementById(containerId);
    
    if (!resources || resources.length === 0) {
        container.innerHTML = '<div class="col-12 text-center text-muted">Kh√¥ng c√≥ t√†i nguy√™n n√†o</div>';
        return;
    }
    
    container.innerHTML = resources.map(resource => {
        const isImage = resource.is_image;
        const showDescription = resource.resource_type === 'event' || resource.resource_type === 'article';
        
        return `
            <div class="col-md-3 col-lg-2 col-6 mb-3">
                <div class="resource-item position-relative" 
                     style="cursor: default;" 
                     title="${resource.name}"
                     data-resource-id="${resource.id}"
                     data-resource-type="${resource.resource_type}">
                    ${isImage ? `
                        <div class="text-center position-relative">
                            <img src="${resource.thumbnail_url || resource.file_url}" 
                                 class="img-fluid rounded shadow-sm" 
                                 style="width: 100%; max-height: 300px; object-fit: contain;"
                                 alt="${resource.name}">
                            ${resource.resource_type === 'product' && resource.stock_quantity !== undefined ? `
                                <div class="position-absolute top-0 end-0 m-1">
                                    <span class="badge ${resource.stock_quantity > 0 ? 'bg-success' : 'bg-danger'}" 
                                          style="font-size: 10px; padding: 2px 6px;">
                                        <i class="fas fa-boxes me-1"></i>${resource.stock_quantity}
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <div class="text-center bg-light rounded shadow-sm d-flex align-items-center justify-content-center" 
                             style="height: 120px;">
                            <i class="fas fa-file-alt fa-2x text-muted"></i>
                        </div>
                    `}
                    
                   
                    
                    <!-- N√∫t copy description cho event v√† article -->
                    ${showDescription && resource.description ? `
                       
                    ` : ''}
                    
                    <!-- Overlay hi·ªÉn th·ªã khi hover -->
                    <div class="resource-overlay position-absolute top-0 start-0 end-0 bottom-0 bg-dark bg-opacity-75 text-white d-flex align-items-center justify-content-center rounded" 
                         style="display: none; font-size: 12px; text-align: center; z-index: 10;">
                        ${showDescription && resource.description ? `
                            <div class="d-flex flex-column align-items-center gap-3">
                                <div class="d-flex gap-4">
                                    <div class="text-center copy-description-btn" 
                                         data-description="${resource.description}"
                                         data-resource-name="${resource.name}"
                                         style="cursor: pointer;">
                                        <i class="fas fa-copy fa-2x mb-2"></i>
                                        <div>Copy m√¥ t·∫£</div>
                                    </div>
                                    <div class="text-center" 
                                         onclick="event.stopPropagation(); downloadResource(${resource.id}, '${resource.file_url}', '${resource.name}')"
                                         style="cursor: pointer;">
                                        <i class="fas fa-download fa-2x mb-2"></i>
                                        <div>T·∫£i xu·ªëng</div>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div class="text-center" 
                                 onclick="downloadResource(${resource.id}, '${resource.file_url}', '${resource.name}')"
                                 style="cursor: pointer;">
                                <i class="fas fa-download fa-2x mb-2"></i>
                                <div>Click ƒë·ªÉ t·∫£i xu·ªëng</div>
                            </div>
                        `}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    // CSS hover s·∫Ω t·ª± ƒë·ªông x·ª≠ l√Ω hi·ªÉn th·ªã overlay
    
    // Th√™m event listeners cho n√∫t copy description
    container.querySelectorAll('.copy-description-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const description = this.getAttribute('data-description');
            const resourceName = this.getAttribute('data-resource-name');
            copyDescription(description, resourceName);
        });
    });
}

async function downloadResource(resourceId, fileUrl, fileName) {
    try {
        // Track download first
        await fetch(`https://buddyskincare.vn/backend/api/marketing-resources/${resourceId}/download/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        // Force download the file
        const response = await fetch(fileUrl);
        const blob = await response.blob();
        
        // Create download link
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        
        // Get file extension from URL or default to jpg
        const urlParts = fileUrl.split('.');
        const extension = urlParts.length > 1 ? urlParts[urlParts.length - 1] : 'jpg';
        link.download = `buddy_image_${resourceId}.${extension}`;
        
        // Trigger download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Clean up
        window.URL.revokeObjectURL(downloadUrl);
        
    } catch (error) {
        console.error('Error downloading resource:', error);
        // Fallback: open in new tab
        window.open(fileUrl, '_blank');
    }
}

async function trackDownload(resourceId) {
    try {
        await fetch(`https://buddyskincare.vn/backend/api/marketing-resources/${resourceId}/download/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
    } catch (error) {
        console.error('Error tracking download:', error);
    }
}

async function copyDescription(description, resourceName) {
    try {
        // Copy description to clipboard
        await navigator.clipboard.writeText(description);
        
        // Show success message
        const toast = document.createElement('div');
        toast.className = 'position-fixed top-0 end-0 m-3 p-3 bg-success text-white rounded shadow';
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-check-circle me-2"></i>
                <div>
                    <strong>ƒê√£ copy!</strong><br>
                    <small>M√¥ t·∫£ c·ªßa c·ªßa b√†i vi·∫øt. Ch√∫c b·∫°n mua may b√°n ƒë·∫Øt nh√©.</small>
                </div>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Remove toast after 3 seconds
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 3000);
        
    } catch (error) {
        console.error('Error copying description:', error);
        
        // Fallback: show alert
        alert(`M√¥ t·∫£ c·ªßa "${resourceName}":\n\n${description}`);
    }
}
</script>
{% endblock %}


{% extends "ctv_base.html" %}

{% block title %}Đơn hàng CTV{% endblock %}

{% block ctv_body %}
<div class="ctv-card p-3">
  <div class="d-flex justify-content-between align-items-center">
    <h1 class="h6 mb-0">Đơn hàng có mã CTV của bạn</h1>
    <small id="oCount" class="text-muted"></small>
  </div>
  <div class="table-responsive mt-2">
    <table class="table align-middle">
      <thead><tr><th>Mã đơn</th><th>Ngày</th><th>Trạng thái</th><th>Giá trị</th></tr></thead>
      <tbody id="oRows"></tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Inject CTV data từ server-side session
{% if g.ctv %}
window.ctvData = {{ g.ctv | tojson }};
{% else %}
window.ctvData = null;
{% endif %}

function getCtv(){ 
  try { 
    return window.ctvData || null; 
  } catch(e){ 
    return null; 
  } 
}
function fmt(n){return (Number(n)||0).toLocaleString('vi-VN')+" đ"}

async function loadOrders(){
  const ctv = getCtv(); if (!ctv){ location.href='/ctv/login/'; return; }
  // Lấy orders qua router /orders/ có filter đơn giản phía client
  const all = await fetch('/orders/').then(r=>r.json());
  const list = Array.isArray(all)? all.filter(o=> (o.collaborator_code||'').toUpperCase()===(ctv.code||'').toUpperCase()) : [];
  document.getElementById('oCount').textContent = `${list.length} đơn`;
  const tbody = document.getElementById('oRows'); tbody.innerHTML='';
  for (const o of list){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${o.order_code||('#'+o.id)}</td><td>${new Date(o.order_date).toLocaleString('vi-VN')}</td><td>${o.status}</td><td>${fmt(o.total_amount)}</td>`;
    tbody.appendChild(tr);
  }
}

document.addEventListener('DOMContentLoaded', loadOrders);
</script>
{% endblock %}


{% extends 'admin_base.html' %}

{% block title %}H√≥a ƒê∆°n - BuddySkincare{% endblock %}

{% block content %}
<style>
  .invoice { max-width: 900px; margin: 0 auto; background: #fff; border: 1px solid #eee; }
  .invoice-header { padding: 20px; border-bottom: 1px solid #eee;padding-bottom: 0; }
  .invoice-body { padding: 20px; padding-bottom: 0; }
  .invoice-footer { padding: 12px 20px; border-top: 1px solid #eee; font-size: 12px; color: #6c757d; }
  .brand { font-weight: 700; font-size: 20px; }
  .muted { color: #6c757d; }
  .table-invoice th, .table-invoice td { padding: 8px; border-bottom: 1px solid #f1f1f1; }
  .table-invoice th { background: #f8f9fa; }
  @media print { .no-print { display: none !important; } body { background: #fff; } }
  .badge-paid { background: #28a745; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 11px; }
  .badge-unpaid { background: #ffc107; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 11px; }
  .logo { font-weight: 800; font-size: 18px; letter-spacing: .5px; }
</style>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3 no-print">
    <h4 class="mb-0"><i class="fas fa-file-invoice me-2"></i>H√≥a ƒê∆°n ƒê∆°n H√†ng</h4>
    <div>
      <a href="/admin/orders" class="btn btn-outline-secondary me-2"><i class="fas fa-arrow-left me-1"></i>Quay l·∫°i</a>
      <button class="btn btn-success me-2" onclick="sendInvoiceEmail()"><i class="fas fa-paper-plane me-1"></i>G·ª≠i h√≥a ƒë∆°n</button>
      <button class="btn btn-primary" onclick="window.print()"><i class="fas fa-print me-1"></i>In / L∆∞u PDF</button>
    </div>
  </div>

  <div class="invoice shadow-sm rounded">
    <div class="invoice-header">
      <div class="row">
        <div class="col-md-6 d-flex align-items-center">
          <img src="{{ url_for('static', filename='image/logo.png') }}" alt="Logo" style="height:28px; width:auto; margin-right:8px;"/>
          <div>
            <div class="logo">BuddySkincare</div>
            <div class="muted">www.buddyskincare.vn</div>
          </div>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
          {% if order %}
          <div><strong>H√≥a ƒë∆°n:</strong> #{{ order.id }}</div>
          {% set _dt = (order.order_date|string)|replace('T',' ') %}
          <div><strong>Ng√†y:</strong> {{ _dt[:16] }}</div>
          <div><strong>Thanh to√°n:</strong> {{ 'Chuy·ªÉn kho·∫£n' if order.payment_method == 'bank' else 'COD' }}</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="invoice-body">
      {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
      {% elif not order %}
        <div class="alert alert-warning">Kh√¥ng c√≥ d·ªØ li·ªáu h√≥a ƒë∆°n.</div>
      {% else %}
        <div class="row mb-3">
          <div class="col-md-6">
            <h6 class="mb-1">Th√¥ng tin kh√°ch h√†ng</h6>
            <div class="muted">T√™n: <strong>{{ order.customer_name or 'N/A' }}</strong></div>
            <div class="muted">SƒêT: <strong>{{ order.phone_number or 'N/A' }}</strong></div>
            <div class="muted">ƒê·ªãa ch·ªâ: <strong>{{ (order.street or '') ~ ' ' ~ (order.ward or '') ~ ' ' ~ (order.district or '') ~ ' ' ~ (order.province or '') }}</strong></div>
          </div>
          <div class="col-md-6 text-md-end mt-3 mt-md-0">
            <h6 class="mb-1">Th√¥ng tin ƒë∆°n h√†ng</h6>
            {% set status_map = {
              'pending':'Ch·ªù x·ª≠ l√Ω',
              'processing':'ƒêang x·ª≠ l√Ω',
              'shipped':'ƒê√£ giao h√†ng',
              'delivered':'ƒê√£ nh·∫≠n h√†ng',
              'cancelled':'ƒê√£ h·ªßy',
              'confirmed':'ƒê√£ x√°c nh·∫≠n',
              'completed':'Ho√†n th√†nh'
            } %}
            <div class="muted">Tr·∫°ng th√°i: <strong>{{ status_map.get(order.status, order.status) }}</strong></div>
            <div class="muted">X√°c nh·∫≠n: <strong>{{ 'ƒê√£ x√°c nh·∫≠n' if order.is_confirmed else 'Ch∆∞a x√°c nh·∫≠n' }}</strong></div>
            {% if order.voucher_code or order.voucher %}
            <div class="muted">Voucher: <strong>{{ order.voucher_code or (order.voucher.code if order.voucher) }}</strong></div>
            {% endif %}
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-invoice">
            <thead>
              <tr>
                <th style="width:50%">M√¥ t·∫£</th>
                <th class="text-end">ƒê∆°n gi√°</th>
                <th class="text-end">S·ªë l∆∞·ª£ng</th>
                <th class="text-end">Th√†nh ti·ªÅn</th>
              </tr>
            </thead>
            <tbody>
              {% set ns = namespace(subtotal=0.0) %}
              {% for it in order.get('items', []) %}
                {% set name = it.product.name if it.product else ('#' ~ it.product) %}
                {% set unit = it.price_at_purchase or (it.product.discounted_price if it.product) or 0 %}
                {% set qty = it.quantity or 0 %}
                {% set u = (unit|float) %}
                {% set q = (qty|float) %}
                {% set line = u * q %}
                {% set ns.subtotal = (ns.subtotal|float) + (line|float) %}
                <tr>
                  <td>{{ name }}</td>
                  <td class="text-end">{{ ('{:,.0f}'.format(u * 1000)).replace(',', '.') }}ƒë</td>
                  <td class="text-end">{{ q|int }}</td>
                  <td class="text-end">{{ ('{:,.0f}'.format(line * 1000)).replace(',', '.') }}ƒë</td>
                </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <th colspan="3" class="text-end">T·∫°m t√≠nh</th>
                <th class="text-end">{{ ('{:,.0f}'.format((ns.subtotal|float * 1000))).replace(',', '.') }}ƒë</th>
              </tr>
              {% set ship = (order.shipping_fee or 0)|float %}
              {% if ship > 0 and ship < 1000 %}{% set ship = ship * 1000 %}{% endif %}
              {% set discount = (order.discount_applied or 0)|float %}
              {% if discount > 0 and discount < 1000 %}{% set discount = discount * 1000 %}{% endif %}
              <tr>
                <th colspan="3" class="text-end">Gi·∫£m gi√°</th>
                <th class="text-end text-success">-{{ ('{:,.0f}'.format(discount)).replace(',', '.') }}ƒë</th>
              </tr>
              <tr>
                <th colspan="3" class="text-end">Ph√≠ v·∫≠n chuy·ªÉn</th>
                <th class="text-end">{{ ('{:,.0f}'.format(ship)).replace(',', '.') }}ƒë</th>
              </tr>
              {% set grand = ((order.total_amount or 0)|float * 1000) %}
              <tr>
                <th colspan="3" class="text-end">T·ªïng c·ªông</th>
                <th class="text-end text-danger">{{ ('{:,.0f}'.format(grand)).replace(',', '.') }}ƒë</th>
              </tr>
            </tfoot>
          </table>
        </div>
      {% endif %}
    </div>
    <div class="invoice-footer">
        <span style="font-weight:700; margin-bottom:3px; margin-top:26px; font-style:italic; font-size:12px !important;" class="note-text" >üíå ƒê√¢y l√† email h√≥a ƒë∆°n</a></span>
        <span style="font-size:10px; font-style:italic;" class="note-text" >Ch√∫ng t√¥i g·ª≠i email n√†y ƒë·ªÉ <strong>x√°c nh·∫≠n h√≥a ƒë∆°n</strong> cho b·∫°n.<br/></span>
        <span style="margin-top:2px; font-size:11px !important; font-style:italic;" class="note-text" >N·∫øu c√≥ g√¨ sai s√≥t ho·∫∑c ch∆∞a ƒë√∫ng, vui l√≤ng li√™n h·ªá Zalo <strong>0987 789 274</strong> (nh√¢n vi√™n <strong>Kim Nhi ‚Äì Buddy</strong>) ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ nhanh nha! <br/></span>
        <!-- <span style="margin-top:2px; font-size:11px !important; font-style:italic;" class="note-text" >B·∫°n vui l√≤ng ki·ªÉm tra ƒë∆°n h√†ng ngay khi nh·∫≠n. Ch√∫ng t√¥i h·ªó tr·ª£ c√°c v·∫•n ƒë·ªÅ trong v√≤ng <strong>5 ng√†y</strong> k·ªÉ t·ª´ ng√†y nh·∫≠n h√†ng.<br/></span> -->
        <span style="margin-top:2px; font-size:11px !important; font-style:italic;" class="note-text" >C·∫£m ∆°n b·∫°n ƒë√£ lu√¥n y√™u th∆∞∆°ng <strong>BuddySkincare</strong> ü´∂<br/></span>
        <span style="margin-top:2px; font-size:11px !important; font-style:italic;" class="note-text" >Xem th√™m s·∫£n ph·∫©m t·∫°i: <a href="https://www.buddyskincare.com">www.buddyskincare.com</a></span>
          </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Lightweight notifier that works even if AdminAPI is unavailable
function notify(message, type){
  const useAdmin = (typeof AdminAPI !== 'undefined' && AdminAPI && typeof AdminAPI.showNotification === 'function');
  if (useAdmin) {
    AdminAPI.showNotification(message, type || 'info');
    return;
  }
  // Fallback toast
  const toast = document.createElement('div');
  toast.className = 'notification';
  toast.style.cssText = `position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 480px; padding: 12px 16px; border-radius: 6px; color: #111; background: ${type==='success' ? '#d1e7dd' : type==='error' ? '#f8d7da' : '#e2e3e5'}; border: 1px solid ${type==='success' ? '#badbcc' : type==='error' ? '#f5c2c7' : '#d3d6d8'}; box-shadow: 0 4px 12px rgba(0,0,0,0.12);`;
  toast.innerHTML = `<div style="display:flex;align-items:flex-start;gap:10px"><div style="white-space:pre-line;flex:1">${message}</div><button aria-label="Close" style="background:none;border:0;cursor:pointer;font-size:18px;opacity:.6" onclick="this.parentElement.parentElement.remove()">√ó</button></div>`;
  document.body.appendChild(toast);
  setTimeout(()=>{ if (toast && toast.parentNode) toast.remove(); }, 5000);
}

async function sendInvoiceEmail(){
  try {
    const defaultEmail = '{{ (order.email or "") if order else "" }}';
    const email = prompt('Nh·∫≠p email c·∫ßn g·ª≠i (ƒë·ªÉ tr·ªëng s·∫Ω d√πng email c·ªßa ƒë∆°n h√†ng):', defaultEmail);
    const orderId = {{ order.id if order else 'null' }};
    if(!orderId){ notify('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë∆°n h√†ng', 'error'); return; }
    // Client-side quick validation: if user provided an invalid email string
    if (email && typeof email === 'string') {
      const e = email.trim();
      if (e && !e.includes('@')) {
        notify('Email kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p l·∫°i.', 'error');
        return;
      }
    }
    const res = await fetch(`/admin/orders/${orderId}/invoice/email`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: (email||'').trim() })
    });
    const data = await res.json();
    if(res.ok){
      const extra = data.saved_path ? `\nƒê√£ l∆∞u file: ${data.saved_path}` : '';
      notify((data.message || 'ƒê√£ g·ª≠i h√≥a ƒë∆°n th√†nh c√¥ng') + extra, 'success');
    } else {
      notify(data.message || 'G·ª≠i email th·∫•t b·∫°i', 'error');
    }
  } catch (e){
    notify('L·ªói g·ª≠i email: ' + e.message, 'error');
  }
}
</script>
{% endblock %}

 <!-- Footer -->
 <footer class="bg-white text-dark mt-5 border-top">
    <!-- Floating Action Button -->
<div class="floating-actions">
    <div class="floating-action-item">
        <button id="chatFab" class="floating-btn chat-btn" title="Chat tr·ª±c ti·∫øp" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative;">
            <i class="fas fa-comments"></i>
            <span id="chatNotificationBadge" class="notification-badge" style="display: none;">0</span>
        </button>
    </div>
    <div class="floating-action-item">
        <button id="favFab" class="floating-btn" title="Y√™u th√≠ch" style="background:#dc3545;display:flex;align-items:center;justify-content:center;border:none;outline:none;box-shadow:none;">
            <i class="fas fa-heart"></i>
        </button>
    </div>
    <div class="floating-action-item">
        <a href="https://zalo.me/0987789274" class="floating-btn phone-btn" title="Chat Zalo">
            <img src="{{ url_for('static', filename='image/logozalo.webp') }}" alt="Zalo" style="width: 23px; height: 23px;">
        </a>
    </div>
    <div class="floating-action-item">
        <a href="https://www.facebook.com/messages/t/822076197645395" class="floating-btn zalo-btn" title="Chat Messenger">
            <i class="fab fa-facebook-messenger"></i>
        </a>
    </div>
    
    <div class="floating-action-item">
        <a href="#" class="floating-btn scroll-top-btn" title="L√™n ƒë·∫ßu trang" onclick="scrollToTop()">
            <i class="fas fa-arrow-up"></i>
        </a>
    </div>
    
</div>

<!-- Wishlist Modal (center) -->
<div class="modal fade" id="wishlistModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-heart text-danger me-2"></i>Danh s√°ch y√™u th√≠ch</h5>
        <button type="button" class="btn-close" id="favModalClose" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="wishlistList"></div>
      <div class="modal-footer">
        <button id="favClearBtn" type="button" class="btn btn-outline-secondary"><i class="fas fa-trash me-1"></i>X√≥a h·∫øt</button>
        <button type="button" class="btn btn-dark" data-bs-dismiss="modal">ƒê√≥ng</button>
      </div>
    </div>
  </div>
</div>

<!-- Chat Modal -->
<div class="modal fade" id="chatModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="height: 500px; display: flex; flex-direction: column;">
      <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
        <div class="d-flex align-items-center">
          <img src="{{ url_for('static', filename='image/logo.png') }}" alt="BuddySkincare" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;">
          <div>
            <h5 class="modal-title mb-0">H·ªó tr·ª£ BuddySkincare</h5>
            <small>Tr·ª±c tuy·∫øn - B·∫°n c·∫ßn BuddySkincare h·ªó tr·ª£? H√£y chat v·ªõi ch√∫ng t√¥i ngay!</small>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <div class="modal-body flex-grow-1 p-0" style="display: flex; flex-direction: column;">
        <div id="chatModalContent" style="display: none; flex: 1; display: flex; flex-direction: column;">
          <div id="chatModalBody" class="chat-messages" style="flex: 1; padding: 15px; overflow-y: auto; background: #f8fafc; display: flex; flex-direction: column; gap: 10px; max-height: 400px; min-height: 300px;">
            <!-- Messages will be loaded here -->
          </div>
          
          <style>
          /* Chat Modal Styles - ƒê·ªìng b·ªô v·ªõi live-chat.js */
          #chatModalBody .message {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            max-width: 85%;
          }
          
          #chatModalBody .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
          }
          
          #chatModalBody .message.agent {
            align-self: flex-start;
          }
          
          #chatModalBody .message-avatar {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
          }
          
          #chatModalBody .message.user .message-avatar {
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e2e8f0;
          }
          
          #chatModalBody .message.agent .message-avatar {
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e2e8f0;
          }
          
          #chatModalBody .message-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
          }
          
          #chatModalBody .message-bubble {
            padding: 6px 10px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.3;
            word-wrap: break-word;
            position: relative;
          }
          
          #chatModalBody .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
          }
          
          #chatModalBody .message.agent .message-bubble {
            background: white;
            color: #2d3748;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
          }
          
          #chatModalBody .message-time {
            font-size: 9px;
            color: #9ca3af;
            padding: 0 4px;
            text-align: right;
            margin-top: 1px;
          }
          
          #chatModalBody .message.user .message-time {
            text-align: right;
          }
          
          #chatModalBody .message.agent .message-time {
            text-align: left;
          }
          
          #chatModalBody .emoji-btn {
            width: 28px;
            height: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
          }
          
          #chatModalBody .emoji-btn:hover {
            background: #f1f5f9;
          }
          
          /* Notification Badge Styles */
          .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
            animation: pulse 2s infinite;
          }
          
          @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
          }
          </style>
          
          <div class="chat-input-area" style="border-radius: 20px;padding: 15px; background: white; border-top: 1px solid #e2e8f0; display: flex; align-items: center; gap: 10px;">
            <div class="input-wrapper" style="flex: 1; position: relative;">
              <textarea id="chatModalInput" class="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." rows="1" style="width: 100%; border: 1px solid #e2e8f0; background: #f8fafc; border-radius: 16px; padding: 8px 12px; font-size: 14px; transition: all 0.2s ease; resize: none; min-height: 40px; max-height: 80px;"></textarea>
              <div id="chatModalEmojiPanel" class="emoji-panel" style="position: absolute; bottom: 50px; left: 12px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 8px; display: none; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15); z-index: 1000;">
                <div class="emoji-grid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px;">
                  <div class="emoji-btn">üòÄ</div>
                  <div class="emoji-btn">üòÅ</div>
                  <div class="emoji-btn">üòÇ</div>
                  <div class="emoji-btn">üòä</div>
                  <div class="emoji-btn">üòç</div>
                  <div class="emoji-btn">üòé</div>
                  <div class="emoji-btn">üëç</div>
                  <div class="emoji-btn">üôè</div>
                  <div class="emoji-btn">üéâ</div>
                  <div class="emoji-btn">üíñ</div>
                  <div class="emoji-btn">üî•</div>
                  <div class="emoji-btn">‚ú®</div>
                  <div class="emoji-btn">üõçÔ∏è</div>
                  <div class="emoji-btn">üöö</div>
                  <div class="emoji-btn">üí≥</div>
                  <div class="emoji-btn">üß¥</div>
                </div>
              </div>
            </div>
            <button id="chatModalEmojiBtn" type="button" class="send-button" title="Emoji" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; font-size: 14px;">üòä</button>
            <button id="chatModalSendBtn" type="button" class="send-button" title="G·ª≠i" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; font-size: 14px;">‚û§</button>
          </div>
        </div>

        <div id="chatModalLoginPrompt" class="login-prompt" style="text-align: center; padding: 40px 20px; color: #64748b; font-size: 14px; flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column;">
          <i class="fas fa-comments fa-3x mb-3" style="color: #667eea;"></i>
          <p>B·∫°n c·∫ßn <a href="{{ url_for('index') }}" style="color: #667eea; text-decoration: none; font-weight: 600;">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng t∆∞ v·∫•n tr·ª±c ti·∫øp.</p>
        </div>
      </div>
    </div>
  </div>
</div>

    <!-- Newsletter Section -->
<section class="newsletter-section py-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h4 class="fw-bold text-white mb-2">NH·∫¨N B·∫¢N TIN L√ÄM ƒê·∫∏P</h4>
                <p class="text-white-50 mb-0">ƒê·ª´ng b·ªè l·ª° h√†ng ng√†n s·∫£n ph·∫©m v√† khuy·∫øn m√£i si√™u h·∫•p d·∫´n</p>
            </div>
            <div class="col-lg-6">
                <form class="newsletter-form">
                    <div class="input-group">
                        <input type="email" class="form-control" placeholder="ƒêi·ªÅn email c·ªßa b·∫°n" required>
                        <button class="btn btn-light fw-bold" type="submit">ƒêƒÇNG K√ù</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>
    <div class="container py-5">
        <div class="row">
            <!-- Company Info -->
            <div class="col-lg-4 col-md-6 mb-4">
                <img src="{{ url_for('static', filename='image/logo.png') }}" alt="BuddySkincare Logo" style="max-height: 40px; width: auto; margin-bottom: 1rem;">
                <h5 class="text-primary mb-3">BuddySkincare</h5>
                <p class="text-muted">Chuy√™n cung c·∫•p m·ªπ ph·∫©m thanh l√Ω ch√≠nh h√£ng v·ªõi gi√° t·ªët nh·∫•t th·ªã tr∆∞·ªùng. B√°n h√†ng online - Giao h√†ng to√†n qu·ªëc - Thanh to√°n khi nh·∫≠n h√†ng.</p>
                <div class="social-links">
                    <a href="#" class="text-muted me-3"><i class="fab fa-facebook fa-lg"></i></a>
                    <a href="#" class="text-muted me-3"><i class="fab fa-instagram fa-lg"></i></a>
                    <a href="#" class="text-muted me-3"><i class="fab fa-youtube fa-lg"></i></a>
                    <a href="#" class="text-muted me-3"><i class="fab fa-tiktok fa-lg"></i></a>
                </div>
            </div>
            
            <!-- Quick Links -->
            <div class="col-lg-2 col-md-6 mb-4">
                <h6 class="text-primary mb-3">Li√™n k·∫øt nhanh</h6>
                <ul class="list-unstyled">
                    <li class="mb-2"><a href="/about" class="text-muted text-decoration-none">V·ªÅ ch√∫ng t√¥i</a></li>
                    <li class="mb-2"><a href="/products" class="text-muted text-decoration-none">S·∫£n ph·∫©m</a></li>
                    <li class="mb-2"><a href="/events/flash-sale" class="text-muted text-decoration-none">Flash Sale</a></li>
                    <li class="mb-2"><a href="/news" class="text-muted text-decoration-none">Tin t·ª©c</a></li>
                    <li class="mb-2"><a href="/contact" class="text-muted text-decoration-none">Li√™n h·ªá</a></li>
                </ul>
            </div>
            
            <!-- Customer Service -->
            <div class="col-lg-2 col-md-6 mb-4">
                <h6 class="text-primary mb-3">H·ªó tr·ª£ kh√°ch h√†ng</h6>
                <ul class="list-unstyled">
                    <li class="mb-2"><a href="/shopping-guide" class="text-muted text-decoration-none">H∆∞·ªõng d·∫´n mua h√†ng</a></li>
                    <li class="mb-2"><a href="/return-policy" class="text-muted text-decoration-none">Ch√≠nh s√°ch ƒë·ªïi tr·∫£</a></li>
                    <li class="mb-2"><a href="/shipping-payment" class="text-muted text-decoration-none">V·∫≠n chuy·ªÉn & Thanh to√°n</a></li>
                    <li class="mb-2"><a href="/online-payment-safety" class="text-muted text-decoration-none">Thanh to√°n an to√†n</a></li>
                    <li class="mb-2"><a href="/privacy-policy" class="text-muted text-decoration-none">B·∫£o m·∫≠t th√¥ng tin</a></li>
                </ul>
            </div>
            
            <!-- Contact Info -->
            <div class="col-lg-4 col-md-6 mb-4">
                <h6 class="text-primary mb-3">Th√¥ng tin li√™n h·ªá</h6>
                <div class="mb-3">
                    <i class="fas fa-phone me-2 text-primary"></i>
                    <span class="text-muted">0987.789.274</span>
                </div>
                <div class="mb-3">
                    <i class="fas fa-envelope me-2 text-primary"></i>
                    <span class="text-muted">buddyskincarevn@gmail.com</span>
                </div>
                <div class="mb-3">
                    <i class="fas fa-clock me-2 text-primary"></i>
                    <span class="text-muted">H·ªó tr·ª£ 24/7</span>
                </div>
                <div class="mb-3">
                    <i class="fas fa-shipping-fast me-2 text-primary"></i>
                    <span class="text-muted">Giao h√†ng to√†n qu·ªëc</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bottom Footer -->
    <div class="bg-darker py-3">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <small class="text-muted" style="color: #ffffff !important; font-size: 9.5px;">&copy; 2024 BuddySkincare - Website b√°n h√†ng online. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</small>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <small class="text-muted">
                        <img src="https://img.icons8.com/color/24/000000/visa.png" alt="Visa" class="me-2">
                        <img src="https://img.icons8.com/color/24/000000/mastercard.png" alt="Mastercard" class="me-2">
                        <img src="https://img.icons8.com/color/24/000000/paypal.png" alt="PayPal" class="me-2">
                        <span class="ms-2" style="color: #ffffff !important;">Thanh to√°n online & COD</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

<!-- Chat Modal JavaScript -->
<script>
// Chat Modal functionality - ƒê·ªìng b·ªô v·ªõi live-chat.js
document.addEventListener('DOMContentLoaded', function() {
    console.log('Chat Modal script starting...');
    
    const chatFab = document.getElementById('chatFab');
    const chatModal = document.getElementById('chatModal');
    const chatModalContent = document.getElementById('chatModalContent');
    const chatModalLoginPrompt = document.getElementById('chatModalLoginPrompt');
    const chatModalBody = document.getElementById('chatModalBody');
    const chatModalInput = document.getElementById('chatModalInput');
    const chatModalSendBtn = document.getElementById('chatModalSendBtn');
    const chatModalEmojiBtn = document.getElementById('chatModalEmojiBtn');
    const chatModalEmojiPanel = document.getElementById('chatModalEmojiPanel');
    
    console.log('Elements found:', {
        chatFab: !!chatFab,
        chatModal: !!chatModal,
        chatModalContent: !!chatModalContent,
        chatModalLoginPrompt: !!chatModalLoginPrompt,
        chatModalBody: !!chatModalBody,
        chatModalInput: !!chatModalInput,
        chatModalSendBtn: !!chatModalSendBtn,
        chatModalEmojiBtn: !!chatModalEmojiBtn,
        chatModalEmojiPanel: !!chatModalEmojiPanel
    });
    
    let currentUserId = null;
    let currentUserName = null; // Th√™m bi·∫øn ƒë·ªÉ l∆∞u t√™n ng∆∞·ªùi d√πng
    let currentUserAvatar = null; // Th√™m bi·∫øn ƒë·ªÉ l∆∞u avatar ng∆∞·ªùi d√πng
    let currentToken = null;
    let isEmojiPanelOpen = false;
    let isSending = false; // Flag to prevent duplicate sends
    let isClearing = false; // Flag to prevent event listener interference
    let sentMessages = new Set(); // Track sent messages to prevent duplicates
    let displayedMessages = new Set(); // Track displayed messages to prevent duplicates
    let unreadCount = 0; // Track unread messages count
    let lastReadMessageId = null; // Track last read message
    let isModalOpen = false; // Track if chat modal is open
    let hasLoadedInitialMessages = false; // Track if initial messages have been loaded
    let lastReadTimestamp = null; // Track last read timestamp
    
    // Cleanup old sent messages to prevent memory leak - Gi·ªëng live-chat.js
    function cleanupSentMessages() {
        if (sentMessages.size > 50) {
            const messagesArray = Array.from(sentMessages);
            sentMessages.clear();
            // Keep only the last 25 messages
            messagesArray.slice(-25).forEach(msg => sentMessages.add(msg));
        }
        
        if (displayedMessages.size > 100) {
            const messagesArray = Array.from(displayedMessages);
            displayedMessages.clear();
            // Keep only the last 50 messages
            messagesArray.slice(-50).forEach(msg => displayedMessages.add(msg));
        }
    }
    
    // Update notification badge
    function updateNotificationBadge() {
        const badge = document.getElementById('chatNotificationBadge');
        if (!badge) return;
        
        if (unreadCount > 0) {
            badge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }
    
    // Mark messages as read
    function markMessagesAsRead() {
        unreadCount = 0;
        updateNotificationBadge();
        lastReadMessageId = displayedMessages.size > 0 ? Array.from(displayedMessages).pop() : null;
    }
    
    // Check if message is unread (from admin and not sent by current user)
    function isUnreadMessage(senderId, messageId, messageText = '', messageTimestamp = null) {
        if (senderId === currentUserId) return false; // User's own messages are not unread
        if (senderId === "admin_001") {
            // Don't count welcome messages as unread
            const isWelcomeMessage = messageText.includes('Ch√†o b·∫°n!') || messageText.includes('Ch√∫ng t√¥i c√≥ nhi·ªÅu s·∫£n ph·∫©m');
            if (isWelcomeMessage) return false;
            
            // Check if message is newer than last read timestamp
            if (messageTimestamp && lastReadTimestamp) {
                const messageTime = messageTimestamp.seconds ? messageTimestamp.seconds * 1000 : Date.now();
                return messageTime > lastReadTimestamp;
            }
            
            return true; // If no timestamp info, consider as unread
        }
        return false;
    }
    
    // Reset unread count when modal is opened
    function resetUnreadCount() {
        unreadCount = 0;
        updateNotificationBadge();
        saveLastReadTimestamp(); // Save timestamp when opening chat
    }
    
    // Save last read timestamp to localStorage
    function saveLastReadTimestamp() {
        const timestamp = Date.now();
        lastReadTimestamp = timestamp;
        localStorage.setItem('chat_last_read_timestamp', timestamp.toString());
        console.log('Saved last read timestamp:', timestamp);
    }
    
    // Load last read timestamp from localStorage
    function loadLastReadTimestamp() {
        const saved = localStorage.getItem('chat_last_read_timestamp');
        if (saved) {
            lastReadTimestamp = parseInt(saved);
            console.log('Loaded last read timestamp:', lastReadTimestamp);
        } else {
            lastReadTimestamp = Date.now(); // If no saved timestamp, consider all messages as read
            console.log('No saved timestamp, setting to current time:', lastReadTimestamp);
        }
    }
    
    // Check if user is logged in
    function checkLoginStatus() {
        console.log('checkLoginStatus called');
        console.log('isLoggedIn function available:', typeof isLoggedIn === 'function');
        
        if (typeof isLoggedIn === 'function' && isLoggedIn()) {
            console.log('User is logged in according to isLoggedIn()');
            
            if (typeof getUserProfile !== 'function') {
                console.error('getUserProfile function not available in checkLoginStatus!');
                return false;
            }
            
            const userProfile = getUserProfile();
            console.log('User profile in checkLoginStatus:', userProfile);
            
            currentUserId = userProfile.id ? String(userProfile.id) : null;
            currentUserName = userProfile.name; // G√°n t√™n ng∆∞·ªùi d√πng
            currentUserAvatar = userProfile.avatar; // G√°n avatar ng∆∞·ªùi d√πng
            currentToken = userProfile.access_token ? String(userProfile.access_token) : null;
            
            console.log('Updated current user info:', { currentUserId, currentUserName, currentUserAvatar, currentToken });
            return true;
        }
        
        console.log('User is not logged in according to isLoggedIn()');
        return false;
    }
    
    // H√†m ƒë·ªÉ t·∫°o v√† th√™m m·ªôt tin nh·∫Øn v√†o giao di·ªán ng∆∞·ªùi d√πng - Gi·ªëng live-chat.js
    function appendMessage(senderId, text, timestamp, messageId = null) {
        console.log('appendMessage called:', { senderId, text, timestamp, messageId });
        console.log('chatModalBody element:', chatModalBody);
        
        if (!chatModalBody) {
            console.error('chatModalBody not found!');
            return;
        }
        
        const isUserMessage = (senderId === currentUserId);
        
        // Check if this message was already displayed
        if (messageId && displayedMessages.has(messageId)) {
            console.log('Skipping duplicate message in appendMessage:', messageId);
            return;
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUserMessage ? 'user' : 'agent'}`;
        
        // Add messageId as data attribute for tracking
        if (messageId) {
            messageDiv.setAttribute('data-message-id', messageId);
            displayedMessages.add(messageId); // Track as displayed
        }

        const displayTime = timestamp ? new Date(timestamp.seconds * 1000).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) : 'V·ª´a xong';

        // Convert links to clickable links
        const processedText = convertLinksToClickable(text);

        let messageHTML = '';
        if (isUserMessage) {
            // S·ª≠ d·ª•ng avatar v√† t√™n ƒë√£ l·∫•y ƒë∆∞·ª£c
            const avatarUrl = currentUserAvatar || '/static/image/khach/anh-avatar-nam-ca-tinh-nguoi-that.jpg';
            messageHTML = `
                <div class="message-avatar">
                    <img src="${avatarUrl}" alt="${currentUserName || 'Ng∆∞·ªùi d√πng'}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.src='/static/image/khach/anh-avatar-nam-ca-tinh-nguoi-that.jpg'">
                </div>
                <div class="message-content">
                    <div class="message-bubble">${processedText}</div>
                    <div class="message-time">${displayTime}</div>
                </div>`;
        } else {
            // Use logo.png for agent
            messageHTML = `
                <div class="message-avatar">
                    <img src="/static/image/logo.png" alt="BuddySkincare" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.src='/static/image/logo.png'">
                </div>
                <div class="message-content">
                    <div class="message-bubble">${processedText}</div>
                    <div class="message-time">${displayTime}</div>
                </div>`;
        }

        messageDiv.innerHTML = messageHTML;
        chatModalBody.appendChild(messageDiv);
        console.log('Message appended to chatModalBody:', messageDiv);
        console.log('chatModalBody children count:', chatModalBody.children.length);
        console.log('chatModalBody innerHTML length:', chatModalBody.innerHTML.length);
        
        // Check if this is an unread message and update notification badge
        // Only count as unread if modal is not open AND initial messages have been loaded
        if (isUnreadMessage(senderId, messageId, text, timestamp) && !isModalOpen && hasLoadedInitialMessages) {
            unreadCount++;
            updateNotificationBadge();
        }
        
        // Auto scroll to bottom with smooth animation
        setTimeout(() => {
            chatModalBody.scrollTo({
                top: chatModalBody.scrollHeight,
                behavior: 'smooth'
            });
        }, 100);
    }
    
    // Convert links to clickable links
    function convertLinksToClickable(text) {
        // Escape HTML first to prevent XSS
        const escapedText = text.replace(/&/g, '&amp;')
                               .replace(/</g, '&lt;')
                               .replace(/>/g, '&gt;')
                               .replace(/"/g, '&quot;')
                               .replace(/'/g, '&#39;');
        
        // URL regex pattern - matches http, https, www, and common domains
        const urlRegex = /(https?:\/\/[^\s]+|www\.[^\s]+|[a-zA-Z0-9-]+\.[a-zA-Z]{2,}(?:\/[^\s]*)?)/g;
        
        return escapedText.replace(urlRegex, (url) => {
            // Ensure URL has protocol
            let href = url;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                href = 'https://' + url;
            }
            
            return `<a href="${href}" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: underline; word-break: break-all;">${url}</a>`;
        });
    }
    
    // Force clear input function - Gi·ªëng live-chat.js
    function forceClearInput() {
        isClearing = true; // Set flag to prevent event listener interference
        
        const tempValue = chatModalInput.value;
        
        // Method 1: Direct value clear
        chatModalInput.value = '';
        
        // Method 2: Clear all possible properties
        chatModalInput.innerHTML = '';
        chatModalInput.textContent = '';
        chatModalInput.innerText = '';
        
        // Method 3: Force clear using setAttribute
        chatModalInput.setAttribute('value', '');
        
        // Method 4: Reset height to default
        chatModalInput.style.height = '35px';
        
        // Method 5: Force focus and select all then clear
        chatModalInput.focus();
        chatModalInput.select();
        
        // Method 6: Use document.execCommand for textarea
        if (chatModalInput.tagName.toLowerCase() === 'textarea') {
            try {
                document.execCommand('selectAll', false, null);
                document.execCommand('delete', false, null);
            } catch (e) {
                // Fallback if execCommand fails
            }
        }
        
        console.log('Input cleared. Previous value:', tempValue, 'New value:', chatModalInput.value);
        
        // Verify it's actually cleared
        if (chatModalInput.value !== '') {
            console.warn('Input still has value after clear:', chatModalInput.value);
            // Force clear one more time
            chatModalInput.value = '';
        }
        
        // Reset flag after a short delay
        setTimeout(() => {
            isClearing = false;
        }, 50);
    }
    
    // Send message - Gi·ªëng live-chat.js
    function sendMessage() {
        const text = (chatModalInput.value || '').trim();
        if (!text || isSending) return; // Prevent duplicate sends

        isSending = true; // Set flag to prevent duplicate sends

        // Create unique message ID to track duplicates
        const messageId = `${currentUserId}_${text}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        sentMessages.add(messageId);

        // Clear input immediately for better UX
        forceClearInput();
        
        // Force clear multiple times to ensure it's cleared
        setTimeout(() => {
            forceClearInput();
        }, 10);
        
        setTimeout(() => {
            forceClearInput();
        }, 50);
        
        setTimeout(() => {
            forceClearInput();
        }, 100);

        const messageData = {
            text: text,
            senderId: currentUserId,
            senderName: currentUserName, // G·ª≠i t√™n ng∆∞·ªùi d√πng
            senderAvatar: currentUserAvatar, // G·ª≠i avatar ng∆∞·ªùi d√πng
            receiverId: "admin_001",
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            authToken: currentToken,
            messageId: messageId // Add unique ID to track
        };

        console.log("Sending message:", messageData);

        fetch('https://buddyhotro.pythonanywhere.com/api/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(messageData),
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error from Flask:', data.error);
                // Restore input if error
                chatModalInput.value = text;
                autoResize();
            } else {
                console.log('Message sent successfully.');
            }
        })
        .catch(error => {
            console.error('Error sending message:', error);
            // Restore input if error
            chatModalInput.value = text;
            autoResize();
        })
        .finally(() => {
            isSending = false; // Reset flag after request completes
            cleanupSentMessages(); // Cleanup old sent messages
        });
    }
    
    // Auto resize textarea
    function autoResize() {
        chatModalInput.style.height = 'auto';
        chatModalInput.style.height = Math.min(chatModalInput.scrollHeight, 80) + 'px';
    }
    
    // Toggle emoji panel
    function toggleEmojiPanel() {
        isEmojiPanelOpen = !isEmojiPanelOpen;
        chatModalEmojiPanel.style.display = isEmojiPanelOpen ? 'block' : 'none';
    }
    
    // Add emoji to input
    function addEmoji(emoji) {
        const cursorPos = chatModalInput.selectionStart;
        const textBefore = chatModalInput.value.substring(0, cursorPos);
        const textAfter = chatModalInput.value.substring(chatModalInput.selectionEnd);
        chatModalInput.value = textBefore + emoji + textAfter;
        chatModalInput.selectionStart = chatModalInput.selectionEnd = cursorPos + emoji.length;
        chatModalInput.focus();
        autoResize();
    }
    
    // Initialize chat modal immediately if user is logged in (like live-chat.js)
    // Add small delay to ensure Firebase SDK is loaded
    setTimeout(() => {
        console.log('Firebase available:', typeof firebase !== 'undefined');
        console.log('isLoggedIn function available:', typeof isLoggedIn === 'function');
        
        if (typeof firebase === 'undefined') {
            console.error('Firebase SDK not loaded!');
            return;
        }
        
        if (typeof isLoggedIn === 'function' && isLoggedIn()) {
        console.log("User logged in. Initializing chat modal.");
        
        if (typeof getUserProfile !== 'function') {
            console.error('getUserProfile function not available!');
            return;
        }
        
        const userProfile = getUserProfile();
        console.log('User profile:', userProfile);
        
        currentUserId = userProfile.id ? String(userProfile.id) : null;
        currentUserName = userProfile.name; // G√°n t√™n ng∆∞·ªùi d√πng
        currentUserAvatar = userProfile.avatar; // G√°n avatar ng∆∞·ªùi d√πng
        currentToken = userProfile.access_token ? String(userProfile.access_token) : null;
        
        console.log(`Current user ID: ${currentUserId}, Name: ${currentUserName}, Avatar: ${currentUserAvatar}`);
        console.log(`Current token: ${currentToken}`);

        const firebaseConfig = {
            apiKey: "AIzaSyBl_8N53eSIGEbBN2TBSGW36vabMdq2lbI",
            authDomain: "buddyskincare-ec603.firebaseapp.com",
            projectId: "buddyskincare-ec603",
            storageBucket: "buddyskincare-ec603.firebasestorage.app",
            messagingSenderId: "151445800213",
            appId: "1:151445800213:web:62dafa29093235e913151c",
            measurementId: "G-5PLJ2MQ9PW"
        };
        
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.log("Firebase already initialized or error:", error);
        }
        
        const db = firebase.firestore();
        console.log("Firestore database object:", db);
        console.log("Firebase app:", firebase.app());
        
        // Load last read timestamp from localStorage
        loadLastReadTimestamp();
        
        const adminId = "admin_001";
        const chatId = [currentUserId, adminId].sort().join('_');
        console.log('Chat ID:', chatId);
        const messagesRef = db.collection('chats').doc(chatId).collection('messages');
        
        messagesRef.orderBy('timestamp').onSnapshot(snapshot => {
            console.log('Firebase snapshot received:', snapshot.docChanges().length, 'changes');
            console.log('Snapshot docs:', snapshot.docs.length);
            
            if (snapshot.docChanges().length === 0) {
                console.log('No changes in snapshot, but docs exist:', snapshot.docs.length);
                // Mark initial messages as loaded if no changes
                if (!hasLoadedInitialMessages) {
                    hasLoadedInitialMessages = true;
                    console.log('Initial messages loaded (no changes)');
                }
            }
            
            snapshot.docChanges().forEach(change => {
                console.log('Change type:', change.type, 'Doc ID:', change.doc.id);
                if (change.type === 'added') {
                    const message = change.doc.data();
                    console.log(`New message from Firebase. Sender: ${message.senderId}, Content: ${message.text}, MessageId: ${message.messageId}`);
                    
                    // Use the messageId from Firebase, or create a fallback
                    const messageId = message.messageId || `${message.senderId}_${message.text}_${message.timestamp?.seconds || Date.now()}`;
                    
                    // Check if we already displayed this message
                    if (displayedMessages.has(messageId)) {
                        console.log('Skipping duplicate message - already in displayedMessages:', messageId);
                        return;
                    }
                    
                    // Check if we already have this message displayed in DOM
                    const existingMessage = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (existingMessage) {
                        console.log('Skipping duplicate message - already in DOM:', messageId);
                        return;
                    }
                    
                    console.log('Appending message to chat modal:', messageId);
                    appendMessage(message.senderId, message.text, message.timestamp, messageId);
                    
                    // Mark initial messages as loaded after first message
                    if (!hasLoadedInitialMessages) {
                        hasLoadedInitialMessages = true;
                        console.log('Initial messages loaded (first message processed)');
                    }
                }
            });
        }, error => {
            console.error('Firebase listener error:', error);
        });

        // Welcome message
        console.log('Adding welcome messages...');
        console.log('adminId:', adminId);
        console.log('chatModalBody before welcome messages:', chatModalBody);
        
        appendMessage(adminId, 'Ch√†o b·∫°n! M√¨nh c√≥ th·ªÉ h·ªó tr·ª£ g√¨ cho b·∫°n h√¥m nay? üòä', null);
        console.log('First welcome message added. chatModalBody children:', chatModalBody.children.length);
        
        appendMessage(adminId, 'Ch√∫ng t√¥i c√≥ nhi·ªÅu s·∫£n ph·∫©m m·ªπ ph·∫©m thanh l√Ω v·ªõi gi√° t·ªët. B·∫°n quan t√¢m ƒë·∫øn s·∫£n ph·∫©m n√†o?', null);
        console.log('Second welcome message added. chatModalBody children:', chatModalBody.children.length);
        
        // Mark initial messages as loaded after welcome messages
        hasLoadedInitialMessages = true;
        console.log('Initial messages loaded (welcome messages added)');
        
        console.log('Welcome messages added. Total messages in chatModalBody:', chatModalBody.children.length);
        console.log('chatModalBody innerHTML length:', chatModalBody.innerHTML.length);
        
        // Force show chatModalContent to test
        console.log('Forcing chatModalContent to be visible for testing...');
        chatModalContent.style.display = 'flex';
        chatModalLoginPrompt.style.display = 'none';
        console.log('chatModalContent display forced to flex');
        
        // Test if messages are visible
        setTimeout(() => {
            console.log('After 2 seconds - chatModalBody children:', chatModalBody.children.length);
            console.log('After 2 seconds - chatModalBody innerHTML length:', chatModalBody.innerHTML.length);
            console.log('After 2 seconds - chatModalContent display:', chatModalContent.style.display);
            console.log('After 2 seconds - chatModalLoginPrompt display:', chatModalLoginPrompt.style.display);
            
            // Check if messages are actually visible in DOM
            const messages = chatModalBody.querySelectorAll('.message');
            console.log('Messages found in DOM:', messages.length);
            messages.forEach((msg, index) => {
                console.log(`Message ${index}:`, msg.textContent);
            });
            
            // Check if chatModalBody is visible
            const chatModalBodyRect = chatModalBody.getBoundingClientRect();
            console.log('chatModalBody getBoundingClientRect:', chatModalBodyRect);
            console.log('chatModalBody computed style display:', window.getComputedStyle(chatModalBody).display);
            console.log('chatModalBody computed style visibility:', window.getComputedStyle(chatModalBody).visibility);
        }, 2000);
        } else {
            console.log('User is not logged in');
        }
    }, 1000); // 1 second delay

    // Event listeners
    if (chatFab) {
        chatFab.addEventListener('click', function() {
            console.log('Chat Fab clicked!');
            console.log('checkLoginStatus result:', checkLoginStatus());
            console.log('chatModalContent element:', chatModalContent);
            console.log('chatModalLoginPrompt element:', chatModalLoginPrompt);
            
            if (checkLoginStatus()) {
                console.log('User is logged in, showing chat content');
                chatModalContent.style.display = 'flex';
                chatModalLoginPrompt.style.display = 'none';
                console.log('chatModalContent display set to flex');
                console.log('chatModalLoginPrompt display set to none');
                
                // Reset unread count when opening chat
                resetUnreadCount();
                markMessagesAsRead();
                isModalOpen = true;
                
                // Auto scroll to bottom when opening chat
                setTimeout(() => {
                    if (chatModalBody) {
                        chatModalBody.scrollTo({
                            top: chatModalBody.scrollHeight,
                            behavior: 'smooth'
                        });
                        console.log('Auto scrolled to bottom when opening chat');
                    }
                }, 300); // Delay to ensure modal is fully opened
            } else {
                console.log('User is not logged in, showing login prompt');
                chatModalContent.style.display = 'none';
                chatModalLoginPrompt.style.display = 'flex';
                console.log('chatModalContent display set to none');
                console.log('chatModalLoginPrompt display set to flex');
            }
            
            console.log('Opening modal...');
            const modal = new bootstrap.Modal(chatModal);
            modal.show();
            console.log('Modal opened');
            
            // Set isModalOpen to false when modal is hidden
            chatModal.addEventListener('hidden.bs.modal', function() {
                isModalOpen = false;
                console.log('Modal closed, isModalOpen set to false');
            });
            
            // Auto scroll to bottom when modal is fully shown
            chatModal.addEventListener('shown.bs.modal', function() {
                setTimeout(() => {
                    if (chatModalBody) {
                        chatModalBody.scrollTo({
                            top: chatModalBody.scrollHeight,
                            behavior: 'smooth'
                        });
                        console.log('Auto scrolled to bottom when modal fully shown');
                    }
                }, 100);
            });
        });
    }
    
    if (chatModalSendBtn) {
        chatModalSendBtn.addEventListener('click', sendMessage);
    }
    
    if (chatModalEmojiBtn) {
        chatModalEmojiBtn.addEventListener('click', toggleEmojiPanel);
    }
    
    if (chatModalInput) {
        chatModalInput.addEventListener('input', function(e) {
            if (e.target.value.length > 0 && !isSending && !isClearing) {
                autoResize();
            }
        });
        
        chatModalInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }
    
    // Emoji panel event listeners
    if (chatModalEmojiPanel) {
        chatModalEmojiPanel.addEventListener('click', function(e) {
            if (e.target.classList.contains('emoji-btn')) {
                addEmoji(e.target.textContent);
                toggleEmojiPanel();
            }
        });
    }
    
    // Close emoji panel when clicking outside
    document.addEventListener('click', function(e) {
        if (!chatModalEmojiPanel.contains(e.target) && !chatModalEmojiBtn.contains(e.target)) {
            if (isEmojiPanelOpen) {
                toggleEmojiPanel();
            }
        }
    });
});
</script>
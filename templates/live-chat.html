{% extends "base.html" %}

{% block title %}T∆∞ V·∫•n Tr·ª±c Ti·∫øp - BuddySkincare{% endblock %}

{% block extra_css %}
<style>
    body { background: #ffffff; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; color: #111827; }
    .chat-container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }

    /* Hero */
    .hero { margin-top: 10px;border-radius: 32px;padding: 1.5rem 0 1rem; text-align: center; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; }
    .hero h1 { font-size: 2rem; font-weight: 800; margin: 0 0 .25rem; letter-spacing: -0.02em; }
    .hero p { margin: 0; opacity: .9; }

    /* Layout */
    .chat-layout { display: grid; grid-template-columns: minmax(0, 1fr) 360px; gap: 1rem; margin: 1rem 0 2rem; }

    /* Chat area */
    .chat { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; display: grid; grid-template-rows: auto 1fr auto; height: 72vh; }
    .chat-header { padding: .8rem 1rem; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: .6rem; }
    .chat-title { font-weight: 800; }
    .chat-body { padding: .9rem; overflow: auto; background: #fafafa; }
    .msg { display: flex; gap: .6rem; margin-bottom: .75rem; width: 100%; }
    .msg .bubble { max-width: 100%; padding: .6rem .75rem; border-radius: 12px; font-size: .95rem; line-height: 1.45; display: inline-flex; align-items: flex-end; overflow: hidden; }
    .msg.agent .bubble { background: #ffffff; border: 1px solid #e5e7eb; border-top-left-radius: 6px; margin-right: auto; }
    .msg.user { justify-content: flex-end; gap: 0; }
    .msg.user > div { max-width: min(80%, 620px); display: flex; flex-direction: column; align-items: flex-end; }
    .msg.user .bubble { background: #6d28d9; color: #fff; border-top-right-radius: 6px; border: none; }
    .msg.user .time { text-align: right; width: 100%; }
    .time { font-size: .75rem; color: #9ca3af; margin-top: .15rem; }

    /* Media bubble */
    .bubble img.chat-image { display: block; width: auto; height: auto; max-width: 260px; max-height: 220px; border-radius: 10px; object-fit: contain; background: #fff; }
    .bubble:has(> img.chat-image) { padding: 0; }

    /* Composer */
    .chat-composer { position: relative; border-top: 1px solid #f3f4f6; padding: .6rem; display: grid; grid-template-columns: auto auto 1fr auto; gap: .5rem; align-items: center; }
    .icon-btn { width: 36px; height: 36px; border-radius: 10px; border: 1px solid #e5e7eb; background: #fff; display: grid; place-items: center; color: #6b7280; }
    .chat-input { width: 100%; border: 1px solid #e5e7eb; background: #fff; border-radius: 10px; padding: .55rem .75rem; font-size: .95rem; }
    .send-btn { background: #6d28d9; color: #fff; border: none; border-radius: 10px; padding: .55rem .9rem; font-weight: 700; }
    .send-btn:disabled { opacity: .6; cursor: not-allowed; }

    /* Emoji picker */
    .emoji-panel { position: absolute; bottom: 56px; left: 50px; background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: .4rem; display: none; box-shadow: 0 10px 20px rgba(0,0,0,.08); }
    .emoji-grid { display: grid; grid-template-columns: repeat(8, 28px); gap: 6px; }
    .emoji-btn { width: 28px; height: 28px; display: grid; place-items: center; border-radius: 6px; cursor: pointer; }
    .emoji-btn:hover { background: #f3f4f6; }

    /* Right rail */
    .rail { display: flex; flex-direction: column; gap: 1rem; height: 72vh; }
    .panel { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: .8rem; overflow: auto; }
    .panel h3 { font-size: 1rem; font-weight: 800; margin: 0 0 .6rem; color: #111827; }

    a.news-item { text-decoration: none; color: inherit; }
    a.news-item:hover { text-decoration: none; background: #f9fafb; }

    .news-item { display: grid; grid-template-columns: 64px 1fr; gap: .6rem; padding: .5rem; border-radius: 10px; border: 1px solid #f3f4f6; margin-bottom: .5rem; }
    .news-thumb { width: 64px; height: 48px; border-radius: 8px; overflow: hidden; background: #f3f4f6; }
    .news-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .news-title { font-size: .92rem; font-weight: 700; color: #111827; line-height: 1.35; margin: 0; }
    .news-meta { font-size: .8rem; color: #6b7280; }

    .prod { display: grid; grid-template-columns: 56px 1fr auto; gap: .6rem; padding: .5rem; border: 1px solid #f3f4f6; border-radius: 10px; align-items: center; margin-bottom: .5rem; }
    .prod-thumb { width: 56px; height: 56px; border-radius: 8px; overflow: hidden; background: #f3f4f6; }
    .prod-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .prod-name { font-size: .9rem; font-weight: 600; color: #111827; margin: 0; }
    .prod-price { font-size: .9rem; font-weight: 800; color: #dc2626; }
    .prod-old { font-size: .8rem; color: #9ca3af; text-decoration: line-through; margin-left: .35rem; }
    .prod-badge { font-size: .75rem; background: #fde68a; color: #92400e; border-radius: 999px; padding: 0 .4rem; margin-left: .35rem; }
    .prod-btn { background: #ef4444; color: #fff; border: none; border-radius: 8px; padding: .4rem .55rem; font-size: .85rem; font-weight: 700; }
    .prod-btn:disabled { opacity: .6; }

    @media (max-width: 900px) {
        .chat-layout { grid-template-columns: 1fr; }
        .chat { height: 68vh; }
        .rail { height: auto; }
        .emoji-panel { bottom: 56px; left: 8px; }
        .bubble img.chat-image { max-width: 65vw; max-height: 35vh; }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <section class="hero">
        <h1>T∆∞ V·∫•n Tr·ª±c Ti·∫øp</h1>
        <p>Tr√≤ chuy·ªán v·ªõi nh√¢n vi√™n. Ch√∫ng t√¥i s·∫Ω h·ªó tr·ª£ b·∫°n nhanh nh·∫•t c√≥ th·ªÉ!</p>
    </section>

    <div class="chat-layout">
        <!-- Chat -->
        <section class="chat" aria-live="polite">
            <header class="chat-header">
                <img src="{{ url_for('static', filename='image/logo.png') }}" alt="BuddySkincare" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">
                <div>
                    <div class="chat-title">H·ªó tr·ª£ BuddySkincare</div>
                    <div class="time">Tr·ª±c tuy·∫øn</div>
                </div>
            </header>

            <div id="chatBody" class="chat-body">
                <div class="msg agent">
                    <img src="{{ url_for('static', filename='image/logo.png') }}" alt="BuddySkincare" style="width:28px;height:28px;border-radius:50%;object-fit:cover;">
                    <div>
                        <div class="bubble">Ch√†o b·∫°n, m√¨nh c√≥ th·ªÉ h·ªó tr·ª£ g√¨ cho b·∫°n h√¥m nay?</div>
                        <div class="time">V·ª´a xong</div>
                    </div>
                </div>
            </div>

            <form id="composer" class="chat-composer" autocomplete="off">
                <button id="emojiBtn" type="button" class="icon-btn" title="Ch√®n emoji"><i class="far fa-smile"></i></button>
                <button id="attachBtn" type="button" class="icon-btn" title="ƒê√≠nh k√®m ·∫£nh"><i class="fas fa-paperclip"></i></button>
                <input id="attachInput" type="file" accept="image/*" hidden>
                <input id="messageInput" class="chat-input" type="text" placeholder="Nh·∫≠p tin nh·∫Øn..." required>
                <button id="sendBtn" class="send-btn" type="submit">G·ª≠i</button>
                <div id="emojiPanel" class="emoji-panel">
                    <div class="emoji-grid">
                        <div class="emoji-btn">üòÄ</div>
                        <div class="emoji-btn">üòÅ</div>
                        <div class="emoji-btn">üòÇ</div>
                        <div class="emoji-btn">üòä</div>
                        <div class="emoji-btn">üòç</div>
                        <div class="emoji-btn">üòé</div>
                        <div class="emoji-btn">üëç</div>
                        <div class="emoji-btn">üôè</div>
                        <div class="emoji-btn">üéâ</div>
                        <div class="emoji-btn">üíñ</div>
                        <div class="emoji-btn">üî•</div>
                        <div class="emoji-btn">‚ú®</div>
                        <div class="emoji-btn">üõçÔ∏è</div>
                        <div class="emoji-btn">üöö</div>
                        <div class="emoji-btn">üí≥</div>
                        <div class="emoji-btn">üß¥</div>
                    </div>
                </div>
            </form>
        </section>

        <!-- Right rail: News and Flash Sale -->
        <aside class="rail">
            <div class="panel" style="max-height: 34vh;">
                <h3>Tin t·ª©c m·ªõi</h3>
                <a class="news-item" href="/news">
                    <div class="news-thumb"><img src="{{ url_for('static', filename='image/tintuc/cach-chon-kem-chong-nang-phu-hop-nhat-cho-tung-loai-da-201910150810078833.jpg') }}" alt="news"></div>
                    <div>
                        <div class="news-title">C√°ch ch·ªçn kem ch·ªëng n·∫Øng ph√π h·ª£p</div>
                        <div class="news-meta">12/08/2025 ¬∑ 6 ph√∫t</div>
                    </div>
                </a>
                <a class="news-item" href="/online-payment-safety">
                    <div class="news-thumb"><img src="{{ url_for('static', filename='image/demo/47e547c3-bc87-4c3a-a0da-eeddf358e0f5.webp') }}" alt="safety"></div>
                    <div>
                        <div class="news-title">Thanh to√°n online an to√†n</div>
                        <div class="news-meta">05/08/2025 ¬∑ 4 ph√∫t</div>
                    </div>
                </a>
                <a class="news-item" href="/shopping-guide">
                    <div class="news-thumb"><img src="{{ url_for('static', filename='image/demo/1200x429px_f18b4a4fee8d439b95d810bbd94b3493.jpg') }}" alt="guide"></div>
                    <div>
                        <div class="news-title">H∆∞·ªõng d·∫´n mua h√†ng & thanh l√Ω h·ªô</div>
                        <div class="news-meta">08/08/2025 ¬∑ 5 ph√∫t</div>
                    </div>
                </a>
            </div>

            <div class="panel" style="max-height: 34vh;">
                <h3>Flash Sale gi·ªù v√†ng</h3>
                <div class="prod">
                    <div class="prod-thumb"><img src="{{ url_for('static', filename='image/demo/facebook-dynamic-sua-rua-mat-cetaphil-diu-nhe-khong-xa-phong-500ml-moi-1741235596_img_300x300_b798dd_fit_center.jpg') }}" alt="Cetaphil"></div>
                    <div>
                        <div class="prod-name">Cetaphil D·ªãu Nh·∫π</div>
                        <div><span class="prod-price">128.000‚Ç´</span><span class="prod-old">320.000‚Ç´</span><span class="prod-badge">-60%</span></div>
                    </div>
                    <a href="/flash-sale" class="prod-btn">Xem</a>
                </div>
                <div class="prod">
                    <div class="prod-thumb"><img src="{{ url_for('static', filename='image/demo/facebook-dynamic-kem-chong-nang-l-oreal-paris-x20-thoang-da-mong-nhe-50ml-1738898716_img_300x300_b798dd_fit_center.jpg') }}" alt="L'Oreal"></div>
                    <div>
                        <div class="prod-name">L'Oreal Ch·ªëng N·∫Øng</div>
                        <div><span class="prod-price">157.500‚Ç´</span><span class="prod-old">350.000‚Ç´</span><span class="prod-badge">-55%</span></div>
                    </div>
                    <a href="/flash-sale" class="prod-btn">Xem</a>
                </div>
                <div class="prod">
                    <div class="prod-thumb"><img src="{{ url_for('static', filename='image/demo/facebook-dynamic-nuoc-tay-trang-bioderma-danh-cho-da-dau-hon-hop-500ml-1745303871_img_300x300_b798dd_fit_center.jpg') }}" alt="Bioderma"></div>
                    <div>
                        <div class="prod-name">T·∫©y Trang Bioderma</div>
                        <div><span class="prod-price">98.000‚Ç´</span><span class="prod-old">280.000‚Ç´</span><span class="prod-badge">-65%</span></div>
                    </div>
                    <a href="/flash-sale" class="prod-btn">Xem</a>
                </div>
            </div>
        </aside>
    </div>
</div>

<script>
(function() {
    const chatBody = document.getElementById('chatBody');
    const input = document.getElementById('messageInput');
    const form = document.getElementById('composer');
    const attachBtn = document.getElementById('attachBtn');
    const attachInput = document.getElementById('attachInput');
    const emojiBtn = document.getElementById('emojiBtn');
    const emojiPanel = document.getElementById('emojiPanel');

    function appendUserMessage(text) {
        const wrap = document.createElement('div');
        wrap.className = 'msg user';
        wrap.innerHTML = '<div><div class="bubble"></div><div class="time"></div></div>';
        wrap.querySelector('.bubble').textContent = text;
        wrap.querySelector('.time').textContent = 'V·ª´a xong';
        chatBody.appendChild(wrap);
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    function appendUserImage(src) {
        const wrap = document.createElement('div');
        wrap.className = 'msg user';
        wrap.innerHTML = '<div><div class="bubble"><img class="chat-image"/></div><div class="time"></div></div>';
        wrap.querySelector('img.chat-image').src = src;
        wrap.querySelector('.time').textContent = 'V·ª´a xong';
        chatBody.appendChild(wrap);
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    function appendAgentMessage(text) {
        const wrap = document.createElement('div');
        wrap.className = 'msg agent';
        wrap.innerHTML = '<img src="{{ url_for('static', filename='image/logo.png') }}" alt="BuddySkincare" style="width:28px;height:28px;border-radius:50%;object-fit:cover;"><div><div class="bubble"></div><div class="time"></div></div>';
        wrap.querySelector('.bubble').textContent = text;
        wrap.querySelector('.time').textContent = 'V·ª´a xong';
        chatBody.appendChild(wrap);
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    // Demo bot reply
    function botReply(userText) {
        const lower = userText.toLowerCase();
        let reply = 'C·∫£m ∆°n b·∫°n, m√¨nh ƒë√£ ghi nh·∫≠n. Nh√¢n vi√™n s·∫Ω ph·∫£n h·ªìi s·ªõm!';
        if (lower.includes('ship') || lower.includes('v·∫≠n chuy·ªÉn')) reply = 'Ph√≠ ship gi·∫£m 50% khi chuy·ªÉn kho·∫£n. N·ªôi th√†nh 1‚Äì2 ng√†y, ngo·∫°i t·ªânh 2‚Äì5 ng√†y nh√©!';
        if (lower.includes('thanh to√°n') || lower.includes('chuy·ªÉn kho·∫£n')) reply = 'STK Saccombank 0701 1991 0003 ‚Äì NGUYEN HUU NGHIA. Nh·ªõ ghi n·ªôi dung BSK-[M√É ƒê∆†N]-[SƒêT] nh√©!';
        if (lower.includes('thanh l√Ω') || lower.includes('pass')) reply = 'Thanh l√Ω h·ªô: khi c√≥ ng∆∞·ªùi mua v√† sau 5 ng√†y x√°c nh·∫≠n th√†nh c√¥ng, b·∫°n nh·∫≠n 80% (tr·ª´ 20% ph√≠ d·ªãch v·ª•).';
        setTimeout(() => appendAgentMessage(reply), 600);
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const text = (input.value || '').trim();
        if (!text) return;
        appendUserMessage(text);
        input.value = '';
        botReply(text);
    });

    attachBtn.addEventListener('click', () => attachInput.click());
    attachInput.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        if (!file.type.startsWith('image/')) { alert('Vui l√≤ng ch·ªçn ·∫£nh.'); return; }
        const reader = new FileReader();
        reader.onload = () => {
            appendUserImage(reader.result);
            // Optional bot acknowledgement
            setTimeout(() => appendAgentMessage('ƒê√£ nh·∫≠n h√¨nh ·∫£nh, c·∫£m ∆°n b·∫°n!'), 500);
        };
        reader.readAsDataURL(file);
        attachInput.value = '';
    });

    // Emoji picker
    function toggleEmoji(show) {
        emojiPanel.style.display = show === undefined ? (emojiPanel.style.display === 'none' || !emojiPanel.style.display ? 'block' : 'none') : (show ? 'block' : 'none');
    }
    emojiBtn.addEventListener('click', () => toggleEmoji());
    emojiPanel.addEventListener('click', (e) => {
        const target = e.target.closest('.emoji-btn');
        if (!target) return;
        const emoji = target.textContent;
        const start = input.selectionStart || input.value.length;
        const end = input.selectionEnd || input.value.length;
        input.value = input.value.slice(0, start) + emoji + input.value.slice(end);
        input.focus();
        input.selectionStart = input.selectionEnd = start + emoji.length;
    });
    document.addEventListener('click', (e) => {
        if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) toggleEmoji(false);
    });
})();
</script>
{% endblock %}
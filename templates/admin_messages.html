{% extends "admin_base.html" %}

{% block title %}Quản Lý Tin Nhắn - Admin{% endblock %}

{% block extra_css %}
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
    /* Mobile responsive styles for admin messages */
    @media (max-width: 768px) {
        .messages-container {
            height: auto;
            max-height: none;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
        }
        
        .conversations-panel {
            width: 100%;
            max-height: 300px;
            order: 2;
        }
        
        .conversations-header {
            padding: 15px;
        }
        
        .conversations-list {
            padding: 8px;
        }
        
        .conversation-item {
            padding: 12px;
            margin-bottom: 6px;
        }
        
        .conversation-avatar {
            width: 35px;
            height: 35px;
            font-size: 14px;
        }
        
        .conversation-name {
            font-size: 13px;
        }
        
        .conversation-preview {
            font-size: 12px;
        }
        
        .conversation-time {
            font-size: 10px;
        }
        
        .unread-badge {
            width: 18px;
            height: 18px;
            font-size: 10px;
        }
        
        .chat-panel {
            order: 1;
            min-height: 400px;
        }
        
        .chat-header {
            padding: 15px;
        }
        
        .chat-avatar {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }
        
        .chat-user-info h4 {
            font-size: 15px;
        }
        
        .chat-user-info p {
            font-size: 12px;
        }
        
        .chat-messages {
            padding: 15px;
            gap: 12px;
            max-height: 310px;
            min-height: 250px;
        }
        
        .message {
            gap: 8px;
        }
        
        .message-avatar {
            width: 30px;
            height: 30px;
            font-size: 12px;
        }
        
        .message-content {
            max-width: calc(100% - 50px);
        }
        
        .message-bubble {
            padding: 10px 12px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .message-time {
            font-size: 11px;
        }
        
        .chat-input {
            padding: 15px;
            display: block !important;
            visibility: visible !important;
        }
        
        .input-group {
            margin-bottom: 10px;
        }
        
        .form-control {
            font-size: 14px;
            padding: 10px 12px;
        }
        
        .btn {
            font-size: 14px;
            padding: 10px 15px;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 13px;
        }
        
        .card {
            margin-bottom: 1rem;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .card-header {
            padding: 0.75rem 1rem;
        }
        
        .d-flex.gap-2 {
            flex-direction: column;
            gap: 0.5rem !important;
        }
        
        .d-flex.gap-2 .btn {
            width: 100%;
            margin-bottom: 0.25rem;
        }
        
        .d-flex.justify-content-between {
            flex-direction: column;
            align-items: flex-start !important;
        }
        
        .d-flex.justify-content-between .btn-group {
            width: 100%;
            margin-top: 1rem;
        }
        
        .btn-group .btn {
            flex: 1;
            font-size: 0.8rem;
            padding: 0.5rem 0.25rem;
        }
        
        .modal-lg {
            max-width: 95%;
        }
        
        .modal-xl {
            max-width: 98%;
        }
        
        .form-control, .form-select {
            font-size: 0.9rem;
        }
        
        .form-label {
            font-size: 0.9rem;
        }
        
        .badge {
            font-size: 0.8rem;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-size: 1.2rem;
        }
        
        .table-responsive {
            font-size: 0.8rem;
        }
        
        .table th, .table td {
            padding: 0.5rem 0.25rem;
        }
    }
    
    @media (max-width: 480px) {
        .messages-container {
            padding: 5px;
            gap: 8px;
        }
        
        .conversations-panel {
            max-height: 250px;
        }
        
        .conversations-header {
            padding: 12px;
        }
        
        .conversations-list {
            padding: 6px;
        }
        
        .conversation-item {
            padding: 10px;
            margin-bottom: 4px;
        }
        
        .conversation-avatar {
            width: 30px;
            height: 30px;
            font-size: 12px;
        }
        
        .conversation-name {
            font-size: 12px;
        }
        
        .conversation-preview {
            font-size: 11px;
        }
        
        .conversation-time {
            font-size: 9px;
        }
        
        .unread-badge {
            width: 16px;
            height: 16px;
            font-size: 9px;
        }
        
        .chat-panel {
            min-height: 350px;
        }
        
        .chat-header {
            padding: 12px;
        }
        
        .chat-avatar {
            width: 35px;
            height: 35px;
            font-size: 14px;
        }
        
        .chat-user-info h4 {
            font-size: 14px;
        }
        
        .chat-user-info p {
            font-size: 11px;
        }
        
        .chat-messages {
            padding: 12px;
            gap: 10px;
            max-height: calc(100vh - 250px);
            min-height: 200px;
        }
        
        .message {
            gap: 6px;
        }
        
        .message-avatar {
            width: 25px;
            height: 25px;
            font-size: 10px;
        }
        
        .message-content {
            max-width: calc(100% - 40px);
        }
        
        .message-bubble {
            padding: 8px 10px;
            font-size: 13px;
            line-height: 1.3;
        }
        
        .message-time {
            font-size: 10px;
        }
        
        .chat-input {
            padding: 12px;
            display: block !important;
            visibility: visible !important;
        }
        
        .form-control {
            font-size: 13px;
            padding: 8px 10px;
        }
        
        .btn {
            font-size: 13px;
            padding: 8px 12px;
        }
        
        .btn-sm {
            padding: 6px 10px;
            font-size: 12px;
        }
        
        .card-body {
            padding: 0.75rem;
        }
        
        .card-header {
            padding: 0.5rem 0.75rem;
        }
        
        .d-flex.gap-2 .btn {
            font-size: 0.8rem;
            padding: 0.5rem;
        }
        
        .form-control, .form-select {
            font-size: 0.8rem;
        }
        
        .form-label {
            font-size: 0.8rem;
        }
        
        .badge {
            font-size: 0.7rem;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-size: 1.1rem;
        }
        
        .table th, .table td {
            padding: 0.25rem 0.1rem;
            font-size: 0.7rem;
        }
        
        .modal-dialog {
            margin: 0.5rem;
        }
        
        .input-group-text {
            font-size: 0.8rem;
            padding: 0.375rem 0.5rem;
        }
    }
    
    /* Hide chat panel on very small screens when conversations are shown */
    @media (max-width: 360px) {
        .conversations-panel.show-mobile {
            max-height: 200px;
        }
        
        .chat-panel.hide-mobile {
            display: none !important;
        }
        
        .conversation-item {
            padding: 8px;
        }
        
        .conversation-avatar {
            width: 25px;
            height: 25px;
            font-size: 10px;
        }
        
        .conversation-name {
            font-size: 11px;
        }
        
        .conversation-preview {
            font-size: 10px;
        }
    }
.messages-container {
    height: 600px;
    max-height: 700px;
    display: flex;
    gap: 20px;
    overflow: hidden;
}

.conversations-panel {
    width: 300px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
}

.conversations-header {
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    background: #f8f9fa;
    border-radius: 8px 8px 0 0;
}

.conversations-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.conversation-item {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid transparent;
    display: flex;
    align-items: center;
    gap: 12px;
}

.conversation-item:hover {
    background: #f8f9fa;
    border-color: #dee2e6;
}

.conversation-item.active {
    background: #e3f2fd;
    border-color: #2196f3;
}

.conversation-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #2196f3;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
    overflow: hidden;
}

.conversation-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.conversation-info {
    flex: 1;
    min-width: 0;
}

.conversation-name {
    font-weight: 600;
    margin: 0 0 4px 0;
    font-size: 14px;
    color: #333;
}

.conversation-preview {
    margin: 0;
    font-size: 13px;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.conversation-time {
    font-size: 11px;
    color: #999;
    margin: 4px 0 0 0;
}

.unread-badge {
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
    flex-shrink: 0;
}

.chat-panel {
    flex: 1;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    height: 100%;
    max-height: 100%;
    overflow: hidden;
}

#chatInterface {
    display: none;
    flex: 1;
    flex-direction: column;
}

#chatInterface.show {
    display: flex !important;
}

.chat-header {
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    background: #f8f9fa;
    border-radius: 8px 8px 0 0;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
}

.chat-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: #2196f3;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 18px;
    overflow: hidden;
}

.chat-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.chat-user-info h4 {
    margin: 0 0 4px 0;
    font-size: 16px;
    color: #333;
}

.chat-user-info p {
    margin: 0;
    font-size: 13px;
    color: #666;
}

.chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
    max-height: calc(100vh - 400px);
    min-height: 300px;
}

.message {
    display: flex;
    gap: 10px;
    max-width: 70%;
}

.message.user {
    align-self: flex-start;
}

.message.agent {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 12px;
    color: white;
    flex-shrink: 0;
    overflow: hidden;
}

.message-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.message.user .message-avatar {
    background: #4caf50;
}

.message.agent .message-avatar {
    background: #2196f3;
}

.message-content {
    flex: 1;
}

.message-bubble {
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
    word-break: break-word;
    max-width: 100%;
    overflow-wrap: break-word;
    white-space: pre-wrap;
}

.message.user .message-bubble {
    background: #e3f2fd;
    color: #1976d2;
}

.message.agent .message-bubble {
    background: #f5f5f5;
    color: #333;
}

.message-time {
    font-size: 11px;
    color: #999;
    margin-top: 4px;
    text-align: left;
}

.message.agent .message-time {
    text-align: right;
}

.chat-input {
    padding: 20px;
    border-top: 1px solid #e9ecef;
    background: #f8f9fa;
    border-radius: 0 0 8px 8px;
    flex-shrink: 0;
    display: block !important;
    visibility: visible !important;
}

.input-group {
    display: flex !important;
    gap: 10px;
    visibility: visible !important;
}

.form-control {
    flex: 1;
    border-radius: 20px;
    border: 1px solid #ddd;
    padding: 10px 16px;
    display: block !important;
    visibility: visible !important;
}

.btn-send {
    background: #2196f3;
    color: white;
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    display: flex !important;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s ease;
    visibility: visible !important;
}

.btn-send:hover:not(:disabled) {
    background: #1976d2;
}

.btn-send:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #666;
    text-align: center;
}

.empty-state i {
    font-size: 48px;
    margin-bottom: 16px;
    color: #ddd;
}

.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.spinner {
    width: 32px;
    height: 32px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #2196f3;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.online-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #4caf50;
    font-size: 14px;
}

.online-dot {
    width: 8px;
    height: 8px;
    background: #4caf50;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.no-messages {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.stats-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-item {
    text-align: center;
    padding: 25px 20px;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 12px;
    border: 1px solid #e9ecef;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #2196f3, #21cbf3);
}

.stat-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.stat-item:nth-child(1)::before {
    background: linear-gradient(90deg, #2196f3, #21cbf3);
}

.stat-item:nth-child(2)::before {
    background: linear-gradient(90deg, #4caf50, #8bc34a);
}

.stat-item:nth-child(3)::before {
    background: linear-gradient(90deg, #ff9800, #ffc107);
}

.stat-item:nth-child(4)::before {
    background: linear-gradient(90deg, #9c27b0, #e91e63);
}

.stat-number {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #2196f3, #21cbf3);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1.2;
}

.stat-item:nth-child(1) .stat-number {
    background: linear-gradient(135deg, #2196f3, #21cbf3);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stat-item:nth-child(2) .stat-number {
    background: linear-gradient(135deg, #4caf50, #8bc34a);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stat-item:nth-child(3) .stat-number {
    background: linear-gradient(135deg, #ff9800, #ffc107);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stat-item:nth-child(4) .stat-number {
    background: linear-gradient(135deg, #9c27b0, #e91e63);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stat-icon {
    font-size: 24px;
    margin-bottom: 15px;
    opacity: 0.7;
}

.stat-item:nth-child(1) .stat-icon {
    color: #2196f3;
}

.stat-item:nth-child(2) .stat-icon {
    color: #4caf50;
}

.stat-item:nth-child(3) .stat-icon {
    color: #ff9800;
}

.stat-item:nth-child(4) .stat-icon {
    color: #9c27b0;
}

.stat-label {
    color: #666;
    font-size: 14px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-comments me-2"></i>Quản Lý Tin Nhắn Khách Hàng</h2>
    <div class="online-indicator">
        <div class="online-dot"></div>
        <span>Đang hoạt động</span>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-item">
        <div class="stat-icon">
            <i class="fas fa-comments"></i>
        </div>
        <div class="stat-number" id="totalMessages">-</div>
        <div class="stat-label">Tổng tin nhắn</div>
    </div>
    <div class="stat-item">
        <div class="stat-icon">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-number" id="totalConversations">-</div>
        <div class="stat-label">Cuộc trò chuyện</div>
    </div>
    <div class="stat-item">
        <div class="stat-icon">
            <i class="fas fa-bell"></i>
        </div>
        <div class="stat-number" id="unreadMessages">-</div>
        <div class="stat-label">Chưa đọc</div>
    </div>
    <div class="stat-item">
        <div class="stat-icon">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-number" id="responseTime">-</div>
        <div class="stat-label">Thời gian phản hồi TB</div>
    </div>
</div>

<div class="messages-container">
    <div class="conversations-panel">
        <div class="conversations-header">
            <h3 class="conversations-title mb-0">Cuộc trò chuyện</h3>
        </div>
        <div class="conversations-list" id="conversationsList">
            <div class="loading-spinner">
                <div class="spinner"></div>
            </div>
        </div>
    </div>
    
    <div class="chat-panel">
        <div id="emptyChatState" class="empty-state">
            <i class="fas fa-comments"></i>
            <h4>Chọn cuộc trò chuyện</h4>
            <p>Chọn một cuộc trò chuyện từ danh sách bên trái để bắt đầu.</p>
        </div>
        
        <div id="chatInterface">
            <div class="chat-header">
                <div class="chat-avatar" id="chatAvatar"></div>
                <div class="chat-user-info">
                    <h4 id="chatUserName"></h4>
                    <p id="chatUserInfo">Thông tin khách hàng</p>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                </div>
            
            <div class="chat-input">
                <div class="input-group">
                    <input type="text" class="form-control" id="messageInput" placeholder="Nhập tin nhắn...">
                    <button class="btn-send" id="sendButton" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let currentConversation = null;
let conversations = [];
let messages = [];
let db = null;
let messagesListener = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeFirebase();
    loadStats();
    
    // Add event listeners
    document.getElementById('sendButton').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
});

// Initialize Firebase
function initializeFirebase() {
    if (typeof firebase !== 'undefined') {
        const firebaseConfig = {
            apiKey: "AIzaSyBl_8N53eSIGEbBN2TBSGW36vabMdq2lbI",
            authDomain: "buddyskincare-ec603.firebaseapp.com",
            projectId: "buddyskincare-ec603",
            storageBucket: "buddyskincare-ec603.firebasestorage.app",
            messagingSenderId: "151445800213",
            appId: "1:151445800213:web:62dafa29093235e913151c",
            measurementId: "G-5PLJ2MQ9PW"
        };
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase initialized successfully.");
            startConversationsListener();
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }
    } else {
        console.error('Firebase SDK is not loaded correctly. Please check your script tags.');
    }
}

// Load statistics
async function loadStats() {
    try {
        if (!db) {
            console.log('Firebase not initialized yet, will retry...');
            setTimeout(loadStats, 1000);
            return;
        }
        
        // Get all chats to calculate stats
        const chatsSnapshot = await db.collection('chats').get();
        let totalMessages = 0;
        let totalConversations = chatsSnapshot.size;
        let unreadMessages = 0;
        let responseTimes = [];
        
        // Process each chat
        for (const chatDoc of chatsSnapshot.docs) {
            const chatData = chatDoc.data();
            
            // Count messages in this chat
            const messagesSnapshot = await db.collection('chats').doc(chatDoc.id)
                .collection('messages').get();
            totalMessages += messagesSnapshot.size;
            
            // Check for unread messages (latest message from customer and not read by admin)
            const hasUnreadMessage = chatData.latestMessage && chatData.latestMessage.senderId !== 'admin_001';
            const isReadByAdmin = chatData.isReadByAdmin || false;
            if (hasUnreadMessage && !isReadByAdmin) {
                unreadMessages++;
            }
            
            // Calculate response time (simplified - time between customer and admin messages)
            if (messagesSnapshot.size > 1) {
                const messages = messagesSnapshot.docs.map(doc => ({
                    ...doc.data(),
                    timestamp: doc.data().timestamp.toDate()
                })).sort((a, b) => a.timestamp - b.timestamp);
                
                for (let i = 0; i < messages.length - 1; i++) {
                    if (messages[i].senderId !== 'admin_001' && messages[i + 1].senderId === 'admin_001') {
                        const responseTime = messages[i + 1].timestamp - messages[i].timestamp;
                        responseTimes.push(responseTime);
                    }
                }
            }
        }
        
        // Calculate average response time
        let avgResponseTime = 'N/A';
        if (responseTimes.length > 0) {
            const avgMs = responseTimes.reduce((sum, time) => sum + time, 0) / responseTimes.length;
            const avgHours = avgMs / (1000 * 60 * 60);
            if (avgHours < 1) {
                avgResponseTime = `${Math.round(avgMs / (1000 * 60))} phút`;
            } else {
                avgResponseTime = `${avgHours.toFixed(1)} giờ`;
            }
        }
        
        // Update UI
        document.getElementById('totalMessages').textContent = totalMessages.toLocaleString();
        document.getElementById('totalConversations').textContent = totalConversations.toLocaleString();
        document.getElementById('unreadMessages').textContent = unreadMessages.toLocaleString();
        document.getElementById('responseTime').textContent = avgResponseTime;
        
    } catch (error) {
        console.error('Error loading stats:', error);
        // Fallback to default values
        document.getElementById('totalMessages').textContent = '0';
        document.getElementById('totalConversations').textContent = '0';
        document.getElementById('unreadMessages').textContent = '0';
        document.getElementById('responseTime').textContent = 'N/A';
    }
}

// Start conversations listener
function startConversationsListener() {
    if (!db) {
        console.error('Firebase not initialized');
        return;
    }
    
    db.collection('chats').onSnapshot(snapshot => {
        conversations = [];
        snapshot.forEach(doc => {
            const chatData = doc.data();
            const chatId = doc.id;
            const userId = chatId.split('_').find(id => id !== 'admin_001');
            
            // Check if conversation is unread
            const hasUnreadMessage = chatData.latestMessage && chatData.latestMessage.senderId !== 'admin_001';
            const isReadByAdmin = chatData.isReadByAdmin || false;
            const unread = hasUnreadMessage && !isReadByAdmin;
            
            // Lấy tên và avatar từ conversation data (ưu tiên) hoặc fetch từ API
            let customerName = `Người dùng ${userId}`;
            let customerAvatar = null;
            
            // Ưu tiên lấy từ conversation data (đã lưu cố định)
            if (chatData.customerName) {
                customerName = chatData.customerName;
                customerAvatar = chatData.customerAvatar;
            } else if (chatData.latestMessage) {
                // Fallback: lấy từ tin nhắn cuối cùng nếu là từ user
                if (chatData.latestMessage.senderId !== 'admin_001') {
                    customerName = chatData.latestMessage.senderName || `Người dùng ${userId}`;
                    customerAvatar = chatData.latestMessage.senderAvatar;
                }
            }
            
            // Nếu chưa có thông tin user, fetch từ API
            if (customerName === `Người dùng ${userId}` && userId && userId !== 'admin_001') {
                fetchUserInfoFromAPI(userId, chatId);
            }
            
            conversations.push({
                id: chatId,
                userId: userId,
                customerName: customerName,
                customerAvatar: customerAvatar,
                latestMessage: chatData.latestMessage,
                lastMessage: chatData.latestMessage ? chatData.latestMessage.text : 'Chưa có tin nhắn',
                lastMessageTime: chatData.latestMessage ? chatData.latestMessage.timestamp.toDate().toISOString() : new Date().toISOString(),
                unreadCount: unread ? 1 : 0,
                isFromCustomer: chatData.latestMessage ? chatData.latestMessage.senderId !== 'admin_001' : true
            });
        });
        
        renderConversations();
        
        // Update stats when conversations change
        loadStats();
        
        // Re-select the current conversation if it exists
        if (currentConversation) {
            const activeItem = document.querySelector(`[data-conversation-id="${currentConversation.id}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }
        
        // Debug: Log conversation data
        console.log('Conversations loaded:', conversations.map(c => ({
            id: c.id,
            customerName: c.customerName,
            customerAvatar: c.customerAvatar,
            lastMessage: c.lastMessage
        })));
        
        // Fetch thông tin user cho các conversations chưa có thông tin
        conversations.forEach(conv => {
            if (conv.customerName === `Người dùng ${conv.userId}` && conv.userId && conv.userId !== 'admin_001') {
                fetchUserInfoFromAPI(conv.userId, conv.id);
            }
        });
    }, error => {
        console.error('Error listening to conversations:', error);
        document.getElementById('conversationsList').innerHTML = 
            '<div class="no-messages">Lỗi khi tải cuộc trò chuyện. Vui lòng kiểm tra lại cấu trúc dữ liệu hoặc quy tắc bảo mật của Firebase.</div>';
    });
}

// Render conversations list
function renderConversations() {
    const container = document.getElementById('conversationsList');
    
    if (conversations.length === 0) {
        container.innerHTML = '<div class="no-messages">Chưa có cuộc trò chuyện nào</div>';
        return;
    }
    
    // Sort conversations by last message time
    conversations.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
    
    const conversationsHTML = conversations.map(conv => {
        const timeAgo = getTimeAgo(new Date(conv.lastMessageTime));
        const preview = conv.lastMessage || 'Tin nhắn trống';

        // Tạo HTML cho avatar
        let avatarContent = `<img src="${conv.customerAvatar}" alt="Avatar">`;
        if (conv.customerAvatar) {
            avatarContent = `<img src="${conv.customerAvatar}" alt="Avatar">`;
        } else {
            // Nếu không có ảnh, dùng chữ cái đầu
            console.log("customerAvatar",conv.customerAvatar)
        }

        return `
            <div class="conversation-item" data-conversation-id="${conv.id}" onclick="selectConversation('${conv.id}')">
                <div class="conversation-avatar">${avatarContent}</div>
                <div class="conversation-info">
                    <h4 class="conversation-name">${conv.customerName}</h4>
                    <p class="conversation-preview">${conv.isFromCustomer ? '' : 'Bạn: '}${preview}</p>
                    <p class="conversation-time">${timeAgo}</p>
                </div>
                ${conv.unreadCount > 0 ? `<div class="unread-badge">${conv.unreadCount}</div>` : ''}
            </div>
        `;
    }).join('');
    
    container.innerHTML = conversationsHTML;
}

// Select conversation
function selectConversation(conversationId) {
    currentConversation = conversations.find(c => c.id === conversationId);
    if (!currentConversation) return;
    
    // Update UI
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-conversation-id="${conversationId}"]`).classList.add('active');
    
    // Show chat interface
    document.getElementById('emptyChatState').style.display = 'none';
    document.getElementById('chatInterface').classList.add('show');
    
    // Update chat header with user name and avatar
    const chatAvatarEl = document.getElementById('chatAvatar');
    const chatUserNameEl = document.getElementById('chatUserName');

    // Cập nhật Avatar và Tên
    if (currentConversation.customerAvatar) {
        chatAvatarEl.innerHTML = `<img src="${currentConversation.customerAvatar}" alt="Avatar">`;
    } else {
        chatAvatarEl.innerHTML = currentConversation.customerName.charAt(0).toUpperCase();
    }
    chatUserNameEl.textContent = currentConversation.customerName;
    document.getElementById('chatUserInfo').textContent = `SĐT: ${currentConversation.userId}`;
    
    // Fetch thông tin user mới nhất từ API nếu cần
    if (currentConversation.userId && currentConversation.userId !== 'admin_001') {
        fetchUserInfoFromAPI(currentConversation.userId, conversationId);
    }
    
    // Start messages listener
    startMessagesListener(conversationId);
    
    // Enable send button
    document.getElementById('sendButton').disabled = false;
    
    // Remove unread badge and mark as read
    const unreadBadge = document.querySelector(`[data-conversation-id="${conversationId}"] .unread-badge`);
    if (unreadBadge) {
        unreadBadge.remove();
    }
    
    // Mark conversation as read in Firebase
    markConversationAsRead(conversationId);
}

// Mark conversation as read
async function markConversationAsRead(conversationId) {
    try {
        if (!db) return;
        
        // Update the chat document to mark as read
        await db.collection('chats').doc(conversationId).update({
            lastReadByAdmin: firebase.firestore.FieldValue.serverTimestamp(),
            isReadByAdmin: true
        });
        
        console.log('Conversation marked as read:', conversationId);
        
    } catch (error) {
        console.error('Error marking conversation as read:', error);
    }
}

// Start real-time listener for messages
function startMessagesListener(conversationId) {
    if (messagesListener) {
        messagesListener(); // Unsubscribe from the previous listener
    }
    
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
    
    messagesListener = db.collection('chats').doc(conversationId)
        .collection('messages')
        .orderBy('timestamp', 'asc')
        .onSnapshot(snapshot => {
            const messages = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                timestamp: doc.data().timestamp.toDate().toISOString(),
                isFromCustomer: doc.data().senderId !== 'admin_001'
            }));
            
            // Tự động cập nhật conversation data nếu chưa có thông tin user
            if (messages.length > 0 && !currentConversation.customerName) {
                const firstUserMessage = messages.find(msg => msg.isFromCustomer);
                if (firstUserMessage) {
                    // Ưu tiên fetch từ API nếu có userId
                    if (firstUserMessage.senderId && firstUserMessage.senderId !== 'admin_001') {
                        fetchUserInfoFromAPI(firstUserMessage.senderId, conversationId);
                    } else {
                        // Fallback: dùng thông tin từ tin nhắn
                        updateConversationUserInfo(conversationId, {
                            name: firstUserMessage.senderName,
                            avatar: firstUserMessage.senderAvatar,
                            id: firstUserMessage.senderId
                        });
                    }
                }
            }
            
            renderMessages(messages);
        }, error => {
            console.error('Error listening to messages:', error);
            chatMessages.innerHTML = '<div class="no-messages">Lỗi khi tải tin nhắn. Vui lòng kiểm tra lại cấu trúc dữ liệu hoặc quy tắc bảo mật của Firebase.</div>';
        });
}

// Render messages
function renderMessages(messages) {
    const chatMessages = document.getElementById('chatMessages');
    
    // Lấy thông tin khách hàng từ cuộc trò chuyện hiện tại
    const customerName = currentConversation ? currentConversation.customerName : 'Khách hàng';
    const customerAvatar = currentConversation ? currentConversation.customerAvatar : null;

    if (messages.length === 0) {
        chatMessages.innerHTML = '<div class="no-messages">Chưa có tin nhắn nào</div>';
        return;
    }
    
    const messagesHTML = messages.map(message => {
        const time = new Date(message.timestamp).toLocaleTimeString('vi-VN', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const messageClass = message.isFromCustomer ? 'user' : 'agent';
        
        // Xác định tên và avatar sẽ hiển thị
        let senderName, senderAvatar;
        let avatarHtml = '';

        if (message.isFromCustomer) {
            // Luôn dùng thông tin từ conversation để đảm bảo nhất quán
            senderName = customerName;
            senderAvatar = customerAvatar;

            if (senderAvatar) {
                avatarHtml = `<img src="${senderAvatar}" alt="${senderName}">`;
            } else {
                avatarHtml = senderName.charAt(0).toUpperCase();
            }
        } else {
            // Đối với tin nhắn của Admin, luôn dùng tên và avatar cố định
            senderName = 'Admin';
            senderAvatar = '/static/image/logo.png';
            avatarHtml = `<img src="${senderAvatar}" alt="${senderName}">`;
        }

        return `
            <div class="message ${messageClass}">
                <div class="message-avatar">${avatarHtml}</div>
                <div class="message-content">
                    <div class="message-bubble">${convertLinksToClickable(message.text)}</div>
                    <div class="message-time">${time}</div>
                </div>
            </div>
        `;
    }).join('');
    
    chatMessages.innerHTML = messagesHTML;
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Send message
async function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const messageText = messageInput.value.trim();
    
    if (!messageText || !currentConversation || !db) return;
    
    try {
        // Clear input immediately
        messageInput.value = '';
        
        // Send message to Firebase
        await db.collection('chats').doc(currentConversation.id)
            .collection('messages')
            .add({
                text: messageText,
                senderId: 'admin_001',
                senderName: 'Admin', // Tên mặc định của Admin
                senderAvatar: '/static/image/logo.png', // Avatar mặc định của Admin
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        
        // Update latest message in chat document (chỉ cập nhật text và timestamp)
        await db.collection('chats').doc(currentConversation.id)
            .update({
                latestMessage: {
                    text: messageText,
                    senderId: 'admin_001',
                    senderName: 'Admin',
                    senderAvatar: '/static/image/logo.png',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                },
                // Mark as read after admin sends a message
                isReadByAdmin: true
            });
        
        console.log('Message sent successfully to Firebase');
        
    } catch (error) {
        console.error('Error sending message:', error);
        alert('Lỗi khi gửi tin nhắn: ' + error.message);
        
        // Restore input text on error
        messageInput.value = messageText;
    }
}

// Function to fetch user info from API
async function fetchUserInfoFromAPI(userId, conversationId) {
    try {
        console.log(`Fetching user info for userId: ${userId}`);
        const response = await fetch(`https://buddyskincare.vn/backend/api/customer/${userId}`);
        
        if (response.ok) {
            const userData = await response.json();
            console.log('User data from API:', userData);
            
            // Cập nhật conversation data với thông tin user từ API
            await updateConversationUserInfo(conversationId, {
                name: userData.name,
                avatar: userData.avatar,
                id: userData.id
            });
            
            // Cập nhật conversation trong danh sách hiện tại
            const conversation = conversations.find(c => c.id === conversationId);
            if (conversation) {
                conversation.customerName = userData.name;
                conversation.customerAvatar = userData.avatar;
                
                // Re-render conversations để hiển thị tên mới
                renderConversations();
                
                // Cập nhật chat header nếu đang xem conversation này
                if (currentConversation && currentConversation.id === conversationId) {
                    updateChatHeader(userData);
                }
            }
            
        } else {
            console.error(`Failed to fetch user info for userId ${userId}:`, response.status, response.statusText);
        }
    } catch (error) {
        console.error('Error fetching user info from API:', error);
    }
}

// Function to update chat header with user info
function updateChatHeader(userData) {
    const chatAvatarEl = document.getElementById('chatAvatar');
    const chatUserNameEl = document.getElementById('chatUserName');
    
    if (chatAvatarEl && chatUserNameEl) {
        // Cập nhật Avatar
        if (userData.avatar) {
            chatAvatarEl.innerHTML = `<img src="${userData.avatar}" alt="${userData.name}">`;
        } else {
            chatAvatarEl.innerHTML = userData.name.charAt(0).toUpperCase();
        }
        
        // Cập nhật Tên
        chatUserNameEl.textContent = userData.name;
        
        console.log('Updated chat header with user data:', userData);
    }
}

// Function to update conversation data with user info
async function updateConversationUserInfo(conversationId, userInfo) {
    try {
        await db.collection('chats').doc(conversationId).update({
            customerName: userInfo.name,
            customerAvatar: userInfo.avatar,
            customerId: userInfo.id
        });
        console.log('Updated conversation user info:', userInfo);
    } catch (error) {
        console.error('Error updating conversation user info:', error);
    }
}

// Convert links to clickable links
function convertLinksToClickable(text) {
    // Escape HTML first to prevent XSS
    const escapedText = text.replace(/&/g, '&amp;')
                           .replace(/</g, '&lt;')
                           .replace(/>/g, '&gt;')
                           .replace(/"/g, '&quot;')
                           .replace(/'/g, '&#39;');
    
    // URL regex pattern - matches http, https, www, and common domains
    const urlRegex = /(https?:\/\/[^\s]+|www\.[^\s]+|[a-zA-Z0-9-]+\.[a-zA-Z]{2,}(?:\/[^\s]*)?)/g;
    
    return escapedText.replace(urlRegex, (url) => {
        // Ensure URL has protocol
        let href = url;
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            href = 'https://' + url;
        }
        
        return `<a href="${href}" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: underline; word-break: break-all;">${url}</a>`;
    });
}

// Debug function to check conversation data
function debugConversationData(conversationId) {
    if (!db) return;
    
    db.collection('chats').doc(conversationId).get().then(doc => {
        if (doc.exists) {
            const data = doc.data();
            console.log('Conversation data for', conversationId, ':', {
                customerName: data.customerName,
                customerAvatar: data.customerAvatar,
                customerId: data.customerId,
                latestMessage: data.latestMessage
            });
        }
    });
}

// Utility function to get time ago
function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffSecs = Math.floor(diffMs / 1000);
    const diffMins = Math.floor(diffSecs / 60);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffSecs < 60) {
        return 'Vừa xong';
    } else if (diffMins < 60) {
        return `${diffMins} phút trước`;
    } else if (diffHours < 24) {
        return `${diffHours} giờ trước`;
    } else if (diffDays < 7) {
        return `${diffDays} ngày trước`;
    } else {
        return date.toLocaleDateString('vi-VN');
    }
}

// Firebase real-time listeners handle auto-refresh

// Mobile navigation functions
function toggleMobileView() {
    const conversationsPanel = document.querySelector('.conversations-panel');
    const chatPanel = document.querySelector('.chat-panel');
    
    if (window.innerWidth <= 768) {
        if (currentConversation) {
            // Show chat panel, hide conversations
            conversationsPanel.style.display = 'none';
            chatPanel.style.display = 'flex';
        } else {
            // Show conversations panel, hide chat
            conversationsPanel.style.display = 'flex';
            chatPanel.style.display = 'none';
        }
    } else {
        // Desktop view - show both
        conversationsPanel.style.display = 'flex';
        chatPanel.style.display = 'flex';
    }
}

function showConversationsList() {
    const conversationsPanel = document.querySelector('.conversations-panel');
    const chatPanel = document.querySelector('.chat-panel');
    
    if (window.innerWidth <= 768) {
        conversationsPanel.style.display = 'flex';
        chatPanel.style.display = 'none';
    }
}

function showChatPanel() {
    const conversationsPanel = document.querySelector('.conversations-panel');
    const chatPanel = document.querySelector('.chat-panel');
    
    if (window.innerWidth <= 768) {
        conversationsPanel.style.display = 'none';
        chatPanel.style.display = 'flex';
    }
    
    // Always ensure chat input is visible
    forceShowChatInput();
}

// Override selectConversation to handle mobile navigation
const originalSelectConversation = selectConversation;
selectConversation = function(conversationId) {
    originalSelectConversation(conversationId);
    
    // On mobile, switch to chat view after selecting conversation
    if (window.innerWidth <= 768) {
        showChatPanel();
    }
};

// Add back button functionality for mobile
function addBackButton() {
    const chatHeader = document.querySelector('.chat-header');
    if (chatHeader && window.innerWidth <= 768) {
        // Check if back button already exists
        if (!chatHeader.querySelector('.back-button')) {
            const backButton = document.createElement('button');
            backButton.className = 'back-button btn btn-outline-secondary btn-sm me-2';
            backButton.innerHTML = '<i class="fas fa-arrow-left"></i>';
            backButton.onclick = showConversationsList;
            chatHeader.insertBefore(backButton, chatHeader.firstChild);
        }
    }
}

// Handle window resize
window.addEventListener('resize', function() {
    toggleMobileView();
    addBackButton();
});

// Force show chat input
function forceShowChatInput() {
    const chatInput = document.querySelector('.chat-input');
    const inputGroup = document.querySelector('.input-group');
    const messageInput = document.querySelector('#messageInput');
    const sendButton = document.querySelector('#sendButton');
    
    if (chatInput) {
        chatInput.style.display = 'block';
        chatInput.style.visibility = 'visible';
    }
    
    if (inputGroup) {
        inputGroup.style.display = 'flex';
        inputGroup.style.visibility = 'visible';
    }
    
    if (messageInput) {
        messageInput.style.display = 'block';
        messageInput.style.visibility = 'visible';
    }
    
    if (sendButton) {
        sendButton.style.display = 'flex';
        sendButton.style.visibility = 'visible';
    }
}

// Initialize mobile view on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        toggleMobileView();
        addBackButton();
        forceShowChatInput();
    }, 100);
});

// Override renderConversations to add mobile click handlers
const originalRenderConversations = renderConversations;
renderConversations = function() {
    originalRenderConversations();
    
    // Add mobile click handlers
    const conversationItems = document.querySelectorAll('.conversation-item');
    conversationItems.forEach(item => {
        item.addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                showChatPanel();
            }
        });
    });
};
</script>
{% endblock %}
{% extends "admin_base.html" %}

{% block title %}Quản Lý Tin Nhắn - Admin{% endblock %}

{% block extra_css %}
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
.messages-container {
    height: 600px;
    max-height: 700px;
    display: flex;
    gap: 20px;
    overflow: hidden;
}

.conversations-panel {
    width: 300px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
}

.conversations-header {
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    background: #f8f9fa;
    border-radius: 8px 8px 0 0;
}

.conversations-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.conversation-item {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid transparent;
    display: flex;
    align-items: center;
    gap: 12px;
}

.conversation-item:hover {
    background: #f8f9fa;
    border-color: #dee2e6;
}

.conversation-item.active {
    background: #e3f2fd;
    border-color: #2196f3;
}

.conversation-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #2196f3;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
}

.conversation-info {
    flex: 1;
    min-width: 0;
}

.conversation-name {
    font-weight: 600;
    margin: 0 0 4px 0;
    font-size: 14px;
    color: #333;
}

.conversation-preview {
    margin: 0;
    font-size: 13px;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.conversation-time {
    font-size: 11px;
    color: #999;
    margin: 4px 0 0 0;
}

.unread-badge {
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
    flex-shrink: 0;
}

.chat-panel {
    flex: 1;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    height: 100%;
    max-height: 100%;
    overflow: hidden;
}

#chatInterface {
    display: none;
    flex: 1;
    flex-direction: column;
}

#chatInterface.show {
    display: flex !important;
}

.chat-header {
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    background: #f8f9fa;
    border-radius: 8px 8px 0 0;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
}

.chat-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: #2196f3;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 18px;
}

.chat-user-info h4 {
    margin: 0 0 4px 0;
    font-size: 16px;
    color: #333;
}

.chat-user-info p {
    margin: 0;
    font-size: 13px;
    color: #666;
}

.chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
    max-height: calc(100vh - 400px);
    min-height: 300px;
}

.message {
    display: flex;
    gap: 10px;
    max-width: 70%;
}

.message.user {
    align-self: flex-start;
}

.message.agent {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 12px;
    color: white;
    flex-shrink: 0;
}

.message.user .message-avatar {
    background: #4caf50;
}

.message.agent .message-avatar {
    background: #2196f3;
}

.message-content {
    flex: 1;
}

.message-bubble {
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
    word-break: break-word;
    max-width: 100%;
    overflow-wrap: break-word;
    white-space: pre-wrap;
}

.message.user .message-bubble {
    background: #e3f2fd;
    color: #1976d2;
}

.message.agent .message-bubble {
    background: #f5f5f5;
    color: #333;
}

.message-time {
    font-size: 11px;
    color: #999;
    margin-top: 4px;
    text-align: left;
}

.message.agent .message-time {
    text-align: right;
}

.chat-input {
    padding: 20px;
    border-top: 1px solid #e9ecef;
    background: #f8f9fa;
    border-radius: 0 0 8px 8px;
    flex-shrink: 0;
}

.input-group {
    display: flex;
    gap: 10px;
}

.form-control {
    flex: 1;
    border-radius: 20px;
    border: 1px solid #ddd;
    padding: 10px 16px;
}

.btn-send {
    background: #2196f3;
    color: white;
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s ease;
}

.btn-send:hover:not(:disabled) {
    background: #1976d2;
}

.btn-send:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #666;
    text-align: center;
}

.empty-state i {
    font-size: 48px;
    margin-bottom: 16px;
    color: #ddd;
}

.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.spinner {
    width: 32px;
    height: 32px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #2196f3;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.online-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #4caf50;
    font-size: 14px;
}

.online-dot {
    width: 8px;
    height: 8px;
    background: #4caf50;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.no-messages {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.stats-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-item {
    text-align: center;
    padding: 25px 20px;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 12px;
    border: 1px solid #e9ecef;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #2196f3, #21cbf3);
}

.stat-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.stat-item:nth-child(1)::before {
    background: linear-gradient(90deg, #2196f3, #21cbf3);
}

.stat-item:nth-child(2)::before {
    background: linear-gradient(90deg, #4caf50, #8bc34a);
}

.stat-item:nth-child(3)::before {
    background: linear-gradient(90deg, #ff9800, #ffc107);
}

.stat-item:nth-child(4)::before {
    background: linear-gradient(90deg, #9c27b0, #e91e63);
}

.stat-number {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #2196f3, #21cbf3);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1.2;
}

.stat-item:nth-child(1) .stat-number {
    background: linear-gradient(135deg, #2196f3, #21cbf3);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stat-item:nth-child(2) .stat-number {
    background: linear-gradient(135deg, #4caf50, #8bc34a);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stat-item:nth-child(3) .stat-number {
    background: linear-gradient(135deg, #ff9800, #ffc107);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stat-item:nth-child(4) .stat-number {
    background: linear-gradient(135deg, #9c27b0, #e91e63);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stat-icon {
    font-size: 24px;
    margin-bottom: 15px;
    opacity: 0.7;
}

.stat-item:nth-child(1) .stat-icon {
    color: #2196f3;
}

.stat-item:nth-child(2) .stat-icon {
    color: #4caf50;
}

.stat-item:nth-child(3) .stat-icon {
    color: #ff9800;
}

.stat-item:nth-child(4) .stat-icon {
    color: #9c27b0;
}

.stat-label {
    color: #666;
    font-size: 14px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-comments me-2"></i>Quản Lý Tin Nhắn Khách Hàng</h2>
    <div class="online-indicator">
        <div class="online-dot"></div>
        <span>Đang hoạt động</span>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-item">
        <div class="stat-icon">
            <i class="fas fa-comments"></i>
        </div>
        <div class="stat-number" id="totalMessages">-</div>
        <div class="stat-label">Tổng tin nhắn</div>
    </div>
    <div class="stat-item">
        <div class="stat-icon">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-number" id="totalConversations">-</div>
        <div class="stat-label">Cuộc trò chuyện</div>
    </div>
    <div class="stat-item">
        <div class="stat-icon">
            <i class="fas fa-bell"></i>
        </div>
        <div class="stat-number" id="unreadMessages">-</div>
        <div class="stat-label">Chưa đọc</div>
    </div>
    <div class="stat-item">
        <div class="stat-icon">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-number" id="responseTime">-</div>
        <div class="stat-label">Thời gian phản hồi TB</div>
    </div>
</div>

<div class="messages-container">
    <div class="conversations-panel">
        <div class="conversations-header">
            <h3 class="conversations-title mb-0">Cuộc trò chuyện</h3>
        </div>
        <div class="conversations-list" id="conversationsList">
            <div class="loading-spinner">
                <div class="spinner"></div>
            </div>
        </div>
    </div>
    
    <div class="chat-panel">
        <div id="emptyChatState" class="empty-state">
            <i class="fas fa-comments"></i>
            <h4>Chọn cuộc trò chuyện</h4>
            <p>Chọn một cuộc trò chuyện từ danh sách bên trái để bắt đầu.</p>
        </div>
        
        <div id="chatInterface">
            <div class="chat-header">
                <div class="chat-avatar" id="chatAvatar">K</div>
                <div class="chat-user-info">
                    <h4 id="chatUserName">Khách hàng</h4>
                    <p id="chatUserInfo">Thông tin khách hàng</p>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be loaded here -->
            </div>
            
            <div class="chat-input">
                <div class="input-group">
                    <input type="text" class="form-control" id="messageInput" placeholder="Nhập tin nhắn...">
                    <button class="btn-send" id="sendButton" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let currentConversation = null;
let conversations = [];
let messages = [];
let db = null;
let messagesListener = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeFirebase();
    loadStats();
    
    // Add event listeners
    document.getElementById('sendButton').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
});

// Initialize Firebase
function initializeFirebase() {
    if (typeof firebase !== 'undefined') {
        const firebaseConfig = {
            apiKey: "AIzaSyBl_8N53eSIGEbBN2TBSGW36vabMdq2lbI",
            authDomain: "buddyskincare-ec603.firebaseapp.com",
            projectId: "buddyskincare-ec603",
            storageBucket: "buddyskincare-ec603.firebasestorage.app",
            messagingSenderId: "151445800213",
            appId: "1:151445800213:web:62dafa29093235e913151c",
            measurementId: "G-5PLJ2MQ9PW"
        };
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase initialized successfully.");
            startConversationsListener();
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }
    } else {
        console.error('Firebase SDK is not loaded correctly. Please check your script tags.');
    }
}

// Load statistics
async function loadStats() {
    try {
        if (!db) {
            console.log('Firebase not initialized yet, will retry...');
            setTimeout(loadStats, 1000);
            return;
        }
        
        // Get all chats to calculate stats
        const chatsSnapshot = await db.collection('chats').get();
        let totalMessages = 0;
        let totalConversations = chatsSnapshot.size;
        let unreadMessages = 0;
        let responseTimes = [];
        
        // Process each chat
        for (const chatDoc of chatsSnapshot.docs) {
            const chatData = chatDoc.data();
            
            // Count messages in this chat
            const messagesSnapshot = await db.collection('chats').doc(chatDoc.id)
                .collection('messages').get();
            totalMessages += messagesSnapshot.size;
            
            // Check for unread messages (latest message from customer and not read by admin)
            const hasUnreadMessage = chatData.latestMessage && chatData.latestMessage.senderId !== 'admin_001';
            const isReadByAdmin = chatData.isReadByAdmin || false;
            if (hasUnreadMessage && !isReadByAdmin) {
                unreadMessages++;
            }
            
            // Calculate response time (simplified - time between customer and admin messages)
            if (messagesSnapshot.size > 1) {
                const messages = messagesSnapshot.docs.map(doc => ({
                    ...doc.data(),
                    timestamp: doc.data().timestamp.toDate()
                })).sort((a, b) => a.timestamp - b.timestamp);
                
                for (let i = 0; i < messages.length - 1; i++) {
                    if (messages[i].senderId !== 'admin_001' && messages[i + 1].senderId === 'admin_001') {
                        const responseTime = messages[i + 1].timestamp - messages[i].timestamp;
                        responseTimes.push(responseTime);
                    }
                }
            }
        }
        
        // Calculate average response time
        let avgResponseTime = 'N/A';
        if (responseTimes.length > 0) {
            const avgMs = responseTimes.reduce((sum, time) => sum + time, 0) / responseTimes.length;
            const avgHours = avgMs / (1000 * 60 * 60);
            if (avgHours < 1) {
                avgResponseTime = `${Math.round(avgMs / (1000 * 60))} phút`;
            } else {
                avgResponseTime = `${avgHours.toFixed(1)} giờ`;
            }
        }
        
        // Update UI
        document.getElementById('totalMessages').textContent = totalMessages.toLocaleString();
        document.getElementById('totalConversations').textContent = totalConversations.toLocaleString();
        document.getElementById('unreadMessages').textContent = unreadMessages.toLocaleString();
        document.getElementById('responseTime').textContent = avgResponseTime;
        
    } catch (error) {
        console.error('Error loading stats:', error);
        // Fallback to default values
        document.getElementById('totalMessages').textContent = '0';
        document.getElementById('totalConversations').textContent = '0';
        document.getElementById('unreadMessages').textContent = '0';
        document.getElementById('responseTime').textContent = 'N/A';
    }
}

// Start conversations listener
function startConversationsListener() {
    if (!db) {
        console.error('Firebase not initialized');
        return;
    }
    
    db.collection('chats').onSnapshot(snapshot => {
        conversations = [];
        snapshot.forEach(doc => {
            const chatData = doc.data();
            const chatId = doc.id;
            const userId = chatId.split('_').find(id => id !== 'admin_001');
            
            // Check if conversation is unread
            const hasUnreadMessage = chatData.latestMessage && chatData.latestMessage.senderId !== 'admin_001';
            const isReadByAdmin = chatData.isReadByAdmin || false;
            const unread = hasUnreadMessage && !isReadByAdmin;
            
            conversations.push({
                id: chatId,
                userId: userId,
                customerName: `Người dùng ${userId}`,
                customerPhone: userId,
                latestMessage: chatData.latestMessage,
                lastMessage: chatData.latestMessage ? chatData.latestMessage.text : 'Chưa có tin nhắn',
                lastMessageTime: chatData.latestMessage ? chatData.latestMessage.timestamp.toDate().toISOString() : new Date().toISOString(),
                unreadCount: unread ? 1 : 0,
                isFromCustomer: chatData.latestMessage ? chatData.latestMessage.senderId !== 'admin_001' : true
            });
        });
        
        renderConversations();
        
        // Update stats when conversations change
        loadStats();
        
        // Re-select the current conversation if it exists
        if (currentConversation) {
            const activeItem = document.querySelector(`[data-conversation-id="${currentConversation.id}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }
    }, error => {
        console.error('Error listening to conversations:', error);
        document.getElementById('conversationsList').innerHTML = 
            '<div class="no-messages">Lỗi khi tải cuộc trò chuyện. Vui lòng kiểm tra lại cấu trúc dữ liệu hoặc quy tắc bảo mật của Firebase.</div>';
    });
}

// Render conversations list
function renderConversations() {
    const container = document.getElementById('conversationsList');
    
    if (conversations.length === 0) {
        container.innerHTML = '<div class="no-messages">Chưa có cuộc trò chuyện nào</div>';
        return;
    }
    
    const conversationsHTML = conversations.map(conv => {
        const timeAgo = getTimeAgo(new Date(conv.lastMessageTime));
        const preview = conv.lastMessage || 'Tin nhắn trống';
        
        return `
            <div class="conversation-item" data-conversation-id="${conv.id}" onclick="selectConversation('${conv.id}')">
                <div class="conversation-avatar">${conv.customerName.charAt(0).toUpperCase()}</div>
                <div class="conversation-info">
                    <h4 class="conversation-name">${conv.customerName}</h4>
                    <p class="conversation-preview">${conv.isFromCustomer ? '' : 'Bạn: '}${preview}</p>
                    <p class="conversation-time">${timeAgo}</p>
                </div>
                ${conv.unreadCount > 0 ? `<div class="unread-badge">${conv.unreadCount}</div>` : ''}
            </div>
        `;
    }).join('');
    
    container.innerHTML = conversationsHTML;
}

// Select conversation
function selectConversation(conversationId) {
    currentConversation = conversations.find(c => c.id === conversationId);
    if (!currentConversation) return;
    
    // Update UI
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-conversation-id="${conversationId}"]`).classList.add('active');
    
    // Show chat interface
    document.getElementById('emptyChatState').style.display = 'none';
    document.getElementById('chatInterface').classList.add('show');
    
    // Update chat header
    document.getElementById('chatAvatar').textContent = currentConversation.customerName.charAt(0).toUpperCase();
    document.getElementById('chatUserName').textContent = currentConversation.customerName;
    document.getElementById('chatUserInfo').textContent = `SĐT: ${currentConversation.customerPhone}`;
    
    // Start messages listener
    startMessagesListener(conversationId);
    
    // Enable send button
    document.getElementById('sendButton').disabled = false;
    
    // Remove unread badge and mark as read
    const unreadBadge = document.querySelector(`[data-conversation-id="${conversationId}"] .unread-badge`);
    if (unreadBadge) {
        unreadBadge.remove();
    }
    
    // Mark conversation as read in Firebase
    markConversationAsRead(conversationId);
}

// Mark conversation as read
async function markConversationAsRead(conversationId) {
    try {
        if (!db) return;
        
        // Update the chat document to mark as read
        await db.collection('chats').doc(conversationId).update({
            lastReadByAdmin: firebase.firestore.FieldValue.serverTimestamp(),
            isReadByAdmin: true
        });
        
        console.log('Conversation marked as read:', conversationId);
        
    } catch (error) {
        console.error('Error marking conversation as read:', error);
    }
}

// Start real-time listener for messages
function startMessagesListener(conversationId) {
    if (messagesListener) {
        messagesListener(); // Unsubscribe from the previous listener
    }
    
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
    
    messagesListener = db.collection('chats').doc(conversationId)
        .collection('messages')
        .orderBy('timestamp', 'asc')
        .onSnapshot(snapshot => {
            const messages = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                timestamp: doc.data().timestamp.toDate().toISOString(),
                isFromCustomer: doc.data().senderId !== 'admin_001'
            }));
            
            renderMessages(messages);
        }, error => {
            console.error('Error listening to messages:', error);
            chatMessages.innerHTML = '<div class="no-messages">Lỗi khi tải tin nhắn. Vui lòng kiểm tra lại cấu trúc dữ liệu hoặc quy tắc bảo mật của Firebase.</div>';
        });
}

// Render messages
function renderMessages(messages) {
    const chatMessages = document.getElementById('chatMessages');
    
    if (messages.length === 0) {
        chatMessages.innerHTML = '<div class="no-messages">Chưa có tin nhắn nào</div>';
        return;
    }
    
    const messagesHTML = messages.map(message => {
        const time = new Date(message.timestamp).toLocaleTimeString('vi-VN', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const messageClass = message.isFromCustomer ? 'user' : 'agent';
        const avatar = message.isFromCustomer ? 'K' : 'A';
        
        return `
            <div class="message ${messageClass}">
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-bubble">${message.text}</div>
                    <div class="message-time">${time}</div>
                </div>
            </div>
        `;
    }).join('');
    
    chatMessages.innerHTML = messagesHTML;
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Send message
async function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const messageText = messageInput.value.trim();
    
    if (!messageText || !currentConversation || !db) return;
    
    try {
        // Clear input immediately
        messageInput.value = '';
        
        // Send message to Firebase
        await db.collection('chats').doc(currentConversation.id)
            .collection('messages')
            .add({
                text: messageText,
                senderId: 'admin_001',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        
        // Update latest message in chat document
        await db.collection('chats').doc(currentConversation.id)
            .update({
                latestMessage: {
                    text: messageText,
                    senderId: 'admin_001',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }
            });
        
        console.log('Message sent successfully to Firebase');
        
    } catch (error) {
        console.error('Error sending message:', error);
        alert('Lỗi khi gửi tin nhắn: ' + error.message);
        
        // Restore input text on error
        messageInput.value = messageText;
    }
}

// Utility function to get time ago
function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffSecs = Math.floor(diffMs / 1000);
    const diffMins = Math.floor(diffSecs / 60);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffSecs < 60) {
        return 'Vừa xong';
    } else if (diffMins < 60) {
        return `${diffMins} phút trước`;
    } else if (diffHours < 24) {
        return `${diffHours} giờ trước`;
    } else if (diffDays < 7) {
        return `${diffDays} ngày trước`;
    } else {
        return date.toLocaleDateString('vi-VN');
    }
}

// Firebase real-time listeners handle auto-refresh
</script>
{% endblock %}
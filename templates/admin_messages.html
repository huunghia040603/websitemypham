{% extends "admin_base.html" %}

{% block title %}Quản Lý Tin Nhắn - Admin{% endblock %}

{% block extra_css %}
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
    .messages-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .messages-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .messages-title {
        font-size: 28px;
        font-weight: 700;
        color: #2c3e50;
        margin: 0;
    }
    
    .online-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 20px;
        color: #155724;
        font-size: 14px;
        font-weight: 500;
    }
    
    .online-dot {
        width: 8px;
        height: 8px;
        background: #28a745;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .messages-layout {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 20px;
        height: calc(100vh - 200px);
    }
    
    .conversations-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .conversations-header {
        background: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .conversations-title {
        font-size: 16px;
        font-weight: 600;
        color: #495057;
        margin: 0;
    }
    
    .conversations-list {
        max-height: calc(100vh - 300px);
        overflow-y: auto;
    }
    
    .conversation-item {
        padding: 15px 20px;
        border-bottom: 1px solid #f1f3f4;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .conversation-item:hover {
        background: #f8f9fa;
    }
    
    .conversation-item.active {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
    }
    
    .conversation-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #6c757d;
        font-size: 14px;
    }
    
    .conversation-info {
        flex: 1;
        min-width: 0;
    }
    
    .conversation-name {
        font-weight: 600;
        color: #2c3e50;
        margin: 0 0 4px 0;
        font-size: 14px;
    }
    
    .conversation-preview {
        color: #6c757d;
        font-size: 12px;
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .conversation-time {
        font-size: 11px;
        color: #adb5bd;
        margin-top: 4px;
    }
    
    .unread-badge {
        background: #dc3545;
        color: white;
        border-radius: 10px;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: 600;
        min-width: 18px;
        text-align: center;
    }
    
    .chat-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .chat-header {
        background: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .chat-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #6c757d;
        font-size: 14px;
    }
    
    .chat-user-info h4 {
        margin: 0;
        font-size: 16px;
        color: #2c3e50;
        font-weight: 600;
    }
    
    .chat-user-info p {
        margin: 0;
        font-size: 12px;
        color: #6c757d;
    }
    
    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #fafafa;
        max-height: calc(100vh - 400px);
    }
    
    .message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }
    
    .message.user {
        flex-direction: row-reverse;
    }
    
    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #6c757d;
        font-size: 12px;
        flex-shrink: 0;
    }
    
    .message-content {
        max-width: 70%;
    }
    
    .message-bubble {
        padding: 10px 15px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.4;
        word-wrap: break-word;
    }
    
    .message.user .message-bubble {
        background: #007bff;
        color: white;
        border-bottom-right-radius: 4px;
    }
    
    .message.agent .message-bubble {
        background: white;
        color: #2c3e50;
        border: 1px solid #e9ecef;
        border-bottom-left-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .message-time {
        font-size: 11px;
        color: #adb5bd;
        margin-top: 4px;
        text-align: right;
    }
    
    .message.user .message-time {
        text-align: left;
    }
    
    .chat-input-area {
        padding: 15px 20px;
        background: white;
        border-top: 1px solid #e9ecef;
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }
    
    .chat-input {
        flex: 1;
        border: 1px solid #e9ecef;
        border-radius: 20px;
        padding: 10px 15px;
        font-size: 14px;
        resize: none;
        min-height: 40px;
        max-height: 100px;
        outline: none;
        transition: border-color 0.2s ease;
    }
    
    .chat-input:focus {
        border-color: #007bff;
    }
    
    .send-button {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        background: #007bff;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 16px;
    }
    
    .send-button:hover {
        background: #0056b3;
        transform: scale(1.05);
    }
    
    .send-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }
    
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #6c757d;
        text-align: center;
        padding: 40px;
    }
    
    .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    
    .empty-state h3 {
        margin: 0 0 8px 0;
        font-size: 18px;
        color: #495057;
    }
    
    .empty-state p {
        margin: 0;
        font-size: 14px;
    }
    
    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .messages-layout {
            grid-template-columns: 1fr;
            height: auto;
        }
        
        .conversations-panel {
            order: 2;
            max-height: 300px;
        }
        
        .chat-panel {
            order: 1;
            min-height: 500px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="messages-container">
    <div class="messages-header">
        <h1 class="messages-title">Quản Lý Tin Nhắn</h1>
        <div class="online-indicator">
            <div class="online-dot"></div>
            <span>Đang hoạt động</span>
        </div>
    </div>
    
    <div class="messages-layout">
        <div class="conversations-panel">
            <div class="conversations-header">
                <h3 class="conversations-title">Cuộc trò chuyện</h3>
            </div>
            <div class="conversations-list" id="conversationsList">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <div class="chat-panel">
            <div id="emptyChatState" class="empty-state">
                <i class="fas fa-comments"></i>
                <h3>Chọn cuộc trò chuyện</h3>
                <p>Chọn một cuộc trò chuyện từ danh sách bên trái để bắt đầu trả lời tin nhắn</p>
            </div>
            
            <div id="chatInterface" style="display: none;">
                <div class="chat-header">
                    <div class="chat-avatar" id="chatAvatar">U</div>
                    <div class="chat-user-info">
                        <h4 id="chatUserName">Tên người dùng</h4>
                        <p id="chatUserInfo">Thông tin người dùng</p>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    </div>
                
                <div class="chat-input-area">
                    <textarea 
                        id="messageInput" 
                        class="chat-input" 
                        placeholder="Nhập tin nhắn trả lời..."
                        rows="1"
                    ></textarea>
                    <button id="sendButton" class="send-button" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let currentConversation = null;
let conversations = [];
let db = null;
let messagesListener = null;

// Initialize Firebase
function initializeFirebase() {
    if (typeof firebase !== 'undefined') {
        const firebaseConfig = {
            apiKey: "AIzaSyBl_8N53eSIGEbBN2TBSGW36vabMdq2lbI",
            authDomain: "buddyskincare-ec603.firebaseapp.com",
            projectId: "buddyskincare-ec603",
            storageBucket: "buddyskincare-ec603.firebasestorage.app",
            messagingSenderId: "151445800213",
            appId: "1:151445800213:web:62dafa29093235e913151c",
            measurementId: "G-5PLJ2MQ9PW"
        };
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase initialized successfully.");
            startConversationsListener();
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }
    } else {
        console.error('Firebase SDK is not loaded correctly. Please check your script tags.');
    }
}

// Start real-time listener for conversations
function startConversationsListener() {
    const conversationsList = document.getElementById('conversationsList');
    conversationsList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
    
    // Listen for changes in the 'chats' collection
    db.collection('chats').orderBy('latestMessage.timestamp', 'desc').onSnapshot(snapshot => {
        conversations = [];
        if (snapshot.empty) {
            conversationsList.innerHTML = '<div class="empty-state"><p>Chưa có cuộc trò chuyện nào</p></div>';
            return;
        }

        snapshot.docs.forEach(doc => {
            const chatData = doc.data();
            const chatId = doc.id;
            const userId = chatId.split('_').find(id => id !== 'admin_001');

            const unread = chatData.latestMessage.senderId !== 'admin_001';

            conversations.push({
                id: chatId,
                userId: userId,
                latestMessage: chatData.latestMessage,
                unread: unread
            });
        });
        
        renderConversations();
        
        // Re-select the current conversation if it exists
        if (currentConversation) {
            const activeItem = document.querySelector(`[data-conversation-id="${currentConversation.id}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }
    }, error => {
        console.error('Error listening to conversations:', error);
        conversationsList.innerHTML = '<div class="empty-state"><p>Lỗi khi tải cuộc trò chuyện. Vui lòng kiểm tra lại cấu trúc dữ liệu hoặc quy tắc bảo mật của Firebase.</p></div>';
    });
}

// Render conversations list
function renderConversations() {
    const conversationsList = document.getElementById('conversationsList');
    
    if (conversations.length === 0) {
        conversationsList.innerHTML = '<div class="empty-state"><p>Chưa có cuộc trò chuyện nào</p></div>';
        return;
    }
    
    const conversationsHTML = conversations.map(conv => {
        const timeAgo = getTimeAgo(conv.latestMessage.timestamp.seconds);
        const preview = conv.latestMessage.text || 'Tin nhắn trống';
        
        return `
            <div class="conversation-item" data-conversation-id="${conv.id}" data-user-id="${conv.userId}">
                <div class="conversation-avatar">${conv.userId.charAt(0).toUpperCase()}</div>
                <div class="conversation-info">
                    <h4 class="conversation-name">Người dùng ${conv.userId}</h4>
                    <p class="conversation-preview">${conv.latestMessage.senderId === 'admin_001' ? 'Bạn: ' : ''}${preview}</p>
                    <p class="conversation-time">${timeAgo}</p>
                </div>
                ${conv.unread ? '<div class="unread-badge">1</div>' : ''}
            </div>
        `;
    }).join('');
    
    conversationsList.innerHTML = conversationsHTML;
    
    // Add click event listeners
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.addEventListener('click', () => {
            const conversationId = item.dataset.conversationId;
            const userId = item.dataset.userId;
            selectConversation(conversationId, userId);
        });
    });
}

// Select conversation
function selectConversation(conversationId, userId) {
    if (messagesListener) {
        messagesListener(); // Unsubscribe from the previous listener
    }
    
    currentConversation = { id: conversationId, userId: userId };
    
    // Update UI
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-conversation-id="${conversationId}"]`).classList.add('active');
    
    // Remove unread badge
    const unreadBadge = document.querySelector(`[data-conversation-id="${conversationId}"] .unread-badge`);
    if (unreadBadge) {
        unreadBadge.remove();
    }
    
    // Show chat interface
    document.getElementById('emptyChatState').style.display = 'none';
    document.getElementById('chatInterface').style.display = 'flex';
    
    // Update chat header
    document.getElementById('chatAvatar').textContent = userId.charAt(0).toUpperCase();
    document.getElementById('chatUserName').textContent = `Người dùng ${userId}`;
    document.getElementById('chatUserInfo').textContent = `ID: ${userId}`;
    
    // Start messages listener
    startMessagesListener(conversationId);
    
    // Enable send button
    document.getElementById('sendButton').disabled = false;
}

// Start real-time listener for messages
function startMessagesListener(conversationId) {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
    
    messagesListener = db.collection('chats').doc(conversationId)
        .collection('messages')
        .orderBy('timestamp', 'asc')
        .onSnapshot(snapshot => {
            const messages = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            renderMessages(messages);
        }, error => {
            console.error('Error listening to messages:', error);
            chatMessages.innerHTML = '<div class="empty-state"><p>Lỗi khi tải tin nhắn. Vui lòng kiểm tra lại cấu trúc dữ liệu hoặc quy tắc bảo mật của Firebase.</p></div>';
        });
}

// Render messages
function renderMessages(messages) {
    const chatMessages = document.getElementById('chatMessages');
    
    if (messages.length === 0) {
        chatMessages.innerHTML = '<div class="empty-state"><p>Chưa có tin nhắn nào</p></div>';
        return;
    }
    
    const messagesHTML = messages.map(message => {
        const isFromUser = message.senderId !== 'admin_001';
        const time = new Date(message.timestamp.seconds * 1000).toLocaleTimeString('vi-VN', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        return `
            <div class="message ${isFromUser ? 'user' : 'agent'}">
                <div class="message-avatar">${isFromUser ? 'U' : 'A'}</div>
                <div class="message-content">
                    <div class="message-bubble">${escapeHtml(message.text)}</div>
                    <div class="message-time">${time}</div>
                </div>
            </div>
        `;
    }).join('');
    
    chatMessages.innerHTML = messagesHTML;
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Send message
async function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const text = messageInput.value.trim();
    
    if (!text || !currentConversation) return;
    
    try {
        const messageData = {
            text: text,
            senderId: 'admin_001',
            receiverId: currentConversation.userId,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('chats').doc(currentConversation.id)
            .collection('messages')
            .add(messageData);
        
        // Update the latest message field on the parent chat document
        await db.collection('chats').doc(currentConversation.id).update({
            latestMessage: messageData
        });
        
        messageInput.value = '';
        autoResize(messageInput);
        
    } catch (error) {
        console.error('Error sending message:', error);
        alert('Lỗi khi gửi tin nhắn');
    }
}

// Utility functions
function getTimeAgo(timestamp) {
    const now = Date.now() / 1000;
    const diff = now - timestamp;
    
    if (diff < 60) return 'Vừa xong';
    if (diff < 3600) return `${Math.floor(diff / 60)} phút trước`;
    if (diff < 86400) return `${Math.floor(diff / 3600)} giờ trước`;
    return `${Math.floor(diff / 86400)} ngày trước`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Auto-resize textarea
function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    initializeFirebase();
    
    // Message input events
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    
    messageInput.addEventListener('input', function() {
        autoResize(this);
        sendButton.disabled = !this.value.trim();
    });
    
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    sendButton.addEventListener('click', sendMessage);
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Sản Phẩm - BuddySkincare{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="page-header bg-light py-5">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Trang chủ</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Sản phẩm</li>
                    </ol>
                </nav>
                <h1 class="fw-bold mt-3">{% if page_title %}{{ page_title }}{% else %}Tất Cả Sản Phẩm{% endif %}</h1>
                <p class="text-muted">
                    {% if current_condition == 'Mới 100%' %}
                        Sản phẩm mới 100% chính hãng, đảm bảo chất lượng
                    {% elif current_condition == 'Đã sử dụng' %}
                        Sản phẩm đã sử dụng với giá tốt, tiết kiệm 50-80%
                    {% else %}
                        Khám phá bộ sưu tập mỹ phẩm thanh lý chất lượng cao
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</section>

<!-- Filters and Products -->
<section class="products-section py-5">
    <div class="container">
        <div class="row">
            <!-- Sidebar Filters -->
            <div class="col-lg-3">
                <div class="filters-sidebar">
                    <h5 class="fw-bold mb-4">Bộ Lọc</h5>
                    <!-- Brand Filter -->
                    <div class="filter-group mb-4">
                        <h6 class="fw-semibold mb-3">Thương Hiệu</h6>
                        <div id="filterBrands" class="d-flex flex-column gap-2" style="max-height: 280px; overflow:auto;"></div>
                    </div>
                    
                    <!-- Tags Filter -->
                    <div class="filter-group mb-4">
                        <h6 class="fw-semibold mb-3">Tags</h6>
                        <div id="filterTags" class="d-flex flex-column gap-2" style="max-height: 200px; overflow:auto;"></div>
                    </div>
                
                   
                    <!-- Price Filter -->
                    <div class="filter-group mb-4">
                        <h6 class="fw-semibold mb-3">Khoảng Giá</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="price_range" id="pr_under_200" value="under_200k">
                            <label class="form-check-label" for="pr_under_200">Dưới 200.000đ</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="price_range" id="pr_200_500" value="200_500">
                            <label class="form-check-label" for="pr_200_500">200.000đ - 500.000đ</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="price_range" id="pr_500_1m" value="500_1m">
                            <label class="form-check-label" for="pr_500_1m">500.000đ - 1.000.000đ</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="price_range" id="pr_over_1m" value="over_1m">
                            <label class="form-check-label" for="pr_over_1m">Trên 1.000.000đ</label>
                        </div>
                    </div>

                    
                    
                    <!-- Condition Filter -->
                    <div class="filter-group mb-4">
                        <h6 class="fw-semibold mb-3">Tình Trạng Sản Phẩm</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="condition" id="condition_all" value="all" {% if current_condition == 'all' %}checked{% endif %}>
                            <label class="form-check-label" for="condition_all">
                                <i class="fas fa-th-large text-primary"></i> Tất cả sản phẩm
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="condition" id="condition_new" value="new" {% if current_condition == 'new' %}checked{% endif %}>
                            <label class="form-check-label" for="condition_new">
                                <i class="fas fa-tag text-success"></i> Sản phẩm mới 100%
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="condition" id="condition_used" value="used" {% if current_condition == 'used' %}checked{% endif %}>
                            <label class="form-check-label" for="condition_used">
                                <i class="fas fa-recycle text-warning"></i> Sản phẩm đã sử dụng
                            </label>
                        </div>
                    </div>
                    
                    <!-- Discount Filter -->
                    <div class="filter-group mb-4">
                        <h6 class="fw-semibold mb-3">Giảm Giá</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="discount_range" id="dis_under_30" value="under_30">
                            <label class="form-check-label" for="dis_under_30">Dưới 30%</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="discount_range" id="dis_50_70" value="50_70">
                            <label class="form-check-label" for="dis_50_70">50% - 70%</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="discount_range" id="dis_over_70" value="over_70">
                            <label class="form-check-label" for="dis_over_70">Trên 70%</label>
                        </div>
                    </div>

                    <!-- Category Filter -->
                    <div class="filter-group mb-4">
                        <h6 class="fw-semibold mb-3">Danh Mục</h6>
                        <div id="filterCategories" class="d-flex flex-column gap-2" style="max-height: 280px; overflow:auto;"></div>
                    </div>
                    
                    <!-- Clear Filters -->
                    <a class="btn btn-outline-secondary w-100" href="/products">Xóa Bộ Lọc</a>
                </div>
            </div>
            
            <!-- Products Grid -->
            <div class="col-lg-9">
                <!-- Sort and View Options -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex align-items-center">
                        <span class="me-3">Hiển thị:</span>
                        <select class="form-select form-select-sm" style="width: auto;">
                            <option>12 sản phẩm</option>
                            <option>24 sản phẩm</option>
                            <option>48 sản phẩm</option>
                        </select>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="me-3">Sắp xếp:</span>
                        <select id="products-sort" class="form-select form-select-sm" style="width: auto;">
                            <option value="newest" selected>Mới nhất</option>
                            <option value="price_asc">Giá thấp đến cao</option>
                            <option value="price_desc">Giá cao đến thấp</option>
                            <option value="sales">Bán chạy nhất</option>
                            <option value="discount">Giảm giá nhiều nhất</option>
                        </select>
                    </div>
                </div>
                
                <!-- Products Grid -->
                <div id="products-page-grid" class="row g-4"></div>
                
                <!-- Pagination -->
                <nav aria-label="Product pagination" class="mt-5">
                    <ul class="pagination justify-content-center">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">Trước</a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#">Sau</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</section>
{% endblock %}
{% block extra_js %}
<script>
(function(){
    const params = new URLSearchParams(window.location.search);
    // Preselect price and discount
    const pr = params.get('price_range') || params.get('price');
    if (pr) {
        const el = document.querySelector(`input[name="price_range"][value="${pr}"]`);
        if (el) el.checked = true;
    }
    const dr = params.get('discount_range') || params.get('discount');
    if (dr) {
        const el = document.querySelector(`input[name="discount_range"][value="${dr}"]`);
        if (el) el.checked = true;
    }
    const cond = params.get('condition');
    if (cond) {
        const el = document.querySelector(`input[name="condition"][value="${cond}"]`);
        if (el) el.checked = true;
    }

    // Bind change events -> update URL
    function updateParam(key, value) {
        const p = new URLSearchParams(window.location.search);
        if (!value) p.delete(key); else p.set(key, value);
        // Reset to page 1 behavior by removing unrelated pagination params (if any)
        p.delete('page');
        const qs = p.toString();
        window.location.href = `/products${qs ? ('?' + qs) : ''}`;
    }

    document.querySelectorAll('input[name="price_range"]').forEach(r => {
        r.addEventListener('change', () => updateParam('price_range', r.checked ? r.value : ''));
    });
    document.querySelectorAll('input[name="discount_range"]').forEach(r => {
        r.addEventListener('change', () => updateParam('discount_range', r.checked ? r.value : ''));
    });
    document.querySelectorAll('input[name="condition"]').forEach(r => {
        r.addEventListener('change', () => updateParam('condition', r.checked ? r.value : ''));
    });

    // Render dynamic categories, brands, and tags
    const catWrap = document.getElementById('filterCategories');
    const brandWrap = document.getElementById('filterBrands');
    const tagsWrap = document.getElementById('filterTags');
    const selectedCat = params.get('category_name') || '';
    const selectedBrand = params.get('brands_name') || '';
    const selectedTag = params.get('tags') || '';

    function makeFilterLink(label, key, value, isActive) {
        const a = document.createElement('a');
        a.href = '#';
        a.className = `d-flex align-items-center justify-content-between text-decoration-none px-2 py-1 rounded ${isActive ? 'bg-light' : ''}`;
        a.innerHTML = `<span class="text-dark">${label}</span>${isActive ? '<i class="fas fa-check text-primary"></i>' : ''}`;
        a.addEventListener('click', (e) => {
            e.preventDefault();
            const p = new URLSearchParams(window.location.search);
            if (value) p.set(key, value); else p.delete(key);
            p.delete('page');
            window.location.href = `/products?${p.toString()}`;
        });
        return a;
    }

    // Fetch categories - only show categories with products in stock
    Promise.all([
      fetch('https://buddyskincare.pythonanywhere.com/category/').then(r => r.ok ? r.json() : []),
      fetch('https://buddyskincare.pythonanywhere.com/products/').then(r => r.ok ? r.json() : [])
    ])
      .then(([categoriesList, productsList]) => {
        if (!Array.isArray(categoriesList) || !Array.isArray(productsList)) return;
        catWrap.innerHTML = '';
        
        // Get categories that have products with stock > 0
        const categoriesWithStock = new Set();
        productsList.forEach(product => {
          const stockQuantity = typeof product.stock_quantity === 'number' ? product.stock_quantity : 0;
          if (stockQuantity > 0) {
            const categoryName = product.category_name || (product.category && product.category.name) || '';
            if (categoryName) {
              categoriesWithStock.add(categoryName);
            }
          }
        });
        
        categoriesList.forEach(item => {
            const name = item.name || item.title || '';
            if (!name) return;
            // Only show categories that have products in stock
            if (categoriesWithStock.has(name)) {
              catWrap.appendChild(makeFilterLink(name, 'category_name', name, name === selectedCat));
            }
        });
      }).catch(()=>{});

    // Fetch brands - only show brands with products in stock
    Promise.all([
      fetch('https://buddyskincare.pythonanywhere.com/brands/').then(r => r.ok ? r.json() : []),
      fetch('https://buddyskincare.pythonanywhere.com/products/').then(r => r.ok ? r.json() : [])
    ])
      .then(([brandsList, productsList]) => {
        if (!Array.isArray(brandsList) || !Array.isArray(productsList)) return;
        brandWrap.innerHTML = '';
        
        // Get brands that have products with stock > 0
        const brandsWithStock = new Set();
        productsList.forEach(product => {
          const stockQuantity = typeof product.stock_quantity === 'number' ? product.stock_quantity : 0;
          if (stockQuantity > 0) {
            const brandName = product.brand_name || (product.brand && product.brand.name) || '';
            if (brandName) {
              brandsWithStock.add(brandName);
            }
          }
        });
        
        // Sort brands alphabetically by name, only include those with stock
        const sortedBrands = brandsList
          .map(item => ({
            name: item.name || item.title || '',
            item: item
          }))
          .filter(brand => brand.name && brandsWithStock.has(brand.name))
          .sort((a, b) => a.name.localeCompare(b.name, 'vi', { sensitivity: 'base' }));
        
        sortedBrands.forEach(brand => {
            brandWrap.appendChild(makeFilterLink(brand.name, 'brands_name', brand.name, brand.name === selectedBrand));
        });
      }).catch(()=>{});

    // Fetch tags from products - only show tags with products in stock
    fetch('https://buddyskincare.pythonanywhere.com/products/')
      .then(r => r.ok ? r.json() : [])
      .then(products => {
        if (!Array.isArray(products)) return;
        tagsWrap.innerHTML = '';
        
        // Extract all unique tags from products that have stock > 0
        const allTags = new Set();
        products.forEach(product => {
          const stockQuantity = typeof product.stock_quantity === 'number' ? product.stock_quantity : 0;
          if (stockQuantity > 0) {
            const tags = product?.tags || [];
            if (Array.isArray(tags)) {
              tags.forEach(tag => {
                if (typeof tag === 'string' && tag.trim()) {
                  allTags.add(tag.trim());
                } else if (tag && typeof tag === 'object' && tag.name && tag.name.trim()) {
                  allTags.add(tag.name.trim());
                }
              });
            }
          }
        });
        
        // Sort tags alphabetically
        const sortedTags = Array.from(allTags).sort((a, b) => a.localeCompare(b, 'vi', { sensitivity: 'base' }));
        
        sortedTags.forEach(tag => {
            tagsWrap.appendChild(makeFilterLink(tag, 'tags', tag, tag === selectedTag));
        });
      }).catch(()=>{});
})();
</script>
{% endblock %} 
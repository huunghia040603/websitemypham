{% extends "base.html" %}

{% block title %}S·∫£n Ph·∫©m - BuddySkincare{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="page-header bg-light py-5">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Trang ch·ªß</a></li>
                        <li class="breadcrumb-item active" aria-current="page">S·∫£n ph·∫©m</li>
                    </ol>
                </nav>
                <h1 class="fw-bold mt-3">{% if page_title %}{{ page_title }}{% else %}T·∫•t C·∫£ S·∫£n Ph·∫©m{% endif %}</h1>
                <p class="text-muted">
                    {% if current_condition == 'M·ªõi 100%' %}
                        S·∫£n ph·∫©m m·ªõi 100% ch√≠nh h√£ng, ƒë·∫£m b·∫£o ch·∫•t l∆∞·ª£ng
                    {% elif current_condition == 'ƒê√£ s·ª≠ d·ª•ng' %}
                        S·∫£n ph·∫©m ƒë√£ s·ª≠ d·ª•ng v·ªõi gi√° t·ªët, ti·∫øt ki·ªám 50-80%
                    {% else %}
                        Kh√°m ph√° b·ªô s∆∞u t·∫≠p m·ªπ ph·∫©m thanh l√Ω ch·∫•t l∆∞·ª£ng cao
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</section>

<!-- Filters and Products -->
<section class="products-section py-5">
    <div class="container">
        <div class="row">
            <!-- Mobile Filter Button -->
            <div class="col-12 d-lg-none mb-3">
                <button class="btn btn-outline-primary w-100" type="button" data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas" aria-controls="filtersOffcanvas">
                    <i class="fas fa-filter me-2"></i>B·ªô L·ªçc S·∫£n Ph·∫©m
                </button>
            </div>
            
            <!-- Sidebar Filters -->
            <div class="col-lg-3 d-none d-lg-block">
                <div class="filters-sidebar">
                    <h5 class="fw-bold mb-4">B·ªô L·ªçc</h5>
                    <!-- Brand Filter -->
                    <div class="filter-group mb-4">
                        <h6 class="fw-semibold mb-3">Th∆∞∆°ng Hi·ªáu</h6>
                        <div id="filterBrands" class="d-flex flex-column gap-2" style="max-height: 280px; overflow:auto;"></div>
                    </div>
                    
                    <!-- Tags Filter -->
                    <div class="filter-group mb-4">
                        <h6 class="fw-semibold mb-3">Tags</h6>
                        <div id="filterTags" class="d-flex flex-column gap-2" style="max-height: 200px; overflow:auto;"></div>
                    </div>
                
                   
                    <!-- Price Filter -->
                    <div class="filter-group mb-4">
                        <h6 class="fw-semibold mb-3">Kho·∫£ng Gi√°</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="price_range" id="pr_under_200" value="under_200k">
                            <label class="form-check-label" for="pr_under_200">D∆∞·ªõi 200.000ƒë</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="price_range" id="pr_200_500" value="200_500">
                            <label class="form-check-label" for="pr_200_500">200.000ƒë - 500.000ƒë</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="price_range" id="pr_500_1m" value="500_1m">
                            <label class="form-check-label" for="pr_500_1m">500.000ƒë - 1.000.000ƒë</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="price_range" id="pr_over_1m" value="over_1m">
                            <label class="form-check-label" for="pr_over_1m">Tr√™n 1.000.000ƒë</label>
                        </div>
                    </div>

                    
                    
                    <!-- Condition Filter -->
                    <div class="filter-group mb-4">
                        <h6 class="fw-semibold mb-3">T√¨nh Tr·∫°ng S·∫£n Ph·∫©m</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="condition" id="condition_all" value="all" {% if current_condition == 'all' %}checked{% endif %}>
                            <label class="form-check-label" for="condition_all">
                                <i class="fas fa-th-large text-primary"></i> T·∫•t c·∫£ s·∫£n ph·∫©m
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="condition" id="condition_new" value="new" {% if current_condition == 'new' %}checked{% endif %}>
                            <label class="form-check-label" for="condition_new">
                                <i class="fas fa-tag text-success"></i> S·∫£n ph·∫©m m·ªõi 100%
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="condition" id="condition_used" value="used" {% if current_condition == 'used' %}checked{% endif %}>
                            <label class="form-check-label" for="condition_used">
                                <i class="fas fa-recycle text-warning"></i> S·∫£n ph·∫©m ƒë√£ s·ª≠ d·ª•ng
                            </label>
                        </div>
                    </div>
                    
                    <!-- Discount Filter -->
                    <div class="filter-group mb-4">
                        <h6 class="fw-semibold mb-3">Gi·∫£m Gi√°</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="discount_range" id="dis_under_30" value="under_30">
                            <label class="form-check-label" for="dis_under_30">D∆∞·ªõi 30%</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="discount_range" id="dis_50_70" value="50_70">
                            <label class="form-check-label" for="dis_50_70">50% - 70%</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="discount_range" id="dis_over_70" value="over_70">
                            <label class="form-check-label" for="dis_over_70">Tr√™n 70%</label>
                        </div>
                    </div>

                    <!-- Category Filter -->
                    <div class="filter-group mb-4">
                        <h6 class="fw-semibold mb-3">Danh M·ª•c</h6>
                        <div id="filterCategories" class="d-flex flex-column gap-2" style="max-height: 280px; overflow:auto;"></div>
                    </div>
                    
                    <!-- Clear Filters -->
                    <a class="btn btn-outline-secondary w-100" href="/products">X√≥a B·ªô L·ªçc</a>
                </div>
            </div>
            
            <!-- Products Grid -->
            <div class="col-lg-9">
                <!-- Desktop: Search + Per-page + Sort on one row -->
                <div class="d-none d-md-flex align-items-center justify-content-between gap-3 mb-4">
                    <div class="position-relative flex-grow-1" style="max-width: 520px;">
                        <div class="search-pill">
                            <!-- <i class="fas fa-search"></i> -->
                            <input type="text" 
                                   id="products-search" 
                                   class="form-control" 
                                   placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." 
                                   autocomplete="off">
                        </div>
                        <!-- Search suggestions dropdown -->
                        <div id="search-suggestions" class="position-absolute top-100 start-0 w-100 bg-white border rounded shadow-lg" style="z-index: 1000; display: none; max-height: 300px; overflow-y: auto; margin-top: 5px;"></div>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="me-2">Hi·ªÉn th·ªã:</span>
                        <select id="products-per-page" class="form-select form-select-sm" style="width: auto;">
                            <option value="12" selected>12 s·∫£n ph·∫©m</option>
                            <option value="20">20 s·∫£n ph·∫©m</option>
                            <option value="32">32 s·∫£n ph·∫©m</option>
                            <option value="48">48 s·∫£n ph·∫©m</option>
                        </select>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="me-2">S·∫Øp x·∫øp:</span>
                        <select id="products-sort" class="form-select form-select-sm" style="width: auto;">
                            <option value="newest" selected>M·ªõi nh·∫•t</option>
                            <option value="price_asc">Gi√° th·∫•p ƒë·∫øn cao</option>
                            <option value="price_desc">Gi√° cao ƒë·∫øn th·∫•p</option>
                            <option value="sales">B√°n ch·∫°y nh·∫•t</option>
                            <option value="discount">Gi·∫£m gi√° nhi·ªÅu nh·∫•t</option>
                        </select>
                    </div>
                    
                </div>

                <!-- Mobile: search on top, filters on one row -->
                <div class="d-md-none mb-3">
                    <div class="position-relative">
                        <div class="search-pill">
                            <i class="fas fa-search"></i>
                            <input type="text" 
                                   id="products-search" 
                                   class="form-control" 
                                   placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." 
                                   autocomplete="off">
                        </div>
                        <div id="search-suggestions" class="position-absolute top-100 start-0 w-100 bg-white border rounded shadow-lg" style="z-index: 1000; display: none; max-height: 300px; overflow-y: auto; margin-top: 5px;"></div>
                    </div>
                </div>

                <div class="d-flex d-md-none align-items-center w-100">
                    <div class="d-flex d-md-none align-items-center w-100">
                        <div class="d-flex align-items-center me-3">
                            <span class="me-2" style="font-size: 0.85rem;">Hi·ªÉn th·ªã:</span>
                            <select id="products-per-page-mobile" class="form-select form-select-sm" style="width: auto; min-width: 80px;">
                                <option value="12" selected>12</option>
                                <option value="20">20</option>
                                <option value="32">32</option>
                                <option value="48">48</option>
                            </select>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="me-2" style="font-size: 0.85rem;">S·∫Øp x·∫øp:</span>
                            <select id="products-sort-mobile" class="form-select form-select-sm" style="width: auto; min-width: 120px;">
                                <option value="newest" selected>M·ªõi nh·∫•t</option>
                                <option value="price_asc">Gi√° th·∫•p</option>
                                <option value="price_desc">Gi√° cao</option>
                                <option value="sales">B√°n ch·∫°y</option>
                                <option value="discount">Gi·∫£m gi√°</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Products Info -->
                <div id="products-info" class="mb-3">
                    <small class="text-muted">
                        Hi·ªÉn th·ªã <span id="products-showing">0</span> trong <span id="products-total">0</span> s·∫£n ph·∫©m
                    </small>
                </div>
                
                
                
                <!-- Products Grid -->
                <div id="products-page-grid" class="row g-4"></div>
                
                <!-- Pagination -->
                <nav aria-label="Product pagination" class="mt-5">
                    <ul id="products-pagination" class="pagination justify-content-center" style="display: flex !important; flex-direction: row !important; flex-wrap: nowrap !important; justify-content: center !important; align-items: center !important; list-style: none !important; padding: 0 !important; margin: 0 !important; gap: 0.25rem !important;">
                        <!-- Pagination will be generated by JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</section>

<!-- Mobile Filters Offcanvas -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="filtersOffcanvas" aria-labelledby="filtersOffcanvasLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="filtersOffcanvasLabel">
            <i class="fas fa-filter me-2"></i>B·ªô L·ªçc S·∫£n Ph·∫©m
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <!-- Brand Filter -->
        <div class="filter-group mb-4">
            <h6 class="fw-semibold mb-3">Th∆∞∆°ng Hi·ªáu</h6>
            <div id="filterBrandsMobile" class="d-flex flex-column gap-2" style="max-height: 200px; overflow:auto;"></div>
        </div>
        
        <!-- Tags Filter -->
        <div class="filter-group mb-4">
            <h6 class="fw-semibold mb-3">Tags</h6>
            <div id="filterTagsMobile" class="d-flex flex-column gap-2" style="max-height: 150px; overflow:auto;"></div>
        </div>
        
        <!-- Price Filter -->
        <div class="filter-group mb-4">
            <h6 class="fw-semibold mb-3">Kho·∫£ng Gi√°</h6>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="price_range_mobile" id="pr_under_200_mobile" value="under_200k">
                <label class="form-check-label" for="pr_under_200_mobile">D∆∞·ªõi 200.000ƒë</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="price_range_mobile" id="pr_200_500_mobile" value="200_500">
                <label class="form-check-label" for="pr_200_500_mobile">200.000ƒë - 500.000ƒë</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="price_range_mobile" id="pr_500_1m_mobile" value="500_1m">
                <label class="form-check-label" for="pr_500_1m_mobile">500.000ƒë - 1.000.000ƒë</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="price_range_mobile" id="pr_over_1m_mobile" value="over_1m">
                <label class="form-check-label" for="pr_over_1m_mobile">Tr√™n 1.000.000ƒë</label>
            </div>
        </div>
        
        <!-- Condition Filter -->
        <div class="filter-group mb-4">
            <h6 class="fw-semibold mb-3">T√¨nh Tr·∫°ng</h6>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="condition_mobile" id="condition_all_mobile" value="all" {% if current_condition == 'all' %}checked{% endif %}>
                <label class="form-check-label" for="condition_all_mobile">
                    <i class="fas fa-th-large text-primary"></i> T·∫•t c·∫£
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="condition_mobile" id="condition_new_mobile" value="new" {% if current_condition == 'new' %}checked{% endif %}>
                <label class="form-check-label" for="condition_new_mobile">
                    <i class="fas fa-tag text-success"></i> M·ªõi 100%
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="condition_mobile" id="condition_used_mobile" value="used" {% if current_condition == 'used' %}checked{% endif %}>
                <label class="form-check-label" for="condition_used_mobile">
                    <i class="fas fa-recycle text-warning"></i> ƒê√£ s·ª≠ d·ª•ng
                </label>
            </div>
        </div>
        
        <!-- Discount Filter -->
        <div class="filter-group mb-4">
            <h6 class="fw-semibold mb-3">Gi·∫£m Gi√°</h6>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="discount_range_mobile" id="dis_under_30_mobile" value="under_30">
                <label class="form-check-label" for="dis_under_30_mobile">D∆∞·ªõi 30%</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="discount_range_mobile" id="dis_50_70_mobile" value="50_70">
                <label class="form-check-label" for="dis_50_70_mobile">50% - 70%</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="discount_range_mobile" id="dis_over_70_mobile" value="over_70">
                <label class="form-check-label" for="dis_over_70_mobile">Tr√™n 70%</label>
            </div>
        </div>
        
        <!-- Category Filter -->
        <div class="filter-group mb-4">
            <h6 class="fw-semibold mb-3">Danh M·ª•c</h6>
            <div id="filterCategoriesMobile" class="d-flex flex-column gap-2" style="max-height: 200px; overflow:auto;"></div>
        </div>
        
        <!-- Apply Filters Button -->
        <div class="d-grid gap-2 mt-4">
            <button type="button" class="btn btn-primary" id="applyFiltersMobile">
                <i class="fas fa-check me-2"></i>√Åp D·ª•ng B·ªô L·ªçc
            </button>
            <button type="button" class="btn btn-outline-secondary" id="clearFiltersMobile">
                <i class="fas fa-times me-2"></i>X√≥a T·∫•t C·∫£
            </button>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<style>
    .hover-bg-light:hover {
        background-color: #f8f9fa !important;
    }
</style>
<script>
(function(){
    const params = new URLSearchParams(window.location.search);
    // Preselect price and discount
    const pr = params.get('price_range') || params.get('price');
    if (pr) {
        const el = document.querySelector(`input[name="price_range"][value="${pr}"]`);
        if (el) el.checked = true;
    }
    const dr = params.get('discount_range') || params.get('discount');
    if (dr) {
        const el = document.querySelector(`input[name="discount_range"][value="${dr}"]`);
        if (el) el.checked = true;
    }
    const cond = params.get('condition');
    if (cond) {
        const el = document.querySelector(`input[name="condition"][value="${cond}"]`);
        if (el) el.checked = true;
    }

    // Bind change events -> update URL with AJAX
    function updateParam(key, value) {
        const p = new URLSearchParams(window.location.search);
        if (!value) p.delete(key); else p.set(key, value);
        p.delete('page');
        const qs = p.toString();
        
        // Update URL without reloading page
        const newUrl = `/products${qs ? ('?' + qs) : ''}`;
        window.history.pushState({}, '', newUrl);
        
        // Load products with AJAX
        console.log('üîÑ Radio button changed - calling AJAX with params:', qs);
        loadProductsWithAJAX(qs);
    }

    document.querySelectorAll('input[name="price_range"]').forEach(r => {
        r.addEventListener('change', () => {
            const currentValue = params.get('price_range');
            if (r.checked && currentValue === r.value) {
                // If clicking the same value, uncheck it
                r.checked = false;
                updateParam('price_range', '');
            } else {
                updateParam('price_range', r.checked ? r.value : '');
            }
        });
    });
    document.querySelectorAll('input[name="discount_range"]').forEach(r => {
        r.addEventListener('change', () => {
            const currentValue = params.get('discount_range');
            if (r.checked && currentValue === r.value) {
                // If clicking the same value, uncheck it
                r.checked = false;
                updateParam('discount_range', '');
            } else {
                updateParam('discount_range', r.checked ? r.value : '');
            }
        });
    });
    document.querySelectorAll('input[name="condition"]').forEach(r => {
        r.addEventListener('change', () => {
            const currentValue = params.get('condition');
            if (r.checked && currentValue === r.value && r.value !== 'all') {
                // If clicking the same value (except 'all'), uncheck it and set to 'all'
                r.checked = false;
                document.querySelector('input[name="condition"][value="all"]').checked = true;
                updateParam('condition', '');
            } else {
                updateParam('condition', r.checked ? r.value : '');
            }
        });
    });

    // Initialize smart search
    initSmartSearch();
    
    // Render dynamic categories, brands, and tags
    const catWrap = document.getElementById('filterCategories');
    const brandWrap = document.getElementById('filterBrands');
    const tagsWrap = document.getElementById('filterTags');
    let selectedCats = params.getAll('category_name') || [];
    let selectedBrands = params.getAll('brands_name') || [];
    const selectedTag = params.get('tags') || '';

    function makeFilterLink(label, key, value, isActive) {
        const a = document.createElement('a');
        a.href = '#';
        a.className = `d-flex align-items-center justify-content-between text-decoration-none px-2 py-1 rounded ${isActive ? 'bg-primary text-white' : 'hover-bg-light'}`;
        a.innerHTML = `<span class="${isActive ? 'text-white' : 'text-dark'}">${label}</span>${isActive ? '<i class="fas fa-check text-white"></i>' : ''}`;
        a.addEventListener('click', (e) => {
            e.preventDefault();
            const p = new URLSearchParams(window.location.search);
            
            // Special handling for brands_name and category_name - allow multiple selection
            if (key === 'brands_name' || key === 'category_name') {
                const currentValues = p.getAll(key); // Get all current values
                const isCurrentlyActive = currentValues.includes(value); // Check current state from URL
                
                if (isCurrentlyActive) {
                    // Remove this specific value
                    const newValues = currentValues.filter(v => v !== value);
                    p.delete(key); // Remove all
                    newValues.forEach(v => p.append(key, v)); // Add back the remaining ones
                } else {
                    // Add this value to the list
                    if (!currentValues.includes(value)) {
                        p.append(key, value);
                    }
                }
            } else {
                // For other filters (tags), use single selection
                if (isActive) {
                    p.delete(key);
                } else {
                    p.set(key, value);
                }
            }
            
            p.delete('page');
            
            // Update URL without reloading page
            const newUrl = `/products${p.toString() ? ('?' + p.toString()) : ''}`;
            window.history.pushState({}, '', newUrl);
            
            // Update filter states immediately (before AJAX)
            console.log('üîÑ Filter clicked - updating UI immediately');
            updateFilterStates();
            
            // Load products with AJAX instead of page reload
            console.log('üîÑ Filter clicked - calling AJAX with params:', p.toString());
            loadProductsWithAJAX(p.toString());
        });
        return a;
    }

    // Global cache for filters data
    let filtersCache = {
      categories: null,
      brands: null,
      tags: null,
      loaded: false
    };

    // Load filters data only once
    function loadFiltersData() {
      if (filtersCache.loaded) {
        console.log('‚úÖ Using cached filters data');
        renderFiltersFromCache();
        return;
      }

      console.log('üîÑ Loading filters data for the first time...');

    // Fetch categories - only show categories with products in stock
    Promise.all([
        fetch('https://buddyskincare.vn/backend/api/category/').then(r => r.ok ? r.json() : []),
        fetch('https://buddyskincare.vn/backend/api/products/').then(r => r.ok ? r.json() : [])
    ])
      .then(([categoriesList, productsList]) => {
        if (!Array.isArray(categoriesList) || !Array.isArray(productsList)) return;
        
        // Get categories that have products with stock > 0
        const categoriesWithStock = new Set();
        productsList.forEach(product => {
          const stockQuantity = typeof product.stock_quantity === 'number' ? product.stock_quantity : 0;
          if (stockQuantity > 0) {
            const categoryName = product.category_name || (product.category && product.category.name) || '';
            if (categoryName) {
              categoriesWithStock.add(categoryName);
            }
          }
        });
        
          const filteredCategories = categoriesList
            .map(item => item.name || item.title || '')
            .filter(name => name && categoriesWithStock.has(name));
          
          filtersCache.categories = filteredCategories;
          console.log(`‚úÖ Cached ${filteredCategories.length} categories`);
        }).catch(() => {});

    // Fetch brands - only show brands with products in stock
    Promise.all([
        fetch('https://buddyskincare.vn/backend/api/brands/').then(r => r.ok ? r.json() : []),
        fetch('https://buddyskincare.vn/backend/api/products/').then(r => r.ok ? r.json() : [])
    ])
      .then(([brandsList, productsList]) => {
        if (!Array.isArray(brandsList) || !Array.isArray(productsList)) return;
        
        // Get brands that have products with stock > 0
        const brandsWithStock = new Set();
        productsList.forEach(product => {
          const stockQuantity = typeof product.stock_quantity === 'number' ? product.stock_quantity : 0;
          if (stockQuantity > 0) {
            const brandName = product.brand_name || (product.brand && product.brand.name) || '';
            if (brandName) {
              brandsWithStock.add(brandName);
            }
          }
        });
        
        // Sort brands alphabetically by name, only include those with stock
          const filteredBrands = brandsList
            .map(item => item.name || item.title || '')
            .filter(name => name && brandsWithStock.has(name))
            .sort((a, b) => a.localeCompare(b, 'vi', { sensitivity: 'base' }));
          
          filtersCache.brands = filteredBrands;
          console.log(`‚úÖ Cached ${filteredBrands.length} brands`);
        }).catch(() => {});

    // Fetch tags from products - only show tags with products in stock
        fetch('https://buddyskincare.vn/backend/api/products/')
      .then(r => r.ok ? r.json() : [])
      .then(products => {
        if (!Array.isArray(products)) return;
        
        // Extract all unique tags from products that have stock > 0
        const allTags = new Set();
        products.forEach(product => {
          const stockQuantity = typeof product.stock_quantity === 'number' ? product.stock_quantity : 0;
          if (stockQuantity > 0) {
            const tags = product?.tags || [];
            if (Array.isArray(tags)) {
              tags.forEach(tag => {
                if (typeof tag === 'string' && tag.trim()) {
                  allTags.add(tag.trim());
                } else if (tag && typeof tag === 'object' && tag.name && tag.name.trim()) {
                  allTags.add(tag.name.trim());
                }
              });
            }
          }
        });
        
        // Sort tags alphabetically
        const sortedTags = Array.from(allTags).sort((a, b) => a.localeCompare(b, 'vi', { sensitivity: 'base' }));
        
          filtersCache.tags = sortedTags;
          console.log(`‚úÖ Cached ${sortedTags.length} tags`);
          
          // Mark as loaded and render
          filtersCache.loaded = true;
          renderFiltersFromCache();
        }).catch(() => {});
    }

    // Render filters from cache
    function renderFiltersFromCache() {
      // Render categories
      if (filtersCache.categories) {
        catWrap.innerHTML = '';
        filtersCache.categories.forEach(name => {
          const isActive = selectedCats.includes(name);
          catWrap.appendChild(makeFilterLink(name, 'category_name', name, isActive));
        });
      }

      // Render brands
      if (filtersCache.brands) {
        brandWrap.innerHTML = '';
        filtersCache.brands.forEach(name => {
          const isActive = selectedBrands.includes(name);
          brandWrap.appendChild(makeFilterLink(name, 'brands_name', name, isActive));
        });
      }

      // Render tags
      if (filtersCache.tags) {
        tagsWrap.innerHTML = '';
        filtersCache.tags.forEach(tag => {
            tagsWrap.appendChild(makeFilterLink(tag, 'tags', tag, tag === selectedTag));
        });
      }
    }

    // Load filters data on page load
    loadFiltersData();
    
    // Update filter states on initial page load
    setTimeout(() => {
        console.log('üîÑ Initial page load - calling updateFilterStates()');
        updateFilterStates();
        
        // Update pagination visibility on initial load
        const currentParams = new URLSearchParams(window.location.search);
        updatePaginationVisibility(currentParams.toString());
    }, 500);
    
    // Test functions for debugging pagination - Make them global
    window.testPagination = function() {
        console.log('üîç TEST PAGINATION CLICKED');
        const paginationContainer = document.getElementById('products-pagination');
        console.log('üì¶ paginationContainer:', paginationContainer);
        console.log('üì¶ paginationContainer.innerHTML:', paginationContainer ? paginationContainer.innerHTML : 'N/A');
        console.log('üì¶ paginationContainer.style.display:', paginationContainer ? paginationContainer.style.display : 'N/A');
        
        // Check if main.js renderPagination function exists
        if (typeof renderPagination === 'function') {
            console.log('‚úÖ renderPagination function exists');
            console.log('üîç Calling renderPagination(1, 5, 50)...');
            renderPagination(1, 5, 50);
        } else {
            console.log('‚ùå renderPagination function not found');
        }
    };
    
    window.forceShowPagination = function() {
        console.log('üîç FORCE SHOW PAGINATION CLICKED');
        const paginationContainer = document.getElementById('products-pagination');
        if (paginationContainer) {
            paginationContainer.style.display = 'block';
            paginationContainer.innerHTML = `
                <li class="page-item disabled">
                    <span class="page-link">¬´</span>
                </li>
                <li class="page-item active">
                    <span class="page-link">1</span>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#" onclick="event.preventDefault(); return false;">2</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#" onclick="event.preventDefault(); return false;">3</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#" onclick="event.preventDefault(); return false;">¬ª</a>
                </li>
            `;
            console.log('‚úÖ Forced pagination display');
        } else {
            console.log('‚ùå Pagination container not found');
        }
    };
    
    

    // Update filter states after AJAX load
    function updateFilterStates() {
        console.log('üîÑ updateFilterStates() called');
        const currentParams = new URLSearchParams(window.location.search);
        const currentBrands = currentParams.getAll('brands_name') || [];
        const currentCats = currentParams.getAll('category_name') || [];
        const currentTag = currentParams.get('tags') || '';
        
        console.log('üîç URL params:', currentParams.toString());
        console.log('üîç Current brands:', currentBrands);
        
        // Update global variables for consistency
        selectedBrands = currentBrands;
        selectedCats = currentCats;

        // Update brand filter states
        const brandLinks = document.querySelectorAll('#filterBrands a');
        console.log('üîç Found brand links:', brandLinks.length);
        brandLinks.forEach(link => {
            const brandName = link.querySelector('span').textContent;
            const isActive = currentBrands.includes(brandName);
            console.log(`üîç Brand: ${brandName}, isActive: ${isActive}`);
            
            if (isActive) {
                link.className = 'd-flex align-items-center justify-content-between text-decoration-none px-2 py-1 rounded bg-primary text-white';
                link.innerHTML = `<span class="text-white">${brandName}</span><i class="fas fa-check text-white"></i>`;
                console.log(`‚úÖ Set ${brandName} as active`);
            } else {
                link.className = 'd-flex align-items-center justify-content-between text-decoration-none px-2 py-1 rounded hover-bg-light';
                link.innerHTML = `<span class="text-dark">${brandName}</span>`;
                console.log(`‚ùå Set ${brandName} as inactive`);
            }
        });

        // Update category filter states
        const catLinks = document.querySelectorAll('#filterCategories a');
        catLinks.forEach(link => {
            const catName = link.querySelector('span').textContent;
            const isActive = currentCats.includes(catName);
            
            if (isActive) {
                link.className = 'd-flex align-items-center justify-content-between text-decoration-none px-2 py-1 rounded bg-primary text-white';
                link.innerHTML = `<span class="text-white">${catName}</span><i class="fas fa-check text-white"></i>`;
            } else {
                link.className = 'd-flex align-items-center justify-content-between text-decoration-none px-2 py-1 rounded hover-bg-light';
                link.innerHTML = `<span class="text-dark">${catName}</span>`;
            }
        });

        // Update tag filter states
        const tagLinks = document.querySelectorAll('#filterTags a');
        tagLinks.forEach(link => {
            const tagName = link.querySelector('span').textContent;
            const isActive = currentTag === tagName;
            
            if (isActive) {
                link.className = 'd-flex align-items-center justify-content-between text-decoration-none px-2 py-1 rounded bg-primary text-white';
                link.innerHTML = `<span class="text-white">${tagName}</span><i class="fas fa-check text-white"></i>`;
            } else {
                link.className = 'd-flex align-items-center justify-content-between text-decoration-none px-2 py-1 rounded hover-bg-light';
                link.innerHTML = `<span class="text-dark">${tagName}</span>`;
            }
        });

        console.log('‚úÖ Filter states updated');
        console.log('üîç Current brands:', currentBrands);
        console.log('üîç Current categories:', currentCats);
        console.log('üîç Current tag:', currentTag);
    }

    // Update pagination visibility based on filters
    function updatePaginationVisibility(queryParams) {
        const paginationContainer = document.getElementById('products-pagination');
        if (!paginationContainer) {
            console.log('‚ùå Pagination container not found in updatePaginationVisibility');
            return;
        }
        
        // Always show pagination - let the backend handle pagination logic
        paginationContainer.style.display = 'block';
        console.log('üîç Pagination always visible - backend handles pagination logic');
    }

    // Load products with AJAX (without page reload)
    async function loadProductsWithAJAX(queryParams) {
        try {
            console.log('üîÑ Loading products with AJAX:', queryParams);
            
            // Show loading state
            const grid = document.getElementById('products-page-grid');
            if (grid) {
                grid.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                        </div>
                        <p class="mt-3 text-muted">ƒêang t·∫£i s·∫£n ph·∫©m...</p>
                    </div>
                `;
            }

            // Get products from Flask route (which uses server-side filtering)
            const url = queryParams ? `/products?${queryParams}&ajax=1` : `/products?ajax=1`;
            const response = await fetch(url);
            if (response.ok) {
                const html = await response.text();
                
                // Extract products from the HTML response
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const productsGrid = doc.getElementById('products-page-grid');
                
                if (productsGrid) {
                    // Update products grid
                    grid.innerHTML = productsGrid.innerHTML;
                    
                    // Update products info
                    const showingEl = doc.getElementById('products-showing');
                    const totalEl = doc.getElementById('products-total');
                    if (showingEl && totalEl) {
                        document.getElementById('products-showing').textContent = showingEl.textContent;
                        document.getElementById('products-total').textContent = totalEl.textContent;
                    }
                    
                    // Re-initialize product cards (event handlers, animations, etc.)
                    if (typeof initProductCards === 'function') {
                        initProductCards();
                    }
                    if (typeof initAnimations === 'function') {
                        initAnimations();
                    }
                    
                    // Show/hide pagination based on filters
                    updatePaginationVisibility(queryParams);
                    
                    // Filter states already updated before AJAX, no need to update again
                    
                    console.log('‚úÖ Products loaded via AJAX');
                } else {
                    console.log('‚ùå Could not find products grid in response');
                }
            } else {
                console.log('‚ùå Failed to load products:', response.status);
            }
        } catch (error) {
            console.error('‚ùå Error loading products:', error);
        }
    }

    // Clear cache when user leaves the page
    window.addEventListener('beforeunload', function() {
      console.log('üîÑ User leaving page - clearing filters cache');
      filtersCache = {
        categories: null,
        brands: null,
        tags: null,
        loaded: false
      };
    });

    // Also clear cache when navigating to different pages
    document.addEventListener('click', function(e) {
      const link = e.target.closest('a');
      if (link && link.href && !link.href.includes('/products')) {
        console.log('üîÑ Navigating away from products - clearing filters cache');
        filtersCache = {
          categories: null,
          brands: null,
          tags: null,
          loaded: false
        };
      }
    });

    // Smart Search Function
    function initSmartSearch() {
        const searchInput = document.getElementById('products-search');
        const suggestionsDiv = document.getElementById('search-suggestions');
        let allProducts = [];
        let searchTimeout;

        // Load products for search
        fetch('https://buddyskincare.vn/backend/api/products/')
            .then(r => r.ok ? r.json() : [])
            .then(products => {
                allProducts = products || [];
            })
            .catch(() => {});

        // Handle search input
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();
            
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                hideSuggestions();
                return;
            }

            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        });

        // Handle search on Enter
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const query = e.target.value.trim();
                if (query) {
                    executeSearch(query);
                }
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                hideSuggestions();
            }
        });

        function performSearch(query) {
            const results = searchProducts(query, allProducts);
            showSuggestions(results, query);
        }

        function searchProducts(query, products) {
            const lowerQuery = query.toLowerCase();
            const results = [];

            products.forEach(product => {
                const name = (product.name || '').toLowerCase();
                const brand = (product.brand_name || '').toLowerCase();
                const category = (product.category_name || '').toLowerCase();
                const tags = (product.tags || []).map(tag => 
                    typeof tag === 'string' ? tag.toLowerCase() : (tag.name || '').toLowerCase()
                );

                let score = 0;
                let matchType = '';

                // Exact name match (highest priority)
                if (name.includes(lowerQuery)) {
                    score += 100;
                    matchType = 'name';
                }
                // Brand match
                else if (brand.includes(lowerQuery)) {
                    score += 80;
                    matchType = 'brand';
                }
                // Category match
                else if (category.includes(lowerQuery)) {
                    score += 60;
                    matchType = 'category';
                }
                // Tags match
                else if (tags.some(tag => tag.includes(lowerQuery))) {
                    score += 40;
                    matchType = 'tag';
                }

                if (score > 0) {
                    results.push({
                        product,
                        score,
                        matchType
                    });
                }
            });

            // Sort by score and return top 8 results
            return results
                .sort((a, b) => b.score - a.score)
                .slice(0, 8);
        }

        function showSuggestions(results, query) {
            if (results.length === 0) {
                hideSuggestions();
                return;
            }

            let html = '';
            results.forEach(result => {
                const { product, matchType } = result;
                const imageUrl = product.image || '/static/image/default-product.jpg';
                const price = product.discounted_price ? (product.discounted_price * 1000).toLocaleString('vi-VN') : 'N/A';
                
                html += `
                    <div class="suggestion-item p-2 border-bottom" style="cursor: pointer;" data-product-id="${product.id}">
                        <div class="d-flex align-items-center">
                            <img src="${imageUrl}" alt="${product.name}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 10px;">
                            <div class="flex-grow-1">
                                <div class="fw-bold" style="font-size: 14px;">${product.name}</div>
                                <div class="text-muted" style="font-size: 12px;">
                                    ${product.brand_name || 'N/A'} ‚Ä¢ ${price}ƒë
                                </div>
                            </div>
                            
                        </div>
                    </div>
                `;
            });

            // Add "T√¨m ki·∫øm t·∫•t c·∫£" option
            html += `
                <div class="suggestion-item p-2 text-center bg-light" style="cursor: pointer;" data-search-all="true">
                    <i class="fas fa-search me-2"></i>T√¨m ki·∫øm t·∫•t c·∫£ cho "${query}"
                </div>
            `;

            suggestionsDiv.innerHTML = html;
            suggestionsDiv.style.display = 'block';

            // Add click handlers
            suggestionsDiv.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', function() {
                    if (this.dataset.searchAll === 'true') {
                        executeSearch(query);
                    } else {
                        const productId = this.dataset.productId;
                        window.location.href = `/product/${productId}`;
                    }
                });

                // Hover effect
                item.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f8f9fa';
                });
                item.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = this.dataset.searchAll === 'true' ? '#f8f9fa' : 'white';
                });
            });
        }

        function hideSuggestions() {
            suggestionsDiv.style.display = 'none';
        }

        function executeSearch(query) {
            hideSuggestions();
            const p = new URLSearchParams(window.location.search);
            p.set('search', query);
            p.delete('page');
            window.location.href = `/products?${p.toString()}`;
        }

        // Pre-fill search if coming from nav-search
        const searchParam = params.get('search') || params.get('q');
        if (searchParam) {
            searchInput.value = searchParam;
        }
        
        // Mobile filters functionality
        initMobileFilters();
    }
    
    function initMobileFilters() {
        // Sync mobile filters with desktop filters
        syncMobileFilters();
        
        // Apply filters button
        const applyBtn = document.getElementById('applyFiltersMobile');
        if (applyBtn) {
            applyBtn.addEventListener('click', function() {
                applyMobileFilters();
                // Close offcanvas
                const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('filtersOffcanvas'));
                if (offcanvas) offcanvas.hide();
            });
        }
        
        // Clear filters button
        const clearBtn = document.getElementById('clearFiltersMobile');
        if (clearBtn) {
            clearBtn.addEventListener('click', function() {
                clearMobileFilters();
            });
        }
    }
    
    function syncMobileFilters() {
        // Sync price range
        const priceRange = params.get('price_range');
        if (priceRange) {
            const mobilePriceInput = document.querySelector(`input[name="price_range_mobile"][value="${priceRange}"]`);
            if (mobilePriceInput) mobilePriceInput.checked = true;
        }
        
        // Sync condition
        const condition = params.get('condition');
        if (condition) {
            const mobileConditionInput = document.querySelector(`input[name="condition_mobile"][value="${condition}"]`);
            if (mobileConditionInput) mobileConditionInput.checked = true;
        }
        
        // Sync discount range
        const discountRange = params.get('discount_range');
        if (discountRange) {
            const mobileDiscountInput = document.querySelector(`input[name="discount_range_mobile"][value="${discountRange}"]`);
            if (mobileDiscountInput) mobileDiscountInput.checked = true;
        }
    }
    
    function applyMobileFilters() {
        const url = new URL(window.location);
        
        // Get selected values
        const priceRange = document.querySelector('input[name="price_range_mobile"]:checked')?.value;
        const condition = document.querySelector('input[name="condition_mobile"]:checked')?.value;
        const discountRange = document.querySelector('input[name="discount_range_mobile"]:checked')?.value;
        
        // Update URL parameters
        if (priceRange) url.searchParams.set('price_range', priceRange);
        else url.searchParams.delete('price_range');
        
        if (condition && condition !== 'all') url.searchParams.set('condition', condition);
        else url.searchParams.delete('condition');
        
        if (discountRange) url.searchParams.set('discount_range', discountRange);
        else url.searchParams.delete('discount_range');
        
        // Reset to page 1
        url.searchParams.delete('page');
        
        // Navigate
        window.location.href = url.toString();
    }
    
    function clearMobileFilters() {
        // Uncheck all mobile filters
        document.querySelectorAll('input[name="price_range_mobile"]').forEach(input => input.checked = false);
        document.querySelectorAll('input[name="condition_mobile"]').forEach(input => input.checked = false);
        document.querySelectorAll('input[name="discount_range_mobile"]').forEach(input => input.checked = false);
        
        // Set default condition
        const defaultCondition = document.querySelector('input[name="condition_mobile"][value="all"]');
        if (defaultCondition) defaultCondition.checked = true;
        
        // Clear URL parameters
        const url = new URL(window.location);
        url.searchParams.delete('price_range');
        url.searchParams.delete('condition');
        url.searchParams.delete('discount_range');
        url.searchParams.set('page', '1');
        
        // Navigate
        window.location.href = url.toString();
    }
})();
</script>
{% endblock %} 
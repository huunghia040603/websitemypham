{% extends "admin_base.html" %}

{% block title %}Quản Lý Cộng Tác Viên - Admin{% endblock %}

{% block extra_css %}
<style>
    .ctv-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .ctv-tabs {
        display: flex;
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 30px;
    }

    .ctv-tab {
        padding: 12px 24px;
        background: none;
        border: none;
        cursor: pointer;
        font-weight: 500;
        color: #6c757d;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
    }

    .ctv-tab.active {
        color: #007bff;
        border-bottom-color: #007bff;
        background: #f8f9fa;
    }

    .ctv-tab:hover {
        color: #007bff;
        background: #f8f9fa;
    }

    .ctv-tab-content {
        display: none;
    }

    .ctv-tab-content.active {
        display: block;
    }

    .info-card {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .info-card p {
        margin-bottom: 8px;
        font-size: 14px;
    }

    .info-card p:last-child {
        margin-bottom: 0;
    }

    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 4px solid #007bff;
    }

    .stat-card.success {
        border-left-color: #28a745;
    }

    .stat-card.warning {
        border-left-color: #ffc107;
    }

    .stat-card.danger {
        border-left-color: #dc3545;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 0.9rem;
        color: #666;
    }
    
    /* Mobile responsive styles for CTV */
    @media (max-width: 768px) {
        .ctv-container {
            padding: 10px;
        }
        
        .ctv-tabs {
            flex-direction: column;
            border-bottom: none;
        }
        
        .ctv-tab {
            width: 100%;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            border-radius: 0;
        }
        
        .ctv-tab.active {
            background: #007bff;
            color: white;
            border-bottom-color: #007bff;
        }
        
        .stats-cards {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .stat-card {
            padding: 15px;
        }
        
        .stat-number {
            font-size: 1.5rem;
        }
        
        .stat-label {
            font-size: 0.8rem;
        }
        
        .card {
            margin-bottom: 1rem;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .card-header {
            padding: 0.75rem 1rem;
        }
        
        .table-responsive {
            font-size: 0.8rem;
        }
        
        .table th, .table td {
            padding: 0.5rem 0.25rem;
        }
        
        .btn {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
        }
        
        .form-control, .form-select {
            font-size: 0.9rem;
        }
        
        .modal-lg {
            max-width: 95%;
        }
        
        .modal-xl {
            max-width: 98%;
        }
        
        .d-flex.gap-2 {
            flex-direction: column;
            gap: 0.5rem !important;
        }
        
        .d-flex.gap-2 .btn {
            width: 100%;
            margin-bottom: 0.25rem;
        }
        
        .d-flex.justify-content-between {
            flex-direction: column;
            align-items: flex-start !important;
        }
        
        .d-flex.justify-content-between .btn-group {
            width: 100%;
            margin-top: 1rem;
        }
        
        .btn-group .btn {
            flex: 1;
            font-size: 0.8rem;
            padding: 0.5rem 0.25rem;
        }
        
        .col-md-3, .col-md-6, .col-md-9 {
            margin-bottom: 1rem;
        }
    }
    
    @media (max-width: 480px) {
        .ctv-container {
            padding: 5px;
        }
        
        .stat-card {
            padding: 10px;
        }
        
        .stat-number {
            font-size: 1.2rem;
        }
        
        .stat-label {
            font-size: 0.75rem;
        }
        
        .table th, .table td {
            padding: 0.25rem 0.1rem;
            font-size: 0.7rem;
        }
        
        .btn {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
        
        .btn-sm {
            padding: 0.2rem 0.4rem;
            font-size: 0.65rem;
        }
        
        .form-control, .form-select {
            font-size: 0.8rem;
        }
        
        .modal-dialog {
            margin: 0.5rem;
        }
        
        .form-label {
            font-size: 0.8rem;
        }
        
        .badge {
            font-size: 0.7rem;
        }
        
        .card h5, .card h6 {
            font-size: 0.9rem;
        }
        
        .card h4 {
            font-size: 1.1rem;
        }
        
        .d-flex.gap-2 .btn {
            font-size: 0.8rem;
            padding: 0.5rem;
        }
    }

    .table-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .table-header {
        background: #f8f9fa;
        padding: 20px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        margin: 0;
    }

    .table-actions {
        display: flex;
        gap: 10px;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 0.875rem;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .table {
        margin: 0;
    }

    .table th {
        background: #f8f9fa;
        border-top: none;
        font-weight: 600;
        color: #495057;
        padding: 15px 12px;
    }

    .table td {
        padding: 12px;
        vertical-align: middle;
        border-top: 1px solid #e9ecef;
    }

    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .status-pending {
        background: #fff3cd;
        color: #856404;
    }

    .status-approved {
        background: #d4edda;
        color: #155724;
    }

    .status-rejected {
        background: #f8d7da;
        color: #721c24;
    }

    .level-badge {
        background: #e3f2fd;
        color: #1976d2;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .commission-badge {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .loading-spinner {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 20px;
        color: #dee2e6;
    }

    .modal-header {
        background: #007bff;
        color: white;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 8px;
    }

    .alert {
        border-radius: 8px;
        border: none;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
    }

    .alert-danger {
        background: #f8d7da;
        color: #721c24;
    }

    .alert-warning {
        background: #fff3cd;
        color: #856404;
    }

    .alert-info {
        background: #d1ecf1;
        color: #0c5460;
    }

    .password-display {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        color: #6c757d;
        transition: color 0.3s ease;
    }
    
    .password-display.visible {
        color: #dc3545;
    }

    @media (max-width: 768px) {
        .ctv-container {
            padding: 10px;
        }

        .stats-cards {
            grid-template-columns: 1fr;
        }

        .table-header {
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }

        .table-actions {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="ctv-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-users me-2"></i>Quản Lý Cộng Tác Viên
        </h1>
        <div class="text-muted">
            <i class="fas fa-clock me-1"></i>
            <span id="lastUpdated">Đang tải...</span>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-number" id="totalApplications">-</div>
            <div class="stat-label">Tổng đơn đăng ký</div>
        </div>
        <div class="stat-card success">
            <div class="stat-number" id="approvedApplications">-</div>
            <div class="stat-label">Đã duyệt</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-number" id="pendingApplications">-</div>
            <div class="stat-label">Chờ duyệt đơn</div>
        </div>
        <div class="stat-card danger">
            <div class="stat-number" id="rejectedApplications">-</div>
            <div class="stat-label">Từ chối</div>
        </div>
        <div class="stat-card" style="border-left-color: #6f42c1;">
            <div class="stat-number" id="totalWithdrawals">-</div>
            <div class="stat-label">Chờ duyệt rút tiền</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="ctv-tabs">
        <button class="ctv-tab active" data-tab="applications">
            <i class="fas fa-file-alt me-2"></i>Đơn Đăng Ký
        </button>
        <button class="ctv-tab" data-tab="levels">
            <i class="fas fa-star me-2"></i>Cấp Độ CTV
        </button>
        <button class="ctv-tab" data-tab="ctvs">
            <i class="fas fa-users me-2"></i>Danh Sách CTV
        </button>
        <button class="ctv-tab" data-tab="all-orders">
            <i class="fas fa-shopping-cart me-2"></i>Đơn của tất cả CTV
        </button>
        <button class="ctv-tab" data-tab="withdrawals">
            <i class="fas fa-money-bill-wave me-2"></i>Yêu Cầu Rút Tiền
        </button>
        <button class="ctv-tab" data-tab="wallets">
            <i class="fas fa-wallet me-2"></i>Quản Lý Ví CTV
        </button>
    </div>

    <!-- Applications Tab -->
    <div id="applications-tab" class="ctv-tab-content active">
        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Đơn Đăng Ký CTV</h3>
                <div class="table-actions">
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshApplications()">
                        <i class="fas fa-sync-alt me-1"></i>Làm mới
                    </button>
                    <button class="btn btn-success btn-sm" onclick="exportApplications()">
                        <i class="fas fa-download me-1"></i>Xuất Excel
                    </button>
                   
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tên</th>
                            <th>SĐT</th>
                            <th>Email</th>
                            <th>Địa chỉ</th>
                            <th>Mã CTV</th>
                            <th>Trạng thái</th>
                            <th>Ngày đăng ký</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="applicationsTableBody">
                        <tr>
                            <td colspan="9" class="text-center">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Đang tải...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Levels Tab -->
    <div id="levels-tab" class="ctv-tab-content">
        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Cấp Độ CTV</h3>
                <div class="table-actions">
                    <button class="btn btn-primary btn-sm" onclick="showAddLevelModal()">
                        <i class="fas fa-plus me-1"></i>Thêm cấp độ
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshLevels()">
                        <i class="fas fa-sync-alt me-1"></i>Làm mới
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tên cấp độ</th>
                            <th>Hoa hồng (%)</th>
                            <th>Mô tả</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="levelsTableBody">
                        <tr>
                            <td colspan="5" class="text-center">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Đang tải...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- CTVs Tab -->
    <div id="ctvs-tab" class="ctv-tab-content">
        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Danh Sách CTV</h3>
                <div class="table-actions">
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshCTVs()">
                        <i class="fas fa-sync-alt me-1"></i>Làm mới
                    </button>
                    <button class="btn btn-success btn-sm" onclick="exportCTVs()">
                        <i class="fas fa-download me-1"></i>Xuất Excel
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tên</th>
                            <th>SĐT</th>
                            <th>Email</th>
                            <th>Mã CTV</th>
                            <th>Cấp độ</th>
                            <th>Hoa hồng</th>
                            <th>Trạng thái</th>
                            <th>Ngày tạo</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="ctvsTableBody">
                        <tr>
                            <td colspan="10" class="text-center">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Đang tải...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- All CTV Orders Tab -->
    <div id="all-orders-tab" class="ctv-tab-content">
        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Đơn hàng của tất cả CTV</h3>
                <div class="table-actions">
                    <button class="btn btn-outline-primary btn-sm" onclick="loadAllCTVOrders()">
                        <i class="fas fa-sync-alt me-1"></i>Làm mới
                    </button>
                    <button class="btn btn-success btn-sm" onclick="exportAllCTVOrders()">
                        <i class="fas fa-download me-1"></i>Xuất Excel
                    </button>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="filter-section mb-3">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">CTV Code:</label>
                        <select class="form-select" id="filterCTVCode">
                            <option value="">Tất cả CTV</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Từ ngày:</label>
                        <input type="date" class="form-control" id="filterStartDate">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Đến ngày:</label>
                        <input type="date" class="form-control" id="filterEndDate">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="filterAllCTVOrders()">
                            <i class="fas fa-filter me-1"></i>Lọc
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Statistics Cards -->
            <div class="row g-3 mb-4" id="allCTVOrdersStats">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                            <h5 class="card-title">Tổng đơn hàng</h5>
                            <h3 class="mb-0" id="statsTotalOrders">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                            <h5 class="card-title">Tổng doanh thu CTV</h5>
                            <h3 class="mb-0" id="statsTotalRevenue">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-chart-line fa-2x mb-2"></i>
                            <h5 class="card-title">Tổng lợi nhuận CTV</h5>
                            <h3 class="mb-0" id="statsTotalProfit">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-percentage fa-2x mb-2"></i>
                            <h5 class="card-title">Tổng hoa hồng CTV</h5>
                            <h3 class="mb-0" id="statsTotalCommission">-</h3>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Mã đơn</th>
                            <th>CTV Code</th>
                            <th>CTV</th>
                            <th>Khách hàng</th>
                            <th>SĐT</th>
                            <th>Tổng tiền</th>
                            <th>Lợi nhuận</th>
                            <th>Hoa hồng</th>
                            <th>Trạng thái</th>
                            <th>Ngày đặt</th>
                        </tr>
                    </thead>
                    <tbody id="allCTVOrdersTableBody">
                        <tr>
                            <td colspan="10" class="text-center">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Đang tải...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Withdrawals Tab -->
    <div id="withdrawals-tab" class="ctv-tab-content">
        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Yêu cầu rút tiền</h3>
                <div class="table-actions">
                    <button class="btn btn-outline-primary btn-sm" onclick="loadWithdrawals()">
                        <i class="fas fa-sync-alt me-1"></i>Làm mới
                    </button>
                    <button class="btn btn-success btn-sm" onclick="exportWithdrawals()">
                        <i class="fas fa-download me-1"></i>Xuất Excel
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>CTV</th>
                            <th>SĐT</th>
                            <th>Số tiền</th>
                            <th>Trạng thái</th>
                            <th>Ngày yêu cầu</th>
                            <th>Ngày xử lý</th>
                            <th>Ghi chú</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawalsTableBody">
                        <tr>
                            <td colspan="9" class="text-center">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Đang tải...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Wallets Tab -->
    <div id="wallets-tab" class="ctv-tab-content">
        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Quản Lý Ví CTV</h3>
                <div class="table-actions">
                    <button class="btn btn-outline-primary btn-sm" onclick="loadCTVWallets()">
                        <i class="fas fa-sync-alt me-1"></i>Làm mới
                    </button>
                    <button class="btn btn-success btn-sm" onclick="exportCTVWallets()">
                        <i class="fas fa-download me-1"></i>Xuất Excel
                    </button>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="filter-section mb-3">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">CTV Code:</label>
                        <select class="form-select" id="filterWalletCTVCode">
                            <option value="">Tất cả CTV</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Trạng thái:</label>
                        <select class="form-select" id="filterWalletStatus">
                            <option value="">Tất cả</option>
                            <option value="active">Đang hoạt động</option>
                            <option value="inactive">Không hoạt động</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="filterCTVWallets()">
                            <i class="fas fa-filter me-1"></i>Lọc
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>CTV Code</th>
                            <th>Tên CTV</th>
                            <th>SĐT</th>
                            <th>Số dư hiện tại</th>
                            <th>Đang chờ</th>
                            <th>Tổng đã rút</th>
                            <th>Tổng doanh thu</th>
                            <th>Cấp độ</th>
                            <th>Trạng thái</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="ctvWalletsTableBody">
                        <tr>
                            <td colspan="10" class="text-center">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Đang tải...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Application Detail Modal -->
<div class="modal fade" id="applicationDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>Chi tiết đơn đăng ký
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="applicationDetailBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-danger" id="rejectApplicationBtn" onclick="rejectApplication()">
                    <i class="fas fa-times me-1"></i>Từ chối
                </button>
                <button type="button" class="btn btn-success" id="approveApplicationBtn" onclick="approveApplication()">
                    <i class="fas fa-check me-1"></i>Duyệt
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Withdrawal Detail Modal -->
<div class="modal fade" id="withdrawalDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-money-bill-wave me-2"></i>Chi tiết yêu cầu rút tiền
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="withdrawalDetailBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-danger" id="rejectWithdrawalBtn" onclick="rejectWithdrawal()">
                    <i class="fas fa-times me-1"></i>Từ chối
                </button>
                <button type="button" class="btn btn-success" id="approveWithdrawalBtn" onclick="approveWithdrawal()">
                    <i class="fas fa-check me-1"></i>Duyệt
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Level Modal -->
<div class="modal fade" id="addLevelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Thêm cấp độ CTV
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addLevelForm">
                    <div class="form-group">
                        <label class="form-label">Tên cấp độ</label>
                        <input type="text" class="form-control" id="levelName" required autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hoa hồng (%)</label>
                        <input type="number" class="form-control" id="levelCommission" min="0" max="100" step="0.1" required autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" id="levelDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveLevel()">
                    <i class="fas fa-save me-1"></i>Lưu
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Level Modal -->
<div class="modal fade" id="editLevelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Chỉnh sửa cấp độ CTV
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editLevelForm">
                    <input type="hidden" id="editLevelId">
                    <div class="form-group">
                        <label class="form-label">Tên cấp độ</label>
                        <input type="text" class="form-control" id="editLevelName" required autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hoa hồng (%)</label>
                        <input type="number" class="form-control" id="editLevelCommission" min="0" max="100" step="0.1" required autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" id="editLevelDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="updateLevel()">
                    <i class="fas fa-save me-1"></i>Cập nhật
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit CTV Modal -->
<div class="modal fade" id="editCTVModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-edit me-2"></i>Chỉnh sửa thông tin CTV
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCTVForm">
                    <input type="hidden" id="editCTVId">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-user me-2"></i>Thông tin cá nhân</h6>
                            <div class="form-group">
                                <label class="form-label">Tên đầy đủ</label>
                                <input type="text" class="form-control" id="editCTVFullName" required autocomplete="name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Số điện thoại</label>
                                <input type="text" class="form-control" id="editCTVPhone" required autocomplete="tel">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="editCTVEmail" required autocomplete="email">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Địa chỉ</label>
                                <textarea class="form-control" id="editCTVAddress" rows="2" autocomplete="address-line1"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-id-card me-2"></i>Thông tin CTV</h6>
                            <div class="form-group">
                                <label class="form-label">Mã CTV</label>
                                <input type="text" class="form-control" id="editCTVCode" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cấp độ</label>
                                <select class="form-control" id="editCTVLevel" required>
                                    <option value="">Chọn cấp độ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Mật khẩu</label>
                                <input type="password" class="form-control" id="editCTVPassword" placeholder="Để trống nếu không đổi" autocomplete="new-password">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Trạng thái</label>
                                <select class="form-control" id="editCTVStatus" required>
                                    <option value="true">Hoạt động</option>
                                    <option value="false">Không hoạt động</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6><i class="fas fa-university me-2"></i>Thông tin ngân hàng</h6>
                            <div class="form-group">
                                <label class="form-label">Tên ngân hàng</label>
                                <input type="text" class="form-control" id="editCTVBankName" required autocomplete="organization">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Số tài khoản</label>
                                <input type="text" class="form-control" id="editCTVBankNumber" required autocomplete="cc-number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Chủ tài khoản</label>
                                <input type="text" class="form-control" id="editCTVBankHolder" required autocomplete="cc-name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-id-card me-2"></i>Giấy tờ tùy thân</h6>
                            <div class="form-group">
                                <label class="form-label">CCCD mặt trước</label>
                                <input type="url" class="form-control" id="editCTVCCCDFront">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CCCD mặt sau</label>
                                <input type="url" class="form-control" id="editCTVCCCDBack">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="updateCTV()">
                    <i class="fas fa-save me-1"></i>Cập nhật
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CTV Wallet Detail Modal -->
<div class="modal fade" id="ctvWalletDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-wallet me-2"></i>Chi tiết ví CTV
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="ctvWalletDetailBody">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="adjustCTVWalletFromDetail()">
                    <i class="fas fa-edit me-1"></i>Điều chỉnh ví
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CTV Wallet Adjustment Modal -->
<div class="modal fade" id="ctvWalletAdjustModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Điều chỉnh ví CTV
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="adjustWalletForm">
                    <input type="hidden" id="adjustCTVId">
                    <input type="hidden" id="adjustCTVCode">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-info-circle me-2"></i>Thông tin CTV</h6>
                            <div class="form-group mb-3">
                                <label class="form-label">Tên CTV:</label>
                                <input type="text" class="form-control" id="adjustCTVName" readonly>
                            </div>
                            <div class="form-group mb-3">
                                <label class="form-label">Mã CTV:</label>
                                <input type="text" class="form-control" id="adjustCTVCodeDisplay" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-wallet me-2"></i>Số dư hiện tại</h6>
                            <div class="form-group mb-3">
                                <label class="form-label">Số dư:</label>
                                <input type="text" class="form-control" id="adjustCurrentBalance" readonly>
                            </div>
                            <div class="form-group mb-3">
                                <label class="form-label">Đang chờ:</label>
                                <input type="text" class="form-control" id="adjustCurrentPending" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-plus-circle me-2"></i>Điều chỉnh số dư</h6>
                            <div class="form-group mb-3">
                                <label class="form-label">Loại điều chỉnh:</label>
                                <select class="form-select" id="adjustType" required>
                                    <option value="">Chọn loại điều chỉnh</option>
                                    <option value="add_balance">Cộng vào số dư</option>
                                    <option value="subtract_balance">Trừ khỏi số dư</option>
                                    <option value="set_balance">Đặt số dư mới</option>
                                </select>
                            </div>
                            <div class="form-group mb-3">
                                <label class="form-label">Số tiền (VND):</label>
                                <input type="number" class="form-control" id="adjustAmount" min="0" step="1000" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-comment me-2"></i>Ghi chú</h6>
                            <div class="form-group mb-3">
                                <label class="form-label">Lý do điều chỉnh:</label>
                                <textarea class="form-control" id="adjustReason" rows="4" placeholder="Nhập lý do điều chỉnh ví..." required></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Lưu ý:</strong> Việc điều chỉnh ví sẽ được ghi lại trong lịch sử và không thể hoàn tác.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-warning" onclick="confirmWalletAdjustment()">
                    <i class="fas fa-save me-1"></i>Xác nhận điều chỉnh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Alert Container -->
<div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

<script>
// Global variables
let applications = [];
let levels = [];
let ctvs = [];
let currentApplication = null;

// API endpoints
    const API_BASE = 'https://buddyskincare.vn/backend/api';
const ENDPOINTS = {
    applications: `${API_BASE}/ctv-applications/`,
    levels: `${API_BASE}/ctv-levels/`,
    ctvs: `${API_BASE}/ctvs/`
};

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeTabs();
    loadAllData();
    updateLastUpdated();
});

// Tab functionality
function initializeTabs() {
    const tabs = document.querySelectorAll('.ctv-tab');
    const contents = document.querySelectorAll('.ctv-tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.dataset.tab;
            
            // Remove active class from all tabs and contents
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            this.classList.add('active');
            document.getElementById(`${targetTab}-tab`).classList.add('active');
            
            // Load data based on active tab
            if (targetTab === 'applications') {
                loadApplications();
            } else if (targetTab === 'levels') {
                loadLevels();
            } else if (targetTab === 'ctvs') {
                loadCTVs();
            } else if (targetTab === 'all-orders') {
                loadAllCTVOrders();
            } else if (targetTab === 'withdrawals') {
                loadWithdrawals();
            } else if (targetTab === 'wallets') {
                loadCTVWallets();
            }
        });
    });
}

// Load all data
async function loadAllData() {
    try {
        await Promise.all([
            loadApplications(),
            loadLevels(),
            loadCTVs(),
            loadWithdrawals()
        ]);
        updateStats();
    } catch (error) {
        console.error('Error loading data:', error);
        showAlert('Lỗi khi tải dữ liệu', 'danger');
    }
}

// Load applications
async function loadApplications() {
    try {
        const response = await fetch(ENDPOINTS.applications);
        if (!response.ok) throw new Error('Failed to load applications');
        
        applications = await response.json();
        renderApplications();
    } catch (error) {
        console.error('Error loading applications:', error);
        showAlert('Lỗi khi tải danh sách đơn đăng ký', 'danger');
    }
}

// Load levels
async function loadLevels() {
    try {
        const response = await fetch(ENDPOINTS.levels);
        if (!response.ok) throw new Error('Failed to load levels');
        
        levels = await response.json();
        renderLevels();
    } catch (error) {
        console.error('Error loading levels:', error);
        showAlert('Lỗi khi tải danh sách cấp độ', 'danger');
    }
}

// Load CTVs
async function loadCTVs() {
    try {
        const response = await fetch(ENDPOINTS.ctvs);
        if (!response.ok) throw new Error('Failed to load CTVs');
        
        ctvs = await response.json();
        renderCTVs();
    } catch (error) {
        console.error('Error loading CTVs:', error);
        showAlert('Lỗi khi tải danh sách CTV', 'danger');
    }
}

// Render applications
function renderApplications() {
    const tbody = document.getElementById('applicationsTableBody');
    
    if (!applications || applications.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center">
                    <div class="empty-state">
                        <i class="fas fa-file-alt"></i>
                        <p>Chưa có đơn đăng ký nào</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = applications.map(app => `
        <tr>
            <td>${app.id}</td>
            <td>${app.full_name || app.name || 'N/A'}</td>
            <td>${app.phone || 'N/A'}</td>
            <td>${app.email || 'N/A'}</td>
            <td>${app.address || 'N/A'}</td>
            <td>${app.desired_code || app.ctv_code || 'N/A'}</td>
            <td>
                <span class="status-badge status-${app.status || 'pending'}">
                    ${getStatusText(app.status)}
                </span>
            </td>
            <td>${formatDate(app.created_at)}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewApplication(${app.id})">
                    <i class="fas fa-eye"></i>
                </button>
                ${app.status === 'pending' ? `
                    <button class="btn btn-sm btn-success" onclick="approveApplication(${app.id})">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="rejectApplication(${app.id})">
                        <i class="fas fa-times"></i>
                    </button>
                ` : ''}
            </td>
        </tr>
    `).join('');
}

// Render levels
function renderLevels() {
    const tbody = document.getElementById('levelsTableBody');
    
    if (!levels || levels.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center">
                    <div class="empty-state">
                        <i class="fas fa-star"></i>
                        <p>Chưa có cấp độ nào</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = levels.map(level => `
        <tr>
            <td>${level.id}</td>
            <td>${level.name || 'N/A'}</td>
            <td>
                <span class="commission-badge">
                    ${level.commission_percent || 0}%
                </span>
            </td>
            <td>${level.description || 'N/A'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editLevel(${level.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteLevel(${level.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// Render CTVs
function renderCTVs() {
    const tbody = document.getElementById('ctvsTableBody');
    
    if (!ctvs || ctvs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center">
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>Chưa có CTV nào</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = ctvs.map(ctv => `
        <tr>
            <td>${ctv.id}</td>
            <td>${ctv.full_name || ctv.name || 'N/A'}</td>
            <td>${ctv.phone || 'N/A'}</td>
            <td>${ctv.email || 'N/A'}</td>
            <td>${ctv.code || ctv.desired_code || ctv.ctv_code || 'N/A'}</td>
            <td>
                <span class="level-badge">
                    ${ctv.level ? ctv.level.name : 'N/A'}
                </span>
            </td>
            <td>
                <span class="commission-badge">
                    ${ctv.level ? ctv.level.commission_percent : 0}%
                </span>
            </td>
            <td>
                <span class="status-badge status-${ctv.is_active ? 'active' : 'inactive'}">
                    ${getCTVStatusText(ctv.is_active)}
                </span>
            </td>
            <td>${formatDate(ctv.joined_at)}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewCTV(${ctv.id})" title="Xem chi tiết">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="editCTV(${ctv.id})" title="Chỉnh sửa">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="viewCTVOrders('${ctv.code || ctv.desired_code || ctv.ctv_code || ''}')" title="Xem đơn hàng">
                    <i class="fas fa-shopping-cart"></i>
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="sendWelcomeEmail(${ctv.id}, '${ctv.full_name || ctv.name || ''}', '${ctv.email || ''}', this)" title="Gửi email chúc mừng">
                    <i class="fas fa-envelope"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// Update stats
function updateStats() {
    const total = applications.length;
    const approved = applications.filter(app => app.status === 'approved').length;
    const pending = applications.filter(app => app.status === 'pending').length;
    const rejected = applications.filter(app => app.status === 'rejected').length;
    const pendingWithdrawals = withdrawals ? withdrawals.filter(w => w.status === 'pending').length : 0;

    document.getElementById('totalApplications').textContent = total;
    document.getElementById('approvedApplications').textContent = approved;
    document.getElementById('pendingApplications').textContent = pending;
    document.getElementById('rejectedApplications').textContent = rejected;
    document.getElementById('totalWithdrawals').textContent = pendingWithdrawals;
}

// Utility functions
function getStatusText(status) {
    const statusMap = {
        'pending': 'Chờ duyệt',
        'approved': 'Đã duyệt',
        'rejected': 'Từ chối'
    };
    return statusMap[status] || 'Không xác định';
}

function getCTVStatusText(isActive) {
    if (typeof isActive === 'boolean') {
        return isActive ? 'Hoạt động' : 'Không hoạt động';
    }
    const statusMap = {
        'active': 'Hoạt động',
        'inactive': 'Không hoạt động',
        'suspended': 'Tạm khóa'
    };
    return statusMap[isActive] || 'Không xác định';
}

function getOrderStatusText(status) {
    // Debug logging to see what status values we're getting
    console.log('🔍 getOrderStatusText called with status:', status, 'type:', typeof status);
    
    const statusMap = {
        'pending': 'Chờ xử lý',
        'processing': 'Đang xử lý',
        'confirmed': 'Đã xác nhận',
        'shipped': 'Đã giao hàng',
        'delivered': 'Đã nhận hàng',
        'cancelled': 'Đã hủy'
    };
    
    const result = statusMap[status] || 'Không xác định';
    console.log('🔍 getOrderStatusText result:', result);
    return result;
}

// Helper functions for date filtering
function getTodayDate() {
    return new Date().toISOString().split('T')[0];
}

function getDateDaysAgo(days) {
    const date = new Date();
    date.setDate(date.getDate() - days);
    return date.toISOString().split('T')[0];
}

// Calculate order profit (revenue - cost)
function calculateOrderProfit(order) {
    // New formula: Total Amount - Shipping Fee - Discount Applied - Import Price
    const totalAmount = parseFloat(order.total_amount || 0); // Keep in thousands
    const shippingFee = parseFloat(order.shipping_fee || 0); // Keep in thousands
    const discountApplied = parseFloat(order.discount_applied || 0); // Keep in thousands
    
    // Calculate total import price for all items in the order
    let totalImportPrice = 0;
    if (order.items && order.items.length > 0) {
        order.items.forEach(item => {
            if (item.product) {
                const importPrice = parseFloat(item.product.import_price || 0); // Keep in thousands
                const quantity = parseInt(item.quantity || 0);
                totalImportPrice += importPrice * quantity;
            }
        });
    }
    
    // Apply new formula: calculate in thousands, convert to VND only when displaying
    const profit = totalAmount - shippingFee - discountApplied - totalImportPrice;
    
    // Keep in thousands, convert to VND only when displaying
    return Math.max(0, profit); // Ensure non-negative
}

// Calculate commission based on new formula: (total_amount - shipping_fee - discount_applied - import_price) * commission_percent
function calculateOrderCommission(order, profit, ctvInfo = null) {
    let commissionRate = 0.10; // Default 10%
    
    // Use CTV level commission rate if available
    if (ctvInfo && ctvInfo.level && ctvInfo.level.commission_percent) {
        commissionRate = parseFloat(ctvInfo.level.commission_percent) / 100;
    }
    
    // New formula: ((total_amount - shipping_fee - discount_applied - import_price) * commission_percent) * 1000
    const totalAmount = parseFloat(order.total_amount || 0); // Keep in thousands
    const shippingFee = parseFloat(order.shipping_fee || 0); // Keep in thousands
    const discountApplied = parseFloat(order.discount_applied || 0); // Keep in thousands
    
    // Calculate total import price for all items in the order
    let totalImportPrice = 0;
    if (order.items && order.items.length > 0) {
        order.items.forEach(item => {
            if (item.product) {
                const importPrice = parseFloat(item.product.import_price || 0); // Keep in thousands
                const quantity = parseInt(item.quantity || 0);
                totalImportPrice += importPrice * quantity;
            }
        });
    }
    
    // Apply new formula: calculate in thousands, convert to VND only when displaying
    const commissionBase = totalAmount - shippingFee - discountApplied - totalImportPrice;
    const commission = commissionBase * commissionRate; // Keep in thousands
    
    return Math.max(0, commission); // Ensure non-negative
}

// Get commission calculation details for tooltip
function getCommissionDetail(order, ctvInfo = null) {
    const totalAmount = parseFloat(order.total_amount || 0); // Keep in thousands
    const shippingFee = parseFloat(order.shipping_fee || 0); // Keep in thousands
    const discountApplied = parseFloat(order.discount_applied || 0); // Keep in thousands
    
    let totalImportPrice = 0;
    if (order.items && order.items.length > 0) {
        order.items.forEach(item => {
            if (item.product) {
                const importPrice = parseFloat(item.product.import_price || 0); // Keep in thousands
                const quantity = parseInt(item.quantity || 0);
                totalImportPrice += importPrice * quantity;
            }
        });
    }
    
    const profit = totalAmount - shippingFee - discountApplied - totalImportPrice;
    const commissionRate = ctvInfo && ctvInfo.level ? ctvInfo.level.commission_percent : 10;
    const commission = profit * commissionRate / 100; // Keep in thousands
    
    return `Lợi nhuận: (${totalAmount} - ${shippingFee} - ${discountApplied} - ${totalImportPrice}) = ${profit}k\nHoa hồng: ${profit}k × ${commissionRate}% = ${formatPrice(commission)}`;
}

// Calculate total profit for all orders
function calculateTotalProfit(orders) {
    return orders.reduce((total, order) => {
        return total + calculateOrderProfit(order);
    }, 0);
}

// Calculate total commission for all orders
function calculateTotalCommission(orders, ctvInfo = null) {
    return orders.reduce((total, order) => {
        const profit = calculateOrderProfit(order);
        const commission = calculateOrderCommission(order, profit, ctvInfo);
        return total + commission;
    }, 0);
}

function renderCTVOrdersTable(orders, ctvInfo = null) {
    if (orders.length === 0) {
        return `
            <tr>
                <td colspan="8" class="text-center text-muted">
                    <i class="fas fa-inbox"></i> Chưa có đơn hàng nào
                </td>
            </tr>
        `;
    }
    
    return orders.map(order => {
        // Debug logging to see order data
        console.log('🔍 Order data:', order);
        console.log('🔍 Order status:', order.status, 'type:', typeof order.status);
        
        // Calculate profit and commission for this order
        const profit = calculateOrderProfit(order);
        const commission = calculateOrderCommission(order, profit, ctvInfo);
        
        return `
            <tr>
                <td>${order.order_code || `#${order.id}`}</td>
                <td>${order.customer_name || 'N/A'}</td>
                <td>${order.phone_number || 'N/A'}</td>
                <td>${formatPrice((order.total_amount || 0) )}</td>
                <td class="text-success">${formatPrice(profit)}</td>
                <td class="text-primary fw-bold" title="Chi tiết: ${getCommissionDetail(order, ctvInfo)}">${formatPrice(commission )}</td>
                <td>
                    <span class="status-badge status-${order.status || 'pending'}">
                        ${getOrderStatusText(order.status)}
                    </span>
                </td>
                <td>${formatDate(order.order_date)}</td>
            </tr>
        `;
    }).join('');
}

// Set date range and filter
function setDateRange(ctvCode, days) {
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    
    if (days === 0) {
        // Show all orders - set a very old start date
        startDateInput.value = '2020-01-01';
        endDateInput.value = getTodayDate();
    } else {
        startDateInput.value = getDateDaysAgo(days);
        endDateInput.value = getTodayDate();
    }
    
    // Auto filter after setting date range
    filterCTVOrders(ctvCode);
}

// Filter CTV orders by date range
async function filterCTVOrders(ctvCode) {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        showAlert('Vui lòng chọn đầy đủ ngày bắt đầu và kết thúc', 'warning');
        return;
    }
    
    try {
        // Show loading state
        const tbody = document.getElementById('ctvOrdersTableBody');
        tbody.innerHTML = '<tr><td colspan="10" class="text-center"><div class="loading-spinner"><i class="fas fa-spinner fa-spin me-2"></i>Đang lọc...</div></td></tr>';
        
        // Build API URL with filters - using backend filtering
        const apiUrl = new URL('https://buddyskincare.vn/backend/api/orders/');
        apiUrl.searchParams.append('collaborator_code', ctvCode);
        apiUrl.searchParams.append('order_date__gte', startDate + 'T00:00:00');
        apiUrl.searchParams.append('order_date__lte', endDate + 'T23:59:59');
        
        // Fetch filtered orders and CTV info
        const [ordersResponse, ctvResponse] = await Promise.all([
            fetch(apiUrl.toString()),
            fetch(`https://buddyskincare.vn/backend/api/ctvs/by-code/?code=${ctvCode}`)
        ]);
        
        if (!ordersResponse.ok || !ctvResponse.ok) {
            throw new Error('Failed to load data');
        }
        
        const filteredOrders = await ordersResponse.json();
        const ctvInfo = await ctvResponse.json();
        
        // Debug: Log filtered orders to see the data structure
        console.log('🔍 Filtered Orders - First 3 orders:', filteredOrders.slice(0, 3));
        if (filteredOrders.length > 0) {
            console.log('🔍 First filtered order structure:', Object.keys(filteredOrders[0]));
            console.log('🔍 First filtered order status field:', filteredOrders[0].status);
            console.log('🔍 First filtered order is_confirmed field:', filteredOrders[0].is_confirmed);
        }
        
        // Update table and totals
        document.getElementById('ctvOrdersTableBody').innerHTML = renderCTVOrdersTable(filteredOrders, ctvInfo);
        document.getElementById('orderCount').textContent = filteredOrders.length;
        document.getElementById('totalProfit').textContent = formatPrice(calculateTotalProfit(filteredOrders) / 1000);
        document.getElementById('totalCommission').textContent = formatPrice(calculateTotalCommission(filteredOrders, ctvInfo) / 1000);
        
    } catch (error) {
        console.error('Error filtering CTV orders:', error);
        showAlert('Lỗi khi lọc đơn hàng', 'danger');
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('vi-VN');
    } catch (error) {
        return 'N/A';
    }
}

function formatPrice(amount) {
    if (!amount) return '0đ';
    try {
        const num = parseFloat(amount);
        return num.toLocaleString('vi-VN') + 'đ';
    } catch (error) {
        return '0đ';
    }
}

function togglePassword(ctvId, password) {
    const passwordElement = document.getElementById(`password-${ctvId}`);
    const eyeElement = document.getElementById(`eye-${ctvId}`);
    
    if (passwordElement && eyeElement) {
        if (passwordElement.textContent === '••••••••') {
            // Show password
            passwordElement.textContent = password;
            eyeElement.className = 'fas fa-eye-slash';
            passwordElement.style.color = '#dc3545'; // Red color for visible password
        } else {
            // Hide password
            passwordElement.textContent = '••••••••';
            eyeElement.className = 'fas fa-eye';
            passwordElement.style.color = '#6c757d'; // Gray color for hidden password
        }
    }
}

function updateLastUpdated() {
    const now = new Date();
    document.getElementById('lastUpdated').textContent = 
        `Cập nhật lần cuối: ${now.toLocaleTimeString('vi-VN')}`;
}

function showAlert(title, message, type = 'info') {
    const alertContainer = document.getElementById('alertContainer');
    const alertId = 'alert-' + Date.now();
    
    const alertHTML = `
        <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
            <strong>${title}:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    alertContainer.insertAdjacentHTML('beforeend', alertHTML);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        const alert = document.getElementById(alertId);
        if (alert) {
            alert.remove();
        }
    }, 5000);
}

// Action functions
function refreshApplications() {
    loadApplications();
    showAlert('Thành công', 'Đã làm mới danh sách đơn đăng ký', 'success');
}

function refreshLevels() {
    loadLevels();
    showAlert('Thành công', 'Đã làm mới danh sách cấp độ', 'success');
}

function refreshCTVs() {
    loadCTVs();
    showAlert('Thành công', 'Đã làm mới danh sách CTV', 'success');
}

function viewApplication(id) {
    const app = applications.find(a => a.id === id);
    if (!app) return;
    
    currentApplication = app;
    
    const modalBody = document.getElementById('applicationDetailBody');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-user me-2"></i>Thông tin cá nhân</h6>
                <div class="info-card">
                    <p><strong>Tên đầy đủ:</strong> ${app.full_name || app.name || 'N/A'}</p>
                    <p><strong>Số điện thoại:</strong> ${app.phone || 'N/A'}</p>
                    <p><strong>Email:</strong> ${app.email || 'N/A'}</p>
                    <p><strong>Địa chỉ:</strong> ${app.address || 'N/A'}</p>
                </div>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-file-alt me-2"></i>Thông tin đăng ký</h6>
                <div class="info-card">
                    <p><strong>Mã CTV mong muốn:</strong> 
                        <span class="badge bg-primary">${app.desired_code || app.ctv_code || 'Chưa chọn'}</span>
                    </p>
                    <p><strong>Trạng thái:</strong> 
                        <span class="status-badge status-${app.status || 'pending'}">
                            ${getStatusText(app.status)}
                        </span>
                    </p>
                    <p><strong>Ngày đăng ký:</strong> ${formatDate(app.created_at)}</p>
                    <p><strong>ID đơn:</strong> #${app.id}</p>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-6">
                <h6><i class="fas fa-university me-2"></i>Thông tin ngân hàng</h6>
                <div class="info-card">
                    <p><strong>Tên ngân hàng:</strong> ${app.bank_name || 'N/A'}</p>
                    <p><strong>Số tài khoản:</strong> ${app.bank_number || 'N/A'}</p>
                    <p><strong>Chủ tài khoản:</strong> ${app.bank_holder || 'N/A'}</p>
                </div>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-id-card me-2"></i>Giấy tờ tùy thân</h6>
                <div class="info-card">
                    <p><strong>CCCD mặt trước:</strong> 
                        ${app.cccd_front_url ? 
                            `<a href="${app.cccd_front_url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye me-1"></i>Xem ảnh
                            </a>` : 'N/A'}
                    </p>
                    <p><strong>CCCD mặt sau:</strong> 
                        ${app.cccd_back_url ? 
                            `<a href="${app.cccd_back_url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye me-1"></i>Xem ảnh
                            </a>` : 'N/A'}
                    </p>
                </div>
            </div>
        </div>
        
        ${app.sales_plan ? `
            <div class="row mt-3">
                <div class="col-12">
                    <h6><i class="fas fa-chart-line me-2"></i>Kế hoạch bán hàng</h6>
                    <div class="info-card">
                        <p class="text-muted">${app.sales_plan}</p>
                    </div>
                </div>
            </div>
        ` : ''}
        
        ${app.message ? `
            <div class="row mt-3">
                <div class="col-12">
                    <h6><i class="fas fa-comment me-2"></i>Lời nhắn</h6>
                    <div class="info-card">
                        <p class="text-muted">${app.message}</p>
                    </div>
                </div>
            </div>
        ` : ''}
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Lưu ý:</strong> Sau khi duyệt đơn đăng ký, hệ thống sẽ tự động tạo tài khoản CTV và ví tiền cho người đăng ký.
                </div>
            </div>
        </div>
    `;
    
    // Show/hide action buttons based on status
    const approveBtn = document.getElementById('approveApplicationBtn');
    const rejectBtn = document.getElementById('rejectApplicationBtn');
    
    if (app.status === 'pending') {
        approveBtn.style.display = 'inline-block';
        rejectBtn.style.display = 'inline-block';
    } else {
        approveBtn.style.display = 'none';
        rejectBtn.style.display = 'none';
    }
    
    new bootstrap.Modal(document.getElementById('applicationDetailModal')).show();
}

async function approveApplication() {
    if (!currentApplication) return;
    
    const app = currentApplication;
    
    // Kiểm tra SĐT đã tồn tại chưa
    try {
        const phoneCheckResponse = await fetch(`https://buddyskincare.vn/backend/api/ctvs/by-phone/?phone=${app.phone}`);
        if (phoneCheckResponse.ok) {
            const existingCTV = await phoneCheckResponse.json();
            showAlert(`Số điện thoại ${app.phone} đã được sử dụng bởi CTV: ${existingCTV.code}`, 'warning');
            return;
        }
    } catch (error) {
        console.error('Error checking phone:', error);
    }
    
    // Kiểm tra mã CTV đã tồn tại chưa
    const desiredCode = app.desired_code || app.ctv_code;
    if (desiredCode) {
        try {
            const codeCheckResponse = await fetch(`https://buddyskincare.vn/backend/api/ctvs/by-code/?code=${desiredCode}`);
            if (codeCheckResponse.ok) {
                showAlert(`Mã CTV "${desiredCode}" đã được sử dụng`, 'warning');
                return;
            }
        } catch (error) {
            console.error('Error checking code:', error);
        }
    }
    
    // Hiển thị modal nhập mật khẩu
    showPasswordModal(app);
}

function rejectApplication() {
    if (!currentApplication) return;
    
    if (!confirm('Bạn có chắc chắn muốn từ chối đơn đăng ký này?')) return;
    
    // Gọi API từ chối đơn
    rejectApplicationAPI(currentApplication.id);
}

// Hiển thị modal nhập mật khẩu
function showPasswordModal(app) {
    const modalBody = document.getElementById('applicationDetailBody');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-12">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Xác nhận tạo tài khoản CTV</strong>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-user me-2"></i>Thông tin CTV sẽ được tạo</h6>
                <div class="info-card">
                    <p><strong>Tên:</strong> ${app.full_name || app.name || 'N/A'}</p>
                    <p><strong>SĐT:</strong> ${app.phone || 'N/A'}</p>
                    <p><strong>Email:</strong> ${app.email || 'N/A'}</p>
                    <p><strong>Mã CTV:</strong> <span class="badge bg-primary">${app.desired_code || app.ctv_code || 'Tự động tạo'}</span></p>
                </div>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-lock me-2"></i>Thiết lập mật khẩu</h6>
                <div class="info-card">
                    <div class="mb-3">
                        <label for="ctvPassword" class="form-label">Mật khẩu đăng nhập:</label>
                        <input type="password" class="form-control" id="ctvPassword" placeholder="Nhập mật khẩu cho CTV">
                        <div class="form-text">Mật khẩu này sẽ được sử dụng để CTV đăng nhập vào hệ thống</div>
                    </div>
                    <div class="mb-3">
                        <label for="ctvPasswordConfirm" class="form-label">Xác nhận mật khẩu:</label>
                        <input type="password" class="form-control" id="ctvPasswordConfirm" placeholder="Nhập lại mật khẩu">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Lưu ý:</strong> Sau khi tạo tài khoản, CTV có thể đăng nhập bằng số điện thoại và mật khẩu này.
                </div>
            </div>
        </div>
    `;
    
    // Cập nhật nút hành động
    const approveBtn = document.getElementById('approveApplicationBtn');
    const rejectBtn = document.getElementById('rejectApplicationBtn');
    
    approveBtn.innerHTML = '<i class="fas fa-check me-1"></i>Tạo tài khoản CTV';
    approveBtn.onclick = () => createCTVAccount(app);
    approveBtn.style.display = 'inline-block';
    
    rejectBtn.innerHTML = '<i class="fas fa-arrow-left me-1"></i>Quay lại';
    rejectBtn.onclick = () => viewApplication(app.id);
    rejectBtn.style.display = 'inline-block';
    
    // Cập nhật tiêu đề modal
    document.querySelector('#applicationDetailModal .modal-title').innerHTML = `
        <i class="fas fa-user-plus me-2"></i>Tạo tài khoản CTV - ${app.full_name || 'N/A'}
    `;
}

// Tạo tài khoản CTV
async function createCTVAccount(app) {
    const password = document.getElementById('ctvPassword').value;
    const passwordConfirm = document.getElementById('ctvPasswordConfirm').value;
    
    if (!password || !passwordConfirm) {
        showAlert('Vui lòng nhập đầy đủ mật khẩu', 'warning');
        return;
    }
    
    if (password !== passwordConfirm) {
        showAlert('Mật khẩu xác nhận không khớp', 'warning');
        return;
    }
    
    if (password.length < 6) {
        showAlert('Mật khẩu phải có ít nhất 6 ký tự', 'warning');
        return;
    }
    
    try {
        const requestData = {
            password_text: password
        };
        
        console.log('Sending approve request:', {
            url: `https://buddyskincare.vn/backend/api/ctv-applications/${app.id}/approve/`,
            method: 'POST',
            data: requestData
        });
        
        // Gọi API approve application (tạo CTV)
        const response = await fetch(`https://buddyskincare.vn/backend/api/ctv-applications/${app.id}/approve/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const result = await response.json();
            showAlert('Đã tạo tài khoản CTV thành công!', 'success');
            
            // Đóng modal và refresh danh sách
            bootstrap.Modal.getInstance(document.getElementById('applicationDetailModal')).hide();
            loadApplications();
            loadCTVs();
        } else {
            const errorText = await response.text();
            console.error('API Error Response:', errorText);
            let errorMessage = 'Không thể tạo tài khoản CTV';
            
            try {
                const error = JSON.parse(errorText);
                errorMessage = error.detail || error.message || errorText;
            } catch (e) {
                errorMessage = errorText;
            }
            
            showAlert(`Lỗi ${response.status}: ${errorMessage}`, 'danger');
        }
    } catch (error) {
        console.error('Error creating CTV account:', error);
        showAlert('Lỗi kết nối, vui lòng thử lại', 'danger');
    }
}

// Test function để debug
async function testAPI() {
    try {
        console.log('Testing API endpoints...');
        
        // Test 1: Check applications
        const appsResponse = await fetch('https://buddyskincare.vn/backend/api/ctv-applications/');
        console.log('Applications API:', appsResponse.status, appsResponse.ok);
        
        // Test 2: Check CTVs
        const ctvsResponse = await fetch('https://buddyskincare.vn/backend/api/ctvs/');
        console.log('CTVs API:', ctvsResponse.status, ctvsResponse.ok);
        
        // Test 3: Check by-phone endpoint
        const phoneResponse = await fetch('https://buddyskincare.vn/backend/api/ctvs/by-phone/?phone=123456789');
        console.log('By-phone API:', phoneResponse.status, phoneResponse.ok);
        
    } catch (error) {
        console.error('Test API error:', error);
    }
}

// API từ chối đơn đăng ký
async function rejectApplicationAPI(applicationId) {
    try {
        const requestData = {
            status: 'rejected',
            agreed: false
        };
        
        console.log('Sending reject request:', {
            url: `https://buddyskincare.vn/backend/api/ctv-applications/${applicationId}/`,
            method: 'PATCH',
            data: requestData
        });
        
        const response = await fetch(`https://buddyskincare.vn/backend/api/ctv-applications/${applicationId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            showAlert('Đã từ chối đơn đăng ký', 'success');
            
            // Đóng modal và refresh danh sách
            bootstrap.Modal.getInstance(document.getElementById('applicationDetailModal')).hide();
            loadApplications();
        } else {
            const errorText = await response.text();
            console.error('API Error Response:', errorText);
            let errorMessage = 'Không thể từ chối đơn đăng ký';
            
            try {
                const error = JSON.parse(errorText);
                errorMessage = error.detail || error.message || errorText;
            } catch (e) {
                errorMessage = errorText;
            }
            
            showAlert(`Lỗi ${response.status}: ${errorMessage}`, 'danger');
        }
    } catch (error) {
        console.error('Error rejecting application:', error);
        showAlert('Lỗi kết nối, vui lòng thử lại', 'danger');
    }
}

function showAddLevelModal() {
    document.getElementById('addLevelForm').reset();
    new bootstrap.Modal(document.getElementById('addLevelModal')).show();
}

async function saveLevel() {
    const name = document.getElementById('levelName').value;
    const commission = document.getElementById('levelCommission').value;
    const description = document.getElementById('levelDescription').value;
    
    if (!name || !commission) {
        showAlert('Vui lòng điền đầy đủ thông tin', 'warning');
        return;
    }
    
    try {
        const response = await fetch('https://buddyskincare.vn/backend/api/ctv-levels/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                commission_percent: parseFloat(commission),
                description: description
            })
        });
        
        if (response.ok) {
            showAlert('Đã thêm cấp độ thành công!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addLevelModal')).hide();
            loadLevels();
        } else {
            const error = await response.json();
            showAlert(`Lỗi: ${error.detail || 'Không thể thêm cấp độ'}`, 'danger');
        }
    } catch (error) {
        console.error('Error creating level:', error);
        showAlert('Lỗi kết nối, vui lòng thử lại', 'danger');
    }
}

async function updateLevel() {
    const id = document.getElementById('editLevelId').value;
    const name = document.getElementById('editLevelName').value;
    const commission = document.getElementById('editLevelCommission').value;
    const description = document.getElementById('editLevelDescription').value;
    
    if (!name || !commission) {
        showAlert('Vui lòng điền đầy đủ thông tin', 'warning');
        return;
    }
    
    // Validate commission percentage
    const commissionNum = parseFloat(commission);
    if (isNaN(commissionNum) || commissionNum < 0 || commissionNum > 100) {
        showAlert('Phần trăm hoa hồng phải từ 0 đến 100', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`https://buddyskincare.vn/backend/api/ctv-levels/${id}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                commission_percent: commissionNum.toFixed(2),
                description: description || ''
            })
        });
        
        if (response.ok) {
            showAlert('Đã cập nhật cấp độ thành công!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editLevelModal')).hide();
            loadLevels();
        } else {
            const errorData = await response.text();
            console.error('Update error response:', errorData);
            let errorMessage = 'Không thể cập nhật cấp độ';
            
            try {
                const errorJson = JSON.parse(errorData);
                if (errorJson.detail) {
                    errorMessage = errorJson.detail;
                } else if (errorJson.commission_percent) {
                    errorMessage = `Lỗi phần trăm hoa hồng: ${errorJson.commission_percent[0]}`;
                } else if (errorJson.name) {
                    errorMessage = `Lỗi tên: ${errorJson.name[0]}`;
                }
            } catch (e) {
                errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            }
            
            showAlert(`Lỗi: ${errorMessage}`, 'danger');
        }
    } catch (error) {
        console.error('Error updating level:', error);
        showAlert('Lỗi kết nối, vui lòng thử lại', 'danger');
    }
}

function editLevel(id) {
    const level = levels.find(l => l.id === id);
    if (!level) return;
    
    // Điền dữ liệu vào form
    document.getElementById('editLevelId').value = level.id;
    document.getElementById('editLevelName').value = level.name || '';
    document.getElementById('editLevelCommission').value = level.commission_percent || '';
    document.getElementById('editLevelDescription').value = level.description || '';
    
    // Hiển thị modal
    new bootstrap.Modal(document.getElementById('editLevelModal')).show();
}

function deleteLevel(id) {
    if (!confirm('Bạn có chắc chắn muốn xóa cấp độ này?')) return;
    
    showAlert('Chức năng xóa cấp độ đang được phát triển', 'info');
}

function viewCTV(id) {
    const ctv = ctvs.find(c => c.id === id);
    if (!ctv) return;
    
    const modalBody = document.getElementById('applicationDetailBody');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Thông tin cá nhân</h6>
                <p><strong>Tên:</strong> ${ctv.full_name || 'N/A'}</p>
                <p><strong>SĐT:</strong> ${ctv.phone || 'N/A'}</p>
                <p><strong>Email:</strong> ${ctv.email || 'N/A'}</p>
                <p><strong>Địa chỉ:</strong> ${ctv.address || 'N/A'}</p>
            </div>
            <div class="col-md-6">
                <h6>Thông tin CTV</h6>
                <p><strong>Mã CTV:</strong> ${ctv.code || 'N/A'}</p>
                <p><strong>Cấp độ:</strong> 
                    <span class="level-badge">
                        ${ctv.level ? ctv.level.name : 'N/A'} (${ctv.level ? ctv.level.commission_percent : 0}%)
                    </span>
                </p>
                <p><strong>Trạng thái:</strong> 
                    <span class="status-badge status-${ctv.is_active ? 'active' : 'inactive'}">
                        ${getCTVStatusText(ctv.is_active)}
                    </span>
                </p>
                <p><strong>Ngày tham gia:</strong> ${formatDate(ctv.joined_at)}</p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-6">
                <h6>Thông tin ngân hàng</h6>
                <p><strong>Ngân hàng:</strong> ${ctv.bank_name || 'N/A'}</p>
                <p><strong>Số tài khoản:</strong> ${ctv.bank_number || 'N/A'}</p>
                <p><strong>Chủ tài khoản:</strong> ${ctv.bank_holder || 'N/A'}</p>
            </div>
            <div class="col-md-6">
                <h6>Thống kê</h6>
                <p><strong>Tổng doanh thu:</strong> ${formatPrice(ctv.total_revenue || 0)}</p>
                <p><strong>Mật khẩu:</strong> 
                    ${ctv.password_text ? `
                        <span id="password-${ctv.id}" class="password-display">••••••••</span>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="togglePassword(${ctv.id}, '${ctv.password_text}')">
                            <i class="fas fa-eye" id="eye-${ctv.id}"></i>
                        </button>
                    ` : 'N/A'}
                </p>
            </div>
        </div>
        ${ctv.cccd_front_url || ctv.cccd_back_url ? `
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Giấy tờ tùy thân</h6>
                    <div class="row">
                        ${ctv.cccd_front_url ? `
                            <div class="col-md-6">
                                <p><strong>CCCD mặt trước:</strong></p>
                                <img src="${ctv.cccd_front_url}" alt="CCCD mặt trước" class="img-fluid" style="max-height: 200px;">
                            </div>
                        ` : ''}
                        ${ctv.cccd_back_url ? `
                            <div class="col-md-6">
                                <p><strong>CCCD mặt sau:</strong></p>
                                <img src="${ctv.cccd_back_url}" alt="CCCD mặt sau" class="img-fluid" style="max-height: 200px;">
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        ` : ''}
    `;
    
    // Update modal title
    document.querySelector('#applicationDetailModal .modal-title').innerHTML = `
        <i class="fas fa-user me-2"></i>Chi tiết CTV - ${ctv.full_name || 'N/A'}
    `;
    
    // Hide action buttons for CTV view
    document.getElementById('approveApplicationBtn').style.display = 'none';
    document.getElementById('rejectApplicationBtn').style.display = 'none';
    
    new bootstrap.Modal(document.getElementById('applicationDetailModal')).show();
}

function editCTV(id) {
    const ctv = ctvs.find(c => c.id === id);
    if (!ctv) return;
    
    // Điền dữ liệu vào form
    document.getElementById('editCTVId').value = ctv.id;
    document.getElementById('editCTVFullName').value = ctv.full_name || '';
    document.getElementById('editCTVPhone').value = ctv.phone || '';
    document.getElementById('editCTVEmail').value = ctv.email || '';
    document.getElementById('editCTVAddress').value = ctv.address || '';
    document.getElementById('editCTVCode').value = ctv.code || '';
    document.getElementById('editCTVBankName').value = ctv.bank_name || '';
    document.getElementById('editCTVBankNumber').value = ctv.bank_number || '';
    document.getElementById('editCTVBankHolder').value = ctv.bank_holder || '';
    document.getElementById('editCTVCCCDFront').value = ctv.cccd_front_url || '';
    document.getElementById('editCTVCCCDBack').value = ctv.cccd_back_url || '';
    document.getElementById('editCTVStatus').value = ctv.is_active ? 'true' : 'false';
    
    // Load levels vào dropdown
    const levelSelect = document.getElementById('editCTVLevel');
    levelSelect.innerHTML = '<option value="">Chọn cấp độ</option>';
    levels.forEach(level => {
        const option = document.createElement('option');
        option.value = level.id;
        option.textContent = `${level.name} (${level.commission_percent}%)`;
        if (ctv.level && ctv.level.id === level.id) {
            option.selected = true;
        }
        levelSelect.appendChild(option);
    });
    
    // Hiển thị modal
    new bootstrap.Modal(document.getElementById('editCTVModal')).show();
}

async function updateCTV() {
    const id = document.getElementById('editCTVId').value;
    const fullName = document.getElementById('editCTVFullName').value;
    const phone = document.getElementById('editCTVPhone').value;
    const email = document.getElementById('editCTVEmail').value;
    const address = document.getElementById('editCTVAddress').value;
    const code = document.getElementById('editCTVCode').value;
    const levelId = document.getElementById('editCTVLevel').value;
    const password = document.getElementById('editCTVPassword').value;
    const isActive = document.getElementById('editCTVStatus').value === 'true';
    const bankName = document.getElementById('editCTVBankName').value;
    const bankNumber = document.getElementById('editCTVBankNumber').value;
    const bankHolder = document.getElementById('editCTVBankHolder').value;
    const cccdFront = document.getElementById('editCTVCCCDFront').value;
    const cccdBack = document.getElementById('editCTVCCCDBack').value;
    
    if (!fullName || !phone || !email || !code || !levelId || !bankName || !bankNumber || !bankHolder) {
        showAlert('Vui lòng điền đầy đủ thông tin bắt buộc', 'warning');
        return;
    }
    
    // Validate level ID
    const levelIdNum = parseInt(levelId);
    if (isNaN(levelIdNum) || levelIdNum <= 0) {
        showAlert('Vui lòng chọn cấp độ hợp lệ', 'warning');
        return;
    }
    
    try {
        const updateData = {
            full_name: fullName,
            phone: phone,
            email: email,
            address: address,
            code: code,
            level_id: levelIdNum, // Sử dụng level_id như serializer mong đợi
            is_active: isActive,
            bank_name: bankName,
            bank_number: bankNumber,
            bank_holder: bankHolder,
            cccd_front_url: cccdFront,
            cccd_back_url: cccdBack
        };
        
        // Chỉ thêm password nếu có nhập
        if (password) {
            updateData.password_text = password;
        }
        
        console.log('🔧 Updating CTV with data:', updateData);
        console.log('🔧 Level ID being sent:', levelId, 'as integer:', levelIdNum);
        
        const response = await fetch(`https://buddyskincare.vn/backend/api/ctvs/${id}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
        });
        
        if (response.ok) {
            showAlert('Đã cập nhật thông tin CTV thành công!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editCTVModal')).hide();
            
            // Refresh CTVs list to show updated level
            await loadCTVs();
            
            // Also refresh levels if we're on the levels tab
            const activeTab = document.querySelector('.ctv-tab.active');
            if (activeTab && activeTab.dataset.tab === 'levels') {
                await loadLevels();
            }
        } else {
            const errorData = await response.text();
            console.error('Update CTV error response:', errorData);
            let errorMessage = 'Không thể cập nhật thông tin CTV';
            
            try {
                const errorJson = JSON.parse(errorData);
                if (errorJson.detail) {
                    errorMessage = errorJson.detail;
                } else if (errorJson.level_id) {
                    errorMessage = `Lỗi cấp độ: ${errorJson.level_id[0]}`;
                } else if (errorJson.code) {
                    errorMessage = `Lỗi mã CTV: ${errorJson.code[0]}`;
                } else if (errorJson.email) {
                    errorMessage = `Lỗi email: ${errorJson.email[0]}`;
                } else if (errorJson.phone) {
                    errorMessage = `Lỗi số điện thoại: ${errorJson.phone[0]}`;
                }
            } catch (e) {
                errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            }
            
            showAlert(`Lỗi: ${errorMessage}`, 'danger');
        }
    } catch (error) {
        console.error('Error updating CTV:', error);
        showAlert('Lỗi kết nối, vui lòng thử lại', 'danger');
    }
}

// View CTV orders
async function viewCTVOrders(ctvCode) {
    if (!ctvCode) {
        showAlert('Không có mã CTV', 'warning');
        return;
    }
    
    try {
        // Show loading state
        const modalBody = document.getElementById('applicationDetailBody');
        modalBody.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Đang tải...</span></div><p class="text-muted mt-2">Đang tải đơn hàng CTV...</p></div>';
        
        // Apply default 7-day filter on backend
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const today = new Date();
        today.setHours(23, 59, 59, 999);
        
        // Format dates for backend
        const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];
        const todayStr = today.toISOString().split('T')[0];
        
        // Build backend filter URL
        const ordersUrl = new URL('https://buddyskincare.vn/backend/api/orders/');
        ordersUrl.searchParams.append('collaborator_code', ctvCode);
        ordersUrl.searchParams.append('order_date__gte', sevenDaysAgoStr + 'T00:00:00');
        ordersUrl.searchParams.append('order_date__lte', todayStr + 'T23:59:59');
        
        // Fetch CTV info and filtered orders from backend
        const [ordersResponse, ctvResponse] = await Promise.all([
            fetch(ordersUrl.toString()),
            fetch(`https://buddyskincare.vn/backend/api/ctvs/by-code/?code=${ctvCode}`)
        ]);
        
        if (!ordersResponse.ok || !ctvResponse.ok) {
            throw new Error('Failed to load data');
        }
        
        const orders = await ordersResponse.json();
        const ctvInfo = await ctvResponse.json();
        
        // Debug: Log orders to see the data structure
        console.log('🔍 View CTV Orders - First 3 orders:', orders.slice(0, 3));
        if (orders.length > 0) {
            console.log('🔍 First view order structure:', Object.keys(orders[0]));
            console.log('🔍 First view order status field:', orders[0].status);
            console.log('🔍 First view order is_confirmed field:', orders[0].is_confirmed);
        }
        
        // Create modal content
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-12">
                    <h6>Đơn hàng của CTV: <strong>${ctvCode}</strong></h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Lọc theo ngày:</label>
                            <div class="input-group">
                                <input type="date" id="startDate" class="form-control" value="${getDateDaysAgo(7)}">
                                <span class="input-group-text">đến</span>
                                <input type="date" id="endDate" class="form-control" value="${getTodayDate()}">
                                <button class="btn btn-outline-primary" onclick="filterCTVOrders('${ctvCode}')">
                                    <i class="fas fa-filter"></i> Lọc
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-secondary" onclick="setDateRange('${ctvCode}', 7)">7 ngày</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="setDateRange('${ctvCode}', 30)">30 ngày</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="setDateRange('${ctvCode}', 90)">90 ngày</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="setDateRange('${ctvCode}', 0)">Tất cả</button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <p class="text-muted">Tổng cộng: <span id="orderCount">${orders.length}</span> đơn hàng</p>
                        </div>
                        <div class="col-md-4">
                            <p class="text-success">Tổng lợi nhuận: <span id="totalProfit" class="fw-bold">${formatPrice(calculateTotalProfit(orders) )}</span></p>
                        </div>
                        <div class="col-md-4">
                            <p class="text-primary">Tổng hoa hồng: <span id="totalCommission" class="fw-bold">${formatPrice(calculateTotalCommission(orders, ctvInfo))}</span></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                Công thức tính hoa hồng: (Tổng tiền - Phí ship - Giảm giá - Giá nhập) × % hoa hồng CTV
                                ${ctvInfo && ctvInfo.level ? ` (${ctvInfo.level.commission_percent}%)` : ' (10%)'}
                            </small>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Mã đơn</th>
                                    <th>Khách hàng</th>
                                    <th>SĐT</th>
                                    <th>Tổng tiền</th>
                                    <th>Lợi nhuận</th>
                                    <th>Hoa hồng</th>
                                    <th>Trạng thái</th>
                                    <th>Ngày đặt</th>
                                </tr>
                            </thead>
                            <tbody id="ctvOrdersTableBody">
                                ${renderCTVOrdersTable(orders, ctvInfo)}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        // Update modal title
        document.querySelector('#applicationDetailModal .modal-title').innerHTML = `
            <i class="fas fa-shopping-cart me-2"></i>Đơn hàng CTV - ${ctvCode}
        `;
        
        // Hide action buttons
        document.getElementById('approveApplicationBtn').style.display = 'none';
        document.getElementById('rejectApplicationBtn').style.display = 'none';
        
        new bootstrap.Modal(document.getElementById('applicationDetailModal')).show();
        
    } catch (error) {
        console.error('Error loading CTV orders:', error);
        showAlert('Lỗi khi tải danh sách đơn hàng', 'danger');
    }
}

function exportApplications() {
    if (applications.length === 0) {
        showAlert('Không có dữ liệu để xuất', 'warning');
        return;
    }
    
    // Create Excel content
    const headers = ['ID', 'Tên', 'SĐT', 'Email', 'Địa chỉ', 'Mã CTV', 'Trạng thái', 'Ngày đăng ký'];
    const data = applications.map(app => [
        app.id,
        app.full_name || app.name || 'N/A',
        app.phone || 'N/A',
        app.email || 'N/A',
        app.address || 'N/A',
        app.desired_code || app.ctv_code || 'N/A',
        getStatusText(app.status),
        formatDate(app.created_at)
    ]);
    
    exportToExcel(headers, data, 'don_dang_ky_ctv');
    showAlert('Đã xuất danh sách đơn đăng ký', 'success');
}

function exportCTVs() {
    if (ctvs.length === 0) {
        showAlert('Không có dữ liệu để xuất', 'warning');
        return;
    }
    
    // Create Excel content
    const headers = ['ID', 'Tên', 'SĐT', 'Email', 'Mã CTV', 'Cấp độ', 'Hoa hồng (%)', 'Trạng thái', 'Ngày tạo'];
    const data = ctvs.map(ctv => [
        ctv.id,
        ctv.full_name || ctv.name || 'N/A',
        ctv.phone || 'N/A',
        ctv.email || 'N/A',
        ctv.code || ctv.desired_code || ctv.ctv_code || 'N/A',
        ctv.level ? ctv.level.name : 'N/A',
        ctv.level ? ctv.level.commission_percent : 0,
        getCTVStatusText(ctv.is_active),
        formatDate(ctv.joined_at)
    ]);
    
    exportToExcel(headers, data, 'danh_sach_ctv');
    showAlert('Đã xuất danh sách CTV', 'success');
}

function exportToExcel(headers, data, filename) {
    const htmlContent = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" 
              xmlns:x="urn:schemas-microsoft-com:office:excel" 
              xmlns="http://www.w3.org/TR/REC-html40">
        <head>
            <meta charset="utf-8">
            <meta name="ExcelCreated" content="1">
            <style>
                table { border-collapse: collapse; width: 100%; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; font-weight: bold; }
            </style>
        </head>
        <body>
            <table>
                <tr>
                    ${headers.map(h => `<th>${h}</th>`).join('')}
                </tr>
                ${data.map(row => `
                    <tr>
                        ${row.map(cell => `<td>${cell}</td>`).join('')}
                    </tr>
                `).join('')}
            </table>
        </body>
        </html>
    `;
    
    const blob = new Blob([htmlContent], { type: 'application/vnd.ms-excel' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${filename}_${new Date().toISOString().split('T')[0]}.xls`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Withdrawal functions
let withdrawals = [];
let currentWithdrawalId = null;

// Load withdrawals data
async function loadWithdrawals() {
    try {
        const response = await fetch('https://buddyskincare.vn/backend/api/ctv-withdrawals/');
        if (!response.ok) {
            throw new Error('Failed to load withdrawals');
        }
        withdrawals = await response.json();
        renderWithdrawals();
        updateStats(); // Update stats after loading withdrawals
    } catch (error) {
        console.error('Error loading withdrawals:', error);
        showAlert('Lỗi khi tải dữ liệu yêu cầu rút tiền', 'danger');
    }
}

// Render withdrawals table
function renderWithdrawals() {
    const tbody = document.getElementById('withdrawalsTableBody');
    
    if (!withdrawals || withdrawals.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center">
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>Chưa có yêu cầu rút tiền nào</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = withdrawals.map(withdrawal => `
        <tr>
            <td>${withdrawal.id}</td>
            <td>
                <strong>${withdrawal.ctv_name || 'N/A'}</strong><br>
                <small class="text-muted">${withdrawal.ctv_code || 'N/A'}</small>
            </td>
            <td>${withdrawal.ctv_phone || 'N/A'}</td>
            <td><strong>${formatPrice(withdrawal.amount/1000)}</strong></td>
            <td>
                <span class="status-badge status-${withdrawal.status}">
                    ${getWithdrawalStatusText(withdrawal.status)}
                </span>
            </td>
            <td>${formatDate(withdrawal.requested_at)}</td>
            <td>${withdrawal.processed_at ? formatDate(withdrawal.processed_at) : '-'}</td>
            <td>${withdrawal.note || '-'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewWithdrawal(${withdrawal.id})">
                    <i class="fas fa-eye"></i>
                </button>
                ${withdrawal.status === 'pending' ? `
                    <button class="btn btn-sm btn-success" onclick="approveWithdrawal(${withdrawal.id})">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="rejectWithdrawal(${withdrawal.id})">
                        <i class="fas fa-times"></i>
                    </button>
                ` : ''}
            </td>
        </tr>
    `).join('');
}

// View withdrawal details
function viewWithdrawal(id) {
    const withdrawal = withdrawals.find(w => w.id === id);
    if (!withdrawal) return;

    const modalBody = document.getElementById('withdrawalDetailBody');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Thông tin CTV</h6>
                <p><strong>Tên:</strong> ${withdrawal.ctv_name || 'N/A'}</p>
                <p><strong>Mã CTV:</strong> ${withdrawal.ctv_code || 'N/A'}</p>
                <p><strong>SĐT:</strong> ${withdrawal.ctv_phone || 'N/A'}</p>
                <p><strong>Email:</strong> ${withdrawal.ctv_email || 'N/A'}</p>
            </div>
            <div class="col-md-6">
                <h6>Thông tin yêu cầu</h6>
                <p><strong>Số tiền:</strong> <span class="text-success fw-bold">${formatPrice(withdrawal.amount/1000)}</span></p>
                <p><strong>Trạng thái:</strong> 
                    <span class="status-badge status-${withdrawal.status}">
                        ${getWithdrawalStatusText(withdrawal.status)}
                    </span>
                </p>
                <p><strong>Ngày yêu cầu:</strong> ${formatDate(withdrawal.requested_at)}</p>
                <p><strong>Ngày xử lý:</strong> ${withdrawal.processed_at ? formatDate(withdrawal.processed_at) : 'Chưa xử lý'}</p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-6">
                <h6>Thông tin ngân hàng</h6>
                <p><strong>Ngân hàng:</strong> ${withdrawal.ctv_bank_name || 'N/A'}</p>
                <p><strong>Số tài khoản:</strong> ${withdrawal.ctv_bank_number || 'N/A'}</p>
                <p><strong>Chủ tài khoản:</strong> ${withdrawal.ctv_bank_holder || 'N/A'}</p>
            </div>
            <div class="col-md-6">
                <h6>Thông tin ví</h6>
                <p><strong>Số dư hiện tại:</strong> <span class="text-muted">Liên hệ CTV để biết chi tiết</span></p>
                <p><strong>Đang chờ:</strong> <span class="text-muted">Liên hệ CTV để biết chi tiết</span></p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Ghi chú</h6>
                <textarea class="form-control" id="withdrawalNote" rows="3" placeholder="Thêm ghi chú...">${withdrawal.note || ''}</textarea>
            </div>
        </div>
    `;

    // Update modal title
    document.querySelector('#withdrawalDetailModal .modal-title').innerHTML = `
        <i class="fas fa-money-bill-wave me-2"></i>Chi tiết yêu cầu rút tiền #${withdrawal.id}
    `;

    // Show/hide action buttons based on status
    const approveBtn = document.getElementById('approveWithdrawalBtn');
    const rejectBtn = document.getElementById('rejectWithdrawalBtn');
    
    if (withdrawal.status === 'pending') {
        approveBtn.style.display = 'inline-block';
        rejectBtn.style.display = 'inline-block';
    } else {
        approveBtn.style.display = 'none';
        rejectBtn.style.display = 'none';
    }

    currentWithdrawalId = withdrawal.id;
    new bootstrap.Modal(document.getElementById('withdrawalDetailModal')).show();
}

// Approve withdrawal
async function approveWithdrawal(id = null) {
    const withdrawalId = id || currentWithdrawalId;
    if (!withdrawalId) return;

    const note = document.getElementById('withdrawalNote')?.value || '';
    
    if (!confirm('Bạn có chắc chắn muốn duyệt yêu cầu rút tiền này?')) {
        return;
    }

    try {
        const response = await fetch(`https://buddyskincare.vn/backend/api/ctv-withdrawals/${withdrawalId}/approve/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                note: note
            })
        });

        if (!response.ok) {
            throw new Error('Failed to approve withdrawal');
        }

        showAlert('Đã duyệt yêu cầu rút tiền thành công', 'success');
        bootstrap.Modal.getInstance(document.getElementById('withdrawalDetailModal')).hide();
        loadWithdrawals();
    } catch (error) {
        console.error('Error approving withdrawal:', error);
        showAlert('Lỗi khi duyệt yêu cầu rút tiền', 'danger');
    }
}

// Reject withdrawal
async function rejectWithdrawal(id = null) {
    const withdrawalId = id || currentWithdrawalId;
    if (!withdrawalId) return;

    const note = document.getElementById('withdrawalNote')?.value || '';
    
    if (!confirm('Bạn có chắc chắn muốn từ chối yêu cầu rút tiền này?')) {
        return;
    }

    try {
        const response = await fetch(`https://buddyskincare.vn/backend/api/ctv-withdrawals/${withdrawalId}/reject/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                note: note
            })
        });

        if (!response.ok) {
            throw new Error('Failed to reject withdrawal');
        }

        showAlert('Đã từ chối yêu cầu rút tiền', 'warning');
        bootstrap.Modal.getInstance(document.getElementById('withdrawalDetailModal')).hide();
        loadWithdrawals();
    } catch (error) {
        console.error('Error rejecting withdrawal:', error);
        showAlert('Lỗi khi từ chối yêu cầu rút tiền', 'danger');
    }
}

// Export withdrawals to Excel
function exportWithdrawals() {
    if (!withdrawals || withdrawals.length === 0) {
        showAlert('Không có dữ liệu để xuất', 'warning');
        return;
    }

    const headers = [
        'ID', 'Tên CTV', 'Mã CTV', 'SĐT', 'Email', 'Số tiền', 'Trạng thái', 
        'Ngày yêu cầu', 'Ngày xử lý', 'Ghi chú', 'Ngân hàng', 'Số TK', 'Chủ TK'
    ];

    const data = withdrawals.map(withdrawal => [
        withdrawal.id,
        withdrawal.ctv_name || 'N/A',
        withdrawal.ctv_code || 'N/A',
        withdrawal.ctv_phone || 'N/A',
        withdrawal.ctv_email || 'N/A',
        withdrawal.amount,
        getWithdrawalStatusText(withdrawal.status),
        formatDate(withdrawal.requested_at),
        withdrawal.processed_at ? formatDate(withdrawal.processed_at) : 'Chưa xử lý',
        withdrawal.note || '',
        withdrawal.ctv_bank_name || 'N/A',
        withdrawal.ctv_bank_number || 'N/A',
        withdrawal.ctv_bank_holder || 'N/A'
    ]);

    exportToExcel(headers, data, 'yeu_cau_rut_tien_ctv');
    showAlert('Đã xuất danh sách yêu cầu rút tiền', 'success');
}

// Helper function for withdrawal status
function getWithdrawalStatusText(status) {
    const statusMap = {
        'pending': 'Chờ duyệt',
        'approved': 'Đã duyệt',
        'rejected': 'Từ chối'
    };
    return statusMap[status] || 'Không xác định';
}

// Gửi email chào mừng CTV
async function sendWelcomeEmail(ctvId, ctvName, ctvEmail, buttonElement) {
    if (!ctvEmail) {
        showAlert('Lỗi', 'CTV chưa có email để gửi thư chúc mừng!', 'warning');
        return;
    }

    // Disable button to prevent multiple clicks
    const originalText = buttonElement.innerHTML;
    buttonElement.disabled = true;
    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    try {
        const response = await fetch(`https://buddyskincare.vn/backend/api/ctvs/${ctvId}/send-welcome-email/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                ctv_id: ctvId,
                ctv_name: ctvName,
                ctv_email: ctvEmail
            })
        });

        const result = await response.json();

        if (result.success) {
            showAlert('🎉 Gửi email thành công', result.message, 'success');
        } else {
            showAlert('❌ Lỗi gửi email', result.message, 'danger');
        }
    } catch (error) {
        console.error('Error sending welcome email:', error);
        showAlert('❌ Lỗi kết nối', 'Không thể gửi email. Vui lòng thử lại sau.', 'danger');
    } finally {
        // Re-enable button
        buttonElement.disabled = false;
        buttonElement.innerHTML = originalText;
    }
}

// ===== ALL CTV ORDERS FUNCTIONS =====

// Load all CTV orders
async function loadAllCTVOrders() {
    try {
        // Auto-set date filters: 7 days ago to today
        const today = new Date();
        const sevenDaysAgo = new Date(today);
        sevenDaysAgo.setDate(today.getDate() - 7);
        
        // Format dates for input fields (YYYY-MM-DD)
        const todayStr = today.toISOString().split('T')[0];
        const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];
        
        // Set default date values
        document.getElementById('filterStartDate').value = sevenDaysAgoStr;
        document.getElementById('filterEndDate').value = todayStr;
        
        console.log('📅 Auto-set date filters:', {
            from: sevenDaysAgoStr,
            to: todayStr
        });
        
        const tbody = document.getElementById('allCTVOrdersTableBody');
        tbody.innerHTML = '<tr><td colspan="10" class="text-center"><div class="loading-spinner"><i class="fas fa-spinner fa-spin me-2"></i>Đang tải...</div></td></tr>';
        
        // Load CTV codes for filter
        await loadCTVCodeFilter();
        
        // Load CTVs first to get active CTV codes
        const ctvsResponse = await fetch('/ctvs/');
        if (!ctvsResponse.ok) throw new Error('Failed to load CTVs');
        
        const ctvs = await ctvsResponse.json();
        
        // Get list of active CTV codes
        const activeCTVCodes = ctvs
            .filter(ctv => ctv.is_active && ctv.code)
            .map(ctv => ctv.code);
        
        console.log('📋 Active CTV codes:', activeCTVCodes);
        
        // Build backend filter URL for CTV orders with date range
        const ordersUrl = new URL('https://buddyskincare.vn/backend/api/orders/');
        
        // Filter by date range (last 7 days)
        ordersUrl.searchParams.append('order_date__gte', sevenDaysAgoStr + 'T00:00:00');
        ordersUrl.searchParams.append('order_date__lte', todayStr + 'T23:59:59');
        
        // Filter by collaborator_code (only orders with CTV codes)
        ordersUrl.searchParams.append('collaborator_code__isnull', 'false');
        
        console.log('🔍 Backend filter URL:', ordersUrl.toString());
        
        // Load filtered orders from backend
        const ordersResponse = await fetch(ordersUrl.toString());
        if (!ordersResponse.ok) throw new Error('Failed to load orders');
        
        const allOrders = await ordersResponse.json();
        
        // Debug: Log first few orders to see the data structure
        console.log('🔍 API Response - First 3 orders:', allOrders.slice(0, 3));
        if (allOrders.length > 0) {
            console.log('🔍 First order structure:', Object.keys(allOrders[0]));
            console.log('🔍 First order status field:', allOrders[0].status);
            console.log('🔍 First order is_confirmed field:', allOrders[0].is_confirmed);
        }
        
        // Filter orders that have collaborator_code matching active CTV codes
        // This is a small filter since backend already filtered by date and CTV existence
        let ctvOrders = allOrders.filter(order => {
            const hasCTVCode = order.collaborator_code && order.collaborator_code.trim() !== '';
            const isActiveCTV = activeCTVCodes.includes(order.collaborator_code);
            return hasCTVCode && isActiveCTV;
        });
        
        console.log(`📊 Total orders: ${allOrders.length}, CTV orders: ${ctvOrders.length}, Filtered (last 7 days): ${ctvOrders.length}`);
        
        // Update statistics and render table
        updateAllCTVOrdersStats(ctvOrders, ctvs);
        renderAllCTVOrdersTable(ctvOrders, ctvs);
        
    } catch (error) {
        console.error('Error loading all CTV orders:', error);
        document.getElementById('allCTVOrdersTableBody').innerHTML = 
            '<tr><td colspan="10" class="text-center text-danger">Lỗi khi tải dữ liệu</td></tr>';
    }
}

// Load CTV codes for filter dropdown
async function loadCTVCodeFilter() {
    try {
        const response = await fetch('/ctvs/');
        if (!response.ok) throw new Error('Failed to load CTVs');
        
        const ctvs = await response.json();
        const select = document.getElementById('filterCTVCode');
        
        select.innerHTML = '<option value="">Tất cả CTV</option>';
        ctvs.forEach(ctv => {
            if (ctv.is_active) {
                const option = document.createElement('option');
                option.value = ctv.code;
                option.textContent = `${ctv.code} - ${ctv.full_name}`;
                select.appendChild(option);
            }
        });
    } catch (error) {
        console.error('Error loading CTV codes:', error);
    }
}

// Render all CTV orders table
function renderAllCTVOrdersTable(orders, ctvs = []) {
    const tbody = document.getElementById('allCTVOrdersTableBody');
    
    console.log('📋 Rendering CTV orders:', orders?.length || 0, 'orders');
    
    if (!orders || orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">Không có đơn hàng nào</td></tr>';
        return;
    }
    
    // Show all CTV orders (including pending/unconfirmed ones)
    // Only exclude cancelled orders
    const validOrders = orders.filter(order => order.status !== 'cancelled');
    
    console.log('✅ Valid CTV orders (excluding cancelled):', validOrders.length);
    
    // Create CTV mapping for quick lookup (name and full object)
    const ctvNameMap = {};
    const ctvObjectMap = {};
    ctvs.forEach(ctv => {
        if (ctv.code) {
            ctvNameMap[ctv.code] = ctv.full_name || ctv.name || ctv.code;
            ctvObjectMap[ctv.code] = ctv; // Store full CTV object for commission calculation
        }
    });
    
    tbody.innerHTML = validOrders.map(order => {
        // Debug logging to see order data
        console.log('🔍 All CTV Orders - Order data:', order);
        console.log('🔍 All CTV Orders - Order status:', order.status, 'type:', typeof order.status);
        
        // Calculate profit and commission
        const profit = calculateOrderProfit(order);
        
        // Get CTV info for commission calculation
        const ctvInfo = ctvObjectMap[order.collaborator_code] || null;
        const commission = calculateOrderCommission(order, profit, ctvInfo);
        
        // Get CTV name from mapping
        const ctvName = ctvNameMap[order.collaborator_code] || order.collaborator_code || 'N/A';
        
        return `
            <tr>
                <td><strong>${order.order_code || `#${order.id}`}</strong></td>
                <td><span class="badge bg-info">${order.collaborator_code || 'N/A'}</span></td>
                <td><span class="badge bg-secondary">${ctvName}</span></td>
                <td>${order.customer_name || 'N/A'}</td>
                <td>${order.phone_number || 'N/A'}</td>
                <td class="text-success fw-bold">${formatPrice(order.total_amount)}</td>
                <td class="text-warning">${formatPrice(profit)}</td>
                <td class="text-primary fw-bold" title="Chi tiết: ${getCommissionDetail(order, ctvInfo)}">${formatPrice(commission)}</td>
                <td>
                    <span class="status-badge status-${order.status || 'pending'}">
                        ${getOrderStatusText(order.status)}
                    </span>
                </td>
                <td>${formatDate(order.order_date)}</td>
            </tr>
        `;
    }).join('');
}

// Update statistics for all CTV orders
function updateAllCTVOrdersStats(orders, ctvs = []) {
    console.log('📊 Updating statistics for', orders?.length || 0, 'orders');
    
    if (!orders || orders.length === 0) {
        document.getElementById('statsTotalOrders').textContent = '0';
        document.getElementById('statsTotalRevenue').textContent = '0đ';
        document.getElementById('statsTotalProfit').textContent = '0đ';
        document.getElementById('statsTotalCommission').textContent = '0đ';
        return;
    }
    
    // Create CTV mapping for commission calculation
    const ctvObjectMap = {};
    ctvs.forEach(ctv => {
        if (ctv.code) {
            ctvObjectMap[ctv.code] = ctv;
        }
    });
    
    // Calculate statistics
    let totalOrders = 0;
    let totalRevenue = 0;
    let totalProfit = 0;
    let totalCommission = 0;
    
    orders.forEach(order => {
        if (order.status !== 'cancelled') {
            totalOrders++;
            
            // Total revenue (convert to VND for display)
            const revenue = parseFloat(order.total_amount || 0) ;
            totalRevenue += revenue;
            
            // Calculate profit
            const profit = calculateOrderProfit(order) ; // Convert to VND
            totalProfit += profit;
            
            // Calculate commission with CTV info
            const ctvInfo = ctvObjectMap[order.collaborator_code] || null;
            const commission = calculateOrderCommission(order, calculateOrderProfit(order), ctvInfo) ; // Convert to VND
            totalCommission += commission;
        }
    });
    
    // Update UI
    document.getElementById('statsTotalOrders').textContent = totalOrders.toLocaleString('vi-VN');
    document.getElementById('statsTotalRevenue').textContent = formatPrice(totalRevenue);
    document.getElementById('statsTotalProfit').textContent = formatPrice(totalProfit);
    document.getElementById('statsTotalCommission').textContent = formatPrice(totalCommission);
    
    console.log('📊 Statistics updated:', {
        totalOrders,
        totalRevenue: formatPrice(totalRevenue),
        totalProfit: formatPrice(totalProfit),
        totalCommission: formatPrice(totalCommission)
    });
}

// Filter all CTV orders
async function filterAllCTVOrders() {
    try {
        const ctvCode = document.getElementById('filterCTVCode').value;
        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;
        
        const tbody = document.getElementById('allCTVOrdersTableBody');
        tbody.innerHTML = '<tr><td colspan="10" class="text-center"><div class="loading-spinner"><i class="fas fa-spinner fa-spin me-2"></i>Đang lọc...</div></td></tr>';
        
        // Load all orders and CTVs in parallel
        const [ordersResponse, ctvsResponse] = await Promise.all([
            fetch('/orders/'),
            fetch('/ctvs/')
        ]);
        
        if (!ordersResponse.ok) throw new Error('Failed to load orders');
        if (!ctvsResponse.ok) throw new Error('Failed to load CTVs');
        
        const allOrders = await ordersResponse.json();
        const ctvs = await ctvsResponse.json();
        
        // Get list of active CTV codes
        const activeCTVCodes = ctvs
            .filter(ctv => ctv.is_active && ctv.code)
            .map(ctv => ctv.code);
        
        // Filter orders that have collaborator_code matching active CTV codes
        let ctvOrders = allOrders.filter(order => {
            const hasCTVCode = order.collaborator_code && order.collaborator_code.trim() !== '';
            const isActiveCTV = activeCTVCodes.includes(order.collaborator_code);
            return hasCTVCode && isActiveCTV;
        });
        
        // Apply additional filters
        if (ctvCode) {
            ctvOrders = ctvOrders.filter(order => order.collaborator_code === ctvCode);
        }
        
        if (startDate) {
            ctvOrders = ctvOrders.filter(order => {
                const orderDate = new Date(order.order_date);
                const filterStartDate = new Date(startDate);
                return orderDate >= filterStartDate;
            });
        }
        
        if (endDate) {
            ctvOrders = ctvOrders.filter(order => {
                const orderDate = new Date(order.order_date);
                const filterEndDate = new Date(endDate);
                filterEndDate.setHours(23, 59, 59, 999); // End of day
                return orderDate <= filterEndDate;
            });
        }
        
        console.log(`🔍 Filtered CTV orders: ${ctvOrders.length}`);
        
        // Update statistics and render table
        updateAllCTVOrdersStats(ctvOrders, ctvs);
        renderAllCTVOrdersTable(ctvOrders, ctvs);
        
    } catch (error) {
        console.error('Error filtering orders:', error);
        showAlert('Lỗi khi lọc đơn hàng', 'danger');
    }
}

// Export all CTV orders to Excel
function exportAllCTVOrders() {
    const tbody = document.getElementById('allCTVOrdersTableBody');
    const rows = tbody.querySelectorAll('tr');
    
    if (rows.length === 0 || rows[0].textContent.includes('Không có đơn hàng')) {
        showAlert('Không có dữ liệu để xuất', 'warning');
        return;
    }
    
    // Get current statistics
    const totalOrders = document.getElementById('statsTotalOrders').textContent;
    const totalRevenue = document.getElementById('statsTotalRevenue').textContent;
    const totalProfit = document.getElementById('statsTotalProfit').textContent;
    const totalCommission = document.getElementById('statsTotalCommission').textContent;
    
    let csv = '=== THỐNG KÊ TỔNG QUAN ===\n';
    csv += `Tổng đơn hàng,${totalOrders}\n`;
    csv += `Tổng doanh thu,${totalRevenue}\n`;
    csv += `Tổng lợi nhuận,${totalProfit}\n`;
    csv += `Tổng hoa hồng,${totalCommission}\n`;
    csv += '\n=== CHI TIẾT ĐƠN HÀNG ===\n';
    csv += 'Mã đơn,CTV Code,CTV,Khách hàng,SĐT,Tổng tiền,Lợi nhuận,Hoa hồng,Trạng thái,Ngày đặt\n';
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 10) {
            const orderCode = cells[0].textContent.trim();
            const ctvCode = cells[1].textContent.trim();
            const ctvName = cells[2].textContent.trim();
            const customer = cells[3].textContent.trim();
            const phone = cells[4].textContent.trim();
            const total = cells[5].textContent.trim();
            const profit = cells[6].textContent.trim();
            const commission = cells[7].textContent.trim();
            const status = cells[8].textContent.trim();
            const date = cells[9].textContent.trim();
            
            csv += `"${orderCode}","${ctvCode}","${ctvName}","${customer}","${phone}","${total}","${profit}","${commission}","${status}","${date}"\n`;
        }
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `don-hang-ctv-${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('Đã xuất file Excel thành công', 'success');
}

// ===== CTV WALLETS FUNCTIONS =====

// Load CTV wallets
async function loadCTVWallets() {
    try {
        const tbody = document.getElementById('ctvWalletsTableBody');
        tbody.innerHTML = '<tr><td colspan="10" class="text-center"><div class="loading-spinner"><i class="fas fa-spinner fa-spin me-2"></i>Đang tải...</div></td></tr>';
        
        // Load CTV codes for filter
        await loadWalletCTVCodeFilter();
        
        // Load CTVs with wallet information
        const response = await fetch('/ctvs/');
        if (!response.ok) throw new Error('Failed to load CTVs');
        
        const ctvs = await response.json();
        console.log('📊 Loaded CTVs:', ctvs.length);
        
        // Calculate total_withdrawn for each CTV from withdrawals
        for (let ctv of ctvs) {
            try {
                const withdrawalsResponse = await fetch(`/ctvs/${ctv.id}/withdrawals/`);
                if (withdrawalsResponse.ok) {
                    const withdrawals = await withdrawalsResponse.json();
                    const totalWithdrawn = withdrawals
                        .filter(w => w.status === 'approved')
                        .reduce((sum, w) => sum + parseFloat(w.amount), 0);
                    ctv.total_withdrawn = totalWithdrawn;
                    console.log(`💰 CTV ${ctv.code}: total_withdrawn = ${totalWithdrawn}`);
                }
            } catch (error) {
                console.error(`Error loading withdrawals for CTV ${ctv.code}:`, error);
                ctv.total_withdrawn = 0;
            }
        }
        
        // Render wallets table
        renderCTVWalletsTable(ctvs);
        
    } catch (error) {
        console.error('Error loading CTV wallets:', error);
        document.getElementById('ctvWalletsTableBody').innerHTML = 
            '<tr><td colspan="10" class="text-center text-danger">Lỗi khi tải dữ liệu</td></tr>';
    }
}

// Load CTV codes for wallet filter dropdown
async function loadWalletCTVCodeFilter() {
    try {
        const response = await fetch('/ctvs/');
        if (!response.ok) throw new Error('Failed to load CTVs');
        
        const ctvs = await response.json();
        const select = document.getElementById('filterWalletCTVCode');
        
        // Clear existing options except first one
        select.innerHTML = '<option value="">Tất cả CTV</option>';
        
        // Add CTV options
        ctvs.forEach(ctv => {
            if (ctv.code && ctv.is_active) {
                const option = document.createElement('option');
                option.value = ctv.code;
                option.textContent = `${ctv.code} - ${ctv.full_name || ctv.name || 'N/A'}`;
                select.appendChild(option);
            }
        });
        
        console.log('📋 Loaded CTV codes for wallet filter:', ctvs.length);
        
    } catch (error) {
        console.error('Error loading CTV codes for wallet filter:', error);
    }
}

// Render CTV wallets table
function renderCTVWalletsTable(ctvs) {
    const tbody = document.getElementById('ctvWalletsTableBody');
    
    console.log('📊 Rendering CTV wallets:', ctvs?.length || 0, 'CTVs');
    
    if (!ctvs || ctvs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">Không có CTV nào</td></tr>';
        return;
    }
    
    tbody.innerHTML = ctvs.map(ctv => {
        const wallet = ctv.wallet || { balance: 0, pending: 0 };
        const totalWithdrawn = ctv.total_withdrawn || 0;
        const totalRevenue = ctv.total_revenue || 0;
        const level = ctv.level || { name: 'N/A', commission_percent: 0 };
        
        return `
            <tr>
                <td><span class="badge bg-info">${ctv.code || 'N/A'}</span></td>
                <td>${ctv.full_name || ctv.name || 'N/A'}</td>
                <td>${ctv.phone || 'N/A'}</td>
                <td class="text-success fw-bold">${formatPrice(wallet.balance)}</td>
                <td class="text-warning">${formatPrice(wallet.pending/1000)}</td>
                <td class="text-info">${formatPrice(totalWithdrawn/1000)}</td>
                <td class="text-primary">${formatPrice(totalRevenue)}</td>
                <td>
                    <span class="badge bg-secondary">${level.name}</span>
                    <small class="text-muted d-block">${level.commission_percent}%</small>
                </td>
                <td>
                    <span class="status-badge ${ctv.is_active ? 'status-active' : 'status-inactive'}">
                        ${ctv.is_active ? 'Đang hoạt động' : 'Không hoạt động'}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewCTVWalletDetail('${ctv.code}')" title="Xem chi tiết ví">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="adjustCTVWallet('${ctv.code}', '${ctv.full_name || ctv.name || ''}')" title="Điều chỉnh ví">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Filter CTV wallets
async function filterCTVWallets() {
    try {
        const ctvCode = document.getElementById('filterWalletCTVCode').value;
        const status = document.getElementById('filterWalletStatus').value;
        
        const tbody = document.getElementById('ctvWalletsTableBody');
        tbody.innerHTML = '<tr><td colspan="10" class="text-center"><div class="loading-spinner"><i class="fas fa-spinner fa-spin me-2"></i>Đang lọc...</div></td></tr>';
        
        // Load CTVs
        const response = await fetch('/ctvs/');
        if (!response.ok) throw new Error('Failed to load CTVs');
        
        let ctvs = await response.json();
        
        // Apply filters
        if (ctvCode) {
            ctvs = ctvs.filter(ctv => ctv.code === ctvCode);
        }
        
        if (status) {
            const isActive = status === 'active';
            ctvs = ctvs.filter(ctv => ctv.is_active === isActive);
        }
        
        // Calculate total_withdrawn for each CTV from withdrawals
        for (let ctv of ctvs) {
            try {
                const withdrawalsResponse = await fetch(`/ctvs/${ctv.id}/withdrawals/`);
                if (withdrawalsResponse.ok) {
                    const withdrawals = await withdrawalsResponse.json();
                    const totalWithdrawn = withdrawals
                        .filter(w => w.status === 'approved')
                        .reduce((sum, w) => sum + parseFloat(w.amount), 0);
                    ctv.total_withdrawn = totalWithdrawn;
                }
            } catch (error) {
                console.error(`Error loading withdrawals for CTV ${ctv.code}:`, error);
                ctv.total_withdrawn = 0;
            }
        }
        
        console.log(`🔍 Filtered CTV wallets: ${ctvs.length}`);
        renderCTVWalletsTable(ctvs);
        
    } catch (error) {
        console.error('Error filtering CTV wallets:', error);
        showAlert('Lỗi khi lọc ví CTV', 'danger');
    }
}

// View CTV wallet detail
async function viewCTVWalletDetail(ctvCode) {
    try {
        // Find CTV by code
        const response = await fetch('/ctvs/');
        if (!response.ok) throw new Error('Failed to load CTVs');
        
        const ctvs = await response.json();
        const ctv = ctvs.find(c => c.code === ctvCode);
        
        if (!ctv) {
            showAlert('Không tìm thấy CTV với mã này', 'warning');
            return;
        }
        
        // Load wallet data
        const walletResponse = await fetch(`/ctvs/${ctv.id}/wallet/`);
        if (!walletResponse.ok) throw new Error('Failed to load wallet');
        
        const wallet = await walletResponse.json();
        
        // Load withdrawals
        const withdrawalsResponse = await fetch(`/ctvs/${ctv.id}/withdrawals/`);
        const withdrawals = withdrawalsResponse.ok ? await withdrawalsResponse.json() : [];
        
        // Calculate total withdrawn
        const totalWithdrawn = withdrawals
            .filter(w => w.status === 'approved')
            .reduce((sum, w) => sum + parseFloat(w.amount), 0);
        
        // Load recent orders for this CTV
        const ordersResponse = await fetch(`/orders/?collaborator_code=${ctvCode}`);
        const orders = ordersResponse.ok ? await ordersResponse.json() : [];
        
        // Render modal content
        const modalBody = document.getElementById('ctvWalletDetailBody');
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-user me-2"></i>Thông tin CTV</h6>
                    <div class="info-card">
                        <p><strong>Tên:</strong> ${ctv.full_name || 'N/A'}</p>
                        <p><strong>Mã CTV:</strong> <span class="badge bg-info">${ctv.code}</span></p>
                        <p><strong>SĐT:</strong> ${ctv.phone || 'N/A'}</p>
                        <p><strong>Email:</strong> ${ctv.email || 'N/A'}</p>
                        <p><strong>Cấp độ:</strong> ${ctv.level?.name || 'N/A'} (${ctv.level?.commission_percent || 0}%)</p>
                        <p><strong>Trạng thái:</strong> 
                            <span class="status-badge ${ctv.is_active ? 'status-active' : 'status-inactive'}">
                                ${ctv.is_active ? 'Đang hoạt động' : 'Không hoạt động'}
                            </span>
                        </p>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-wallet me-2"></i>Thông tin ví</h6>
                    <div class="info-card">
                        <p><strong>Số dư hiện tại:</strong> <span class="text-success fw-bold">${formatPrice(wallet.balance/1000)}</span></p>
                        <p><strong>Đang chờ:</strong> <span class="text-warning">${formatPrice(wallet.pending/1000)}</span></p>
                        <p><strong>Tổng đã rút:</strong> <span class="text-info">${formatPrice(totalWithdrawn/1000)}</span></p>
                        <p><strong>Tổng doanh thu:</strong> <span class="text-primary">${formatPrice(ctv.total_revenue || 0)}</span></p>
                        <p><strong>Cập nhật lần cuối:</strong> ${formatDate(wallet.updated_at)}</p>
                    </div>
                </div>
            </div>
            
            <hr>
            
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-money-bill-wave me-2"></i>Lịch sử rút tiền gần đây</h6>
                    <div class="table-responsive" style="max-height: 300px;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Ngày</th>
                                    <th>Số tiền</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${withdrawals.slice(0, 10).map(w => `
                                    <tr>
                                        <td>${formatDate(w.requested_at)}</td>
                                        <td>${formatPrice(w.amount/1000)}</td>
                                        <td>
                                            <span class="status-badge status-${w.status}">
                                                ${getWithdrawalStatusText(w.status)}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('') || '<tr><td colspan="3" class="text-center text-muted">Chưa có lịch sử rút tiền</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-shopping-cart me-2"></i>Đơn hàng gần đây</h6>
                    <div class="table-responsive" style="max-height: 300px;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Mã đơn</th>
                                    <th>Ngày</th>
                                    <th>Tổng tiền</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${orders.slice(0, 10).map(o => `
                                    <tr>
                                        <td>${o.order_code || '#' + o.id}</td>
                                        <td>${formatDate(o.order_date)}</td>
                                        <td>${formatPrice(o.total_amount)}</td>
                                        <td>
                                            <span class="status-badge status-${o.status}">
                                                ${getOrderStatusText(o.status)}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('') || '<tr><td colspan="4" class="text-center text-muted">Chưa có đơn hàng</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        // Store CTV data for adjustment
        window.currentCTVForAdjustment = ctv;
        window.currentWalletForAdjustment = wallet;
        
        // Update modal title
        document.querySelector('#ctvWalletDetailModal .modal-title').innerHTML = `
            <i class="fas fa-wallet me-2"></i>Chi tiết ví CTV: ${ctv.code}
        `;
        
        new bootstrap.Modal(document.getElementById('ctvWalletDetailModal')).show();
        
    } catch (error) {
        console.error('Error loading wallet detail:', error);
        showAlert('Lỗi khi tải chi tiết ví', 'danger');
    }
}

// Adjust CTV wallet
function adjustCTVWallet(ctvCode, ctvName) {
    // This will be called from the detail modal
    adjustCTVWalletFromDetail();
}

// Adjust CTV wallet from detail modal
function adjustCTVWalletFromDetail() {
    const ctv = window.currentCTVForAdjustment;
    const wallet = window.currentWalletForAdjustment;
    
    if (!ctv || !wallet) {
        showAlert('Không có thông tin CTV để điều chỉnh', 'warning');
        return;
    }
    
    // Fill form data
    document.getElementById('adjustCTVId').value = ctv.id;
    document.getElementById('adjustCTVCode').value = ctv.code;
    document.getElementById('adjustCTVName').value = ctv.full_name || ctv.name || '';
    document.getElementById('adjustCTVCodeDisplay').value = ctv.code;
    document.getElementById('adjustCurrentBalance').value = formatPrice(wallet.balance/1000);
    document.getElementById('adjustCurrentPending').value = formatPrice(wallet.pending/1000);
    
    // Clear form
    document.getElementById('adjustType').value = '';
    document.getElementById('adjustAmount').value = '';
    document.getElementById('adjustReason').value = '';
    
    // Close detail modal and open adjustment modal
    bootstrap.Modal.getInstance(document.getElementById('ctvWalletDetailModal')).hide();
    
    setTimeout(() => {
        new bootstrap.Modal(document.getElementById('ctvWalletAdjustModal')).show();
    }, 300);
}

// Confirm wallet adjustment
async function confirmWalletAdjustment() {
    const ctvId = document.getElementById('adjustCTVId').value;
    const adjustType = document.getElementById('adjustType').value;
    const amount = parseFloat(document.getElementById('adjustAmount').value);
    const reason = document.getElementById('adjustReason').value;
    
    if (!adjustType || !amount || !reason) {
        showAlert('Vui lòng điền đầy đủ thông tin', 'warning');
        return;
    }
    
    if (amount <= 0) {
        showAlert('Số tiền phải lớn hơn 0', 'warning');
        return;
    }
    
    if (!confirm(`Bạn có chắc chắn muốn điều chỉnh ví CTV?\n\nLoại: ${adjustType}\nSố tiền: ${formatPrice(amount)}\nLý do: ${reason}`)) {
        return;
    }
    
    try {
        // Calculate new balance based on adjustment type
        const ctv = window.currentCTVForAdjustment;
        const wallet = window.currentWalletForAdjustment;
        
        let newBalance = parseFloat(wallet.balance);
        
        switch (adjustType) {
            case 'add_balance':
                newBalance += amount;
                break;
            case 'subtract_balance':
                newBalance -= amount;
                if (newBalance < 0) {
                    showAlert('Số dư không thể âm', 'warning');
                    return;
                }
                break;
            case 'set_balance':
                newBalance = amount;
                break;
        }
        
        // Update wallet via API
        const response = await fetch(`/ctvs/${ctvId}/wallet/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                balance: newBalance,
                adjustment_reason: reason,
                adjustment_type: adjustType,
                adjustment_amount: amount
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to update wallet');
        }
        
        showAlert('Đã điều chỉnh ví CTV thành công', 'success');
        bootstrap.Modal.getInstance(document.getElementById('ctvWalletAdjustModal')).hide();
        
        // Reload wallet data
        loadCTVWallets();
        
    } catch (error) {
        console.error('Error adjusting wallet:', error);
        showAlert('Lỗi khi điều chỉnh ví CTV', 'danger');
    }
}

// Export CTV wallets to Excel
function exportCTVWallets() {
    const tbody = document.getElementById('ctvWalletsTableBody');
    const rows = tbody.querySelectorAll('tr');
    
    if (rows.length === 0 || rows[0].textContent.includes('Không có CTV nào')) {
        showAlert('Không có dữ liệu để xuất', 'warning');
        return;
    }
    
    let csv = 'CTV Code,Tên CTV,SĐT,Số dư hiện tại,Đang chờ,Tổng đã rút,Tổng doanh thu,Cấp độ,Trạng thái\n';
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 9) {
            const ctvCode = cells[0].textContent.trim();
            const ctvName = cells[1].textContent.trim();
            const phone = cells[2].textContent.trim();
            const balance = cells[3].textContent.trim();
            const pending = cells[4].textContent.trim();
            const withdrawn = cells[5].textContent.trim();
            const revenue = cells[6].textContent.trim();
            const level = cells[7].textContent.trim();
            const status = cells[8].textContent.trim();
            
            csv += `"${ctvCode}","${ctvName}","${phone}","${balance}","${pending}","${withdrawn}","${revenue}","${level}","${status}"\n`;
        }
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `vi-ctv-${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('Đã xuất file Excel thành công', 'success');
}
</script>
{% endblock %}
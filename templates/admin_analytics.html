{% extends 'admin_base.html' %}

{% block title %}Th·ªëng k√™ doanh thu{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="fas fa-chart-line me-2"></i>Th·ªëng k√™ chi ti·∫øt doanh thu</h4>
        <div class="btn-group" id="rangeGroup">
            <button class="btn btn-outline-primary active" data-range="day">Ng√†y h√¥m nay</button>
            <button class="btn btn-outline-primary" data-range="week">Tu·∫ßn n√†y</button>
            <button class="btn btn-outline-primary" data-range="month">Th√°ng n√†y</button>
            <button class="btn btn-outline-primary" data-range="year">NƒÉm nay</button>
            <button class="btn btn-outline-secondary" data-range="custom" id="customRangeBtn">
                <i class="fas fa-calendar-alt me-1"></i>T√πy ch·ªçn
            </button>
        </div>
    </div>

    <!-- Custom Date Range Picker -->
    <div class="card mb-4" id="customDateRange" style="display: none;">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">T·ª´ ng√†y</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="col-md-3">
                    <label class="form-label">ƒê·∫øn ng√†y</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Ho·∫∑c ch·ªçn nhanh</label>
                    <select class="form-select" id="quickSelect">
                        <option value="">Ch·ªçn kho·∫£ng th·ªùi gian</option>
                        <option value="today">H√¥m nay</option>
                        <option value="yesterday">H√¥m qua</option>
                        <option value="thisWeek">Tu·∫ßn n√†y</option>
                        <option value="lastWeek">Tu·∫ßn tr∆∞·ªõc</option>
                        <option value="thisMonth">Th√°ng n√†y</option>
                        <option value="lastMonth">Th√°ng tr∆∞·ªõc</option>
                        <option value="thisYear">NƒÉm nay</option>
                        <option value="lastYear">NƒÉm tr∆∞·ªõc</option>
                        
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary" id="applyCustomRange">
                        <i class="fas fa-search me-1"></i>√Åp d·ª•ng
                    </button>
                    <button class="btn btn-outline-secondary ms-2" id="clearCustomRange">
                        <i class="fas fa-times me-1"></i>X√≥a
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Overview -->
    <div class="row g-3 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line fa-2x mb-2"></i>
                    <h5 class="card-title">T·ªïng doanh thu</h5>
                    <h3 id="analyticsRevenue">0ƒë</h3>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-coins fa-2x mb-2"></i>
                    <h5 class="card-title">L·ª£i nhu·∫≠n</h5>
                    <h3 id="analyticsProfit">0ƒë</h3>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                    <h5 class="card-title">S·ªë ƒë∆°n h√†ng</h5>
                    <h3 id="totalOrders">0</h3>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-calculator fa-2x mb-2"></i>
                    <h5 class="card-title">ƒê∆°n trung b√¨nh AOV</h5>
                    <h3 id="averageOrderValue">0ƒë</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Revenue Charts -->
    <div class="row g-3 mb-4">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Bi·ªÉu ƒë·ªì doanh thu (ƒê∆∞·ªùng)</h5>
                    <button id="btnCompute" class="btn btn-sm btn-outline-primary d-none" aria-hidden="true" tabindex="-1">
                        <i class="fas fa-rotate me-1"></i>C·∫≠p nh·∫≠t d·ªØ li·ªáu
                    </button>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" height="120"></canvas>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Detailed Metrics -->
    <div class="row g-3 mb-4">
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-box me-2"></i>Chi ph√≠ & Ph√≠ ship</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">T·ªïng gi√° nh·∫≠p kho</span>
                        <strong id="analyticsImport">0ƒë</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">T·ªïng ph√≠ ship</span>
                        <strong id="analyticsShip">0ƒë</strong>
                    </div>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">T·ªïng gi·∫£m gi√° voucher</span>
                        <strong id="analyticsVoucher">0ƒë</strong>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-user me-2"></i>Kh√°ch h√†ng VIP</h6>
                </div>
                <div class="card-body text-center">
                    <h4 class="text-primary">
                        <span id="topCustomerName">-</span>
                        <small class="text-secondary ms-2" id="topCustomerPhone">-</small>
                    </h4>
                    <small class="text-muted">Kh√°ch h√†ng mang l·∫°i doanh thu cao nh·∫•t</small>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-percentage me-2"></i>T·ª∑ l·ªá l·ª£i nhu·∫≠n</h6>
                </div>
                <div class="card-body text-center">
                    <h4 id="profitMargin" class="text-success">0%</h4>
                    <small class="text-muted">L·ª£i nhu·∫≠n / Doanh thu</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Analytics -->
    <div class="row g-3 mb-4">
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-fire me-2"></i>S·∫£n ph·∫©m b√°n ch·∫°y nh·∫•t</h6>
                </div>
                <div class="card-body">
                    <ol id="topSelling" class="small mb-0" style="font-size: 0.75rem;"></ol>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-trophy me-2"></i>S·∫£n ph·∫©m doanh thu cao nh·∫•t</h6>
                </div>
                <div class="card-body">
                    <ol id="topRevenue" class="small mb-0" style="font-size: 0.75rem;"></ol>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>S·∫£n ph·∫©m l·ª£i nhu·∫≠n cao nh·∫•t</h6>
                </div>
                <div class="card-body">
                    <ol id="topProfitProducts" class="small mb-0" style="font-size: 0.75rem;"></ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Analytics -->
    <div class="row g-3 mb-4">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-users me-2"></i>Kh√°ch h√†ng mang l·∫°i doanh thu cao nh·∫•t</h6>
                </div>
                <div class="card-body">
                    <ol id="topCustomers" class="small mb-0"></ol>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Doanh thu theo khu v·ª±c ƒë·ªãa l√Ω</h6>
                </div>
                <div class="card-body">
                    <ol id="revenueByRegion" class="small mb-0"></ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Category & Brand Analytics -->
    <div class="row g-3 mb-4">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-tags me-2"></i>Doanh thu theo danh m·ª•c s·∫£n ph·∫©m</h6>
                </div>
                <div class="card-body">
                    <ol id="revenueByCategory" class="small mb-0"></ol>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-crown me-2"></i>Doanh thu theo h√£ng s·∫£n ph·∫©m</h6>
                </div>
                <div class="card-body">
                    <ol id="revenueByBrand" class="small mb-0"></ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Quantity Trend Charts -->
    <div class="row g-3">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>S·ªë l∆∞·ª£ng b√°n theo danh m·ª•c</h5>
                </div>
                <div class="card-body">
                    <canvas id="qtyCategoryPie" height="200" style="height:300px"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>S·ªë l∆∞·ª£ng b√°n theo h√£ng</h5>
                </div>
                <div class="card-body">
                    <canvas id="qtyBrandBar" height="200" style="height:300px"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
let chartInst = null;
let trendChartInst = null;
let qtyCategoryPieInst = null;
let qtyBrandBarInst = null;
let currentPeriod = 'day';
let customDateRange = null;

function fmt(v){
  const val = Number(v || 0);
  return new Intl.NumberFormat('vi-VN').format(Math.round(val)) + 'ƒë';
}

// Date utility functions
function getDateRange(option) {
  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  
  switch(option) {
    case 'today':
      return { start: today, end: today };
    case 'yesterday':
      return { start: yesterday, end: yesterday };
    case 'thisWeek':
      const startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - today.getDay() + 1);
      return { start: startOfWeek, end: today };
    case 'lastWeek':
      const lastWeekStart = new Date(today);
      lastWeekStart.setDate(today.getDate() - today.getDay() - 6);
      const lastWeekEnd = new Date(lastWeekStart);
      lastWeekEnd.setDate(lastWeekStart.getDate() + 6);
      return { start: lastWeekStart, end: lastWeekEnd };
    case 'thisMonth':
      return { 
        start: new Date(today.getFullYear(), today.getMonth(), 1), 
        end: today 
      };
    case 'lastMonth':
      const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
      const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
      return { start: lastMonth, end: lastMonthEnd };
    case 'thisYear':
      return { 
        start: new Date(today.getFullYear(), 0, 1), 
        end: today 
      };
    case 'lastYear':
      return { 
        start: new Date(today.getFullYear() - 1, 0, 1), 
        end: new Date(today.getFullYear() - 1, 11, 31) 
      };
    case 'last7days':
      const last7days = new Date(today);
      last7days.setDate(today.getDate() - 7);
      return { start: last7days, end: today };
    case 'last30days':
      const last30days = new Date(today);
      last30days.setDate(today.getDate() - 30);
      return { start: last30days, end: today };
    case 'last90days':
      const last90days = new Date(today);
      last90days.setDate(today.getDate() - 90);
      return { start: last90days, end: today };
    default:
      return null;
  }
}

function formatDateForAPI(date) {
  return date.toISOString().split('T')[0];
}

async function loadSnapshots(period, customRange = null){
  // Add cache busting to ensure fresh data
  const timestamp = new Date().getTime();
  let apiUrl = `?period=${period}&t=${timestamp}`;
  
  // Add custom date range parameters if provided
  if (customRange && customRange.start && customRange.end) {
    apiUrl += `&start_date=${formatDateForAPI(customRange.start)}&end_date=${formatDateForAPI(customRange.end)}`;
  }
  
  console.log('üîç Loading analytics with URL:', apiUrl);
  let data;
  try {
    data = await AdminAPI.getAnalytics(apiUrl);
    console.log('üìä Analytics data received:', data);
    console.log('üìä Data length:', data ? data.length : 'null');
    if (data && data.length > 0) {
      console.log('üìä First item:', data[0]);
    }
  } catch (error) {
    console.error('‚ùå Error loading analytics:', error);
    console.error('‚ùå Error details:', error.response ? error.response.data : error.message);
    AdminAPI.showNotification('C√≥ l·ªói khi t·∫£i d·ªØ li·ªáu th·ªëng k√™: ' + error.message, 'error');
    return;
  }
  if(!data || !data.length){
    renderChart([],[]);
    renderTrendChart([],[]);
    document.getElementById('analyticsRevenue').textContent = '0ƒë';
    document.getElementById('analyticsProfit').textContent = '0ƒë';
    document.getElementById('topSelling').innerHTML = '';
    document.getElementById('topRevenue').innerHTML = '';
    return;
  }
  
  // Prepare chart data from all snapshots
  const labels = [];
  const series = [];
  const allSnapshots = data;

  // Helper: aggregate snapshots (sum totals and quantities)
  function aggregateSnapshots(snaps){
    const agg = {
      period: 'custom',
      period_key: 'custom',
      total_revenue: 0,
      total_profit: 0,
      data: {
        import_total: 0,
        shipping_total: 0,
        total_orders: 0,
        average_order_value: 0,
        qty_by_category: [],
        qty_by_brand: [],
        top_selling: [],
        top_revenue: [],
        top_customers: [],
        top_profit_products: [],
        revenue_by_region: [],
        revenue_by_category: [],
        revenue_by_brand: [],
        top_customer_phone: '-',
        top_customers_phone: [],
        voucher_discount_total: 0
      }
    };
    const catQtyMap = {};
    const brandQtyMap = {};
    const topSellingMap = {};
    const topRevenueMap = {};
    const topCustomersMap = {};
    const topProfitMap = {};
    const regionRevenueMap = {};
    const categoryRevenueMap = {};
    const brandRevenueMap = {};
    const phoneRevenueMap = {};
    snaps.forEach(s => {
      agg.total_revenue += Number(s.total_revenue || 0);
      agg.total_profit += Number(s.total_profit || 0);
      const d = s.data || {};
      agg.data.import_total += Number(d.import_total || 0);
      agg.data.shipping_total += Number(d.shipping_total || 0);
      agg.data.total_orders += Number(d.total_orders || 0);
      agg.data.voucher_discount_total += Number(d.voucher_discount_total || 0);
      (d.qty_by_category || []).forEach(it => { catQtyMap[it.category] = (catQtyMap[it.category] || 0) + Number(it.qty || 0); });
      (d.qty_by_brand || []).forEach(it => { brandQtyMap[it.brand] = (brandQtyMap[it.brand] || 0) + Number(it.qty || 0); });
      (d.top_selling || []).forEach(it => { topSellingMap[it.name] = (topSellingMap[it.name] || 0) + Number(it.qty || 0); });
      (d.top_revenue || []).forEach(it => { topRevenueMap[it.name] = (topRevenueMap[it.name] || 0) + Number(it.revenue || 0); });
      (d.top_customers || []).forEach(it => { topCustomersMap[it.name] = (topCustomersMap[it.name] || 0) + Number(it.revenue || 0); });
      (d.top_profit_products || []).forEach(it => { topProfitMap[it.name] = (topProfitMap[it.name] || 0) + Number(it.profit || 0); });
      (d.revenue_by_region || []).forEach(it => { regionRevenueMap[it.region] = (regionRevenueMap[it.region] || 0) + Number(it.revenue || 0); });
      (d.revenue_by_category || []).forEach(it => { categoryRevenueMap[it.category] = (categoryRevenueMap[it.category] || 0) + Number(it.revenue || 0); });
      (d.revenue_by_brand || []).forEach(it => { brandRevenueMap[it.brand] = (brandRevenueMap[it.brand] || 0) + Number(it.revenue || 0); });
      (d.top_customers_phone || []).forEach(it => { phoneRevenueMap[it.phone] = (phoneRevenueMap[it.phone] || 0) + Number(it.revenue || 0); });
    });
    if (agg.data.total_orders > 0){
      agg.data.average_order_value = agg.total_revenue / agg.data.total_orders;
    }
    agg.data.qty_by_category = Object.entries(catQtyMap).map(([category, qty]) => ({ category, qty }));
    agg.data.qty_by_brand = Object.entries(brandQtyMap).map(([brand, qty]) => ({ brand, qty }));
    agg.data.top_selling = Object.entries(topSellingMap).map(([name, qty]) => ({ name, qty })).sort((a,b)=>b.qty-a.qty).slice(0,10);
    agg.data.top_revenue = Object.entries(topRevenueMap).map(([name, revenue]) => ({ name, revenue })).sort((a,b)=>b.revenue-a.revenue).slice(0,10);
    agg.data.top_customers = Object.entries(topCustomersMap).map(([name, revenue]) => ({ name, revenue })).sort((a,b)=>b.revenue-a.revenue).slice(0,10);
    agg.data.top_profit_products = Object.entries(topProfitMap).map(([name, profit]) => ({ name, profit })).sort((a,b)=>b.profit-a.profit).slice(0,10);
    agg.data.revenue_by_region = Object.entries(regionRevenueMap).map(([region, revenue]) => ({ region, revenue })).sort((a,b)=>b.revenue-a.revenue).slice(0,10);
    agg.data.revenue_by_category = Object.entries(categoryRevenueMap).map(([category, revenue]) => ({ category, revenue })).sort((a,b)=>b.revenue-a.revenue).slice(0,10);
    agg.data.revenue_by_brand = Object.entries(brandRevenueMap).map(([brand, revenue]) => ({ brand, revenue })).sort((a,b)=>b.revenue-a.revenue).slice(0,10);
    // Build phone aggregates
    const phones = Object.entries(phoneRevenueMap).map(([phone, revenue]) => ({ phone, revenue }));
    phones.sort((a,b)=>b.revenue-a.revenue);
    agg.data.top_customers_phone = phones.slice(0,10);
    agg.data.top_customer_phone = phones.length ? phones[0].phone : '-';
    return agg;
  }
  
  // For custom range, create detailed chart by day or month
  if (customRange) {
    console.log('üìÖ Custom range:', customRange.start, 'to', customRange.end);
    
    const startDate = new Date(customRange.start);
    const endDate = new Date(customRange.end);
    const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
    
    // If range is more than 90 days, show by month (12 points max)
    if (daysDiff > 90) {
      console.log('üìÖ Range > 90 days, showing by month');
      
      // Generate all months in the range
      const currentDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
      const endMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
      
      while (currentDate <= endMonth) {
        const monthStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
        labels.push(monthStr);
        
        // Find revenue for this specific month
        const monthData = allSnapshots.find(snap => snap.period_key === monthStr);
        const revenue = monthData ? Number(monthData.total_revenue || 0) : 0;
        series.push(revenue);
        
        console.log(`üìÖ ${monthStr}: ${revenue}ƒë`);
        currentDate.setMonth(currentDate.getMonth() + 1);
      }
    } else {
      console.log('üìÖ Range <= 90 days, showing by day');
      
      // Generate all days in the range
      const currentDate = new Date(startDate);
      
      while (currentDate <= endDate) {
        const dateStr = currentDate.toISOString().split('T')[0];
        labels.push(dateStr);
        
        // Find revenue for this specific date
        const dayData = allSnapshots.find(snap => snap.period_key === dateStr);
        const revenue = dayData ? Number(dayData.total_revenue || 0) : 0;
        series.push(revenue);
        
        console.log(`üìÖ ${dateStr}: ${revenue}ƒë`);
        currentDate.setDate(currentDate.getDate() + 1);
      }
    }
    
    console.log('üìä Custom range - Final labels:', labels.length);
    console.log('üìä Custom range - Final series:', series.length);
  } else {
    // For regular periods (day, week, month, year), use existing logic
    // Sort by period_key to get chronological order
    allSnapshots.sort((a, b) => a.period_key.localeCompare(b.period_key));
    
    // For chart: show individual periods, not cumulative
    allSnapshots.forEach(snap => {
      labels.push(snap.period_key);
      series.push(Number(snap.total_revenue || 0));
    });
  }
  
  renderChart(labels, series);
  
  // Show latest snapshot details (most recent period)
  // Find the most recent snapshot by created_at or period_key
  let latestSnap = data.reduce((latest, current) => {
    // Compare by period_key (newest date first)
    if (!latest) return current;
    return current.period_key > latest.period_key ? current : latest;
  }, null);
  // If custom range is selected, use aggregated snapshot for displays
  if (customRange) {
    latestSnap = aggregateSnapshots(allSnapshots);
  }
  // Render quantity charts now that latestSnap is available
  renderQtyCharts(latestSnap);
  
  console.log('üìä All Snapshots:', data);
  console.log('üìä Latest Snapshot:', latestSnap);
  console.log('üí∞ Latest Revenue:', latestSnap.total_revenue);
  console.log('üíµ Latest Profit:', latestSnap.total_profit);
  console.log('üì¶ Latest Import:', latestSnap.data?.import_total);
  console.log('üöö Latest Shipping:', latestSnap.data?.shipping_total);
  console.log('üè∑Ô∏è Latest Voucher Discount:', latestSnap.data?.voucher_discount_total);
  
  document.getElementById('analyticsRevenue').textContent = fmt(latestSnap.total_revenue || 0);
  document.getElementById('analyticsProfit').textContent = fmt(latestSnap.total_profit || 0);
  document.getElementById('analyticsImport').textContent = fmt((latestSnap.data && latestSnap.data.import_total) || 0);
  document.getElementById('analyticsShip').textContent = fmt((latestSnap.data && latestSnap.data.shipping_total) || 0);
  const voucherSum = (latestSnap.data && latestSnap.data.voucher_discount_total) || 0;
  if (document.getElementById('analyticsVoucher')) {
    document.getElementById('analyticsVoucher').textContent = fmt(voucherSum);
  }

  // Debug info to console for verification
  try {
    console.log('üìä All Snapshots:', data);
    console.log('üßÆ Chart Labels:', labels);
    console.log('üßÆ Chart Series:', series);
    console.log('üí∞ Latest Revenue:', latestSnap.total_revenue);
    console.log('üíµ Latest Profit:', latestSnap.total_profit);
  } catch(e) {}

  const topS = (latestSnap.data && latestSnap.data.top_selling) || [];
  const topR = (latestSnap.data && latestSnap.data.top_revenue) || [];
  const topCustomers = (latestSnap.data && latestSnap.data.top_customers) || [];
  const topProfitProducts = (latestSnap.data && latestSnap.data.top_profit_products) || [];
  const revenueByRegion = (latestSnap.data && latestSnap.data.revenue_by_region) || [];
  const revenueByCategory = (latestSnap.data && latestSnap.data.revenue_by_category) || [];
  const revenueByBrand = (latestSnap.data && latestSnap.data.revenue_by_brand) || [];
  
  // Basic stats
  const totalOrders = latestSnap.data?.total_orders || 0;
  const averageOrderValue = latestSnap.data?.average_order_value || 0;
  let topCustomerPhone = latestSnap.data?.top_customer_phone || '-';
  // If custom aggregated snapshot, find top phone from aggregated customers
  if (customRange && (!topCustomerPhone || topCustomerPhone === '-')) {
    const phones = latestSnap.data?.top_customers_phone || [];
    topCustomerPhone = phones.length ? phones[0].phone : '-';
  }
  
  // Get top customer name and phone
  const topCustomer = topCustomers.length > 0 ? topCustomers[0] : null;
  const topCustomerName = topCustomer ? topCustomer.name : '-';
  
  // Calculate profit margin
  const totalRevenue = latestSnap.total_revenue || 0;
  const totalProfit = latestSnap.total_profit || 0;
  const profitMargin = totalRevenue > 0 ? ((totalProfit / totalRevenue) * 100).toFixed(1) : 0;
  
  // Helper function to truncate product names
  function truncateName(name, maxLength = 48) {
    if (name.length <= maxLength) return name;
    return name.substring(0, maxLength) + '...';
  }

  // Update displays
  document.getElementById('topSelling').innerHTML = topS.map(it => `<li><span title="${it.name}">${truncateName(it.name)}</span> <span class="text-muted float-end">x${it.qty}</span></li>`).join('');
  document.getElementById('topRevenue').innerHTML = topR.map(it => `<li><span title="${it.name}">${truncateName(it.name)}</span> <strong class=\"float-end\">${fmt(it.revenue)}</strong></li>`).join('');
  document.getElementById('topCustomers').innerHTML = topCustomers.map(it => `<li>${it.name} <strong class=\"float-end\">${fmt(it.revenue)}</strong></li>`).join('');
  document.getElementById('topProfitProducts').innerHTML = topProfitProducts.map(it => `<li><span title="${it.name}">${truncateName(it.name)}</span> <strong class=\"float-end\">${fmt(it.profit)}</strong></li>`).join('');
  document.getElementById('revenueByRegion').innerHTML = revenueByRegion.map(it => `<li>${it.region} <strong class=\"float-end\">${fmt(it.revenue)}</strong></li>`).join('');
  document.getElementById('revenueByCategory').innerHTML = revenueByCategory.map(it => `<li>${it.category} <strong class=\"float-end\">${fmt(it.revenue)}</strong></li>`).join('');
  document.getElementById('revenueByBrand').innerHTML = revenueByBrand.map(it => `<li>${it.brand} <strong class=\"float-end\">${fmt(it.revenue)}</strong></li>`).join('');
  
  document.getElementById('totalOrders').textContent = totalOrders;
  document.getElementById('averageOrderValue').textContent = fmt(averageOrderValue);
  document.getElementById('topCustomerName').textContent = topCustomerName;
  document.getElementById('topCustomerPhone').textContent = topCustomerPhone;
  document.getElementById('profitMargin').textContent = profitMargin + '%';
}

function renderChart(labels, data){
  const ctx = document.getElementById('revenueChart');
  if(chartInst) chartInst.destroy();
  chartInst = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: 'Doanh thu', data, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.15)', tension: .3, fill: true }]},
    options: { plugins:{legend:{display:false}}, scales:{ y:{ ticks:{ callback:v=>fmt(v) } } } }
  });
}

function renderQtyCharts(latestSnap){
  const qtyByCategory = (latestSnap.data && latestSnap.data.qty_by_category) || [];
  const qtyByBrand = (latestSnap.data && latestSnap.data.qty_by_brand) || [];

  // Category Pie
  const pieCtx = document.getElementById('qtyCategoryPie');
  if (qtyCategoryPieInst) qtyCategoryPieInst.destroy();
  const catLabels = qtyByCategory.map(it => it.category);
  const catData = qtyByCategory.map(it => it.qty);
  const pieColors = ['#6366f1','#10b981','#f59e0b','#ef4444','#8b5cf6','#14b8a6','#f97316','#84cc16','#06b6d4','#eab308'];
  qtyCategoryPieInst = new Chart(pieCtx, {
    type: 'pie',
    data: { labels: catLabels, datasets: [{ data: catData, backgroundColor: pieColors }]},
    options: { plugins: { legend: { position: 'bottom' } }, maintainAspectRatio: false, responsive: true }
  });

  // Brand Bar
  const barCtx = document.getElementById('qtyBrandBar');
  if (qtyBrandBarInst) qtyBrandBarInst.destroy();
  const brandLabels = qtyByBrand.map(it => it.brand);
  const brandData = qtyByBrand.map(it => it.qty);
  qtyBrandBarInst = new Chart(barCtx, {
    type: 'bar',
    data: { labels: brandLabels, datasets: [{ label: 'S·ªë l∆∞·ª£ng', data: brandData, backgroundColor: '#3b82f6' }]},
    options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } }, maintainAspectRatio: false, responsive: true }
  });
}

document.getElementById('rangeGroup').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-range]'); if(!btn) return;
  document.querySelectorAll('#rangeGroup button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  
  currentPeriod = btn.dataset.range;
  
  if (btn.dataset.range === 'custom') {
    document.getElementById('customDateRange').style.display = 'block';
    // Default: yesterday -> today
    const today = new Date();
    const yesterday = new Date();
    yesterday.setDate(today.getDate() - 1);
    document.getElementById('startDate').value = formatDateForAPI(yesterday);
    document.getElementById('endDate').value = formatDateForAPI(today);
    const qs = document.getElementById('quickSelect');
    if (qs) qs.value = '';
  } else {
    document.getElementById('customDateRange').style.display = 'none';
    customDateRange = null;
    await loadSnapshots(btn.dataset.range);
  }
});

// Quick select handler
document.getElementById('quickSelect').addEventListener('change', (e) => {
  const option = e.target.value;
  if (option) {
    const dateRange = getDateRange(option);
    if (dateRange) {
      document.getElementById('startDate').value = formatDateForAPI(dateRange.start);
      document.getElementById('endDate').value = formatDateForAPI(dateRange.end);
    }
  }
});

// When user manually changes start/end date, reset quickSelect to placeholder
['startDate','endDate'].forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.addEventListener('change', () => {
      const qs = document.getElementById('quickSelect');
      if (qs) qs.value = '';
    });
  }
});

// Apply custom range handler
document.getElementById('applyCustomRange').addEventListener('click', async () => {
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  
  if (!startDate || !endDate) {
    AdminAPI.showNotification('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c', 'error');
    return;
  }
  
  if (new Date(startDate) > new Date(endDate)) {
    AdminAPI.showNotification('Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n ng√†y k·∫øt th√∫c', 'error');
    return;
  }
  
  customDateRange = {
    start: new Date(startDate),
    end: new Date(endDate)
  };
  
  console.log('üéØ Applying custom range:', customDateRange);
  
  // Show loading state
  document.getElementById('applyCustomRange').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang t·∫£i...';
  document.getElementById('applyCustomRange').disabled = true;
  
  try {
    await loadSnapshots('custom', customDateRange);
    AdminAPI.showNotification(`ƒê√£ √°p d·ª•ng th·ªëng k√™ t·ª´ ${startDate} ƒë·∫øn ${endDate}`, 'success');
  } catch (error) {
    console.error('Error loading custom range:', error);
    AdminAPI.showNotification('C√≥ l·ªói khi t·∫£i d·ªØ li·ªáu th·ªëng k√™', 'error');
  } finally {
    document.getElementById('applyCustomRange').innerHTML = '<i class="fas fa-search me-1"></i>√Åp d·ª•ng';
    document.getElementById('applyCustomRange').disabled = false;
  }
});

// Clear custom range handler
document.getElementById('clearCustomRange').addEventListener('click', () => {
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  document.getElementById('quickSelect').value = '';
  customDateRange = null;
  
  // Switch back to day view
  document.querySelectorAll('#rangeGroup button').forEach(b => b.classList.remove('active'));
  document.querySelector('#rangeGroup button[data-range="day"]').classList.add('active');
  currentPeriod = 'day';
  loadSnapshots('day');
});

document.getElementById('btnCompute').addEventListener('click', async ()=>{
  const active = document.querySelector('#rangeGroup .active');
  const period = active ? active.dataset.range : 'month';
  await AdminAPI.computeAnalytics(period);
  await loadSnapshots(period, customDateRange);
  AdminAPI.showNotification('ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu doanh thu','success');
});

// init - force refresh on page load
document.addEventListener('DOMContentLoaded', function() {
    // Force refresh all periods
    loadSnapshots('day');
});

// Also load on page show (back button, etc.)
window.addEventListener('pageshow', function() {
    loadSnapshots('day');
});
</script>
{% endblock %}

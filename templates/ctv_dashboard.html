{% extends "ctv_base.html" %}

{% block title %}Dashboard CTV{% endblock %}

{% block ctv_body %}
<div class="row g-3">
  <div class="col-md-3">
    <div class="ctv-card p-3">
      <div class="text-muted small mb-1">Tổng đơn</div>
      <div id="mTotalOrders" class="h4 mb-0">-</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="ctv-card p-3">
      <div class="text-muted small mb-1">Tổng doanh thu</div>
      <div id="mTotalRevenue" class="h4 mb-0">-</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="ctv-card p-3">
      <div class="text-muted small mb-1">Hoa hồng</div>
      <div id="mCommissionBal" class="h5 mb-0">-</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="ctv-card p-3">
      <div class="text-muted small mb-1">Chờ duyệt</div>
      <div id="mCommissionPending" class="h5 mb-0">-</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="ctv-card p-3">
      <div class="text-muted small mb-1">Đã rút</div>
      <div id="mCommissionWithdrawn" class="h5 mb-0">-</div>
    </div>
  </div>
</div>

<div class="ctv-card p-3 mt-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="h6 mb-0">Danh sách hoa hồng</h2>
    <a class="btn btn-sm btn-outline-primary" href="/ctv/wallet/">Rút tiền</a>
  </div>
  <div class="table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Mã đơn</th>
          <th>Sản phẩm</th>
          <th>SL</th>
          <th>Lợi nhuận</th>
          <th>Hoa hồng</th>
        </tr>
      </thead>
      <tbody id="commissionRows">
      </tbody>
    </table>
  </div>
  <div class="small text-muted" id="commissionEmpty">-</div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
// Inject CTV data từ server-side session
{% if g.ctv %}
window.ctvData = {{ g.ctv | tojson }};
{% else %}
window.ctvData = null;
{% endif %}

function getCtv(){ 
  // Sử dụng server-side session thay vì sessionStorage
  // CTV data sẽ được inject từ server qua template context
  try { 
    return window.ctvData || null; 
  } catch(e){ 
    return null; 
  } 
}
function fmt(n){return (Number(n)||0).toLocaleString('vi-VN')+" đ"}

async function loadDashboard(){
  const ctv = getCtv();
  if (!ctv) { location.href='/ctv/login/'; return; }
  const id = ctv.id;
  const s = await fetch(`/ctvs/${id}/stats/`).then(r=>r.json());
  document.getElementById('mTotalOrders').textContent = s.total_orders ?? 0;
  document.getElementById('mTotalRevenue').textContent = fmt((s.total_revenue ?? 0) * 1000);
  document.getElementById('mCommissionBal').textContent = fmt((s.commission_balance ?? 0) * 1000);
  document.getElementById('mCommissionPending').textContent = fmt((s.commission_pending ?? 0) );
  document.getElementById('mCommissionWithdrawn').textContent = fmt((s.commission_withdrawn ?? 0) );

  const list = await fetch(`/ctvs/${id}/commissions/`).then(r=>r.json());
  const tbody = document.getElementById('commissionRows');
  tbody.innerHTML = '';
  if (!Array.isArray(list) || list.length===0) {
    document.getElementById('commissionEmpty').textContent = 'Chưa có đơn nào';
    return;
  }
  document.getElementById('commissionEmpty').textContent='';
  for (const it of list.slice(0, 20)){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.order_code}</td><td>${it.product_name}</td><td>${it.quantity}</td><td>${fmt(it.profit * 1000)}</td><td><strong>${fmt(it.commission * 1000)}</strong></td>`;
    tbody.appendChild(tr);
  }
}

document.addEventListener('DOMContentLoaded', loadDashboard);
</script>
{% endblock %}


{% extends "base.html" %}

{% block title %}{{ product.name if product else 'Chi tiết sản phẩm' }} - BuddySkincare{% endblock %}

{% block description %}{{ product.description[:160] if product and product.description else 'Khám phá sản phẩm mỹ phẩm thanh lý chất lượng cao với giá tốt nhất tại BuddySkincare.' }}{% endblock %}

{% block keywords %}{{ product.name if product else 'sản phẩm mỹ phẩm' }}, mỹ phẩm thanh lý, mỹ phẩm giá rẻ, {{ product.brand_name if product and product.brand_name else 'mỹ phẩm chính hãng' }}{% endblock %}

{% block og_type %}product{% endblock %}

{% block og_title %}{{ product.name if product else 'Sản phẩm mỹ phẩm' }} - BuddySkincare{% endblock %}

{% block og_description %}{{ product.description[:200] if product and product.description else 'Sản phẩm mỹ phẩm thanh lý chất lượng cao với giá tốt nhất.' }}{% endblock %}

{% block og_image %}{{ product.image if product and product.image else 'https://buddyskincare.vn/static/image/sukien/banner03.png' }}{% endblock %}

{% block og_image_alt %}{{ product.name if product else 'Sản phẩm mỹ phẩm' }} - BuddySkincare{% endblock %}

{% block extra_css %}
<style>
/* Flash Sale Countdown Styles */
.flash-sale-countdown .alert {
    border: 2px solid #dc3545;
    background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
    animation: flashSalePulse 2s infinite;
}

@keyframes flashSalePulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

.countdown-timer {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-family: 'Courier New', monospace;
    font-weight: bold;
}

.countdown-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #dc3545;
    color: white;
    border-radius: 8px;
    padding: 8px 12px;
    min-width: 60px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.countdown-number {
    font-size: 1.5rem;
    line-height: 1;
    font-weight: 900;
}

.countdown-label {
    font-size: 0.7rem;
    opacity: 0.9;
    margin-top: 2px;
}

.countdown-separator {
    font-size: 1.5rem;
    font-weight: bold;
    color: #dc3545;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
}

.flash-sale-savings {
    text-align: center;
    padding: 8px;
    background: rgba(40, 167, 69, 0.1);
    border-radius: 6px;
    border: 1px solid rgba(40, 167, 69, 0.3);
}

/* Mobile responsive for countdown */
@media (max-width: 768px) {
    .countdown-timer {
        gap: 4px;
    }
    
    .countdown-item {
        min-width: 50px;
        padding: 6px 8px;
    }
    
    .countdown-number {
        font-size: 1.2rem;
    }
    
    .countdown-label {
        font-size: 0.6rem;
    }
    
    .countdown-separator {
        font-size: 1.2rem;
    }
}

@media (max-width: 480px) {
    .countdown-timer {
        gap: 2px;
    }
    
    .countdown-item {
        min-width: 45px;
        padding: 4px 6px;
    }
    
    .countdown-number {
        font-size: 1rem;
    }
    
    .countdown-label {
        font-size: 0.55rem;
    }
    
    .countdown-separator {
        font-size: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="page-header bg-light py-3" id="product-detail-page">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="/products" class="text-decoration-none">Sản phẩm</a></li>
                <li class="breadcrumb-item"><a href="#" class="text-decoration-none" id="detailCategory">Danh mục</a></li>
                <li class="breadcrumb-item active" aria-current="page" id="detailBreadcrumb">Đang tải...</li>
            </ol>
        </nav>
    </div>
</section>

<!-- Product Detail -->
<section class="product-detail py-5">
    <div class="container">
        <div class="row">
            <!-- Product Images -->
            <div class="col-lg-6">
                <div class="product-images">
                    <!-- Main Image -->
                    <div class="main-image mb-3 position-relative">
                        <img src="/static/image/default-product.jpg" 
                             alt="Hình sản phẩm" 
                             class="img-fluid rounded" 
                             id="mainImage">
                        <!-- Smart Actions -->
                        <div class="position-absolute top-0 end-0 m-2 d-flex gap-2">
                            <button type="button" class="btn btn-light btn-sm shadow-sm" id="btnDownloadImage" title="Tải ảnh sản phẩm" onclick="window.downloadCurrentImage && window.downloadCurrentImage()">
                                <i class="fas fa-download"></i>
                            </button>
                            <button type="button" class="btn btn-light btn-sm shadow-sm" id="btnCopyProductLink" title="Sao chép link sản phẩm" onclick="window.copyProductLink && window.copyProductLink()">
                                <i class="fas fa-link"></i>
                            </button>
                        </div>
                        <!-- Out of Stock Overlay -->
                        <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" 
                             id="outOfStockOverlay" 
                             style="display: none; background-color: rgba(0,0,0,0.7); border-radius: 0.375rem;">
                            <div class="text-center text-white">
                                <i class="fas fa-times-circle fa-3x mb-2"></i>
                                <h4 class="fw-bold">HẾT HÀNG</h4>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Thumbnail Images -->
                    <div class="thumbnail-images d-flex gap-2" id="thumbnailContainer"></div>
                    
                    <!-- Image Notice (compact) -->
                    <div class="image-notice mt-2">
                        <div class="d-flex align-items-center text-muted small">
                            <i class="fas fa-camera me-1" style="font-size: 0.85rem;"></i>
                            <span>Ảnh thật do shop tự chụp</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Product Info -->
            <div class="col-lg-6">
                <div class="product-info">
                    <h1 class="fw-bold mb-2" id="detailName">Đang tải...</h1>
                    <p class="text-muted mb-3" id="detailBrand"></p>
                    
                    <!-- Rating -->
                    <div class="d-flex align-items-center mb-3">
                        <div class="stars text-warning me-2" id="detailStars"></div>
                        <span class="fw-bold text-warning me-2" id="detailRating">0.0</span>
                        <span class="text-muted me-2" id="detailReviews">(0 đánh giá)</span>
                        <span class="text-success" id="detailStock"></span>
                    </div>
                    
                    <!-- Price -->
                    <div class="price-section mb-4">
                        <div class="d-flex align-items-center">
                            <span class="text-decoration-line-through text-muted fs-5 me-3" id="detailOriginalPrice"></span>
                            <span class="text-danger fw-bold fs-2" id="detailDiscountedPrice"></span>
                            <span class="badge bg-danger fs-6" id="detailDiscountBadge" style="display:none; margin-left: 8px;"></span>
                        </div>
                        <small class="text-muted" id="detailSavings"></small>
                    </div>
                    
                    <!-- Product Status -->
                    <div class="product-status mb-4" id="detailStatus" style="display:none">
                        <div class="alert alert-warning d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <div id="detailStatusText"></div>
                        </div>
                    </div>
                    
                    <!-- Flash Sale Countdown -->
                    <div class="flash-sale-countdown mb-4" id="flashSaleCountdown" style="display:none">
                        <div class="alert alert-danger d-flex align-items-center">
                            <i class="fas fa-bolt me-2"></i>
                            <div class="flex-grow-1">
                                <div class="fw-bold mb-1">⚡ FLASH SALE ĐANG DIỄN RA!</div>
                                <div class="countdown-timer" id="countdownTimer">
                                    <span class="countdown-item">
                                        <span class="countdown-number" id="days">00</span>
                                        <span class="countdown-label">Ngày</span>
                                    </span>
                                    <span class="countdown-separator">:</span>
                                    <span class="countdown-item">
                                        <span class="countdown-number" id="hours">00</span>
                                        <span class="countdown-label">Giờ</span>
                                    </span>
                                    <span class="countdown-separator">:</span>
                                    <span class="countdown-item">
                                        <span class="countdown-number" id="minutes">00</span>
                                        <span class="countdown-label">Phút</span>
                                    </span>
                                    <span class="countdown-separator">:</span>
                                    <span class="countdown-item">
                                        <span class="countdown-number" id="seconds">00</span>
                                        <span class="countdown-label">Giây</span>
                                    </span>
                                </div>
                                <div class="flash-sale-savings mt-2" id="flashSaleSavings">
                                    <small class="text-success fw-bold">
                                        <i class="fas fa-gift me-1"></i>
                                        Tiết kiệm thêm: <span id="additionalSavings">0</span>K VNĐ
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Product Tags -->
                    <div class="product-tags mb-4" id="detailTags" style="display:none">
                        <h6 class="fw-semibold mb-2">Tags:</h6>
                        <div id="detailTagsList"></div>
                    </div>
                    
                    <!-- Product Gifts -->
                    <div class="product-gifts mb-4" id="detailGifts" style="display:none">
                        <h6 class="fw-semibold mb-2">Quà tặng kèm:</h6>
                        <div id="detailGiftsList"></div>
                    </div>
                    
                    <!-- Quantity -->
                    <div class="quantity-section mb-4">
                        <label class="form-label fw-semibold">Số lượng:</label>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-outline-secondary" onclick="changeQuantity(-1)">-</button>
                            <input type="number" class="form-control mx-2" value="1" min="1" id="quantity" style="width: 80px;" onchange="validateQuantityInput()" oninput="validateQuantityInput()" max="999">
                            <button class="btn btn-outline-secondary" onclick="changeQuantity(1)">+</button>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="action-buttons mb-4">
                        <div class="row g-2">
                            <div class="col-8">
                                <button class="btn btn-primary btn-lg w-100" id="detailAddToCartBtn">
                                    <i class="fas fa-shopping-cart me-2"></i>Thêm vào giỏ hàng
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-success btn-lg w-100" id="detailBuyNowBtn" style="    padding: 12px 4px;">
                                    <i class="fas fa-bolt me-2"></i>Mua ngay
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Wishlist -->
                    <div class="wishlist-section mb-4">
                        <button id="detailFavBtn" class="btn btn-outline-secondary w-100">
                            <i class="far fa-heart me-2"></i><span class="fav-text">Thêm vào yêu thích</span>
                        </button>
                        <div class="d-flex gap-2 mt-2">
                            <button type="button" class="btn btn-outline-primary flex-fill" id="btnCopyProductLink_2" onclick="window.copyProductLink && window.copyProductLink()">
                                <i class="fas fa-link me-1"></i> Copy link sản phẩm
                            </button>
                            <button type="button" class="btn btn-outline-secondary flex-fill" id="btnDownloadImage_2" onclick="window.downloadCurrentImage && window.downloadCurrentImage()">
                                <i class="fas fa-download me-1"></i> Tải ảnh sản phẩm
                            </button>
                        </div>
                    </div>
                    
                    <!-- Product Features -->
                    <div class="product-features mb-4" id="detailFeatures">
                        <h6 class="fw-semibold mb-3">Đặc điểm nổi bật:</h6>
                        <ul class="list-unstyled" id="detailFeaturesList">
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Chính hãng <span id="detailBrandFeature"></span></li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Chất lượng cao</li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Giá tốt nhất thị trường</li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Giao hàng nhanh</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Product Details Tabs -->
<section class="product-tabs py-5 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs" id="productTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab">
                            Mô tả
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="specifications-tab" data-bs-toggle="tab" data-bs-target="#specifications" type="button" role="tab">
                            Thông số
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">
                            Đánh giá
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="productTabsContent">
                    <!-- Description Tab -->
                    <div class="tab-pane fade show active" id="description" role="tabpanel">
                        <div class="p-4" id="detailDescription" style="line-height: 1.6; text-align: justify;">Đang cập nhật mô tả sản phẩm...</div>
                    </div>
                    
                    <!-- Specifications Tab -->
                    <div class="tab-pane fade" id="specifications" role="tabpanel">
                        <div class="p-4" id="detailSpecifications">Đang cập nhật thông số...</div>
                    </div>
                    
                    <!-- Reviews Tab -->
                    <div class="tab-pane fade" id="reviews" role="tabpanel">
                        <div class="p-4" id="detailReviewsTab">Chưa có đánh giá.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Related Products -->
<section class="related-products py-5">
    <div class="container">
        <h3 class="fw-bold text-center mb-4">Sản phẩm liên quan</h3>
        <div id="related-products-container">
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Đang tải...</span></div>
                <p class="text-muted mt-2">Đang tải sản phẩm liên quan...</p>
            </div>
        </div>
    </div>
</section>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Viết đánh giá</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label class="form-label">Đánh giá của bạn:</label>
                        <div class="stars-input">
                            <i class="far fa-star" data-rating="1"></i>
                            <i class="far fa-star" data-rating="2"></i>
                            <i class="far fa-star" data-rating="3"></i>
                            <i class="far fa-star" data-rating="4"></i>
                            <i class="far fa-star" data-rating="5"></i>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tiêu đề:</label>
                        <input type="text" class="form-control" placeholder="Tóm tắt đánh giá của bạn">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nội dung:</label>
                        <textarea class="form-control" rows="4" placeholder="Chia sẻ trải nghiệm của bạn về sản phẩm"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hình ảnh (tùy chọn):</label>
                        <input type="file" class="form-control" multiple accept="image/*">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary">Gửi đánh giá</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script id="productDataJson" type="application/json">{{ product | tojson | safe }}</script>
<script>
// Pass product data to JavaScript
try {
    window.productData = JSON.parse(document.getElementById('productDataJson').textContent || '{}');
} catch(e) {
    window.productData = {};
}

// Initialize product detail page after data is loaded
console.log('🔍 Template script loaded');
console.log('📦 Product data available:', !!window.productData);
console.log('🔧 Init function available:', typeof window.initProductDetailPageGlobal);

try {
    if (typeof window.initProductDetailPageGlobal === 'function') {
        console.log('✅ Calling initProductDetailPageGlobal...');
        window.initProductDetailPageGlobal();
    } else {
        console.log('❌ initProductDetailPageGlobal function not found');
    }
} catch (err) {
    console.warn('⚠️ initProductDetailPageGlobal error (ignored to keep page interactive):', err);
}

// Flash Sale Countdown Logic
let flashSaleInterval = null;

function checkFlashSaleStatus() {
    if (!window.productData || !window.productData.tags) return;
    
    // Check if product has FlashSale tag
    const hasFlashSaleTag = window.productData.tags.some(tag => 
        tag.toLowerCase().includes('flashsale') || tag.toLowerCase().includes('flash-sale')
    );
    
    if (!hasFlashSaleTag) return;
    
    // Fetch active flash sale tag details
        fetch('https://buddyskincare.vn/backend/api/tags/')
        .then(response => response.json())
        .then(tags => {
            const activeFlashSaleTag = tags.find(tag => 
                tag.code.toLowerCase().includes('flashsale') && 
                tag.status === 'active' &&
                new Date(tag.end_date) > new Date()
            );
            
            if (activeFlashSaleTag) {
                showFlashSaleCountdown(activeFlashSaleTag);
            }
        })
        .catch(error => {
            console.error('Error fetching flash sale tags:', error);
        });
}

function showFlashSaleCountdown(tag) {
    const countdownElement = document.getElementById('flashSaleCountdown');
    const additionalSavingsElement = document.getElementById('additionalSavings');
    
    if (!countdownElement) return;
    
    // Show countdown
    countdownElement.style.display = 'block';
    
    // Set additional savings
    if (additionalSavingsElement && tag.discounted_price_reduction) {
        additionalSavingsElement.textContent = tag.discounted_price_reduction;
    }
    
    // Start countdown
    startCountdown(tag.end_date);
}

function startCountdown(endDate) {
    const endTime = new Date(endDate).getTime();
    
    function updateCountdown() {
        const now = new Date().getTime();
        const timeLeft = endTime - now;
        
        if (timeLeft <= 0) {
            // Flash sale ended
            clearInterval(flashSaleInterval);
            document.getElementById('flashSaleCountdown').style.display = 'none';
            return;
        }
        
        // Calculate time units
        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
        
        // Update display
        const daysElement = document.getElementById('days');
        const hoursElement = document.getElementById('hours');
        const minutesElement = document.getElementById('minutes');
        const secondsElement = document.getElementById('seconds');
        
        if (daysElement) daysElement.textContent = days.toString().padStart(2, '0');
        if (hoursElement) hoursElement.textContent = hours.toString().padStart(2, '0');
        if (minutesElement) minutesElement.textContent = minutes.toString().padStart(2, '0');
        if (secondsElement) secondsElement.textContent = seconds.toString().padStart(2, '0');
    }
    
    // Update immediately
    updateCountdown();
    
    // Update every second
    flashSaleInterval = setInterval(updateCountdown, 1000);
}

// Initialize flash sale check when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for product data to be available
    setTimeout(checkFlashSaleStatus, 1000);
});

// Clean up interval when page unloads
window.addEventListener('beforeunload', function() {
    if (flashSaleInterval) {
        clearInterval(flashSaleInterval);
    }
});

// Keep helper functions
function changeMainImage(src) { document.getElementById('mainImage').src = src; }
function changeQuantity(delta) {
    const quantityInput = document.getElementById('quantity');
    let currentValue = parseInt(quantityInput.value) || 1;
    let newValue = currentValue + delta;
    
    // Get stock quantity from the page
    const stockText = document.getElementById('detailStock').textContent;
    const stockMatch = stockText.match(/Còn (\d+) sản phẩm/);
    const stockQuantity = stockMatch ? parseInt(stockMatch[1]) : 0;
    
    // Limit quantity to stock and minimum 1
    if (newValue >= 1 && newValue <= stockQuantity) { 
        quantityInput.value = newValue; 
    } else if (newValue > stockQuantity) {
        // Show notification if trying to exceed stock
        showStockLimitNotification(stockQuantity);
    }
}

// Show stock limit notification
function showStockLimitNotification(maxStock) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'alert alert-warning alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Số lượng vượt quá tồn kho!</strong><br>
        Chỉ còn ${maxStock} sản phẩm trong kho.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// Validate quantity input when user types directly
function validateQuantityInput() {
    const quantityInput = document.getElementById('quantity');
    let inputValue = parseInt(quantityInput.value) || 1;
    
    // Get stock quantity from the page
    const stockText = document.getElementById('detailStock').textContent;
    const stockMatch = stockText.match(/Còn (\d+) sản phẩm/);
    const stockQuantity = stockMatch ? parseInt(stockMatch[1]) : 0;
    
    // Validate and correct input
    if (inputValue < 1) {
        quantityInput.value = 1;
    } else if (inputValue > stockQuantity) {
        quantityInput.value = stockQuantity;
        showStockLimitNotification(stockQuantity);
    }
}

// Add to cart
function addToCart() {
    const quantity = document.getElementById('quantity').value;
    // Simulate adding to cart
    alert(`Đã thêm ${quantity} sản phẩm vào giỏ hàng!`);
}

// Buy now
function buyNow() {
    const quantity = document.getElementById('quantity').value;
    // Redirect to checkout
    alert(`Chuyển đến trang thanh toán với ${quantity} sản phẩm!`);
}

// Star rating for review modal
document.addEventListener('DOMContentLoaded', function() {
    // Smart actions: copy product link & download image
    function getProductUrl(){
        try {
            const id = (window.productData && window.productData.id) ? window.productData.id : null;
            if (!id) return window.location.href;
            return `${window.location.origin}/product/${id}`;
        } catch(e){ return window.location.href; }
    }

    window.copyProductLink = async function(){
        const link = getProductUrl();
        try {
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(link);
            } else {
                const ta = document.createElement('textarea');
                ta.value = link;
                ta.style.position = 'fixed';
                ta.style.top = '-1000px';
                document.body.appendChild(ta);
                ta.focus();
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
            }
            if (typeof showNotification === 'function') {
                showNotification('Đã sao chép link sản phẩm vào clipboard', 'success');
            }
        } catch (err) {
            if (typeof showNotification === 'function') {
                showNotification('Không thể sao chép link. Vui lòng thử lại.', 'error');
            }
        }
    }

    // Flag to prevent duplicate downloads
    let isDownloading = false;
    
    window.downloadCurrentImage = async function(){
        // Prevent duplicate downloads
        if (isDownloading) {
            console.log('Download already in progress, skipping...');
            return;
        }
        
        isDownloading = true;
        
        try {
            const img = document.getElementById('mainImage');
            const url = img ? img.src : null;
            if (!url) throw new Error('Không tìm thấy ảnh');

            const nameFromTitle = (document.getElementById('detailName')?.textContent || 'product')
                .replace(/[^a-zA-Z0-9\- ]/g,'')
                .replace(/\s+/g,'-')
                .toLowerCase() || 'product';
            // Always use backend proxy to force download with correct headers
            const productId = (window.productData && (window.productData.id || window.productData.product_id)) || 'product';
            const filename = `${nameFromTitle}-${productId}.jpg`;
            
            // Use Django backend endpoint instead of Flask
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const baseUrl = isLocalhost ? window.location.origin : 'https://buddyskincare.vn';
            const proxy = `${baseUrl}/backend/api/download-image/?url=${encodeURIComponent(url)}&filename=${encodeURIComponent(filename)}`;
            
            const a = document.createElement('a');
            a.href = proxy;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            if (typeof showNotification === 'function') {
                showNotification('Đang tải ảnh sản phẩm...', 'success');
            }
        } catch(err){
            const img = document.getElementById('mainImage');
            if (img && img.src) window.open(img.src, '_blank');
        } finally {
            // Reset flag after a short delay
            setTimeout(() => {
                isDownloading = false;
            }, 1000);
        }
    }

    function bindSmartActionButtons(){
        const copyBtns = [
            document.getElementById('btnCopyProductLink'),
            document.getElementById('btnCopyProductLink_2')
        ].filter(Boolean);
        copyBtns.forEach(btn => {
            if (!btn.dataset.bound) {
                btn.addEventListener('click', copyProductLink);
                btn.dataset.bound = '1';
            }
        });

        const dlBtns = [
            document.getElementById('btnDownloadImage'),
            document.getElementById('btnDownloadImage_2')
        ].filter(Boolean);
        dlBtns.forEach(btn => {
            if (!btn.dataset.bound) {
                btn.addEventListener('click', downloadCurrentImage);
                btn.dataset.bound = '1';
            }
        });
    }

    function onReady(fn){
        if (document.readyState !== 'loading') fn();
        else document.addEventListener('DOMContentLoaded', fn);
    }

    onReady(bindSmartActionButtons);

    // Event delegation fallback (in case DOM is re-rendered by other scripts)
    document.addEventListener('click', function(e){
        const t = e.target;
        const copyBtn = t.closest && (t.closest('#btnCopyProductLink') || t.closest('#btnCopyProductLink_2'));
        if (copyBtn) {
            e.preventDefault();
            copyProductLink();
            return;
        }
        const dlBtn = t.closest && (t.closest('#btnDownloadImage') || t.closest('#btnDownloadImage_2'));
        if (dlBtn) {
            e.preventDefault();
            downloadCurrentImage();
            return;
        }
    });

    const stars = document.querySelectorAll('.stars-input i');
    if (stars && stars.length) {
        stars.forEach(star => {
            star.addEventListener('click', function() {
                const rating = this.dataset.rating;
                stars.forEach((s, index) => {
                    if (index < rating) {
                        s.classList.remove('far');
                        s.classList.add('fas');
                    } else {
                        s.classList.remove('fas');
                        s.classList.add('far');
                    }
                });
            });
        });
    }
});
</script>
{% endblock %} 
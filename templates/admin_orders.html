{% extends "admin_base.html" %}

{% block title %}Qu·∫£n L√Ω ƒê∆°n H√†ng - Admin{% endblock %}

{% block extra_css %}
<style>
    .table-light {
        background-color: #e3f2fd !important;
    }
    .table-light:hover {
        background-color: #bbdefb !important;
    }
    
    /* Bank transfer badge clickable styling */
    .badge[onclick] {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .badge[onclick]:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .badge[onclick]:active {
        transform: scale(0.95);
    }
    
    /* Bank transfer image modal styling */
    #bankTransferImageDisplay {
        border: 2px solid #e9ecef;
        transition: transform 0.2s ease;
    }
    
    #bankTransferImageDisplay:hover {
        transform: scale(1.02);
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    /* Button states */
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .btn-success:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
    }
    
    .btn-danger:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
    }
    
    .status-processing {
        background-color: #17a2b8 !important;
        color: white !important;
    }
    
    .status-shipped {
        background-color: #28a745 !important;
        color: white !important;
    }
    
    /* Statistics styling */
    .stat-item {
        padding: 10px 5px;
    }
    
    .stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
        font-weight: 500;
    }
    
    .stat-item:hover .stat-number {
        transform: scale(1.1);
        transition: transform 0.2s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-shopping-cart me-2"></i>Qu·∫£n L√Ω ƒê∆°n H√†ng
            </h1>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="exportOrders()">
                    <i class="fas fa-download me-2"></i>Xu·∫•t Excel
                </button>
                <button class="btn btn-primary" onclick="refreshOrders()">
                    <i class="fas fa-sync me-2"></i>L√†m M·ªõi
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Filter and Search -->
<div class="row mb-4">
    <!-- Left Sidebar Filters -->
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>B·ªô L·ªçc</h5>
            </div>
            <div class="card-body">
                <!-- Payment Method Filter -->
                <div class="mb-3">
                    <label for="paymentFilter" class="form-label fw-semibold">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
                    <select class="form-select" id="paymentFilter">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="cod">Thanh to√°n khi nh·∫≠n h√†ng</option>
                        <option value="bank">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</option>
                    </select>
                    </div>
                
                <!-- Order Status Filter -->
                <div class="mb-3">
                    <label for="statusFilter" class="form-label fw-semibold">Tr·∫°ng th√°i ƒë∆°n h√†ng</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="pending">Ch·ªù x·ª≠ l√Ω</option>
                        <option value="processing">ƒêang x·ª≠ l√Ω</option>
                        <option value="shipped">ƒê√£ giao h√†ng</option>
                        <option value="completed">Ho√†n th√†nh</option>
                            <option value="cancelled">ƒê√£ h·ªßy</option>
                        </select>
                    </div>
                
                <!-- Confirmation Filter -->
                <div class="mb-3">
                    <label for="confirmationFilter" class="form-label fw-semibold">X√°c nh·∫≠n</label>
                        <select class="form-select" id="confirmationFilter">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="true">ƒê√£ x√°c nh·∫≠n</option>
                            <option value="false">Ch∆∞a x√°c nh·∫≠n</option>
                        </select>
                    </div>
                
                <!-- Clear Filters Button -->
                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                    <i class="fas fa-times me-2"></i>X√≥a b·ªô l·ªçc
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="col-md-9">
        <!-- Order Statistics - Desktop Only -->
        <div class="row d-none d-md-block mb-3">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body py-3">
                        <h6 class="card-title mb-3">
                            <i class="fas fa-chart-bar me-2"></i>Th·ªëng K√™ ƒê∆°n H√†ng Theo B·ªô L·ªçc
                        </h6>
                        <div class="row text-center">
                            <div class="col-md-2">
                                <div class="stat-item">
                                    <div class="stat-number text-primary" id="totalOrders">0</div>
                                    <div class="stat-label">T·ªïng ƒë∆°n h√†ng</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-item">
                                    <div class="stat-number text-warning" id="pendingOrders">0</div>
                                    <div class="stat-label">Ch·ªù x·ª≠ l√Ω</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-item">
                                    <div class="stat-number text-info" id="processingOrders">0</div>
                                    <div class="stat-label">ƒêang x·ª≠ l√Ω</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-item">
                                    <div class="stat-number text-success" id="shippedOrders">0</div>
                                    <div class="stat-label">ƒê√£ giao h√†ng</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-item">
                                    <div class="stat-number text-secondary" id="completedOrders">0</div>
                                    <div class="stat-label">Ho√†n th√†nh</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-item">
                                    <div class="stat-number text-danger" id="cancelledOrders">0</div>
                                    <div class="stat-label">ƒê√£ h·ªßy</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Revenue Statistics -->
                        <div class="row mt-3 pt-3 border-top">
                            <div class="col-md-3">
                                <div class="stat-item">
                                    <div class="stat-number text-success" id="totalRevenue">0ƒë</div>
                                    <div class="stat-label">T·ªïng doanh thu</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-item">
                                    <div class="stat-number text-primary" id="codOrders">0</div>
                                    <div class="stat-label">Thanh to√°n COD</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-item">
                                    <div class="stat-number text-info" id="bankOrders">0</div>
                                    <div class="stat-label">Chuy·ªÉn kho·∫£n</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-item">
                                    <div class="stat-number text-warning" id="confirmedOrders">0</div>
                                    <div class="stat-label">ƒê√£ x√°c nh·∫≠n</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="orderSearch" class="form-label">T√¨m ki·∫øm ƒë∆°n h√†ng</label>
                        <input type="text" class="form-control" id="orderSearch" placeholder="ID, t√™n kh√°ch h√†ng, s·ªë ƒëi·ªán tho·∫°i...">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="dateFilter" class="form-label">Ng√†y t·∫°o</label>
                        <input type="date" class="form-control" id="dateFilter">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Orders Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Danh S√°ch ƒê∆°n H√†ng
                    <span class="badge bg-primary ms-2" id="orderCount">0</span>
                </h5>
            </div>
            <div class="card-body">
                <div id="ordersContainer">
                    <div class="loading-spinner show">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">ƒêang t·∫£i danh s√°ch ƒë∆°n h√†ng...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Order Detail Modal -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Chi Ti·∫øt ƒê∆°n H√†ng #<span id="orderDetailId"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="orderDetailContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-warning" id="cancelOrderBtn" onclick="cancelOrder()" style="display: none;">
                    <i class="fas fa-times me-2"></i>H·ªßy ƒê∆°n H√†ng
                </button>
                <button type="button" class="btn btn-info" id="shipOrderBtn" onclick="shipOrder()" style="display: none;">
                    <i class="fas fa-truck me-2"></i>ƒê√£ Giao H√†ng
                </button>
                <button type="button" class="btn btn-success" id="confirmOrderBtn" onclick="confirmOrder()" style="display: none;">
                    <i class="fas fa-check me-2"></i>X√°c Nh·∫≠n ƒê∆°n H√†ng
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Order Modal -->
<div class="modal fade" id="editOrderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Ch·ªânh S·ª≠a ƒê∆°n H√†ng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editOrderForm">
                    <input type="hidden" id="editOrderId">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editCustomerName" class="form-label">T√™n kh√°ch h√†ng</label>
                            <input type="text" class="form-control" id="editCustomerName">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editCustomerPhone" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="text" class="form-control" id="editCustomerPhone">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editCustomerAddress" class="form-label">ƒê·ªãa ch·ªâ giao h√†ng</label>
                        <textarea class="form-control" id="editCustomerAddress" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editOrderStatus" class="form-label">Tr·∫°ng th√°i ƒë∆°n h√†ng</label>
                            <select class="form-select" id="editOrderStatus">
                                <option value="pending">Ch·ªù x·ª≠ l√Ω</option>
                                <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
                                <option value="shipped">ƒê√£ giao</option>
                                <option value="delivered">ƒê√£ nh·∫≠n</option>
                                <option value="cancelled">ƒê√£ h·ªßy</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editOrderConfirmed" class="form-label">X√°c nh·∫≠n ƒë∆°n h√†ng</label>
                            <select class="form-select" id="editOrderConfirmed">
                                <option value="false">Ch∆∞a x√°c nh·∫≠n</option>
                                <option value="true">ƒê√£ x√°c nh·∫≠n</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editOrderNotes" class="form-label">Ghi ch√∫</label>
                        <textarea class="form-control" id="editOrderNotes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="updateOrder()">
                    <i class="fas fa-save me-2"></i>C·∫≠p Nh·∫≠t
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Utility functions
function formatPrice(price) {
    console.log('formatPrice input:', price, 'type:', typeof price);
    if (typeof price === 'number') {
        const formatted = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(price * 1000);
        console.log('Number formatted:', formatted);
        return formatted;
    }
    if (typeof price === 'string') {
        const numPrice = parseFloat(price);
        console.log('String parsed to number:', numPrice);
        if (!isNaN(numPrice)) {
            const formatted = new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(numPrice * 1000);
            console.log('String formatted:', formatted);
            return formatted;
        }
    }
    console.log('Returning default 0ƒë');
    return '0ƒë';
}

function formatShippingFee(price) {
    console.log('formatShippingFee called with:', price, typeof price);
    if (typeof price === 'number') {
        const formatted = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(price * 1000);
        console.log('Shipping fee formatted:', formatted);
        return formatted;
    }
    if (typeof price === 'string') {
        const numPrice = parseFloat(price);
        console.log('Shipping fee parsed to number:', numPrice);
        if (!isNaN(numPrice)) {
            const formatted = new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(numPrice * 1000);
            console.log('Shipping fee formatted:', formatted);
            return formatted;
        }
    }
    console.log('Returning default 0ƒë for shipping');
    return '0ƒë';
}

function formatTotalAmount(order) {
    console.log('formatTotalAmount called with order:', order);
    const totalAmount = parseFloat(order.total_amount || 0);
    const shippingFee = parseFloat(order.shipping_fee || 0);
    const finalTotal = (totalAmount + shippingFee);
    
    console.log('Total amount (products):', totalAmount);
    console.log('Shipping fee:', shippingFee);
    console.log('Final total (totalAmount + shippingFee):', finalTotal);
    
    const formatted = new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
    }).format(finalTotal);
    
    console.log('Final total formatted:', formatted);
    return formatted;
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('vi-VN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function copyToClipboard(text) {
    if (navigator.clipboard && window.isSecureContext) {
        // Use modern clipboard API
        navigator.clipboard.writeText(text).then(() => {
            showCopySuccess();
        }).catch(err => {
            console.error('Failed to copy: ', err);
            fallbackCopyTextToClipboard(text);
        });
    } else {
        // Fallback for older browsers
        fallbackCopyTextToClipboard(text);
    }
}

function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showCopySuccess();
        } else {
            showCopyError();
        }
    } catch (err) {
        console.error('Fallback: Oops, unable to copy', err);
        showCopyError();
    }
    
    document.body.removeChild(textArea);
}

function showCopySuccess() {
    // Create a temporary toast notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = '<i class="fas fa-check-circle me-2"></i>ƒê√£ copy v√†o clipboard!';
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        z-index: 9999;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideInRight 0.3s ease-out;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 2000);
}

function showCopyError() {
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>Kh√¥ng th·ªÉ copy!';
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #dc3545;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        z-index: 9999;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideInRight 0.3s ease-out;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 2000);
}

let allOrders = [];
let filteredOrders = [];
let currentOrderId = null;

document.addEventListener('DOMContentLoaded', async function() {
    await loadOrders();
    setupEventListeners();
    
    // Auto-complete orders that have been shipped for 5+ days
    await autoCompleteShippedOrders();
});

async function loadOrders() {
    try {
        showLoading('ordersContainer');
        
        // Use cache if available and not too old (5 minutes)
        const cacheKey = 'orders_cache';
        const cacheTime = 5 * 60 * 1000; // 5 minutes
        const cached = localStorage.getItem(cacheKey);
        
        if (cached) {
            const { data, timestamp } = JSON.parse(cached);
            if (Date.now() - timestamp < cacheTime) {
                console.log('Using cached orders data');
                allOrders = data;
        filteredOrders = [...allOrders];
                renderOrders();
                updateOrderCount();
                hideLoading('ordersContainer');
                return;
            }
        }
        
        const response = await fetch('/admin/api/orders');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        allOrders = await response.json();
        
        // Cache the data
        localStorage.setItem(cacheKey, JSON.stringify({
            data: allOrders,
            timestamp: Date.now()
        }));
        
        console.log('Loaded orders:', allOrders);
        filteredOrders = [...allOrders];
        
        // Sort orders by order_date descending (newest first)
        filteredOrders.sort((a, b) => {
            const dateA = new Date(a.order_date || a.created_at || 0);
            const dateB = new Date(b.order_date || b.created_at || 0);
            return dateB - dateA; // Descending order (newest first)
        });
        
        renderOrders();
        updateOrderCount();
        
    } catch (error) {
        console.error('Error loading orders:', error);
        let errorMessage = 'L·ªói khi t·∫£i danh s√°ch ƒë∆°n h√†ng';
        
        if (error.message && error.message.includes('401')) {
            errorMessage = 'API y√™u c·∫ßu x√°c th·ª±c ƒë·ªÉ truy c·∫≠p danh s√°ch ƒë∆°n h√†ng. Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n.';
        } else if (error.message && error.message.includes('500')) {
            errorMessage = 'L·ªói server khi t·∫£i danh s√°ch ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i sau.';
        }
        
        document.getElementById('ordersContainer').innerHTML = 
            `<div class="text-center py-4">
                <i class="fas fa-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
                <p class="text-danger">${errorMessage}</p>
                <button class="btn btn-outline-primary" onclick="loadOrders()">
                    <i class="fas fa-sync me-2"></i>Th·ª≠ l·∫°i
                </button>
            </div>`;
    }
}

function showLoading(containerId) {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = `
            <div class="loading-spinner show">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">ƒêang t·∫£i danh s√°ch ƒë∆°n h√†ng...</p>
            </div>
        `;
    }
}

function renderOrders() {
    const container = document.getElementById('ordersContainer');
    
    // Sort orders by order_date descending (newest first)
    filteredOrders.sort((a, b) => {
        const dateA = new Date(a.order_date || a.created_at || 0);
        const dateB = new Date(b.order_date || b.created_at || 0);
        return dateB - dateA; // Descending order (newest first)
    });
    
    if (filteredOrders.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-shopping-cart text-muted mb-3" style="font-size: 3rem;"></i>
                <p class="text-muted">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</p>
                <p class="text-muted small">C√≥ th·ªÉ API y√™u c·∫ßu x√°c th·ª±c ho·∫∑c ch∆∞a c√≥ ƒë∆°n h√†ng n√†o ƒë∆∞·ª£c t·∫°o</p>
            </div>`;
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-admin">';
    html += '<thead><tr><th>ID</th><th>Kh√°ch H√†ng</th><th>S·∫£n Ph·∫©m</th><th>T·ªïng Ti·ªÅn</th><th>Thanh To√°n</th><th>Tr·∫°ng Th√°i</th><th>X√°c Nh·∫≠n</th><th>Ng√†y T·∫°o</th><th>Thao T√°c</th></tr></thead><tbody>';
    
    filteredOrders.forEach(order => {
        const statusClass = {
            'pending': 'status-pending',
            'confirmed': 'status-confirmed',
            'processing': 'status-processing',
            'shipped': 'status-shipped',
            'delivered': 'status-delivered',
            'cancelled': 'status-cancelled',
            'completed': 'status-delivered'
        }[order.status] || 'status-pending';
        
        const statusText = {
            'pending': 'Ch·ªù x·ª≠ l√Ω',
            'confirmed': 'ƒê√£ x√°c nh·∫≠n',
            'processing': 'ƒêang x·ª≠ l√Ω',
            'shipped': 'ƒê√£ giao',
            'delivered': 'ƒê√£ nh·∫≠n',
            'cancelled': 'ƒê√£ h·ªßy',
            'completed': 'Ho√†n th√†nh'
        }[order.status] || order.status;
        
        const confirmationBadge = order.is_confirmed ? 
            '<span class="badge bg-success">ƒê√£ x√°c nh·∫≠n</span>' : 
            '<span class="badge bg-warning">Ch∆∞a x√°c nh·∫≠n</span>';
        
        const paymentMethod = order.payment_method === 'bank' ? 'Ng√¢n h√†ng' : 'Thu COD';
        const rowClass = order.payment_method === 'bank' ? 'table-light' : '';
        
        const itemCount = order.items ? order.items.length : 0;
        console.log('Order total_amount:', order.total_amount, 'Type:', typeof order.total_amount);
        const totalAmount = formatTotalAmount(order);
        console.log('Formatted totalAmount:', totalAmount);
        const createdDate = formatDate(order.order_date);
        
        html += `
            <tr class="${rowClass}">
                <td><strong>#${order.id}</strong></td>
                <td>
                    <div>${order.customer_name || 'N/A'}</div>
                    <small class="text-muted">${order.phone_number || 'N/A'}</small>
                </td>
                <td>
                    <span class="badge bg-info">${itemCount} s·∫£n ph·∫©m</span>
                </td>
                <td><strong>${formatPrice(order.total_amount || 0)}</strong></td>
                <td>
                    ${order.payment_method === 'bank' && order.bank_transfer_image ? 
                        `<span class="badge bg-primary" style="cursor: pointer;" onclick="showBankTransferImage('${order.bank_transfer_image}', ${order.id})" data-bs-toggle="tooltip" title="Click ƒë·ªÉ xem ·∫£nh chuy·ªÉn kho·∫£n">${paymentMethod}</span>` :
                        `<span class="badge ${order.payment_method === 'bank' ? 'bg-primary' : 'bg-secondary'}">${paymentMethod}</span>`
                    }
                </td>
                <td><span class="badge ${statusClass}">${statusText}</span></td>
                <td>${confirmationBadge}</td>
                <td>${createdDate}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="viewOrderDetail(${order.id})" data-bs-toggle="tooltip" title="Xem chi ti·∫øt">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="editOrder(${order.id})" data-bs-toggle="tooltip" title="Ch·ªânh s·ª≠a">
                        <i class="fas fa-edit"></i>
                    </button>
                    <a class="btn btn-sm btn-outline-success ms-1" href="/admin/orders/${order.id}/invoice" target="_blank" data-bs-toggle="tooltip" title="Xu·∫•t h√≥a ƒë∆°n / In">
                        <i class="fas fa-file-invoice"></i>
                    </a>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
    
    // Re-initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
}

function setupEventListeners() {
    // Debounced search for better performance
    let searchTimeout;
    document.getElementById('orderSearch').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(filterOrders, 300);
    });
    
    document.getElementById('statusFilter').addEventListener('change', filterOrders);
    document.getElementById('confirmationFilter').addEventListener('change', filterOrders);
    document.getElementById('paymentFilter').addEventListener('change', filterOrders);
    document.getElementById('dateFilter').addEventListener('change', filterOrders);
}

function filterOrders() {
    const searchTerm = document.getElementById('orderSearch').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const confirmationFilter = document.getElementById('confirmationFilter').value;
    const paymentFilter = document.getElementById('paymentFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    
    filteredOrders = allOrders.filter(order => {
        const phone = (order.phone_number || order.customer_phone || '').toString().toLowerCase();
        const matchesSearch = 
            order.id.toString().includes(searchTerm) ||
            (order.customer_name && order.customer_name.toLowerCase().includes(searchTerm)) ||
            (phone && phone.includes(searchTerm));
        
        const matchesStatus = !statusFilter || order.status === statusFilter;
        const matchesConfirmation = !confirmationFilter || order.is_confirmed.toString() === confirmationFilter;
        
        // Payment method filter
        let matchesPayment = true;
        if (paymentFilter) {
            if (paymentFilter === 'cod') {
                matchesPayment = order.payment_method === 'cod';
            } else if (paymentFilter === 'bank') {
                matchesPayment = order.payment_method === 'bank';
            }
        }
        
        let matchesDate = true;
        if (dateFilter) {
            const orderDate = new Date(order.order_date).toISOString().split('T')[0];
            matchesDate = orderDate === dateFilter;
        }
        
        return matchesSearch && matchesStatus && matchesConfirmation && matchesPayment && matchesDate;
    });
    
    renderOrders();
    updateOrderCount();
}

function clearOrderFilters() {
    document.getElementById('orderSearch').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('confirmationFilter').value = '';
    document.getElementById('paymentFilter').value = '';
    document.getElementById('dateFilter').value = '';
    filterOrders();
}

function clearFilters() {
    clearOrderFilters();
}

function updateOrderCount() {
    document.getElementById('orderCount').textContent = filteredOrders.length;
    updateOrderStatistics();
}

function updateOrderStatistics() {
    // Calculate statistics from filtered orders
    const stats = {
        total: filteredOrders.length,
        pending: 0,
        processing: 0,
        shipped: 0,
        completed: 0,
        cancelled: 0,
        totalRevenue: 0,
        codOrders: 0,
        bankOrders: 0,
        confirmedOrders: 0
    };
    
    const includedIds = [];
    const excludedIds = [];
    filteredOrders.forEach(order => {
        // Count by status
        switch(order.status) {
            case 'pending':
                stats.pending++;
                break;
            case 'processing':
                stats.processing++;
                break;
            case 'shipped':
                stats.shipped++;
                break;
            case 'completed':
                stats.completed++;
                break;
            case 'cancelled':
                stats.cancelled++;
                break;
        }
        
        // Count by payment method
        if (order.payment_method === 'cod') {
            stats.codOrders++;
        } else if (order.payment_method === 'bank') {
            stats.bankOrders++;
        }
        
        // Count confirmed orders
        if (order.is_confirmed) {
            stats.confirmedOrders++;
        }
        
        // Calculate total revenue: only confirmed and not cancelled
        const eligible = order.is_confirmed === true && order.status !== 'cancelled' && order.total_amount;
        if (eligible) {
            stats.totalRevenue += parseFloat(order.total_amount) || 0;
            includedIds.push(order.id);
        } else {
            excludedIds.push({ id: order.id, is_confirmed: order.is_confirmed, status: order.status, total_amount: order.total_amount });
        }
    });
    
    // Update UI
    document.getElementById('totalOrders').textContent = stats.total;
    document.getElementById('pendingOrders').textContent = stats.pending;
    document.getElementById('processingOrders').textContent = stats.processing;
    document.getElementById('shippedOrders').textContent = stats.shipped;
    document.getElementById('completedOrders').textContent = stats.completed;
    document.getElementById('cancelledOrders').textContent = stats.cancelled;
    document.getElementById('totalRevenue').textContent = formatPrice(stats.totalRevenue);
    document.getElementById('codOrders').textContent = stats.codOrders;
    document.getElementById('bankOrders').textContent = stats.bankOrders;
    document.getElementById('confirmedOrders').textContent = stats.confirmedOrders;

    // Debug: show which orders were counted
    try {
        console.log('üßÆ Revenue included IDs:', includedIds);
        console.log('üö´ Excluded IDs (reason fields):', excludedIds);
        console.log('‚Ü≥ Total (raw):', stats.totalRevenue);
    } catch(e) {}
}

function updateOrderRow(orderId) {
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;
    
    // Find the row in the table
    const rows = document.querySelectorAll('#ordersTable tbody tr');
    rows.forEach(row => {
        const idCell = row.querySelector('td:first-child');
        if (idCell && idCell.textContent.trim() === orderId.toString()) {
            // Update status cell
            const statusCell = row.querySelector('td:nth-child(6)');
            if (statusCell) {
                const statusText = getStatusText(order.status);
                const statusClass = getStatusClass(order.status);
                statusCell.innerHTML = `<span class="badge ${statusClass}">${statusText}</span>`;
            }
            
            // Update confirmation cell
            const confirmCell = row.querySelector('td:nth-child(7)');
            if (confirmCell) {
                const confirmText = order.is_confirmed ? 'ƒê√£ x√°c nh·∫≠n' : 'Ch∆∞a x√°c nh·∫≠n';
                const confirmClass = order.is_confirmed ? 'bg-success' : 'bg-warning';
                confirmCell.innerHTML = `<span class="badge ${confirmClass}">${confirmText}</span>`;
            }
        }
    });
}

function getStatusText(status) {
    const statusMap = {
        'pending': 'Ch·ªù x·ª≠ l√Ω',
        'processing': 'ƒêang x·ª≠ l√Ω',
        'shipped': 'ƒê√£ giao h√†ng',
        'delivered': 'ƒê√£ nh·∫≠n h√†ng',
        'cancelled': 'ƒê√£ h·ªßy'
    };
    return statusMap[status] || status;
}

function getStatusClass(status) {
    const classMap = {
        'pending': 'bg-warning',
        'processing': 'bg-info',
        'shipped': 'bg-success',
        'delivered': 'bg-primary',
        'cancelled': 'bg-danger'
    };
    return classMap[status] || 'bg-secondary';
}

function updateOrdersCache() {
    const cacheKey = 'orders_cache';
    localStorage.setItem(cacheKey, JSON.stringify({
        data: allOrders,
        timestamp: Date.now()
    }));
}

function hideLoading(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        const loadingEl = element.querySelector('.loading-spinner');
        if (loadingEl) {
            loadingEl.remove();
        }
    }
}

async function viewOrderDetail(orderId) {
    currentOrderId = orderId;
    const order = allOrders.find(o => o.id === orderId);
    
    if (!order) {
        AdminAPI.showNotification('Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng', 'error');
        return;
    }
    
    // Show modal
    document.getElementById('orderDetailId').textContent = orderId;
    new bootstrap.Modal(document.getElementById('orderDetailModal')).show();
    
    // Load order detail content
    await loadOrderDetail(order);
}

async function loadOrderDetail(order) {
    const container = document.getElementById('orderDetailContent');
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-user me-2"></i>Th√¥ng Tin Kh√°ch H√†ng</h6>
                <div class="card">
                    <div class="card-body">
                        <p><strong>T√™n:</strong> ${order.customer_name || 'N/A'}</p>
                        <p><strong>SƒêT:</strong> ${order.phone_number || 'N/A'} 
                            ${order.phone_number ? `<button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('${order.phone_number}')" data-bs-toggle="tooltip" title="Copy s·ªë ƒëi·ªán tho·∫°i"><i class="fas fa-copy"></i></button>` : ''}
                        </p>
                        <p><strong>Email:</strong> ${order.email || 'N/A'}</p>
                        <p><strong>ƒê·ªãa ch·ªâ:</strong> ${order.street || ''} ${order.ward || ''} ${order.district || ''} ${order.province || ''} 
                            ${order.street ? `<button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('${order.street} ${order.ward || ''} ${order.district || ''} ${order.province || ''}')" data-bs-toggle="tooltip" title="Copy ƒë·ªãa ch·ªâ"><i class="fas fa-copy"></i></button>` : ''}
                        </p>
                        <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> ${order.payment_method || 'N/A'}</p>
                        ${order.bank_transfer_image ? `<p><strong>·∫¢nh chuy·ªÉn kho·∫£n:</strong> <a href="${order.bank_transfer_image}" target="_blank" class="btn btn-sm btn-outline-primary ms-2"><i class="fas fa-external-link-alt me-1"></i>Xem ·∫£nh</a></p>` : ''}
                        ${order.notes ? `<p><strong>Ghi ch√∫:</strong> ${order.notes}</p>` : ''}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-info-circle me-2"></i>Th√¥ng Tin ƒê∆°n H√†ng</h6>
                <div class="card">
                    <div class="card-body">
                        <p><strong>ID:</strong> #${order.id}</p>
                        <p><strong>Tr·∫°ng th√°i:</strong> 
                            <span class="badge ${order.status === 'pending' ? 'status-pending' : order.status === 'confirmed' ? 'status-confirmed' : order.status === 'processing' ? 'status-processing' : order.status === 'shipped' ? 'status-shipped' : order.status === 'completed' ? 'status-delivered' : 'status-cancelled'}">
                                ${order.status === 'pending' ? 'Ch·ªù x·ª≠ l√Ω' : order.status === 'confirmed' ? 'ƒê√£ x√°c nh·∫≠n' : order.status === 'processing' ? 'ƒêang x·ª≠ l√Ω' : order.status === 'shipped' ? 'ƒê√£ giao h√†ng' : order.status === 'completed' ? 'Ho√†n th√†nh' : order.status === 'cancelled' ? 'ƒê√£ h·ªßy' : order.status}
                            </span>
                        </p>
                        <p><strong>X√°c nh·∫≠n:</strong> 
                            <span class="badge ${order.is_confirmed ? 'bg-success' : 'bg-warning'}">
                                ${order.is_confirmed ? 'ƒê√£ x√°c nh·∫≠n' : 'Ch∆∞a x√°c nh·∫≠n'}
                            </span>
                        </p>
                        <p><strong>Ng√†y t·∫°o:</strong> ${formatDate(order.order_date)}</p>
                        <p><strong>T·ªïng ti·ªÅn:</strong> <strong>${formatPrice(order.total_amount || 0)}</strong></p>
                        <p><strong>Ph√≠ ship:</strong> <strong>${formatShippingFee(order.shipping_fee || 0)}</strong></p>
                        ${order.discount_applied ? `<p><strong>Gi·∫£m gi√°:</strong> ${formatPrice(order.discount_applied)}</p>` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if (order.items && order.items.length > 0) {
        html += `
            <div class="row mt-4">
                <div class="col-12">
                    <h6><i class="fas fa-box me-2"></i>Chi Ti·∫øt S·∫£n Ph·∫©m</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>S·∫£n Ph·∫©m</th>
                                    <th>S·ªë L∆∞·ª£ng</th>
                                    <th>Gi√°</th>
                                    <th>Th√†nh Ti·ªÅn</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        order.items.forEach(item => {
            const product = item.product || {};
            const productName = product.name || 'N/A';
            const productImage = product.image ? `<img src="${product.image}" alt="${productName}" class="me-2" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">` : '';
            const priceAtPurchase = parseFloat(item.price_at_purchase) || 0;
            const totalPrice = priceAtPurchase * item.quantity;
            
            html += `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            ${productImage}
                            <div>
                                <div class="fw-bold">${productName}</div>
                                <small class="text-muted">${product.brand_name || ''} - ${product.category_name || ''}</small>
                            </div>
                        </div>
                    </td>
                    <td>${item.quantity}</td>
                    <td>${formatPrice(priceAtPurchase)}</td>
                    <td><strong>${formatPrice(totalPrice)}</strong></td>
                </tr>
            `;
        });
        
        html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
    
    // Show/hide and enable/disable action buttons based on order status
    const confirmBtn = document.getElementById('confirmOrderBtn');
    const cancelBtn = document.getElementById('cancelOrderBtn');
    const shipBtn = document.getElementById('shipOrderBtn');
    
    // Reset button states
        confirmBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
    shipBtn.style.display = 'inline-block';
    confirmBtn.disabled = false;
    cancelBtn.disabled = false;
    shipBtn.disabled = false;
    
    if (order.status === 'pending' && !order.is_confirmed) {
        // Ban ƒë·∫ßu: X√°c nh·∫≠n enable, H·ªßy v√† Giao h√†ng disable
        confirmBtn.disabled = false;
        cancelBtn.disabled = true;
        shipBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-check me-1"></i>X√°c nh·∫≠n ƒë∆°n h√†ng';
        cancelBtn.innerHTML = '<i class="fas fa-times me-1"></i>H·ªßy ƒë∆°n h√†ng';
        shipBtn.innerHTML = '<i class="fas fa-truck me-1"></i>ƒê√£ giao h√†ng';
    } else if (order.status === 'processing' || (order.status === 'confirmed' && order.is_confirmed)) {
        // Sau khi x√°c nh·∫≠n: X√°c nh·∫≠n disable, H·ªßy v√† Giao h√†ng enable (ch·ªâ ch·ªçn 1)
        confirmBtn.disabled = true;
        cancelBtn.disabled = false;
        shipBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-check me-1"></i>ƒê√£ x√°c nh·∫≠n';
        cancelBtn.innerHTML = '<i class="fas fa-times me-1"></i>H·ªßy ƒë∆°n h√†ng';
        shipBtn.innerHTML = '<i class="fas fa-truck me-1"></i>ƒê√£ giao h√†ng';
    } else if (order.status === 'shipped') {
        // ƒê√£ giao h√†ng: T·∫•t c·∫£ disable
        confirmBtn.disabled = true;
        cancelBtn.disabled = true;
        shipBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-check me-1"></i>ƒê√£ x√°c nh·∫≠n';
        cancelBtn.innerHTML = '<i class="fas fa-times me-1"></i>H·ªßy ƒë∆°n h√†ng';
        shipBtn.innerHTML = '<i class="fas fa-truck me-1"></i>ƒê√£ giao h√†ng';
    } else if (order.status === 'cancelled') {
        // ƒê√£ h·ªßy: T·∫•t c·∫£ disable
        confirmBtn.disabled = true;
        cancelBtn.disabled = true;
        shipBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-check me-1"></i>X√°c nh·∫≠n ƒë∆°n h√†ng';
        cancelBtn.innerHTML = '<i class="fas fa-times me-1"></i>ƒê√£ h·ªßy';
        shipBtn.innerHTML = '<i class="fas fa-truck me-1"></i>ƒê√£ giao h√†ng';
    } else {
        // C√°c tr·∫°ng th√°i kh√°c: ·∫®n t·∫•t c·∫£ n√∫t
        confirmBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        shipBtn.style.display = 'none';
    }
}

async function confirmOrder() {
    if (!currentOrderId) return;
    
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√°c nh·∫≠n ƒë∆°n h√†ng n√†y? S·ªë l∆∞·ª£ng t·ªìn kho s·∫Ω ƒë∆∞·ª£c gi·∫£m t∆∞∆°ng ·ª©ng.')) {
        return;
    }
    
    // Show loading state and disable immediately
    const confirmBtn = document.getElementById('confirmOrderBtn');
    if (!confirmBtn) return;
    
    const originalText = confirmBtn.innerHTML;
    confirmBtn.disabled = true;
    confirmBtn.style.pointerEvents = 'none';
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang x·ª≠ l√Ω...';
    
    try {
        // Check stock availability first
        const order = allOrders.find(o => o.id === currentOrderId);
        if (!order || !order.items) {
            throw new Error('Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë∆°n h√†ng');
        }
        
        console.log('Order items for stock check:', order.items);
        
        // Try to check stock availability (optional - skip if API fails)
        try {
            const stockCheckPromises = order.items.map(async (item) => {
                // Get product ID - handle both object and number cases
                const productId = typeof item.product === 'object' ? item.product.id : item.product;
                const productName = item.product_name || (typeof item.product === 'object' ? item.product.name : `S·∫£n ph·∫©m ${productId}`);
                
                console.log(`Checking stock for product ${productId}: ${productName}`);
                
                const response = await fetch(`/api/product-stock/${productId}`);
                if (!response.ok) {
                    console.warn(`Stock check failed for product ${productId}: ${response.status}`);
                    return null; // Skip this product
                }
                const data = await response.json();
                return {
                    product_id: productId,
                    product_name: productName,
                    requested: item.quantity,
                    available: data.stock_quantity || 0
                };
            });
            
            const stockResults = await Promise.all(stockCheckPromises);
            const validResults = stockResults.filter(result => result !== null);
            
            if (validResults.length > 0) {
                const insufficientStock = validResults.filter(item => item.available < item.requested);
                
                if (insufficientStock.length > 0) {
                    const insufficientList = insufficientStock.map(item => 
                        `- ${item.product_name}: C·∫ßn ${item.requested}, C√≤n ${item.available}`
                    ).join('\n');
                    
                    showNotification(`Kh√¥ng ƒë·ªß t·ªìn kho cho c√°c s·∫£n ph·∫©m sau:\n${insufficientList}`, 'error');
                    return;
                }
            } else {
                console.log('Stock check skipped - no valid results');
            }
        } catch (stockError) {
            console.warn('Stock check failed, proceeding without stock validation:', stockError);
        }
        
        // Direct API call
        const response = await fetch(`/admin/api/orders/${currentOrderId}/confirm`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        showNotification(result.message || 'ƒê√£ x√°c nh·∫≠n ƒë∆°n h√†ng th√†nh c√¥ng', 'success');
        
        // Close modals
        const orderModal = document.getElementById('orderDetailModal');
        if (orderModal && window.bootstrap) {
            const modalInstance = bootstrap.Modal.getInstance(orderModal) || new bootstrap.Modal(orderModal);
            modalInstance.hide();
        }
        
        // Also close edit modal if open
        const editModal = document.getElementById('editOrderModal');
        if (editModal && window.bootstrap) {
            const editModalInstance = bootstrap.Modal.getInstance(editModal);
            if (editModalInstance) {
                editModalInstance.hide();
            }
        }
        
        // Reload orders list
        await refreshOrders();
        
    } catch (error) {
        console.error('Error confirming order:', error);
        showNotification('L·ªói khi x√°c nh·∫≠n ƒë∆°n h√†ng: ' + error.message, 'error');
    } finally {
        // Restore button state
        if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.style.pointerEvents = 'auto';
            confirmBtn.innerHTML = originalText;
        }
    }
}

async function cancelOrder() {
    if (!currentOrderId) return;
    
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng n√†y? S·ªë l∆∞·ª£ng t·ªìn kho s·∫Ω ƒë∆∞·ª£c kh√¥i ph·ª•c n·∫øu ƒë√£ x√°c nh·∫≠n.')) {
        return;
    }
    
    // Disable both buttons during processing
    const cancelBtn = document.getElementById('cancelOrderBtn');
    const shipBtn = document.getElementById('shipOrderBtn');
    if (!cancelBtn || !shipBtn) return;
    
    const originalCancelText = cancelBtn.innerHTML;
    const originalShipText = shipBtn.innerHTML;
    
    cancelBtn.disabled = true;
    shipBtn.disabled = true;
    cancelBtn.style.pointerEvents = 'none';
    shipBtn.style.pointerEvents = 'none';
    cancelBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang x·ª≠ l√Ω...';
    
    try {
        // Direct API call
        const response = await fetch(`/admin/api/orders/${currentOrderId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        showNotification(result.message || 'ƒê√£ h·ªßy ƒë∆°n h√†ng th√†nh c√¥ng', 'success');
        
        // Close modals
        const orderModal = document.getElementById('orderDetailModal');
        if (orderModal && window.bootstrap) {
            const modalInstance = bootstrap.Modal.getInstance(orderModal) || new bootstrap.Modal(orderModal);
            modalInstance.hide();
        }
        
        // Also close edit modal if open
        const editModal = document.getElementById('editOrderModal');
        if (editModal && window.bootstrap) {
            const editModalInstance = bootstrap.Modal.getInstance(editModal);
            if (editModalInstance) {
                editModalInstance.hide();
            }
        }
        
        // Reload orders list
        await refreshOrders();
        
    } catch (error) {
        console.error('Error cancelling order:', error);
        showNotification('L·ªói khi h·ªßy ƒë∆°n h√†ng: ' + error.message, 'error');
    } finally {
        // Restore button states
        if (cancelBtn && shipBtn) {
            cancelBtn.disabled = false;
            shipBtn.disabled = false;
            cancelBtn.style.pointerEvents = 'auto';
            shipBtn.style.pointerEvents = 'auto';
            cancelBtn.innerHTML = originalCancelText;
            shipBtn.innerHTML = originalShipText;
        }
    }
}

async function shipOrder() {
    if (!currentOrderId) return;
    
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë√°nh d·∫•u ƒë∆°n h√†ng n√†y l√† ƒë√£ giao h√†ng?')) {
        return;
    }
    
    // Disable both buttons during processing
    const cancelBtn = document.getElementById('cancelOrderBtn');
    const shipBtn = document.getElementById('shipOrderBtn');
    if (!cancelBtn || !shipBtn) return;
    
    const originalCancelText = cancelBtn.innerHTML;
    const originalShipText = shipBtn.innerHTML;
    
    cancelBtn.disabled = true;
    shipBtn.disabled = true;
    cancelBtn.style.pointerEvents = 'none';
    shipBtn.style.pointerEvents = 'none';
    shipBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang x·ª≠ l√Ω...';
    
    try {
        // Direct API call to update status to 'shipped'
        const response = await fetch(`/admin/api/orders/${currentOrderId}/ship`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        showNotification(result.message || 'ƒê√£ ƒë√°nh d·∫•u ƒë∆°n h√†ng l√† giao h√†ng th√†nh c√¥ng', 'success');
        
        // Close modals
        const orderModal = document.getElementById('orderDetailModal');
        if (orderModal && window.bootstrap) {
            const modalInstance = bootstrap.Modal.getInstance(orderModal) || new bootstrap.Modal(orderModal);
            modalInstance.hide();
        }
        
        // Also close edit modal if open
        const editModal = document.getElementById('editOrderModal');
        if (editModal && window.bootstrap) {
            const editModalInstance = bootstrap.Modal.getInstance(editModal);
            if (editModalInstance) {
                editModalInstance.hide();
            }
        }
        
        // Reload orders list
        await refreshOrders();
        
    } catch (error) {
        console.error('Error shipping order:', error);
        showNotification('L·ªói khi ƒë√°nh d·∫•u giao h√†ng: ' + error.message, 'error');
    } finally {
        // Restore button states
        if (cancelBtn && shipBtn) {
            cancelBtn.disabled = false;
            shipBtn.disabled = false;
            cancelBtn.style.pointerEvents = 'auto';
            shipBtn.style.pointerEvents = 'auto';
            cancelBtn.innerHTML = originalCancelText;
            shipBtn.innerHTML = originalShipText;
        }
    }
}

function editOrder(orderId) {
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;
    
    // Populate edit form
    document.getElementById('editOrderId').value = order.id;
    document.getElementById('editCustomerName').value = order.customer_name || '';
    document.getElementById('editCustomerPhone').value = order.customer_phone || '';
    document.getElementById('editCustomerAddress').value = order.customer_address || '';
    document.getElementById('editOrderStatus').value = order.status || 'pending';
    document.getElementById('editOrderConfirmed').value = order.is_confirmed ? 'true' : 'false';
    document.getElementById('editOrderNotes').value = order.notes || '';
    
    // Show modal
    new bootstrap.Modal(document.getElementById('editOrderModal')).show();
}

async function updateOrder() {
    const orderId = document.getElementById('editOrderId').value;
    const formData = {
        customer_name: document.getElementById('editCustomerName').value,
        customer_phone: document.getElementById('editCustomerPhone').value,
        customer_address: document.getElementById('editCustomerAddress').value,
        status: document.getElementById('editOrderStatus').value,
        is_confirmed: document.getElementById('editOrderConfirmed').value === 'true',
        notes: document.getElementById('editOrderNotes').value
    };
    
    try {
        await AdminAPI.updateOrder(orderId, formData);
        AdminAPI.showNotification('C·∫≠p nh·∫≠t ƒë∆°n h√†ng th√†nh c√¥ng!', 'success');
        
        // Close modal and reload data
        bootstrap.Modal.getInstance(document.getElementById('editOrderModal')).hide();
        await loadOrders();
        
    } catch (error) {
        console.error('Error updating order:', error);
    }
}

function refreshOrders() {
    // X√≥a cache tr∆∞·ªõc khi load l·∫°i
    localStorage.removeItem('orders_cache');
    loadOrders();
}

function exportOrders() {
    AdminAPI.showNotification('T√≠nh nƒÉng xu·∫•t Excel c·∫ßn ƒë∆∞·ª£c implement', 'info');
}

function showBankTransferImage(imageUrl, orderId) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('bankTransferImageModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'bankTransferImageModal';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-image me-2"></i>·∫¢nh Chuy·ªÉn Kho·∫£n - ƒê∆°n H√†ng #${orderId}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div class="mb-3">
                            <img id="bankTransferImageDisplay" src="" alt="·∫¢nh chuy·ªÉn kho·∫£n" class="img-fluid rounded shadow" style="max-height: 70vh; max-width: 100%;">
                        </div>
                        <div class="mt-3">
                            <a id="downloadBankTransferImage" href="" download class="btn btn-outline-primary me-2">
                                <i class="fas fa-download me-1"></i>T·∫£i xu·ªëng
                            </a>
                            <button type="button" class="btn btn-outline-secondary" onclick="openImageInNewTab()">
                                <i class="fas fa-external-link-alt me-1"></i>M·ªü trong tab m·ªõi
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Update image source and download link
    document.getElementById('bankTransferImageDisplay').src = imageUrl;
    document.getElementById('downloadBankTransferImage').href = imageUrl;
    
    // Show modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

function openImageInNewTab() {
    const imageUrl = document.getElementById('bankTransferImageDisplay').src;
    window.open(imageUrl, '_blank');
}
</script>

<!-- Bank Transfer Image Modal -->
<div class="modal fade" id="bankTransferImageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-image me-2"></i>·∫¢nh Chuy·ªÉn Kho·∫£n
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <img id="bankTransferImageDisplay" src="" alt="·∫¢nh chuy·ªÉn kho·∫£n" class="img-fluid rounded shadow" style="max-height: 70vh; max-width: 100%;">
                </div>
                <div class="mt-3">
                    <a id="downloadBankTransferImage" href="" download class="btn btn-outline-primary me-2">
                        <i class="fas fa-download me-1"></i>T·∫£i xu·ªëng
                    </a>
                    <button type="button" class="btn btn-outline-secondary" onclick="openImageInNewTab()">
                        <i class="fas fa-external-link-alt me-1"></i>M·ªü trong tab m·ªõi
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<script>
// Notification function
function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} notification`;
    
    // Custom styling based on type
    let customStyle = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 500px;
        animation: slideInRight 0.3s ease-out;
    `;
    
    // Add light red background for error notifications
    if (type === 'error' || type === 'danger') {
        customStyle += `
            background-color: #f8d7da !important;
            border-color: #f5c6cb !important;
            color: #721c24 !important;
        `;
    }
    
    notification.style.cssText = customStyle;
    
    notification.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div style="white-space: pre-line; flex: 1; margin-right: 10px;">${message}</div>
            <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    // Add to body
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Add CSS for animation and styling
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    .notification .btn-close {
        background: none;
        border: none;
        font-size: 1.2em;
        opacity: 0.7;
        transition: opacity 0.2s;
    }
    
    .notification .btn-close:hover {
        opacity: 1;
    }
    
    .notification .btn-close::before {
        content: '√ó';
        font-weight: bold;
    }
`;
document.head.appendChild(style);

// Auto-complete orders that have been shipped for 5+ days
async function autoCompleteShippedOrders() {
    try {
        console.log('üîÑ Checking for orders to auto-complete...');
        
        const response = await fetch('/admin/api/orders/auto-complete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.updated_orders && result.updated_orders.length > 0) {
                console.log(`‚úÖ Auto-completed ${result.updated_orders.length} orders:`, result.updated_orders);
                
                // Show notification
                showNotification(
                    `ƒê√£ t·ª± ƒë·ªông ho√†n th√†nh ${result.updated_orders.length} ƒë∆°n h√†ng:\n` +
                    result.updated_orders.map(order => `- ƒê∆°n h√†ng #${order.id} (${order.customer_name})`).join('\n'),
                    'success'
                );
                
                // Refresh orders list to show updated status
                await refreshOrders();
            } else {
                console.log('‚ÑπÔ∏è No orders to auto-complete');
            }
        } else {
            const error = await response.json();
            console.error('‚ùå Auto-complete failed:', error);
        }
    } catch (error) {
        console.error('‚ùå Error in auto-complete:', error);
    }
}

// Set up periodic auto-complete check (every 2 minutes for testing)
setInterval(async () => {
    await autoCompleteShippedOrders();
}, 2 * 60 * 1000); // 2 minutes for testing

</script>

{% endblock %}